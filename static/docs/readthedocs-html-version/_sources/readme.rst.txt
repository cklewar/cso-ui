Juniper Advanced Solutions Technology Team Blue-Prints:

.. warning:: Juniper CONFIDENTIAL and INTERNAL document!

**How to build a generic Test lab for CSO V4.1.0 and execute Test cases for**

**SD-WAN, uCPE and vCPE with it**

**Make sure you got the latest Version**\ `HERE <https://easylink.juniper.net/CSOReferenceLab>`__

|image0|

Juniper Networks, Inc.

1133 Innovation Way

Sunnyvale, CA 94089 USA

`www.juniper.net <http://www.juniper.net>`__

**Version: 3.1**

**Issue Date: 21 March 2019**

**Document Control**

**Author:** Hartmut Schroeder with contribution of many reviewers

**Change Authority:** Hartmut Schroeder (Sr. Consultant SE, CPO Solutions Team)

**Revision History:**

+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Version**                                                                                                                                                                                           | **Date Issued**                                                                                                                                                                                       | **Status**                                                                                                                                                                                            | **Change Request Number**                                                                                                                                                                             | **Reason for Change**                                                                                                                                                                                 |
|                                                                                                                                                                                                       |                                                                                                                                                                                                       |                                                                                                                                                                                                       |                                                                                                                                                                                                       |                                                                                                                                                                                                       |
| **Number**                                                                                                                                                                                            |                                                                                                                                                                                                       |                                                                                                                                                                                                       |                                                                                                                                                                                                       |                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 1.0                                                                                                                                                                                                   | 20 Apr 18                                                                                                                                                                                             | First Version finish                                                                                                                                                                                  |                                                                                                                                                                                                       | SD-WAN Basic test cases are fully developed now (vCPE and uCPE as well)                                                                                                                               |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 1.1                                                                                                                                                                                                   | 8 May 18                                                                                                                                                                                              | Continued add                                                                                                                                                                                         |                                                                                                                                                                                                       | vCPE test cases are stable now, added local-breakout, added Hub-Redundancy, added Spoke-Redundancy                                                                                                    |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 1.2                                                                                                                                                                                                   | 29 May 18                                                                                                                                                                                             | Continued add                                                                                                                                                                                         |                                                                                                                                                                                                       | Automation of Desktop VM’s creation, changed to CSO 3.3.1, added colour coding, NTP added                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 1.3                                                                                                                                                                                                   | 7 June 18                                                                                                                                                                                             | Continued add                                                                                                                                                                                         |                                                                                                                                                                                                       | AWS Spoke added                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2.0                                                                                                                                                                                                   | 20 July 18                                                                                                                                                                                            | Entire refresh                                                                                                                                                                                        |                                                                                                                                                                                                       | CSO 4.0.0 integration started                                                                                                                                                                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2.1                                                                                                                                                                                                   | 3 August 18                                                                                                                                                                                           | Continued refresh                                                                                                                                                                                     |                                                                                                                                                                                                       | CSO 4.0.1 integration started                                                                                                                                                                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2.2                                                                                                                                                                                                   | 17 Sep. 18                                                                                                                                                                                            | Continued add                                                                                                                                                                                         |                                                                                                                                                                                                       | VNF (single-legged Ubuntu VM) added                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2.3                                                                                                                                                                                                   | 18 Sep. 18                                                                                                                                                                                            | Update to 4.0.1                                                                                                                                                                                       |                                                                                                                                                                                                       | CSO 4.0.1 integration finished                                                                                                                                                                        |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2.4                                                                                                                                                                                                   | 29 Oct. 18                                                                                                                                                                                            | Continued add                                                                                                                                                                                         |                                                                                                                                                                                                       | AppQoE added, CSO 4.0.2 validated                                                                                                                                                                     |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2.5                                                                                                                                                                                                   | 22 Nov. 18                                                                                                                                                                                            | Final Version                                                                                                                                                                                         |                                                                                                                                                                                                       | Device-RMA added, Full Mesh added, Public-IP forwarder prototype added                                                                                                                                |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2.6                                                                                                                                                                                                   | 10 Dec. 18                                                                                                                                                                                            | New adds                                                                                                                                                                                              |                                                                                                                                                                                                       | Traffic-generator script exchanged, ENTIRE doc restruct for Browser version                                                                                                                           |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2.7                                                                                                                                                                                                   | 8 Feb. 19                                                                                                                                                                                             | New adds                                                                                                                                                                                              |                                                                                                                                                                                                       | AWSspoke on BYOD, vSRX3 as NAT-VM                                                                                                                                                                     |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 3.0                                                                                                                                                                                                   | 6 Mar. 19                                                                                                                                                                                             | Change to V4.1                                                                                                                                                                                        |                                                                                                                                                                                                       | CSO 4.1.0 integration, re-done FullMesh, added Partial Mesh w. Site-GW                                                                                                                                |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 3.1                                                                                                                                                                                                   | 21 Mar. 19                                                                                                                                                                                            | New adds                                                                                                                                                                                              |                                                                                                                                                                                                       | Device and Underlay automation added                                                                                                                                                                  |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

**Change Forecast: Low** (only bugfixes and new CSO versions)

**This document will be kept under strict revision control**

**Intellectual Property Rights**

This document contains valuable trade secrets and confidential information of Juniper Networks Ltd. and its suppliers, and shall not be disclosed to any person, organization, or entity unless such disclosure is subject to the provisions of a written non-disclosure and proprietary rights agreement or intellectual property license agreement approved by Juniper Networks Ltd. The distribution of this document does not grant any license in or rights, in whole or in part, to the content, the product(s), technology, or intellectual property described herein.

Table of Contents

1 Introduction 6

2 Lab setup design and guidelines 8

2.1 Absolute MUST HAVES for a Lab and known Limits 8

2.2 Minimal Hardware for a Lab (read carefully) 10

2.3 Unusable IP-Address Ranges for all Labs 12

2.4 Used IP-Addresses and Ranges in this Lab 13

2.5 Default Interfaces of CSO Templates for Devices 15

2.6 Cable-Plan (for EMEA loan pool-Racks and OpenLab) 17

2.7 Topologies for the different Lab-Setups 18

2.8 Lab access and default passwords 24

2.9 How to access the GUI’s 27

2.10 Dynamic CSO passwords 28

2.11 Firmware and Software to use for CSO 4.1.0 28

2.12 KNOWN BUGs in CSO 4.1.0 FRS 29

3 Installation of the Lab 32

3.1 Contrail-Host (optional and only needed for vCPE) 32

3.1.1 Install the Host OS onto the Server 32

3.1.2 Host OS preparation 33

3.1.3 Install the Contrail Fabric 34

3.1.4 After Fabric installation tasks 35

3.2 CSO-Host and CSO itself 36

3.2.1 Install the Host OS onto the Server 36

3.2.2 Host OS preparation 37

3.2.3 Install a local DNS and NTP Server on the Host 39

3.2.4 Install a squid proxy for lab access to other VM’s 41

3.2.5 Install NAT GW for the lab based on vSRX V3.0 42

3.2.6 Start CSO installation 48

3.2.7 Provision the CSO-VM’s 50

3.2.8 Execute CSO installation 53

3.2.9 Post CSO installation procedure 59

3.2.10 Post installation for optional vCPE support 65

3.2.11 Post installation for optional uCPE support 76

3.2.12 Create Desktop VM’s to simulate Clients 78

3.2.13 Create DelayVM for SD-WAN traffic manipulation 83

3.2.14 First Login to CSO 87

3.2.15 MANDATORY create a backup of your CSO installation 89

3.3 Lab Switches, Routers and Devices 93

Default/initial Lab setup 93

3.3.2 vCPE Lab setup 95

3.3.3 uCPE Lab setup 97

3.3.4 SD-WAN basic Lab setup 103

4 Test case execution related to vCPE use-cases 126

5 Test case execution related to uCPE use-cases 175

6 Test case execution related to SD-WAN BASIC use-cases 225

6.1 Hub1 (srx1500-1) install for SD-WAN BASIC 225

6.2 Create a Tenant 237

6.3 Add the Hub to your Tenant 241

6.4 SRX345 as Spoke for SD-WAN BASIC 245

6.5 NFX250 as Spoke for SD-WAN BASIC 269

6.6 Shared test cases for SRX and NFX250 as Spoke devices 316

6.6.1 MANDATORY STEP – add/review Licenses for later tests 316

6.6.2 MANDATORY STEP – Load IDP-Signatures 319

6.6.3 Demonstrate Application detection for SD-WAN 320

6.6.4 Static SD-WAN policy 325

6.6.5 Dynamic SD-WAN policy 337

6.6.6 (optional) DSCP-Field re-writing and copying to outer Tunnel 358

6.6.7 Security feature related Test-cases for SD-WAN 364

6.6.8 Logging and Report generation 406

7 Test case execution related to SD-WAN EXTENDED and FULL 412

7.1 Local-Breakout at Spoke to Internet 412

7.1.1 Preparation (on boarding first Spoke) 412

7.1.2 Test case local-breakout to default (without SLA-Policy) 426

7.1.3 NFX250 as second Spoke bring-up 427

7.1.4 Test case Spoke to Spoke communication (no breakout) 433

7.1.5 Test case local-breakout with SLA Policy 435

7.2 Local-Breakout at Spoke towards (Zscaler-) Cloud 441

7.3 Hub-Redundancy aka Hub Multihoming 441

7.3.1 QFX5100-1 changes to add second Hub Device 442

7.3.2 SRX1500-2 initial configuration 444

7.3.3 On-board Hub2 to CSO and Tenant 446

7.3.4 On-board Spoke with Hub Redundancy configuration 454

7.3.5 Failover Testcase with Static Routes in the Underlay 466

7.3.6 Failover Test case with NAT on the Hubs 470

7.4 Spoke-Redundancy aka Dual-Spoke 474

7.4.1 NFX250-2 configuration 477

7.4.2 QFX5100-1 changes for this lab 478

7.4.3 Hub1 re-provision (SRX1500-1) 490

7.4.4 (optional) Create Tenant 495

7.4.5 Add the CloudHub to the Tenant 496

7.4.6 On-board both NFX250 in HA Cluster-mode 496

7.4.7 Failover Test cases to be executed 514

7.5 Device RMA 529

7.5.1 Modifications on the underlay QFX5100 configuration 530

7.5.2 Second NFX preparation and check 536

7.5.3 Test Case execution 537

7.6 Real-time optimized (or AppQoE) SD-WAN 541

7.6.1 Create a new Realtime Tenant 542

7.6.2 Onboard Hub to Tenant 547

7.6.3 Onboard the Spoke Device 550

7.6.4 Test case execution demonstrating realtime failovers 573

7.7 Full Mesh with Local-Breakout 581

7.7.1 Add underlay support for third Spoke Device 582

7.7.2 Create cloud-hub1 583

7.7.3 (optional) Create Realtime Tenant 584

7.7.4 Onboard Hub to Tenant 584

7.7.5 Add the three Spoke Devices 584

7.7.6 (optional) Review and check Mesh configuration 598

7.7.7 Add Firewall rules and deploy 610

7.7.8 Traffic between Desktop VM’s and towards Internet 611

7.8 Partial Mesh AND Site-Gateway 626

7.8.1 Changes on underlay to support hub2 as Site-GW 627

7.8.2 Add Site-Gateway 628

7.8.3 Review/change the Firewall configuration 642

7.8.4 Add your Spokes to the Environment 643

7.8.5 Traffic between Desktop VM’s and Site-Gateway 657

7.9 Simple VNF integration (aka Service-Chaining) 670

7.9.1 VNF import to CSO and Template changes 671

7.9.2 VNF onboarding to Spoke and testing of it 688

7.10 SD-WAN endpoint in AWS (aka Multicloud-scenario) 699

7.10.1 Before the PoC starts 701

7.10.2 Changes and updates on the Devices 702

7.10.3 Provision of the AWS Spoke 704

7.10.4 AWS Spoke changes to CSO 721

7.10.5 Add a Desktop VM in AWS-VPC to Test the configuration 725

8 Appendix 734

8.1 References and Videos 734

8.2 Raspberry Pi changes 734

8.3 Known stable Ubuntu VM as NAT-GW instead of vSRX V3.0 736

8.4 Lab restore from backup 744

8.5 CSO behind NAT Firewalling 747

8.6 Locked CSO Admin account 748

8.7 “No Data Available” displayed 749

8.8 CSO Tuning for faster switchover times 752

8.9 README.md file from CSO-Tarball 753

8.10 QFX5100-1 config 764

8.11 MX80 config 768

8.12 Saved Certificates from central-msvm 770

8.13 Recover lost passwords 770

8.14 Traffic generator script 771

8.15 Automation of the Lab setup 774

8.15.1 Building an VM for Automation on the CSO-Host 774

8.15.2 Changes on the NAT-VM 776

8.15.3 Build Gitlab Docker Container and configure it 776

8.15.4 Apply changes of your local Lab to the configuration 777

8.15.5 Build Automation-Gui Docker Contrainer 779

8.15.6 Useing the automation Framework 782

8.16 Other lab configurations 784

8.16.1 Slab Amsterdam 784

8.16.2 Openlab DC73 787

8.16.3 JCL Sandbox 791

9 UNDER DEVELOPMENT / NOT STABLE / USE AT OWN RISK 799

9.1 Patch to fix CXU-26429 799

9.2 vSRX as Hub3 801

9.3 Public IP Forwarder to local Lab 809

9.4 Peering between Hub and Legacy environment 824

9.5 AWS Spoke on CSO-BYOD-OpenLab instance 827

9.5.1 Preparations on AWS before the PoC starts 827

9.5.2 Provision of the AWS Spoke 828

9.5.3 Add a Traffic-Testing VM to your AWS VPC 846

9.6 Multicloud Demo with CC13 slab environment 852

9.7 Open Automation items (for future enhancements) 869

10 Conclusion 874

Introduction
============

This document is the **master document of the ASTT CSO Reference Lab**.

It includes all needed information about the Lab, its design, the components needed and how they play together here and give full / detailed instructions how to **run a demo** or **execute a PoC** with a customer.

Prior this Reference Lab Document doing a Demo or a PoC of CSO was subject of a month of work. This is not just about the pure installation process of CSO itself (which is pretty slick these days) it’s the overall complexity of the things that all come together with this that impact the ability to do a Demo or do a PoC. As example for SD-WAN you need to be able to add latency, packet loss and jitter to the Path but no Junos device has an option to add this. With this Reference Design you have a complete design with all the needed functions added (non-Juniper or Juniper) that should now allow you to finish a whole PoC in a Week. That’s the ultimate goal of this exercise.

The Document explains:

-  What you need to know as known limits of this Lab and what not to do.
-  Which Hardware you need to run this Lab
-  Explains the Links and Cables between the Devices
-  Details the Lab Topology
-  Provides the initial Start-up and Underlay configuration for each device.
-  Has a detailed (and tested) installation procedure for CSO to follow
-  Has a detailed installation procedure for the additionally needed support VM’s
-  Has all detailed procedures for executing a Demo or PoC for the covered functions

Other avail Documents (that are also reachable via this `link <https://junipernetworks.sharepoint.com/teams/Sales/Technical_Sales/coe/Solutions%20%20Write%20Ups/Documents/CSOReferenceLab>`__):

-  A **Test Plan to be shared with Customer** prior executing this Lab / PoC.
-  PowerPoint from a Training on this Lab given to Juniper SE’s in various countries
-  PowerPoint’s with background information on CSO
-  Modifications of this Lab in other environments

While this ASTT CSO Reference Lab focuses and is mostly **tested for SD-WAN** with CSO you will see that the design **includes older Models as uCPE and vCPE as well**.

This document is intended to be kept **internal to Juniper** Employees and NOT shared with Customers or Partners.

Please also remember the Colour convention used in the Textboxes

.. code-block:: none

   Black  = Normal list output the system did in response to a command
   Green  = CLI Input and configuration pieces to use Copy&Paste
   Purple = Variable pieces of the configuration you need to adapt for your lab
   Red    = Something to highlight or warn you about

This Lab is self-contained by design. Only some outside IP-Addresses should be needed to be changed for your own lab. If you keep straight to the original design then 99% of the configuration **just** needs a **copy&paste** from you.

However this should not prevent you from thinking what you are doing. ;-)

.. warning:: Check the KNOWN BUGs section in chapter 2.12 below before you start.

We know that no one likes to review long Documents. However it works best when you add the Navigation Pane at the Left side to see the Chapter overview like below.

|image1|

Word on **MacOS Users** please notice that accepting the changes in this document, that we track from CSO 4.0.1 to be able to compare it, might take a long time and word might not be responsive. It’s better to change the markup display level like below:

|image2|

**Change the display level** to “Simple Markup” or even “No Markup”

.. warning:: Advice: Do not change the Names for Hubs/Tenants and Spoke Devices! This will make it harder for you to debug and fix issues that may appear. Do not try to be creative here and follow the conventions as they are.

Lab setup design and guidelines
===============================

Absolute MUST HAVES for a Lab and known Limits
----------------------------------------------

Before you install the Lab make sure that you have **unrestricted Internet** access. Source NATed access to the Internet (like a home DSL-Router) is ok. ANY Proxied Access is prohibited and doesn’t work. You have been warned.

The statement above is NOT NEGOTIABLE. CSO, vCPE, uCPE and SD-WAN etc. is all about granting connectivity. Apart from the installation procedure, which may require to download packages and Junos images from the Internet and also the IDP-Signature Databases for SD-WAN are located in the Internet, almost all test-procedures require Internet access. Especially to demonstrate the power of SD-WAN you hardly can emulate the behaviour of most of the applications in the Internet locally.

You need proper licenses for your SRX and NFX CPE’s when you demonstrate SD-WAN.

New features like “SD-WAN endpoint in AWS” need an AWS Account for the Demo AND a couple of Public-IP’s mapped to the Lab else your Demo will fail.

You need to be able to change the Host Operating System of the Servers towards Ubuntu V14.04.5. If the local IT-Dep. has preinstalled the Servers it is usually better to redo the installation to ensure it is not altered in a way that something doesn’t work.

If the servers are provided by the customer then ask for remote console access and IPMI credentials of them. This will assure you can change/re-install the Host OS yourself if required.

ESXi VM installations are not supported or tested as part of this documentation. We advise you not to go this path. Pre CSO 3.3 the installation and provision of the VM’s is manually done which is very time consuming. Still with CSO V3.3 on ESXi the vRR has to be configured manually.

Also avoid installing CSO inside an OpenStack environment as the upgrade procedures are only for native KVM and ESXi (speaking of CSO >= 3.3).

Better use NATIVE KVM installations with the servers for a smooth lab.

A Contrail-Fabric installation for vCPE test cases cannot be inside a VM. A separate and dedicated Server is needed as a minimum.

Make sure you have an IP-Address of a reachable NTP server. You can’t walk without that.

Do not use any customer provided DNS-Servers as first Source. Always setup a local DNS-Server on the CSO-Host (and use others from there if the local DNS doesn’t resolve the domain). This practice will allow you to give the right information to devices during the ZTP process when they use this DNS-Server. If you fail to comply this practice then the wrong certificates for the CSO VM’s may be created that are not configured on the DNS-Server and you are not able to change this without reinstalling CSO.

A usual CSO Lab will not be able to demonstrate CSO control plane redundancy (HA). This is because you need a minimum of FOUR Servers to archive the 2N+1 redundancy of the servers (plus another to distribute the services for more load). Do not agree to do this as a part of the test plan. If the customer wants this, it should be treated as a regression test with paid PS support.

Hub and Spoke redundancy however are part of this test plan if you have the right amount of devices.

When you install the CSO-Host OS make sure you do **NOT use more than 32GB swap space**. From an USB-Key or CDROM you need to select Manual Disk Partitioning to archive this. If you forget this them Ubuntu will assign a USELESS 256GB swap-partition because it follows the old practice in assigning as many swap as you have RAM which is totally meaningless for servers with large RAM because when you try to swap such large amount of memory out, you will only get into disk IO-contention. Also even when you do not use such a large swap-space but it is still assigned, it will block the precious first fast sectors of your HD for nothing.

Also do not configure a large /home directory. CSO installs the VM’s in /root/ubuntu_vm so a single big / dir is fine instead. In case you forgot a symbolic link from /root/ubuntu_vm to anywhere in your /home/\* will help you without changing the partition.

Ethernet interfaces for Servers: This Lab expects a **minimum of ONE 10Gbit/s Ethernet NIC for the CSO-Host** and a **minimum of 2 \* Gbit/s Ethernet Ports for the Contrail-Host**. We need the 10 Gbit/s interface on the CSO-Host for SD-WAN as we have this delayVM insertion. So the traffic has to go through this VM twice and you would impact the entire forwarding speed in your lab to a half of 1Gbit/s which may cause you hidden surprises not reaching the promised performance.

**Make sure you have an >= 1TB SDD** in the server system. We see issues with the local HD not fast enough and then CSO takes 2-4 times longer to install and you have massive issues with starting the services. If you only get HDD’s but you have them attached to a modern Raid-Controller make sure to have **“write-back” and caching enabled** as this may not be the default.

**You can NOT do a Lab without a Terminal Server** (or an equal replacement). If you zeroize an NFX250 it will be extremely hard to get it back under control to do follow-up configuration and make use of it for any scenario.

On all Spoke devices our Labs are using **STATIC IP’s on the WAN_0 interface**.

This should be kept as advice for all Labs you want to do for now.

It’s usually the MPLS interface that is bound to WAN_0 so you really mimic a production behaviour and not something exotic. We also do this because occasionally there may be issues, mostly related to use an NFX250, where the link-switch script may not correctly configure the vSRX image with the DHCP lease from JDM and then the provisioning process will stuck and not finish.

You are free to ignore our advice and lean against this practice in your own lab; but don’t complain if something is not working as you have been warned with this.

**No Third-Party Switch** as replacement for the QFX5100 in any SD-WAN scenario.

We are utilising certain Layer3 forwarding features, Virtual Router and BGP-Peering of the QFX5100 to come close to a real live environment with routing between Hub-Spoke. A third-party switch may not have those and only provide basic VLAN L2-Features. You never know. We decided not to build a lab just to substitute a single customer Switch that may be there already and make our live artificially harder than it already is. Also the automation we are building doesn’t reflect to configure a non QFX5100. Get a QFX5100 from the Loan-Pool if you are tight.

**Try to get SRX345 and NOT ANY SRX300/320!** The reason is that the SRX300/320 has a Hardware limitation in Junos 15x that prevents to execute the SSL-Proxy feature. This is covered in the releasenotes of CSO but we better make you aware in the case you have not read them. Also the SRX300 may not build up the IPsec Tunnel correctly during Provision Stage-2 and you have to reboot it before it works correctly.

Minimal Hardware for a Lab (read carefully)
-------------------------------------------

Depending on what Parts of the Test plan you execute with the features highlighted here the following Hardware should be avail.

**Minimal Lab requirements for vCPE testing**

1\* 8Port Terminal Server (or a proper substitute like a Raspberry PI with USB-to-Serial cables)

1\* 24Port Switch

1\* Juniper MX as DC-R and Edge-PE (collapsed without MPLS in-between)

1\* Server as CSO Host with >=256GB RAM, >=50vCPU, >=2TB-Harddrives, 1*10gbit/s Ethernet interface

1 \*Server as Contrail Host with >=64GB RAM, >=20vCPU, >=500GB-Harddrives (FUNCTIONAL testing only)

**Minimal Lab requirements for uCPE testing**

1\* 8Port Terminal Server (or a proper substitute like a Raspberry PI with USB-to-Serial cables)

1\* 24Port Switch

1\* Juniper MX as Edge-PE with Hardware Accelerator (example MX-80 w. MS-MIC-16G and MIC-3D-20GE-SFP)

1\* NFX250-S2

1\* Server as CSO Host with >=256GB RAM, >=50vCPU, >=2TB-Harddrives, 1*10gbit/s Ethernet interface

**Minimal Lab requirements for SD-WAN testing**

1\* 8Port Terminal Server (or a proper substitute like a Raspberry PI with USB-to-Serial cables)

1\* 48Port Switch (QFX5100 or better demanded)

1\* NFX250-Sx (as Spoke)

1\* SRX345 (as Spoke)

1\* SRX1500/SRX4000/SRX4100 (Hub) (you also may utilize an SRX3xx for FUNCTIONAL testing)

1\* Server as CSO Host with >=256GB RAM, >=50vCPU, >=2TB-Harddrives, 1*10gbit/s Ethernet interface

**Minimal Lab requirements for SD-WAN testing w. Hub Redundancy**

1\* 8Port Terminal Server (or a proper substitute like a Raspberry PI with USB-to-Serial cables)

1\* 48Port Switch (QFX5100 or better demanded)

1\* NFX250-S2 (as Spoke)

1\* SRX345 (as Spoke)

2\* SRX1500/SRX4000/SRX4100 (Hub) (you also may utilize an SRX3xx for FUNCTIONAL testing)

1\* Server as CSO Host with >=256GB RAM, >=50vCPU, >=2TB-Harddrives, 1*10gbit/s Ethernet interface

**Minimal Lab requirements for SD-WAN testing w. Spoke Redundancy (CSO V3.3 or higher)**

1\* 8Port Terminal Server (or a proper substitute like a Raspberry PI with USB-to-Serial cables)

1\* 48Port Switch (QFX5100 or better demanded)

2\* NFX250-Sx (as Dual-Spoke)

1\* SRX1500/SRX4000/SRX4100 (Hub) (you also may utilize an SRX3xx for FUNCTIONAL testing)

1\* Server as CSO Host with >=256GB RAM, >=50vCPU, >=2TB-Harddrives, 1*10gbit/s Ethernet interface

**All minimal Lab requirements together in one Lab**

1\* 8Port Terminal Server (or a proper substitute like a Raspberry PI with USB-to-Serial cables)

1\* 48Port Switch (QFX5100 or better demanded)

1\* Juniper MX as Edge-PE with Hardware Accelerator (example MX-80 w. MS-MIC-16G and MIC-3D-20GE-SFP)

2\* NFX250-Sx (as Spoke/Dual-Spoke)

1\* SRX345 (as Spoke)

2\* SRX1500/SRX4000/SRX4100 (as Hub/Dual-Hub) (you also may utilize an SRX3xx for FUNCTIONAL testing)

1\* Server as CSO Host with >=256GB RAM, >=50vCPU, >=2TB-Harddrives (less RAM is really NOT ALLOWED), 1*10gbit/s Ethernet interface

1 \*Server as Contrail Host with >=64GB RAM, >=20vCPU, >=500GB-Harddrives (FUNCTIONAL testing only)

.. warning:: We **strongly advice** you to attach all **Hub/Spoke devices** to a remote managed **PDU** if you are working from remote. They can be stuck somewhere during booting or operation and then you need long arms to power-cycle them.

.. warning:: Also we **strongly advice** you have on all **Hub/Spoke devices** USB-Keys installed that are loaded with the initial Firmware if you are working from remote. You need to be able to reimage the System if for some reason the filesystem get’s corrupted. We promise you this practice will pay off for you when need it the most and these few USB-Keys are cheap to buy.

**Possible expansions and alterations of the required Hardware:**

For the CSO Host if there is no single Server with 256GB RAM avail you can instead use two Servers with 128GB RAM (or 4-5 with 64GB RAM) and distribute the VM’s across these Hosts. The CSO Release notes and the README.md (a copy is in the Appendix section) will state how much RAM and vCPU capacity each VM will need and you need to find a way to balance this across the Servers you have. Do not accept servers with less than 64GB RAM as this is NOT SERIOUS and some VM’s would not be able to work.

If you don’t have enough storage on the CSO Host as requested you might go down with the Storage requirements until around 500GB. We are aware that the Release notes state that a single VM of the many will be sized for 500GB but this is for production and we don’t use raw images that reserve the maximum storage statically.

The qcow2 images for the VM’s will start small and may grow during the PoC but for demonstration it should be ok. **With such a tweak you will definitely exhaust the local diskspace after around a month of operation. You have been warned!** 1TB storage would also give you enough space to perform a backup after the CSO installation.

vSRX as Hub devices are officially supported by CSO >= V4.0 but we currently do not entertain this actively for a PoC as we have seen some shortcomings already. The issues spotted come from the fact that most People try to avoid using a second server and try to re-use the CSO-Host. Here you might run into issues as Ubuntu 14.04.5 might give you some headaches. If you can’t escape this as request from a customer insisting to build a demo you might use the test in chapter 00 below AT YOUR OWN RISK!

vSRX as Spoke is officially supported. However we want to sell NFX instead so avoid this as part of a demo. This might change towards Soft-NFX in the future but this is not a committed program yet.

You can use an NFX150 vs. the NFX250 as this is a supported model in CSO >= 4.0.

However when the lab was initially created we had only CSO 3.3 and that’s why these units are not integrated. (also they do not work with Dual-CPE as of 4.1.x)

We kindly request you NOT to substitute a physical MX against a virtual MX. This is NOT tested and apart from the struggle that people have in the field to bring this up it may not even work for uCPE with IPsec used. You already need a bunch of hardware devices to run a PoC so order an MX as well to be on the save side. Again: No vMX as part of the lab. We also have no intend for now to test MX150 for labs.

Unusable IP-Address Ranges for all Labs
---------------------------------------

CSO and NFX and the way the vSRX is integrated utilize a couple of IP-Address Ranges itself that you should not use in any lab you build. It’s important to know them because some are not even changeable.

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| IP-Address Range used                                                                                                                                                                                                                                                                                                                      | Used by                                                                                                                                                                                                                                                                                                                                    | Changeable Range?                                                                                                                                                                                                                                                                                                                          |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.2.0/24                                                                                                                                                                                                                                                                                                                             | NFX150 Phone-Home                                                                                                                                                                                                                                                                                                                          | No. Hardcoded in Firmware                                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.3.0/24                                                                                                                                                                                                                                                                                                                             | CSO VM Docker internal                                                                                                                                                                                                                                                                                                                     | Yes. Change during setup                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.122.0/24                                                                                                                                                                                                                                                                                                                           | KVM virbr0                                                                                                                                                                                                                                                                                                                                 | Yes. (will be deleted)                                                                                                                                                                                                                                                                                                                     |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.0.2.0/24                                                                                                                                                                                                                                                                                                                               | NFX-Series new internal OAM                                                                                                                                                                                                                                                                                                                | No. Hardcoded in Firmware                                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.10.0.0/24                                                                                                                                                                                                                                                                                                                               | NFX in uCPE use case                                                                                                                                                                                                                                                                                                                       | No. CSO design                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.10.1.0/24                                                                                                                                                                                                                                                                                                                               | NFX in uCPE use case                                                                                                                                                                                                                                                                                                                       | No. CSO design                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.10.2.0/24                                                                                                                                                                                                                                                                                                                               | NFX in uCPE use case                                                                                                                                                                                                                                                                                                                       | No. CSO design                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.10.3.0/24                                                                                                                                                                                                                                                                                                                               | NFX in uCPE use case                                                                                                                                                                                                                                                                                                                       | No. CSO design                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.10.4.0/24                                                                                                                                                                                                                                                                                                                               | NFX in uCPE use case                                                                                                                                                                                                                                                                                                                       | No. CSO design                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.10.5.0/24                                                                                                                                                                                                                                                                                                                               | NFX in uCPE use case                                                                                                                                                                                                                                                                                                                       | No. CSO design                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.10.10.0/24                                                                                                                                                                                                                                                                                                                              | NFX internal PHC                                                                                                                                                                                                                                                                                                                           | No.                                                                                                                                                                                                                                                                                                                                        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.10.20.0/24                                                                                                                                                                                                                                                                                                                              | NFX internal OAM (CSO4)                                                                                                                                                                                                                                                                                                                    | No. CSO design                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 172.16.0.0/16                                                                                                                                                                                                                                                                                                                              | CSO Kubernetes                                                                                                                                                                                                                                                                                                                             | Yes. Change during setup                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Used IP-Addresses and Ranges in this Lab
----------------------------------------

We have avoided using 10.0.0.0/8 and 172.16.0.0/12 as in most customer labs (and juniper internal) those are in use to manage devices and act also as connection to the outside.

We only use /24 subnets in the setup, even if only two peers are in that subnet, to make things not too confusing.

VLAN’s in this Lab are derived from the third Byte/Octet of the IPv4 subnet to make it simple to understand and debug.

+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| IP-Address Range used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Used by                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | CSO Installation and OAM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.1-9                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Default GW and Manage devices like Terminal servers                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.10-19                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | CSO and Contrail Host-IPs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.20-39                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Devices fxp0 (Switches/Routers/CPE’s)                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.40-69                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | CSO and other VM’s                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.70-89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Device Interface IP’s (in case they act as a Router)                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.90-99                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | IPMI of CSO and Contrail Host-IPs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.32.0/19                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Reserved (free) Range                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.64.0/18                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Other Transport networks (excluding 192.168.122.0/24)                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.64.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Second CSO OAM (for uCPE deploy opt 1 only)                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.65.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | OAM for NFX CPE (for uCPE deploy opt 1 only)                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.66.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | CSO Data Network (for uCPE deploy opt 1 only)                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.67.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Internet Network for CPE (for uCPE deploy opt 1 only)                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.68.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Contrail Data and Signalling Network (vCPE only)                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.69.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Contrail VRF for VNF Management Network (vCPE only)                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.70.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | QFX5100 Uplink to Internet NAT GW                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.71.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | unused                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.72.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | unused                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.73.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | unused                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.74.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | MX80 to NAT vSRX (vCPE only)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.75.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | MX80 to NAT vSRX for DATA (for uCPE deploy opt 1 only)                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.76.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | MX80 to NAT vSRX for OAM (for uCPE deploy opt 1 only)                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.99.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Dummy IPsec LAN for Internet (for uCPE deploy opt 1 only)                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.128.0/17                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Underlay Network’s between Spoke and Hubs                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.130.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan0 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.131.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan0 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.132.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan0 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.133.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan1 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.134.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan1 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.135.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan1 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.136.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan2 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.137.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan2 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.138.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan2 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.139.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan3 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.140.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan3 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.141.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke1 (NFX250-1) Wan3 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.150.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan0 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.151.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan0 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.152.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan0 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.153.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan1 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.154.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan1 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.155.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan1 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.156.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan2 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.157.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan2 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.158.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan2 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.159.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan3 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.160.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan3 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.161.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke2 (NFX250-2) Wan3 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.170.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan0 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.171.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan0 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.172.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan0 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.173.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan1 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.174.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan1 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.175.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan1 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.176.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan2 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.177.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan2 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.178.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan2 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.179.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan3 + DHCP-Server on QFX                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.180.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan3 to TC-VM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.181.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spoke3 (SRX345-1) Wan3 from TC-VM to Hub VR                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.190.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub1 (SRX1500-1) Wan0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.191.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub1 (SRX1500-1) Wan1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.192.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub1 (SRX1500-1) Wan2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.193.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub1 (SRX1500-1) Wan3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.194.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub1 (SRX1500-1) Secure OAM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.200.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub2 (SRX1500-1) Wan0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.201.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub2 (SRX1500-2) Wan1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.202.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub2 (SRX1500-2) Wan2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.203.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub2 (SRX1500-2) Wan3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.204.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Hub2 (SRX1500-1) Secure OAM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.210.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Secure OAM Loopback Range                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.99.99.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Desktop1 Client attach to NFX250-1 (only for uCPE)                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.88.88.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Desktop2 Client attach to SRX345-1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.77.77.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Desktop3 Client attach to MX80-1 (only for vCPE)                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 10.66.66.0/24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Desktop4 Client attach to NFX250-1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Here are the IP-Addresses assigned to each Host, Device or VM for this lab in the 192.168.10.0/24 CSO Installation and OAM Network.

If you need to have a tighter integration into a Customer Lab environment then only change the first three octets and not the last one to have an easy mapping.

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| IP-Address                                                                                                                                                                                                                                                                                                                                 | Interface Name                                                                                                                                                                                                                                                                                                                             | Assigned to                                                                                                                                                                                                                                                                                                                                |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.1                                                                                                                                                                                                                                                                                                                               | ge-0/0/1                                                                                                                                                                                                                                                                                                                                   | vSRX NAT as GW                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.2                                                                                                                                                                                                                                                                                                                               | eth0                                                                                                                                                                                                                                                                                                                                       | Raspberry-Pi-1                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.3                                                                                                                                                                                                                                                                                                                               | eth0                                                                                                                                                                                                                                                                                                                                       | Raspberry-Pi-2 (optional)                                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.5                                                                                                                                                                                                                                                                                                                               | ens3                                                                                                                                                                                                                                                                                                                                       | Automation VM                                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.10                                                                                                                                                                                                                                                                                                                              | p5p1                                                                                                                                                                                                                                                                                                                                       | CSO-Host (also the Lab DNS!!!)                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.11                                                                                                                                                                                                                                                                                                                              | p5p1                                                                                                                                                                                                                                                                                                                                       | CSO-Host2 (optional) (NOTE: not in this lab)                                                                                                                                                                                                                                                                                               |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.15                                                                                                                                                                                                                                                                                                                              | em1                                                                                                                                                                                                                                                                                                                                        | Contrail-Host                                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.20                                                                                                                                                                                                                                                                                                                              | fxp0                                                                                                                                                                                                                                                                                                                                       | QFX5100-1 (Note: No default GW configured)                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.21                                                                                                                                                                                                                                                                                                                              | fxp0                                                                                                                                                                                                                                                                                                                                       | MX80-1 (Note: No default GW configured)                                                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.190.254                                                                                                                                                                                                                                                                                                                            | ge-0/0/0                                                                                                                                                                                                                                                                                                                                   | SRX1500-1 **BEFORE PROVISION**                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.210.1                                                                                                                                                                                                                                                                                                                              | Lo.0                                                                                                                                                                                                                                                                                                                                       | SRX1500-1 **AFTER PROVISION**                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.200.254                                                                                                                                                                                                                                                                                                                            | ge-0/0/0                                                                                                                                                                                                                                                                                                                                   | SRX1500-2 **BEFORE PROVISION**                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.210.2                                                                                                                                                                                                                                                                                                                              | Lo.0                                                                                                                                                                                                                                                                                                                                       | SRX1500-2 **AFTER PROVISION**                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.130.2                                                                                                                                                                                                                                                                                                                              | ge-0/0/0                                                                                                                                                                                                                                                                                                                                   | NFX250-1 SD-WAN **BEFORE PROVISION**                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.210.4                                                                                                                                                                                                                                                                                                                              | Lo.0                                                                                                                                                                                                                                                                                                                                       | NFX250-1 SD-WAN **AFTER PROVISION**                                                                                                                                                                                                                                                                                                        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.25                                                                                                                                                                                                                                                                                                                              | fxp0                                                                                                                                                                                                                                                                                                                                       | NFX250-2 (Note: No default GW configured)                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.170.2                                                                                                                                                                                                                                                                                                                              | ge-0/0/0                                                                                                                                                                                                                                                                                                                                   | SRX345-1 SD-WAN **BEFORE PROVISION**                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.210.3                                                                                                                                                                                                                                                                                                                              | Lo.0                                                                                                                                                                                                                                                                                                                                       | SRX345-1 SD-WAN **AFTER PROVISION**                                                                                                                                                                                                                                                                                                        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.40                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | installervm.example.net                                                                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.41                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | centralinfravm.example.net                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.42                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | centralmsvm.example.net                                                                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.43                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | centralk8mastervm.example.net                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.44                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | unused in CSO >= 4.0                                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.45                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | unused in CSO >= 4.0                                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.46                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | unused in CSO >= 4.0                                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.47                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | regional-sblb.example.net                                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.48                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | canvm.example.net                                                                                                                                                                                                                                                                                                                          |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.49                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | vrr.example.net                                                                                                                                                                                                                                                                                                                            |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.50                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | spacevm.example.net (optional)                                                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.51                                                                                                                                                                                                                                                                                                                              | eth0                                                                                                                                                                                                                                                                                                                                       | spacevm-web.example.net (optional)                                                                                                                                                                                                                                                                                                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.60                                                                                                                                                                                                                                                                                                                              | ens3                                                                                                                                                                                                                                                                                                                                       | Desktop1 VM TMP during installation                                                                                                                                                                                                                                                                                                        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.70                                                                                                                                                                                                                                                                                                                              | ge-1/0/2                                                                                                                                                                                                                                                                                                                                   | mx80-1 to mgmt. VRF in Contrail for vCPE + **SD-WAN extended**                                                                                                                                                                                                                                                                             |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.90                                                                                                                                                                                                                                                                                                                              | ipmi                                                                                                                                                                                                                                                                                                                                       | IPMI of CSO-Host                                                                                                                                                                                                                                                                                                                           |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 192.168.10.95                                                                                                                                                                                                                                                                                                                              | em1                                                                                                                                                                                                                                                                                                                                        | IPMI of Contrail-Host                                                                                                                                                                                                                                                                                                                      |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Default Interfaces of CSO Templates for Devices
-----------------------------------------------

NFX150 as SD-WAN Spoke (HA not supported in V4.0.x and 4.1.0)

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Hardware Interface                                                                                                                                                                                                                                                                                                                         | CSO name                                                                                                                                                                                                                                                                                                                                   | Used for                                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| MGMT/fxp0                                                                                                                                                                                                                                                                                                                                  | fxp0                                                                                                                                                                                                                                                                                                                                       | Out of band manage                                                                                                                                                                                                                                                                                                                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/0/1                                                                                                                                                                                                                                                                                                                                   | WAN_0                                                                                                                                                                                                                                                                                                                                      | OAM and Data (MPLS)                                                                                                                                                                                                                                                                                                                        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/0/2                                                                                                                                                                                                                                                                                                                                   | WAN_1                                                                                                                                                                                                                                                                                                                                      | Data (Internet)                                                                                                                                                                                                                                                                                                                            |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/0/3                                                                                                                                                                                                                                                                                                                                   | WAN_2                                                                                                                                                                                                                                                                                                                                      | Optional Data                                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/0/4                                                                                                                                                                                                                                                                                                                                   | WAN_3                                                                                                                                                                                                                                                                                                                                      | Optional Data                                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/0                                                                                                                                                                                                                                                                                                                                   | LAN_0                                                                                                                                                                                                                                                                                                                                      | Attach LAN Client VM                                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

NFX250 as SD-WAN (Dual) Spoke and blue for NFX Deployment Option 1 (uCPE)

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Hardware Interface                                                                                                                                                                                                                                                                                                                         | CSO name                                                                                                                                                                                                                                                                                                                                   | Used for                                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| MGMT/fxp0                                                                                                                                                                                                                                                                                                                                  | fxp0                                                                                                                                                                                                                                                                                                                                       | Out of band manage (ZTP)                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/8                                                                                                                                                                                                                                                                                                                                   | WAN_0                                                                                                                                                                                                                                                                                                                                      | OAM and Data (MPLS)                                                                                                                                                                                                                                                                                                                        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/9                                                                                                                                                                                                                                                                                                                                   | WAN_1                                                                                                                                                                                                                                                                                                                                      | Data (Internet w. opt. IPsec)                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/10                                                                                                                                                                                                                                                                                                                                  | WAN_0                                                                                                                                                                                                                                                                                                                                      | OAM and Data (MPLS)                                                                                                                                                                                                                                                                                                                        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/11                                                                                                                                                                                                                                                                                                                                  | WAN_1                                                                                                                                                                                                                                                                                                                                      | Data (Internet)                                                                                                                                                                                                                                                                                                                            |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| xe-0/0/12                                                                                                                                                                                                                                                                                                                                  | WAN_2 / Internal HA                                                                                                                                                                                                                                                                                                                        | Optional Data / Redundancy Link                                                                                                                                                                                                                                                                                                            |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| xe-0/0/13                                                                                                                                                                                                                                                                                                                                  | WAN_3 / Internal HA                                                                                                                                                                                                                                                                                                                        | Optional Data / Redundancy Link                                                                                                                                                                                                                                                                                                            |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/0                                                                                                                                                                                                                                                                                                                                   | LAN_0 / ae1 redundant                                                                                                                                                                                                                                                                                                                      | Attach LAN Client VM                                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/1                                                                                                                                                                                                                                                                                                                                   | ae1 redundant                                                                                                                                                                                                                                                                                                                              | HA LAN_0 for Dual CPE                                                                                                                                                                                                                                                                                                                      |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

SRX3xx as SD-WAN Spoke

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Hardware Interface                                                                                                                                                                                                                                                                                                                         | CSO name                                                                                                                                                                                                                                                                                                                                   | Used for                                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| fxp0                                                                                                                                                                                                                                                                                                                                       | fxp0                                                                                                                                                                                                                                                                                                                                       | Out of band manage (ZTP)                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/0                                                                                                                                                                                                                                                                                                                                   | WAN_0                                                                                                                                                                                                                                                                                                                                      | OAM and Data (MPLS)                                                                                                                                                                                                                                                                                                                        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/1                                                                                                                                                                                                                                                                                                                                   | WAN_1                                                                                                                                                                                                                                                                                                                                      | Data (Internet)                                                                                                                                                                                                                                                                                                                            |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/2                                                                                                                                                                                                                                                                                                                                   | WAN_2                                                                                                                                                                                                                                                                                                                                      | Optional Data                                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/3                                                                                                                                                                                                                                                                                                                                   | WAN_3                                                                                                                                                                                                                                                                                                                                      | Optional Data                                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/4                                                                                                                                                                                                                                                                                                                                   | LAN_4                                                                                                                                                                                                                                                                                                                                      | Attach LAN Client VM                                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

SRXxxxx as SD-WAN Hub

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Hardware Interface                                                                                                                                                                                                                                                                                                                         | CSO name                                                                                                                                                                                                                                                                                                                                   | Used for                                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| fxp0                                                                                                                                                                                                                                                                                                                                       | fxp0                                                                                                                                                                                                                                                                                                                                       | Out of band manage (ZTP)                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/0                                                                                                                                                                                                                                                                                                                                   | WAN_0                                                                                                                                                                                                                                                                                                                                      | OAM and Data (MPLS)                                                                                                                                                                                                                                                                                                                        |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/1                                                                                                                                                                                                                                                                                                                                   | WAN_1                                                                                                                                                                                                                                                                                                                                      | Data (Internet)                                                                                                                                                                                                                                                                                                                            |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/2                                                                                                                                                                                                                                                                                                                                   | WAN_2                                                                                                                                                                                                                                                                                                                                      | Optional Data                                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/3                                                                                                                                                                                                                                                                                                                                   | WAN_3                                                                                                                                                                                                                                                                                                                                      | Optional Data                                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-0/0/4                                                                                                                                                                                                                                                                                                                                   | n/a                                                                                                                                                                                                                                                                                                                                        | Peering with MX as PE (direct connect)                                                                                                                                                                                                                                                                                                     |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

MX as vCPE DC-R, uCPE and SD-WAN PE (not covered by a CSO template)

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Hardware Interface                                                                                                                                                                                                                                                                                                                         | CSO name                                                                                                                                                                                                                                                                                                                                   | Used for                                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| fxp0                                                                                                                                                                                                                                                                                                                                       | fxp0                                                                                                                                                                                                                                                                                                                                       | Out of band manage                                                                                                                                                                                                                                                                                                                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/0/0                                                                                                                                                                                                                                                                                                                                   | WAN_0                                                                                                                                                                                                                                                                                                                                      | OAM and Data (MPLS) uCPE                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/1/0                                                                                                                                                                                                                                                                                                                                   | WAN_1                                                                                                                                                                                                                                                                                                                                      | Data (Internet) uCPE                                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/0/1                                                                                                                                                                                                                                                                                                                                   | OAM                                                                                                                                                                                                                                                                                                                                        | OAM to second CSO subnet uCPE                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/1/1                                                                                                                                                                                                                                                                                                                                   | Contrail BGP+Data                                                                                                                                                                                                                                                                                                                          | Link to Contrail Fabric vCPE                                                                                                                                                                                                                                                                                                               |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/0/2                                                                                                                                                                                                                                                                                                                                   | Manage towards CSO                                                                                                                                                                                                                                                                                                                         | To Mgmt. VRF in Contrail for vCPE                                                                                                                                                                                                                                                                                                          |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/1/2                                                                                                                                                                                                                                                                                                                                   | Client3 LAN                                                                                                                                                                                                                                                                                                                                | vCPE Client3                                                                                                                                                                                                                                                                                                                               |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/0/3                                                                                                                                                                                                                                                                                                                                   | Manage towards CSO2                                                                                                                                                                                                                                                                                                                        | SD-WAN to CSO                                                                                                                                                                                                                                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/1/3                                                                                                                                                                                                                                                                                                                                   | Link to Hub1                                                                                                                                                                                                                                                                                                                               | Peering with Hub1 (direct connect)                                                                                                                                                                                                                                                                                                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ge-1/0/4                                                                                                                                                                                                                                                                                                                                   | Link to Hub2                                                                                                                                                                                                                                                                                                                               | Peering with Hub2 (direct connect)                                                                                                                                                                                                                                                                                                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Cable-Plan (for EMEA loan pool-Racks and OpenLab)
-------------------------------------------------

.. note:: The EMEA CSO Loan-Pool Racks implement EVERYTHING (including vCPE and uCPE scenarios) while on OpenLab the focus is on SD-WAN only. As a result there is lesser to wire/patch in the OpenLab design if the limits are fine with you. Both plans use similar ports and demand a QFX5100 48Port Switch as underlay. They may differ on how and where the CSO-Host is attached but this is usually 1-2ports.

EMEA CSO-Rack from Loan-Pool

|image3|

|image4|

Embedded Excel-File of Cable-Plan

**DOWNLOAD**
`CSO-Demo-Racks-Cabling-Plan-HS08.xlsx <CSO-Demo-Racks-Cabling-Plan-HS08.xlsx>`__


|image5|

OpenLab (example DC72)

|image6|

Topologies for the different Lab-Setups
---------------------------------------

In these Slides we do NOT show all connections and how the physical connections are structured. For each Lab we only show the relevant connections and networks.

|image7|

|image8|

|image9|

|image10|

|image11|

|image12|

|image13|

|image14|

|image15|

|image16|

Lab access and default passwords
--------------------------------

In the current Lab the CSO Management lab is separated from the EMEA PoC Lab. Access is avail if you are connected to the Juniper VPN. This lab-gw-ip unique an subject to change in every installation of the lab.

.. code-block:: none

   NAT-GW VM has    172.30.200.155    

The NAT-GW VM redirects the following ports to the CSO-Host at 192.168.10.10

+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Port (Range)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Used by                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 22                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | SSH                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 3128                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Squid Proxy for lab access                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 5900-5999                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | VNC Remote-Consoles of the VM’s on the CSO-Host                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

As a result you should open **first a SSH session** from outside **to**\ root@172.30.200.155\ **(juniper123)** to land on the CSO-Host and then launch the next SSH session to all host/devices/VM’s that are in the 192.168.10.0/24 Lab-Management network

The NAT-GW VM redirects the following ports to the central-msvm at 192.168.10.42

+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Port (Range)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Used by                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 443                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | CSO-GUI (for Admins and Tenants)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 83                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | CSO-NSD UI (Admins and PS)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

.. note:: If you do not which to configure a browser proxy and you only want to access the regular CSO GUI or NSD. Then you can use the forwarding we do above to get there directly like **Error! Hyperlink reference not valid.**> or **Error! Hyperlink reference not valid.**>:83

To **access ALL web-pages in this lab add a proper proxy** configuration to your browser.

On Firefox (tested for Windows) we use FoxyProxy Standard as you can see below:

|image17|

|image18|

|image19|

.. note:: Make sure you delete all other White/Black Patterns

Then make sure to enable the Proxy

|image20|

.. note:: On IPMI remote access to the Servers it has been found that the Java Remote Console doesn’t work through a Proxy. This is only as Limit for the CSO-Host IPMI on IP-Address 192.168.10.90 where you have to use the modern HTML5 Client for remote console to the Server instead.

To access the Screen of any VM on the CSO-Host please use your favourite VNC-Client (on windows UltraVNC it a good choice) and point it to 172.30.200.155:x

To find the :x of any VM you need an ssh-session to the cso-host first and then use the command “virsh vncdisplay <vm-name>” like in the example below.

.. code-block:: none

   virsh list --all
    Id    Name                           State
   ----------------------------------------------------
    21    canvm                          running
    22    centralk8mastervm              running
    24    centralinfravm                 running
    26    regional-sblb                  running
    27    vrr                            running
    29    desktop2                       running
    30    desktop3                       running
    31    delayvm                        running
    33    centralmsvm                    running
    42    natvm                          running
    43    desktop1                       running
    45    desktop4                       running
    -     installervm                    shut off

   virsh vncdisplay desktop1
   :8

As a result of the query above you can now be formed

|image21|

and you see the screen of where you wanted to be

|image22|

Last but not least here are the ssh-access credentials of the Devices/Hosts/VM’s

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Device/Host/VM                                                                                                                                                                                                                                                                                                                             | Username                                                                                                                                                                                                                                                                                                                                   | Password                                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Nat-Lab GW                                                                                                                                                                                                                                                                                                                                 | root                                                                                                                                                                                                                                                                                                                                       | juniper123                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Raspberry Pi                                                                                                                                                                                                                                                                                                                               | root                                                                                                                                                                                                                                                                                                                                       | Lab58fgr#-1                                                                                                                                                                                                                                                                                                                                |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CSO-Host                                                                                                                                                                                                                                                                                                                                   | root                                                                                                                                                                                                                                                                                                                                       | juniper123                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Contrail-Host                                                                                                                                                                                                                                                                                                                              | root                                                                                                                                                                                                                                                                                                                                       | juniper123                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| QFX5100-1                                                                                                                                                                                                                                                                                                                                  | root                                                                                                                                                                                                                                                                                                                                       | juniper123                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| MX80-1                                                                                                                                                                                                                                                                                                                                     | root                                                                                                                                                                                                                                                                                                                                       | juniper123                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| NFX250-1                                                                                                                                                                                                                                                                                                                                   | root                                                                                                                                                                                                                                                                                                                                       | Embe1mpls                                                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| NFX250-2                                                                                                                                                                                                                                                                                                                                   | root                                                                                                                                                                                                                                                                                                                                       | Embe1mpls                                                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SRX345-1                                                                                                                                                                                                                                                                                                                                   | root                                                                                                                                                                                                                                                                                                                                       | Embe1mpls                                                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SRX1500-1                                                                                                                                                                                                                                                                                                                                  | root                                                                                                                                                                                                                                                                                                                                       | Embe1mpls                                                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SRX1500-2                                                                                                                                                                                                                                                                                                                                  | root                                                                                                                                                                                                                                                                                                                                       | Embe1mpls                                                                                                                                                                                                                                                                                                                                  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Desktop1                                                                                                                                                                                                                                                                                                                                   | root or juniper                                                                                                                                                                                                                                                                                                                            | juniper123                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Desktop2                                                                                                                                                                                                                                                                                                                                   | root or juniper                                                                                                                                                                                                                                                                                                                            | juniper123                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Desktop3                                                                                                                                                                                                                                                                                                                                   | root or juniper                                                                                                                                                                                                                                                                                                                            | juniper123                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Desktop4                                                                                                                                                                                                                                                                                                                                   | root or juniper                                                                                                                                                                                                                                                                                                                            | juniper123                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| All CSO provisioned VM’s                                                                                                                                                                                                                                                                                                                   | root                                                                                                                                                                                                                                                                                                                                       | passw0rd                                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

How to access the GUI’s
-----------------------

.. note:: You need to configure a Browser Proxy to access **ALL** these GUI’s as those are local IPs that are not routed outside of the Lab due to the natvm!

.. code-block:: none

   - Accessing Automation Git and GUI

           http://192.168.10.5:9080   (root/juniper123)
           http://192.168.10.5:8670   (root/juniper123)

   - Accessing NSD-UI

           https://192.168.10.42:83/nsd-ui/index.html (cspadmin/Juniper123!)

   - Accessing Admin-portal-ui

           https://192.168.10.42 (cspadmin/Juniper123!)

   - Accessing SIM

           http://192.168.10.42:1947/icingaweb2

           Default Creds: icinga/ use the password from dynamic list

   - Accessing KIBANA

           http://192.168.10.41:5601 (admin/Elasticsearch password that is generated during CSO installation)


           Please click on the CREATE tab under 'settings' on      
           kibana UI in order to create the 'csplogs*' index.

   - Infra and Microserices - Haproxy status page

           http://192.168.10.42:1936
           http://192.168.10.47:1936


   Grafana
   -------
   http://192.168.10.42:3000    sign-up or use hschroeder@juniper.net/testtest


   Prometheus
   ----------
   http://192.168.10.42:30900   use the password from dynamic list


   OpenStack VIM and Contrail-GUI
   ------------------------------
   http://192.168.10.15/horizon (admin/contrail123)
   https://192.168.10.15:8143   (admin/contrail123)

   Configuration Designer
   https://192.168.10.42:83/cd-ui/index.html (cspadmin/Juniper123!)

   Resource Designer
   https://192.168.10.42:83/rd-ui/index.html (cspadmin/Juniper123!)

Dynamic CSO passwords
---------------------

Starting with CSO 3.3 dynamic and RANDOM passwords are enforced for all components. Below is a list of the one installation as part of the execution of the setup_assist.sh script. In your environment they will not be the same so you have to adapt to the list your environment installation will generate.

.. code-block:: none

   UI Password for cspadmin user: Wy6dtEtPBR@Y         <- Initial GUI Password
   Keystone Password for admin user: 5DQkO6ME2Y87
   Arangodb root user password: TdWHlGUKaBsczohL
   Cassandra DB password for cassandra user: 8XWivLiFCPpNFf
   Cassandra DB password for casadmin user: hlthrIDbuYCM
   Elasticsearch admin Password: Mj7SoiykdPFVtvU
   Keystone Password for swift user: nIFGSEfbpsHD26d1
   Mariadb Password for root/admin user: 3IyCk09jyLpDLrYt
   Mariadb Password for clusteruser user: 5Eu8ffAQ9euEQA
   Prometheus user Password: Nm4kT9vt0nPXf
   Rabbitmq cspmq Password: W6O2cfpF3k3GQJ
   Icinga UI Password: DOnOSUk5nmYzHxf3
   Zookeeper Password for admin user: 2ZE2MqpCJws8r

Firmware and Software to use for CSO 4.1.0
------------------------------------------

The **RELEASENOTES** always have a section where the Junos **Firmware to use** is noted. You may not find these builds in the official pages but the links in the release notes give you the downloads from the official Juniper website.

Make sure to always use the tested build for a CSO version!

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Device                                                                                                                                                                                                                                                                                                                                     | Version                                                                                                                                                                                                                                                                                                                                    | Download URL                                                                                                                                                                                                                                                                                                                               |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| NFX250                                                                                                                                                                                                                                                                                                                                     | 15.1X53-D496                                                                                                                                                                                                                                                                                                                               | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/87998.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| NFX150                                                                                                                                                                                                                                                                                                                                     | 18.2X85D11                                                                                                                                                                                                                                                                                                                                 | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/87999.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SRX3xx                                                                                                                                                                                                                                                                                                                                     | 15.1X49-D170                                                                                                                                                                                                                                                                                                                               | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/87870.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SRX1500                                                                                                                                                                                                                                                                                                                                    | 15.1X49-D170                                                                                                                                                                                                                                                                                                                               | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/87873.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SRX4xxx                                                                                                                                                                                                                                                                                                                                    | 15.1X49-D170                                                                                                                                                                                                                                                                                                                               | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/87872.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| vSRX                                                                                                                                                                                                                                                                                                                                       | 15.1X49-D170                                                                                                                                                                                                                                                                                                                               | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/87892.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| MX80                                                                                                                                                                                                                                                                                                                                       | 17.4R1.16                                                                                                                                                                                                                                                                                                                                  | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/72215.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| QFX5100                                                                                                                                                                                                                                                                                                                                    | 17.3R2.10                                                                                                                                                                                                                                                                                                                                  | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/73642.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CSO-Host                                                                                                                                                                                                                                                                                                                                   | Ubuntu 14.04.5                                                                                                                                                                                                                                                                                                                             | http://releases.ubuntu.com/14.04/ubuntu-14.04.5-server-amd64.iso                                                                                                                                                                                                                                                                           |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CSO-core                                                                                                                                                                                                                                                                                                                                   | 4.1.0                                                                                                                                                                                                                                                                                                                                      | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/88102.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CSO-KVM                                                                                                                                                                                                                                                                                                                                    | 4.1.0                                                                                                                                                                                                                                                                                                                                      | https://webdownload.juniper.net/swdl/dl/secure/site/1/record/88105.html                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

KNOWN BUGs in CSO 4.1.0 FRS
---------------------------

.. warning:: Note: These Bugs where discovered with the FRS release (Build 4.1.0.0rc0.dev14646) of CSO 4.1 and the official release documentation.

**BUG1:** When you deploy a hardware based SRX300 + SRX320 as Spoke you “may” get an error message during provision and it may about the process. It will complain about not able to install default Certifcates.

|image23|

Just a retry of the Job does usually not fix this behaviour. Disable it in the device-profile “SRX as SD-WAN CPE” as below an the try the retry of the Job.

The workaround to prevent this from happening is to disable certificate installation in the device template as below.

|image24|

.. note:: It looks like this only happens for SRX300/320; the SRX345 seem not to be affected. This may be because the SSL-Proxy-Feature is not supported on these Platforms anyway (the Releasenotes mention this). Remember that we told you in chapter 2.2 above to use the SRX345 as Spoke!

**BUG2:** The official firewall ruleset describing the CSO-behind-Nat installation (which we don’t do in this lab) has multiple Bugs and is inaccurate. Please review chapter 8.5 below for a better one.

**BUG3:** Jira-Ticket `CXU-32897 <https://aspg-jira.juniper.net/browse/CXU-32897>`__ In some cases the Device Provisioning process may fail with and error message like this:

|image25|

It was found that the FMPM-Collector Microservice was down and you need to restart it’s Docker contrainer to fix this issue. The engineering Team is looking to provide RCA. Meanwhile do the following if you are in a similar situation:

.. code-block:: none

   ssh root@192.168.10.42 (passw0rd)
   
   cd /opt/csp/logs/tssm-core
   cat tssm.log | grep ERROR
   .
   2019-03-05 13:06:17,788 ERROR    DeviceManager        device_manager.py[line:3619]   _wait_fmpm_api_notif failed with timeout exception
   2019-03-05 13:06:17,835 ERROR    tssm                 job_logger.py[line:133]   create monitored object for device 40ca3b26-505d-4eea-85a6-62d0fcd86d4a FAILED. Monitoring for this device not supported
   2019-03-05 13:06:17,837 ERROR    DeviceManager        device_manager.py[line:9145]   create monitored object for device 40ca3b26-505d-4eea-85a6-62d0fcd86d4a FAILED. Monitoring for this device not supported
   .
   kubectl get service -n central | grep fmpm
   csp-fmpm-provider                192.168.3.31    <nodes>       8082:32202/TCP                                 22h

   kubectl get service -n central csp-fmpm-provider
   NAME                CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
   csp-fmpm-provider   192.168.3.31   <nodes>       8082:32202/TCP   22h
   
   docker ps | grep provider-core
   74fe43ac2f96        csp-installer:10000/fmpm-provider-core-svr@sha256:380814feff6d20f00177793427775937f296857e26b383b8180cdbc4c5bdfe73               "/csp-service-dock..."   20 hours ago        Up 18 hours                             k8s_fmpm-provider-core_csp.csp-fmpm-provider-core-2773159510-xl20m_central_d2051ae7-3f36-11e9-8948-0242ac106202_1
   a2e2b0520ce3        csp-installer:10000/pause-amd64:3.0                                                                                              "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_csp.csp-fmpm-provider-core-2773159510-xl20m_central_d2051ae7-3f36-11e9-8948-0242ac106202_1

   docker restart 74fe43ac2f96

   docker ps | grep provider-api
   ca423ceb1b29        csp-installer:10000/fmpm-provider-api-svr@sha256:793710c9eaf387e85e1803e1c1ead4228588becfc801be1d805304cbf1cf45f2                "/csp-service-dock..."   20 hours ago        Up 18 hours                             k8s_fmpm-provider_csp.csp-fmpm-provider-2968057203-17f7j_central_da08d5c0-3f36-11e9-8948-0242ac106202_1

   docker restart ca423ceb1b29

   # Do this so that engineering can look at the logs later
   cd
   ./getlogs.sh

Test cases that have not been tested again with CSO 4.1.0 are:

-  All vCPE test cases (last test was with 3.3.1). Note: These are frozen anyway and CSO 4.1 is the last version with official support for it.
-  All uCPE test cases (last test was with 3.3.1). Note: These are frozen anyway
-  All SD-WAN security tests in chapter 6.6.7 below (last test was with 4.0.1)
-  The Local-Breakout tests cases (last test was with 3.3.1)
-  Device RMA (last test was with 4.0.2)
-  The SD-Wan endpoint in AWS (last test was with 3.3.1)

Should you find any Bug in those please alert the Team

Installation of the Lab
=======================

The whole process (even if you do not include vCPE and jump over to Chapter 3.2 below) usually takes a minimum of 4hours. So plan 1-2 days as you never know what’s going to happen. Also make sure to perform a Backup after the installation.

Contrail-Host (optional and only needed for vCPE)
-------------------------------------------------

.. note:: Jump over this Chapter if you intend only demonstrating SD-WAN.

Install the Host OS onto the Server
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

USB-Key or PXE boot via Raspberry Pi of the CSO-Rack

.. code-block:: none

   ssh root@192.168.10.2/172.30.200.152       (Lab58fgr#-1)
   cd /root
   service cobblerd start
   
   cobbler system remove --name=contrail-host
   cobbler system add --name=contrail-host --profile=ubuntu14045-x86_64
   cobbler profile edit --name=ubuntu14045-x86_64 --kopts="netcfg/choose_interface=em1"
   cobbler system edit --name=contrail-host --interface=em1 --mac=14:fe:b5:da:b7:00 --ip-address=192.168.10.15
   cobbler system edit --name=contrail-host --power-type=ipmilan --power-address=192.168.10.95 --power-user=root --power-pass=calvin
   
   vi /etc/cobbler/dhcp.template
   # disable dynamic range
   #     range dynamic-bootp

   # add the host below subnet xx {}
   host contrail-host {
     hardware ethernet 14:fe:b5:da:b7:00;
     fixed-address 192.168.10.15;
     #
     option routers        192.168.10.1;
     option subnet-mask    255.255.255.0;
     next-server           192.168.10.2;
     class "pxeclients" {
       match if substring (option vendor-class-identifier, 0, 9) = "PXEClient";
         if option pxe-system-type = 00:06 {
           filename "grub/grub-x86.efi";
         } else if option pxe-system-type = 00:07 {
           filename "grub/grub-x86_64.efi";
         } else {
           filename "pxelinux.0";
       }
     }
   }
   
   cobbler sync
   
   cobbler system reboot --name=contrail-host
   
   # wait until it the system is up-again
   tcpdump -n -v -i eth0 ether host 14:fe:b5:da:b7:00
   tailf /var/log/apache2/access.log
   
   service isc-dhcp-server stop
   service cobblerd stop

Host OS preparation
~~~~~~~~~~~~~~~~~~~

Deployment guide CSO V3.2 states “Contrail Release 3.2.5 with OpenStack Mitaka”

.. code-block:: none

   #https://webdownload.juniper.net/swdl/dl/secure/site/1/record/69888.html

   scp root@192.168.10.10:/root/contrail-inst* .
   ls -l
   -rw-r--r-- 1 root root 1004216744 Mar 19 03:36 contrail-install-packages_3.2.5.0-51~ubuntu-14-04mitaka_all.deb
   md5sum contrail-install-packages_3.2.5.0-51~ubuntu-14-04mitaka_all.deb
   2c8881d3935ce64bea8cb0b5ad73d56a  contrail-install-packages_3.2.5.0-51~ubuntu-14-04mitaka_all.deb

.. code-block:: none

   cat <<EOF > /etc/hosts
   127.0.0.1       localhost
   192.168.10.15    contrail-host
   
   # The following lines are desirable for IPv6 capable hosts
   ::1     ip6-localhost ip6-loopback
   fe00::0 ip6-localnet
   ff00::0 ip6-mcastprefix
   ff02::1 ip6-allnodes
   ff02::2 ip6-allrouters
   EOF

.. code-block:: none

   cat <<EOF > /etc/apt/sources.list
   #------------------------------------------------------------------------------#
   #                            OFFICIAL UBUNTU REPOS                             #
   #------------------------------------------------------------------------------#
   
   
   ###### Ubuntu Main Repos
   deb http://us.archive.ubuntu.com/ubuntu/ trusty main restricted universe multiverse 
   
   ###### Ubuntu Update Repos
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-security main restricted universe multiverse 
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-updates main restricted universe multiverse 
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-proposed main restricted universe multiverse 
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-backports main restricted universe multiverse
   EOF
   
   apt-get update

.. code-block:: none

   dpkg -l | grep libnl-3-200
   ii  libnl-3-200:amd64                    3.2.21-1ubuntu4.1                          amd64        library for dealing with netlink sockets
   
   apt-get install -y libnl-3-200
   apt-get install -y libnl-route-3-200

Install the Contrail Fabric
~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   dpkg -i contrail-install-packages_3.2.5.0-51~ubuntu-14-04mitaka_all.deb
   cd /opt/contrail/contrail_packages/
   ./setup.sh all
   cd /opt/contrail/utils/
   cp fabfile/testbeds/testbed_singlebox_example.py fabfile/testbeds/testbed.py

.. code-block:: none

   cat <<EOF > fabfile/testbeds/testbed.py
   from fabric.api import env
   
   #Management ip addresses of hosts in the cluster
   host1 = 'root@192.168.10.15'
   
   
   #External routers if any
   #for eg.
   ext_routers = [('mx80', '169.254.169.254')]
   #ext_routers = []
   
   #Autonomous system number
   router_asn = 64512
   
   #Host from which the fab commands are triggered to install and provision
   host_build = 'root@192.168.10.15'
   
   
   #Role definition of the hosts.
   env.roledefs = {
       'all': [host1],
       'cfgm': [host1],
       'openstack': [host1],
       'control': [host1],
       'compute': [host1],
       'collector': [host1],
       'webui': [host1],
       'database': [host1],
       'build': [host_build],
   }
   
   #Openstack admin password
   env.openstack_admin_password = 'contrail123'
   
   env.hostnames = {
       host1: 'contrail-host',
   }
   
   # Passwords of each host
   # for passwordless login's no need to set env.passwords,
   # instead populate env.key_filename in testbed.py with public key.
   env.passwords = {
       host1: 'juniper123',
       host_build: 'juniper123',
   }
   
   
   #For reimage purpose
   env.ostypes = {
       host1:'ubuntu',
   }
   
   #ntp server the servers should point to
   env.ntp_server = '192.168.10.10'
   
   minimum_diskGB = 128
   
   
   #OPTIONAL SEPARATION OF MANAGEMENT AND CONTROL + DATA and OPTIONAL VLAN INFORMATION
   #==================================================================================
   control_data = {
       host1 : { 'ip': '192.168.68.15/24', 'gw' : '192.168.68.1', 'device': 'em2' },
   }
   
   #OPTIONAL STATIC ROUTE CONFIGURATION
   #===================================
   static_route  = {
       host1 : [ { 'ip': '169.254.169.254', 'netmask' : '255.255.255.255', 'gw':'192.168.68.1', 'intf': 'em2' }],
   }
   
   #To enable multi-tenancy feature
   multi_tenancy = True
   
   
   #To Enable prallel execution of task in multiple nodes
   do_parallel = True
   
   # To configure the encapsulation priority. Default: MPLSoGRE
   #env.encap_priority =  "'MPLSoUDP','MPLSoGRE','VXLAN'"
   EOF

.. code-block:: none

   fab install_contrail
   # system reboots at the end of this task
   
   cd /opt/contrail/utils
   fab upgrade_kernel_all
   # system reboots at the end of this task
   
   cd /opt/contrail/utils/
   uname -r
   3.13.0-110-generic    ## Very important to check this!!!
   
   fab setup_interface
   fab add_static_route
   
   fab setup_all
   # system reboots at the end of this task

After Fabric installation tasks
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   cat /etc/contrail/keystonerc
   export OS_USERNAME=admin
   export SERVICE_TOKEN=9ba2f2b76878225d3382
   export OS_SERVICE_ENDPOINT=http://192.168.68.15:35357/v2.0
   export OS_REGION_NAME=RegionOne
   export AUTH_PROTOCOL=http
   export OS_CACERT=
   export KEYSTONE_VERSION=v2.0

.. code-block:: none

   source /etc/contrail/openstackrc
   keystone endpoint-list
   +----------------------------------+-----------+----------------------------------------------+----------------------------------------------+----------------------------------------------+----------------------------------+
   |                id                |   region  |                  publicurl                   |                 internalurl                  |                   adminurl                   |            service_id            |
   +----------------------------------+-----------+----------------------------------------------+----------------------------------------------+----------------------------------------------+----------------------------------+
   | 116bc61bcf7b49be8931f17f050edcdc | RegionOne |         http://192.168.68.15:8000/v1         |         http://192.168.68.15:8000/v1         |         http://192.168.68.15:8000/v1         | cac53e7f387b40a398d155673adaf2b9 |
   | 25a0b9227b0c4030b8e51675e447c571 | RegionOne |  http://192.168.68.15:8776/v2/$(tenant_id)s  |  http://192.168.68.15:8776/v2/$(tenant_id)s  |  http://192.168.68.15:8776/v2/$(tenant_id)s  | 3247e86a3f7d4651a5eed0cada5af6e6 |
   | 2dca4949e64c47c5b2af7b922b1952c4 | RegionOne |          http://192.168.68.15:9292           |          http://192.168.68.15:9292           |          http://192.168.68.15:9292           | 62a43183aa154bef9966f78945176ff6 |
   | 391b96392851490990c9513e89a3a340 | RegionOne |  http://192.168.68.15:8004/v1/%(tenant_id)s  |  http://192.168.68.15:8004/v1/%(tenant_id)s  |  http://192.168.68.15:8004/v1/%(tenant_id)s  | d60f532e6bda4fd3933e62788c9dc411 |
   | 5adb697e93e1474faa028e0e4b248013 | RegionOne |     http://localhost:8773/services/Cloud     |     http://localhost:8773/services/Cloud     |     http://localhost:8773/services/Admin     | cff6112c602b48b3bab71426d68397c6 |
   | 80614c4f10f142ffa3ead9d21c69bb11 | RegionOne |  http://192.168.68.15:$(public_port)s/v2.0   |   http://192.168.68.15:$(admin_port)s/v2.0   |   http://192.168.68.15:$(admin_port)s/v2.0   | d913a393649047a181ef85a991f035e4 |
   | a7216c94979d443f831cece7ce0c3242 | RegionOne |          http://192.168.68.15:9696           |          http://192.168.68.15:9696           |          http://192.168.68.15:9696           | c57d1861fbb143378946d00fde884116 |
   | be4605c236064f9cabb2042eed6b4dc5 | RegionOne |          http://192.168.68.15:9311           |          http://192.168.68.15:9311           |          http://192.168.68.15:9311           | 7b3de9dadd1b42e5a134f5803cea0f54 |
   | d962b54df8304c9e824da8aa05086645 | RegionOne | http://192.168.68.15:8774/v2.1/%(tenant_id)s | http://192.168.68.15:8774/v2.1/%(tenant_id)s | http://192.168.68.15:8774/v2.1/%(tenant_id)s | 61824b1465ee4a708f00bdc50de8a784 |
   +----------------------------------+-----------+----------------------------------------------+----------------------------------------------+----------------------------------------------+----------------------------------+

#

# contrail needs to re-route packets as his 192.168.68.15 ip is the endpoint for keystone

#

.. code-block:: none

   echo 1 > /proc/sys/net/ipv4/ip_forward
   # and made permanent for next boot
   sed -i '/net.ipv4.ip_forward/s/^#//g' /etc/sysctl.conf
   sysctl -p /etc/sysctl.conf

CSO-Host and CSO itself
-----------------------

.. _install-the-host-os-onto-the-server-1:

Install the Host OS onto the Server
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

USB-Key or PXE boot via Raspberry Pi of the CSO-Rack.

Reminder to make **sure SWAP space is manually configured to be no larger than 32GB** as described in Chapter 2.1 above

.. code-block:: none

   ssh 192.168.10.2/172.30.200.152       root/Lab58fgr#-1
   cd /root
   service cobblerd start
   
   cobbler system remove --name=cso-host
   cobbler system add --name=cso-host --profile=ubuntu14045-x86_64
   cobbler profile edit --name=ubuntu14045-x86_64 --kopts="netcfg/choose_interface=p5p1"
   cobbler system edit --name=cso-host --interface=p5p1 --mac=90:e2:ba:d7:10:b0 --ip-address=192.168.10.10
   cobbler system edit --name=cso-host --power-type=ipmilan --power-address=192.168.10.90 --power-user=ADMIN --power-pass=ADMIN
   
   vi /etc/cobbler/dhcp.template
   # disable dynamic range
   #     range dynamic-bootp

   # add the host below subnet xx {}
   host cso-host {
     hardware ethernet     90:e2:ba:d7:10:b0;
     fixed-address         192.168.10.10;
     #
     option routers        192.168.10.1;
     option subnet-mask    255.255.255.0;
     next-server           192.168.10.2;
     class "pxeclients" {
       match if substring (option vendor-class-identifier, 0, 9) = "PXEClient";
         if option pxe-system-type = 00:06 {
           filename "grub/grub-x86.efi";
         } else if option pxe-system-type = 00:07 {
           filename "grub/grub-x86_64.efi";
         } else {
           filename "pxelinux.0";
       }
     }
   }
   
   cobbler sync
   
   cobbler system reboot --name=contrail-host
   
   # wait until it the system is up-again
   tailf /var/log/syslog | grep 90:e2:ba:d7:10:b0
   tailf /var/log/apache2/access.log
   
   service isc-dhcp-server stop
   service cobblerd stop

.. _host-os-preparation-1:

Host OS preparation
~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   cat <<EOF > /etc/apt/sources.list
   #------------------------------------------------------------------------------#
   #                            OFFICIAL UBUNTU REPOS                             #
   #------------------------------------------------------------------------------#
   
   
   ###### Ubuntu Main Repos
   deb http://us.archive.ubuntu.com/ubuntu/ trusty main restricted universe multiverse 
   
   ###### Ubuntu Update Repos
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-security main restricted universe multiverse 
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-updates main restricted universe multiverse 
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-proposed main restricted universe multiverse 
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-backports main restricted universe multiverse
   EOF
   
   apt-get update

.. note:: Exchange the p5p1 value with the local 10Gbit/s interface on your server!

.. code-block:: none

   cat <<EOF >/etc/hosts
   # The following lines are desirable for IPv6 capable hosts
   ::1     localhost ip6-localhost ip6-loopback
   ff02::1 ip6-allnodes
   ff02::2 ip6-allrouters
   127.0.0.1 localhost.example.net localhost
   192.168.10.10 cso-host.example.net cso-host
   EOF
   
   echo 'cso-host.example.net' >/etc/hostname
   hostname -F /etc/hostname
   hostname
   
   apt-get -y install qemu-kvm libvirt-bin virtinst virt-top genisoimage bridge-utils vlan
   # packages needed by CSO provision_vm-script
   apt-get -y install software-properties-common python-pip
   
   # add user/group for root in libvirtd
   sed -i 's/#user = "root"/user = "root"/g' /etc/libvirt/qemu.conf
   sed -i 's/#group = "root"/group = "root"/g' /etc/libvirt/qemu.conf
   service libvirt-bin restart
   
   
   cp /etc/network/interfaces /etc/network/interfaces.orig
   cat <<EOF > /etc/network/interfaces
   # This file describes the network interfaces available on your system
   # and how to activate them. For more information, see interfaces(5).
   
   # The loopback network interface
   auto lo
   iface lo inet loopback
   
   # The primary network interface
   auto p5p1
   iface p5p1 inet manual
     up ifconfig p5p1 0.0.0.0 up
   
   auto virbr0
   iface virbr0 inet static
     bridge_ports p5p1
     bridge_stp off
     bridge_fd 0
     bridge_maxwait 0
      address 192.168.10.10
      netmask 255.255.255.0
      gateway 192.168.10.1
      dns-nameservers 192.168.10.10
   EOF

#

# Caution you must execute this before you apply the new network changes

#

.. code-block:: none

   cat <<EOF >/root/defaultnetwork.xml
   <network>
     <name>default</name>
     <forward mode='bridge'/>
     <bridge name='virbr0'/>
   </network>
   EOF
   
   virsh net-destroy default
   virsh net-undefine default
   virsh net-create --file /root/defaultnetwork.xml
   
   ufw disable
   iptables -F
   iptables -X
   iptables -t nat -F
   iptables -t nat -X
   iptables -t mangle -F
   iptables -t mangle -X
   iptables -t raw -F
   iptables -t raw -X
   iptables -P INPUT ACCEPT
   iptables -P FORWARD ACCEPT
   iptables -P OUTPUT ACCEPT
   
   reboot
   
   ifconfig
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:1058 errors:0 dropped:0 overruns:0 frame:0
             TX packets:1058 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1
             RX bytes:86108 (86.1 KB)  TX bytes:86108 (86.1 KB)
   
   p1p1      Link encap:Ethernet  HWaddr 90:e2:ba:d7:1f:18
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:24741342 errors:0 dropped:939 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:8210439810 (8.2 GB)  TX bytes:648 (648.0 B)
   
   virbr0    Link encap:Ethernet  HWaddr 90:e2:ba:d7:10:b0
             inet addr:192.168.10.10  Bcast:192.168.10.255  Mask:255.255.255.0
             inet6 addr: fe80::92e2:baff:fed7:10b0/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:24738281 errors:0 dropped:62634 overruns:0 frame:0
             TX packets:791 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:7863434292 (7.8 GB)  TX bytes:46801 (46.8 KB)
   
   brctl show
   bridge name     bridge id               STP enabled     interfaces
   virbr0          8000.90e2bad710b0       no              p5p1

.. warning:: Do not do any security updates. The CSO installer doesn’t work after this anymore.

Install a local DNS and NTP Server on the Host
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#

# install a local DNS-Server on the cso-host to serve this lab

# Note that all devices who do ZTP should only know this server!!!

#

.. code-block:: none

   apt-get install -y dnsmasq
   
   cp /etc/dnsmasq.conf /etc/dnsmasq.conf.orig
   
   cat <<EOF >/etc/dnsmasq.conf
   domain-needed
   
   bogus-priv
   
   no-resolv
   
   no-poll
   
   local=/example.net/
   
   server=9.9.9.9
   server=8.8.8.8
   
   listen-address=192.168.10.10,127.0.0.1
   
   no-hosts
   
   addn-hosts=/etc/dnsmasq_static_hosts.conf
   
   EOF
   
   cat <<EOF >/etc/dnsmasq_static_hosts.conf
   192.168.10.1    lab-gw              lab-gw.example.net
   192.168.10.2    raspberry-pi-1      raspberry-pi-1.example.net
   192.168.10.3    raspberry-pi-2      raspberry-pi-2.example.net
   192.168.10.4    nat-gw              nat-gw.example.net
   192.168.10.10   cso-host            cso-host.example.net
   192.168.10.11   cso-host2           cso-host2.example.net
   192.168.10.15   contrail-host       contrail-host.example.net
   192.168.10.20   qfx5100-1           qfx5100-1.example.net
   192.168.10.21   mx80-1              mx80-1.example.net
   192.168.10.22   srx1500-1           srx1500-1.example.net
   192.168.10.23   srx1500-2           srx1500-2.example.net
   192.168.10.24   nfx250-1            nfx250-1.example.net
   192.168.10.25   nfx250-2            nfx250-2.example.net
   192.168.10.26   srx345-1            srx345-1.example.net
   192.168.10.40   installervm         installervm.example.net
   192.168.10.41   centralinfravm      centralinfravm.example.net
   192.168.10.42   centralmsvm         centralmsvm.example.net
   192.168.10.43   centralk8mastervm   centralk8mastervm.example.net
   192.168.10.47   regional-sblb       regional-sblb.example.net
   192.168.10.48   canvm               canvm.example.net
   192.168.10.49   vrr                 vrr.example.net
   192.168.10.50   spacevm             spacevm.example.net
   192.168.10.51   spacevm-web         spacevm-web.example.net
   192.168.10.60   desktop1            desktop1.example.net
   192.168.10.61   desktop2            desktop2.example.net
   192.168.10.62   desktop3            desktop3.example.net
   192.168.10.63   desktop4            desktop4.example.net
   192.168.10.70   vnf-mgnt            vnf-mgnt.example.net
   192.168.10.71   sdwan-underlay      sdwan-underlay.example.net
   192.168.10.90   ipmi-cso-host       ipmi-cso-host.example.net
   192.168.10.95   ipmi-contrail-host  ipmi-contrail-host.example.net
   EOF
   
   /etc/init.d/dnsmasq restart

A DHCP server is OPTIONAL for this lab if you have a Terminal/Console connection to the Devices. Here we use it ONLY to give the devices a fixed IP-Address based on their fxp0 MAC-Address like below. This config is added to the dnsmasq server:

.. code-block:: none

   cat <<EOF >>/etc/dnsmasq.conf
   
   domain=example.net
   # this interface is wrong and doesn't exist ON PURPOSE
   # without a range the dhcp server in dnsmask doesn't get active
   # but we want only a static range to be used
   dhcp-range=eth-xyz,192.168.10.100,192.168.10.101,4h
   # dns server to use
   dhcp-option=6,192.168.10.10
   # hosts by mac
   dhcp-host=ec:3e:f7:54:cf:81,192.168.10.20,24h
   dhcp-host=80:71:1f:c7:3c:ff,192.168.10.21,24h
   dhcp-host=44:f4:77:40:1d:9a,192.168.10.22,24h
   dhcp-host=44:f4:77:40:21:b2,192.168.10.23,24h
   dhcp-host=f4:cc:55:2b:58:cb,192.168.10.24,24h
   dhcp-host=12:34:56:12:34:56,192.168.10.60,24h
   
   # we will NOT tell a default gw on purpose
   dhcp-option=3
   dhcp-option=option:ntp-server,192.168.10.10
   interface=virbr0
   EOF
   
   /etc/init.d/dnsmasq restart

This is an local ntpd installation that also relays time to others (like the VM’s).

You might need to tweak the ntp-server and your local time zone.

We also made sure this config is valid when the outside NTP fails.

.. note:: You can NOT INSTALL CSO WITHOUT A PROPER NTP-SETUP!!!

.. code-block:: none

   apt-get -y install ntp
   
   service ntp stop
   ntpdate 0.us.pool.ntp.org
   service ntp start
   
   mv /etc/ntp.conf /etc/ntp.conf.orig
   touch /var/lib/ntp/drift
   
   cat <<EOF > /etc/ntp.conf
   driftfile /var/lib/ntp/drift
   server 0.us.pool.ntp.org
   server 1.us.pool.ntp.org
   server 2.us.pool.ntp.org
   server 127.127.1.0
   fudge 127.127.1.0 stratum 4
   restrict 192.168.0.0 mask 255.255.0.0
   restrict 127.0.0.1
   restrict -6 ::1
   includefile /etc/ntp/crypto/pw
   keys /etc/ntp/keys
   EOF
   
   service ntp restart
   
   timedatectl set-timezone Europe/Berlin
   date
   Fri May 25 18:11:06 CEST 2018

   ntpq -p
        remote           refid      st t when poll reach   delay   offset  jitter
   ==============================================================================
    209-133-217-165 128.227.205.3    2 u   11   64    1   32.763   -4.820   0.000
    replyback.biz   .INIT.          16 u    -   64    0    0.000    0.000   0.000
    time-c-g.nist.g .NIST.           1 u    9   64    1    9.355   -0.813   0.000
   *LOCAL(0)        .LOCL.           4 l    8   64    1    0.000    0.000   0.000

Install a squid proxy for lab access to other VM’s
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   apt-get install -y squid
   
   cp /etc/squid3/squid.conf /etc/squid3/squid.conf.orig
   
   #cat /etc/squid3/squid.conf | egrep -v "^\s*(#|$)"

   cat <<EOF >/etc/squid3/squid.conf
   acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
   acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
   acl SSL_ports port 443
   acl SSL_ports port 83           # cso nsd
   acl SSL_ports port 8143         # contrail ui
   acl Safe_ports port 80          # http
   acl Safe_ports port 8080        # contrail ui
   acl Safe_ports port 5601        # kibana
   acl Safe_ports port 5999        # VNC OpenStack
   acl Safe_ports port 6080        # VNC OpenStack
   acl Safe_ports port 1936        # haproxy stats
   acl Safe_ports port 3000        # grafana
   acl Safe_ports port 30900       # Prometheus
   acl Safe_ports port 83          # cso nsd again
   acl Safe_ports port 21          # ftp
   acl Safe_ports port 443         # https
   acl Safe_ports port 70          # gopher
   acl Safe_ports port 210         # wais
   acl Safe_ports port 1025-65535  # unregistered ports
   acl Safe_ports port 280         # http-mgmt
   acl Safe_ports port 488         # gss-http
   acl Safe_ports port 591         # filemaker
   acl Safe_ports port 777         # multiling http
   acl CONNECT method CONNECT
   http_access deny !Safe_ports
   http_access deny CONNECT !SSL_ports
   http_access allow localhost manager
   http_access deny manager
   http_access allow localnet
   http_access allow localhost
   http_access deny all
   http_port 0.0.0.0:3128
   coredump_dir /var/spool/squid3
   refresh_pattern ^ftp:           1440    20%     10080
   refresh_pattern ^gopher:        1440    0%      1440
   refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
   refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
   refresh_pattern .               0       20%     4320
   visible_hostname localhost
   EOF
   
   service squid3 restart
   sleep 5
   netstat -tunap | grep 3128
   tcp        0      0 0.0.0.0:3128            0.0.0.0:*               LISTEN      5050/squid3

Install NAT GW for the lab based on vSRX V3.0
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: Be sure to have a license applied to the VM after it’s started.If you forget this, **after 60 Days** of operation this VM WILL **STOP FORWARDING**!

.. warning:: We changed, starting with V2.7 of the lab documentation, to vSRX v3.0 as natvm. In older labs we had to use an Ubuntu based natvm because vSRX v2.0 was not stable enough depending which server hardware you had. If the new vSRX apparoach is not stable and you run into issues revert back to the Ubuntu VM in chapter 8.3 below which is known to be stable since a long time.

.. note:: The below configuration should also support a configuration when you use “CSO behind NAT” during the installation. However this is not tested yet and just prepared.

Download **vSRX v3.0** image and prepare it for initial config.

.. code-block:: none

   # https://webdownload.juniper.net/swdl/dl/secure/site/1/record/86046.html

   wget "https://cdn.juniper.net/software/junos/18.4R1.8/junos-vsrx3-x86-64-18.4R1.8.qcow2?SM_USER=hschroeder&__gda__=1547541108_c100a9e94e00737e7ed425bc93ea4f60"
   
   mv "junos-vsrx3-x86-64-18.4R1.8.qcow2?SM_USER=hschroeder&__gda__=1547541108_c100a9e94e00737e7ed425bc93ea4f60" junos-vsrx3-x86-64-18.4R1.8.qcow2
   
   virsh destroy natvm
   virsh undefine natvm
   cp /root/junos-vsrx3-x86-64-18.4R1.8.qcow2 /var/lib/libvirt/images/vsrx.qcow2
   chmod 666 /var/lib/libvirt/images/vsrx.qcow2
   
   rm -f vsrx.iso
   vi juniper.conf

You need to **adapt the IP-addresses 172.30.52.57 and 172.30.52.1** as Default-GW-IP to be the single point where you attach this lab to any other network.

.. note:: Have a look at the “alladmins” address-book in the below configuration. For security reasons we only allow SSH to the lab and other services for RFC 1918 networks. You may need to open that.

Paste the entire sections. But be shure to change the two ge-0/0/0.42 parameters to the right values of your own lab.

.. code-block:: none

   
   system {
       host-name vsrx;
       root-authentication {
           encrypted-password "$6$ArrH2Tag$VOZ/t.IBFXmiIYUpGREKjNd/iWzoTpc48BvQNQJ8jXcIDDeHzFQ4WZGEJXphTYdU8s.CHDIy6T7Ar3lB.SFpK0"; ## SECRET-DATA
       }
       services {
           ssh;
           netconf {
               ssh;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any any;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
   }
   security {
       address-book {
           global {
               address a1 10.0.0.0/8;
               address a2 172.16.0.0/12;
               address a3 192.168.0.0/16;
               address a4 192.168.210.0/24;
               address-set alladmins {
                   address a1;
                   address a2;
                   address a3;
               }
               address-set oamloopbackips {
                   address a4;
               }
           }
       }
       screen {
           ids-option untrust-screen {
               icmp {
                   ping-death;
               }
               ip {
                   source-route-option;
                   tear-drop;
               }
               tcp {
                   syn-flood {
                       alarm-threshold 1024;
                       attack-threshold 200;
                       source-threshold 1024;
                       destination-threshold 2048;
                       queue-size 2000; ## Warning: 'queue-size' is deprecated
                       timeout 20;
                   }
                   land;
               }
           }
       }
       nat {
           source {
               rule-set SNAT {
                   from zone trust;
                   to zone untrust;
                   rule r1 {
                       match {
                           source-address 0.0.0.0/0;
                           destination-address 0.0.0.0/0;
                       }
                       then {
                           source-nat {
                               interface;
                           }
                       }
                   }
               }
           }
           destination {
               pool csohost {
                   address 192.168.10.10/32;
               }
               pool centralmsvm {
                   address 192.168.10.42/32;
               }
               pool sblb {
                   address 192.168.10.47/32;
               }
               pool vrr {
                   address 192.168.10.49/32;
               }
               pool automationvm {
                   address 192.168.10.5/32;
               }
               rule-set natforward {
                   from zone untrust;
                   rule r2 {
                       match {
                           source-address-name alladmins;
                           destination-address 172.30.52.57/32;
                           destination-port {
                               22;
                               3128;
                               5900 to 5999;
                           }
                           protocol tcp;
                       }
                       then {
                           destination-nat {
                               pool {
                                   csohost;
                               }
                           }
                       }
                   }
                   rule r3 {
                       match {
                           destination-address 172.30.52.57/32;
                           destination-port {
                               443;
                               444;
                               83;
                               9090;
                           }
                           protocol tcp;
                       }
                       then {
                           destination-nat {
                               pool {
                                   centralmsvm;
                               }
                           }
                       }
                   }
                   rule r4 {
                       match {
                           source-address-name oamloopbackips;
                           destination-address 172.30.52.57/32;
                           destination-port {
                               7804;
                           }
                           protocol tcp;
                       }
                       then {
                           destination-nat {
                               pool {
                                   centralmsvm;
                               }
                           }
                       }
                   }
                   rule r5 {
                       match {
                           source-address-name oamloopbackips;
                           destination-address 172.30.52.57/32;
                           application any;
                       }
                       then {
                           destination-nat {
                               pool {
                                   sblb;
                               }
                           }
                       }
                   }
                   rule r6 {
                       match {
                           source-address-name oamloopbackips;
                           destination-address 172.30.52.57/32;
                           destination-port {
                               179;
                           }
                           protocol tcp;
                       }
                       then {
                           destination-nat {
                               pool {
                                   centralmsvm;
                               }
                           }
                       }
                   }
                   rule r9 {
                       match {
                           source-address-name alladmins;
                           destination-address 172.30.52.57/32;
                           destination-port {
                               9080;
                               8670;
                           }
                           protocol tcp;
                       }
                       then {
                           destination-nat {
                               pool {
                                   automationvm;
                               }
                           }
                       }
                   }
               }
           }
       }
       policies {
           from-zone trust to-zone trust {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone trust to-zone untrust {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone untrust to-zone trust {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone untrust to-zone untrust {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone trust {
               tcp-rst;
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/1.0;
                   ge-0/0/2.70;
                   ge-0/0/2.74;
                   ge-0/0/2.75;
                   ge-0/0/2.76;
               }
           }
           security-zone untrust {
               screen untrust-screen;
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/0.42;
               }
           }
       }
   }
   interfaces {
       ge-0/0/0 {
           vlan-tagging;
           unit 42 {
               vlan-id 42;
               family inet {
                   address 172.30.52.57/24;
               }
           }
       }
       ge-0/0/1 {
           unit 0 {
               family inet {
                   address 192.168.10.1/24;
               }
           }
       }
       ge-0/0/2 {
           vlan-tagging;
           unit 70 {
               vlan-id 70;
               family inet {
                   address 192.168.70.1/24;
               }
           }
           unit 74 {
               vlan-id 74;
               family inet {
                   address 192.168.74.1/24;
               }
           }
           unit 75 {
               vlan-id 75;
               family inet {
                   address 192.168.75.1/24;
               }
           }
           unit 76 {
               vlan-id 76;
               family inet {
                   address 192.168.76.1/24;
               }
           }
       }
       fxp0 {
           unit 0;
       }
   }
   routing-options {
       static {
           # global route to lab gw
           route 0.0.0.0/0 next-hop 172.30.52.1;
           # SD-WAN underlay routes
           route 192.168.128.0/17 next-hop 192.168.70.254;
           route 10.88.88.0/24 next-hop 192.168.70.254;
           route 10.66.66.0/24 next-hop 192.168.70.254;
           # vCPE testcase routes
           route 192.168.68.0/24 next-hop 192.168.10.15;
           route 192.168.69.0/24 next-hop 192.168.10.70;
           route 10.77.77.0/24 next-hop 192.168.74.254;
           # uCPE testcase routes
           route 10.99.99.0/24 next-hop 192.168.75.254;
           route 192.168.66.0/24 next-hop 192.168.75.254;
           route 192.168.67.0/24 next-hop 192.168.75.254;
       }
   }
   

The next steps then create the iso for the config and launch the vm.

.. code-block:: none

   genisoimage -o vsrx.iso -volid cidata -joliet -rock juniper.conf
   chmod 666 vsrx.iso
   
   virt-install -n natvm -r 4096 --vcpus=2 --arch=x86_64 \
   --disk path=/var/lib/libvirt/images/vsrx.qcow2,size=20,device=disk,bus=virtio,format=qcow2 \
   --import --disk path=/root/vsrx.iso,device=cdrom,bus=ide --os-type linux --hvm \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --graphics vnc,listen=0.0.0.0 --noautoconsole
   
   # virsh dumpxml natvm
   virsh autostart natvm
   
   virsh console natvm

.. note:: Now apply your permanent license else the system will stop after 60Days (this would also happen for a vSRX2)

You can try getting an official license for one year via https://internal-license.juniper.net/nckt/ login with your windows credentials and apply there for a license OR you just use the one I use below but be aware it’s also not unlimited :-)

.. code-block:: none

   root@vsrx> request system license add terminal
   [Type ^D at a new line to end input,
    enter blank line between each license key]
   JUNOS1048426 aeaqic beajc4 mnwkqa bhhrrw zkaaeq 6gg3fi
                aaq5yy 3mvaac dpddns uaaj34 mnwkqa fq4ojr
                g4ztaq jqgazt imzsgu yayc2m ifbekt kfieqf
                at2da4 uf3w2v mzkxek mfujvx zyvz4f sb32ch
                z4zytt ei3cbu reqhph virk24 qkgb7y ljgg4e
                gyy
   <CTRL-D>
   JUNOS1048426: successfully added
   add license complete (no errors)

   root@vsrx> show system license
   License usage:
                                    Licenses     Licenses    Licenses    Expiry
     Feature name                       used    installed      needed
     anti_spam_key_sbl                     0            1           0    2022-03-21 00:00:00 UTC
     idp-sig                               0            1           0    2022-03-21 00:00:00 UTC
     appid-sig                             0            1           0    2022-03-21 00:00:00 UTC
     av_key_sophos_engine                  0            1           0    2022-03-21 00:00:00 UTC
     wf_key_websense_ewf                   0            1           0    2022-03-21 00:00:00 UTC
     Virtual Appliance                     1            1           0    2022-03-21 00:00:00 UTC
     remote-access-ipsec-vpn-client        0            2           0    permanent
   
   Licenses installed:
     License identifier: E420588955
     License version: 4
     Software Serial Number: 20150625
     Customer ID: vSRX-JuniperEval
     Features:
       Virtual Appliance - Virtual Appliance
         count-down, Original validity: 60 days
   
     License identifier: JUNOS1048426
     License version: 4
     Software Serial Number: 91730A00343250
     Customer ID: LABEMEA POC
     Features:
       av_key_sophos_engine - Anti Virus with Sophos Engine
         date-based, 2019-03-19 00:00:00 UTC - 2022-03-21 00:00:00 UTC
       wf_key_websense_ewf - Web Filtering EWF
         date-based, 2019-03-19 00:00:00 UTC - 2022-03-21 00:00:00 UTC
       appid-sig        - APPID Signature
         date-based, 2019-03-19 00:00:00 UTC - 2022-03-21 00:00:00 UTC
       idp-sig          - IDP Signature
         date-based, 2019-03-19 00:00:00 UTC - 2022-03-21 00:00:00 UTC
       anti_spam_key_sbl - Anti-Spam
         date-based, 2019-03-19 00:00:00 UTC - 2022-03-21 00:00:00 UTC
       Virtual Appliance - Virtual Appliance
         date-based, 2019-03-19 00:00:00 UTC - 2022-03-21 00:00:00 UTC

.. warning:: BEFORE YOU MOVE ON: Do a little Ping test like the one below. Here you do a LOCAL Ping from the CSO-Host to the vSRX as default GW (192.168.10.1). A Packet loss that high as below is NOT ACCEPTABLE. Go to Chapter 8.3 below and use the Ubuntu VM for this Lab instead!!!

.. code-block:: none

   root@cso-host:~# ping 192.168.10.1
   PING 192.168.10.1 (192.168.10.1) 56(84) bytes of data.
   64 bytes from 192.168.10.1: icmp_seq=1 ttl=64 time=1.43 ms
   64 bytes from 192.168.10.1: icmp_seq=2 ttl=64 time=1.23 ms
   64 bytes from 192.168.10.1: icmp_seq=3 ttl=64 time=1.11 ms
   64 bytes from 192.168.10.1: icmp_seq=4 ttl=64 time=0.638 ms
   64 bytes from 192.168.10.1: icmp_seq=5 ttl=64 time=0.259 ms
   64 bytes from 192.168.10.1: icmp_seq=6 ttl=64 time=0.798 ms
   64 bytes from 192.168.10.1: icmp_seq=7 ttl=64 time=0.303 ms
   64 bytes from 192.168.10.1: icmp_seq=8 ttl=64 time=0.545 ms
   64 bytes from 192.168.10.1: icmp_seq=9 ttl=64 time=0.824 ms
   64 bytes from 192.168.10.1: icmp_seq=21 ttl=64 time=1.09 ms
   64 bytes from 192.168.10.1: icmp_seq=22 ttl=64 time=0.219 ms
   64 bytes from 192.168.10.1: icmp_seq=23 ttl=64 time=0.941 ms
   64 bytes from 192.168.10.1: icmp_seq=24 ttl=64 time=0.591 ms
   64 bytes from 192.168.10.1: icmp_seq=25 ttl=64 time=1.05 ms
   64 bytes from 192.168.10.1: icmp_seq=53 ttl=64 time=0.262 ms
   64 bytes from 192.168.10.1: icmp_seq=68 ttl=64 time=0.529 ms
   64 bytes from 192.168.10.1: icmp_seq=69 ttl=64 time=1.10 ms
   64 bytes from 192.168.10.1: icmp_seq=70 ttl=64 time=1.02 ms
   64 bytes from 192.168.10.1: icmp_seq=71 ttl=64 time=0.867 ms
   64 bytes from 192.168.10.1: icmp_seq=72 ttl=64 time=0.664 ms
   ^C
   --- 192.168.10.1 ping statistics ---
   74 packets transmitted, 20 received, 72% packet loss, time 73334ms
   rtt min/avg/max/mdev = 0.219/0.775/1.432/0.346 ms

Start CSO installation
~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   cd /root
   # CSO 4.1.0
   # https://webdownload.juniper.net/swdl/dl/secure/site/1/record/88102.html
   # https://webdownload.juniper.net/swdl/dl/secure/site/1/record/88105.html

   wget "https://cdn.juniper.net/software/cloudcpe/4.1.0/Contrail_Service_Orchestration_4.1.0.tar.gz?SM_USER=hschroeder&__gda__=1551772359_628d9fc4969f29286a4e82a410a3c3db"
   wget "https://cdn.juniper.net/software/cloudcpe/4.1.0/KVM-4.1.0.tar.gz?SM_USER=hschroeder&__gda__=1551772420_9140bacc9d4b13c359e24076690454ae"

   # rename the files and then
   ls -l
   .
   -rw-r--r--  1 root  root 11379363041 Mar  4 21:06 Contrail_Service_Orchestration_4.1.0.tar.gz
   -rw-r--r--  1 root  root  2930213920 Mar  4 21:19 KVM-4.1.0.tar.gz
   .
   
   md5sum Contrail_Service_Orchestration_4.1.0.tar.gz
   049324750c8bfa802219e28a943e0fef  Contrail_Service_Orchestration_4.1.0.tar.gz
   md5sum KVM-4.1.0.tar.gz
   0d9c552ad84764d5dbf54fdd9cf06381  KVM-4.1.0.tar.gz 

Clean Host from previous installations

.. code-block:: none

   cd /root
   
   virsh list --all
    Id    Name                           State
   ----------------------------------------------------
    3     vsrx                           running
    169   desktop1                       running
    171   desktop3                       running
    190   desktop2                       running
    285   canvm                          running
    286   centralinfravm                 running
    287   regionalinfravm                running
    288   regionalmsvm                   running
    289   centralmsvm                    running
    290   regional-sblb                  running
    291   vrr                            running
    292   installervm                    running
    294   delayvm                        running
   
   virsh destroy installervm
   virsh undefine installervm
   virsh destroy centralinfravm
   virsh undefine centralinfravm
   virsh destroy centralmsvm
   virsh undefine centralmsvm
   virsh destroy regionalinfravm
   virsh undefine regionalinfravm
   virsh destroy regionalmsvm
   virsh undefine regionalmsvm
   virsh destroy centralk8mastervm
   virsh undefine centralk8mastervm
   virsh destroy regionalk8mastervm
   virsh undefine regionalk8mastervm
   virsh destroy canvm
   virsh undefine canvm
   virsh destroy vrr
   virsh undefine vrr
   virsh destroy regional-sblb
   virsh undefine regional-sblb
   
   
   rm -rf /root/disks
   rm -rf /root/disks_can
   mkdir /root/ubuntu_vm
   cd /root/ubuntu_vm
   rm -rf *
   cd ..
   #salt-key -D

   # Check your diskspace before you install
   # You need 300GB free minimum in /root NOT in /home
   df -lh
   Filesystem      Size  Used Avail Use% Mounted on
   udev            126G  4.0K  126G   1% /dev
   tmpfs            26G  1.4M   26G   1% /run
   /dev/dm-1       1.8T   25G  1.7T   2% /
   none            4.0K     0  4.0K   0% /sys/fs/cgroup
   none            5.0M     0  5.0M   0% /run/lock
   none            126G     0  126G   0% /run/shm
   none            100M     0  100M   0% /run/user
   /dev/sda1       465M   40M  401M  10% /boot

   # also check that the swap-space is NOT bigger then >32GB
   cat /proc/swaps
   Filename                                Type            Size    Used    Priority
   /dev/dm-0                               partition       999420  0       -1

Create and **map** the directory **/root/ubuntu_vm to an SDD** via symbolic link!

This will help to reduce installation time and improve stability of services.

Get the right and approved Firmware version for (v)SRX as Hub and Spoke and also for the NFX250\ **. Make sure your devices are upgraded before you do tests and demos.**

.. warning:: Review Chapter 2.11 above to download the right Firmware images locally to CSO-Host

Rename all Files so that they finally look like below (old capture from cso 3.3):

.. code-block:: none

   ls -l
   -rw-r--r--  1 root  root  1004216744 Sep  5  2017 contrail-install-packages_3.2.5.0-51~ubuntu-14-04mitaka_all.deb
   -rw-r--r--  1 root  root 15711115497 Apr  1 13:56 Contrail_Service_Orchestration_3.3.tar.gz
   -rw-r--r--  1 root  root   593128588 Feb 14 14:04 jinstall-host-qfx-5-17.3R2.10-signed.tgz
   -rw-r--r--  1 root  root   598284120 Mar 19 04:32 jinstall-host-qfx-5-17.4R1.16-signed.tgz
   -rw-r--r--  1 root  root  1185899167 Mar 30 13:22 jinstall-nfx-2-flex-15.1X53-D472.secure-domestic-signed.tgz
   -rw-r--r--  1 root  root   725521925 Mar 30 17:32 junos-srxentedge-15.1X49-D133-domestic.tgz
   -rw-r--r--  1 root  root   257614687 Mar 30 17:34 junos-srxsme-15.1X49-D133-domestic.tgz
   -rw-r--r--  1 root  root  3287941120 Mar 30 17:50 media-vsrx-vmdisk-15.1X49-D133.qcow2

Provision the CSO-VM’s
~~~~~~~~~~~~~~~~~~~~~~

This step is executed on the CSO-Host to also setup the installerVM used later.

.. code-block:: none

   cd /root
   tar xvfz Contrail_Service_Orchestration_4.1.0.tar.gz
   
   cd Contrail_Service_Orchestration_4.1.0
   # new step in CSO >= 4.0
   cp ../KVM-4.1.0.tar.gz artifacts

All edits in the default file to adapt to our Lab are marked as red.

They usually consists of the new IP-Addresses the fact that for the uCPE you need a second interface enabled and the root-password of the cso-host to be set correctly.

.. note:: Space VM is configured but will not be installed as vCPE can work directly for vSRX and LinuxTables VM (we only need Space for Cisco CSR 1000k)

.. note:: Installer IP is the CSO-Host itself as from there we create also the installerVM.

.. code-block:: none

   # cp confs/cso4.1.0/trial/nonha/provisionvm/provision_vm_collocated_example.conf confs/provision_vm.conf
   
   cat <<EOF >confs/provision_vm.conf
   # This config file is used to provision KVM-based virtual machines using lib virt manager.
   
   [TARGETS]
   # Mention primary host (installer host) management_ip
   
   installer_ip = 192.168.10.10
   
   ntp_servers = 192.168.10.10
   
   # The physical server where the Virtual Machines should be provisioned
   # There can be one or more physical servers on
   # which virtual machines can be provisioned
   physical = cso-host
   
   # The list of virtual servers to be provisioned.
   server = csp-central-infravm, csp-central-msvm, csp-central-k8mastervm, csp-installer-vm, csp-contrailanalytics-1, csp-vrr-vm, csp-regional-sblb
   
   # Physical Server Details
   [cso-host]
   management_address = 192.168.10.10/24
   management_interface = virbr0
   gateway = 192.168.10.1
   dns_search = example.net
   dns_servers = 192.168.10.10
   hostname = cso-host
   username = root
   password = juniper123
   data_interface =
   
   # VM Details
   
   [csp-central-infravm]
   management_address = 192.168.10.41/24
   hostname = centralinfravm.example.net
   username = root
   password = passw0rd
   local_user = infravm
   local_password = passw0rd
   guest_os = ubuntu
   host_server = cso-host
   memory = 49152
   vcpu = 8
   enable_data_interface = false
   vm_type = baseInfra
   volumes = swap:48G,/mnt/data:400G,/data2:1G
   base_disk_size = 100G
   
   [csp-central-msvm]
   management_address = 192.168.10.42/24
   hostname = centralmsvm.example.net
   username = root
   password = passw0rd
   local_user = msvm
   local_password = passw0rd
   guest_os = ubuntu
   host_server = cso-host
   memory = 49152
   vcpu = 8
   enable_data_interface = false
   vm_type = baseMS
   volumes = swap:48G,/mnt/data:400G,/data2:1G
   base_disk_size = 100G
   
   [csp-central-k8mastervm]
   management_address = 192.168.10.43/24
   hostname = centralk8mastervm.example.net
   username = root
   password = passw0rd
   local_user = msvm
   local_password = passw0rd
   guest_os = ubuntu
   host_server = cso-host
   memory = 4096
   vcpu = 2
   enable_data_interface = false
   vm_type =
   volumes = swap:4G,/mnt/data:50G,/data2:1G
   base_disk_size = 50G
   
   [csp-installer-vm]
   management_address = 192.168.10.40/24
   hostname = installervm.example.net
   username = root
   password = passw0rd
   local_user = installervm
   local_password = passw0rd
   guest_os = ubuntu
   host_server = cso-host
   memory = 8192
   vcpu = 4
   enable_data_interface = false
   vm_type =
   volumes = swap:24G,/data2:1G
   base_disk_size = 500G
   
   [csp-contrailanalytics-1]
   management_address = 192.168.10.48/24
   hostname = canvm.example.net
   username = root
   password = passw0rd
   local_user = installervm
   local_password = passw0rd
   guest_os = ubuntu
   host_server = cso-host
   memory = 49152
   vcpu = 16
   enable_data_interface = false
   vm_type =
   volumes = swap:48G,/data1:1G,/data2:1G
   base_disk_size = 300G
   
   [csp-regional-sblb]
   management_address = 192.168.10.47/24
   hostname = regional-sblb.example.net
   username = root
   password = passw0rd
   local_user = sblb
   local_password = passw0rd
   guest_os = ubuntu
   host_server = cso-host
   memory = 4096
   vcpu = 2
   enable_data_interface = true
   vm_type =
   volumes = swap:4G,/mnt/data:50G,/data2:1G
   base_disk_size = 50G
   
   [csp-vrr-vm]
   management_address = 192.168.10.49/24
   hostname = vrr.example.net
   gateway = 192.168.10.1
   newpassword = passw0rd
   guest_os = vrr
   host_server = cso-host
   memory = 8192
   vcpu = 4
   
   
   [csp-space-vm]
   management_address = 192.168.10.50/24
   web_address = 192.168.10.51/24
   gateway = 192.168.10.1
   nameserver_address = 192.168.10.10
   hostname = spacevm.example.net
   username = admin
   password = abc123
   newpassword = jnpr123!
   guest_os = space
   host_server = cso-host
   memory = 16384
   vcpu = 4
   EOF

Now create the VM’s for CSO to be used

.. code-block:: none

   cd /root/Contrail_Service_Orchestration_4.1.0
   
   ./provision_vm.sh
   .
   .
   ==================================

   VM Provisioning Successfully Completed

   ==================================

Execute CSO installation
~~~~~~~~~~~~~~~~~~~~~~~~

This and the follow-up steps have to be done via the installerVM that is now ready.

.. code-block:: none

   ssh root@192.168.10.40 (passw0rd)
   
   cd /root
   scp root@192.168.10.10://root/Contrail_Service_Orchestration_4.1.0.tar* .
   
   ls -l
   -rw-r--r--  1 root  root 11379363041 Mar  4 21:06 Contrail_Service_Orchestration_4.1.0.tar.gz
   
   tar xvfz Contrail_Service_Orchestration_4.1.0.tar.gz
   
   cd Contrail_Service_Orchestration_4.1.0

Copy over the File provision_vm.conf from the cso-host installation so that the installerVM has the information about these VM’s and their IP-Addresses.

Also change the installer ip to the VM instead of the cso-host

.. code-block:: none

   scp root@192.168.10.10:/root/Contrail_Service_Orchestration_4.1.0/confs/provision_vm.conf /root/Contrail_Service_Orchestration_4.1.0/confs/provision_vm.conf
   
   sed -i 's/installer_ip = 192.168.10.10/installer_ip = 192.168.10.40/g' /root/Contrail_Service_Orchestration_4.1.0/confs/provision_vm.conf

Carefully review the readme file for instructions. If you see conflicting information with other information sources then this file should be treated as the only source of truth.

.. code-block:: none

   cat README.md

In our Lab we use the following resources.

.. note:: The installerVM will always be shut-down after installation to save resources so it does not count.

.. code-block:: none

   #################### our setup on cso-host


   | S.No   | Components                       | VM name                   | CPU(Cores)/Memory(GB)
   | ------ |:--------------------------------:|:-------------------------:|:---------------------:|
   | 1      | Installer VM                     | csp-installer-vm          | 4/  8G (shutdown)
   | 2      | Central Infrastructure services  | csp-central-infravm       | 8/ 48G
   | 3      | Central Microservices            | csp-central-msvm          | 8/ 48G
   | 4      | Central K8 Master                | csp-central-k8mastervm    | 2/  4G
   | 5      | Regional SBLB VM                 | csp-regional-sblb         | 2/  4G
   | 6      | Virtual Route Reflector VM       | csp-vrr-vm                | 4/  8G
   | 7      | Contrail Analytics server        | csp-contrailanalytics-1   |16/ 48G
   | 8      | Client Desktop VM1               | desktop1                  | 1/  1G
   | 9      | Client Desktop VM2               | desktop2                  | 1/  2G
   | 10     | Client Desktop VM3               | desktop3                  | 1/  1G
   | 11     | Client Desktop VM4               | desktop4                  | 1/  2G
   | 12     | delayVM                          | delayvm                   | 1/  1G
   | 13     | NAT Gateway                      | natvm                     | 2/  4G
                                                                            47/170G

Use the setup assist script to enter all configuration values one needs for this lab.

**Note on using a backup-config**: If you are installing the same CSO Version (4.1.0 FRS) as we’re doing in this lab you can abort the initial setup_assist-script via <CTRL>+C when you are prompted for “The installer machine IP”. Then you use “vi .config/settings.yaml” and enter the information from the backup you find below in this chapter and save your file. Then you run the setup_assist-script a second time using the restore config. This Trick will enable two things:

#. You only need to hit <Return> (only for the vRR passwords you have to respond with “passw0rd” when prompted) in the whole dialogue and can’t cause yourself a wrong configuration by entering a wrong value.
#. You will apply a config that has the SAME initial passwords as in this doc. So you won’t have individual password and can use copy&paste from this doc without changes.

This practice does NOT WORK on a different CSO version as there may be new or other Fields in the configuration

.. code-block:: none

   ./setup_assist.sh
   .
   .
   The solution being installed: cso4.1.0

   ***************
   Please answer the questions below. The default values are shown with each question, Press enter to proceed without any change. Press any key to continue:


   Generic Questions
   ---------------------------------------------
   The installer machine IP: []:192.168.10.40
   The deployment environment that you want to setup. (production) [production]:trial
   Do you want to have regions? (y/n) [y]:n
   Is CSO behind NAT (y/n) [n]:n
   Timezone for the servers in topology [America/Los_Angeles]:Europe/Amsterdam
   List of ntp servers (comma seperated) [ntp.juniper.net]:192.168.10.10
   Do you need a HA deployment (y/n) [n]:n
   CSO certificate validity (in days) [365]:999
   Do you want to enable TLS mode of authentication between device to FMPM services?. (y/n) [y]:y
   Provide Email Address for cspadmin user []:juniperse@juniper.net
   DNS name of CSO Customer Portal []:centralmsvm.example.net
   DNS name of CSO Admin Portal (can be same as Customer Portal) []:centralmsvm.example.net
   The Autonomous System Number for BGP [64512]:64512

   Keystone related
   ---------------------------------------------
   Do you have an external keystone (centralized mode use case only) (y/n) [n]:n

   Topology Details. Region: central
   "NONHA trial Environment Details"
   The servers required in central region are csp-central-infravm, csp-central-msvm, csp-central-k8mastervm, csp-contrailanalytics-1
   ---------------------------------------------
   Kubernetes overlay network cidr used by the microservices [172.16.0.0/16]:
   Kubernetes Services overlay network range (cidr) used by the microservices [192.168.3.0/24]:
   Kubernetes Service APIServer IP which is in above cidr range [192.168.3.1]:
   Kubernetes Cluster DNS IP used by skydns which should be in Kubernetes Services overlay network range [192.168.3.10]:

   Topology Details. Region: regional
   "NONHA trial Environment Details"
   The servers required in regional region are csp-regional-sblb
   ---------------------------------------------
   Number of VRR instances []:1
   Do you have VRR behind NAT (y/n) []:n
   Do all your VRR instances use the same username and password [y]:y
   Enter the username for VRR []:root
   Enter the password for VRR:passw0rd
   Confirm Password:passw0rd
   VRR Public IP Address of instance 1 []:192.168.10.49
   Please provide redundancy group (0/1) of instance 1 []:0

   More questions
   ---------------------------------------------
   Enter the subnet where all CSO VMs reside (network cidr)) []:192.168.10.0/24
   Enter the tunnel interface unit range which can be used by cso [4000,6000]:
   Enter the primary interface for all VMs [eth0,em1,p1p1,p10p1]:eth0

   Scale related
   ---------------------------------------------
   regional:IP address for southbound load balancer (virtual IP in case of Haproxy HA) [192.168.10.47]:
   regional:Hostname for southbound load balancer (example: sblb-vip.example.net) [regional-sblb.example.net]:

   Applying changes for region central
   ---------------------------------------------
   /root/Contrail_Service_Orchestration_4.1.0/create_deployment_env.sh central

   Creating deployment_env "central"


   Applying changes for region regional
   ---------------------------------------------
   /root/Contrail_Service_Orchestration_4.1.0/create_deployment_env.sh regional

   Creating deployment_env "regional"


   ***************
   PLEASE STORE ALL INFRA PASSWORDS GENERATED BELOW. THEY WILL NOT BE AVAILABLE POST THIS STAGE:
   ***************
   ***************
   UI Password for cspadmin user: Wy6dtEtPBR@Y
   Keystone Password for admin user: 5DQkO6ME2Y87
   Arangodb root user password: TdWHlGUKaBsczohL
   Cassandra DB password for cassandra user: 8XWivLiFCPpNFf
   Cassandra DB password for casadmin user: hlthrIDbuYCM
   Elasticsearch admin Password: Mj7SoiykdPFVtvU
   Keystone Password for swift user: nIFGSEfbpsHD26d1
   Mariadb Password for root/admin user: 3IyCk09jyLpDLrYt
   Mariadb Password for clusteruser user: 5Eu8ffAQ9euEQA
   Prometheus user Password: Nm4kT9vt0nPXf
   Rabbitmq cspmq Password: W6O2cfpF3k3GQJ
   Icinga UI Password: DOnOSUk5nmYzHxf3
   Zookeeper Password for admin user: 2ZE2MqpCJws8r
   Done!

   ---------------------------------------------
   Configuration completed for regions "regional,central"
   ---------------------------------------------

   Continue the installation by following the steps given below in order:

   ./deploy_infra_services.sh
   ./deploy_micro_services.sh
   ./load_services_data.sh

   Done!

.. warning:: Do not lose this generated Password list! It is dynamically generated with every CSO installation CSO >= V3.3!

# Backup of your settings

.. code-block:: none

   cat .config/settings.yaml
   admin_domain_name: centralmsvm.example.net
   arangodb_admin_password: uI5n2ujVGbzkbALLb041kfahtXiIZPUzUpZcHcqBvjg=
   as_number: '64512'
   can_external: n
   can_ip_address: ''
   can_ips:
   - 192.168.10.48
   cassandra_admin_password: 1RxC1xfrIEO/3O68F1NGYw==
   cassandra_password: HjCoOoXnITC4B54F8AkNvX9jLgeSkLVipfBASzrOUmc=
   central_can_ip_address: 192.168.10.48
   central_csp-central-infravm_hostname: centralinfravm.example.net
   central_csp-central-infravm_management_address: 192.168.10.41/24
   central_csp-central-infravm_password: passw0rd
   central_csp-central-infravm_roles: elasticsearch, cassandra, zookeeper, mariadb, rabbitmq,
     elk_kibana, elk_logstash, redis, dms, etcd, keystone, swift, arangodb
   central_csp-central-infravm_username: root
   central_csp-central-k8mastervm_hostname: centralk8mastervm.example.net
   central_csp-central-k8mastervm_management_address: 192.168.10.43/24
   central_csp-central-k8mastervm_password: passw0rd
   central_csp-central-k8mastervm_roles: kubemaster
   central_csp-central-k8mastervm_username: root
   central_csp-central-msvm_hostname: centralmsvm.example.net
   central_csp-central-msvm_management_address: 192.168.10.42/24
   central_csp-central-msvm_password: passw0rd
   central_csp-central-msvm_roles: haproxy_confd, kubeminion, sim_cluster, sim_client
   central_csp-central-msvm_username: root
   central_csp-contrailanalytics-1_hostname: canvm.example.net
   central_csp-contrailanalytics-1_management_address: 192.168.10.48/24
   central_csp-contrailanalytics-1_password: passw0rd
   central_csp-contrailanalytics-1_roles: contrail_analytics
   central_csp-contrailanalytics-1_username: root
   central_csp-installer-vm_hostname: installervm.example.net
   central_csp-installer-vm_management_address: 192.168.10.40/24
   central_csp-installer-vm_password: passw0rd
   central_csp-installer-vm_roles: saltmaster
   central_csp-installer-vm_username: root
   central_default_replicas: '1'
   central_flannel_overlay_cidr: 172.16.0.0/16
   central_fmpm_lb_fqdn: ''
   central_fmpm_lb_hostname: ''
   central_fmpm_lb_hostnames: []
   central_fmpm_lb_ips: []
   central_k8_cluster_dns_ip: 192.168.3.10
   central_k8_service_apiserver_ip: 192.168.3.1
   central_k8_svc_overlay_cidr: 192.168.3.0/24
   central_keystone_ip_address: ''
   central_lb_fqdn: 192.168.10.42
   central_lb_fqdn_hostname: centralmsvm.example.net
   central_lb_hostnames:
   - centralmsvm.example.net
   central_lb_ips:
   - 192.168.10.42
   central_lb_vm_roles:
   - haproxy_confd
   - kubeminion
   - sim_cluster
   - sim_client
   central_sim_cluster_ip_address: ''
   central_vrr_id: ''
   certificate_validity: '999'
   cloud_type: onpremise
   collocated: y
   default_data_dir: /mnt/data
   deployment_mode: trial
   deployment_type: trial
   domain_name: centralmsvm.example.net
   elasticsearch_admin_password: /f0ClWxmiut1nmPv0O8Nw4zLxa6nU60FoGPXUg1hocU=
   enable_https: y
   enable_k8: y
   enable_tls: y
   external_keystone_service_token: ''
   ha: n
   http_proxy: noproxy
   installer_ip: 192.168.10.40
   interface_unit_range: 4000,6000
   internal_keystone_service_token: 3d18a801cfd4503d8091
   keystone_admin_email: juniperse@juniper.net
   keystone_admin_internal_password: RHN+MTCUpN1FTVAJvqgDxQ==
   keystone_admin_name: admin
   keystone_admin_password: ''
   keystone_admin_tenant: default-project
   keystone_cspadmin_password: GgVX+gk3sWarcA7TANtfsg==
   keystone_external: n
   keystone_ip_address: ''
   keystone_swift_user_password: ok3SnUGPMgftimXfjq0oiIFSFRfp7S3IHU08WbZRqoQ=
   manifest_url: ''
   mariadb: Klj7e6HwEVWFSVGmO0Rek1Sm9wtAsteNlsfWaj+Ne+I=
   mariadb_appvisibilityDb_database: 5OkopJSLqAnKAvUufYkz3P8NQ2dt/wK/ubjd+olxR4E=
   mariadb_cluster_user: MBYmnj+JIvcutkGdFyb4tiIYYT61jm3qSLz8pkS5Mdo=
   mariadb_commonDb_database: 2w1OxW5/Xx0qQNOrnQGESnZAvVboEzHjg1YRhONrlIA=
   mariadb_cspadmin_user: OVIocwHaDykZ3+nUKeEMJVKlat9WxGkbY1w0qfkXfp0=
   mariadb_ecmDb_database: VuHsiCIOQy4FRMBMPL0K9NTCNo5rhwp/AGXCSt6XUhw=
   mariadb_icinga_user: ecvlWF7TdePQ5BYN88UQIQ==
   mariadb_keystone_user: MmlqZwK7i1e+faYqXTalsqAoPlvqktrfYu7eQMKt0+0=
   mariadb_neDb_database: ybRvd/bvqRRfJl8LNRQweg==
   mariadb_nsoDb_database: h8nE85ujChsA7gvx+CsdjmLrqq1atmriuQDVbpWNYWA=
   mariadb_seciDb_database: MBTX11Fp+BmBR8eyC2fIGpkkC4pcfAcbFU0nmiCSTiQ=
   mariadb_smDb_database: tMTr9uqCJcCFleNGv+WEX7mexI49mksuye8YdWFaFGY=
   mariadb_vnfmDb_database: nqJ40eXrIpclVGSAxaYnrO8SznPWMoNRA2E6PlhwXJU=
   multi_region: n
   nat_configured: n
   nfx_route_network: 192.168.10.0/24
   ntp_servers: 192.168.10.10
   prometheus_password: +dsX5yNDcyDNVEBhOIKOp49evNHdMuBge6rrlS8uUb4=
   rabbitmq_cspmq_password: MnNxe42ZTLW5OwIQZ+Kw2jtpV/v1QPvbDLWd/JcRMTM=
   rabbitmq_ne_password: cqiDuPHm+NZfwpTuzVJNSBxyju8ypypKN/WflGoGWDQ=
   rabbitmq_nso_password: /ulce7Vtc1dvicimc2JZZK3s9ToQKDHU5tprkdR17tQ=
   rabbitmq_vnfm_password: fDl/U7vmgwACuHX7NGePnhMpePA1Qm//QbAcE39iv+4=
   redis_password: EoI+R6IMlZuvNffOncymSqvXGNgtlgJLE5QTpOAtWB0=
   regional_can_ip_address: 192.168.10.48
   regional_csp-regional-sblb_hostname: regional-sblb.example.net
   regional_csp-regional-sblb_management_address: 192.168.10.47/24
   regional_csp-regional-sblb_password: passw0rd
   regional_csp-regional-sblb_roles: haproxy_confd[sblb]
   regional_csp-regional-sblb_username: root
   regional_default_replicas: '1'
   regional_flannel_overlay_cidr: 172.16.0.0/16
   regional_fmpm_lb_fqdn: 192.168.10.47
   regional_fmpm_lb_hostname: regional-sblb.example.net
   regional_fmpm_lb_hostnames:
   - regional-sblb.example.net
   regional_fmpm_lb_ips:
   - 192.168.10.47
   regional_k8_cluster_dns_ip: 192.168.3.10
   regional_k8_service_apiserver_ip: 192.168.3.1
   regional_k8_svc_overlay_cidr: 192.168.3.0/24
   regional_keystone_ip_address: ''
   regional_lb_fqdn: ''
   regional_lb_fqdn_hostname: ''
   regional_lb_hostnames: []
   regional_lb_ips: []
   regional_lb_vm_roles: []
   regional_no_of_vrrs: '1'
   regional_sim_cluster_ip_address: 192.168.10.42
   regional_vrr_id: ''
   regional_vrr_ip_address_1: 192.168.10.49
   regional_vrr_redundancy_grp_1: '0'
   regionals_list: regional
   salt_interfaces: eth0
   same_pwd: y
   same_vrr_settings: y
   sblb: y
   secureserver_token: 5N/SlPUkik6hud916gezsA==
   sim_cluster_password: 1Uqmstr85jSxiRVKFNCTK/pe8WoSKnCVlBrNF7NdnOs=
   solution_name: cso4.1.0
   timezone: Europe/Amsterdam
   upgrade: n
   vrr:
     regional_vrr:
       '1':
         vrr_ip_address: 192.168.10.49
         vrr_password: CsG8zBpuXBSz94DgTIQRjA==
         vrr_redundancy_grp: '0'
         vrr_username: root
   vrr_behind_nat: n
   vrr_ip_address: ''
   vrr_password: passw0rd
   vrr_private_ip_address: ''
   vrr_redundancy_grp: '0'
   vrr_username: root
   zookeeper_admin_password: dbXjb2aXvk56yhB+ZbPuTa3s9ToQKDHU5tprkdR17tQ=
   

Deploy the services

.. note:: You also see (marked in red) the typical deployment times each step needs. **If are more than 50% higher in your own deployment times you have an issue with your Server Hardware.** You should review swap-space allocation, enable HDD write-back caching and caching at all or deploy the VM’s on a SSD. It is best to resolve your issues first before you continue on such a platform. We know why we recommend this!!!

.. code-block:: none

   
   ./deploy_infra_services.sh
   .
   .
   Overall result:
   
            The following Infrastructure Components are Healthy:
   
                    ['Cassandra', 'ElasticSearch', 'Etcd', 'MariaDb', 'RabbitMQ', 'ZooKeeper', 'Redis', 'ArangoDb', 'Sim_Cluster', 'Elk_Logstash', 'Elk_Kibana', 'Keystone', 'Swift', 'Kubernetes', 'Contrail_Analytics']
   2018-07-12 13:42:13 INFO     =============== Deployment start time : 2018-07-12 13:07:38.258274 ==============
   2018-07-12 13:42:13 INFO     =============== Deployment end time : 2018-07-12 13:42:13.649705   ==============
   2018-07-12 13:42:13 INFO     =============== Deployment duration : 0:34:35.391431   ==============
   ##################################
   regional
   ################################## 
   .
   .
   .
   HEALTH CHECK NOT REQUIRED FOR COLLOCATED REGION
   2018-07-12 13:49:51 INFO     =============== Deployment start time : 2018-07-12 13:42:16.170587 ==============
   2018-07-12 13:49:51 INFO     =============== Deployment end time : 2018-07-12 13:49:51.938099   ==============
   2018-07-12 13:49:51 INFO     =============== Deployment duration : 0:07:35.767512   ==============
   
   
   
   ./deploy_micro_services.sh
   .
   .
   2018-07-12 13:58:23 INFO     Is Collocated Mode True
   2018-07-12 13:58:23 INFO     =============== Deployment start time : 2018-07-12 13:52:17.189386 ==============
   2018-07-12 13:58:23 INFO     =============== Deployment end time : 2018-07-12 13:58:23.568686   ==============
   2018-07-12 13:58:23 INFO     =============== Deployment duration : 0:06:06.379300   ==========================
   .
   .
   2018-07-12 14:02:38 INFO     Is Collocated Mode True
   2018-07-12 14:02:39 INFO     =============== Deployment start time : 2018-07-12 13:58:25.565460 ==============
   2018-07-12 14:02:39 INFO     =============== Deployment end time : 2018-07-12 14:02:39.000959   ==============
   2018-07-12 14:02:39 INFO     =============== Deployment duration : 0:04:13.435499   ==========================
   

.. code-block:: none

   cd /root/Contrail_Service_Orchestration_4.1.0
   
   ./load_services_data.sh
   .
   .
   INFO     =============== Deployment start time : 2019-03-05 12:05:29.283397 ==============
   INFO     =============== Deployment end time : 2019-03-05 12:12:17.361796   ==============
   INFO     =============== Deployment duration : 0:06:48.078399   ==============

This takes ~20minutes time and is USELESS today!

.. code-block:: none

   ./snapshot.sh

Post CSO installation procedure
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#

# Load NFX and vSRX images for distributed / SD-WAN

#

.. code-block:: none

   cd /root/Contrail_Service_Orchestration_4.1.0/
   scp root@192.168.10.10://root/jinstall-nfx-2-flex-15.1X53-D496* /root

Step1: Make an HTTP call to the endpoint http://192.168.10.41:5000/v2.0/tokens with the specified data (-d) and the headers (-H). In the data field, you need to supply the username "admin" and the Keystone Password for admin user which was displayed after the completion of setup_assist script. For more information on the structure of REST calls, refer Contrail Service Orchestration API Reference documentation https://iam-sso.juniper.net/oamfed/idp/samlv20.

.. code-block:: none

   RAW_TOKEN=`curl -d '{"auth":{"tenantName":"admin", "passwordCredentials":{"username":"admin", "password":"5DQkO6ME2Y87"}}}' -H "Content-type: application/json" http://192.168.10.41:5000/v2.0/tokens`

Step2: The following python command reads the value of RAW_TOKEN (retrieved in step 1), converts it to JSON format, and stores the access token id field in the TOKEN variable. The value of the variable, $TOKEN, needs to be supplied to further CSO REST calls for authorization purposes.

.. code-block:: none

   TOKEN=`echo $RAW_TOKEN | python -c "import sys; import json; tok = json.loads(sys.stdin.read()); print tok['access']['token']['id'];"`
   echo $TOKEN
   8c8ee84808a241d29e8dbc44d053338b

Step3: Make a REST call using the TOKEN generated in Step2 to upload the NFX Junos image to the https://192.168.10.42/ims-central/upload_image_file (central-msvm) endpoint. This call may take some time to finish without displaying any progress update.

.. code-block:: none

   curl -v --insecure -X POST -H "x-auth-token:$TOKEN" -H "Content-Type: multipart/form-data" -F "imagefile=@/root/jinstall-nfx-2-flex-15.1X53-D496.secure-domestic-signed.tgz" -F "cname=jinstall-nfx-2-flex-15.1X53-D496.secure-domestic-signed.tgz" -F "image_type=DEVICE_IMAGE" -F "description=NFX 15.1" -F "device_family=juniper-nfx" -F "supported_platform=nfx250" -F "vendor=Juniper" -F "major_version=15" -F "minor_version=1" -F "build_num=15.1"  "https://192.168.10.42/ims-central/upload_image_file"

Step4: Copy the latest SRX version mentioned in the release notes to root directory of installer VM.

.. code-block:: none

   scp root@192.168.10.10:/root/media-vsrx-vmdisk-15.1X49-D170.4.qcow2 /root

Step5: REST call for uploading vSRX Junos image to the https://192.168.10.42/ims-central/upload_image_file (central-msvm) endpoint. This call may take some time to finish without displaying any progress update.

.. code-block:: none

   curl -v --insecure -X POST -H "x-auth-token:$TOKEN" -H "Content-Type: multipart/form-data" -F "imagefile=@/root/media-vsrx-vmdisk-15.1X49-D170.4.qcow2" -F "cname=vsrx-vmdisk-15.1.qcow2" -F "image_type=VNF_IMAGE" -F "description=vSRX 15.1 D170" -F "device_family=SRX" -F "supported_platform=vSRX" -F "vendor=Juniper" -F "major_version=15" -F "minor_version=1" -F "build_num=15.1"  "https://192.168.10.42/ims-central/upload_image_file"

#

# Import the Visualizations to Kibana:

#

.. note:: Jump over this step as it’s brocken in V4.1. Do the Certificate check next.

.. code-block:: none

   cat deploy_manager/export.json
   [
     {
       "_id": "Performance-Analysis",
       "_type": "dashboard",
       "_index": ".kibana",
       "_source": {
         "title": "Performance Analysis",
         "hits": 0,
         "description": "",
         "panelsJSON": "[{\"col\":1,\"id\":\"Performance-Analysis:-API-Vs-Min-slash-Avg-slash-Max-Elapsed-Time\",\"panelIndex\":1,\"row\":1,\"size_x\":12,\"size_y\":5,\"type\":\"visualization\"},{\"id\":\"Performance-Analysis:-Request-ID-Vs-Timestamp\",\"type\":\"visualization\",\"panelIndex\":2,\"size_x\":6,\"size_y\":5,\"col\":1,\"row\":6},{\"id\":\"Performance-Analysis:-API-Vs-Count\",\"type\":\"visualization\",\"panelIndex\":3,\"size_x\":6,\"size_y\":5,\"col\":7,\"row\":6},{\"id\":\"Performance-Analysis:-Application-Vs-API\",\"type\":\"visualization\",\"panelIndex\":4,\"size_x\":6,\"size_y\":4,\"col\":1,\"row\":11},{\"id\":\"Performance-Analysis:-Request_id-Vs-Application-Vs-API\",\"type\":\"visualization\",\"panelIndex\":5,\"size_x\":5,\"size_y\":4,\"col\":7,\"row\":11},{\"id\":\"CSP-Logs\",\"type\":\"search\",\"panelIndex\":6,\"size_x\":12,\"size_y\":19,\"col\":1,\"row\":15,\"columns\":[\"request_id\",\"service_app_name\",\"request\",\"url\",\"method\",\"message\",\"status_code\",\"time_elapsed\",\"level\"],\"sort\":[\"@timestamp\",\"desc\"]}]",
         "optionsJSON": "{\"darkTheme\":false}",
         "uiStateJSON": "{}",
         "version": 1,
         "timeRestore": false,
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[{\"query\":{\"query_string\":{\"query\":\"*\",\"analyze_wildcard\":true}}}]}"
         }
       }
     },
     {
       "_id": "Troubleshooting",
       "_type": "dashboard",
       "_index": ".kibana",
       "_source": {
         "title": "Troubleshooting",
         "hits": 0,
         "description": "",
         "panelsJSON": "[{\"id\":\"Troubleshooting:-Log-Level-Vs-Count\",\"type\":\"visualization\",\"panelIndex\":1,\"size_x\":4,\"size_y\":3,\"col\":1,\"row\":1},{\"id\":\"Troubleshooting:-Status-Code-Vs-Count\",\"type\":\"visualization\",\"panelIndex\":2,\"size_x\":4,\"size_y\":3,\"col\":5,\"row\":1},{\"id\":\"Troubleshooting:-Service-App-Name-Vs-Status-Code-(Count)\",\"type\":\"visualization\",\"panelIndex\":3,\"size_x\":4,\"size_y\":3,\"col\":9,\"row\":1},{\"id\":\"CSP-Logs\",\"type\":\"search\",\"panelIndex\":4,\"size_x\":12,\"size_y\":9,\"col\":1,\"row\":4,\"columns\":[\"request_id\",\"service_app_name\",\"request\",\"url\",\"method\",\"message\",\"status_code\",\"time_elapsed\",\"level\"],\"sort\":[\"@timestamp\",\"desc\"]}]",
         "optionsJSON": "{\"darkTheme\":false}",
         "uiStateJSON": "{}",
         "version": 1,
         "timeRestore": false,
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[{\"query\":{\"query_string\":{\"query\":\"*\",\"analyze_wildcard\":true}}}]}"
         }
       }
     },
     {
       "_id": "CSP-Logs",
       "_type": "search",
       "_index": ".kibana",
       "_source": {
         "title": "CSP Logs",
         "description": "",
         "hits": 0,
         "columns": [
           "request_id",
           "service_app_name",
           "request",
           "url",
           "method",
           "message",
           "status_code",
           "time_elapsed",
           "level"
         ],
         "sort": [
           "@timestamp",
           "desc"
         ],
         "version": 1,
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"index\":\"csplogs*\",\"filter\":[],\"highlight\":{\"pre_tags\":[\"@kibana-highlighted-field@\"],\"post_tags\":[\"@/kibana-highlighted-field@\"],\"fields\":{\"*\":{}},\"require_field_match\":false,\"fragment_size\":2147483647},\"query\":{\"query_string\":{\"query\":\"*\",\"analyze_wildcard\":true}}}"
         }
       }
     },
     {
       "_id": "Performance-Analysis:-API-Vs-Count",
       "_type": "visualization",
       "_index": ".kibana",
       "_source": {
         "visState": "{\"title\":\"New Visualization\",\"type\":\"histogram\",\"params\":{\"shareYAxis\":true,\"addTooltip\":true,\"addLegend\":true,\"scale\":\"linear\",\"mode\":\"stacked\",\"times\":[],\"addTimeMarker\":false,\"defaultYExtents\":false,\"setYExtents\":false,\"yAxis\":{}},\"aggs\":[{\"id\":\"1\",\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"api.raw\",\"size\":30,\"order\":\"desc\",\"orderBy\":\"1\"}}],\"listeners\":{}}",
         "description": "",
         "title": "Performance Analysis: API Vs Count",
         "uiStateJSON": "{}",
         "version": 1,
         "savedSearchId": "CSP-Logs",
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[{\"meta\":{\"index\":\"csplogs*\",\"key\":\"api.raw\",\"value\":\"%{method}--%{clean_url}--%{status_code}\",\"disabled\":false,\"negate\":true,\"alias\":null},\"query\":{\"match\":{\"api.raw\":{\"query\":\"%{method}--%{clean_url}--%{status_code}\",\"type\":\"phrase\"}}},\"$state\":{\"store\":\"appState\"}}]}"
         }
       }
     },
     {
       "_id": "Performance-Analysis:-API-Vs-Min-slash-Avg-slash-Max-Elapsed-Time",
       "_type": "visualization",
       "_index": ".kibana",
       "_source": {
         "visState": "{\"title\":\"Performance Analysis: API Vs Min/Avg/Max Elapsed Time\",\"type\":\"histogram\",\"params\":{\"shareYAxis\":true,\"addTooltip\":true,\"addLegend\":true,\"scale\":\"linear\",\"mode\":\"grouped\",\"times\":[],\"addTimeMarker\":false,\"defaultYExtents\":false,\"setYExtents\":false,\"yAxis\":{}},\"aggs\":[{\"id\":\"1\",\"type\":\"min\",\"schema\":\"metric\",\"params\":{\"field\":\"time_elapsed\"}},{\"id\":\"2\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"api.raw\",\"size\":30,\"order\":\"desc\",\"orderBy\":\"3\"}},{\"id\":\"3\",\"type\":\"avg\",\"schema\":\"metric\",\"params\":{\"field\":\"time_elapsed\"}},{\"id\":\"4\",\"type\":\"max\",\"schema\":\"metric\",\"params\":{\"field\":\"time_elapsed\"}}],\"listeners\":{}}",
         "description": "",
         "title": "Performance Analysis: API Vs Min/Avg/Max Elapsed Time",
         "uiStateJSON": "{}",
         "version": 1,
         "savedSearchId": "CSP-Logs",
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[]}"
         }
       }
     },
     {
       "_id": "Performance-Analysis:-Request-ID-Vs-Timestamp",
       "_type": "visualization",
       "_index": ".kibana",
       "_source": {
         "visState": "{\"title\":\"Performance Analysis: Request ID Vs Timestamp\",\"type\":\"histogram\",\"params\":{\"shareYAxis\":true,\"addTooltip\":true,\"addLegend\":true,\"scale\":\"linear\",\"mode\":\"stacked\",\"times\":[],\"addTimeMarker\":false,\"defaultYExtents\":false,\"setYExtents\":false,\"yAxis\":{}},\"aggs\":[{\"id\":\"1\",\"type\":\"cardinality\",\"schema\":\"metric\",\"params\":{\"field\":\"request_id.raw\"}},{\"id\":\"2\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"@timestamp\",\"size\":40,\"order\":\"desc\",\"orderBy\":\"1\"}}],\"listeners\":{}}",
         "description": "",
         "title": "Performance Analysis: Request ID Vs Timestamp",
         "uiStateJSON": "{}",
         "version": 1,
         "savedSearchId": "CSP-Logs",
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[]}"
         }
       }
     },
     {
       "_id": "Troubleshooting:-Service-App-Name-Vs-Status-Code-(Count)",
       "_type": "visualization",
       "_index": ".kibana",
       "_source": {
         "visState": "{\"title\":\"New Visualization\",\"type\":\"pie\",\"params\":{\"shareYAxis\":true,\"addTooltip\":true,\"addLegend\":true,\"isDonut\":true},\"aggs\":[{\"id\":\"1\",\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"service_app_name.raw\",\"size\":10,\"order\":\"desc\",\"orderBy\":\"1\"}},{\"id\":\"3\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"status_code\",\"size\":5,\"order\":\"desc\",\"orderBy\":\"1\"}}],\"listeners\":{}}",
         "description": "",
         "title": "Troubleshooting: Service App Name Vs Status Code (Count)",
         "uiStateJSON": "{}",
         "version": 1,
         "savedSearchId": "CSP-Logs",
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[]}"
         }
       }
     },
     {
       "_id": "Performance-Analysis:-Request_id-Vs-Application-Vs-API",
       "_[   96.638955] serial8250: too much work for irq4
   type": "visualization",
       "_index": ".kibana",
       "_source": {
         "visState": "{\"title\":\"Performance Analysis: Request_id Vs Application Vs API\",\"type\":\"pie\",\"params\":{\"shareYAxis\":true,\"addTooltip\":true,\"addLegend\":true,\"isDonut\":true},\"aggs\":[{\"id\":\"1\",\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"request_id.raw\",\"size\":10,\"order\":\"desc\",\"orderBy\":\"1\"}},{\"id\":\"3\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"service_app_name.raw\",\"size\":10,\"order\":\"desc\",\"orderBy\":\"1\"}},{\"id\":\"4\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"api.raw\",\"size\":10,\"order\":\"desc\",\"orderBy\":\"1\"}}],\"listeners\":{}}",
         "description": "",
         "title": "Performance Analysis: Request_id Vs Application Vs API",
         "uiStateJSON": "{}",
         "version": 1,
         "savedSearchId": "CSP-Logs",
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[{\"meta\":{\"index\":\"csplogs*\",\"key\":\"api.raw\",\"value\":\"%{method}--%{clean_url}--%{status_code}\",\"disabled\":false,\"negate\":true,\"alias\":null,\"apply\":true},\"query\":{\"match\":{\"api.raw\":{\"query\":\"%{method}--%{clean_url}--%{status_code}\",\"type\":\"phrase\"}}},\"$state\":{\"store\":\"appState\"}}]}"
         }
       }
     },
     {
       "_id": "Performance-Analysis:-Application-Vs-API",
       "_type": "visualization",
       "_index": ".kibana",
       "_source": {
         "visState": "{\"title\":\"Performance Analysis: Application Vs API\",\"type\":\"pie\",\"params\":{\"shareYAxis\":true,\"addTooltip\":true,\"addLegend\":true,\"isDonut\":true},\"aggs\":[{\"id\":\"1\",\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"service_app_name.raw\",\"size\":10,\"order\":\"desc\",\"orderBy\":\"1\"}},{\"id\":\"3\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"api.raw\",\"size\":10,\"order\":\"desc\",\"orderBy\":\"1\"}}],\"listeners\":{}}",
         "description": "",
         "title": "Performance Analysis: Application Vs API",
         "uiStateJSON": "{}",
         "version": 1,
         "savedSearchId": "CSP-Logs",
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[{\"meta\":{\"index\":\"csplogs*\",\"key\":\"api.raw\",\"value\":\"%{method}--%{clean_url}--%{status_code}\",\"disabled\":false,\"negate\":true,\"alias\":null,\"apply\":true},\"query\":{\"match\":{\"api.raw\":{\"query\":\"%{method}--%{clean_url}--%{status_code}\",\"type\":\"phrase\"}}},\"$state\":{\"store\":\"appState\"}}]}"
         }
       }
     },
     {
       "_id": "Troubleshooting:-Status-Code-Vs-Count",
       "_type": "visualization",
       "_index": ".kibana",
       "_source": {
         "visState": "{\"title\":\"New Visualization\",\"type\":\"histogram\",\"params\":{\"shareYAxis\":true,\"addTooltip\":true,\"addLegend\":true,\"scale\":\"linear\",\"mode\":\"stacked\",\"times\":[],\"addTimeMarker\":false,\"defaultYExtents\":false,\"setYExtents\":false,\"yAxis\":{}},\"aggs\":[{\"id\":\"1\",\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"status_code\",\"size\":5,\"order\":\"desc\",\"orderBy\":\"1\"}}],\"listeners\":{}}",
         "description": "",
         "title": "Troubleshooting: Status Code Vs Count",
         "uiStateJSON": "{}",
         "version": 1,
         "savedSearchId": "CSP-Logs",
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[]}"
         }
       }
     },
     {
       "_id": "Troubleshooting:-Log-Level-Vs-Count",
       "_type": "visualization",
       "_index": ".kibana",
       "_source": {
         "visState": "{\"title\":\"New Visualization\",\"type\":\"histogram\",\"params\":{\"shareYAxis\":true,\"addTooltip\":true,\"addLegend\":true,\"scale\":\"linear\",\"mode\":\"stacked\",\"times\":[],\"addTimeMarker\":false,\"defaultYExtents\":false,\"setYExtents\":false,\"yAxis\":{}},\"aggs\":[{\"id\":\"1\",\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"level.raw\",\"size\":5,\"order\":\"desc\",\"orderBy\":\"1\"}}],\"listeners\":{}}",
         "description": "",
         "title": "Troubleshooting: Log Level Vs Count",
         "uiStateJSON": "{}",
         "version": 1,
         "savedSearchId": "CSP-Logs",
         "kibanaSavedObjectMeta": {
           "searchSourceJSON": "{\"filter\":[]}"
         }
       }
     }
   ]
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
    

.. code-block:: none

   http://192.168.10.41:5601 (admin/Dynamic generated Elasticsearch password)
          

   - In Kibana UI : Go to Management -->Saved Objects -->Import 
      Click 'Import'
      Navigate to choose the 'export.json' file from the location where we just copied the file to.

   - Refresh Kibana UI, go to dashboards to view the visualizations.

      Once NS-instantitaion is made, logs will pop up in the kibana dashboard.

.. warning:: For this Lab we assume you do NOT have an Account for https://nfxweb.juniper.net !!!

As a result we need to upload the Server Cert generated on central-msvm during CSO installation to the Spoke and point the phone-home server on the Device directly to central-msvm and not to redirect.juniper.net. (In larger installs it will the regional-msvm). This is the only way to warrant the ZTP Process of device will succeed if you can’t work the regular way via the external redirect server.

.. code-block:: none

   ssh root@192.168.10.42 (passw0rd)
   cd /etc/pki/tls/certs/
   ls -l
   -rw-r--r-- 1 root root 1338 Jul 12 15:12 ssl_cert.crt
   -rw-r--r-- 1 root root 1070 Jul 12 15:12 ssl_cert.csr
   -rw-r--r-- 1 root root 1675 Jul 12 15:12 ssl_cert.key
   -rw-r--r-- 1 root root 3013 Jul 12 15:12 ssl_cert.pem
   -rw-r--r-- 1 root root 1310 Jul 12 15:12 ssl_cert_virtual_ip.crt
   -rw-r--r-- 1 root root 1058 Jul 12 15:12 ssl_cert_virtual_ip.csr
   -rw-r--r-- 1 root root 1675 Jul 12 15:12 ssl_cert_virtual_ip.key
   -rw-r--r-- 1 root root 2985 Jul 12 15:12 ssl_cert_virtual_ip.pem

   openssl x509 -in ssl_cert.crt -text | grep "CN="
           Issuer: C=US, ST=CA, O=Juniper Networks, L=Sunnyvale, CN=centralmsvm.example.net, OU=CSP/emailAddress=test@email.net
           Subject: C=US, ST=CA, O=Juniper Networks, L=Sunnyvale, CN=centralmsvm.example.net, OU=CSP/emailAddress=test@email.net

   host centralmsvm.example.net
   centralmsvm.example.net has address 192.168.10.42

Instead of using the automatic generated Certs **we use the backup-certs** from Chapter Appendix 8.12 below and upload those. This we guarantee that **all labs work with the same Certs** and the certificates below are always the same which make it easier to follow and apply the device changes:

.. code-block:: none

   scp root@192.168.10.10:/root/centralmsvm-certs.tgz .
   
   mkdir backup
   mv ssl_cert* backup
   tar xvfz centralmsvm-certs.tgz
   service haproxy restart
   sync ; sync

It should now look like this

.. code-block:: none

   openssl x509 -in ssl_cert_virtual_ip.crt -text | grep "CN="
           Issuer: C=US, ST=CA, O=Juniper Networks, L=Sunnyvale, CN=192.168.10.42, OU=CSP/emailAddress=test@email.net
           Subject: C=US, ST=CA, O=Juniper Networks, L=Sunnyvale, CN=192.168.10.42, OU=CSP/emailAddress=test@email.net

   host 192.168.10.42
   42.10.168.192.in-addr.arpa domain name pointer centralmsvm.


   cat ssl_cert.crt
   -----BEGIN CERTIFICATE-----
   MIIDrjCCApYCCQDZ8BNWtFex/DANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMC
   VVMxCzAJBgNVBAgMAkNBMRkwFwYDVQQKDBBKdW5pcGVyIE5ldHdvcmtzMRIwEAYD
   VQQHDAlTdW5ueXZhbGUxIDAeBgNVBAMMF2NlbnRyYWxtc3ZtLmV4YW1wbGUubmV0
   MQwwCgYDVQQLDANDU1AxHTAbBgkqhkiG9w0BCQEWDnRlc3RAZW1haWwubmV0MB4X
   DTE4MDcxMjEzMDYwNFoXDTIxMDQwNjEzMDYwNFowgZgxCzAJBgNVBAYTAlVTMQsw
   CQYDVQQIDAJDQTEZMBcGA1UECgwQSnVuaXBlciBOZXR3b3JrczESMBAGA1UEBwwJ
   U3Vubnl2YWxlMSAwHgYDVQQDDBdjZW50cmFsbXN2bS5leGFtcGxlLm5ldDEMMAoG
   A1UECwwDQ1NQMR0wGwYJKoZIhvcNAQkBFg50ZXN0QGVtYWlsLm5ldDCCASIwDQYJ
   KoZIhvcNAQEBBQADggEPADCCAQoCggEBAKtiYIRnR2Yq0eE/aqGTu+7MDFjxpjWX
   3CNf+yiNpG+dxtCcEXNrq1//UiBdPJlcKXq5mNOY359O0ueQrFhwPqaRwXoC04lR
   /W+2wLwse0ePeweQ0hd6GTQWAOjRfyQew+DZp31W10YDRSc8qzZTkgnYWqBJVFt/
   MnKgWNj8R50l0DK+nPhzDgo3iHVQh1M4x2muI238GSOJOsZNyOf0bUfj8Yti89AN
   wLIuQvbxaxP1qpbwRNK8ciA4DQr7RczNBVT4rsqw4GM3Hqtic7umM/EOQ1RCTjiU
   uGd56FkIqkkYGQ8nMWh7Uxfo1d+G8wjFXBUE6pxsMicU9DmZEKDix9ECAwEAATAN
   BgkqhkiG9w0BAQsFAAOCAQEAICz4G05p96lQToWDLf86XK24m8YtTAMZlckcErCx
   h2nQEDbiltSwspiaeyyenoAnK5KmGR6ijZDFuNIr5GIjbjx9RgrOLBacNDBous8Q
   C77w9BmCZB0TSuGMFeeV07A0lSEqoc2wX89Pic7rchb3LorJKE+ZEB0U2fppXp2o
   y8LnqX6ZgYH9QD5FBbVyTK0sw1aqPP/pRsv6Pa9mfvKivNPzfERJiFJkNdqvIj39
   iwUuwJUF3sN6cdKMj8s1irYnNhsB62M2pNFOCtvzIe+xLhbMlNEY1Qoiyk+KJOvZ
   fzX+nt1TrRi7zq+yGFSkOQ4kwAiWxSPUCZOcGLTjUd1G/Q==
   -----END CERTIFICATE-----

.. warning:: /\* fixme changes for NFXWEB as it needs unique FQDN for Cert now missing \*/

If you have an NFXWEB account and want to use it (which is fine and causes lesser changes on the devices) find out the device serial number

.. code-block:: none

   # login on each NFX you have

   cat /config/device_serial_id
   DD2316AF0086

   # login on each SRX you have


   cli
   show chassis hardware
   Hardware inventory:
   Item             Version  Part number  Serial number     Description
   Chassis                                CZ1616AF0021      SRX345
   Routing Engine   REV 0x06 650-065042   CZ1616AF0021      RE-SRX345
   FPC 0                                                    FPC
     PIC 0                                                  8xGE,8xGE SFP Base PIC
   Power Supply 0

   # go to central nfx web
   https://nfxweb.juniper.net/nfx/
   -> Select "Juniper Demo Account" as organisation
   -> Select "Manage Servers"
   # create a new server for regionalmsvm.example.net or use ANY OTHER NAME
   # and use the extracted certificate from above
   # make sure the IP address is 192.168.10.45
   -> Done
   -> Add device
   DD2316AF0086,CZ1616AF0021
   -> Add device
   -> next
   Search for "regionalmsvm.example.net" (or whatever name you gave it)
   Check the server
   -> Done

At this point the installerVM is no longer needed.

Power it down to save precious resources and continue from the cso-host

.. code-block:: none

   poweroff

Post installation for optional vCPE support
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

This section is only needed for vCPE test cases

#

# Changes to get Contrail and MX piece up

#

.. code-block:: none

   ssh root@192.168.10.15
   
   source /etc/contrail/openstackrc
   keystone user-create --name="cspadmin" --pass="passw0rd" --tenant="admin"
   keystone tenant-create --name="cso-project" --description="CSO Tenant"
   keystone user-role-add --tenant cso-project --user admin --role admin
   keystone user-role-add --tenant cso-project --user cspadmin --role admin
   keystone user-role-add --tenant cso-project --user cspadmin --role _member_
   keystone role-create --name operator
   keystone role-create --name tenant-operator
   
   
   RAW_TOKEN=`curl -d '{"auth":{"tenantName":"admin", "passwordCredentials":{"username":"admin", "password":"5DQkO6ME2Y87"}}}' -H "Content-type: application/json" http://192.168.10.42:5000/v2.0/tokens`
   TOKEN=`echo $RAW_TOKEN | python -c "import sys; import json; tok = json.loads(sys.stdin.read()); print tok['access']['token']['id'];"`
   echo $TOKEN
   
   # the next 3 curl calls should get an duplicate record so IGNORE
   
   curl -H "x-auth-token:$TOKEN" -H "content-type:application/json" -d '{"group": {"name": "operator", "domain_id": "default"}}' -XPOST http://192.168.10.42:5000/v3/groups
   
   curl -H "x-auth-token:$TOKEN" -H "content-type:application/json" -d '{"group": {"name": "admin", "domain_id": "default"}}' -XPOST http://192.168.10.42:5000/v3/groups
   
   curl -H "x-auth-token:$TOKEN" -H "content-type:application/json" -d '{"group": {"name": "_member_", "domain_id": "default"}}' -XPOST http://192.168.10.42:5000/v3/groups
   
   # Install the json-query package to decode the stuff
   apt-get -y install jq

   #curl -X GET http://192.168.10.42:5000/v3/groups  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq .

   OSGROUPADMIN=`curl -X GET http://192.168.10.42:5000/v3/groups  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq -r '.groups[] | select(.name=="admin") | .id '`
   echo $OSGROUPADMIN
   c8454af873124d5f9e59f4494a807f96

   OSGROUPMEMBER=`curl -X GET http://192.168.10.42:5000/v3/groups  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq -r '.groups[] | select(.name=="_member_") | .id '`
   echo $OSGROUPMEMBER
   1523773513c04e4d81c40203e9e52d81


   #curl -X GET http://192.168.10.42:5000/v3/users  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq .

   OSUSERCSPADMIN=`curl -X GET http://192.168.10.42:5000/v3/users  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq -r '.users[] | select(.name=="cspadmin") | .id '`
   echo $OSUSERCSPADMIN
   4b6e7eb96dcc477099d1d002e73403e4

   OSUSERADMIN=`curl -X GET http://192.168.10.42:5000/v3/users  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq -r '.users[] | select(.name=="admin") | .id '`
   echo $OSUSERADMIN
   51618ef488c549e8b0a4dda5d6f31bbb


   # group admin user admin
   curl -g -i -X PUT http://192.168.10.42:5000/v3/groups/$OSGROUPADMIN/users/$OSUSERADMIN  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN"

   # group admin user cspadmin
   curl -g -i -X PUT http://192.168.10.42:5000/v3/groups/$OSGROUPADMIN/users/$OSUSERCSPADMIN  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN"

   # group _member_ user admin
   curl -g -i -X PUT http://192.168.10.42:5000/v3/groups/$OSGROUPMEMBER/users/$OSUSERADMIN  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN"

   # group _member_ user cspadmin
   curl -g -i -X PUT http://192.168.10.42:5000/v3/groups/$OSGROUPMEMBER/users/$OSUSERCSPADMIN  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN"



   ###Add system_user property to cspadmin, admin & neutron users

   # user admin
   curl -X PATCH -H "X-Auth-Token:$TOKEN" -H "content-type:application/json" http://192.168.10.42:5000/v3/users/$OSUSERADMIN -d '{"user": {"system_user": 1 }}'

   # user cspadmin
   curl -X PATCH -H "X-Auth-Token:$TOKEN" -H "content-type:application/json" http://192.168.10.42:35357/v3/users/$OSUSERCSPADMIN -d '{"user": {"system_user": 1 }}'

   ## neutron (not possible)
   #curl -X PATCH -H "X-Auth-Token:$TOKEN" -H "content-type:application/json" http://192.168.10.42:35357/v3/users/<user-id> -d '{"user": {"system_user": 1 }}'


   e
      % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                    Dload  Upload   Total   Spent    Left  Speed
   100   907  100   907    0     0  17080      0 --:--:-- --:--:-- --:--:-- 17113
   {
     "links": {
       "next": null,
       "previous": null,
       "self": "http://192.168.10.42:5000/v3/users"
     },
     "users": [
       {
         "domain_id": "default",
         "id": "273929bea1d84e7ba29707001e588ba7",
         "enabled": true,
         "links": {
           "self": "http://192.168.10.42:5000/v3/users/273929bea1d84e7ba29707001e588ba7"
         },
         "name": "swift",
         "system_user": 1
       },
       {
         "domain_id": "default",
         "system_user": 1,
         "locked": false,
         "name": "cspadmin",
         "links": {
           "self": "http://192.168.10.42:5000/v3/users/4b6e7eb96dcc477099d1d002e73403e4"
         },
         "enabled": true,
         "email": "juniperse@juniper.net",
         "max_failed_attempts": 0,
         "change_password": true,
         "id": "4b6e7eb96dcc477099d1d002e73403e4"
       },
       {
         "id": "51618ef488c549e8b0a4dda5d6f31bbb",
         "last_login": "2018-04-04 20:31:30.029367",
         "domain_id": "default",
         "enabled": true,
         "links": {
           "self": "http://192.168.10.42:5000/v3/users/51618ef488c549e8b0a4dda5d6f31bbb"
         },
         "name": "admin",
         "system_user": 1,
         "failed_login_attempts": 0
       }
     ]
   }  

Use the CSO provided vSRX image as it has the right pre-setting to obtain an IP-Address via DHCP on fxp0 and the root password set to “passw0rd”

.. code-block:: none

   # install vSRX image for service-chain
   cd /root
   wget http://192.168.10.10:90/csp_components/vSRX-img
   
   source /etc/contrail/openstackrc
   glance image-create --name vSRX-img --disk-format qcow2 --container-format bare --visibility public --file vSRX-img
   +------------------+--------------------------------------+
   | Property         | Value                                |
   +------------------+--------------------------------------+
   | checksum         | 3ec381168c5b19ce1b166dc4b95d1a47     |
   | container_format | bare                                 |
   | created_at       | 2018-03-19T16:24:42Z                 |
   | disk_format      | qcow2                                |
   | id               | 2753e8fb-ebb8-488d-8a93-00af1cb219c6 |
   | min_disk         | 0                                    |
   | min_ram          | 0                                    |
   | name             | vSRX-img                             |
   | owner            | c52c125d1d52452caade9356e33ac808     |
   | protected        | False                                |
   | size             | 3525640192                           |
   | status           | active                               |
   | tags             | []                                   |
   | updated_at       | 2018-03-19T16:25:00Z                 |
   | virtual_size     | None                                 |
   | visibility       | public                               |
   +------------------+--------------------------------------+

# Apply mandatory patch for heat resources

.. code-block:: none

   # scp root@192.168.10.10:/root/Contrail_Service_Orchestration_3.3/scripts/jsm_contrail_3.py /usr/lib/python2.7/dist-packages/contrail_heat/resources/jsm.py

   cat <<EOF > /usr/lib/python2.7/dist-packages/contrail_heat/resources/jsm.py
   # jsm_contrail_3.py
   #
   # Author: nfvos-dev, June 2016
   #
   # Copyright(c) 2061, Juniper Networks, Inc.
   # All Rights Reserved.
   
   # Copy this file  to
   # /usr/lib/python2.7/dist-packages/contrail_heat/resources/jsm.py
   
   try:
       from heat.common.i18n import _
   except ImportError:
       pass
   from heat.engine import attributes
   from heat.engine import constraints
   from heat.engine import clients
   from heat.engine import properties
   from contrail_heat.resources import contrail
   try:
       from heat.openstack.common import log as logging
   except ImportError:
       from oslo_log import log as logging
   
   
   LOG = logging.getLogger(__name__)
   
   class HeatFlavor(contrail.ContrailResource):
       PROPERTIES = CPUS, MEMORY, DISK_GB = ('cpus', 'memory', 'disk_gb')
       properties_schema = {CPUS: properties.Schema(properties.Schema.INTEGER, _('Number of CPUs'), update_allowed=False),
        MEMORY: properties.Schema(properties.Schema.INTEGER, _('Memory size (mb)'), update_allowed=False),
        DISK_GB: properties.Schema(properties.Schema.INTEGER, _('Disk size (GB)'), update_allowed=False)}
       attributes_schema = {'flavor': attributes.Schema(_('The flavor'),),
        'show': attributes.Schema(_('All attributes.'))}
   
       default_client_name = 'nova'
   
       def handle_create(self):
           pass
   
       def _show_resource(self):
           dict = {}
           ret_flavor = None
           cpus = self.properties[self.CPUS]
           memory = self.properties[self.MEMORY]
           disk_gb = self.properties[self.DISK_GB]
           nova_client = clients.Clients(self.context).client('nova')
           flavors_list = nova_client.flavors.list()
           sorted_flavors_list = sorted(flavors_list, key=lambda k: (k.vcpus, k.ram, k.disk))
           for flavor in sorted_flavors_list:
               if flavor.vcpus >= cpus and flavor.ram >= memory and flavor.disk >= disk_gb:
                   ret_flavor = flavor
                   break
   
           dict['flavor'] = ret_flavor.name if ret_flavor else None
           return dict
   
       def handle_delete(self):
           pass
   
       def handle_update(self, json_snippet, tmpl_diff, prop_diff):
           pass
   
   
   def resource_mapping():
       return {'OS::JSM::GetFlavor': HeatFlavor}
   EOF
   
   ls -l /usr/lib/python2.7/dist-packages/contrail_heat/resources/jsm*
   -rw-r--r-- 1 root root 2154 Apr 23 03:01 /usr/lib/python2.7/dist-packages/contrail_heat/resources/jsm.py

   # don’t forget to also copy it as heat v2 resource
   cp /usr/lib/python2.7/dist-packages/contrail_heat/resources/jsm.py /usr/lib/python2.7/dist-packages/vnc_api/gen/heat/resources
   
   service heat-api restart
   service heat-api-cfn restart
   service heat-engine restart
   
   source /etc/contrail/openstackrc
   heat resource-type-list | grep GetF
   | OS::JSM::GetFlavor     <-- This is the response we need                 

# Image to ping something

.. code-block:: none

   source /etc/contrail/openstackrc
   wget https://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img
   
   glance image-create --name cirros --disk-format qcow2 --container-format bare --visibility public --file cirros-0.4.0-x86_64-disk.img

.. code-block:: none

   https://192.168.10.15:8143 (admin/contrail123)

|image26|

|image27|

.. code-block:: none

   -> Configure -> Networking
   # make sure you are in the admin project
   Configure > Networking > Networks > default-domain > admin
   Networks -> Add
   Name=manage-test
   Network Policy=passall
   Subnets -> Add
   CIDR=192.168.69.0/24
   Advanced Options -> Check "Shared"
   Route Target -> Add
   ASN=64512
   Target=10000
   -> Save

.. code-block:: none

   source /etc/contrail/openstackrc
   neutron net-list
   +--------------------------------------+-------------------------+------------------------------------------------------+
   | id                                   | name                    | subnets                                              |
   +--------------------------------------+-------------------------+------------------------------------------------------+
   | db16fdd8-b114-41f0-b7fd-347d397a35ae | __link_local__          |                                                      |
   | dde72e25-3ae0-4ec8-8d2c-2ba2794598d2 | manage-test             | d58a20dd-8bb2-4440-9f2f-e807e7c3408a 192.168.69.0/24 |
   | f9582eb1-86a8-4678-9100-ddf2c16edb0f | default-virtual-network |                                                      |
   | 9176be91-cf04-45c9-b37f-11bf6c199daf | ip-fabric               |                                                      |
   +--------------------------------------+-------------------------+------------------------------------------------------+
   
   nova boot --nic net-id=dde72e25-3ae0-4ec8-8d2c-2ba2794598d2 --flavor m1.tiny --image cirros test

.. code-block:: none

   nova list
   +--------------------------------------+------+--------+------------+-------------+--------------------------+
   | ID                                   | Name | Status | Task State | Power State | Networks                 |
   +--------------------------------------+------+--------+------------+-------------+--------------------------+
   | 806452fd-98f4-4fc9-b4ce-18f63b21f22a | test | ACTIVE | -          | Running     | manage-test=192.168.69.3 |
   +--------------------------------------+------+--------+------------+-------------+--------------------------+

.. code-block:: none

   show bgp neighbor
   Peer: 192.168.68.15+49050 AS 64512 Local: 169.254.169.254+179 AS 64512
     Group: contrail              Routing-Instance: master
     Forwarding routing-instance: master
     Type: Internal    State: Established    Flags: <Sync>
     Last State: OpenConfirm   Last Event: RecvKeepAlive
     Last Error: None
     Options: <Multihop Preference LocalAddress HoldTime KeepAll AddressFamily PeerAS Rib-group Refresh>
     Address families configured: inet-vpn-unicast inet6-vpn-unicast route-target evpn
     Local Address: 169.254.169.254 Holdtime: 90 Preference: 170
     Number of flaps: 0
     Peer ID: 192.168.68.15   Local ID: 169.254.169.254   Active Holdtime: 90
     Keepalive Interval: 30         Group index: 0    Peer index: 0
     I/O Session Thread: bgpio-0 State: Enabled
     BFD: disabled, down
     NLRI for restart configured on peer: inet-vpn-unicast inet6-vpn-unicast route-target evpn
     NLRI advertised by peer: inet-vpn-unicast inet6-vpn-unicast route-target evpn
     NLRI for this session: inet-vpn-unicast inet6-vpn-unicast route-target evpn
     Peer does not support Refresh capability
     Stale routes from peer are kept for: 300
     Peer does not support Restarter functionality
     NLRI that restart is negotiated for: inet-vpn-unicast inet6-vpn-unicast route-target evpn
     NLRI of received end-of-rib markers: inet-vpn-unicast inet6-vpn-unicast route-target evpn
     NLRI of all end-of-rib markers sent: inet-vpn-unicast inet6-vpn-unicast route-target evpn
     Peer does not support LLGR Restarter or Receiver functionality
     Peer does not support 4 byte AS extension
     Peer does not support Addpath
     Table bgp.rtarget.0 Bit: 10000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            2
       Accepted prefixes:            2
       Suppressed due to damping:    0
       Advertised prefixes:          3
     Table bgp.l3vpn.0
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: not advertising
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
     Table bgp.l3vpn-inet6.0
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: not advertising
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
     Table bgp.evpn.0
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: not advertising
       Active prefixes:              3
       Received prefixes:            3
       Accepted prefixes:            3
       Suppressed due to damping:    0
     Table vnf-mgnt.inet.0 Bit: 50000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table vnf-mgnt.inet6.0 Bit: 60000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          0
     Table public-vcpe.inet.0 Bit: 80000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          0
     Table public-vcpe.inet6.0 Bit: 90000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          0
     Table site-vcpe.inet.0 Bit: b0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          0
     Table site-vcpe.inet6.0 Bit: c0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          0
     Last traffic (seconds): Received 16752861 Sent 123 Checked 16752861
     Input messages:  Total 14     Updates 8       Refreshes 0     Octets 841
     Output messages: Total 4      Updates 2       Refreshes 0     Octets 388
     Output Queue[0]: 0            (bgp.rtarget.0, route-target)
     Output Queue[4]: 0            (vnf-mgnt.inet.0, inet-vpn-unicast)
     Output Queue[5]: 0            (vnf-mgnt.inet6.0, inet6-vpn-unicast)
     Output Queue[7]: 0            (public-vcpe.inet.0, inet-vpn-unicast)
     Output Queue[8]: 0            (public-vcpe.inet6.0, inet6-vpn-unicast)
     Output Queue[10]: 0           (site-vcpe.inet.0, inet-vpn-unicast)
     Output Queue[11]: 0           (site-vcpe.inet6.0, inet6-vpn-unicast)

.. code-block:: none

   show route
   .
   .
   vnf-mgnt.inet.0: 3 destinations, 3 routes (3 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   192.168.10.0/24    *[Direct/0] 00:10:27
                       > via ge-1/0/2.0
   192.168.10.70/32   *[Local/0] 00:10:27
                         Local via ge-1/0/2.0
   192.168.69.3/32    *[BGP/170] 00:03:58, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 17
   .
   .

#

# /\* fixme ping from regional-msvm

#

.. code-block:: none

   ssh root@192.168.10.45 (passw0rd)
   
   ping 192.168.10.70 -c3
   PING 192.168.10.70 (192.168.10.70) 56(84) bytes of data.
   64 bytes from 192.168.10.70: icmp_seq=1 ttl=64 time=0.667 ms
   64 bytes from 192.168.10.70: icmp_seq=2 ttl=64 time=0.758 ms
   64 bytes from 192.168.10.70: icmp_seq=3 ttl=64 time=3.22 ms
   
   --- 192.168.10.70 ping statistics ---
   3 packets transmitted, 3 received, 0% packet loss, time 2000ms
   rtt min/avg/max/mdev = 0.667/1.550/3.225/1.184 ms
   
   ping 192.168.68.15 -c10
   PING 192.168.68.15 (192.168.68.15) 56(84) bytes of data.
   64 bytes from 192.168.68.15: icmp_seq=1 ttl=64 time=0.271 ms
   From 192.168.68.15: icmp_seq=2 Redirect Host(New nexthop: 192.168.68.15)
   64 bytes from 192.168.68.15: icmp_seq=2 ttl=64 time=0.384 ms
   From 192.168.68.15: icmp_seq=3 Redirect Host(New nexthop: 192.168.68.15)
   64 bytes from 192.168.68.15: icmp_seq=3 ttl=64 time=0.431 ms
   From 192.168.68.15: icmp_seq=4 Redirect Host(New nexthop: 192.168.68.15)
   64 bytes from 192.168.68.15: icmp_seq=4 ttl=64 time=0.435 ms
   From 192.168.68.15: icmp_seq=5 Redirect Host(New nexthop: 192.168.68.15)
   64 bytes from 192.168.68.15: icmp_seq=5 ttl=64 time=0.466 ms
   From 192.168.68.15: icmp_seq=6 Redirect Host(New nexthop: 192.168.68.15)
   64 bytes from 192.168.68.15: icmp_seq=6 ttl=64 time=0.526 ms
   64 bytes from 192.168.68.15: icmp_seq=7 ttl=64 time=0.461 ms
   From 192.168.68.15: icmp_seq=8 Redirect Host(New nexthop: 192.168.68.15)
   64 bytes from 192.168.68.15: icmp_seq=8 ttl=64 time=0.479 ms
   64 bytes from 192.168.68.15: icmp_seq=9 ttl=64 time=0.484 ms
   64 bytes from 192.168.68.15: icmp_seq=10 ttl=64 time=0.352 ms
   
   --- 192.168.68.15 ping statistics ---
   10 packets transmitted, 10 received, 0% packet loss, time 9000ms
   rtt min/avg/max/mdev = 0.271/0.428/0.526/0.076 ms
   
   
   ping 192.168.69.3 -c10
   PING 192.168.69.3 (192.168.69.3) 56(84) bytes of data.
   64 bytes from 192.168.69.3: icmp_seq=1 ttl=62 time=1.80 ms
   From 192.168.69.3: icmp_seq=2 Redirect Host(New nexthop: 192.168.69.3)
   64 bytes from 192.168.69.3: icmp_seq=2 ttl=62 time=0.904 ms
   From 192.168.69.3: icmp_seq=3 Redirect Host(New nexthop: 192.168.69.3)
   64 bytes from 192.168.69.3: icmp_seq=3 ttl=62 time=0.909 ms
   From 192.168.69.3: icmp_seq=4 Redirect Host(New nexthop: 192.168.69.3)
   64 bytes from 192.168.69.3: icmp_seq=4 ttl=62 time=0.693 ms
   From 192.168.69.3: icmp_seq=5 Redirect Host(New nexthop: 192.168.69.3)
   64 bytes from 192.168.69.3: icmp_seq=5 ttl=62 time=1.00 ms
   From 192.168.69.3: icmp_seq=6 Redirect Host(New nexthop: 192.168.69.3)
   64 bytes from 192.168.69.3: icmp_seq=6 ttl=62 time=0.843 ms
   64 bytes from 192.168.69.3: icmp_seq=7 ttl=62 time=0.768 ms
   From 192.168.69.3: icmp_seq=8 Redirect Host(New nexthop: 192.168.69.3)
   64 bytes from 192.168.69.3: icmp_seq=8 ttl=62 time=0.670 ms
   64 bytes from 192.168.69.3: icmp_seq=9 ttl=62 time=1.02 ms
   64 bytes from 192.168.69.3: icmp_seq=10 ttl=62 time=0.900 ms
   
   --- 192.168.69.3 ping statistics ---
   10 packets transmitted, 10 received, 0% packet loss, time 9003ms
   rtt min/avg/max/mdev = 0.670/0.953/1.809/0.307 ms
   
   ssh cirros@192.168.69.3 (gocubsgo)
   $ ifconfig
   eth0      Link encap:Ethernet  HWaddr 02:63:B2:25:41:87
             inet addr:192.168.69.3  Bcast:192.168.69.255  Mask:255.255.255.0
             inet6 addr: fe80::63:b2ff:fe25:4187/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:6702 errors:0 dropped:0 overruns:0 frame:0
             TX packets:6700 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:291935 (285.0 KiB)  TX bytes:289901 (283.1 KiB)
   

Once you have created the desktop3-vm (which is below) come back and test that you can ping the MX as your default-gw. If this succeeds as well your lab is prepared for this test case.

|image28|

The following step is OPTIONAL to prepare a LinuxTables VM that you can use in a Demo instead of a vSRX. It comes up faster and shows we can work with third-party VM’s but the firewall piece is not nice (as its bare bone Linux tables one must understand).

.. code-block:: none

   source /etc/contrail/openstackrc
   
   wget http://cloud-images.ubuntu.com/releases/14.04/release/ubuntu-14.04-server-cloudimg-amd64-disk1.img
   
   glance image-create --name IPtables --visibility public --container-format bare --disk-format qcow2 < ubuntu-14.04-server-cloudimg-amd64-disk1.img
   
   cat <<EOF > user-data
   #cloud-config
   disable_root: false
   manage_etc_hosts: false
   chpasswd:
     list: |
       root:passw0rd
       ubuntu:ubuntu
     expire: False
   ssh_pwauth: True
   final_message: "The system is finally up, after $UPTIME seconds"
   
   groups:
     - cloud-users
   users:
     - default
   runcmd:
     - touch /etc/cloud/cloud-init.disabled
     - sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
     - service ssh restart
     - echo 200 left >> /etc/iproute2/rt_tables
     - echo 201 right >> /etc/iproute2/rt_tables
     - ufw enable; ufw allow ssh
     - |
       cloud-init-per instance set_network_interface
   
       echo 'auto lo
       iface lo inet loopback
   
       auto eth0
       iface eth0 inet dhcp
         metric 1
   
       auto eth1
       iface eth1 inet dhcp
         post-up ip rule add iif eth1 lookup right
         metric 100
   
       auto eth2
       iface eth2 inet dhcp
         post-up ip rule add iif eth2 lookup left
         metric 100
       ' > /etc/network/interfaces
   
     - cp /etc/network/interfaces /etc/network/interfaces.default
     - |
       echo '#!/bin/sh -e
       echo 1 > /proc/sys/net/ipv4/ip_forward
       ip route add default dev eth1 table left
       ip route add default dev eth2 table right
       iptables -F
       iptables -X
       iptables -t nat -F
       iptables -t nat -X
       iptables -t mangle -F
       iptables -t mangle -X
       iptables -t raw -F
       iptables -t raw -X
       iptables -P INPUT ACCEPT
       iptables -P FORWARD ACCEPT
       iptables -P OUTPUT ACCEPT
       exit 0
       ' > /etc/rc.local
     - |
     - sudo shutdown -h now
   EOF
   
   neutron net-list
   +--------------------------------------+-------------------------+------------------------------------------------------+
   | id                                   | name                    | subnets                                              |
   +--------------------------------------+-------------------------+------------------------------------------------------+
   | db16fdd8-b114-41f0-b7fd-347d397a35ae | __link_local__          |                                                      |
   | dde72e25-3ae0-4ec8-8d2c-2ba2794598d2 | manage-test             | d58a20dd-8bb2-4440-9f2f-e807e7c3408a 192.168.69.0/24 |
   | f9582eb1-86a8-4678-9100-ddf2c16edb0f | default-virtual-network |                                                      |
   | 9176be91-cf04-45c9-b37f-11bf6c199daf | ip-fabric               |                                                      |
   +--------------------------------------+-------------------------+------------------------------------------------------+
   
   
   nova boot --flavor m1.medium --user-data=user-data --image IPtables IPtable-temp --nic net-id=dde72e25-3ae0-4ec8-8d2c-2ba2794598d2

   # right after start the VM will show running state
   nova list
   +--------------------------------------+--------------+--------+------------+-------------+------------------------------------------------------------+
   | ID                                   | Name         | Status | Task State | Power State | Networks                                                   |
   +--------------------------------------+--------------+--------+------------+-------------+------------------------------------------------------------+
   | d196a3c9-19fd-428e-8835-169c4e6db738 | IPtable-temp | ACTIVE | -          | Running     | 1d4334b7-1f5d-41eb-8616-50e5b03fdcbc-mgmt-net=192.168.69.4 |
   +--------------------------------------+--------------+--------+------------+-------------+------------------------------------------------------------+
   
   sleep 2m
   
   # after the initial config is done the vm will shutdown itself
   # WAIT until you see it in shutdown state
   nova list
   +--------------------------------------+--------------+---------+------------+-------------+------------------------------------------------------------+
   | ID                                   | Name         | Status  | Task State | Power State | Networks                                                   |
   +--------------------------------------+--------------+---------+------------+-------------+------------------------------------------------------------+
   | d196a3c9-19fd-428e-8835-169c4e6db738 | IPtable-temp | SHUTOFF | -          | Shutdown    | 1d4334b7-1f5d-41eb-8616-50e5b03fdcbc-mgmt-net=192.168.69.4 |
   +--------------------------------------+--------------+---------+------------+-------------+------------------------------------------------------------+
   
   nova image-create --poll IPtable-temp IPtable-snap
   
   Server snapshotting... 100% complete
   Finished

   nova image-list
   +--------------------------------------+--------------+--------+--------------------------------------+
   | ID                                   | Name         | Status | Server                               |
   +--------------------------------------+--------------+--------+--------------------------------------+
   | 8bdd1f87-a85b-42c2-b9da-940f484bdeab | IPtable-snap | ACTIVE | d196a3c9-19fd-428e-8835-169c4e6db738 |
   | 4d34b335-0462-4cf6-8eed-d38ddfd087e5 | IPtables     | ACTIVE |                                      |
   | 902cf99f-53af-4c67-bb5d-a5a3654086f3 | cirros       | ACTIVE |                                      |
   | 2753e8fb-ebb8-488d-8a93-00af1cb219c6 | vSRX-img     | ACTIVE |                                      |
   +--------------------------------------+--------------+--------+--------------------------------------+
   
   glance image-download --file ./LxcImg.qcow2 8bdd1f87-a85b-42c2-b9da-940f484bdeab
   ls -l
   -rw-r--r-- 1 root root  921174016 Apr 23 09:47 LxcImg.qcow2
   -rw-r--r-- 1 root root  262668800 Apr  4 15:06 ubuntu-14.04-server-cloudimg-amd64-disk1.img

   glance image-create --name LxcImg --visibility public --container-format bare --disk-format qcow2 < LxcImg.qcow2
   
   nova list
   +--------------------------------------+--------------+---------+------------+-------------+------------------------------------------------------------+
   | ID                                   | Name         | Status  | Task State | Power State | Networks                                                   |
   +--------------------------------------+--------------+---------+------------+-------------+------------------------------------------------------------+
   | d196a3c9-19fd-428e-8835-169c4e6db738 | IPtable-temp | SHUTOFF | -          | Shutdown    | 1d4334b7-1f5d-41eb-8616-50e5b03fdcbc-mgmt-net=192.168.69.4 |
   +--------------------------------------+--------------+---------+------------+-------------+------------------------------------------------------------+
   
   nova delete d196a3c9-19fd-428e-8835-169c4e6db738
   
   glance image-list
   +--------------------------------------+--------------+
   | ID                                   | Name         |
   +--------------------------------------+--------------+
   | 8bdd1f87-a85b-42c2-b9da-940f484bdeab | IPtable-snap |
   | 4d34b335-0462-4cf6-8eed-d38ddfd087e5 | IPtables     |
   | ee7d850c-297b-4edd-9632-a9e6acd15e7a | LxcImg       |
   +--------------------------------------+--------------+

   glance image-delete 8bdd1f87-a85b-42c2-b9da-940f484bdeab
   glance image-delete 4d34b335-0462-4cf6-8eed-d38ddfd087e5

#

# delete our testvm and network on contrail!

# make sure there is NO predefined thing before you do any vCPE things

#

.. code-block:: none

   ssh root@192.168.10.15 (juniper123)
   
   source /etc/contrail/openstackrc
   nova list
   +--------------------------------------+------+--------+------------+-------------+--------------------------+
   | ID                                   | Name | Status | Task State | Power State | Networks                 |
   +--------------------------------------+------+--------+------------+-------------+--------------------------+
   | 806452fd-98f4-4fc9-b4ce-18f63b21f22a | test | ACTIVE | -          | Running     | manage-test=192.168.69.3 |
   +--------------------------------------+------+--------+------------+-------------+--------------------------+
   
   nova delete 806452fd-98f4-4fc9-b4ce-18f63b21f22a
   
   nova list
   +----+------+--------+------------+-------------+----------+
   | ID | Name | Status | Task State | Power State | Networks |
   +----+------+--------+------------+-------------+----------+
   +----+------+--------+------------+-------------+----------+

   neutron net-list
   +--------------------------------------+-------------------------+------------------------------------------------------+
   | id                                   | name                    | subnets                                              |
   +--------------------------------------+-------------------------+------------------------------------------------------+
   | db16fdd8-b114-41f0-b7fd-347d397a35ae | __link_local__          |                                                      |
   | dde72e25-3ae0-4ec8-8d2c-2ba2794598d2 | manage-test             | d58a20dd-8bb2-4440-9f2f-e807e7c3408a 192.168.69.0/24 |
   | f9582eb1-86a8-4678-9100-ddf2c16edb0f | default-virtual-network |                                                      |
   | 9176be91-cf04-45c9-b37f-11bf6c199daf | ip-fabric               |                                                      |
   +--------------------------------------+-------------------------+------------------------------------------------------+
   
   
   neutron net-delete dde72e25-3ae0-4ec8-8d2c-2ba2794598d2
   
   neutron net-list
   +--------------------------------------+-------------------------+---------+
   | id                                   | name                    | subnets |
   +--------------------------------------+-------------------------+---------+
   | db16fdd8-b114-41f0-b7fd-347d397a35ae | __link_local__          |         |
   | f9582eb1-86a8-4678-9100-ddf2c16edb0f | default-virtual-network |         |
   | 9176be91-cf04-45c9-b37f-11bf6c199daf | ip-fabric               |         |
   +--------------------------------------+-------------------------+---------+

Post installation for optional uCPE support
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

We need a second interface to support a second (legacy) interface for uCPE on the regional-msvm. More details are in Chapter 5 below.

On the CSO-Host add an additional interface (that will be eth1 inside the VM) to the regional-msvm.

.. code-block:: none

   virsh domiflist regionalmsvm
   Interface  Type       Source     Model       MAC
   -------------------------------------------------------
   vnet14     bridge     virbr0     virtio      52:54:00:00:62:a9

   virsh attach-interface --domain regionalmsvm --type bridge --source virbr0 --model virtio --config --live
   Interface attached successfully

   virsh domiflist regionalmsvm
   Interface  Type       Source     Model       MAC
   -------------------------------------------------------
   vnet14     bridge     virbr0     virtio      52:54:00:00:62:a9
   vnet16     bridge     virbr0     virtio      52:54:00:43:ac:69

Create local eth1.64 interface for OAM to CPE on regional-msvm to manage the device.

.. code-block:: none

   ssh root@192.168.10.45 (passw0rd)

   # check that you now have an eth1 inside the vm
   ifconfig -a
   .
   .
   eth0      Link encap:Ethernet  HWaddr 52:54:00:00:62:a9
             inet addr:192.168.10.45  Bcast:192.168.10.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fe00:62a9/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:15648831 errors:0 dropped:34764 overruns:0 frame:0
             TX packets:1109624 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:12129377924 (12.1 GB)  TX bytes:4717354884 (4.7 GB)
   
   eth1      Link encap:Ethernet  HWaddr 52:54:00:43:ac:69
             BROADCAST MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
   .
   .

   # change sources list to be able to load the vlan package
   cp /etc/apt/sources.list /etc/apt/sources.list.backup
   
   cat <<EOF > /etc/apt/sources.list
   #------------------------------------------------------------------------------#
   #                            OFFICIAL UBUNTU REPOS                             #
   #------------------------------------------------------------------------------#
   
   
   ###### Ubuntu Main Repos
   deb http://us.archive.ubuntu.com/ubuntu/ trusty main restricted universe multiverse 
   
   ###### Ubuntu Update Repos
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-security main restricted universe multiverse 
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-updates main restricted universe multiverse 
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-proposed main restricted universe multiverse 
   deb http://us.archive.ubuntu.com/ubuntu/ trusty-backports main restricted universe multiverse
   EOF
   
   apt-get update
   
   apt-get -y install vlan
   
   modprobe 8021q
   vconfig add eth1 64
   ip addr add 192.168.64.45/24 dev eth1.64
   ip link set up eth1
   ip link set up eth1.64
   route add -net 192.168.65.0 netmask 255.255.255.0 gw 192.168.64.1
   
   cat <<EOF >>/etc/network/interfaces
   
   auto eth1
   iface eth1 inet manual
   
   auto eth1.64
   iface eth1.64 inet static
   vlan_raw_device eth1
   address 192.168.64.45
   netmask 255.255.255.0
   up route add -net 192.168.65.0 netmask 255.255.255.0 gw 192.168.64.1 
   EOF
   
   cat /etc/network/interfaces
   auto eth0
   iface eth0 inet static
   address 192.168.10.45
   network 192.168.10.0
   netmask 255.255.255.0
   broadcast 192.168.10.255
   gateway 192.168.10.1
   dns-search example.net
   dns-nameservers 192.168.10.10
   
   auto eth1
   iface eth1 inet manual
   
   auto eth1.64
   iface eth1.64 inet static
   vlan_raw_device eth1
   address 192.168.64.45
   netmask 255.255.255.0
   up route add -net 192.168.65.0 netmask 255.255.255.0 gw 192.168.64.1
   
   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.10.1    0.0.0.0         UG    0      0        0 eth0
   172.16.0.0      0.0.0.0         255.255.0.0     U     0      0        0 flannel.1
   172.16.91.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
   192.168.64.0    0.0.0.0         255.255.255.0   U     0      0        0 eth1.64
   192.168.65.0    192.168.64.1    255.255.255.0   UG    0      0        0 eth1.64
   
   ping -c3 192.168.64.1
   
   exit

Create Desktop VM’s to simulate Clients
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#

# Create the Desktop VM's

#

.. code-block:: none

   cd /root
   
   # https://insights.ubuntu.com/2017/12/01/ubuntu-bionic-netplan
   wget https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
   
   virsh destroy desktop1; virsh undefine desktop1
   
   cp /root/bionic-server-cloudimg-amd64.img /var/lib/libvirt/images/desktop1.qcow2
   qemu-img resize /var/lib/libvirt/images/desktop1.qcow2 +10G
   chmod 666 /var/lib/libvirt/images/desktop1.qcow2
   
   cat <<EOF > meta-data
   hostname: desktop1
   local-hostname: desktop1
   instance-id: desktop1
   EOF
   
   cat <<EOF > user-data
   #cloud-config
   disable_root: false
   manage_etc_hosts: false
   chpasswd:
     list: |
       root:juniper123
       ubuntu:ubuntu
     expire: False
   ssh_pwauth: True
   final_message: "The system is finally up, after $UPTIME seconds"
   fqdn: desktop1.example.net
   groups:
     - cloud-users
   users:
     - default
   
   runcmd:
     - sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
     - service ssh restart
     - touch /etc/cloud/cloud-init.disabled
     - ifconfig ens3 192.168.10.60/24 up
     - route add default gw 192.168.10.1
     - echo nameserver 192.168.10.10 > /etc/resolv.conf
     - sed -i 's/archive/de.archive/g' /etc/apt/sources.list
     - apt-get update
     - apt-get -y install vlan netplan=0.36.1
     - apt-get -y install xorg
     - apt-get -y install --no-install-recommends lubuntu-core
     - apt-get -y install firefox vlc
     - |
       echo 'network: {config: disabled}' >/etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
     - rm -f /etc/netplan/*.yaml
     - |
       echo '
       network:
         version: 2
         renderer: networkd
         ethernets:
           ens3:
             dhcp4: false
           ens4:
             optional: true
             addresses: [192.168.10.60/24]
         vlans:
           vlan1099:
             id: 1099
             link: ens3
             addresses: [10.99.99.99/24]
             gateway4: 10.99.99.1
             nameservers:
               addresses: [8.8.8.8]
       ' > /etc/netplan/01-netcfg.yaml
     - netplan -s generate
     - cloud-init-per instance setup_etc_host echo '127.0.1.1 desktop1.example.net desktop1' >> /etc/hosts
     - apt-get -y remove cloud-init
     - poweroff
   EOF
   
   genisoimage -o desktop1.iso -V cidata -r -J meta-data user-data 
   
   virt-install -n desktop1 -r 1024 --vcpus=1 --disk path=/var/lib/libvirt/images/desktop1.qcow2,format=qcow2,device=disk,bus=virtio --import --disk path=/root/desktop1.iso,device=cdrom,bus=virtio --os-type linux --hvm --network=bridge:virbr0,model=virtio,mac=12:34:56:12:34:56 --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole
   
   
   virsh vncdisplay desktop1
   :7
   # ergo you must access the VM via -> 192.168.10.10:7

Wait more than five minutes if you see the VM not going further after 5 seconds of launch it just means no valid DHCP server responds but the automation will nail the IP address later when the timeout occurs.

|image29|

Depending of the Speed of the internet-connection x11 and other packages are now downloaded and installed.

|image30|

Once the VM has finished itself downloading package it will power-off itself so that you can notice the change when you do a regular “virsh list -all”

Copy the first VM and create new VM’s

.. code-block:: none

   virsh destroy desktop1; virsh undefine desktop1
   virsh destroy desktop2; virsh undefine desktop2
   virsh destroy desktop3; virsh undefine desktop3
   virsh destroy desktop4; virsh undefine desktop4
   
   cp /var/lib/libvirt/images/desktop1.qcow2 /var/lib/libvirt/images/desktop2.qcow2
   chmod 666 /var/lib/libvirt/images/desktop2.qcow2
   
   cp /var/lib/libvirt/images/desktop1.qcow2 /var/lib/libvirt/images/desktop3.qcow2
   chmod 666 /var/lib/libvirt/images/desktop3.qcow2
   
   cp /var/lib/libvirt/images/desktop1.qcow2 /var/lib/libvirt/images/desktop4.qcow2
   chmod 666 /var/lib/libvirt/images/desktop4.qcow2
   
   virt-install -n desktop2 -r 1024 --vcpus=1 --disk path=/var/lib/libvirt/images/desktop2.qcow2,format=qcow2,size=20,device=disk,bus=virtio --import --os-type linux --hvm --network=bridge:virbr0,model=virtio --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0,port=5992 --noautoconsole
   
   sleep 90
   rm /root/.ssh/known_hosts
   ssh root@192.168.10.60
   
   echo desktop2 > /etc/hostname
   sed -i 's/desktop1/desktop2/g' /etc/hosts
   
   cat <<EOF >/etc/netplan/01-netcfg.yaml
   network:
     version: 2
     renderer: networkd
     ethernets:
       ens3:
         dhcp4: false
     vlans:
       vlan1088:
         id: 1088
         link: ens3
         addresses: [10.88.88.88/24]
         gateway4: 10.88.88.1
         nameservers:
           addresses: [8.8.8.8]
   EOF
   
   netplan -s generate
   poweroff
   
   # reinstall with only one network interface
   virsh destroy desktop2; virsh undefine desktop2
   virt-install -n desktop2 -r 2048 --vcpus=1 --disk path=/var/lib/libvirt/images/desktop2.qcow2,format=qcow2,size=20,device=disk,bus=virtio --import --os-type linux --hvm --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0,port=5992 --noautoconsole
   
   
   virt-install -n desktop3 -r 1024 --vcpus=1 --disk path=/var/lib/libvirt/images/desktop3.qcow2,format=qcow2,size=20,device=disk,bus=virtio --import --os-type linux --hvm --network=bridge:virbr0,model=virtio --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0,port=5993 --noautoconsole
   
   sleep 90
   rm /root/.ssh/known_hosts
   ssh root@192.168.10.60
   
   echo desktop3 > /etc/hostname
   sed -i 's/desktop1/desktop3/g' /etc/hosts
   
   cat <<EOF >/etc/netplan/01-netcfg.yaml
   network:
     version: 2
     renderer: networkd
     ethernets:
       ens3:
         dhcp4: false
     vlans:
       vlan1077:
         id: 1077
         link: ens3
         addresses: [10.77.77.77/24]
         gateway4: 10.77.77.1
         nameservers:
           addresses: [8.8.8.8]
   EOF
   
   netplan -s generate
   poweroff
   
   # reinstall with only one network interface
   virsh destroy desktop3; virsh undefine desktop3
   virt-install -n desktop3 -r 1024 --vcpus=1 --disk path=/var/lib/libvirt/images/desktop3.qcow2,format=qcow2,size=20,device=disk,bus=virtio --import --os-type linux --hvm --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0,port=5993 --noautoconsole
   
   
   virt-install -n desktop4 -r 1024 --vcpus=1 --disk path=/var/lib/libvirt/images/desktop4.qcow2,format=qcow2,size=20,device=disk,bus=virtio --import --os-type linux --hvm --network=bridge:virbr0,model=virtio --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0,port=5994 --noautoconsole
   
   sleep 90
   rm /root/.ssh/known_hosts
   ssh root@192.168.10.60
   
   echo desktop4 > /etc/hostname
   sed -i 's/desktop1/desktop4/g' /etc/hosts
   
   cat <<EOF >/etc/netplan/01-netcfg.yaml
   network:
     version: 2
     renderer: networkd
     ethernets:
       ens3:
         dhcp4: false
     vlans:
       vlan1066:
         id: 1066
         link: ens3
         addresses: [10.66.66.66/24]
         gateway4: 10.66.66.1
         nameservers:
           addresses: [8.8.8.8]
   EOF
   
   netplan -s generate
   poweroff
   
   # reinstall with only one network interface
   virsh destroy desktop4; virsh undefine desktop4
   virt-install -n desktop4 -r 2048 --vcpus=1 --disk path=/var/lib/libvirt/images/desktop4.qcow2,format=qcow2,size=20,device=disk,bus=virtio --import --os-type linux --hvm --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0,port=5994 --noautoconsole
   
   
   virt-install -n desktop1 -r 1024 --vcpus=1 --disk path=/var/lib/libvirt/images/desktop1.qcow2,format=qcow2,size=20,device=disk,bus=virtio --import --os-type linux --hvm --network=bridge:virbr0,model=virtio --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0,port=5991 --noautoconsole
   
   sleep 90
   rm /root/.ssh/known_hosts
   ssh root@192.168.10.60
   
   cat <<EOF >/etc/netplan/01-netcfg.yaml
   network:
     version: 2
     renderer: networkd
     ethernets:
       ens3:
         dhcp4: false
     vlans:
       vlan1099:
         id: 1099
         link: ens3
         addresses: [10.99.99.99/24]
         gateway4: 10.99.99.1
         nameservers:
           addresses: [8.8.8.8]
   EOF
   
   netplan -s generate
   poweroff
   
   # reinstall with only one network interface
   virsh destroy desktop1; virsh undefine desktop1
   virt-install -n desktop1 -r 1024 --vcpus=1 --disk path=/var/lib/libvirt/images/desktop1.qcow2,format=qcow2,size=20,device=disk,bus=virtio --import --os-type linux --hvm --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0,port=5991 --noautoconsole

.. code-block:: none

   virsh autostart desktop1
   virsh autostart desktop2
   virsh autostart desktop3
   virsh autostart desktop4

Create DelayVM for SD-WAN traffic manipulation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

https://www.excentis.com/blog/use-linux-traffic-control-impairment-node-test-environment-part-2

This VM has a bit of tricky forwarding engine to simplify the lab setup without creating too much changes for the outside environment in terms of route changes when this is inserted (or removed) from the path between hub and spoke. We kind of emulate the behaviour of a Contrail vRouter plus a VM in service-chaining-mode with TWO independent chains in a single installation. The VM has four interfaces:

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| VM interface                                                                                                                                                                                                                                                                                                                               | Connected to                                                                                                                                                                                                                                                                                                                               | Path                                                                                                                                                                                                                                                                                                                                       |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| eth0.131                                                                                                                                                                                                                                                                                                                                   | Spoke                                                                                                                                                                                                                                                                                                                                      | WAN_0                                                                                                                                                                                                                                                                                                                                      |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| eth0.132                                                                                                                                                                                                                                                                                                                                   | Hub/Internet                                                                                                                                                                                                                                                                                                                               | WAN_0                                                                                                                                                                                                                                                                                                                                      |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| eth0.134                                                                                                                                                                                                                                                                                                                                   | Spoke                                                                                                                                                                                                                                                                                                                                      | WAN_1                                                                                                                                                                                                                                                                                                                                      |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| eth0.135                                                                                                                                                                                                                                                                                                                                   | Hub/Internet                                                                                                                                                                                                                                                                                                                               | WAN_1                                                                                                                                                                                                                                                                                                                                      |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

For each path (WAN0/1) the forwarding is made to have every ingress packet of one interface is moved over to the **opposite** interface of the **same** path and that interface forwards the packet **blindly** to the **individual** default GW that is configured for this interface.

As a nature of this you need to emulate the behaviour of two virtual routers with route-leaking, next table-lookup, incoming packet forwarding and so forth in a single “magic” instance.

We don’t explain the entire construction in details here as this is not a training class on Linux routes and forwarding engine and this VM is not important for SD-WAN as such and only helps us to delay+drop Traffic which is not configurable on Junos Routers. You can review the config below if you want to learn this.

.. code-block:: none

   cd /root
   
   #qemu-img create -f qcow2 /var/lib/libvirt/images/delayvm.qcow2 20G
   virsh destroy delayvm
   virsh undefine delayvm
   cp /root/Contrail_Service_Orchestration_4.0.0/artifacts/ubuntu-14.04.5_163.img /var/lib/libvirt/images/delayvm.qcow2
   chmod 666 /var/lib/libvirt/images/delayvm.qcow2
   
   cat <<EOF > meta-data
   hostname: delayvm
   local-hostname: delayvm
   instance-id: delayvm
   EOF
   
   cat <<EOF > user-data
   #cloud-config
   apt_update: true
   disable_root: false
   manage_etc_hosts: false
   chpasswd:
     list: |
       root:juniper123
     expire: False
   ssh_pwauth: True
   final_message: "The system is finally up, after $UPTIME seconds"
   fqdn: delayvm.example.net
   groups:
     - cloud-users
   users:
     - default
   
   write_files:
     - path: /root/bootconfig.sh
       owner: root:root
       permissions: '0777'
       content: |
         #!/bin/bash
         ip route flush table wan0spoke
         ip route flush table wan0hub
         ip route flush table wan1spoke
         ip route flush table wan1hub 
         ip route add 192.168.131.0/24 via 192.168.131.254 dev eth0.131 table wan0spoke
         ip route add default via 192.168.131.1 dev eth0.131 table wan0spoke
         ip route add 192.168.132.0/24 via 192.168.132.254 dev eth0.132 table wan0hub
         ip route add default via 192.168.132.1 dev eth0.132 table wan0hub
         ip route add 192.168.134.0/24 via 192.168.134.254 dev eth0.134 table wan1spoke
         ip route add default via 192.168.134.1 dev eth0.134 table wan1spoke
         ip route add 192.168.135.0/24 via 192.168.135.254 dev eth0.135 table wan1hub
         ip route add default via 192.168.135.1 dev eth0.135 table wan1hub
         ip rule add iif eth0.131 lookup wan0hub
         ip rule add iif eth0.132 lookup wan0spoke
         ip rule add iif eth0.134 lookup wan1hub
         ip rule add iif eth0.135 lookup wan1spoke
         ip route flush cache
         iptables -F
         iptables -X
         iptables -t nat -F
         iptables -t nat -X
         iptables -t mangle -F
         iptables -t mangle -X
         iptables -t raw -F
         iptables -t raw -X
         iptables -P INPUT ACCEPT
         iptables -P FORWARD ACCEPT
         iptables -P OUTPUT ACCEPT
         echo 1 > /proc/sys/net/ipv4/ip_forward
         sed -i '/By default this script does nothing/a /root/bootconfig.sh' /etc/rc.local
         sed -i '/# By default this script does nothing/d' /etc/rc.local
         exit 0
   
   runcmd:
     - sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
     - mount /dev/vdb /mnt
     - cp /mnt/vlan_1.9-3ubuntu10.1_amd64.deb /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - dpkg -i /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - sed -i '/net.ipv4.ip_forward/s/^#//g' /etc/sysctl.conf
     - sysctl -p /etc/sysctl.conf
     - touch /etc/cloud/cloud-init.disabled
     - service ssh restart
     - echo 200 wan0spoke >> /etc/iproute2/rt_tables
     - echo 201 wan0hub >> /etc/iproute2/rt_tables
     - echo 202 wan1spoke >> /etc/iproute2/rt_tables
     - echo 203 wan1hub >> /etc/iproute2/rt_tables
     - |
       cloud-init-per instance set_network_interface
   
       echo 'auto lo
       iface lo inet loopback
   
       auto eth0
       iface eth0 inet manual
   
       auto eth0.131
       iface eth0.131 inet static
       vlan_raw_device eth0
       address 192.168.131.254
       netmask 255.255.255.0
   
       auto eth0.132
       iface eth0.132 inet static
       vlan_raw_device eth0
       address 192.168.132.254
       netmask 255.255.255.0
   
       auto eth0.134
       iface eth0.134 inet static
       vlan_raw_device eth0
       address 192.168.134.254
       netmask 255.255.255.0
   
       auto eth0.135
       iface eth0.135 inet static
       vlan_raw_device eth0
       address 192.168.135.254
       netmask 255.255.255.0
   
       ' > /etc/network/interfaces
   
     - |
       cloud-init-per instance setup_etc_host echo '127.0.1.1 delayvm.example.net delayvm' >> /etc/hosts
     - /root/bootconfig.sh
   
   power_state:
     mode: reboot
     delay: "now"
     timeout: 120
   EOF
   
   # add vlan package to iso
   #wget http://archive.ubuntu.com/ubuntu/pool/main/v/vlan/vlan_1.9-3ubuntu10.1_amd64.deb
   wget http://launchpadlibrarian.net/289303823/vlan_1.9-3ubuntu10.1_amd64.deb
   
   genisoimage -o delayvm.iso -V cidata -r -J meta-data user-data vlan_1.9-3ubuntu10.1_amd64.deb
   
   virt-install -n delayvm -r 1024 --vcpus=1 \
   --disk path=/var/lib/libvirt/images/delayvm.qcow2,format=qcow2,size=20,device=disk,bus=virtio \
   --import --disk path=/root/delayvm.iso,device=cdrom,bus=virtio --os-type linux --hvm \
   --network=bridge:virbr0,model=virtio --network=bridge:virbr0,model=virtio \
   --graphics vnc,listen=0.0.0.0 --noautoconsole
   
   virsh autostart delayvm
   
   virsh console delayvm
   
   ifconfig
   eth0      Link encap:Ethernet  HWaddr 52:54:00:c4:ad:64
             inet6 addr: fe80::5054:ff:fec4:ad64/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:73884 errors:0 dropped:198 overruns:0 frame:0
             TX packets:39 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:24245664 (24.2 MB)  TX bytes:3294 (3.2 KB)
   
   eth0.131  Link encap:Ethernet  HWaddr 52:54:00:c4:ad:64
             inet addr:192.168.131.254  Bcast:192.168.131.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fec4:ad64/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:648 (648.0 B)
   
   eth0.132  Link encap:Ethernet  HWaddr 52:54:00:c4:ad:64
             inet addr:192.168.132.254  Bcast:192.168.132.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fec4:ad64/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:648 (648.0 B)
   
   eth0.134  Link encap:Ethernet  HWaddr 52:54:00:c4:ad:64
             inet addr:192.168.134.254  Bcast:192.168.134.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fec4:ad64/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:648 (648.0 B)
   
   eth0.135  Link encap:Ethernet  HWaddr 52:54:00:c4:ad:64
             inet addr:192.168.135.254  Bcast:192.168.135.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fec4:ad64/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:648 (648.0 B)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:112 errors:0 dropped:0 overruns:0 frame:0
             TX packets:112 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:8352 (8.3 KB)  TX bytes:8352 (8.3 KB)
   
   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   192.168.131.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0.131
   192.168.132.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0.132
   192.168.134.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0.134
   192.168.135.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0.135
   
   ip route show
   192.168.131.0/24 dev eth0.131  proto kernel  scope link  src 192.168.131.254
   192.168.132.0/24 dev eth0.132  proto kernel  scope link  src 192.168.132.254
   192.168.134.0/24 dev eth0.134  proto kernel  scope link  src 192.168.134.254
   192.168.135.0/24 dev eth0.135  proto kernel  scope link  src 192.168.135.254
   
   ip rule show
   0:      from all lookup local
   32762:  from all iif eth0.135 lookup wan1spoke
   32763:  from all iif eth0.134 lookup wan1hub
   32764:  from all iif eth0.132 lookup wan0spoke
   32765:  from all iif eth0.131 lookup wan0hub
   32766:  from all lookup main
   32767:  from all lookup default
   
   ip route show table wan0spoke
   default via 192.168.131.1 dev eth0.131
   192.168.131.0/24 via 192.168.131.254 dev eth0.131
   
   ip route show table wan0hub
   default via 192.168.132.1 dev eth0.132
   192.168.132.0/24 via 192.168.132.254 dev eth0.132
   
   ip route show table wan1spoke
   default via 192.168.134.1 dev eth0.134
   192.168.134.0/24 via 192.168.134.254 dev eth0.134
   
   ip route show table wan1hub
   default via 192.168.135.1 dev eth0.135
   192.168.135.0/24 via 192.168.135.254 dev eth0.135

# Wait > 5minutes if no local DHCP server avail for cloud-init on first interface

# Note: The VM will be automatically rebooted after first boot to apply the config

First Login to CSO
~~~~~~~~~~~~~~~~~~

Login as cspadmin to https://192.168.10.42

Change the password from the dynamic CSO assigned (“Wy6dtEtPBR@Y” in our example) to “Juniper123!”

Now download the latest Signature Database for SD-WAN as below.

.. note:: This process takes about ~ 25minutes to complete so do that before the PoC.

|image31|

**WAIT** with the next step until you really see the end of this process! Do not trust any earlier (success) message from the system.

|image32|

Should the signature download finally fail with an errormessage like the below then try again with an OLDER signature!!

|image33|

MANDATORY create a backup of your CSO installation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note:: We know that starting with V4.1.0 CSO has now an own snapshot procedure. However it is missing some functions right now so we can’t use it and remain to our own developed one (there are multiple reasons behind that decision).

.. code-block:: none

   ssh root@192.168.10.10 
   
   virsh list --all
    Id    Name                           State
   ----------------------------------------------------
    3     natvm                          running
    5     centralinfravm                 running
    6     centralmsvm                    running
    7     centralk8mastervm              running
    8     installervm                    running
    9     canvm                          running
    10    vrr                            running
    11    regional-sblb                  running
    14    desktop2                       running
    16    desktop3                       running
    18    desktop4                       running
    20    desktop1                       running
    21    delayvm                        running
   
   virsh shutdown installervm
   virsh shutdown centralinfravm
   virsh shutdown centralmsvm
   virsh shutdown canvm
   virsh shutdown centralk8mastervm
   virsh destroy vrr
   virsh shutdown regional-sblb
   virsh destroy desktop1
   virsh destroy desktop2
   virsh destroy desktop3
   virsh destroy desktop4
   virsh shutdown delayvm
   
   watch "virsh list --all"

   # wait until you see this
   # only the natvm will have to stay up
   Every 2.0s: virsh list --all                            Mon Mar 19 11:39:20 2018

   Id    Name                           State
   ----------------------------------------------------
    3     natvm                          running
    -     canvm                          shut off
    -     centralinfravm                 shut off
    -     centralk8mastervm              shut off
    -     centralmsvm                    shut off
    -     delayvm                        shut off
    -     desktop1                       shut off
    -     desktop2                       shut off
    -     desktop3                       shut off
    -     desktop4                       shut off
    -     installervm                    shut off
    -     regional-sblb                  shut off
    -     vrr                            shut off

.. code-block:: none

   ls -l /var/lib/libvirt/images/
   -rw-rw-rw- 1 root root  386269184 Jul 12 17:43 delayvm.qcow2
   -rw-rw-rw- 1 root root 2165964800 Jul 12 17:43 desktop1.qcow2
   -rw-rw-rw- 1 root root 2165899264 Jul 12 17:43 desktop2.qcow2
   -rw-rw-rw- 1 root root 2166620160 Jul 12 17:43 desktop3.qcow2
   -rw-rw-rw- 1 root root 2165964800 Jul 12 17:43 desktop4.qcow2
   -rw-rw-rw- 1 root root  482148352 Jul 12 17:17 natvm.qcow2

.. code-block:: none

   cd /root
   mkdir backup
   date
   cp /var/lib/libvirt/images/delayvm.qcow2 /root/backup
   cp /var/lib/libvirt/images/desktop1.qcow2 /root/backup
   cp /var/lib/libvirt/images/desktop2.qcow2 /root/backup
   cp /var/lib/libvirt/images/desktop3.qcow2 /root/backup
   cp /var/lib/libvirt/images/desktop4.qcow2 /root/backup
   cp -R /root/ubuntu_vm /root/backup
   # remove the swap-space images from your backup as they are useless
   rm `find /root/backup/ubuntu_vm -name "*-swap*"`
   date
   # ~25min
   
   du -h backup
   5.8G    backup/ubuntu_vm/centralk8mastervm
   48G     backup/ubuntu_vm/centralmsvm
   17G     backup/ubuntu_vm/centralinfravm
   17G     backup/ubuntu_vm/canvm
   2.6G    backup/ubuntu_vm/regional-sblb
   616M    backup/ubuntu_vm/vrr
   31G     backup/ubuntu_vm/installervm
   120G    backup/ubuntu_vm
   151G    backup 
   
   df -lh
   Filesystem      Size  Used Avail Use% Mounted on
   udev            126G  4.0K  126G   1% /dev
   tmpfs            26G  1.4M   26G   1% /run
   /dev/dm-0       1.6T  387G  1.1T  26% /
   none            4.0K     0  4.0K   0% /sys/fs/cgroup
   none            5.0M     0  5.0M   0% /run/lock
   none            126G     0  126G   0% /run/shm
   none            100M     0  100M   0% /run/user
   /dev/sda1       237M   48M  177M  22% /boot

#

# not bad also to backup the kvm information

#

.. code-block:: none

   virsh dumpxml installervm > /root/backup/installervm.xml
   virsh dumpxml centralinfravm > /root/backup/centralinfravm.xml
   virsh dumpxml centralmsvm > /root/backup/centralmsvm.xml
   virsh dumpxml canvm > /root/backup/canvm.xml
   virsh dumpxml centralk8mastervm > /root/backup/centralk8mastervm.xml
   virsh dumpxml vrr > /root/backup/vrr.xml
   virsh dumpxml regional-sblb > /root/backup/regional-sblb.xml
   virsh dumpxml desktop1 > /root/backup/desktop1.xml
   virsh dumpxml desktop2 > /root/backup/desktop2.xml
   virsh dumpxml desktop3 > /root/backup/desktop3.xml
   virsh dumpxml desktop4 > /root/backup/desktop4.xml
   virsh dumpxml delayvm > /root/backup/delayvm.xml
   virsh dumpxml natvm > /root/backup/natvm.xml

Start your VM’s again

.. code-block:: none

   virsh start installervm
   virsh start canvm
   virsh start centralk8mastervm
   virsh start centralinfravm
   virsh start regional-sblb
   virsh start vrr
   virsh start desktop1
   virsh start desktop2
   virsh start desktop3
   virsh start desktop4
   virsh start delayvm
   sleep 6m
   virsh start centralmsvm
   sleep 7m

Check your Lab is up and running again

.. code-block:: none

   virsh console installervm
   cd Contrail_Service_Orchestration_4.1.0/
   ./components_health.sh
   .
   .
   INFO     =============== Health Check start time: 2019-03-05 13:41:35.405562 ==============
   INFO     =============== Health Check end time: 2019-03-05 13:42:45.782936   ==============
   INFO     =============== Health Check duration: 0:01:10.377374   ==============

   # see is the logfile is empty. If that is the case you are good
   cat /root/Contrail_Service_Orchestration_4.1.0/logs/health_check_error.log

   # This is just for reference on what’s checked
   cat /root/Contrail_Service_Orchestration_4.1.0/logs/health_check_console.log
   =============== Health Check start time: 2019-03-05 13:41:35.405562 ==============
   
   <<<<<<<< SALTSTACK >>>>>>>>>     [2019-03-05 13:41:53.667309]
   
   
   <<<<<<<< CASSANDRA >>>>>>>>>     [2019-03-05 13:41:54.771449]
   
   
   <<<<<<<< ELASTICSEARCH >>>>>>>>>         [2019-03-05 13:41:55.732097]
   
   The Master node ip is :192.168.10.42
   
   Elasticsearch is Running in the Node 192.168.10.41
   Elasticsearch is running in all 1 nodes
   
   
   <<<<<<<< ETCD >>>>>>>>>  [2019-03-05 13:41:57.435191]
   
   http://192.168.10.41:2379/health
   
   Etcd is running in node 192.168.10.41 and status is HEALTHY
   
   Available healthy members are:
   
   ['192.168.10.41']
   
   Etcd cluster is Healthy
   
   
   <<<<<<<< MARIADB >>>>>>>>>       [2019-03-05 13:41:59.039356]
   
   MariaDB is running in node: 192.168.10.41 and cluster status is: DISCONNECTED
   
   
   <<<<<<<< RABBITMQ >>>>>>>>>      [2019-03-05 13:42:00.772402]
   
   The Healthy nodes are:  ['192.168.10.41']
   The following nodes are running in RabbitMQ cluster in : 192.168.10.41
   
           rabbit@centralinfravm]
   
   
   <<<<<<<< ZOOKEEPER >>>>>>>>>     [2019-03-05 13:42:03.800404]
   
   Zookeeper is running in Standalone mode and is Healthy
   
   
   <<<<<<<< REDIS >>>>>>>>>         [2019-03-05 13:42:04.828849]
   
   Redis is running in node : 192.168.10.41
   
   
   <<<<<<<< ARANGODB >>>>>>>>>      [2019-03-05 13:42:05.427818]
   
   
    ArangoDB running in the Node 192.168.10.41 has a role : SINGLE
   
    ArangoDB is running in STANDALONE mode
   
   
   <<<<<<<< SIM_CLUSTER >>>>>>>>>   [2019-03-05 13:42:06.955487]
   
   Sim_cluster (Icinga) is running in node: 192.168.10.42
   
   
   <<<<<<<< ELK_LOGSTASH >>>>>>>>>  [2019-03-05 13:42:07.537898]
   
   ELK_Logstash is running in node: 192.168.10.41
   
   
   <<<<<<<< ELK_KIBANA >>>>>>>>>    [2019-03-05 13:42:08.146901]
   
   ELK_Kibana is running in node: 192.168.10.41
   
   
   <<<<<<<< KEYSTONE >>>>>>>>>      [2019-03-05 13:42:08.755608]
   
   Keystone token generation is successful
   
   <<<<<<<< SWIFT >>>>>>>>>         [2019-03-05 13:42:09.962038]
   
   keystone_auth_url: http://192.168.10.42:5000/v3
   swift --os-username admin --os-password  --os-auth-url http://192.168.10.42:5000/v3 --os-user-domain-id default --os-project-domain-id default --os-identity-api-version 3 --os-project-name admin --os-region-name central -v stat
   key_data: {'service_protocol': 'tcp', 'swift_keystone_tenant': 'admin', 'swift_authversion': 2.0, 'swift_keystone_user': 'swift', 'keys': {'swift_hash_path_suffix': '8dc2678ca213e6e45e78', 'temp_url_key_2': 'mykey2', 'chosen_temp_url_key': 'temp_url_key', 'temp_url_key': 'mykey', 'swift_hash_path_prefix': '697284a10acb4831383b'}, 'storage': {'disks': None}, 'swift_keystone_password': 'ok3SnUGPMgftimXfjq0oiIFSFRfp7S3IHU08WbZRqoQ=', 'service_ports': {'swift_proxy_port': 9090}, 'dataDir': '/mnt/data/swift', 'containers': ['mycontainer', 'phs_images', 'fmpm_region_container', 'vim_container', 'signature_manager_container'], 'swift_apiendpoint_version': 'v1'}
   swift command output: {'pid': 6517, 'retcode': 0, 'stderr': '', 'stdout': '                     StorageURL: http://192.168.10.42:9090/v1/AUTH_81b3405d559441bb8e5330877ebec799\n                     Auth Token: 1fc21b408685438ab4b48ba55396d767\n                        Account: AUTH_81b3405d559441bb8e5330877ebec799\n                     Containers: 5\n                        Objects: 27\n                          Bytes: 5470680054\nContainers in policy "policy-0": 5\n   Objects in policy "policy-0": 27\n     Bytes in policy "policy-0": 5470680054\n            Meta Temp-Url-Key-2: mykey2\n              Meta Temp-Url-Key: mykey\n    X-Account-Project-Domain-Id: default\n                    X-Timestamp: 1551782017.00712\n                     X-Trans-Id: txcb983b9016f846319f45a-005c7e6ea4\n                   Content-Type: text/plain; charset=utf-8\n                  Accept-Ranges: bytes'}
   Temp url key output from swift: ['Temp-Url-Key-2: mykey2\n              ', 'Temp-Url-Key: mykey\n    ']
   Swift is Healthy
   
   
   <<<<<<<< KUBERNETES >>>>>>>>>    [2019-03-05 13:42:12.637175]
   
   Docker is running in KUBEMASTER node:192.168.10.43
   
   Docker port 2375 is in listening state in: 192.168.10.43
   
   Flanneld is running in KUBEMASTER node:192.168.10.43
   
   Docker is running in KUBEMINION node:192.168.10.42
   
   Docker port 2375 is in listening state in: 192.168.10.42
   
   Flanneld is running in KUBEMINION node:192.168.10.42
   
   Both Docker and Flannel are Healthy
   
   All nodes are in Ready state
   
   etcd-empty-dir-cleanup-192.168.10.43    1/1     Running
   kube-addon-manager-192.168.10.43        1/1     Running
   kube-apiserver-192.168.10.43    1/1     Running
   kube-controller-manager-192.168.10.43   1/1     Running
   kube-dns-3204305068-z87tp       3/3     Running
   kube-proxy-192.168.10.42        1/1     Running
   kube-scheduler-192.168.10.43    1/1     Running
   Kubernetes nodes are in Ready state and Kube-System pods are running
   
   
   <<<<<<<< CONTRAIL_ANALYTICS >>>>>>>>>    [2019-03-05 13:42:17.312196]
   
   ['analytics', 'analyticsdb', 'controller', 'registry']
   Status of analytics in node : 192.168.10.48
   
   192.168.10.48 -- contrail-alarm-gen : ['active']
   192.168.10.48 -- contrail-analytics-api : ['active']
   192.168.10.48 -- contrail-analytics-nodemgr : ['active']
   192.168.10.48 -- contrail-collector : ['active']
   192.168.10.48 -- contrail-query-engine : ['active']
   192.168.10.48 -- contrail-snmp-collector : ['active']
   192.168.10.48 -- contrail-topology : ['active']
   Status of analytics in node: 192.168.10.48
   
   Status of analyticsdb in node : 192.168.10.48
   
   192.168.10.48 -- contrail-database: : ['active']
   192.168.10.48 -- contrail-database-nodemgr : ['active']
   192.168.10.48 -- kafka : ['active']
   Status of analyticsdb in node: 192.168.10.48
   
   Status of controller in node : 192.168.10.48
   
   192.168.10.48 -- contrail-control : ['active']
   192.168.10.48 -- contrail-control-nodemgr : ['active']
   192.168.10.48 -- contrail-dns : ['active']
   192.168.10.48 -- contrail-named : ['active']
   192.168.10.48 -- contrail-api:0 : ['active']
   192.168.10.48 -- contrail-config-nodemgr : ['active']
   192.168.10.48 -- contrail-device-manager : ['active']
   192.168.10.48 -- contrail-schema : ['active']
   192.168.10.48 -- contrail-svc-monitor : ['active']
   192.168.10.48 -- contrail-database: : ['active']
   192.168.10.48 -- contrail-webui : ['active']
   192.168.10.48 -- contrail-webui-middleware : ['active']
   Status of controller in node: 192.168.10.48
   
   
   Contrail is Healthy
                   *********** HEALTH CHECK COMPLETED IN CENTRAL ENVIRONMENT ***********
   
                   *********** HEALTH CHECK COMPLETED IN REGIONAL ENVIRONMENT ***********
   
   =============== Health Check end time: 2019-03-05 13:42:45.780491   ==============
   
   exit
   # this VM is no longer needed and we reclaim its resources
   virsh shutdown installervm

(optional you can skip this check) the script in the installer VM didn’t check the canvm in previous versions so we had to do that manually like below.

.. code-block:: none

   virsh console canvm
   
   docker ps
   CONTAINER ID        IMAGE                                                                         COMMAND                  CREATED             STATUS              PORTS               NAMES
   86b3a6a4500d        192.168.10.48:5100/contrail_networking_docker-contrail-analytics:mainline     "/bin/sh -c /entry..."   3 hours ago         Up 20 minutes                           analytics
   18e8dfa9c1da        192.168.10.48:5100/contrail_networking_docker-contrail-analyticsdb:mainline   "/bin/sh -c /entry..."   3 hours ago         Up 29 minutes                           analyticsdb
   d01629ef1ba6        192.168.10.48:5100/contrail_networking_docker-contrail-controller:mainline    "/bin/sh -c /entry..."   3 hours ago         Up 22 minutes                           controller
   58b845311834        registry:2                                                                    "/entrypoint.sh /e..."   3 hours ago         Up 29 minutes                           registry
   
   analaytics_docker_id=`docker ps|grep analytics|head -1| awk '{ print $1 }'`
   controller_docker_id=`docker ps|grep controller|head -1| awk '{ print $1 }'`
   analayticsdb_docker_id=`docker ps|grep analyticsdb|head -1| awk '{ print $1 }'`
   
   # services have to be in active state on all containers
   docker exec $analaytics_docker_id contrail-status
   == Contrail Analytics ==
   contrail-alarm-gen            active
   contrail-analytics-api        active
   contrail-analytics-nodemgr    active
   contrail-collector            active
   contrail-query-engine         active
   contrail-snmp-collector       active
   contrail-topology             active
   
   docker exec $controller_docker_id contrail-status
   == Contrail Control ==
   contrail-control              active
   contrail-control-nodemgr      active
   contrail-dns                  active
   contrail-named                active
   
   == Contrail Config ==
   contrail-api:0                active
   contrail-config-nodemgr       active
   contrail-device-manager       active
   contrail-schema               active
   contrail-svc-monitor          active
   
   == Contrail Config Database==
   contrail-database:            active
   
   == Contrail Web UI ==
   contrail-webui                active
   contrail-webui-middleware     active
   
   docker exec $analayticsdb_docker_id contrail-status 
   == Contrail Database ==
   contrail-database:            active
   
   contrail-database-nodemgr     active
   kafka                         active

.. code-block:: none

   ##
   ## in case cassandra db is down
   ##
   root@canvm:~# docker exec $analayticsdb_docker_id contrail-status 
   == Contrail Database ==
   contrail-database:            inactive

   contrail-database-nodemgr     active
   kafka                         active

   root@canvm:~# docker exec -it $analayticsdb_docker_id bash
   root@canvm(analyticsdb):/# service contrail-database restart
   Cassandra has been down for at least 777600 seconds, not starting

   service cassandra status
   service cassandra start
   exit

Check the haproxy servers that all service are green (=heartbeats ok)

.. code-block:: none

   http://192.168.10.42:1936/
   http://192.168.10.47:1936/

Lab Switches, Routers and Devices
---------------------------------

Default/initial Lab setup
~~~~~~~~~~~~~~~~~~~~~~~~~

QFX5100-1 default
^^^^^^^^^^^^^^^^^

.. warning:: If you use the Lab Automation from chapter 8.15 below then you don’t need to execute this section if the Docker Containers we use for automation are not located in any way on the CSO-Host itself. If the Automation containers are on the CSO Host itself (directly io indirectly

.. note:: You need to provide a trunk interface towards the CSO-Server(s) with native VLAN 1 towards internal management. In our setup we use xe-0/0/48:0 AND xe-0/0/2. So you need to attach your Server to one of the two Ports. If you need you can modify this but with these two Ports having the same configuration all current lab sittuations should be covered automatically.

.. code-block:: none

   # we assume a naked/default config! If not -> zeroize the system
   cli
   request system zeroize
   
   cli
   edit
   set system host-name qfx5100-1
   set system root-authentication encrypted-password "$6$nCsDlN7N$qTG9G3zHHBcF8wwIkuH3VAwbwU4oV4kdhwv7CSyenNDA/qReSfZ2kuUPGcQWmnON4mfKAwjC323c8hkKr3iWh1"
   set system services ssh root-login allow
   set system services ssh client-alive-interval 120
   set system services netconf ssh
   set system name-server 192.168.10.10
   set system ntp boot-server 192.168.10.10
   set system ntp server 192.168.10.10
   set protocols lldp interface all
   delete protocols rstp
   set protocols rstp interface all
   delete interfaces em1 unit 0 family inet dhcp
   delete interfaces irb unit 0 family inet dhcp
   wildcard range delete interfaces ge-0/0/[0-47] 
   wildcard range delete interfaces xe-0/0/[0-53] 
   wildcard range set interfaces ge-0/0/[0-47] unit 0 family ethernet-switching storm-control default
   wildcard range set interfaces xe-0/0/[0-53] unit 0 family ethernet-switching storm-control default
   delete interfaces vme
   set interfaces irb unit 0 family inet address 192.168.10.20/24
   #
   # Prepare the TWO Ports where the CSO-Host might usually be attached
   #
   delete interfaces xe-0/0/48:0
   set interfaces xe-0/0/48:0 native-vlan-id 1
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching storm-control default
   delete interfaces xe-0/0/2
   set interfaces xe-0/0/2 native-vlan-id 1
   set interfaces xe-0/0/2 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 1
   set interfaces xe-0/0/2 unit 0 family ethernet-switching storm-control default
   #
   # lab-access over xe-0/0/0 to natvm ge-0/0/0.42 or eth1.42
   #
   set vlans lab-access vlan-id 42
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 42
   delete interfaces xe-0/0/0
   set interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 42
   delete interfaces xe-0/0/0
   set interfaces xe-0/0/0 unit 0 family ethernet-switching interface-mode access
   set interfaces xe-0/0/0 unit 0 family ethernet-switching vlan members 42
   commit and-quit

MX80-1 default (only for vCPE and uCPE needed)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

This is the initial config of the MX to get access to it and be able to configure it.

All other settings will be inherited via an apply group relevant to the test case.

.. code-block:: none

   cli
   edit
   delete
   set system host-name mx80-1
   set system name-server 192.168.10.10
   set system root-authentication encrypted-password "$1$i5PzQD4d$ovMu2gE5A6wtN9ZCrcxoN1"
   set system services ssh root-login allow
   set system services telnet
   set system services netconf ssh
   set system services netconf traceoptions file netconf-ops.log
   set system services netconf traceoptions file size 3m
   set system services netconf traceoptions file files 20
   set system services netconf traceoptions file world-readable
   set system services netconf traceoptions flag all
   set system syslog user * any emergency
   set system syslog file messages any notice
   set system syslog file messages authorization info
   set system syslog file interactive-commands interactive-commands any
   set interfaces fxp0 unit 0 family inet address 192.168.10.21/24
   commit

vCPE Lab setup
~~~~~~~~~~~~~~

QFX5100-1 vCPE
^^^^^^^^^^^^^^

.. code-block:: none

   set interfaces xe-0/0/14 description "vcpe vnf-mgnt on mx"
   
   set vlans vcpe-client3 vlan-id 1077
   
   set interfaces xe-0/0/15 description "vcpe client3"
   set interfaces xe-0/0/15 unit 0 family ethernet-switching vlan members 1077
   
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1077
   
   set vlans vcpe-nat vlan-id 74
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 74
   
   set interfaces xe-0/0/17 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/17 unit 0 family ethernet-switching vlan members 74

MX80-1 vCPE
^^^^^^^^^^^

.. code-block:: none

   set groups vcpe interfaces lo0 unit 0 family inet address 169.254.169.254/32
   set groups vcpe interfaces ge-1/1/1 description "Control+Data for Contrail Fabric Dell 610 em2"
   set groups vcpe interfaces ge-1/1/1 unit 0 family inet address 192.168.68.1/24
   set groups vcpe chassis fpc 0 pic 0 tunnel-services
   set groups vcpe chassis fpc 1 pic 0 tunnel-services
   set groups vcpe chassis fpc 1 pic 1 tunnel-services
   set groups vcpe chassis fpc 1 pic 2 tunnel-services
   set groups vcpe chassis fpc 1 pic 3 tunnel-services

.. code-block:: none

   set groups vcpe routing-options router-id 169.254.169.254
   set groups vcpe routing-options route-distinguisher-id 169.254.169.254
   set groups vcpe routing-options autonomous-system 64512
   set groups vcpe routing-options dynamic-tunnels contrail source-address 169.254.169.254
   set groups vcpe routing-options dynamic-tunnels contrail gre
   set groups vcpe routing-options dynamic-tunnels contrail destination-networks 192.168.68.0/24
   set groups vcpe protocols bgp group contrail type internal
   set groups vcpe protocols bgp group contrail multihop
   set groups vcpe protocols bgp group contrail local-address 169.254.169.254
   set groups vcpe protocols bgp group contrail hold-time 90
   set groups vcpe protocols bgp group contrail keep all
   set groups vcpe protocols bgp group contrail family inet-vpn unicast
   set groups vcpe protocols bgp group contrail family inet6-vpn unicast
   set groups vcpe protocols bgp group contrail family evpn signaling
   set groups vcpe protocols bgp group contrail family route-target
   set groups vcpe protocols bgp group contrail neighbor 192.168.68.15 family inet-vpn unicast
   set groups vcpe protocols bgp group contrail neighbor 192.168.68.15 family inet6-vpn unicast
   set groups vcpe protocols bgp group contrail neighbor 192.168.68.15 family evpn signaling
   set groups vcpe protocols bgp group contrail neighbor 192.168.68.15 family route-target
   set groups vcpe protocols bgp group contrail neighbor 192.168.68.15 peer-as 64512
   set groups vcpe protocols bgp group contrail_external type external
   set groups vcpe protocols bgp group contrail_external multihop
   set groups vcpe protocols bgp group contrail_external local-address 169.254.169.254
   set groups vcpe protocols bgp group contrail_external hold-time 90
   set groups vcpe protocols bgp group contrail_external keep all
   set groups vcpe protocols bgp group contrail_external family inet-vpn unicast
   set groups vcpe protocols bgp group contrail_external family inet6-vpn unicast
   set groups vcpe protocols bgp group contrail_external family evpn signaling
   set groups vcpe protocols bgp group contrail_external family route-target

.. code-block:: none

   delete groups vcpe interfaces ge-1/0/2
   set groups vcpe interfaces ge-1/0/2 description "Gateway to CSO lan (towards regionalmsvm)"
   set groups vcpe interfaces ge-1/0/2 unit 0 family inet address 192.168.10.70/24
   
   set groups vcpe routing-instances vnf-mgnt instance-type vrf
   set groups vcpe routing-instances vnf-mgnt interface ge-1/0/2.0
   set groups vcpe routing-instances vnf-mgnt vrf-target target:64512:10000
   set groups vcpe routing-instances vnf-mgnt route-distinguisher 169.254.169.254:10000
   set groups vcpe routing-instances vnf-mgnt vrf-table-label

.. code-block:: none

   # delete groups vcpe interfaces ge-1/1/4
   set groups vcpe interfaces ge-1/1/4 flexible-vlan-tagging
   set groups vcpe interfaces ge-1/1/4 unit 74 vlan-id 74
   set groups vcpe interfaces ge-1/1/4 unit 74 family inet address 192.168.74.254/24
   
   delete groups vcpe routing-instances public-vcpe
   set groups vcpe routing-instances public-vcpe instance-type vrf
   set groups vcpe routing-instances public-vcpe interface ge-1/1/4.74
   set groups vcpe routing-instances public-vcpe route-distinguisher 169.254.169.254:10001
   set groups vcpe routing-instances public-vcpe vrf-target target:64512:10001
   set groups vcpe routing-instances public-vcpe vrf-table-label
   set groups vcpe routing-instances public-vcpe routing-options static route 0.0.0.0/0 next-hop 192.168.74.1

.. code-block:: none

   delete groups vcpe interfaces ge-1/1/2
   set groups vcpe interfaces ge-1/1/2 description "from desktop3 client"
   set groups vcpe interfaces ge-1/1/2 unit 0 family inet address 10.77.77.1/24
   
   delete groups vcpe routing-instances site-vcpe
   set groups vcpe routing-instances site-vcpe instance-type vrf
   set groups vcpe routing-instances site-vcpe interface ge-1/1/2.0
   set groups vcpe routing-instances site-vcpe route-distinguisher 10.77.77.1:10002
   set groups vcpe routing-instances site-vcpe vrf-target target:64513:10002
   set groups vcpe routing-instances site-vcpe vrf-table-label

.. code-block:: none

   set apply-groups vcpe
   commit and-quit

uCPE Lab setup
~~~~~~~~~~~~~~

QFX5100-1 uCPE
^^^^^^^^^^^^^^

.. code-block:: none

   set vlans ucpe-client1 vlan-id 1099
   
   set interfaces xe-0/0/18 description "ucpe client1"
   set interfaces xe-0/0/18 unit 0 family ethernet-switching vlan members 1099
   
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1099
   
   
   set vlans ucpe-data-nat vlan-id 75
   set vlans ucpe-oam-nat vlan-id 76
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 75
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 76
   
   set interfaces xe-0/0/17 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/17 unit 0 family ethernet-switching vlan members 75
   set interfaces xe-0/0/17 unit 0 family ethernet-switching vlan members 76
   
   
   set vlans ucpe-oam vlan-id 65
   set vlans ucpe-data vlan-id 66
   set interfaces xe-0/0/20 description "ucpe oam and data from nfx"
   set interfaces xe-0/0/20 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/20 unit 0 family ethernet-switching vlan members 65
   set interfaces xe-0/0/20 unit 0 family ethernet-switching vlan members 66
   
   set interfaces xe-0/0/11 description "ucpe oam and data to mx"
   set interfaces xe-0/0/11 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/11 unit 0 family ethernet-switching vlan members 65
   set interfaces xe-0/0/11 unit 0 family ethernet-switching vlan members 66
   
   
   set vlans ucpe-internet vlan-id 67
   set interfaces xe-0/0/21 description "ucpe internet from nfx"
   set interfaces xe-0/0/21 unit 0 family ethernet-switching vlan members 67
   
   set interfaces xe-0/0/12 description "ucpe internet to mx"
   set interfaces xe-0/0/12 unit 0 family ethernet-switching vlan members 67
   
   
   set vlans ucpe-oam-cso vlan-id 64
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 64
   
   set interfaces xe-0/0/13 description "second CSO OAM for ucpe to nfx"
   set interfaces xe-0/0/13 unit 0 family ethernet-switching vlan members 64
   
   # NFX and QFX talk to each other spanning-tree
   # we need to remove rstp from the 3 interfaces we need in this demo
   delete protocols rstp interface xe-0/0/18
   delete protocols rstp interface xe-0/0/20
   delete protocols rstp interface xe-0/0/21
   
   # also make sure the other interfaces towards NFX unused in this demo are disabled
   delete interfaces xe-0/0/18 disable
   delete interfaces xe-0/0/20 disable
   delete interfaces xe-0/0/21 disable
   set interfaces xe-0/0/19 disable
   set interfaces xe-0/0/22 disable
   set interfaces xe-0/0/23 disable
   set interfaces xe-0/0/24 disable
   set interfaces xe-0/0/25 disable

MX80-1 uCPE
^^^^^^^^^^^

Add a subscriber license to enable DHCP Server on the MX

.. code-block:: none

   show system license
   License usage:
                                    Licenses     Licenses    Licenses    Expiry
     Feature name                       used    installed      needed
     scale-subscriber                      0           10           0    permanent
     scale-l2tp                            0         1000           0    permanent
     scale-mobile-ip                       0         1000           0    permanent
   
   Licenses installed: none
   
   request system license add terminal
   [Type ^D at a new line to end input,
    enter blank line between each license key]
   E000185416 aeaqeb qfdyps aijca4 udcgiw pa7tqn uc5fwn ns3v7t 7hzgbm lrxxec
   vkoqz4 tj6yy4 prms7p xifvfv 35auxq 7dq
   E000185416: successfully added
   add license complete (no errors)

   show system license
   License usage:
                                    Licenses     Licenses    Licenses    Expiry
     Feature name                       used    installed      needed
     subscriber-accounting                 0            1           0    permanent
     subscriber-authentication             0            1           0    permanent
     subscriber-address-assignment         0            1           0    permanent
     subscriber-vlan                       0            1           0    permanent
     subscriber-ip                         0            1           0    permanent
     scale-subscriber                      0           10           0    permanent
     scale-l2tp                            0         1000           0    permanent
     scale-mobile-ip                       0         1000           0    permanent
   
   Licenses installed:
     License identifier: E000185416
     License version: 2
     Features:
       subscriber-accounting - Per Subscriber Radius Accounting
         permanent
       subscriber-authentication - Per Subscriber Radius Authentication
         permanent
       subscriber-address-assignment - Radius/SRC Address Pool Assignment
         permanent
       subscriber-vlan  - Dynamic Auto-sensed Vlan
         permanent
       subscriber-ip    - Dynamic and Static IP
         permanent
   

.. code-block:: none

   delete groups ucpe interfaces ge-1/0/1
   set groups ucpe interfaces ge-1/0/1 description "Out-off-band management for ucpe"
   set groups ucpe interfaces ge-1/0/1 unit 0 family inet address 192.168.64.1/24
   
   delete groups ucpe interface ge-1/0/0
   set groups ucpe interfaces ge-1/0/0 description "WAN0 for NFX250 (MPLS)"
   set groups ucpe interfaces ge-1/0/0 flexible-vlan-tagging
   set groups ucpe interfaces ge-1/0/0 unit 65 vlan-id 65
   set groups ucpe interfaces ge-1/0/0 unit 65 family inet address 192.168.65.1/24
   set groups ucpe interfaces ge-1/0/0 unit 66 vlan-id 66
   set groups ucpe interfaces ge-1/0/0 unit 66 family inet address 192.168.66.1/24
   
   
   set groups ucpe policy-options policy-statement POL-DEFAULT term default from route-filter 0.0.0.0/0 exact
   set groups ucpe policy-options policy-statement POL-DEFAULT term default then accept
   set groups ucpe policy-options policy-statement POL-DEFAULT then reject
   
   
   delete groups ucpe routing-instances VRFWAN 
   set groups ucpe routing-instances VRFWAN instance-type vrf
   set groups ucpe routing-instances VRFWAN system services dhcp-local-server group ucpe-wan1-pool interface ge-1/1/0.0
   set groups ucpe routing-instances VRFWAN interface ge-1/0/0.66
   set groups ucpe routing-instances VRFWAN routing-options router-id 192.168.66.1
   set groups ucpe routing-instances VRFWAN routing-options autonomous-system 65410
   set groups ucpe routing-instances VRFWAN route-distinguisher 192.168.66.1:65410
   set groups ucpe routing-instances VRFWAN vrf-target target:65410:10010
   set groups ucpe routing-instances VRFWAN vrf-table-label
   set groups ucpe routing-instances VRFWAN protocols bgp group nfx-gwr-bgp-grp type external
   set groups ucpe routing-instances VRFWAN protocols bgp group nfx-gwr-bgp-grp family inet unicast
   set groups ucpe routing-instances VRFWAN protocols bgp group nfx-gwr-bgp-grp peer-as 65500
   set groups ucpe routing-instances VRFWAN protocols bgp group nfx-gwr-bgp-grp neighbor 192.168.66.2
   set groups ucpe routing-instances VRFWAN routing-options static route 0.0.0.0/0 next-hop 192.168.75.1
   set groups ucpe routing-instances VRFWAN protocols bgp export POL-DEFAULT
   
   
   set groups ucpe interfaces ge-1/1/4 flexible-vlan-tagging
   set groups ucpe interfaces ge-1/1/4 unit 75 vlan-id 75
   set groups ucpe interfaces ge-1/1/4 unit 75 family inet address 192.168.75.254/24
   set groups ucpe interfaces ge-1/1/4 unit 76 vlan-id 76
   set groups ucpe interfaces ge-1/1/4 unit 76 family inet address 192.168.76.254/24
   
   set groups ucpe routing-instances VRFWAN interface ge-1/1/4.75
   
   
   set groups ucpe routing-instances OAM-to-CSO instance-type virtual-router
   set groups ucpe routing-instances OAM-to-CSO interface ge-1/0/0.65
   set groups ucpe routing-instances OAM-to-CSO interface ge-1/0/1.0
   set groups ucpe routing-instances OAM-to-CSO interface ge-1/1/4.76
   set groups ucpe routing-instances OAM-to-CSO routing-options static route 0.0.0.0/0 next-hop 192.168.76.1
   
   
   delete groups ucpe interfaces ge-1/1/0
   set groups ucpe interfaces ge-1/1/0 description "WAN1 for NFX250 (Internet)"
   set groups ucpe interfaces ge-1/1/0 unit 0 family inet address 192.168.67.1/24 primary
   set groups ucpe interfaces ge-1/1/0 unit 0 family inet address 192.168.67.67/24
   
   set groups ucpe system services dhcp-local-server group ucpe-wan1-pool interface ge-1/1/0.0
   set groups ucpe access address-assignment pool ucpe-wan1-pool family inet network 192.168.67.0/24
   set groups ucpe access address-assignment pool ucpe-wan1-pool family inet range valid low 192.168.67.5
   set groups ucpe access address-assignment pool ucpe-wan1-pool family inet range valid high 192.168.67.250
   set groups ucpe access address-assignment pool ucpe-wan1-pool family inet dhcp-attributes domain-name example.net
   set groups ucpe access address-assignment pool ucpe-wan1-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups ucpe access address-assignment pool ucpe-wan1-pool family inet dhcp-attributes router 192.168.67.1

.. code-block:: none

   set apply-groups ucpe
   commit and-quit

.. code-block:: none

   root@mx80-1> ping 192.168.64.45 routing-instance OAM-to-CSO
   PING 192.168.64.45 (192.168.64.45): 56 data bytes
   64 bytes from 192.168.64.45: icmp_seq=0 ttl=64 time=9.499 ms
   64 bytes from 192.168.64.45: icmp_seq=1 ttl=64 time=10.647 ms
   ^C
   --- 192.168.64.45 ping statistics ---
   2 packets transmitted, 2 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 9.499/10.073/10.647/0.574 ms

   root@mx80-1> ping 8.8.8.8 routing-instance OAM-to-CSO
   PING 8.8.8.8 (8.8.8.8): 56 data bytes
   64 bytes from 8.8.8.8: icmp_seq=0 ttl=56 time=2.111 ms
   64 bytes from 8.8.8.8: icmp_seq=1 ttl=56 time=2.492 ms
   64 bytes from 8.8.8.8: icmp_seq=2 ttl=56 time=1.970 ms
   ^C
   --- 8.8.8.8 ping statistics ---
   3 packets transmitted, 3 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 1.970/2.191/2.492/0.220 ms

   root@mx80-1> ping 192.168.10.10 routing-instance OAM-to-CSO
   PING 192.168.10.10 (192.168.10.10): 56 data bytes
   64 bytes from 192.168.10.10: icmp_seq=0 ttl=63 time=1.012 ms
   64 bytes from 192.168.10.10: icmp_seq=1 ttl=63 time=0.856 ms
   64 bytes from 192.168.10.10: icmp_seq=2 ttl=63 time=0.731 ms
   ^C
   --- 192.168.10.10 ping statistics ---
   3 packets transmitted, 3 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 0.731/0.866/1.012/0.115 ms

   root@mx80-1> ping 8.8.8.8 routing-instance VRFWAN
   PING 8.8.8.8 (8.8.8.8): 56 data bytes
   64 bytes from 8.8.8.8: icmp_seq=0 ttl=56 time=2.050 ms
   64 bytes from 8.8.8.8: icmp_seq=1 ttl=56 time=2.041 ms
   64 bytes from 8.8.8.8: icmp_seq=2 ttl=56 time=2.043 ms
   ^C
   --- 8.8.8.8 ping statistics ---
   3 packets transmitted, 3 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 2.041/2.045/2.050/0.004 ms

   root@mx80-1> ping 192.168.10.10 routing-instance VRFWAN
   PING 192.168.10.10 (192.168.10.10): 56 data bytes
   64 bytes from 192.168.10.10: icmp_seq=0 ttl=63 time=0.770 ms
   64 bytes from 192.168.10.10: icmp_seq=1 ttl=63 time=0.829 ms
   ^C
   --- 192.168.10.10 ping statistics ---
   2 packets transmitted, 2 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 0.770/0.799/0.829/0.029 ms

.. code-block:: none

   ifconfig
   bme1      Link encap:Ethernet  HWaddr 52:54:00:e9:89:58
             inet addr:192.168.1.254  Bcast:192.168.1.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fee9:8958/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:32832 errors:0 dropped:0 overruns:0 frame:0
             TX packets:12432 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:3457207 (3.4 MB)  TX bytes:838682 (838.6 KB)
   
   bme2      Link encap:Ethernet  HWaddr 52:54:00:f7:66:7a
             inet addr:128.0.0.254  Bcast:128.0.255.255  Mask:255.255.0.0
             inet6 addr: fe80::5054:ff:fef7:667a/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:19 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:1378 (1.3 KB)  TX bytes:648 (648.0 B)
   
   jmgmt0    Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cb
             inet addr:192.168.10.24  Bcast:192.168.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:2659509 errors:0 dropped:148 overruns:0 frame:0
             TX packets:3765 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:881532164 (881.5 MB)  TX bytes:472086 (472.0 KB)
   
   jsxe0     Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:1491 errors:0 dropped:0 overruns:0 frame:0
             TX packets:239 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:97443 (97.4 KB)  TX bytes:69990 (69.9 KB)
   
   jsxe0.0   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:192.168.67.5  Bcast:192.168.67.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:186 errors:0 dropped:0 overruns:0 frame:0
             TX packets:21 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:9635 (9.6 KB)  TX bytes:2626 (2.6 KB)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:1771 errors:0 dropped:0 overruns:0 frame:0
             TX packets:1771 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:135269 (135.2 KB)  TX bytes:135269 (135.2 KB)
   
   phc       Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cd
             inet addr:10.10.10.1  Bcast:10.10.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:1490 errors:0 dropped:0 overruns:0 frame:0
             TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:91533 (91.5 KB)  TX bytes:0 (0.0 B)
   
   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.67.1    0.0.0.0         UG    0      0        0 jsxe0.0
   10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 phc
   128.0.0.0       0.0.0.0         255.255.0.0     U     0      0        0 bme2
   192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 bme1
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 jmgmt0
   192.168.67.0    0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.0

   ping 8.8.8.8
   PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
   64 bytes from 8.8.8.8: icmp_seq=1 ttl=55 time=22.9 ms
   64 bytes from 8.8.8.8: icmp_seq=2 ttl=55 time=1.63 ms
   64 bytes from 8.8.8.8: icmp_seq=3 ttl=55 time=1.55 ms
   64 bytes from 8.8.8.8: icmp_seq=4 ttl=55 time=1.58 ms
   64 bytes from 8.8.8.8: icmp_seq=5 ttl=55 time=1.68 ms

NFX250-1 uCPE
^^^^^^^^^^^^^

Here you NEED a Terminal Server to access the device via console

.. code-block:: none

   cli
   request system zeroize
   yes
   
   # use the minicom over the ssh 192.168.10.2/172.30.200.152 (root/Lab58fgr#-1)      
   
   cli
   show configuration version
   # make sure you have upgraded the firmware to the right version
   # for CSO 3.3 it is required to use  15.1X53-D473
   edit
   set system host-name nfx250-1
   # review the device template for updated huge-page numbers to assign
   # In current CSO 3.3.1 the NFX250-S1 has 9 and the NFX250-S2 has 13
   set system memory hugepages page-size 1024 page-count 13
   set system root-authentication plain-text-password
   juniper123
   juniper123
   delete interfaces jmgmt0 unit 0
   # here this OAM setup is NEEDED as you else can’t use the building webbrowser 
   set interfaces jmgmt0 unit 0 family inet address 192.168.10.24/24
   delete system phone-home server https://redirect.juniper.net
   set system phone-home server https://centralmsvm.example.net:444
   set system name-server 192.168.10.10
   commit and-quit
   exit
   
   cat /config/device_serial_id
   DD2316AF0103

   #
   # use the server cert from the Post CSO install procedure
   # and append it to the ca file to be recognized
   #
   cp /var/phone-home/phcd-ca.crt /var/phone-home/phcd-ca.crt.orig
   
   cat <<EOF >>/var/phone-home/phcd-ca.crt
   -----BEGIN CERTIFICATE-----
   MIIDrjCCApYCCQDZ8BNWtFex/DANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMC
   VVMxCzAJBgNVBAgMAkNBMRkwFwYDVQQKDBBKdW5pcGVyIE5ldHdvcmtzMRIwEAYD
   VQQHDAlTdW5ueXZhbGUxIDAeBgNVBAMMF2NlbnRyYWxtc3ZtLmV4YW1wbGUubmV0
   MQwwCgYDVQQLDANDU1AxHTAbBgkqhkiG9w0BCQEWDnRlc3RAZW1haWwubmV0MB4X
   DTE4MDcxMjEzMDYwNFoXDTIxMDQwNjEzMDYwNFowgZgxCzAJBgNVBAYTAlVTMQsw
   CQYDVQQIDAJDQTEZMBcGA1UECgwQSnVuaXBlciBOZXR3b3JrczESMBAGA1UEBwwJ
   U3Vubnl2YWxlMSAwHgYDVQQDDBdjZW50cmFsbXN2bS5leGFtcGxlLm5ldDEMMAoG
   A1UECwwDQ1NQMR0wGwYJKoZIhvcNAQkBFg50ZXN0QGVtYWlsLm5ldDCCASIwDQYJ
   KoZIhvcNAQEBBQADggEPADCCAQoCggEBAKtiYIRnR2Yq0eE/aqGTu+7MDFjxpjWX
   3CNf+yiNpG+dxtCcEXNrq1//UiBdPJlcKXq5mNOY359O0ueQrFhwPqaRwXoC04lR
   /W+2wLwse0ePeweQ0hd6GTQWAOjRfyQew+DZp31W10YDRSc8qzZTkgnYWqBJVFt/
   MnKgWNj8R50l0DK+nPhzDgo3iHVQh1M4x2muI238GSOJOsZNyOf0bUfj8Yti89AN
   wLIuQvbxaxP1qpbwRNK8ciA4DQr7RczNBVT4rsqw4GM3Hqtic7umM/EOQ1RCTjiU
   uGd56FkIqkkYGQ8nMWh7Uxfo1d+G8wjFXBUE6pxsMicU9DmZEKDix9ECAwEAATAN
   BgkqhkiG9w0BAQsFAAOCAQEAICz4G05p96lQToWDLf86XK24m8YtTAMZlckcErCx
   h2nQEDbiltSwspiaeyyenoAnK5KmGR6ijZDFuNIr5GIjbjx9RgrOLBacNDBous8Q
   C77w9BmCZB0TSuGMFeeV07A0lSEqoc2wX89Pic7rchb3LorJKE+ZEB0U2fppXp2o
   y8LnqX6ZgYH9QD5FBbVyTK0sw1aqPP/pRsv6Pa9mfvKivNPzfERJiFJkNdqvIj39
   iwUuwJUF3sN6cdKMj8s1irYnNhsB62M2pNFOCtvzIe+xLhbMlNEY1Qoiyk+KJOvZ
   fzX+nt1TrRi7zq+yGFSkOQ4kwAiWxSPUCZOcGLTjUd1G/Q==
   -----END CERTIFICATE-----
   EOF

   #cat /var/phone-home/phcd-ca.crt

   cli
   request system reboot
   yes

|image34|

SD-WAN basic Lab setup
~~~~~~~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. This will **SAVE** you huge amount of **TIME** and will guarantee that the Devices and Underlay Switch Configuration are in **PROPER STATE**. It will **AVOID** any **MISCONFIGURATION** you do via manual cut&paste.

This is where you have to click to get the WHOLE LAB reseted and to an initial state without you getting any Hands dirty on that.

|image35|

NAT GW sd-wan basic
^^^^^^^^^^^^^^^^^^^

.. note:: These changes are already applied in chapter 3.2.5 above and you don’t need to do this again. We just show it here to note what is important for this lab to change.

.. code-block:: none

   cp /etc/network/interfaces.default /etc/network/interfaces
   
   cat <<EOF >>/etc/network/interfaces
   
       auto eth3.70
       iface eth3.70 inet static
       vlan_raw_device eth3
       address 192.168.70.1
       netmask 255.255.255.0
       up route add -net 192.168.128.0 netmask 255.255.128.0 gw 192.168.70.254
       up route add -net 10.66.66.0 netmask 255.255.255.0 gw 192.168.70.254
       up route add -net 10.88.88.0 netmask 255.255.255.0 gw 192.168.70.254
       up route add -net 172.16.0.0 netmask 255.240.0.0 gw 192.168.70.254
   EOF
   
   reboot
   
   
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         172.30.200.1    0.0.0.0         UG    0      0        0 eth1
   10.66.66.0      192.168.70.254  255.255.255.0   UG    0      0        0 eth3.70
   10.77.77.0      192.168.74.254  255.255.255.0   UG    0      0        0 eth3.74
   10.88.88.0      192.168.70.254  255.255.255.0   UG    0      0        0 eth3.70
   10.99.99.0      192.168.75.254  255.255.255.0   UG    0      0        0 eth3.75
   172.30.200.0    0.0.0.0         255.255.255.0   U     0      0        0 eth1
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 eth2
   192.168.65.0    192.168.75.254  255.255.255.0   UG    0      0        0 eth3.75
   192.168.66.0    192.168.75.254  255.255.255.0   UG    0      0        0 eth3.75
   192.168.67.0    192.168.75.254  255.255.255.0   UG    0      0        0 eth3.75
   192.168.68.0    192.168.10.15   255.255.255.0   UG    0      0        0 eth2
   192.168.69.0    192.168.10.70   255.255.255.0   UG    0      0        0 eth2
   192.168.70.0    0.0.0.0         255.255.255.0   U     0      0        0 eth3.70
   192.168.74.0    0.0.0.0         255.255.255.0   U     0      0        0 eth3.74
   192.168.75.0    0.0.0.0         255.255.255.0   U     0      0        0 eth3.75
   192.168.76.0    0.0.0.0         255.255.255.0   U     0      0        0 eth3.76
   192.168.128.0   192.168.70.254  255.255.128.0   UG    0      0        0 eth3.70

QFX5100-1 SD-WAN basic
^^^^^^^^^^^^^^^^^^^^^^

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. This will **SAVE** you huge amount of **TIME** and will guarantee that the Underlay Switch configuration is in **PROPER STATE**. It will **AVOID** any **MISCONFIGURATION** you do via manual cut&paste.

If you want to bring this device into this state you should click here:

|image36|

In the remaining section we provide you the information what the lab automation has done for you. So you can ignore the rest of the section if you use the automation.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

Please check if your QFX switch has xe-*/*/\* interfaces or ge-*/*/\* (due to SFP’s). If the latter is the case do a search for “xe-“ and replace it with “ge-“ before you apply this config (and then change back the interface where the CSO server is attached to 10G).

.. note:: We KNOW that applying this config via cut&paste may display some false positive error in complaining about item we delete that are not present. IGNORE those messages. We’re just doing this to make sure whatever state you are in the result is commit-able.

.. code-block:: none

   
   set apply-groups sdwan-basic
   
   delete interfaces xe-0/0/22
   delete interfaces xe-0/0/32
   delete protocols rstp interface xe-0/0/22
   delete protocols rstp interface xe-0/0/32
   set groups sdwan-basic interfaces xe-0/0/22 unit 0 family inet address 192.168.130.1/24
   set groups sdwan-basic interfaces xe-0/0/32 unit 0 family inet address 192.168.170.1/24
   set groups sdwan-basic routing-instances spoke-wan0 instance-type virtual-router
   set groups sdwan-basic routing-instances spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-basic routing-instances spoke-wan0 interface xe-0/0/32.0
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/32.0
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet network 192.168.130.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range low 192.168.130.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range high 192.168.130.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes router 192.168.130.1
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet network 192.168.170.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet range spoke-wan0-srx-pool-range low 192.168.170.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet range spoke-wan0-srx-pool-range high 192.168.170.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes router 192.168.170.1
   set groups sdwan-basic routing-instances spoke-wan0 routing-options static route 0.0.0.0/0 next-hop 192.168.131.254
   
   set groups sdwan-basic interfaces irb unit 131 family inet address 192.168.131.1/24
   set groups sdwan-basic vlans vlan131 vlan-id 131
   set groups sdwan-basic vlans vlan131 l3-interface irb.131
   set groups sdwan-basic routing-instances spoke-wan0 interface irb.131
   
   delete interfaces xe-0/0/23
   delete interfaces xe-0/0/33
   delete protocols rstp interface xe-0/0/23
   delete protocols rstp interface xe-0/0/33
   set groups sdwan-basic interfaces xe-0/0/23 unit 0 family inet address 192.168.133.1/24
   set groups sdwan-basic interfaces xe-0/0/33 unit 0 family inet address 192.168.173.1/24
   set groups sdwan-basic routing-instances spoke-wan1 instance-type virtual-router
   set groups sdwan-basic routing-instances spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-basic routing-instances spoke-wan1 interface xe-0/0/33.0
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/33.0
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet network 192.168.133.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range low 192.168.133.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range high 192.168.133.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes router 192.168.133.1
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet network 192.168.173.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet range spoke-wan1-srx-pool-range low 192.168.173.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet range spoke-wan1-srx-pool-range high 192.168.173.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes router 192.168.173.1
   set groups sdwan-basic routing-instances spoke-wan1 routing-options static route 0.0.0.0/0 next-hop 192.168.134.254
   
   set groups sdwan-basic interfaces irb unit 134 family inet address 192.168.134.1/24
   set groups sdwan-basic vlans vlan134 vlan-id 134
   set groups sdwan-basic vlans vlan134 l3-interface irb.134
   set groups sdwan-basic routing-instances spoke-wan1 interface irb.134
   
   
   delete interfaces xe-0/0/37
   delete protocols rstp interface xe-0/0/37
   set groups sdwan-basic interfaces xe-0/0/37 unit 0 family inet address 192.168.190.1/24
   set groups sdwan-basic routing-instances hub-wan0 instance-type virtual-router
   set groups sdwan-basic routing-instances hub-wan0 interface xe-0/0/37.0
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.130.0/24 next-hop 192.168.132.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.170.0/24 next-hop 192.168.132.254
   
   set groups sdwan-basic interfaces irb unit 132 family inet address 192.168.132.1/24
   set groups sdwan-basic vlans vlan132 vlan-id 132
   set groups sdwan-basic vlans vlan132 l3-interface irb.132
   set groups sdwan-basic routing-instances hub-wan0 interface irb.132
   
   
   delete interfaces xe-0/0/38
   delete protocols rstp interface xe-0/0/38
   set groups sdwan-basic interfaces xe-0/0/38 unit 0 family inet address 192.168.191.1/24
   set groups sdwan-basic routing-instances hub-wan1 instance-type virtual-router
   set groups sdwan-basic routing-instances hub-wan1 interface xe-0/0/38.0
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.133.0/24 next-hop 192.168.135.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.173.0/24 next-hop 192.168.135.254
   # route for the Spoke LAN’s to go to Internet
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.88.88.0/24 next-hop 192.168.191.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.191.254
   
   
   set groups sdwan-basic interfaces irb unit 135 family inet address 192.168.135.1/24
   set groups sdwan-basic vlans vlan135 vlan-id 135
   set groups sdwan-basic vlans vlan135 l3-interface irb.135
   set groups sdwan-basic routing-instances hub-wan1 interface irb.135
   
   
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 131
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 132
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 134
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 135
   
   commit
   
   # setup and connect the LAN interfaces of the two spoke devices
   
   set groups sdwan-basic vlans desktop2 vlan-id 1088
   set groups sdwan-basic vlans desktop4 vlan-id 1066
   
   delete interface xe-0/0/36
   set groups sdwan-basic interfaces xe-0/0/36 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-basic interfaces xe-0/0/36 unit 0 family ethernet-switching vlan members 1088
   
   delete interface xe-0/0/18
   set groups sdwan-basic interfaces xe-0/0/18 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-basic interfaces xe-0/0/18 unit 0 family ethernet-switching vlan members 1066
   
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1088
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1066
   
   commit
   
   
   # also make sure the other interfaces towards NFX unused in this demo are disabled
   set interfaces xe-0/0/19 disable
   set interfaces xe-0/0/20 disable
   set interfaces xe-0/0/21 disable
   delete interfaces xe-0/0/22 disable
   delete interfaces xe-0/0/23 disable
   set interfaces xe-0/0/24 disable
   set interfaces xe-0/0/25 disable
   
   # also make sure the other interfaces towards srx345 unused in this demo are disabled
   delete interfaces xe-0/0/32 disable
   delete interfaces xe-0/0/33 disable
   delete interfaces xe-0/0/36 disable
   set interfaces xe-0/0/34 disable
   set interfaces xe-0/0/35 disable
   
   # also make sure the other interfaces towards srx1500-1 unused in this demo are disabled
   # you only need ge-0/0/0 and ge-0/0/1 in this demo
   delete interfaces xe-0/0/37 disable
   delete interfaces xe-0/0/38 disable
   set interfaces xe-0/0/39 disable
   set interfaces xe-0/0/40 disable
   set interfaces xe-0/0/41 disable
   
   #
   # Ribgroups and VRs and interfaces for Internet Access
   #
   set groups sdwan-basic interfaces irb unit 70 family inet address 192.168.70.254/24
   set groups sdwan-basic vlans natuplink vlan-id 70
   set groups sdwan-basic vlans natuplink l3-interface irb.70
   
   set groups sdwan-basic routing-instances internetaccess instance-type virtual-router
   set groups sdwan-basic routing-instances internetaccess interface irb.70
   set groups sdwan-basic routing-instances internetaccess routing-options static route 0.0.0.0/0 next-hop 192.168.70.1
   
   delete groups sdwan-basic policy-options policy-statement directandstatic1
   set groups sdwan-basic policy-options policy-statement directandstatic1 term a from instance internetaccess
   set groups sdwan-basic policy-options policy-statement directandstatic1 term a then accept
   set groups sdwan-basic policy-options policy-statement directandstatic1 term b then reject
   set groups sdwan-basic routing-instances hub-wan0 routing-options instance-import directandstatic1
   set groups sdwan-basic routing-instances hub-wan1 routing-options instance-import directandstatic1
   
   delete groups sdwan-basic policy-options policy-statement directandstatic2
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c from instance hub-wan0
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d from instance hub-wan1
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term e then reject
   set groups sdwan-basic routing-instances internetaccess routing-options instance-import directandstatic2
   
   
   # Some other ports to open
   delete interfaces xe-0/0/16 disable
   
   # hub1 to NAT gw uplink
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 70
   
   commit
   
   #
   # Changes for CSO >=4.0.0
   #
   
   delete interfaces xe-0/0/41
   delete protocols rstp interface xe-0/0/41
   set groups sdwan-basic interfaces xe-0/0/41 unit 0 family inet address 192.168.194.1/24
   
   delete groups sdwan-basic routing-instances secure-oam
   set groups sdwan-basic routing-instances secure-oam instance-type virtual-router
   set groups sdwan-basic routing-instances secure-oam interface xe-0/0/41.0
   set groups sdwan-basic routing-instances secure-oam routing-options static route 192.168.10.0/24 next-hop 192.168.70.1
   set groups sdwan-basic routing-instances secure-oam routing-options autonomous-system 65000
   set groups sdwan-basic routing-instances secure-oam routing-options instance-import directandstatic1
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp type external
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp export export-cso
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp peer-as 64512
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.194.254
   set groups sdwan-basic policy-options policy-statement export-cso term cso-net from route-filter 192.168.10.0/24 exact
   set groups sdwan-basic policy-options policy-statement export-cso term cso-net then accept
   
   delete groups sdwan-basic policy-options policy-statement directandstatic2
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c from instance hub-wan0
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d from instance hub-wan1
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term e from instance secure-oam
   set groups sdwan-basic policy-options policy-statement directandstatic2 term e then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term f then reject
   
   commit and-quit

MX80-1 sd-wan basic (not used in this scenario)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

We are not using the MX80 in this scenario to make it simple to be implemented.

.. note:: With CSO >= 4.0 and more then ONE HUB you need BGP-Peering for the OAM Loop-back IP’s of the Devices. Currently we enable this on the QFX5100 switch of the Lab but in bigger / productiongrade installations you may have to use a real router.

SRX1500-1 sd-wan basic
^^^^^^^^^^^^^^^^^^^^^^

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. This will **SAVE** you huge amount of **TIME** and will guarantee that the Device configuration is in **PROPER STATE**. It will **AVOID** any **MISCONFIGURATION** you do via manual cut&paste.

If you want to bring this device into this state you should click here:

|image37|

In the remaining section we provide you the information what the lab automation has done for you. So you can ignore the rest of the section if you use the automation.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

.. note:: If your Hub is a SRX4x00 you need to modify this template before you apply it. On this Platform all Interfaces are named “\ **xe**-?/?/?” and **not** “\ **ge**-?/?/?” so you need to change that below!

.. code-block:: none

   start shell
   #rm /var/tmp/srx1500-1.default
   vi /var/tmp/srx1500-1.default

Copy and Paste this config into your editor and save

.. code-block:: none

   system {
       host-name srx1500-1;
       root-authentication {
           encrypted-password "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0" ; ## SECRET-DATA
       }
       services {
           ftp;
           rlogin;
           ssh;
           telnet;
           netconf {
               ssh;
               rfc-compliant;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any any;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
   }
   security {
       policies {
           from-zone trust to-zone untrust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone trust to-zone trust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone trust {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
           }
           security-zone untrust {
               host-inbound-traffic {
                   system-services {
                       ssh;
                       ping;
                       netconf;
                       http;
                       https;
                       dhcp;
                       ike;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/0.0;
               }
           }
       }
   }
   interfaces {
       ge-0/0/0 {
           unit 0 {
               family inet {
                   address 192.168.190.254/24;
               }
           }
       }
   }
   routing-options {
       static {
           route 192.168.10.0/24 {
               next-hop 192.168.190.1;
               no-readvertise;
           }
       }
   }

.. code-block:: none

   exit
   edit
   load override /var/tmp/srx1500-1.default
   run request security policies resync
   run clear dhcp server binding all
   commit

NFX250-1 sd-wan basic
^^^^^^^^^^^^^^^^^^^^^

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. This will **SAVE** you huge amount of **TIME** and will guarantee that the Device configuration is in **PROPER STATE**. It will **AVOID** any **MISCONFIGURATION** you do via manual cut&paste.

If you want to bring this device into this state you should click here:

|image38|

In the remaining section we provide you the information what the lab automation has done for you. So you can ignore the rest of the section if you use the automation.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

Here you NEED a Terminal Server to access the device via console

.. code-block:: none

   cli
   request system zeroize
   yes
   
   # use the minicom over the ssh 192.168.10.2/172.30.200.152 (root/Lab58fgr#-1)      

   cli
   show configuration version
   # make sure you have upgraded the firmware to the right version
   # for CSO 4.1.0 it is required to use 15.1X53-D496
   edit
   set system host-name nfx250-1
   # review the device template for updated huge-page numbers to assign
   # In current CSO the NFX250-S1 has 9 and the NFX250-S2 has 13
   set system memory hugepages page-size 1024 page-count 13
   set system root-authentication plain-text-password
   New password: Embe1mpls
   Retype new password: Embe1mpls
   delete interfaces jmgmt0 unit 0 
   # set this interface only for debugging as it shortcuts the OAM
   # set interfaces jmgmt0 unit 0 family inet address 192.168.10.24/24
   delete system phone-home server https://redirect.juniper.net
   set system phone-home server https://centralmsvm.example.net
   set system phone-home traceoptions file phc.log
   set system phone-home traceoptions flag all
   set system name-server 192.168.10.10
   commit and-quit
   exit
   
   cat /config/device_serial_id
   DD2316AF0103

   #
   # use the server cert from the Post CSO install procedure
   # and append it to the ca file to be recognized
   #
   cp /var/phone-home/phcd-ca.crt /var/phone-home/phcd-ca.crt.orig

   # You can also load the certificate from the centralmsvm /etc/pki/tls/certs/ssl_cert.crt and append it to this file instead of put&pasteing it here
   # As explained this is needed if you don’t have an nfxweb account

   cat <<EOF >>/var/phone-home/phcd-ca.crt
   -----BEGIN CERTIFICATE-----
   MIIDrjCCApYCCQDZ8BNWtFex/DANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMC
   VVMxCzAJBgNVBAgMAkNBMRkwFwYDVQQKDBBKdW5pcGVyIE5ldHdvcmtzMRIwEAYD
   VQQHDAlTdW5ueXZhbGUxIDAeBgNVBAMMF2NlbnRyYWxtc3ZtLmV4YW1wbGUubmV0
   MQwwCgYDVQQLDANDU1AxHTAbBgkqhkiG9w0BCQEWDnRlc3RAZW1haWwubmV0MB4X
   DTE4MDcxMjEzMDYwNFoXDTIxMDQwNjEzMDYwNFowgZgxCzAJBgNVBAYTAlVTMQsw
   CQYDVQQIDAJDQTEZMBcGA1UECgwQSnVuaXBlciBOZXR3b3JrczESMBAGA1UEBwwJ
   U3Vubnl2YWxlMSAwHgYDVQQDDBdjZW50cmFsbXN2bS5leGFtcGxlLm5ldDEMMAoG
   A1UECwwDQ1NQMR0wGwYJKoZIhvcNAQkBFg50ZXN0QGVtYWlsLm5ldDCCASIwDQYJ
   KoZIhvcNAQEBBQADggEPADCCAQoCggEBAKtiYIRnR2Yq0eE/aqGTu+7MDFjxpjWX
   3CNf+yiNpG+dxtCcEXNrq1//UiBdPJlcKXq5mNOY359O0ueQrFhwPqaRwXoC04lR
   /W+2wLwse0ePeweQ0hd6GTQWAOjRfyQew+DZp31W10YDRSc8qzZTkgnYWqBJVFt/
   MnKgWNj8R50l0DK+nPhzDgo3iHVQh1M4x2muI238GSOJOsZNyOf0bUfj8Yti89AN
   wLIuQvbxaxP1qpbwRNK8ciA4DQr7RczNBVT4rsqw4GM3Hqtic7umM/EOQ1RCTjiU
   uGd56FkIqkkYGQ8nMWh7Uxfo1d+G8wjFXBUE6pxsMicU9DmZEKDix9ECAwEAATAN
   BgkqhkiG9w0BAQsFAAOCAQEAICz4G05p96lQToWDLf86XK24m8YtTAMZlckcErCx
   h2nQEDbiltSwspiaeyyenoAnK5KmGR6ijZDFuNIr5GIjbjx9RgrOLBacNDBous8Q
   C77w9BmCZB0TSuGMFeeV07A0lSEqoc2wX89Pic7rchb3LorJKE+ZEB0U2fppXp2o
   y8LnqX6ZgYH9QD5FBbVyTK0sw1aqPP/pRsv6Pa9mfvKivNPzfERJiFJkNdqvIj39
   iwUuwJUF3sN6cdKMj8s1irYnNhsB62M2pNFOCtvzIe+xLhbMlNEY1Qoiyk+KJOvZ
   fzX+nt1TrRi7zq+yGFSkOQ4kwAiWxSPUCZOcGLTjUd1G/Q==
   -----END CERTIFICATE-----
   EOF
   
   # Needed with new firmware else the added cert will be removed during reboot
   # If you forget this new step then ZTP will not work!!!
   cp /var/phone-home/phcd-ca.crt /var/phone-home/ca-bundle-1.crt  
   
   #cat /var/phone-home/phcd-ca.crt
   
   cli
   request system reboot
   yes

After this device comes back from reboot please check that the QFX5100 Switch really has handed out a DHCP-Lease to the device and that you have a default route pointing to 192.168.130.1 which will use the WAN_0 interface of the underlay.

.. code-block:: none

   ifconfig
   bme1      Link encap:Ethernet  HWaddr 52:54:00:ce:bd:0a
             inet addr:192.0.2.254  Bcast:192.0.2.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fece:bd0a/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:22195 errors:0 dropped:0 overruns:0 frame:0
             TX packets:10093 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:2440731 (2.4 MB)  TX bytes:671803 (671.8 KB)
   
   bme2      Link encap:Ethernet  HWaddr 52:54:00:da:6b:be
             inet addr:128.0.0.254  Bcast:128.0.255.255  Mask:255.255.0.0
             inet6 addr: fe80::5054:ff:feda:6bbe/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:18 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:1314 (1.3 KB)  TX bytes:648 (648.0 B)
   
   jmgmt0    Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cb
             inet addr:192.168.10.24  Bcast:192.168.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:348682 errors:0 dropped:0 overruns:0 frame:0
             TX packets:95 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:115079810 (115.0 MB)  TX bytes:11148 (11.1 KB)
   
   jsxe0     Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:16 errors:0 dropped:0 overruns:0 frame:0
             TX packets:81 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:2020 (2.0 KB)  TX bytes:23886 (23.8 KB)
   
   jsxe0.0   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:192.168.130.101  Bcast:192.168.130.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:5 errors:0 dropped:0 overruns:0 frame:0
             TX packets:23 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:1040 (1.0 KB)  TX bytes:6594 (6.5 KB)
   
   jsxe0.1   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:31 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:9330 (9.3 KB)
   
   jsxe0.2   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:3 errors:0 dropped:0 overruns:0 frame:0
             TX packets:27 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:188 (188.0 B)  TX bytes:7962 (7.9 KB)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:715 errors:0 dropped:0 overruns:0 frame:0
             TX packets:715 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:57267 (57.2 KB)  TX bytes:57267 (57.2 KB)
   
   phc       Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cd
             inet addr:10.10.10.1  Bcast:10.10.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:33 errors:0 dropped:0 overruns:0 frame:0
             TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:7362 (7.3 KB)  TX bytes:0 (0.0 B)
   
   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.130.1   0.0.0.0         UG    0      0        0 jsxe0.0
   10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 phc
   128.0.0.0       0.0.0.0         255.255.0.0     U     0      0        0 bme2
   192.0.2.0       0.0.0.0         255.255.255.0   U     0      0        0 bme1
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 jmgmt0
   192.168.130.0   0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.0

SRX345-1 sd-wan basic
^^^^^^^^^^^^^^^^^^^^^

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. This will **SAVE** you huge amount of **TIME** and will guarantee that the Device configuration is in **PROPER STATE**. It will **AVOID** any **MISCONFIGURATION** you do via manual cut&paste.

If you want to bring this device into this state you should click here:

|image39|

In the remaining section we provide you the information what the lab automation has done for you. So you can ignore the rest of the section if you use the automation.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

We are **forced to use a pre-defined known-good configuration** for Hardware SRX’s in our Labs (and maybe also in the field) and NOT work with the device after factory reset/zeroization.

The reason is that after are zeroize these devices launch internal DHCP servers that hand out possible WRONG DHCP-LEASES TO OTHER DEVICES. As by default in labs, such as ours, it may have all ports connected to the management lab before you apply valid link configuration. To avoid those devices to play role of a Rogue-DHCP Server we nail the config in the beginning so that we don’t ran into such issues later.

.. warning:: In the Field make sure that you have applied the correct underlay infrastructure configuration before you attach a Hardware SRX to a site to avoid similar issues.

.. code-block:: none

   start shell
   #rm /var/tmp/srx345-1.default
   vi /var/tmp/srx345-1.default

Copy and Paste this config into your editor and save

.. code-block:: none

   groups {
       global {
           security {
               forwarding-options {
                   family {
                       mpls {
                           mode flow-based;
                       }
                   }
               }
           }
       }
   }
   apply-groups global;
   system {
       host-name srx345-1;
       root-authentication {
           encrypted-password "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0" ; ## SECRET-DATA
       }
       name-server {
           192.168.10.10;
       }
       services {
           ftp;
           rlogin;
           ssh;
           telnet;
           netconf {
               ssh;
               rfc-compliant;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any any;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
       phone-home {
           server https://centralmsvm.example.net;
           ca-certificate-file /var/tmp/ssl_cert.crt;
           rfc-complaint;
       }
   }
   security {
       log {
           utc-timestamp;
           mode stream;
           format sd-syslog;
           source-address 192.168.0.1;
           transport {
               protocol tcp;
           }
       }
       flow {
           allow-dns-reply;
           allow-embedded-icmp;
           inactive: tcp-mss {
               ipsec-vpn {
                   mss 1350;
               }
           }
           tcp-session {
               no-syn-check;
               no-syn-check-in-tunnel;
               no-sequence-check;
           }
       }
       nat {
           source {
               rule-set own-mgmt-traffic-nat {
                   from routing-instance default;
                   to interface ge-0/0/0.0;
                   rule r1 {
                       match {
                           source-address 0.0.0.0/0;
                       }
                       then {
                           source-nat {
                               interface;
                           }
                       }
                   }
               }
               rule-set syslognat {
                   from routing-instance default;
                   to zone untrust;
                   rule syslognatr1 {
                       match {
                           source-address 192.168.0.1/32;
                           destination-address 0.0.0.0/0;
                       }
                       then {
                           source-nat {
                               interface;
                           }
                       }
                   }
               }
           }
       }
       policies {
           from-zone trust to-zone untrust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone trust to-zone trust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone trust {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
           }
           security-zone oam {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   lo0.0;
               }
           }
           security-zone untrust {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/0.0;
                   ge-0/0/1.0;
               }
           }
       }
   }
   interfaces {
       ge-0/0/0 {
           unit 0 {
               family inet {
                   address 192.168.170.2/24;
               }
           }
       }
       ge-0/0/1 {
           unit 0 {
               family inet {
                   dhcp-client {
                       lease-time infinite;
                   }
               }
           }
       }
       lo0 {
           description "Loopback Interface";
           unit 0 {
               family inet {
                   address 192.168.0.1/24;
               }
           }
       }
       st0 {
           per-unit-scheduler;
       }
   }
   routing-options {
       static {
           route 0.0.0.0/0 {
               next-hop 192.168.170.1;
               no-readvertise;
           }
       }
   }

.. code-block:: none

   # You can also load the certificate from the centralmsvm /etc/pki/tls/certs/ssl_cert.crt and append it to this file instead of put&pasteing it here
   # scp root@192.168.10.42:/etc/pki/tls/certs/ssl_cert.crt /var/tmp/ssl_cert.crt
   # As explaind this is needed if you don’t have an nfxweb account

   cat <<EOF >>/var/tmp/ssl_cert.crt
   -----BEGIN CERTIFICATE-----
   MIIDrjCCApYCCQDZ8BNWtFex/DANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMC
   VVMxCzAJBgNVBAgMAkNBMRkwFwYDVQQKDBBKdW5pcGVyIE5ldHdvcmtzMRIwEAYD
   VQQHDAlTdW5ueXZhbGUxIDAeBgNVBAMMF2NlbnRyYWxtc3ZtLmV4YW1wbGUubmV0
   MQwwCgYDVQQLDANDU1AxHTAbBgkqhkiG9w0BCQEWDnRlc3RAZW1haWwubmV0MB4X
   DTE4MDcxMjEzMDYwNFoXDTIxMDQwNjEzMDYwNFowgZgxCzAJBgNVBAYTAlVTMQsw
   CQYDVQQIDAJDQTEZMBcGA1UECgwQSnVuaXBlciBOZXR3b3JrczESMBAGA1UEBwwJ
   U3Vubnl2YWxlMSAwHgYDVQQDDBdjZW50cmFsbXN2bS5leGFtcGxlLm5ldDEMMAoG
   A1UECwwDQ1NQMR0wGwYJKoZIhvcNAQkBFg50ZXN0QGVtYWlsLm5ldDCCASIwDQYJ
   KoZIhvcNAQEBBQADggEPADCCAQoCggEBAKtiYIRnR2Yq0eE/aqGTu+7MDFjxpjWX
   3CNf+yiNpG+dxtCcEXNrq1//UiBdPJlcKXq5mNOY359O0ueQrFhwPqaRwXoC04lR
   /W+2wLwse0ePeweQ0hd6GTQWAOjRfyQew+DZp31W10YDRSc8qzZTkgnYWqBJVFt/
   MnKgWNj8R50l0DK+nPhzDgo3iHVQh1M4x2muI238GSOJOsZNyOf0bUfj8Yti89AN
   wLIuQvbxaxP1qpbwRNK8ciA4DQr7RczNBVT4rsqw4GM3Hqtic7umM/EOQ1RCTjiU
   uGd56FkIqkkYGQ8nMWh7Uxfo1d+G8wjFXBUE6pxsMicU9DmZEKDix9ECAwEAATAN
   BgkqhkiG9w0BAQsFAAOCAQEAICz4G05p96lQToWDLf86XK24m8YtTAMZlckcErCx
   h2nQEDbiltSwspiaeyyenoAnK5KmGR6ijZDFuNIr5GIjbjx9RgrOLBacNDBous8Q
   C77w9BmCZB0TSuGMFeeV07A0lSEqoc2wX89Pic7rchb3LorJKE+ZEB0U2fppXp2o
   y8LnqX6ZgYH9QD5FBbVyTK0sw1aqPP/pRsv6Pa9mfvKivNPzfERJiFJkNdqvIj39
   iwUuwJUF3sN6cdKMj8s1irYnNhsB62M2pNFOCtvzIe+xLhbMlNEY1Qoiyk+KJOvZ
   fzX+nt1TrRi7zq+yGFSkOQ4kwAiWxSPUCZOcGLTjUd1G/Q==
   -----END CERTIFICATE-----
   EOF

In case you have no DNS server….

.. code-block:: none

   # set system static-host-mapping regionalmsvm.example.net inet 192.168.10.45

.. code-block:: none

   exit
   edit
   load override /var/tmp/srx345-1.default
   run clear dhcp server binding all
   commit

.. code-block:: none

   ping 192.168.170.1
   PING 192.168.170.1 (192.168.170.1): 56 data bytes
   64 bytes from 192.168.170.1: icmp_seq=0 ttl=64 time=2.552 ms
   64 bytes from 192.168.170.1: icmp_seq=1 ttl=64 time=11.364 ms
   64 bytes from 192.168.170.1: icmp_seq=2 ttl=64 time=6.643 ms
   64 bytes from 192.168.170.1: icmp_seq=3 ttl=64 time=7.303 ms
   ^C
   --- 192.168.170.1 ping statistics ---
   4 packets transmitted, 4 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 2.552/6.966/11.364/3.124 ms

   ping 192.168.10.10 source 192.168.170.2
   PING 192.168.10.10 (192.168.10.10): 56 data bytes
   64 bytes from 192.168.10.10: icmp_seq=619 ttl=59 time=1.450 ms
   64 bytes from 192.168.10.10: icmp_seq=620 ttl=59 time=1.347 ms
   64 bytes from 192.168.10.10: icmp_seq=621 ttl=59 time=1.419 ms
   64 bytes from 192.168.10.10: icmp_seq=622 ttl=59 time=1.579 ms

   show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   ge-0/0/0                up    up
   ge-0/0/0.0              up    up   inet     192.168.170.2/24
   gr-0/0/0                up    up
   ip-0/0/0                up    up
   lsq-0/0/0               up    up
   lt-0/0/0                up    up
   mt-0/0/0                up    up
   sp-0/0/0                up    up
   sp-0/0/0.0              up    up   inet
                                      inet6
   sp-0/0/0.16383          up    up   inet     10.0.0.1            --> 10.0.0.16
                                               10.0.0.6            --> 0/0
                                               128.0.0.1           --> 128.0.1.16
                                               128.0.0.6           --> 0/0
   ge-0/0/1                up    up
   ge-0/0/1.0              up    up   inet
   ge-0/0/2                up    down
   ge-0/0/3                up    down
   ge-0/0/4                up    up
   ge-0/0/5                up    down

#

# MANDATORY - check/upgrade license /\* fixme you need all licenses \*/

#

.. code-block:: none

   show chassis hardware
   Hardware inventory:
   Item             Version  Part number  Serial number     Description
   Chassis                                CZ1616AF0021      SRX345
   Routing Engine   REV 0x06 650-065042   CZ1616AF0021      RE-SRX345
   FPC 0                                                    FPC
     PIC 0                                                  8xGE,8xGE SFP Base PIC
   Power Supply 0

   root@srx345-1> show system license
   License usage:
                                    Licenses     Licenses    Licenses    Expiry
     Feature name                       used    installed      needed
     dynamic-vpn                           0            2           0    permanent
     remote-access-ipsec-vpn-client        0            2           0    permanent

   Licenses installed: none

   # need an idp-sig license for SD-WAN to work

   request system license add terminal
   [Type ^D at a new line to end input,
    enter blank line between each license key]
   JUNOS952069 aeaqia qminnd cnrrgz aummbq giyqqb qcdxca
               7rlqa4 ukmzf6 5i6emn fbu3mg umc3tk irnf7u
               5jznzt wgslzy mav4jh ggjzse hqeovn sx6d77
               wqa
   ^D
   JUNOS952069: successfully added
   add license complete (no errors)

   show system license
   License usage:
                                    Licenses     Licenses    Licenses    Expiry
     Feature name                       used    installed      needed
     idp-sig                               0            1           0    2018-09-02 00:00:00 UTC
     dynamic-vpn                           0            2           0    permanent
     remote-access-ipsec-vpn-client        0            2           0    permanent
   
   Licenses installed:
     License identifier: JUNOS952069
     License version: 4
     Valid for device: CZ1616AF0021
     Features:
       idp-sig          - IDP Signature
         date-based, 2017-09-14 00:00:00 UTC - 2018-09-02 00:00:00 UTC
   
   
   #
   # all licenses for this system
   #
   
   Serial No :              CZ1616AF0021
   Model :                  SRX345
   Features :               SRX345-CS-BUN-1
   Issue Date :             14-Sep-2017
   Expiration Date :        01-Sep-2018
   License Id :             JUNOS952069
   License Key : 
   JUNOS952069 aeaqia qminnd cnrrgz aummbq giyqqb qcdxca
               7rlqa4 ukmzf6 5i6emn fbu3mg umc3tk irnf7u
               5jznzt wgslzy mav4jh ggjzse hqeovn sx6d77
               wqa
   
   Serial No :              CZ1616AF0021
   Model :                  SRX345
   Features :               SRX345-CS-BUN-1
   Issue Date :             14-Sep-2017
   Expiration Date :        01-Sep-2018
   License Id :             JUNOS952070
   License Key : 
   JUNOS952070 aeaqia qminnd cnrrgz aummbq giyqqb qcopca
               7rlqa4 unv4tr eiye6e 2rr6jl otxrs4 w66upf
               xikroa oti2xr mqikwo sd2mdb 7gbs4e u42lep
               6my
   
   Serial No :              CZ1616AF0021
   Model :                  SRX345
   Features :               SRX345-CS-BUN-1
   Issue Date :             14-Sep-2017
   Expiration Date :        01-Sep-2018
   License Id :             JUNOS952071
   License Key : 
   JUNOS952071 aeaqia qminnd cnrrgz aummbq giyqqb qcixca
               7rlqa4 ul63do dgpyin vxwbcf pcepmn h7rptq
               q32cro t3geey ynnbna xpydsc or5hpj o5mdsf
               v4i
   
   Serial No :              CZ1616AF0021
   Model :                  SRX345
   Features :               SRX345-CS-BUN-1
   Issue Date :             14-Sep-2017
   Expiration Date :        01-Sep-2018
   License Id :             JUNOS952072
   License Key : 
   JUNOS952072 aeaqia qminnd cnrrgz aummbq giyqqb qcdpca
               7rlqa4 ugvdb4 2zogui k7j2my vsc3pa cxyrxy
               tltimx dlfdoj tilqbg 23kfd7 sxwkws 6ynebq
               jga

NFX150 sd-wan basic
^^^^^^^^^^^^^^^^^^^

.. warning:: The NFX150 is currently excluded from automation.

.. warning:: /\* fixme this chapter is work-in-progress so far. We need a lab with such a device to test it. \*/

We know already on **important thing that needs to be changed** in the device template of the “NFX150 as SD-WAN CPE”

|image40|

You **MUST change the VNF_DHCP_Configuration** as it collides with the CSO internal management IP address range for this lab. Else ZTP will not succed!!!

|image41|

Also you MUST select the correct Port mapping of your device

|image42|

Test case execution related to vCPE use-cases
=============================================

.. warning:: CSO V4.1 is the last version supporting this use-case. Support will be EOL in newer versions as there are too less requests from customers.

.. warning:: /\* fixme This entire Chapter has not been re-evaluated with CSO 4.0.2 or higher as of now. In theory the big changes are all on the SD-WAN side so there SHOULD not be any dramatic changes. \*/

#

# MANDATORY use NSD to create at least ONE design before you do anything

#

https://192.168.10.42:83/nsd-ui/login.html cspadmin/Juniper123!

|image43|

|image44|

|image45|

|image46|

|image47|

|image48|

.. note:: Do NOT use vSRX-Space!!!

|image49|

|image50|

|image51|

|image52|

|image53|

|image54|

|image55|

|image56|

|image57|

|image58|

|image59|

|image60|

|image61|

#

# pop-vcpe.json

#

https://192.168.10.42/admin-portal-ui/index.html

|image62|

|image63|

|image64|

|image65|

|image66|

Password=”contrail123”

.. note:: NEVER use a different name then “mgmt” for the management network else your heat stack creation later WILL FAIL. This name is hardcoded somewhere and HAS to be used!!!

|image67|

|image68|

cspadmin Password= “passw0rd”

|image69|

|image70|

|image71|

|image72|

|image73|

|image74|

|image75|

http://192.168.10.15/horizon (admin/contrail123)

|image76|

|image77|

|image78|

|image79|

|image80|

.. code-block:: none

   cat <<EOF > vcpe-pop.json
   {
       "input": {
           "job_name_prefix": "vcpe-pop",
           "pop": [
               {
                   "dc_name": "regional",
                   "vim": [
                       {
                           "vim_type": "cloud",
                           "name": "contrail3",
                           "cloud": {
                               "username": "admin",
                               "vim_service_profiles": {
                                   "default_service_profile_name": "profile3",
                                   "service_profiles": [
                                       {
                                           "tenant_name": "cso-project",
                                           "password": "passw0rd",
                                           "user_name": "cspadmin",
                                           "domain_name": "Default",
                                           "service_profile_name": "profile3"
                                       }
                                   ]
                               },
                               "internet_network": [
                                   {
                                       "route_target": [
                                           "64512:10001"
                                       ],
                                       "onboard": false,
                                       "vl_name": "right",
                                       "vld_name": "right",
                                       "subnet": [
                                           "10.55.55.0/24"
                                       ]
                                   }
                               ],
                               "default_tenant": "admin",
                               "default_domain": "Default",
                               "auth_url": "http://192.168.68.15:5000/v3",
                               "address": "192.168.68.15",
                               "resource_pool": [
                                   {
                                       "compute_zone": "nova",
                                       "name": "nova"
                                   }
                               ],
                               "password": "contrail123",
                               "mgmt_network": {
                                   "route_target": [
                                       "64512:10000"
                                   ],
                                   "onboard": false,
                                   "vl_name": "mgmt",
                                   "vld_name": "mgmt",
                                   "subnet": [
                                       "192.168.69.0/24"
                                   ]
                               }
                           }
                       }
                   ],
                   "name": "vcpe-pop",
                   "address": {
                       "country": "US"
                   }
               }
           ]
       }
   }
   EOF

ssh to MX80-1 192.168.10.21 (root/juniper123)

.. code-block:: none

   show route
   .
   vnf-mgnt.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   192.168.10.0/24    *[Direct/0] 1d 00:14:37
                       > via ge-1/0/2.0
   192.168.10.70/32   *[Local/0] 1d 00:14:37
                         Local via ge-1/0/2.0

   public-vcpe.inet.0: 3 destinations, 3 routes (3 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 1d 00:14:02
                       > to 192.168.74.1 via ge-1/1/4.74
   192.168.74.0/24    *[Direct/0] 1d 00:14:02
                       > via ge-1/1/4.74
   192.168.74.254/32  *[Local/0] 1d 00:14:02
                         Local via ge-1/1/4.74

   site-vcpe.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   10.77.77.0/24      *[Direct/0] 1d 00:13:40
                       > via ge-1/1/2.0
   10.77.77.1/32      *[Local/0] 1d 00:13:40
                         Local via ge-1/1/2.0
   .

|image81|

|image82|

|image83|

.. note:: MAKE SURE you fill in at least one service profile this tenant can use as below.

|image84|

|image85|

.. code-block:: none

   cat <<EOF > vcpe-tenant.json
   {
       "input": {
           "tenant_admin": {
               "admin_user_name": "vcpetenant_admin@vcpetenant.com",
               "last_name": "Doe",
               "first_name": "Joe",
               "password_expiration_interval": 0
           },
           "vim_service_profiles": [
               {
                   "profile_name": "profile3",
                   "vim_name": "contrail3"
               }
           ],
           "tenant_type": "medium",
           "managed_wan_topology": {
               "network": [
                   {
                       "network_name": "vcpetenant_L3VPN"
                   }
               ]
           },
           "tenant_name": "vcpetenant",
           "default_ssl_proxy_profile": {
               "enabled": false
           },
           "password_expiration_radio": "never",
           "topology_type": "standalone",
           "properties": {
               "property": [
                   {
                       "name": "default-tenant-topology",
                       "value": "standalone"
                   }
               ]
           }
       }
   }
   EOF

|image86|

|image87|

|image88|

# change the view to "vcpetenant" upper right corner

|image89|

|image90|

|image91|

|image92|

# go to site and "add a cloud site"

.. code-block:: none

   cat <<EOF > vcpe-site.json
   {
       "input": {
           "tenant_name": "vcpetenant",
           "job_name_prefix": "Create-Site-for-site2",
           "site": [
               {
                   "data_center_site_info": {
                       "subnet": [
                           "10.22.22.0/24"
                       ],
                       "assigned_vim": "contrail3",
                       "assigned_resource_pool": "nova",
                       "internet_info": {
                           "virtual_network_name": "right"
                       },
                       "pop_name": "vcpe-pop",
                       "vl_name": "left",
                       "route_target": "64513:10002",
                       "onboard": false
                   },
                   "site_name": "site2",
                   "site_basic_properties": {
                       "site_address": {
                           "country": "US"
                       },
                       "site_description": "",
                       "site_role": "NONE",
                       "cloud_service": "HUB",
                       "site_type": "data_center"
                   }
               }
           ]
       }
   }
   EOF

|image93|

|image94|

|image95|

|image96|

|image97|

|image98|

|image99|

|image100|

|image101|

|image102|

|image103|

|image104|

|image105|

.. note:: It COULD happen that the Spawning of the VM takes >= 3 minutes and that CSO will terminate the Heat-stack too early. You will then see this:

|image106|

And an unsuccessful deployment here. This usually happens on slow OpenStack Hosts. Especially if the Host takes time to copy the VM qcow2 image internally for the first time to the local Compute. This has NOTHING TO DO WITH CSO. You just have inadequate Servers for the Demo. In most cases you just delete the service in CSO and build it up again. Usually it then comes up faster as there is a local copy from the previous attempt and you don’t run into this issue again.

|image107|

Let’s continue with the normal workflow. **The boot-time of the vSRX is usually around 10minutes.** There is no way to cut this time down.

During that timeframe you can ping the dynamic management IP-Address of the 192.168.69.0/24 subnet (192.168.69.3 in this case) to see when the fxp0 interface of the VM has been configured during boot-up. A minute later or so also Ssh as root (Password=passw0rd) should work. When the vSRX is up and running it usually takes again ~2 minutes until CSO will discover it and configures the two apply groups cso-base and cso-fw that implement the forwarding and firewall behaviour.

.. code-block:: none

   root@cso-host:~# ping 192.168.69.3
   PING 192.168.69.3 (192.168.69.3) 56(84) bytes of data.
   64 bytes from 192.168.69.3: icmp_seq=1 ttl=62 time=2.43 ms
   From 192.168.69.3: icmp_seq=2 Redirect Host(New nexthop: 192.168.69.3)
   64 bytes from 192.168.69.3: icmp_seq=2 ttl=62 time=2.25 ms
   64 bytes from 192.168.69.3: icmp_seq=3 ttl=62 time=1.99 ms
   64 bytes from 192.168.69.3: icmp_seq=4 ttl=62 time=2.43 ms
   64 bytes from 192.168.69.3: icmp_seq=5 ttl=62 time=2.36 ms
   64 bytes from 192.168.69.3: icmp_seq=6 ttl=62 time=2.36 ms
   ^C64 bytes from 192.168.69.3: icmp_seq=7 ttl=62 time=2.23 ms
   ^C
   --- 192.168.69.3 ping statistics ---
   7 packets transmitted, 7 received, 0% packet loss, time 6006ms
   rtt min/avg/max/mdev = 1.999/2.297/2.435/0.144 ms
   root@cso-host:~# ssh root@192.168.69.3
   Password:
   --- JUNOS 15.1X49-D40.6 built 2016-03-22 05:44:29 UTC
   root@testvm% cli
   root@testvm> show configuration | display set
   set version 15.1X49-D40.6
   set groups cso-base system host-name testvm
   set groups cso-base system name-server 8.8.8.8
   set groups cso-base security screen ids-option right-zone-screen icmp ping-death
   set groups cso-base security screen ids-option right-zone-screen ip source-route-option
   set groups cso-base security screen ids-option right-zone-screen ip tear-drop
   set groups cso-base security screen ids-option right-zone-screen tcp syn-flood alarm-threshold 1024
   set groups cso-base security screen ids-option right-zone-screen tcp syn-flood attack-threshold 200
   set groups cso-base security screen ids-option right-zone-screen tcp syn-flood source-threshold 1024
   set groups cso-base security screen ids-option right-zone-screen tcp syn-flood destination-threshold 2048
   set groups cso-base security screen ids-option right-zone-screen tcp syn-flood timeout 20
   set groups cso-base security screen ids-option right-zone-screen tcp land
   set groups cso-base security policies policy-rematch
   set groups cso-base security zones security-zone left interfaces ge-0/0/0.0 host-inbound-traffic system-services dhcp
   set groups cso-base security zones security-zone right screen right-zone-screen
   set groups cso-base security zones security-zone right interfaces ge-0/0/1.0 host-inbound-traffic system-services dhcp
   set groups cso-base interfaces ge-0/0/0 unit 0 family inet dhcp-client
   set groups cso-base interfaces ge-0/0/0 unit 0 family inet filter input left-right
   set groups cso-base interfaces ge-0/0/1 unit 0 family inet dhcp-client
   set groups cso-base interfaces ge-0/0/1 unit 0 family inet filter input right-left
   set groups cso-base interfaces lo0 unit 0 family inet address 1.1.1.1/32
   set groups cso-base firewall family inet filter left-right term any then routing-instance right
   set groups cso-base firewall family inet filter right-left term any then routing-instance left
   set groups cso-base routing-instances left instance-type virtual-router
   set groups cso-base routing-instances left interface ge-0/0/0.0
   set groups cso-base routing-instances right instance-type virtual-router
   set groups cso-base routing-instances right interface ge-0/0/1.0
   set groups cso-fw security policies from-zone left to-zone right policy passall match source-address any
   set groups cso-fw security policies from-zone left to-zone right policy passall match destination-address any
   set groups cso-fw security policies from-zone left to-zone right policy passall match application any
   set groups cso-fw security policies from-zone left to-zone right policy passall then permit
   set apply-groups cso-base
   set apply-groups cso-fw
   set system root-authentication encrypted-password "$5$r2ksDnz0$kwbkWzcFBbd6eT.LBKff7LGXasWXdrGEkI0Oq0km5l6"
   set system services ssh max-sessions-per-connection 32
   set system services netconf ssh
   set system services web-management http interface fxp0.0
   set system syslog user * any emergency
   set system syslog file messages any any
   set system syslog file messages authorization info
   set system syslog file interactive-commands interactive-commands any
   set system syslog file default-log-messages any info
   set system syslog file default-log-messages match "(requested 'commit' operation)|(copying configuration to juniper.save)|(commit complete)|ifAdminStatus|(FRU power)|(FRU removal)|(FRU insertion)|(link UP)|transitioned|Transferred|transfer-file|(license add)|(license delete)|(package -X update)|(package -X delete)|(FRU Online)|(FRU Offline)|(plugged in)|(unplugged)|GRES"
   set system syslog file default-log-messages structured-data
   set system license autoupdate url https://ae1.juniper.net/junos/key_retrieval
   set system processes dhcp-service traceoptions file jdhcp.log
   set system processes dhcp-service traceoptions file size 5m
   set system processes dhcp-service traceoptions level all
   set system processes dhcp-service traceoptions flag all
   set security screen ids-option untrust-screen icmp ping-death
   set security screen ids-option untrust-screen ip source-route-option
   set security screen ids-option untrust-screen ip tear-drop
   set security screen ids-option untrust-screen tcp syn-flood alarm-threshold 1024
   set security screen ids-option untrust-screen tcp syn-flood attack-threshold 200
   set security screen ids-option untrust-screen tcp syn-flood source-threshold 1024
   set security screen ids-option untrust-screen tcp syn-flood destination-threshold 2048
   set security screen ids-option untrust-screen tcp syn-flood queue-size 2000
   set security screen ids-option untrust-screen tcp syn-flood timeout 20
   set security screen ids-option untrust-screen tcp land
   set security policies from-zone trust to-zone trust policy default-permit match source-address any
   set security policies from-zone trust to-zone trust policy default-permit match destination-address any
   set security policies from-zone trust to-zone trust policy default-permit match application any
   set security policies from-zone trust to-zone trust policy default-permit then permit
   set security policies from-zone trust to-zone untrust policy default-permit match source-address any
   set security policies from-zone trust to-zone untrust policy default-permit match destination-address any
   set security policies from-zone trust to-zone untrust policy default-permit match application any
   set security policies from-zone trust to-zone untrust policy default-permit then permit
   set security zones security-zone trust tcp-rst
   set security zones security-zone untrust screen untrust-screen
   set interfaces fxp0 unit 0 family inet dhcp-client retransmission-attempt 6
   set interfaces fxp0 unit 0 family inet dhcp-client retransmission-interval 64

After the process if all is completed review on the MX80-1 the route and observe that route-leaking (via the Contrail SDN-Controller is happening)

.. code-block:: none

   show route
   .
   .
   public-vcpe.inet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 1w1d 20:14:37
                       > to 192.168.74.1 via ge-1/1/4.74
   10.22.22.3/32      *[BGP/170] 02:33:38, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 23
   10.22.22.4/32      *[BGP/170] 02:33:38, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 23
   10.55.55.3/32      *[BGP/170] 03:10:52, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 23
   10.55.55.4/32      *[BGP/170] 03:04:05, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 23
   10.77.77.0/24      *[BGP/170] 02:33:38, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 23
   192.168.74.0/24    *[Direct/0] 1w1d 20:14:37
                       > via ge-1/1/4.74
   192.168.74.254/32  *[Local/0] 1w1d 20:14:37
                         Local via ge-1/1/4.74
   .
   .
   site-vcpe.inet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 02:33:38, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 21
   10.22.22.3/32      *[BGP/170] 03:10:52, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 21
   10.22.22.4/32      *[BGP/170] 03:04:05, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 21
   10.55.55.3/32      *[BGP/170] 02:33:38, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 21
   10.55.55.4/32      *[BGP/170] 02:33:38, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 21
   10.77.77.0/24      *[Direct/0] 1w1d 20:14:37
                       > via ge-1/1/2.0
   10.77.77.1/32      *[Local/0] 1w1d 20:14:37
                         Local via ge-1/1/2.0
   192.168.74.0/24    *[BGP/170] 02:33:38, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 21
   .
   .
   vnf-mgnt.inet.0: 3 destinations, 3 routes (3 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   192.168.10.0/24    *[Direct/0] 1w1d 20:14:38
                       > via ge-1/0/2.0
   192.168.10.70/32   *[Local/0] 1w1d 20:14:38
                         Local via ge-1/0/2.0
   192.168.69.3/32    *[BGP/170] 03:05:18, MED 100, localpref 200, from 192.168.68.15
                         AS path: ?, validation-state: unverified
                       > via gr-0/0/0.32769, Push 19

Now find the

.. code-block:: none

   virsh vncdisplay desktop3
   :93

Ping the MX80 IP 10.77.77.1 first to verify you have a connection with the MX as simulated PE.

|image108|

The ping something in the outside would to see the whole service-chaining working. Let this Ping run and then review the state of the vSRX in the Contrail Fabric.

|image109|

As you see below the traffic now flows over the vSRX towards the Internet which verifies that service-chaining is working.

.. code-block:: none

   root@testvm> show security flow session
   Session ID: 1990, Policy name: passall/6, Timeout: 58, Valid
     In: 10.77.77.77/33769 --> 91.189.94.4/123;udp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 76,
     Out: 91.189.94.4/123 --> 10.77.77.77/33769;udp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 76,
   
   Session ID: 1991, Policy name: passall/6, Timeout: 2, Valid
     In: 10.77.77.77/12 --> 8.8.8.8/791;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/791 --> 10.77.77.77/12;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,
   
   Session ID: 1992, Policy name: passall/6, Timeout: 2, Valid
     In: 10.77.77.77/13 --> 8.8.8.8/791;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/791 --> 10.77.77.77/13;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,
   
   Session ID: 1993, Policy name: passall/6, Timeout: 4, Valid
     In: 10.77.77.77/14 --> 8.8.8.8/791;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/791 --> 10.77.77.77/14;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,
   
   Session ID: 1994, Policy name: passall/6, Timeout: 4, Valid
     In: 10.77.77.77/15 --> 8.8.8.8/791;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/791 --> 10.77.77.77/15;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,
   Total sessions: 5

OPTIONAL Test case Linux Tables VM

This test case assumes that you have created a vCPE POP, Tenant, a Site and when you developed the lab in Chapter 3.2.10 above you have created a Linux table image that CSO can start on the Contrail Fabric.

|image110|

|image111|

|image112|

https://192.168.10.42:83/nsd-ui/login.html cspadmin/Juniper123!

|image113|

|image114|

|image115|

Hit create

|image116|

|image117|

|image118|

|image119|

|image120|

|image121|

|image122|

|image123|

|image124|

|image125|

|image126|

|image127|

|image128|

|image129|

|image130|

Only option supported in “Service/Port” mask is “any”. If you configure port number or service name it will always use TCP only. **Do not try to use port range** as it would fail during configuration push.

|image131|

|image132|

|image133|

From the CSO-Host ping the dynamic IP-Address on the management interface (192.168.69.3 in this case). It should be reachable after 2-3minutes. Then login via Ssh as root/passw0rd.

First show that the firewall rule you have created has been inserted.

The you might show the way the forwarding from eth1 to eth2 has been build.

.. note:: The global routeing table will NOT show you how it’s made and is only relevant for the management interface eth0 in reality.

The main commands are “ip rule show” that state whenever an incoming packet (iif-statement) arrives on an eth1/2 the OPPOSITE Route-Table is used to make the forwarding decision. If you then look as each of the two left/right tables you see that each got the vRouter as GW via DHCP that is on the local interface to route the traffic further.

.. code-block:: none

   root@cso-host:~# ssh root@192.168.69.3
   root@192.168.69.4's password:passw0rd
   .
   root@ns-892dd1941ad8-lxciptable-firewall-0-vm-yyslsshzjoej:~# iptables -S
   -P INPUT ACCEPT
   -P FORWARD ACCEPT
   -P OUTPUT ACCEPT
   -A INPUT -i lo -j ACCEPT
   -A INPUT -m conntrack --ctstate INVALID -j DROP
   -A INPUT -s 127.0.0.0/8 ! -i lo -j DROP
   -A INPUT -m addrtype --dst-type BROADCAST -j DROP
   -A INPUT -m addrtype --dst-type MULTICAST -j DROP
   -A INPUT -m addrtype --dst-type ANYCAST -j DROP
   -A INPUT -d 224.0.0.0/4 -j DROP
   -A FORWARD -m comment --comment passall -j ACCEPT   <- Added by CSO
   root@ns-892dd1941ad8-lxciptable-firewall-0-vm-yyslsshzjoej:~# ifconfig
   eth0      Link encap:Ethernet  HWaddr 02:cd:f2:2f:10:eb
             inet addr:192.168.69.3  Bcast:192.168.69.255  Mask:255.255.255.0
             inet6 addr: fe80::cd:f2ff:fe2f:10eb/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:1020 errors:0 dropped:0 overruns:0 frame:0
             TX packets:1003 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:104068 (104.0 KB)  TX bytes:90584 (90.5 KB)
   
   eth1      Link encap:Ethernet  HWaddr 02:29:12:75:bb:74
             inet addr:10.22.22.4  Bcast:10.22.22.255  Mask:255.255.255.0
             inet6 addr: fe80::29:12ff:fe75:bb74/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:1763 errors:0 dropped:0 overruns:0 frame:0
             TX packets:1468 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:141444 (141.4 KB)  TX bytes:129048 (129.0 KB)
   
   eth2      Link encap:Ethernet  HWaddr 02:a6:b7:bd:8f:fa
             inet addr:10.55.55.4  Bcast:10.55.55.255  Mask:255.255.255.0
             inet6 addr: fe80::a6:b7ff:febd:8ffa/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:1771 errors:0 dropped:0 overruns:0 frame:0
             TX packets:1472 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:141900 (141.9 KB)  TX bytes:129096 (129.0 KB)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
   
   lo:0      Link encap:Local Loopback
             inet addr:1.1.1.1  Mask:255.255.255.255
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
   
   
   root@ns-892dd1941ad8-lxciptable-firewall-0-vm-yyslsshzjoej:~# cat /etc/network/interfaces
   auto lo
   iface lo inet loopback

   auto eth0
   iface eth0 inet dhcp
     metric 1

   auto eth1
   iface eth1 inet dhcp
     post-up ip rule add iif eth1 lookup right
     metric 100

   auto eth2
   iface eth2 inet dhcp
     post-up ip rule add iif eth2 lookup left
     metric 100

   root@ns-892dd1941ad8-lxciptable-firewall-0-vm-yyslsshzjoej:~# ip route show
   default via 192.168.69.1 dev eth0  metric 1
   default via 10.55.55.1 dev eth2  metric 100
   10.22.22.0/24 dev eth1  proto kernel  scope link  src 10.22.22.4
   10.55.55.0/24 dev eth2  proto kernel  scope link  src 10.55.55.4
   192.168.69.0/24 dev eth0  proto kernel  scope link  src 192.168.69.3
   root@ns-892dd1941ad8-lxciptable-firewall-0-vm-yyslsshzjoej:~# ip rule show
   0:      from all lookup local
   32764:  from all iif eth2 lookup left
   32765:  from all iif eth1 lookup right
   32766:  from all lookup main
   32767:  from all lookup default
   root@ns-892dd1941ad8-lxciptable-firewall-0-vm-yyslsshzjoej:~# ip route show table left
   default dev eth1  scope link
   root@ns-892dd1941ad8-lxciptable-firewall-0-vm-yyslsshzjoej:~# ip route show table right
   default dev eth2  scope link

Then go to the desktop client and start a ping to the outside same as you did before with the vSRX as VNF.

|image134|

Then do a tcpdump on the left/right eth1 and eth2 interfaces to confirm they are seeing this traffic and forward it.

.. code-block:: none

   tcpdump -ni eth1
   tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
   listening on eth1, link-type EN10MB (Ethernet), capture size 262144 bytes
   08:11:31.658723 IP 10.77.77.77 > 8.8.8.8: ICMP echo request, id 12429, seq 42616, length 64
   08:11:31.660480 IP 8.8.8.8 > 10.77.77.77: ICMP echo reply, id 12429, seq 42616, length 64
   08:11:32.660085 IP 10.77.77.77 > 8.8.8.8: ICMP echo request, id 12429, seq 42617, length 64
   08:11:32.662045 IP 8.8.8.8 > 10.77.77.77: ICMP echo reply, id 12429, seq 42617, length 64
   08:11:33.661939 IP 10.77.77.77 > 8.8.8.8: ICMP echo request, id 12429, seq 42618, length 64
   08:11:33.663807 IP 8.8.8.8 > 10.77.77.77: ICMP echo reply, id 12429, seq 42618, length 64
   ^C
   6 packets captured
   6 packets received by filter
   0 packets dropped by kernel

.. code-block:: none

   tcpdump -ni eth2
   tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
   listening on eth2, link-type EN10MB (Ethernet), capture size 262144 bytes
   08:13:00.888957 IP 10.77.77.77 > 8.8.8.8: ICMP echo request, id 14365, seq 38, length 64
   08:13:00.890653 IP 8.8.8.8 > 10.77.77.77: ICMP echo reply, id 14365, seq 38, length 64
   08:13:01.890314 IP 10.77.77.77 > 8.8.8.8: ICMP echo request, id 14365, seq 39, length 64
   08:13:01.892075 IP 8.8.8.8 > 10.77.77.77: ICMP echo reply, id 14365, seq 39, length 64
   ^C
   4 packets captured
   4 packets received by filter
   0 packets dropped by kernel

This ends all vCPE test cases we have prepared for this lab.

Test case execution related to uCPE use-cases
=============================================

.. warning:: /\* fixme This entire Chapter has not been re-evaluated with CSO 4.0.2 or higher as of now. In theory the big changes are all on the SD-WAN side so there SHOULD not be any dramatic changes. \*/

##

## MANDATORY!!!

##

**/\* fixme explanation WHY this step need to be done needs to be added here \*/**

.. code-block:: none

   apt-get –y install jq
   
   RAW_TOKEN=`curl -d '{"auth":{"tenantName":"admin", "passwordCredentials":{"username":"admin", "password":"5DQkO6ME2Y87"}}}' -H "Content-type: application/json" http://192.168.10.42:5000/v2.0/tokens`
   TOKEN=`echo $RAW_TOKEN | python -c "import sys; import json; tok = json.loads(sys.stdin.read()); print tok['access']['token']['id'];"`
   echo $TOKEN
   
   REGIONALID=`curl -k -X GET https://192.168.10.42/topology-service/region-dc  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq -r '.[][0].uuid'`
   echo $REGIONALID
   
   curl -k -X GET https://192.168.10.42/topology-service/region-dc/$REGIONALID  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq . > change-net.json
   
   cat change-net.json
   {
     "region-dc": {
       "name": "regional",
       "parent_uri": "/topology-service/domain/89c6d99c-1e22-4af4-a151-2ed557e87c5d",
       "fq_name": [
         "default-domain",
         "regional"
       ],
       "id_perms": {
         "permissions": {
           "group_access": 7,
           "group": "admin",
           "other_access": 7,
           "owner_access": 7,
           "owner": "admin"
         },
         "enable": true,
         "description": null,
         "creator": "admin",
         "created": "2018-04-04T18:32:44.501861",
         "uuid": {
           "uuid_lslong": 13461003805522555000,
           "uuid_mslong": 9389947551792122000
         },
         "user_visible": true,
         "last_modified": "2018-04-10T11:08:30.999422",
         "modifier": "admin"
       },
       "perms2": {
         "share": [],
         "global_access": 4,
         "owner_access": 0,
         "owner": "a509b79996a946ca965039d798c6446c"
       },
       "display_name": "regional",
       "uuid": "824fcb8c-5c1e-4873-bacf-17a4445a6c6f",
       "parent_uuid": "89c6d99c-1e22-4af4-a151-2ed557e87c5d",
       "central_dc_back_refs": [
         {
           "uri": "/topology-service/central-dc/c98711d1-5d29-4d2a-a042-f0d417710ad1",
           "attr": null,
           "uuid": "c98711d1-5d29-4d2a-a042-f0d417710ad1",
           "to": [
             "default-domain",
             "central"
           ]
         }
       ],
       "parent_type": "domain",
       "uri": "/topology-service/region-dc/824fcb8c-5c1e-4873-bacf-17a4445a6c6f",
       "pop_refs": [
         {
           "uri": "/topology-service/pop/588ab293-ba6c-4f8f-a411-5aa9604c4f8c",
           "attr": null,
           "uuid": "588ab293-ba6c-4f8f-a411-5aa9604c4f8c",
           "to": [
             "default-domain",
             "regional"
           ]
         },
         {
           "uri": "/topology-service/pop/3e72c311-5f60-4376-8a88-737e2995c582",
           "attr": null,
           "uuid": "3e72c311-5f60-4376-8a88-737e2995c582",
           "to": [
             "default-domain",
             "sdwan-pop"
           ]
         }
       ],
       "properties": {
         "property": [
           {
             "value": "192.168.10.45",
             "name": "ip"
           },
           {
             "value": "192.168.10.0/24",
             "name": "csp_sbi_network_address"
           },
           {
             "value": "",
             "name": "device_reachable_ip"
           }
         ]
       }
     }
   }
   
   sed -i 's\192.168.10.0/24\192.168.64.0/24\g' change-net.json
   
   
   curl -k -X PUT https://192.168.10.42/topology-service/region-dc/$REGIONALID -H "Content-Type: application/json" -H "X-Auth-Token:$TOKEN" -d@change-net.json
   {"region-dc": {"uuid": "824fcb8c-5c1e-4873-bacf-17a4445a6c6f", "uri": "/topology-service/region-dc/824fcb8c-5c1e-4873-bacf-17a4445a6c6f"}}

   # review your changes by downloading again
   curl -k -X GET https://192.168.10.42/topology-service/region-dc/$REGIONALID  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq .
   

##

## MANDATORY!!! clean-up old IPsec config on MX80 from previous labs or attempts

##

.. code-block:: none

   root@mx80-1> edit
   Entering configuration mode

   [edit]
   root@mx80-1# delete groups ?
   Possible completions:
     <[Enter]>            Execute this command
     <group_name>         Group name
     ucpe                 Group name
     ucpetenant_ucpesite1  Group name
     vcpe                 Group name
     |                    Pipe through a command
   [edit]
   root@mx80-1# delete groups ucpetenant_ucpesite1

   [edit]
   root@mx80-1# delete apply-groups ?
   Possible completions:
     <[Enter]>            Execute this command
     <value>              Groups from which to inherit configuration data
     ucpe                 Groups from which to inherit configuration data
     ucpetenant_ucpesite1  Groups from which to inherit configuration data
     vcpe                 Groups from which to inherit configuration data
     |                    Pipe through a command
   [edit]
   root@mx80-1# delete apply-groups ucpetenant_ucpesite1

   [edit]
   root@mx80-1# commit
   commit complete

|image135|

|image136|

|image137|

|image138|

Password=”juniper123”

|image139|

|image140|

|image141|

|image142|

|image143|

|image144|

.. code-block:: none

   cat <<EOF > ucpe-pop.json
   {
       "input": {
           "job_name_prefix": "ucpe-pop",
           "pop": [
               {
                   "dc_name": "regional",
                   "device": [
                       {
                           "name": "mx80-1",
                           "family": "MX",
                           "internet_gateway": [
                               "192.168.67.67"
                           ],
                           "device_ip": "192.168.10.21",
                           "assigned_device_profile": "SDN-GW-MX",
                           "authentication": {
                               "password_based": {
                                   "username": "root",
                                   "password": "juniper123"
                               }
                           },
                           "management_state": "managed"
                       }
                   ],
                   "name": "ucpe-pop",
                   "address": {
                       "country": "US"
                   }
               }
           ]
       }
   }
   EOF 

The following Step in changing the Template is **MANDATORY FOR THIS LAB**. Without you may hit a bug that prevents provisioning to be completed.

|image145|

|image146|

|image147|

**Deactivate Use_single_SSH_to_NFX like above** and save.

|image148|

|image149|

|image150|

|image151|

.. code-block:: none

   cat <<EOF > ucpe-tenant.json
   {
       "input": {
           "tenant_admin": {
               "admin_user_name": "ucpetenant_admin@ucpetenant.com",
               "last_name": "Doe",
               "first_name": "Joe",
               "password_expiration_interval": 0
           },
           "tenant_type": "medium",
           "managed_wan_topology": {
               "network": [
                   {
                       "network_name": "ucpetenant_L3VPN"
                   }
               ]
           },
           "tenant_name": "ucpetenant",
           "default_ssl_proxy_profile": {
               "enabled": false
           },
           "password_expiration_radio": "never",
           "topology_type": "standalone",
           "properties": {
               "property": [
                   {
                       "name": "default-tenant-topology",
                       "value": "standalone"
                   }
               ]
           }
       }
   }
   EOF 

# Now change the tenant in the upper LEFT corner to ucpetenant

|image152|\ |image153|

-> Site -> Site Management

#

# You can't import a Json here so you have to manually

# AND do NOT ATTEMPT to AVOID this GUI config

#

|image154|

|image155|

|image156|

|image157|

The following step can be GUI or JSON again. So after the Site is created select the site and do “Configure Site” in the GUI (or import JSON)

|image158|

|image159|

|image160|

|image161|

|image162|

|image163|

-> Site -> Site Management -> Add -> Site upload

.. code-block:: none

   cat <<EOF > ucpe-device.json
   {
       "input": {
           "tenant_name": "ucpetenant",
           "job_name_prefix": "ucpetenant-ucpesite1",
           "site": [
               {
                   "hybrid_wan_site_info": {
                       "cpe_as_number": 65500,
                       "device_template_name": "NFX_deployment_option_1",
                       "region": "regional",
                       "device_name": "ucpesite1",
                       "device_details": {
                           "serial_number": "DD2316AF0103",
                           "activation_code": "888"
                       },
                       "access_info": {
                           "router_name": "mx80-1",
                           "router_as_number": 65410,
                           "wan_traffic": [
                               {
                                   "local_ip_prefix": "192.168.66.2/24",
                                   "wan_link_type": "MPLS",
                                   "remote_ip_prefix": "192.168.66.1/24",
                                   "local_interface": "ge-0/0/8",
                                   "ipsec_info": {},
                                   "wan_link_name": "WAN_0",
                                   "vlan_id": 66
                               },
                               {
                                   "local_ip_prefix": "192.168.99.2/24",
                                   "wan_link_type": "Internet",
                                   "remote_ip_prefix": "192.168.99.1/24",
                                   "local_interface": "ge-0/0/9",
                                   "vrf_name": "VRFWAN",
                                   "ipsec_info": {
                                       "ipsec_concentrator_name": "mx80-1",
                                       "internet_gw_ip": "192.168.67.67"
                                   },
                                   "wan_link_name": "WAN_1"
                               }
                           ],
                           "oam_traffic": {
                               "ip_prefix": "192.168.65.2/24",
                               "gateway_ip": "192.168.65.1",
                               "vlan_id": 65
                           }
                       }
                   },
                   "site_name": "ucpesite1",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }
   EOF 

This setup does not need to be performed. Only if you which to change the activation code again prior you need to perform an device-activation in CSO

|image164|

# Use a Browser to watch the phone home client

http://192.168.10.24

|image165|

Enter “888”

|image166|

|image167|

|image168|

This entire process lasts ~15-20minutes and most time is spend on waiting the vSRX to boot up.

|image169|

You can ssh meanwhile to the nfx250 and have a look around what happens.

/\* fixme add comments on the things we are seeing there \*/

.. code-block:: none

   
   root@nfx250-1:~# route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.67.1    0.0.0.0         UG    0      0        0 jsxe0.0
   10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 phc
   128.0.0.0       0.0.0.0         255.255.0.0     U     0      0        0 bme2
   192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 bme1
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 jmgmt0
   192.168.67.0    0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.0
   root@nfx250-1:~# ifconfig
   bme1      Link encap:Ethernet  HWaddr 52:54:00:a7:ea:36
             inet addr:192.168.1.254  Bcast:192.168.1.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fea7:ea36/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:36328 errors:0 dropped:0 overruns:0 frame:0
             TX packets:12200 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:3931899 (3.9 MB)  TX bytes:847132 (847.1 KB)
   
   bme2      Link encap:Ethernet  HWaddr 52:54:00:4b:dd:31
             inet addr:128.0.0.254  Bcast:128.0.255.255  Mask:255.255.0.0
             inet6 addr: fe80::5054:ff:fe4b:dd31/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:21 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:1506 (1.5 KB)  TX bytes:648 (648.0 B)
   
   jmgmt0    Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cb
             inet addr:192.168.10.24  Bcast:192.168.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:5427702 errors:0 dropped:72 overruns:0 frame:0
             TX packets:7485 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:1800836190 (1.8 GB)  TX bytes:937950 (937.9 KB)
   
   jsxe0     Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:1325 errors:0 dropped:0 overruns:0 frame:0
             TX packets:850 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:95718 (95.7 KB)  TX bytes:280345 (280.3 KB)
   
   jsxe0.0   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:192.168.65.2  Bcast:192.168.65.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:34 errors:0 dropped:0 overruns:0 frame:0
             TX packets:31 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:4869 (4.8 KB)  TX bytes:8731 (8.7 KB)
   
   jsxe0.4001 Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:10.10.0.100  Bcast:10.10.0.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:7 errors:0 dropped:0 overruns:0 frame:0
             TX packets:5 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:322 (322.0 B)  TX bytes:438 (438.0 B)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:4511 errors:0 dropped:0 overruns:0 frame:0
             TX packets:4511 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:351247 (351.2 KB)  TX bytes:351247 (351.2 KB)
   
   phc       Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cd
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:1615 errors:0 dropped:0 overruns:0 frame:0
             TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:199487 (199.4 KB)  TX bytes:0 (0.0 B)
   
   root@nfx250-1:~# route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   10.10.0.0       0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.4001
   128.0.0.0       0.0.0.0         255.255.0.0     U     0      0        0 bme2
   192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 bme1
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 jmgmt0
   192.168.64.0    192.168.65.1    255.255.255.0   UG    0      0        0 jsxe0.0
   192.168.65.0    0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.0
   root@nfx250-1:~# ping 192.168.64.45
   PING 192.168.64.45 (192.168.64.45) 56(84) bytes of data.
   64 bytes from 192.168.64.45: icmp_seq=1 ttl=63 time=0.691 ms
   64 bytes from 192.168.64.45: icmp_seq=2 ttl=63 time=0.827 ms
   64 bytes from 192.168.64.45: icmp_seq=3 ttl=63 time=0.530 ms
   ^C
   --- 192.168.64.45 ping statistics ---
   3 packets transmitted, 3 received, 0% packet loss, time 1999ms
   rtt min/avg/max/mdev = 0.530/0.682/0.827/0.125 ms
   root@nfx250-1:~# ifconfig
   bme1      Link encap:Ethernet  HWaddr 52:54:00:a7:ea:36
             inet addr:192.168.1.254  Bcast:192.168.1.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fea7:ea36/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:36471 errors:0 dropped:0 overruns:0 frame:0
             TX packets:12203 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:3948573 (3.9 MB)  TX bytes:847258 (847.2 KB)
   
   bme2      Link encap:Ethernet  HWaddr 52:54:00:4b:dd:31
             inet addr:128.0.0.254  Bcast:128.0.255.255  Mask:255.255.0.0
             inet6 addr: fe80::5054:ff:fe4b:dd31/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:22 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:1570 (1.5 KB)  TX bytes:648 (648.0 B)
   
   jmgmt0    Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cb
             inet addr:192.168.10.24  Bcast:192.168.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:5571885 errors:0 dropped:72 overruns:0 frame:0
             TX packets:7671 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:1848649996 (1.8 GB)  TX bytes:955521 (955.5 KB)
   
   jsxe0     Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:1390 errors:0 dropped:0 overruns:0 frame:0
             TX packets:857 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:99970 (99.9 KB)  TX bytes:281127 (281.1 KB)
   
   jsxe0.0   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:192.168.65.2  Bcast:192.168.65.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:90 errors:0 dropped:0 overruns:0 frame:0
             TX packets:38 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:7537 (7.5 KB)  TX bytes:9513 (9.5 KB)
   
   jsxe0.4001 Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:10.10.0.100  Bcast:10.10.0.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:16 errors:0 dropped:0 overruns:0 frame:0
             TX packets:5 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:736 (736.0 B)  TX bytes:438 (438.0 B)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:4531 errors:0 dropped:0 overruns:0 frame:0
             TX packets:4531 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:352247 (352.2 KB)  TX bytes:352247 (352.2 KB)
   
   phc       Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cd
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:1615 errors:0 dropped:0 overruns:0 frame:0
             TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:199487 (199.4 KB)  TX bytes:0 (0.0 B)
   
   root@nfx250-1:~# ifconfig
   bme1      Link encap:Ethernet  HWaddr 52:54:00:a7:ea:36
             inet addr:192.168.1.254  Bcast:192.168.1.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fea7:ea36/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:36682 errors:0 dropped:0 overruns:0 frame:0
             TX packets:12283 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:3971755 (3.9 MB)  TX bytes:854066 (854.0 KB)
   
   bme2      Link encap:Ethernet  HWaddr 52:54:00:4b:dd:31
             inet addr:128.0.0.254  Bcast:128.0.255.255  Mask:255.255.0.0
             inet6 addr: fe80::5054:ff:fe4b:dd31/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:22 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:1570 (1.5 KB)  TX bytes:648 (648.0 B)
   
   jmgmt0    Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cb
             inet addr:192.168.10.24  Bcast:192.168.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:6133112 errors:0 dropped:72 overruns:0 frame:0
             TX packets:343271 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:4591626204 (4.5 GB)  TX bytes:23108770 (23.1 MB)
   
   jsxe0     Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:1491 errors:0 dropped:0 overruns:0 frame:0
             TX packets:938 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:123342 (123.3 KB)  TX bytes:305713 (305.7 KB)
   
   jsxe0.0   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:192.168.65.2  Bcast:192.168.65.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:181 errors:0 dropped:0 overruns:0 frame:0
             TX packets:119 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:28631 (28.6 KB)  TX bytes:34099 (34.0 KB)
   
   jsxe0.4001 Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:10.10.0.100  Bcast:10.10.0.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:26 errors:0 dropped:0 overruns:0 frame:0
             TX packets:5 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:1196 (1.1 KB)  TX bytes:438 (438.0 B)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:4549 errors:0 dropped:0 overruns:0 frame:0
             TX packets:4549 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:353147 (353.1 KB)  TX bytes:353147 (353.1 KB)
   
   phc       Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cd
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:1615 errors:0 dropped:0 overruns:0 frame:0
             TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:199487 (199.4 KB)  TX bytes:0 (0.0 B)
   
   root@nfx250-1:~# virsh list --all
    Id    Name                           State
   ----------------------------------------------------
    2     vjunos0                        running
   
   root@nfx250-1:~# cd /var/third-party/
   root@nfx250-1:/var/third-party# ls -l
   total 118224
   drwxr-xr-x  3 root root      4096 Mar 22 08:08 CSP
   drwxr-xr-x  2 root root      4096 Mar 21 21:05 images
   drwxr-xr-x  2 root root      4096 Mar 22 06:36 ipsecnm-config
   lrwxrwxrwx  1 root root        52 Mar 21 21:02 ipsecnm.img -> /var/third-party//ipsec-ssd-builder:18May17-1822.img
   drwxr-xr-x  2 root root      4096 Mar 21 21:05 ipsecnm-varlog
   -rw-r--r--  1 root root 120993792 Jun 23  2017 ipsec-ssd-builder:18May17-1822.img
   -rw-r--r--  1 root root      2036 Jun 23  2017 ipsec.xml
   drwxr-xr-x  2 root root      4096 Mar 22 08:09 jdm-config
   drwxr-xr-x 19 root root      4096 Mar 22 08:03 jdm-var
   drwx------  2 root root     16384 Mar 21 21:01 lost+found
   -rw-r--r--  1 root root      4261 Jun 23  2017 vm-template.xml
   -rw-r--r--  1 root root      1260 Mar 21 21:05 __vnf_init_default__.xml
   -rw-r--r--  1 root root      6094 Mar 21 21:03 vsrx.xml
   root@nfx250-1:/var/third-party# cd CSP/GWR.DD2316AF0103.ucpesite1.ucpetenant/
   root@nfx250-1:/var/third-party/CSP/GWR.DD2316AF0103.ucpesite1.ucpetenant# ls -l
   total 3216236
   -rw-r--r-- 1 root root     366592 Mar 22 08:05 bootstrap_cfg.iso
   -rw-r--r-- 1 root root 3293052928 Mar 19 13:30 media-vsrx-vmdisk-15.1X49-D125.3.qcow2
   root@nfx250-1:/var/third-party/CSP/GWR.DD2316AF0103.ucpesite1.ucpetenant# cd /root/
   root@nfx250-1:~# virsh list --all
    Id    Name                           State
   ----------------------------------------------------
    2     vjunos0                        running
    3     GWR.DD2316AF0103.ucpesite1.ucpetenant running
   
   root@nfx250-1:~# virsh console  GWR.DD2316AF0103.ucpesite1.ucpetenant
   Connected to domain GWR.DD2316AF0103.ucpesite1.ucpetenant
   Escape character is ^]
   Consoles: serial port
   BIOS drive C: is disk0
   BIOS drive D: is disk1
   BIOS drive E: is disk2
   BIOS drive F: is disk3
   BIOS drive G: is disk4
   BIOS 639kB/999416kB available memory
   
   FreeBSD/i386 bootstrap loader, Revision 1.2
   (builder@ralenth.juniper.net, Fri Feb  9 07:47:10  2018)
   Loading /boot/defaults/loader.conf
   /kernel text=0xa76f44 data=0x63f9c+0x1214c4 syms=[0x4+0xb6240+0x4+0x10b961]
   /boot/modules/libmbpool.ko text=0xce8 data=0x114 \
   /boot/modules/if_em_vsrx.ko text=0x186dc data=0x840+0x1a4 |
   /boot/modules/virtio.ko text=0x2168 data=0x208 syms=[0x4+0x7f0+0x4+0x972]
   /boot/modules/virtio_pci.ko text=0x2de8 data=0x200+0x8 syms=[0x4+0x900+0x4+0xb22]
   /boot/modules/virtio_blk.ko text=0x299c data=0x1dc+0xc syms=[0x4+0x970+0x4+0xa0f]
   /boot/modules/if_vtnet.ko text=0x61bc data=0x344+0x10 syms=[0x4+0xe20+0x4+0xf2f]
   /boot/modules/pci_hgcomm.ko text=0x12fc data=0x1a4+0x44 syms=[0x4+0x570+0x4+0x61d]
   /boot/modules/pvi_db.ko text=0x27f8 data=0x316+0x2e syms=[0x4+0x610+0x4+0x5be]
   /boot/modules/chassis.ko text=0x9bc data=0x1d4+0x10 syms=[0x4+0x3a0+0x4+0x399]
   
   
   Hit [Enter] to boot immediately, or space bar for command prompt.
   Booting [/kernel]...
   platform_early_bootinit: Early Boot Initialization
   tvp mode is true  jnx_reboot_reason: 16384
   mac base ff:ff:ff:ff:ff:ff len 255
   GDB: debug ports: sio
   GDB: current port: sio
   KDB: debugger backends: ddb gdb
   KDB: current backend: ddb
   Copyright (c) 1996-2018, Juniper Networks, Inc.
   All rights reserved.
   Copyright (c) 1992-2007 The FreeBSD Project.
   Copyright (c) 1979, 1980, 1983, 1986, 1988, 1989, 1991, 1992, 1993, 1994
           The Regents of the University of California. All rights reserved.
   FreeBSD is a registered trademark of The FreeBSD Foundation.
   JUNOS 15.1X49-D125.3 #0: 2018-02-09 08:55:18 UTC
       builder@ralenth.juniper.net:/volume/build/junos/15.1/service/15.1X49-D125.3/obj/i386/junos/bsd/kernels/SRXJCP/kernel
   Timecounter "i8254" frequency 1193182 Hz quality 0
   CPU: Intel Core Processor (Haswell) (1909.69-MHz 686-class CPU)
     Origin = "GenuineIntel"  Id = 0x306c1  Stepping = 1
     Features=0xf8bfbff<FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV,PAT,PSE36,CLFLUSH,MMX,FXSR,SSE,SSE2,SS>
     Features2=0xf7fa3203<SSE3,<b1>,SSSE3,<b12>,CX16,<b17>,SSE4.1,SSE4.2,x2APIC,MOVBE,POPCNT,<b24>,<b25>,XSAVE,<b28>,<b29>,<b30>,<b31>>
     AMD Features=0x20100800<SYSCALL,NX,LM>
     AMD Features2=0x121<LAHF,ABM,Prefetch>
   real memory  = 1024458752 (977 MB)
   avail memory = 986316800 (940 MB)
   ACPI APIC Table: <BOCHS  BXPCAPIC>
   tvp mode is true  jnx_reboot_reason: 16384
   mac base ff:ff:ff:ff:ff:ff len 255
   Security policy loaded: Junos MAC/veriexec (mac_veriexec)
   MAC/veriexec fingerprint module loaded: SHA256
   MAC/veriexec fingerprint module loaded: SHA1
   ioapic0 <Version 1.1> irqs 0-23 on motherboard
   Initializing SRXTVP platform properties ..
   
   pci-hgcomdev module loadedacpi0: <BOCHS BXPCRSDT> on motherboard
   acpi0: Power Button (fixed)
   Timecounter "ACPI-safe" frequency 3579545 Hz quality 1000
   acpi_timer0: <24-bit timer at 3.579545MHz> port 0xb008-0xb00b on acpi0
   pcib0: <ACPI Host-PCI bridge> port 0xcf8-0xcff on acpi0
   pci0: <ACPI PCI bus> on pcib0
   isab0: <PCI-ISA bridge> at device 1.0 on pci0
   isa0: <ISA bus> on isab0
   atapci0: <Intel PIIX3 WDMA2 controller> port 0x1f0-0x1f7,0x3f6,0x170-0x177,0x376,0xc200-0xc20f at device 1.1 on pci0
   ata0: <ATA channel 0> on atapci0
   ata1: <ATA channel 1> on atapci0
   uhci0: <Intel 82371SB (PIIX3) USB controller> port 0xc180-0xc19f irq 11 at device 1.2 on pci0
   usb0: <Intel 82371SB (PIIX3) USB controller> on uhci0
   usb0: USB revision 1.0
   uhub0: Intel UHCI root hub, class 9/0, rev 1.00/1.00, addr 1
   uhub0: 2 ports with 2 removable, self powered
   smb0: <Intel 82371AB SMB controller> irq 9 at device 1.3 on pci0
   virtio_pci0: <VirtIO PCI Network adapter> port 0xc1a0-0xc1bf mem 0xfebe0000-0xfebe0fff irq 11 at device 3.0 on pci0
   em0: <VirtIO Networking Adapter> on virtio_pci0
   virtio_pci0: host features: 0x719fffe3 <EventIdx,RingIndirect,NotifyOnEmpty,0x800000,RxModeExtra,VLanFilter,RxMode,ControlVq,Status,MrgRxBuf,TxUFO,TxTSOECN,TxTSOv6,TxTSOv4,RxUFO,RxECN,RxTSOv6,RxTSOv4,TxAllGSO,MacAddress,RxChecksum,TxChecksum>
   virtio_pci0: negotiated features: 0x110f8020 <RingIndirect,NotifyOnEmpty,VLanFilter,RxMode,ControlVq,Status,MrgRxBuf,MacAddress>
   virtio_pci1: <VirtIO PCI Network adapter> port 0xc1c0-0xc1df mem 0xfebe1000-0xfebe1fff irq 11 at device 4.0 on pci0
   em1: <VirtIO Networking Adapter> on virtio_pci1
   virtio_pci1: host features: 0x719fffe3 <EventIdx,RingIndirect,NotifyOnEmpty,0x800000,RxModeExtra,VLanFilter,RxMode,ControlVq,Status,MrgRxBuf,TxUFO,TxTSOECN,TxTSOv6,TxTSOv4,RxUFO,RxECN,RxTSOv6,RxTSOv4,TxAllGSO,MacAddress,RxChecksum,TxChecksum>
   virtio_pci1: negotiated features: 0x110f8020 <RingIndirect,NotifyOnEmpty,VLanFilter,RxMode,ControlVq,Status,MrgRxBuf,MacAddress>
   virtio_pci2: <VirtIO PCI Network adapter> port 0xc1e0-0xc1ff mem 0xfebe2000-0xfebe2fff irq 10 at device 5.0 on pci0
   em2: <VirtIO Networking Adapter> on virtio_pci2
   virtio_pci2: host features: 0x719fffe3 <EventIdx,RingIndirect,NotifyOnEmpty,0x800000,RxModeExtra,VLanFilter,RxMode,ControlVq,Status,MrgRxBuf,TxUFO,TxTSOECN,TxTSOv6,TxTSOv4,RxUFO,RxECN,RxTSOv6,RxTSOv4,TxAllGSO,MacAddress,RxChecksum,TxChecksum>
   virtio_pci2: negotiated features: 0x110f8020 <RingIndirect,NotifyOnEmpty,VLanFilter,RxMode,ControlVq,Status,MrgRxBuf,MacAddress>
   virtio_pci3: <VirtIO PCI Block adapter> port 0xc000-0xc03f mem 0xfebe3000-0xfebe3fff irq 10 at device 6.0 on pci0
   vtblk0: <VirtIO Block Adapter> on virtio_pci3
   virtio_pci3: host features: 0x71000cd4 <EventIdx,RingIndirect,NotifyOnEmpty,0x800,Topology,SCSICmds,BlockSize,DiskGeometry,MaxNumSegs>
   virtio_pci3: negotiated features: 0x10000054 <RingIndirect,BlockSize,DiskGeometry,MaxNumSegs>
   vtblk0: 509MB (1044288 512 byte sectors)
   virtio_pci4: <VirtIO PCI Block adapter> port 0xc040-0xc07f mem 0xfebe4000-0xfebe4fff irq 11 at device 7.0 on pci0
   vtblk1: <VirtIO Block Adapter> on virtio_pci4
   virtio_pci4: host features: 0x71000ed4 <EventIdx,RingIndirect,NotifyOnEmpty,0x800,Topology,FlushCmd,SCSICmds,BlockSize,DiskGeometry,MaxNumSegs>
   virtio_pci4: negotiated features: 0x10000254 <RingIndirect,FlushCmd,BlockSize,DiskGeometry,MaxNumSegs>
   vtblk1: 3072MB (6291456 512 byte sectors)
   virtio_pci5: <VirtIO PCI Block adapter> port 0xc080-0xc0bf mem 0xfebe5000-0xfebe5fff irq 11 at device 8.0 on pci0
   vtblk2: <VirtIO Block Adapter> on virtio_pci5
   virtio_pci5: host features: 0x71000ed4 <EventIdx,RingIndirect,NotifyOnEmpty,0x800,Topology,FlushCmd,SCSICmds,BlockSize,DiskGeometry,MaxNumSegs>
   virtio_pci5: negotiated features: 0x10000254 <RingIndirect,FlushCmd,BlockSize,DiskGeometry,MaxNumSegs>
   vtblk2: 102MB (209715 512 byte sectors)
   virtio_pci6: <VirtIO PCI Block adapter> port 0xc0c0-0xc0ff mem 0xfebe6000-0xfebe6fff irq 10 at device 9.0 on pci0
   vtblk3: <VirtIO Block Adapter> on virtio_pci6
   virtio_pci6: host features: 0x71000ed4 <EventIdx,RingIndirect,NotifyOnEmpty,0x800,Topology,FlushCmd,SCSICmds,BlockSize,DiskGeometry,MaxNumSegs>
   virtio_pci6: negotiated features: 0x10000254 <RingIndirect,FlushCmd,BlockSize,DiskGeometry,MaxNumSegs>
   vtblk3: 128MB (262144 512 byte sectors)
   virtio_pci7: <VirtIO PCI Block adapter> port 0xc100-0xc13f mem 0xfebe7000-0xfebe7fff irq 10 at device 10.0 on pci0
   vtblk4: <VirtIO Block Adapter> on virtio_pci7
   virtio_pci7: host features: 0x71000ed4 <EventIdx,RingIndirect,NotifyOnEmpty,0x800,Topology,FlushCmd,SCSICmds,BlockSize,DiskGeometry,MaxNumSegs>
   virtio_pci7: negotiated features: 0x10000254 <RingIndirect,FlushCmd,BlockSize,DiskGeometry,MaxNumSegs>
   vtblk4: 614MB (1259059 512 byte sectors)
   em3: <Intel(R) PRO/1000 Network Connection Version - 3.2.18> port 0xc140-0xc17f mem 0xfebc0000-0xfebdffff irq 11 at device 16.0 on pci0
   em3: Memory Access and/or Bus Master bits were not set!
   hgcommdev0: <HGCOMMDEV For Host VM communication> mem 0xfebe8000-0xfebe8fff at device 22.0 on pci0
   hgcommdev0: hgcommdev: registers at 0xdf889000
   cpu0: <ACPI CPU> on acpi0
   atkbdc0: <Keyboard controller (i8042)> port 0x60,0x64 irq 1 on acpi0
   atkbd0: <AT Keyboard> irq 1 on atkbdc0
   kbd0 at atkbd0
   psm0: <PS/2 Mouse> irq 12 on atkbdc0
   psm0: model IntelliMouse Explorer, device ID 4
   sio0: <16550A-compatible COM port> port 0x3f8-0x3ff irq 4 flags 0x90 on acpi0
   sio0: type 16550A, console
   orm0: <ISA Option ROM> at iomem 0xe5800-0xeffff on isa0
   vga0: <Generic ISA VGA> at port 0x3b0-0x3bb iomem 0xb0000-0xb7fff on isa0
   sc0: <System console> at flags 0x100 on isa0
   sc0: MDA <16 virtual consoles, flags=0x300>
   sio1: configured irq 5 not in bitmap of probed irqs 0
   sio1: port may not be enabled
   sio2: configured irq 3 not in bitmap of probed irqs 0
   sio2: port may not be enabled
   sio3: configured irq 7 not in bitmap of probed irqs 0
   sio3: port may not be enabled
   tvp mode is true  jnx_reboot_reason: 16384
   mac base ff:ff:ff:ff:ff:ff len 255
   TVP: Model Name read from HostOS is vsrx
   Initializing product: 192 ..
   fxp0: bus=0, device=16, func=0, Ethernet address f4:cc:55:2b:58:ce
   fxp0 MAC address f4:cc:55:2b:58:ce
   Timecounter "TSC" frequency 1909694500 Hz quality 800
   Registered AMT tunnel Encap with UDP Tunnel!
    Loading Redundant LT driver
   ###PCB Group initialized for udppcbgroup
   ###PCB Group initialized for tcppcbgroup
   Loading JUNOS chassis module
   chassis_init_hw_chassis_startup_time: chassis startup time 0.000000
   Kernel thread "wkupdaemon" (pid 53) exited prematurely.
   Trying to mount root from ufs:/dev/vtbd0s1a
   Attaching /cf/packages/junos via /dev/mdctl...
   Mounted junos package on /dev/md0...
   
   Automatic reboot in progress...
   ** /dev/vtbd0s1a
   FILE SYSTEM CLEAN; SKIPPING CHECKS
   clean, 72643 free (3 frags, 18160 blocks, 0.0% fragmentation)
   Verified jboot signed by PackageProductionEc_2018 method ECDSA256+SHA256
   Verified junos signed by PackageProductionEc_2018 method ECDSA256+SHA256
   Verified junos-srxjcp-15.1X49-D125.3-domestic signed by PackageProductionEc_2018 method ECDSA256+SHA256
   Detected data disk
   Formatting data disk /dev/vtbd1
   /dev/vtbd1s1e: 307.2MB (629080 sectors) block size 16384, fragment size 2048
           using 4 cylinder groups of 76.80MB, 4915 blks, 9856 inodes.
   super-block backups (for fsck -b #) at:
    32, 157312, 314592, 471872
   /dev/vtbd1s1f: 2764.5MB (5661764 sectors) block size 16384, fragment size 2048
           using 16 cylinder groups of 183.69MB, 11756 blks, 23552 inodes.
   super-block backups (for fsck -b #) at:
    32, 376224, 752416, 1128608, 1504800, 1880992, 2257184, 2633376, 3009568,
    3385760, 3761952, 4138144, 4514336, 4890528, 5266720, 5642912
   cp: /config/*: No such file or directory
   sed: /etc/fstab: Read-only file system
   ** /dev/vtbd1s1e
   FILE SYSTEM CLEAN; SKIPPING CHECKS
   clean, 154731 free (27 frags, 19338 blocks, 0.0% fragmentation)
   ** /dev/vtbd1s1f
   FILE SYSTEM CLEAN; SKIPPING CHECKS
   clean, 1391622 free (22 frags, 173950 blocks, 0.0% fragmentation)
   remount /config...success
   remount /var...success
   Initialize /var subdirs...
   Mounting shared partition /var/host ..
   ***Creating /var/host directory
   Detected swap drive
   Enable swap
   *** Creating PVIDb..\n
   1247+0 records in
   1247+0 records out
   648440 bytes transferred in 0.797286 secs (813309 bytes/sec)
   Copied libschema-filter-dd.tlv to /opt/lib/dd/filter\n
   Executing the Junos host files signature script
   Verified manifest signed by PackageDevelopmentEc_2018 method ECDSA256+SHA256
   hw.re.gres_sync_other: 0 -> 1
   hw.re.gres_sync_other: 1 -> 0
   Found junos config on shared disk. Override the existing one!
   vmguest: setup ...
   vmguest: Found smbios variables, skipping reboot.
   Loading configuration ...
   mgd: Running FIPS Self-tests
   veriexec: no fingerprint for file='/sbin/kats/cannot-exec' fsid=81 fileid=2465996 gen=1 uid=0 pid=853
   mgd: FIPS Self-tests Passed
   Generating RSA key /etc/ssh/ssh_host_key
   Generating public/private rsa1 key pair.
   Your identification has been saved in /etc/ssh/ssh_host_key.
   Your public key has been saved in /etc/ssh/ssh_host_key.pub.
   The key fingerprint is:
   SHA256:xeGROWvjumzDYM7elcAJtvAnvmx3RQGWvMQBDvW/QAA root@GWR.DD2316AF0103.ucpesite1.ucpetenant
   The key's randomart image is:
   +---[RSA1 2048]---+
   |      Eo++**     |
   |       o *Oo.    |
   |    . o ..*+ .   |
   |     + + +=..    |
   |      + So.o.    |
   |     .oo ..o..   |
   |     +.o .o..    |
   |     .++*..      |
   |     o+o++       |
   +----[SHA256]-----+
   Generating DSA key /etc/ssh/ssh_host_dsa_key
   Generating public/private dsa key pair.
   Your identification has been saved in /etc/ssh/ssh_host_dsa_key.
   Your public key has been saved in /etc/ssh/ssh_host_dsa_key.pub.
   The key fingerprint is:
   SHA256:BAidi5eYmrn3XBqRRbil/4F/TCupwtLXJRedK2i3Cew root@GWR.DD2316AF0103.ucpesite1.ucpetenant
   The key's randomart image is:
   +---[DSA 1024]----+
   |  .o +o          |
   |    =...         |
   |   + *. .  . .   |
   |  + *o .  . o    |
   | + .o. oS. . .   |
   |+    .o B * .    |
   | . o. .* @ =     |
   |. o.++. E *      |
   | . o+o.. o       |
   +----[SHA256]-----+
   Generating RSA2 key /etc/ssh/ssh_host_rsa_key
   Generating public/private rsa key pair.
   Your identification has been saved in /etc/ssh/ssh_host_rsa_key.
   Your public key has been saved in /etc/ssh/ssh_host_rsa_key.pub.
   The key fingerprint is:
   SHA256:TACt5AYg3uDl3kuNMOS/7dSVfj22kJz+Zf1+SXeFHXI root@GWR.DD2316AF0103.ucpesite1.ucpetenant
   The key's randomart image is:
   +---[RSA 2048]----+
   |oo o.o.          |
   |+ O . ..     . E |
   | o X .  .     oo.|
   |  . O oo    . . o|
   |   o = .S  o    .|
   |    . + . o . +.+|
   |     o o . . *.+B|
   |      o     o oo*|
   |       .     ..++|
   +----[SHA256]-----+
   Generating ECDSA key /etc/ssh/ssh_host_ecdsa_key
   Generating public/private ecdsa key pair.
   Your identification has been saved in /etc/ssh/ssh_host_ecdsa_key.
   Your public key has been saved in /etc/ssh/ssh_host_ecdsa_key.pub.
   The key fingerprint is:
   SHA256:KVbD92SeeHY3ddipNwdVP1PKDIxZYByZrx9oNat6t6M root@GWR.DD2316AF0103.ucpesite1.ucpetenant
   The key's randomart image is:
   +---[ECDSA 256]---+
   |         .+Xo   =|
   |       . .* .+ =+|
   |        + ..o *+=|
   |       . + *+...=|
   |      o S .+*+.+o|
   |     . .  +oo...+|
   |         . o .   |
   |          o +    |
   |        .oEo.o   |
   +----[SHA256]-----+
   Generating ED25519 key /etc/ssh/ssh_host_ed25519_key
   Generating public/private ed25519 key pair.
   Your identification has been saved in /etc/ssh/ssh_host_ed25519_key.
   Your public key has been saved in /etc/ssh/ssh_host_ed25519_key.pub.
   The key fingerprint is:
   SHA256:CIWGUiNZYKGZqHbBnM4Q0pt/HIo2t3jInrEJE2apelo root@GWR.DD2316AF0103.ucpesite1.ucpetenant
   The key's randomart image is:
   +--[ED25519 256]--+
   |+X=. ..          |
   |B+*.+.           |
   |=o O.            |
   |. B ....         |
   |o= * o..S        |
   |=.= + o          |
   |+oE= o           |
   |.+==o            |
   |o+=.             |
   +----[SHA256]-----+
   mgd: commit complete
   Setting initial options: .
   Starting optional daemons:  usbd.
   Doing initial network setup:.
   Initial interface configuration:
   vmtype is 0
   additional daemons: eventd.
   checking for core dump...
   savecore: Reboot reason(s): 0x4000: VJUNOS reboot
   savecore: Reboot reason(s): 0x4000: VJUNOS reboot
   savecore: no dumps found
   Additional routing options:kern.module_path: /boot//kernel;/boot/modules -> /boot/modules;/modules/peertype;/modules/ifpfe_drv;/modules/platform;/modules;
   kld netpfe drv: ifpfed_ep ifpfed_esp ifpfed_ism ifpfed_ml_ha ifpfed_ppeer ifpfed_ps ifpfed_st ifpfed_vtkld platform: fileassoc if_em_vsrx if_vtnet virtio virtio_blk virtio_console virtio_pcikld peertype: peertype_fwdd peertype_pfpc grat_arp_delay=1: net.link.ether.inet.grat_arp_delay: 1 -> 1
    ipsec kldcryptosoft0: <software crypto> on motherboard
    kats kldIPsec: Initialized Security Association Processing.
    resrsv.
   Doing additional network setup: ipv6_security=YES.
   Starting final network daemons:.
   setting ldconfig path: /usr/lib /opt/lib
   starting standard daemons: cron.
   Initial rc.i386 initialization:.
   Local package initialization:.
   starting local daemons:set cores for group access
   .
   kern.securelevel: -1 -> 1
   kern.timecounter.hardware: ACPI-safe -> TSC
   kern.maxfiles: 1500 -> 10500
   kern.maxfilesperproc: 1500 -> 10500
   Configuring from config-drive ...
   mount_msdosfs: /dev/vtbd2: Invalid argument
   sed: /config/config_mnt/openstack/latest/meta_data.json: No such file or directory
   umount: /config/config_mnt: not a file system root directory
   The machine id is empty.
   Cleaning up ...
   Thu Mar 22 08:17:23 UTC 2018
   
   GWR.DD2316AF0103.ucpesite1.ucpetenant (ttyd0)
   
   login: root
   Password:
   
   --- JUNOS 15.1X49-D125.3 built 2018-02-09 08:55:18 UTC
   root@GWR% cli
   root@GWR.DD2316AF0103.ucpesite1.ucpetenant> show route
   
   inet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Access-internal/12] 00:13:23
                       > to 192.168.1.1 via fxp0.0
   192.168.0.0/24     *[Direct/0] 00:13:30
                       > via lo0.0
   192.168.0.1/32     *[Local/0] 00:13:30
                         Local via lo0.0
   192.168.1.0/24     *[Direct/0] 00:13:23
                       > via fxp0.0
   192.168.1.100/32   *[Local/0] 00:13:23
                         Local via fxp0.0
   192.168.64.0/24    *[Static/5] 00:13:30
                         to table trust.inet.0
   
   internet.inet.0: 3 destinations, 3 routes (3 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Access-internal/12] 00:13:00
                       > to 192.168.67.1 via ge-0/0/3.0
   192.168.67.0/24    *[Direct/0] 00:13:00
                       > via ge-0/0/3.0
   192.168.67.6/32    *[Local/0] 00:13:00
                         Local via ge-0/0/3.0
   
   trust.inet.0: 17 destinations, 18 routes (17 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:13:00, localpref 100
                         AS path: 65410 I, validation-state: unverified
                       > to 192.168.66.1 via ge-0/0/2.0
                       [BGP/170] 00:08:40, MED 200, localpref 100
                         AS path: 65410 I, validation-state: unverified
                       > to 192.168.99.1 via st0.1
   10.10.0.0/24       *[Direct/0] 00:13:07
                       > via ge-0/0/4.0
   10.10.0.2/32       *[Local/0] 00:13:09
                         Local via ge-0/0/4.0
   10.10.12.0/24      *[Direct/0] 00:13:07
                       > via ge-0/0/5.0
   10.10.12.2/32      *[Local/0] 00:13:09
                         Local via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:13:07
                       > via ge-0/0/6.0
   10.10.13.2/32      *[Local/0] 00:13:09
                         Local via ge-0/0/6.0
   192.168.0.0/24     *[Direct/0] 00:13:30
                       > via lo0.0
   192.168.0.1/32     *[Local/0] 00:13:30
                         Local via lo0.0
   192.168.64.0/24    *[Static/5] 00:13:07
                       > to 192.168.65.1 via ge-0/0/1.0
   192.168.65.0/24    *[Direct/0] 00:13:07
                       > via ge-0/0/1.0
   192.168.65.4/32    *[Local/0] 00:13:09
                         Local via ge-0/0/1.0
   192.168.66.0/24    *[Direct/0] 00:13:07
                       > via ge-0/0/2.0
   192.168.66.2/32    *[Local/0] 00:13:09
                         Local via ge-0/0/2.0
   192.168.99.0/24    *[Direct/0] 00:08:44
                       > via st0.1
   192.168.99.2/32    *[Local/0] 00:09:55
                         Local via st0.1
   224.0.0.5/32       *[OSPF/10] 00:13:37, metric 1
                         MultiRecv
   
   root@GWR.DD2316AF0103.ucpesite1.ucpetenant> show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   ge-0/0/0                up    up
   gr-0/0/0                up    up
   ip-0/0/0                up    up
   lsq-0/0/0               up    up
   lt-0/0/0                up    up
   mt-0/0/0                up    up
   sp-0/0/0                up    up
   sp-0/0/0.0              up    up   inet
                                      inet6
   sp-0/0/0.16383          up    up   inet
   ge-0/0/1                up    up
   ge-0/0/1.0              up    up   inet     192.168.65.4/24
   ge-0/0/2                up    up
   ge-0/0/2.0              up    up   inet     192.168.66.2/24
   ge-0/0/3                up    up
   ge-0/0/3.0              up    up   inet     192.168.67.6/24
   ge-0/0/4                up    up
   ge-0/0/4.0              up    up   inet     10.10.0.2/24
   ge-0/0/5                up    up
   ge-0/0/5.0              up    up   inet     10.10.12.2/24
   ge-0/0/6                up    up
   ge-0/0/6.0              up    up   inet     10.10.13.2/24
   ge-0/0/7                up    up
   ge-0/0/8                up    up
   dsc                     up    up
   em0                     up    up
   em0.0                   up    up   inet     128.0.0.1/2
   em1                     up    up
   em1.32768               up    up   inet     192.168.1.2/24
   em2                     up    up
   fxp0                    up    up
   fxp0.0                  up    up   inet     192.168.1.100/24
   gre                     up    up
   ipip                    up    up
   irb                     up    up
   lo0                     up    up
   lo0.0                   up    up   inet     192.168.0.1/24
   lo0.16384               up    up   inet     127.0.0.1           --> 0/0
   lo0.16385               up    up   inet     10.0.0.1            --> 0/0
                                               10.0.0.16           --> 0/0
                                               128.0.0.1           --> 0/0
                                               128.0.0.4           --> 0/0
                                               128.0.1.16          --> 0/0
   lo0.32768               up    up
   lsi                     up    up
   mtun                    up    up
   pimd                    up    up
   pime                    up    up
   pp0                     up    up
   ppd0                    up    up
   ppe0                    up    up
   st0                     up    up
   st0.1                   up    up   inet     192.168.99.2/24
   tap                     up    up
   vlan                    up    down
   vtep                    up    up
   
   root@GWR.DD2316AF0103.ucpesite1.ucpetenant> show bgp neighbor
   Peer: 192.168.66.1+179 AS 65410 Local: 192.168.66.2+56149 AS 65500
     Type: External    State: Established    Flags: <Sync>
     Last State: OpenConfirm   Last Event: RecvKeepAlive
     Last Error: None
     Export: [ ebgp-export ]
     Options: <Preference AddressFamily PeerAS Refresh>
     Address families configured: inet-unicast
     Holdtime: 90 Preference: 170
     Number of flaps: 0
     Peer ID: 192.168.66.1    Local ID: 192.168.66.2      Active Holdtime: 90
     Keepalive Interval: 30         Group index: 0    Peer index: 0
     BFD: disabled, down
     Local Interface: ge-0/0/2.0
     NLRI for restart configured on peer: inet-unicast
     NLRI advertised by peer: inet-unicast
     NLRI for this session: inet-unicast
     Peer supports Refresh capability (2)
     Stale routes from peer are kept for: 300
     Peer does not support Restarter functionality
     Restart flag received from the peer: Notification
     NLRI that restart is negotiated for: inet-unicast
     NLRI of received end-of-rib markers: inet-unicast
     NLRI of all end-of-rib markers sent: inet-unicast
     Peer does not support LLGR Restarter functionality
     Peer supports 4 byte AS extension (peer-as 65410)
     Peer does not support Addpath
     Table trust.inet.0 Bit: 10000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          0
     Last traffic (seconds): Received 3    Sent 23   Checked 75
     Input messages:  Total 32     Updates 2       Refreshes 0     Octets 637
     Output messages: Total 32     Updates 0       Refreshes 0     Octets 675
     Output Queue[0]: 0            (trust.inet.0, inet-unicast)
     Trace options: general, state, policy, task, timer
     Trace file: /var/log/rpd.log size 131072 files 10
   
   Peer: 192.168.99.1+56287 AS 65410 Local: 192.168.99.2+179 AS 65500
     Type: External    State: Established    Flags: <Sync>
     Last State: OpenConfirm   Last Event: RecvKeepAlive
     Last Error: None
     Export: [ ebgp-export ]
     Options: <MetricOut Preference Localpref AddressFamily PeerAS Refresh>
     Address families configured: inet-unicast
     Holdtime: 90 Metric Out: 200 Preference: 170 Localpref: 100
     Number of flaps: 0
     Peer ID: 192.168.66.1    Local ID: 192.168.66.2      Active Holdtime: 90
     Keepalive Interval: 30         Group index: 1    Peer index: 0
     BFD: disabled, down
     Local Interface: st0.1
     NLRI for restart configured on peer: inet-unicast
     NLRI advertised by peer: inet-unicast
     NLRI for this session: inet-unicast
     Peer supports Refresh capability (2)
     Stale routes from peer are kept for: 300
     Peer does not support Restarter functionality
     Restart flag received from the peer: Notification
     NLRI that restart is negotiated for: inet-unicast
     NLRI of received end-of-rib markers: inet-unicast
     NLRI of all end-of-rib markers sent: inet-unicast
     Peer does not support LLGR Restarter functionality
     Peer supports 4 byte AS extension (peer-as 65410)
     Peer does not support Addpath
     Table trust.inet.0 Bit: 10001
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          0
     Last traffic (seconds): Received 11   Sent 13   Checked 52
     Input messages:  Total 23     Updates 2       Refreshes 0     Octets 517
     Output messages: Total 23     Updates 0       Refreshes 0     Octets 504
     Output Queue[0]: 0            (trust.inet.0, inet-unicast)
     Trace options: general, state, policy, task, timer
     Trace file: /var/log/rpd.log size 131072 files 10
   
   root@GWR.DD2316AF0103.ucpesite1.ucpetenant> show configuration
   ## Last commit: 2018-03-22 08:21:27 UTC by csp
   version 15.1X49-D125.3;
   groups {
       global {
           security {
               forwarding-options {
                   family {
                       inet6 {
                           mode flow-based;
                       }
                   }
               }
               policies {
                   default-policy {
                       deny-all;
                   }
               }
               zones {
                   security-zone HOST {
                       host-inbound-traffic {
                           system-services {
                               any-service;
                           }
                           protocols {
                               all;
                           }
                       }
                   }
               }
           }
       }
   }
   apply-groups global;
   system {
       host-name GWR.DD2316AF0103.ucpesite1.ucpetenant;
       root-authentication {
           encrypted-password "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81"; ## SECRET-DATA
       }
       login {
           user csp {
               uid 2000;
               class super-user;
               authentication {
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCo3xh8u7b0ryAOKxtmgGQtcbB0cAut1vMWZLxtZiOQK2lQ74Sybf+AEu2xcznUtxxf+D86qw9PfhgnVhyAZAkJNDeZd7piB2yNa25MDkJn0Yo/u2s0C4V8WlVSaF/BRJ0KF9GuvE1nkxt0LSE6l7DS2oepj9jhgXRBI1/+4RwhCejktxqTBkOOa0aSsmqyHI2dkpAL1MIXUReQeVyg6K28p9qoAn86n44qqF3W4UK1iM+7Vj2CUBIUa+gvAryxyvgDsDhcdah+IrCtnAhH0KptOMD3fBgun4tdNrctwXi04G0sQnPtxyxBU1mFpeQGeJh6vMqnkpf5cEHfSPNaomlL"; ## SECRET-DATA
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCvwUTdez5iaB49OE3iFr6tIpSLdPCO49W/32UFscKqmoSRZtbKgagtTW1cV/PGRezb/mbEZXE/oHsZ5JmZdfWCOUL0okzciF6JB7IyXXPryb6Rk4KC6bAOeI5rI+BTN5qF4dwHfMYX6peggiv9ptrUgolV4AFUJ90em3Ke+swU+ryR+jDHYWjsLeuEbHFv0Uksl4bDrlKrQkC9l7WdCQz2J9w0nNXgg95s03rxUlxPif6R0gCQ1ga95lgJ2KPbEiUWhQpvDsXKKP2NxX9R8VtCtnBkpnVB1TKL1wQoqu44ns0ZyT0CZwdLlf6dt5JG8xOy3WJ+HeqXSQPV9zxthflz"; ## SECRET-DATA
               }
           }
           user cspagent {
               uid 2001;
               class operator;
               authentication {
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCo3xh8u7b0ryAOKxtmgGQtcbB0cAut1vMWZLxtZiOQK2lQ74Sybf+AEu2xcznUtxxf+D86qw9PfhgnVhyAZAkJNDeZd7piB2yNa25MDkJn0Yo/u2s0C4V8WlVSaF/BRJ0KF9GuvE1nkxt0LSE6l7DS2oepj9jhgXRBI1/+4RwhCejktxqTBkOOa0aSsmqyHI2dkpAL1MIXUReQeVyg6K28p9qoAn86n44qqF3W4UK1iM+7Vj2CUBIUa+gvAryxyvgDsDhcdah+IrCtnAhH0KptOMD3fBgun4tdNrctwXi04G0sQnPtxyxBU1mFpeQGeJh6vMqnkpf5cEHfSPNaomlL"; ## SECRET-DATA
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCvwUTdez5iaB49OE3iFr6tIpSLdPCO49W/32UFscKqmoSRZtbKgagtTW1cV/PGRezb/mbEZXE/oHsZ5JmZdfWCOUL0okzciF6JB7IyXXPryb6Rk4KC6bAOeI5rI+BTN5qF4dwHfMYX6peggiv9ptrUgolV4AFUJ90em3Ke+swU+ryR+jDHYWjsLeuEbHFv0Uksl4bDrlKrQkC9l7WdCQz2J9w0nNXgg95s03rxUlxPif6R0gCQ1ga95lgJ2KPbEiUWhQpvDsXKKP2NxX9R8VtCtnBkpnVB1TKL1wQoqu44ns0ZyT0CZwdLlf6dt5JG8xOy3WJ+HeqXSQPV9zxthflz"; ## SECRET-DATA
               }
           }
       }
       services {
           ssh;
           netconf {
               ssh;
               rfc-compliant;
           }
       }
       syslog {
           file messages {
               any any;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
       processes {
           dhcp-service {
               traceoptions {
                   file dhcp.log;
                   flag all;
               }
           }
       }
   }
   security {
       ike {
           proposal DEFAULT_IKE_PROPOSAL {
               authentication-method pre-shared-keys;
               dh-group group14;
               authentication-algorithm sha-256;
               encryption-algorithm aes-128-cbc;
           }
           policy DEFAULT_IKE_POLOCY {
               proposals DEFAULT_IKE_PROPOSAL;
               pre-shared-key ascii-text "$9$km5FCtOcyKn/yKM8dVqmfTn/Ap0IhS"; ## SECRET-DATA
           }
           gateway IKE_GATEWAY {
               ike-policy DEFAULT_IKE_POLOCY;
               address 192.168.67.67;
               external-interface ge-0/0/3.0;
               version v2-only;
           }
       }
       ipsec {
           proposal DEFAULT_IPSEC_PROPOSAL {
               protocol esp;
               authentication-algorithm hmac-sha1-96;
               encryption-algorithm aes-128-cbc;
               lifetime-seconds 300;
           }
           policy DEFAULT_IPSEC_POLICY {
               proposals DEFAULT_IPSEC_PROPOSAL;
           }
           vpn WAN_1_IPSEC_0 {
               bind-interface st0.1;
               ike {
                   gateway IKE_GATEWAY;
                   ipsec-policy DEFAULT_IPSEC_POLICY;
               }
               establish-tunnels immediately;
           }
       }
       nat {
           source {
               rule-set own-mgmt-traffic-nat {
                   from routing-instance default;
                   to interface ge-0/0/1.0;
                   rule r1 {
                       match {
                           source-address 0.0.0.0/0;
                       }
                       then {
                           source-nat {
                               interface;
                           }
                       }
                   }
               }
               rule-set mgmt-traffic-nat {
                   from interface ge-0/0/4.0;
                   to interface ge-0/0/1.0;
                   rule r2 {
                       match {
                           destination-address 192.168.64.0/24;
                       }
                       then {
                           source-nat {
                               interface;
                           }
                       }
                   }
               }
           }
       }
       policies {
           from-zone trust to-zone trust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone trust {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/4.0;
                   ge-0/0/5.0;
                   ge-0/0/6.0;
                   ge-0/0/2.0;
                   ge-0/0/1.0;
                   st0.1;
               }
           }
           security-zone untrust {
               host-inbound-traffic {
                   system-services {
                       ssh;
                       ping;
                       netconf;
                       http;
                       https;
                       dhcp;
                       ike;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/3.0;
               }
           }
       }
   }
   interfaces {
       /* Inband OAM interface */
       ge-0/0/1 {
           description "Inband OAM interface";
           unit 0 {
               family inet {
                   address 192.168.65.4/24;
               }
           }
       }
       /* WAN-0 interface */
       ge-0/0/2 {
           description "WAN-0 interface";
           unit 0 {
               family inet {
                   address 192.168.66.2/24;
               }
           }
       }
       /* WAN-1 interface */
       ge-0/0/3 {
           description "WAN-1 interface";
           unit 0 {
               family inet {
                   dhcp-client {
                       lease-time infinite;
                   }
               }
           }
       }
       /* AUX_0 Connected to JCP */
       ge-0/0/4 {
           description "AUX_0 Connected to JCP";
           unit 0 {
               family inet {
                   address 10.10.0.2/24;
               }
           }
       }
       /* AUX_1 */
       ge-0/0/5 {
           description AUX_1;
           unit 0 {
               family inet {
                   address 10.10.12.2/24;
               }
           }
       }
       /* AUX_2 */
       ge-0/0/6 {
           description AUX_2;
           unit 0 {
               family inet {
                   address 10.10.13.2/24;
               }
           }
       }
       /* Internal management port */
       fxp0 {
           description "Internal management port";
           unit 0 {
               family inet {
                   dhcp-client {
                       lease-time infinite;
                   }
               }
           }
       }
       /* Loopback Interface */
       lo0 {
           description "Loopback Interface";
           unit 0 {
               family inet {
                   address 192.168.0.1/24;
               }
           }
       }
       st0 {
           unit 1 {
               family inet {
                   address 192.168.99.2/24;
               }
           }
       }
   }
   routing-options {
       traceoptions {
           file rpd.log;
           flag all;
       }
       interface-routes {
           rib-group inet inet0-to-trust;
       }
       static {
           route 192.168.64.0/24 next-table trust.inet.0;
       }
       rib-groups {
           inet0-to-trust {
               import-rib [ inet.0 trust.inet.0 ];
               import-policy policy-lo0;
           }
       }
   }
   policy-options {
       policy-statement ebgp-export {
           term static {
               from protocol static;
               then accept;
           }
           term reject {
               then reject;
           }
       }
       policy-statement policy-lo0 {
           term 1 {
               from interface lo0.0;
               then accept;
           }
       }
   }
   routing-instances {
       internet {
           instance-type virtual-router;
           interface ge-0/0/3.0;
       }
       trust {
           instance-type virtual-router;
           interface ge-0/0/1.0;
           interface ge-0/0/2.0;
           interface ge-0/0/4.0;
           interface ge-0/0/5.0;
           interface ge-0/0/6.0;
           interface st0.1;
           routing-options {
               static {
                   route 192.168.64.0/24 {
                       next-hop 192.168.65.1;
                       no-readvertise;
                   }
               }
               router-id 192.168.66.2;
               autonomous-system 65500;
           }
           protocols {
               bgp {
                   export ebgp-export;
                   group ebgp {
                       type external;
                       family inet {
                           unicast;
                       }
                       peer-as 65410;
                       neighbor 192.168.66.1;
                       neighbor 192.168.99.1 {
                           metric-out 200;
                           local-preference 100;
                       }
                   }
               }
               ospf {
                   area 0.0.0.0 {
                       interface ge-0/0/4.0;
                   }
               }
           }
       }
   }
   
   root@jdm> show configuration
   ## Last commit: 2018-03-22 08:19:04 UTC by csp
   version "15.1X53-D47.4.secure [dc-builder]";
   system {
       host-name jdm;
       memory {
           hugepages {
               page-size 1024 {
                   page-count 13;
               }
           }
       }
       root-authentication {
           encrypted-password "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81"; ## SECRET-DATA
       }
       name-server {
           192.168.10.10;
       }
       login {
           idle-timeout 10;
           user csp {
               uid 2000;
               class super-user;
               authentication {
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCo3xh8u7b0ryAOKxtmgGQtcbB0cAut1vMWZLxtZiOQK2lQ74Sybf+AEu2xcznUtxxf+D86qw9PfhgnVhyAZAkJNDeZd7piB2yNa25MDkJn0Yo/u2s0C4V8WlVSaF/BRJ0KF9GuvE1nkxt0LSE6l7DS2oepj9jhgXRBI1/+4RwhCejktxqTBkOOa0aSsmqyHI2dkpAL1MIXUReQeVyg6K28p9qoAn86n44qqF3W4UK1iM+7Vj2CUBIUa+gvAryxyvgDsDhcdah+IrCtnAhH0KptOMD3fBgun4tdNrctwXi04G0sQnPtxyxBU1mFpeQGeJh6vMqnkpf5cEHfSPNaomlL"; ## SECRET-DATA
               }
           }
           user cspagent {
               uid 2001;
               class operator;
               authentication {
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCo3xh8u7b0ryAOKxtmgGQtcbB0cAut1vMWZLxtZiOQK2lQ74Sybf+AEu2xcznUtxxf+D86qw9PfhgnVhyAZAkJNDeZd7piB2yNa25MDkJn0Yo/u2s0C4V8WlVSaF/BRJ0KF9GuvE1nkxt0LSE6l7DS2oepj9jhgXRBI1/+4RwhCejktxqTBkOOa0aSsmqyHI2dkpAL1MIXUReQeVyg6K28p9qoAn86n44qqF3W4UK1iM+7Vj2CUBIUa+gvAryxyvgDsDhcdah+IrCtnAhH0KptOMD3fBgun4tdNrctwXi04G0sQnPtxyxBU1mFpeQGeJh6vMqnkpf5cEHfSPNaomlL"; ## SECRET-DATA
               }
           }
       }
       services {
           ssh {
               client-alive-count-max 5;
               client-alive-interval 60;
           }
           netconf {
               ssh;
               rfc-compliant;
           }
           enhanced-orchestration;
       }
   }
   interfaces {
       jmgmt0 {
           unit 0 {
               family inet {
                   address 192.168.10.24/24;
               }
           }
       }
       jsxe0 {
           vlan-tagging;
           unit 0 {
               vlan-id 65;
               family inet {
                   address 192.168.65.2/24;
               }
           }
           unit 4001 {
               vlan-id 4001;
               family inet {
                   address 10.10.0.100/24;
               }
           }
       }
   }
   routing-options {
       static {
           route {
               192.168.64.0/24 next-hop 192.168.65.1;
           }
       }
   }
   host-os {
       vlans {
           aux0_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm {
               vlan-id-list 4001;
           }
           aux1_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm {
               vlan-id-list 4002;
           }
           aux2_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm {
               vlan-id-list 4003;
           }
           mgmt_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm {
               vlan-id-list 65;
           }
           vl-lan-0 {
               vlan-id-list 4032;
           }
           vl-lan-1 {
               vlan-id-list 4033;
           }
           wan0_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm {
               vlan-id-list 66;
           }
           wan1_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm {
               vlan-id-list 4051;
           }
           wan2_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm {
               vlan-id-list 4052;
           }
           wan3_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm {
               vlan-id-list 4053;
           }
       }
   }
   virtual-network-functions GWR.DD2316AF0103.ucpesite1.ucpetenant {
       image {
           /var/third-party/CSP/GWR.DD2316AF0103.ucpesite1.ucpetenant/media-vsrx-vmdisk-15.1X49-D125.3.qcow2;
       }
       virtual-cpu {
           count 2;
           features {
               hardware-virtualization;
           }
       }
       interfaces eth2 {
           description mgmt;
           mapping {
               vlan {
                   mode access;
                   members mgmt_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm;
               }
           }
       }
       interfaces eth3 {
           description wan0;
           mapping {
               vlan {
                   mode access;
                   members wan0_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm;
               }
           }
       }
       interfaces eth4 {
           description wan1;
           mapping {
               vlan {
                   mode access;
                   members wan1_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm;
               }
           }
       }
       interfaces eth5 {
           description aux0;
           mapping {
               vlan {
                   mode access;
                   members aux0_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm;
               }
           }
       }
       interfaces eth6 {
           description aux1;
           mapping {
               vlan {
                   mode access;
                   members aux1_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm;
               }
           }
       }
       interfaces eth7 {
           description aux2;
           mapping {
               vlan {
                   mode access;
                   members aux2_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm;
               }
           }
       }
       interfaces eth8 {
           description wan2;
           mapping {
               vlan {
                   mode access;
                   members wan2_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm;
               }
           }
       }
       interfaces eth9 {
           description wan3;
           mapping {
               vlan {
                   mode access;
                   members wan3_GWR.DD2316AF0103.ucpesite1.ucpetenant_vm;
               }
           }
       }
       memory {
           size 4194304;
           features {
               hugepages;
           }
       }
   }
   
   root@vjunos0> show configuration
   ## Last commit: 2018-03-22 08:20:25 UTC by jdm-sysuser
   version 15.1X53-D47.4;
   system {
       ##
       ## Warning: configuration block ignored: unsupported platform (nfx250_s2_10_t)
       ##
       phone-home {
           server https://regionalmsvm.example.net;
       }
       host-name vjunos0;
       root-authentication {
           encrypted-password "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81"; ## SECRET-DATA
           ssh-ecdsa "ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBG51ZgzaHs7P+hfR76+Q60A9F0dbXRgJSRODP7Ue6W3xAiR3Qvka6xMKdzb5X7DLc1qnyvRyX57wAiNttLrxgQk= root@jdm"; ## SECRET-DATA
       }
       name-server {
           192.168.10.10;
       }
       login {
           user csp {
               uid 2001;
               class super-user;
               authentication {
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCo3xh8u7b0ryAOKxtmgGQtcbB0cAut1vMWZLxtZiOQK2lQ74Sybf+AEu2xcznUtxxf+D86qw9PfhgnVhyAZAkJNDeZd7piB2yNa25MDkJn0Yo/u2s0C4V8WlVSaF/BRJ0KF9GuvE1nkxt0LSE6l7DS2oepj9jhgXRBI1/+4RwhCejktxqTBkOOa0aSsmqyHI2dkpAL1MIXUReQeVyg6K28p9qoAn86n44qqF3W4UK1iM+7Vj2CUBIUa+gvAryxyvgDsDhcdah+IrCtnAhH0KptOMD3fBgun4tdNrctwXi04G0sQnPtxyxBU1mFpeQGeJh6vMqnkpf5cEHfSPNaomlL"; ## SECRET-DATA
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCvwUTdez5iaB49OE3iFr6tIpSLdPCO49W/32UFscKqmoSRZtbKgagtTW1cV/PGRezb/mbEZXE/oHsZ5JmZdfWCOUL0okzciF6JB7IyXXPryb6Rk4KC6bAOeI5rI+BTN5qF4dwHfMYX6peggiv9ptrUgolV4AFUJ90em3Ke+swU+ryR+jDHYWjsLeuEbHFv0Uksl4bDrlKrQkC9l7WdCQz2J9w0nNXgg95s03rxUlxPif6R0gCQ1ga95lgJ2KPbEiUWhQpvDsXKKP2NxX9R8VtCtnBkpnVB1TKL1wQoqu44ns0ZyT0CZwdLlf6dt5JG8xOy3WJ+HeqXSQPV9zxthflz root@jdm;"; ## SECRET-DATA
               }
           }
           user cspagent {
               uid 2002;
               class operator;
               authentication {
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCo3xh8u7b0ryAOKxtmgGQtcbB0cAut1vMWZLxtZiOQK2lQ74Sybf+AEu2xcznUtxxf+D86qw9PfhgnVhyAZAkJNDeZd7piB2yNa25MDkJn0Yo/u2s0C4V8WlVSaF/BRJ0KF9GuvE1nkxt0LSE6l7DS2oepj9jhgXRBI1/+4RwhCejktxqTBkOOa0aSsmqyHI2dkpAL1MIXUReQeVyg6K28p9qoAn86n44qqF3W4UK1iM+7Vj2CUBIUa+gvAryxyvgDsDhcdah+IrCtnAhH0KptOMD3fBgun4tdNrctwXi04G0sQnPtxyxBU1mFpeQGeJh6vMqnkpf5cEHfSPNaomlL"; ## SECRET-DATA
               }
           }
           user jdm-sysuser {
               uid 2000;
               class super-user;
               authentication {
                   ssh-ecdsa "ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBG51ZgzaHs7P+hfR76+Q60A9F0dbXRgJSRODP7Ue6W3xAiR3Qvka6xMKdzb5X7DLc1qnyvRyX57wAiNttLrxgQk= root@jdm"; ## SECRET-DATA
               }
           }
       }
       services {
           ssh;
           netconf {
               ssh;
               rfc-compliant;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any notice;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       processes {
           app-engine-virtual-machine-management-service {
               traceoptions {
                   level notice;
                   flag all;
               }
           }
       }
   }
   interfaces {
       sxe-0/0/0 {
           unit 0 {
               family ethernet-switching {
                   interface-mode trunk;
                   vlan {
                       members [ OAM WAN0 WAN1 ];
                   }
               }
           }
       }
       sxe-0/0/1 {
           unit 0 {
               family ethernet-switching {
                   interface-mode trunk;
                   vlan {
                       members [ AUX0 LAN0 LAN1 ];
                   }
               }
           }
       }
       ge-0/0/8 {
           speed auto;
           ether-options {
               auto-negotiation;
           }
           unit 0 {
               family ethernet-switching {
                   interface-mode trunk;
                   vlan {
                       members [ OAM WAN0 ];
                   }
               }
           }
       }
       ge-0/0/9 {
           speed auto;
           ether-options {
               auto-negotiation;
           }
           unit 0 {
               family ethernet-switching {
                   interface-mode access;
                   vlan {
                       members WAN1;
                   }
               }
           }
       }
       irb {
           unit 65 {
               family inet {
                   address 192.168.65.3/24;
               }
           }
           unit 4001 {
               family inet {
                   address 10.10.0.1/24;
               }
           }
           unit 4032 {
               family inet {
                   address 10.10.1.1/24;
               }
           }
           unit 4033 {
               family inet {
                   address 10.10.2.1/24;
               }
           }
       }
   }
   routing-options {
       static {
           route 192.168.64.0/24 next-hop 192.168.65.1;
           route 0.0.0.0/0 next-hop 10.10.0.2;
       }
   }
   vlans {
       AUX0 {
           vlan-id 4001;
           l3-interface irb.4001;
       }
       LAN0 {
           vlan-id 4032;
           l3-interface irb.4032;
       }
       LAN1 {
           vlan-id 4033;
           l3-interface irb.4033;
       }
       OAM {
           vlan-id 65;
           l3-interface irb.65;
       }
       WAN0 {
           vlan-id 66;
       }
       WAN1 {
           vlan-id 4051;
       }
   }
   

Also on the MX80-1 the following was added as an apply group to add the IPsec configuration.

.. code-block:: none

   groups {
       ucpetenant_ucpesite1 {
           services {
               service-set IPSEC_192_168_67_67 {
                   next-hop-service {
                       inside-service-interface ms-0/2/0.4000;
                       outside-service-interface ms-0/2/0.4001;
                   }
                   ipsec-vpn-options {
                       local-gateway 192.168.67.67;
                   }
                   ipsec-vpn-rules IPSEC_RULES_192_168_67_67;
               }
               ipsec-vpn {
                   rule IPSEC_RULES_192_168_67_67 {
                       term ucpetenant_ucpesite1_RULE {
                           from {
                               ipsec-inside-interface ms-0/2/0.4005;
                           }
                           then {
                               remote-gateway 192.168.67.6;
                               dynamic {
                                   ike-policy ucpetenant_ucpesite1_IKE_POLICY;
                                   ipsec-policy DEFAULT_IPSEC_POLICY;
                               }
                           }
                       }
                       match-direction input;
                   }
                   ipsec {
                       proposal DEFAULT_IPSEC_PROPOSAL {
                           protocol esp;
                           authentication-algorithm hmac-sha1-96;
                           encryption-algorithm aes-128-cbc;
                           lifetime-seconds 300;
                       }
                       policy DEFAULT_IPSEC_POLICY {
                           proposals DEFAULT_IPSEC_PROPOSAL;
                       }
                   }
                   ike {
                       proposal DEFAULT_IKE_PROPOSAL {
                           authentication-method pre-shared-keys;
                           dh-group group14;
                           authentication-algorithm sha-256;
                           encryption-algorithm aes-128-cbc;
                       }
                       policy ucpetenant_ucpesite1_IKE_POLICY {
                           version 2;
                           proposals DEFAULT_IKE_PROPOSAL;
                           pre-shared-key ascii-text "$9$6qRbCpBcyKxNbIENbs2GU/CtuIESreWX7"; ## SECRET-DATA
                       }
                   }
               }
           }
           interfaces {
               ms-0/2/0 {
                   unit 4005 {
                       family inet {
                           address 192.168.99.1/24;
                       }
                       service-domain inside;
                   }
                   unit 4000 {
                       family inet;
                       service-domain inside;
                   }
                   unit 4001 {
                       family inet;
                       service-domain outside;
                   }
               }
           }
           routing-instances {
               VRFWAN {
                   interface ms-0/2/0.4005;
                   protocols {
                       bgp {
                           group ucpetenant_ucpesite1_ipsec {
                               type external;
                               family inet {
                                   unicast;
                               }
                               peer-as 65500;
                               neighbor 192.168.99.2 {
                                   metric-out 200;
                                   local-preference 100;
                               }
                           }
                       }
                   }
               }
           }
       }
   }
   apply-groups [ vcpe ucpe ucpetenant_ucpesite1 ];

Just for reference we’ve added the logs from CSO about the process here

.. hidden-code-block:: none

   
   Job logs:
   03/22/18 09:05:12csp.tssm_ztp.16635dec-2da7-11e8-8019-0242ac101b34
   03/22/18 09:16:13Instanitating virtual link
   03/22/18 09:16:19Instanitating virtual link
   03/22/18 09:16:25Instanitating virtual link
   03/22/18 09:16:30Instanitating virtual link
   03/22/18 09:16:35Instanitating virtual link
   03/22/18 09:16:40Instanitating virtual link
   03/22/18 09:16:45Instanitating virtual link
   03/22/18 09:16:50Instanitating virtual link
   03/22/18 09:16:55Instanitating virtual link
   03/22/18 09:17:20Instanitating virtual link
   Task: 1
   03/22/18 09:05:11Task started
   03/22/18 09:15:45Issue all service libs SUCCESS
   03/22/18 09:15:45Workflow not found in given device profile Workflow switch-wan-ip-to-gwr is not applicable in the provided device profile.
   03/22/18 09:15:45Switching WAN IP to GWR not required
   03/22/18 09:15:45Task complete
   Task: 0
   03/22/18 09:05:11Task started
   03/22/18 09:05:12Create VM Task Start, task_id = 0 ...
   03/22/18 09:05:12NFX device 16635dec-2da7-11e8-8019-0242ac101b34 maps to topo device d007a0d1-8004-4817-81d1-6f4540930311
   03/22/18 09:05:12Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:05:12Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:05:13Updated token to customer project scope SUCCESS
   03/22/18 09:05:13Initiate all service libs SUCCESS
   03/22/18 09:05:13Update topo device d007a0d1-8004-4817-81d1-6f4540930311 management state to managed SUCCESS
   03/22/18 09:05:13Topo device d007a0d1-8004-4817-81d1-6f4540930311 map to nso vim-instance 7984745e-ede6-44b4-b35a-da1ff604f6a9
   03/22/18 09:05:13Topo device d007a0d1-8004-4817-81d1-6f4540930311 map to topology vim edd92b3d-4825-49d1-b6e8-945c9b259f9a
   03/22/18 09:05:14Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:05:14Topology site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 map to topology pop c4aafed6-c798-4cd8-95db-f83fc5f8b4a1
   03/22/18 09:05:14Topology pop c4aafed6-c798-4cd8-95db-f83fc5f8b4a1 map to topology region b4efd255-9080-41bf-84d9-90228ba764a6
   03/22/18 09:05:14Topo region name is regional
   03/22/18 09:05:14Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:05:14Device template id 0deeb00a-a65b-35ad-a8ea-05a706de2661
   03/22/18 09:05:15No resource pool for this nso vim yet, about to create
   03/22/18 09:05:16Calling nso create resource pool SUCCESS
   03/22/18 09:05:16Resource pool id = 9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0
   03/22/18 09:05:16Update resource pool info for porter vim SUCCESS
   03/22/18 09:05:16Create VM Stage 1: create resource pool SUCCESS, resource_pool_id = 9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0
   03/22/18 09:05:19Create VM Stage 2: resolve device profile SUCCESS, profile_id = 0deeb00a-a65b-35ad-a8ea-05a706de2661, results = {'config_templates': {u'gwr-boot-config': {u'input_param': u'{\n "wan_ip": "192.168.66.2/24",\n "wan_vlan_id": "66",\n "cpe_as": "65500",\n "pe_as": "65410",\n "pe_ip": "192.168.66.1",\n "hostname": "GWR.DD2316AF0103.ucpesite1.ucpetenant",\n "management_userid": "csp",\n "agent_userid": "cspagent",\n "ssh_public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCo3xh8u7b0ryAOKxtmgGQtcbB0cAut1vMWZLxtZiOQK2lQ74Sybf+AEu2xcznUtxxf+D86qw9PfhgnVhyAZAkJNDeZd7piB2yNa25MDkJn0Yo/u2s0C4V8WlVSaF/BRJ0KF9GuvE1nkxt0LSE6l7DS2oepj9jhgXRBI1/+4RwhCejktxqTBkOOa0aSsmqyHI2dkpAL1MIXUReQeVyg6K28p9qoAn86n44qqF3W4UK1iM+7Vj2CUBIUa+gvAryxyvgDsDhcdah+IrCtnAhH0KptOMD3fBgun4tdNrctwXi04G0sQnPtxyxBU1mFpeQGeJh6vMqnkpf5cEHfSPNaomlL",\n "jdm_public_key": "AAAAB3NzaC1yc2EAAAADAQABAAABAQCvwUTdez5iaB49OE3iFr6tIpSLdPCO49W/32UFscKqmoSRZtbKgagtTW1cV/PGRezb/mbEZXE/oHsZ5JmZdfWCOUL0okzciF6JB7IyXXPryb6Rk4KC6bAOeI5rI+BTN5qF4dwHfMYX6peggiv9ptrUgolV4AFUJ90em3Ke+swU+ryR+jDHYWjsLeuEbHFv0Uksl4bDrlKrQkC9l7WdCQz2J9w0nNXgg95s03rxUlxPif6R0gCQ1ga95lgJ2KPbEiUWhQpvDsXKKP2NxX9R8VtCtnBkpnVB1TKL1wQoqu44ns0ZyT0CZwdLlf6dt5JG8xOy3WJ+HeqXSQPV9zxthflz",\n "encrypted_root_password": "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81",\n\n "vsrx_mgmt_ip": "192.168.65.4/24",\n "oam_gateway": "192.168.65.1",\n "tunneled_oam": false,\n\n "csp_prefix": "192.168.64.0/24",\n "oam_port": "ge-0/0/1",\n "wan_0_port": "ge-0/0/2",\n "wan_1_port": "ge-0/0/3",\n "aux_0_port": "ge-0/0/4",\n "aux_1_port": "ge-0/0/5",\n "aux_2_port": "ge-0/0/6",\n "aux_0_ip": "10.10.0.2/24",\n "aux_1_ip": "10.10.12.2/24",\n "aux_2_ip": "10.10.13.2/24"\n}\n', u'hide': False, u'name': u'gwr-boot-config', u'template_uuid': u'f780ee05-da19-32af-9410-0fce272158be', u'conditional_template_uuid': None, u'device_component_name': u'GWR', u'display_name': u'Gateway Router Bootstrap Config', u'copy_input_param_from': None, u'initial_config': None}}, 'resources': {u'create_vm_api_input': {u'vm_name': u'GWR.DD2316AF0103.ucpesite1.ucpetenant', u'vim_id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vim_resource_id': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'resources': {u'memory_mb': 4096, u'vcpu': 2, u'disk_gb': 10, u'image_file_uri': u'/var/third-party/images/media-vsrx-vmdisk-15.1X49-D125.3.qcow2,vsrx-vmdisk-15.1.qcow2'}, u'networks': [{u'port_specification': {u'port_ip': u'192.168.65.4/24', u'port_index': 2, u'port_type': u'MGMT'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 65}, u'name': u'mgmt'}, {u'port_specification': {u'port_ip': u'192.168.66.2/24', u'port_index': 3, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 66}, u'name': u'wan0'}, {u'port_specification': {u'port_ip': u'192.168.99.2/24', u'port_index': 4, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4051}, u'name': u'wan1'}, {u'port_specification': {u'port_index': 8, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4052}, u'name': u'wan2'}, {u'port_specification': {u'port_index': 9, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4053}, u'name': u'wan3'}, {u'port_specification': {u'port_ip': u'10.10.0.2/24', u'port_index': 5, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4001}, u'name': u'aux0'}, {u'port_specification': {u'port_ip': u'10.10.12.2/24', u'port_index': 6, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4002}, u'name': u'aux1'}, {u'port_specification': {u'port_ip': u'10.10.13.2/24', u'port_index': 7, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4003}, u'name': u'aux2'}]}}}
   03/22/18 09:05:19Create VM Stage 3: render boot config SUCCESS, config = groups { global { security { forwarding-options { family { inet6 { mode flow-based; } } } policies { default-policy { deny-all; } } zones { security-zone HOST { host-inbound-traffic { system-services { any-service; } protocols { all; } } } } } } } apply-groups global; system { host-name GWR.DD2316AF0103.ucpesite1.ucpetenant; root-authentication { encrypted-password "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81"; } login { user csp { class super-user; authentication { ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCo3xh8u7b0ryAOKxtmgGQtcbB0cAut1vMWZLxtZiOQK2lQ74Sybf+AEu2xcznUtxxf+D86qw9PfhgnVhyAZAkJNDeZd7piB2yNa25MDkJn0Yo/u2s0C4V8WlVSaF/BRJ0KF9GuvE1nkxt0LSE6l7DS2oepj9jhgXRBI1/+4RwhCejktxqTBkOOa0aSsmqyHI2dkpAL1MIXUReQeVyg6K28p9qoAn86n44qqF3W4UK1iM+7Vj2CUBIUa+gvAryxyvgDsDhcdah+IrCtnAhH0KptOMD3fBgun4tdNrctwXi04G0sQnPtxyxBU1mFpeQGeJh6vMqnkpf5cEHfSPNaomlL"; ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCvwUTdez5iaB49OE3iFr6tIpSLdPCO49W/32UFscKqmoSRZtbKgagtTW1cV/PGRezb/mbEZXE/oHsZ5JmZdfWCOUL0okzciF6JB7IyXXPryb6Rk4KC6bAOeI5rI+BTN5qF4dwHfMYX6peggiv9ptrUgolV4AFUJ90em3Ke+swU+ryR+jDHYWjsLeuEbHFv0Uksl4bDrlKrQkC9l7WdCQz2J9w0nNXgg95s03rxUlxPif6R0gCQ1ga95lgJ2KPbEiUWhQpvDsXKKP2NxX9R8VtCtnBkpnVB1TKL1wQoqu44ns0ZyT0CZwdLlf6dt5JG8xOy3WJ+HeqXSQPV9zxthflz"; } } user cspagent { class operator; authentication { ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCo3xh8u7b0ryAOKxtmgGQtcbB0cAut1vMWZLxtZiOQK2lQ74Sybf+AEu2xcznUtxxf+D86qw9PfhgnVhyAZAkJNDeZd7piB2yNa25MDkJn0Yo/u2s0C4V8WlVSaF/BRJ0KF9GuvE1nkxt0LSE6l7DS2oepj9jhgXRBI1/+4RwhCejktxqTBkOOa0aSsmqyHI2dkpAL1MIXUReQeVyg6K28p9qoAn86n44qqF3W4UK1iM+7Vj2CUBIUa+gvAryxyvgDsDhcdah+IrCtnAhH0KptOMD3fBgun4tdNrctwXi04G0sQnPtxyxBU1mFpeQGeJh6vMqnkpf5cEHfSPNaomlL"; ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCvwUTdez5iaB49OE3iFr6tIpSLdPCO49W/32UFscKqmoSRZtbKgagtTW1cV/PGRezb/mbEZXE/oHsZ5JmZdfWCOUL0okzciF6JB7IyXXPryb6Rk4KC6bAOeI5rI+BTN5qF4dwHfMYX6peggiv9ptrUgolV4AFUJ90em3Ke+swU+ryR+jDHYWjsLeuEbHFv0Uksl4bDrlKrQkC9l7WdCQz2J9w0nNXgg95s03rxUlxPif6R0gCQ1ga95lgJ2KPbEiUWhQpvDsXKKP2NxX9R8VtCtnBkpnVB1TKL1wQoqu44ns0ZyT0CZwdLlf6dt5JG8xOy3WJ+HeqXSQPV9zxthflz"; } } } services { ssh; netconf { ssh; rfc-compliant; } } license { autoupdate { url https://ae1.juniper.net/junos/key_retrieval; } } syslog { file messages { any any; } } processes { dhcp-service { traceoptions { file dhcp.log; flag all; } } } } security { nat { source { rule-set own-mgmt-traffic-nat { from routing-instance default; to interface ge-0/0/1.0; rule r1 { match { source-address 0.0.0.0/0; } then { source-nat { interface; } } } } rule-set mgmt-traffic-nat { from interface ge-0/0/4.0; to interface ge-0/0/1.0; rule r2 { match { destination-address 192.168.64.0/24; } then { source-nat { interface; } } } } } } policies { from-zone trust to-zone trust { policy allow_all { match { source-address any; destination-address any; application any; } then { permit; } } } } zones { security-zone trust { host-inbound-traffic { system-services { all; } protocols { all; } } interfaces { ge-0/0/4.0; ge-0/0/5.0; ge-0/0/6.0; ge-0/0/2.0; ge-0/0/1.0; } } security-zone untrust { host-inbound-traffic { system-services { ssh; ping; netconf; http; https; dhcp; ike; } protocols { all; } } interfaces { ge-0/0/3.0; } } } } interfaces { /* Loopback Interface */ lo0 { description "Loopback Interface"; unit 0 { family inet { address 192.168.0.1/24; } } } /* Internal management port */ fxp0 { description "Internal management port"; unit 0 { family inet { dhcp-client { lease-time infinite; } } } } /* Inband OAM interface */ ge-0/0/1 { description "Inband OAM interface"; unit 0 { family inet { address 192.168.65.4/24; } } } /* WAN-0 interface */ ge-0/0/2 { description "WAN-0 interface"; unit 0 { family inet { address 192.168.66.2/24; } } } /* WAN-1 interface */ ge-0/0/3 { description "WAN-1 interface"; unit 0 { family inet { dhcp-client { lease-time infinite; } } } } /* AUX_0 Connected to JCP */ ge-0/0/4 { description "AUX_0 Connected to JCP"; unit 0 { family inet { address 10.10.0.2/24; } } } /* AUX_1 */ ge-0/0/5 { description "AUX_1"; unit 0 { family inet { address 10.10.12.2/24; } } } /* AUX_2 */ ge-0/0/6 { description "AUX_2"; unit 0 { family inet { address 10.10.13.2/24; } } } } policy-options { policy-statement policy-lo0 { term 1 { from interface lo0.0; then accept; } } policy-statement ebgp-export { term static { from protocol static; then accept; } term reject { then reject; } } } routing-options { traceoptions { file rpd.log; flag all; } interface-routes { rib-group inet inet0-to-trust; } static { route 192.168.64.0/24 next-table trust.inet.0; } rib-groups { inet0-to-trust { import-rib [ inet.0 trust.inet.0 ]; import-policy policy-lo0; } } } routing-instances { internet { instance-type virtual-router; interface ge-0/0/3.0; } trust { instance-type virtual-router; interface ge-0/0/1.0; interface ge-0/0/2.0; interface ge-0/0/4.0; interface ge-0/0/5.0; interface ge-0/0/6.0; routing-options { router-id 192.168.66.2; autonomous-system 65500; static { route 192.168.64.0/24 next-hop 192.168.65.1 no-readvertise; } } protocols { bgp { export ebgp-export; group ebgp { type external; family inet { unicast; } peer-as 65410; neighbor 192.168.66.1; } } ospf { area 0.0.0.0 { interface ge-0/0/4.0; } } } } }
   03/22/18 09:05:19Create VM Stage 4: create abstract config SUCCESS
   03/22/18 09:05:20Create VM Stage 5: resolve vlink device profile SUCCESS, profile_id = 0deeb00a-a65b-35ad-a8ea-05a706de2661, results = {'config_templates': {}, 'resources': {u'create_vlinks': {u'vlinks': [{u'subnets': [{u'subnet': u'10.10.1.2/24'}], u'job-name': u'create_vl-lan-0_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 4032, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'4807e324-4ec1-3d24-85b6-4b60b1f6d4de', u'vl-instance-name': u'vl-lan-0', u'onboard': False}, {u'subnets': [{u'subnet': u'10.10.2.2/24'}], u'job-name': u'create_vl-lan-1_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 4033, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'4807e324-4ec1-3d24-85b6-4b60b1f6d4de', u'vl-instance-name': u'vl-lan-1', u'onboard': False}, {u'subnets': [{u'subnet': u'10.10.0.1/24'}], u'job-name': u'create_vl-aux-0_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 4001, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'd1ce9770-ddda-35d6-bbcb-f7e441d3e618', u'vl-instance-name': u'vl-aux-0', u'onboard': False}, {u'subnets': [{u'subnet': u'10.10.12.1/24'}], u'job-name': u'create_vl-aux-1_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 4002, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'd1ce9770-ddda-35d6-bbcb-f7e441d3e618', u'vl-instance-name': u'vl-aux-1', u'onboard': False}, {u'subnets': [{u'subnet': u'10.10.13.1/24'}], u'job-name': u'create_vl-aux-2_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 4003, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'd1ce9770-ddda-35d6-bbcb-f7e441d3e618', u'vl-instance-name': u'vl-aux-2', u'onboard': False}, {u'job-name': u'create_vl-wan-0_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 66, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'd9138dcd-f40a-36e8-aa89-ca8bb84ddcae', u'vl-instance-name': u'vl-wan-0', u'onboard': False}, {u'job-name': u'create_vl-wan-1_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 4051, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'd9138dcd-f40a-36e8-aa89-ca8bb84ddcae', u'vl-instance-name': u'vl-wan-1', u'onboard': False}, {u'job-name': u'create_vl-wan-2_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 4052, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'd9138dcd-f40a-36e8-aa89-ca8bb84ddcae', u'vl-instance-name': u'vl-wan-2', u'onboard': False}, {u'job-name': u'create_vl-wan-3_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 4053, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'd9138dcd-f40a-36e8-aa89-ca8bb84ddcae', u'vl-instance-name': u'vl-wan-3', u'onboard': False}, {u'job-name': u'create_vl-mgmt_d007a0d1-8004-4817-81d1-6f4540930311', u'vlink-info': {u'vlan-id': 65, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'9f4941f2-fb41-4d06-80e5-1fd2caf8ceb0', u'address-pools': [{u'address-pool': u'08c06aa6-b516-45d4-beab-863f147e0f00'}], u'vim-id': u'7984745e-ede6-44b4-b35a-da1ff604f6a9', u'vld-id': u'16c4d32b-1d5e-3df2-a9cb-e21a5998b712', u'vl-instance-name': u'vl-mgmt', u'onboard': False}]}}}
   03/22/18 09:05:20Notification handler info: {"notification_info": {"queue": "tssm.ztp.queue.7c9e9274-0381-4b2b-aaff-8f7664a162df", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "vm_create_7c9e9274-0381-4b2b-aaff-8f7664a162df", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   03/22/18 09:05:21Create VM Stage 6: create_vm rpc SUCCESS, error: , request_id: 0572b060-f575-4072-a1ed-a697116df0f7, vm_uuid: 779e5ff5-f462-4962-bdba-d36da79de1cf, job_id: 0572b060-f575-4072-a1ed-a697116df0f7
   03/22/18 09:15:43Create VM Stage 7: received notification {"status": "SUCCESS", "X-Request-Id": "api_server_db_b28252bd-0d55-423e-9b44-6b954a063461,Xrib,nEeX,5JlC", "api_key": "v3", "rpc_type": "Create_VM", "request_id": "0572b060-f575-4072-a1ed-a697116df0f7"}
   03/22/18 09:15:43Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:15:43Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:15:44Updated token to customer project scope SUCCESS
   03/22/18 09:15:44Create VM Stage 7: got notification and create vm SUCCESS
   03/22/18 09:15:44Create VM Task Complete SUCCESS
   03/22/18 09:15:45Task complete
   Task: 3
   03/22/18 09:05:11Task started
   03/22/18 09:15:46Deploy Config Stage 1: component JDM does not have abstract config to push and deploy
   03/22/18 09:15:46Task complete
   Task: 2
   03/22/18 09:05:11Task started
   03/22/18 09:15:45Deploy Config Stage 1: component JCP does not have abstract config to push and deploy
   03/22/18 09:15:46Task complete
   Task: 5
   03/22/18 09:05:11Task started
   03/22/18 09:15:46Activate Component Task Start, task_id = 5 ...
   03/22/18 09:15:46Initiate all service libs SUCCESS
   03/22/18 09:15:47notification handler info: {"notification_info": {"queue": "tssm.ztp.queue.6fd58b64-0102-4b04-8c01-e2a40e5625c6", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "cmp_activate_6fd58b64-0102-4b04-8c01-e2a40e5625c6", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   03/22/18 09:15:47Activation Component Try: 1
   03/22/18 09:15:47Activate Component Stage 1: activate_component rpc SUCCESS, requstid = a5063a00-80d4-482d-b705-c97d237ce41e
   03/22/18 09:15:48Activate Component Stage 2: received notification {"reason": null, "requestid": "a5063a00-80d4-482d-b705-c97d237ce41e", "request_id": "api_server_db_b28252bd-0d55-423e-9b44-6b954a063461,Xrib,gGX7,26KP", "device_id": "16635dec-2da7-11e8-8019-0242ac101b34", "response": "SUCCESS", "component_name": "JCP"}
   03/22/18 09:15:48Activate Component Stage 2: notification received and activation SUCCESS
   03/22/18 09:15:48Activate Component Task Complete SUCCESS
   03/22/18 09:15:48Task complete
   Task: 4
   03/22/18 09:05:11Task started
   03/22/18 09:15:46Deploy Config Stage 1: component GWR does not have abstract config to push and deploy
   03/22/18 09:15:46Task complete
   Task: 6
   03/22/18 09:05:11Task started
   03/22/18 09:15:48Activate Component Task Start, task_id = 6 ...
   03/22/18 09:15:49Initiate all service libs SUCCESS
   03/22/18 09:15:49notification handler info: {"notification_info": {"queue": "tssm.ztp.queue.86da316f-e913-47f4-a9be-fde6c4b663ad", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "cmp_activate_86da316f-e913-47f4-a9be-fde6c4b663ad", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   03/22/18 09:15:49Activation Component Try: 1
   03/22/18 09:15:49Activate Component Stage 1: activate_component rpc SUCCESS, requstid = f7bfb85a-951c-4a4c-af27-f97a248c6f19
   03/22/18 09:16:12Activate Component Stage 2: received notification {"reason": null, "requestid": "f7bfb85a-951c-4a4c-af27-f97a248c6f19", "request_id": "api_server_db_b28252bd-0d55-423e-9b44-6b954a063461,Xrib,eDO9,QXMO", "device_id": "16635dec-2da7-11e8-8019-0242ac101b34", "response": "SUCCESS", "component_name": "GWR"}
   03/22/18 09:16:12Activate Component Stage 2: notification received and activation SUCCESS
   03/22/18 09:16:12Activate Component Task Complete SUCCESS
   03/22/18 09:16:12Task complete
   Task: 7
   03/22/18 09:05:11Task started
   03/22/18 09:16:13Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:16:13Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:16:13Updated token to customer project scope SUCCESS
   03/22/18 09:16:13Vlink vl-lan-0 is not created, about to create
   03/22/18 09:16:18Vlink vl-lan-0 creation SUCCESS, vl-id = e93602b2-84a2-46c8-8eaa-958ff969a2ee
   03/22/18 09:16:18Create Vlink vl-lan-0 SUCCESS
   03/22/18 09:16:19Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:16:19Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:16:19Updated token to customer project scope SUCCESS
   03/22/18 09:16:19Vlink vl-lan-1 is not created, about to create
   03/22/18 09:16:24Vlink vl-lan-1 creation SUCCESS, vl-id = cf4fcdc5-f166-4fb8-a30d-ca87d0bb7328
   03/22/18 09:16:24Create Vlink vl-lan-1 SUCCESS
   03/22/18 09:16:24Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:16:24Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:16:25Updated token to customer project scope SUCCESS
   03/22/18 09:16:25Vlink vl-aux-0 is not created, about to create
   03/22/18 09:16:29Vlink vl-aux-0 creation SUCCESS, vl-id = c23af9e6-68da-46f1-864f-ad887e868f78
   03/22/18 09:16:29Create Vlink vl-aux-0 SUCCESS
   03/22/18 09:16:30Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:16:30Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:16:30Updated token to customer project scope SUCCESS
   03/22/18 09:16:30Vlink vl-aux-1 is not created, about to create
   03/22/18 09:16:34Vlink vl-aux-1 creation SUCCESS, vl-id = f0c638a5-2aa4-4463-942d-74157bed9386
   03/22/18 09:16:34Create Vlink vl-aux-1 SUCCESS
   03/22/18 09:16:35Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:16:35Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:16:35Updated token to customer project scope SUCCESS
   03/22/18 09:16:35Vlink vl-aux-2 is not created, about to create
   03/22/18 09:16:40Vlink vl-aux-2 creation SUCCESS, vl-id = 32f559de-6b6e-4ca4-87a7-98ac8826ff9e
   03/22/18 09:16:40Create Vlink vl-aux-2 SUCCESS
   03/22/18 09:16:40Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:16:40Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:16:40Updated token to customer project scope SUCCESS
   03/22/18 09:16:40Vlink vl-wan-0 is not created, about to create
   03/22/18 09:16:45Vlink vl-wan-0 creation SUCCESS, vl-id = 4237044c-9921-40d9-a491-9aa5ca5d7e65
   03/22/18 09:16:45Create Vlink vl-wan-0 SUCCESS
   03/22/18 09:16:45Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:16:45Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:16:45Updated token to customer project scope SUCCESS
   03/22/18 09:16:45Vlink vl-wan-1 is not created, about to create
   03/22/18 09:16:49Vlink vl-wan-1 creation SUCCESS, vl-id = 97034384-a121-4c94-b5ba-025bdde738da
   03/22/18 09:16:49Create Vlink vl-wan-1 SUCCESS
   03/22/18 09:16:50Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:16:50Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:16:50Updated token to customer project scope SUCCESS
   03/22/18 09:16:50Vlink vl-wan-2 is not created, about to create
   03/22/18 09:16:54Vlink vl-wan-2 creation SUCCESS, vl-id = 704295b2-533f-4db7-977c-ef56da7ecf9a
   03/22/18 09:16:54Create Vlink vl-wan-2 SUCCESS
   03/22/18 09:16:55Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:16:55Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:16:55Updated token to customer project scope SUCCESS
   03/22/18 09:16:55Vlink vl-wan-3 is not created, about to create
   03/22/18 09:17:20Vlink vl-wan-3 creation SUCCESS, vl-id = 490cb239-53e0-46f8-85da-4276bd4fa4fc
   03/22/18 09:17:20Create Vlink vl-wan-3 SUCCESS
   03/22/18 09:17:20Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:17:20Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:17:20Updated token to customer project scope SUCCESS
   03/22/18 09:17:20Vlink vl-mgmt is not created, about to create
   03/22/18 09:17:25Vlink vl-mgmt creation SUCCESS, vl-id = 41757423-fa6c-4823-8d8a-6fc127c09a42
   03/22/18 09:17:25Updated vlink info mgmt_net_id to topo device SUCCESS
   03/22/18 09:17:25Create Vlink vl-mgmt SUCCESS
   03/22/18 09:17:25Task complete
   03/22/18 09:17:25Task complete
   Task: 8
   03/22/18 09:05:11Task started
   03/22/18 09:17:25Issue all service libs SUCCESS
   03/22/18 09:17:26Install Monitor Obj Stage 1: resolve profile install-monitoring-agent SUCCESS
   03/22/18 09:17:26Issue all service libs SUCCESS
   03/22/18 09:17:26notification handler info: {"notification_info": {"queue": "tssm.ztp.queue.bef681be-26ae-4bb0-8b91-d71725b9e63c", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "mnt_agt_inst_bef681be-26ae-4bb0-8b91-d71725b9e63c", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   03/22/18 09:17:26Calling install_device_package RPC SUCCESS, request_id: 076005db-f002-463c-8494-61e55200f024
   03/22/18 09:17:46Received notification of install_device_package RPC: {"package_image_uuid": "944c5d4d-b299-4e6a-9f9b-19e9ffb63e17", "reason": null, "requestid": "076005db-f002-463c-8494-61e55200f024", "device_id": "16635dec-2da7-11e8-8019-0242ac101b34", "response": "SUCCESS", "component_name": "JDM"}
   03/22/18 09:17:46Install_device_package SUCCESS
   03/22/18 09:17:47Install Monitor Obj Stage 2: install fmpm agent for device 16635dec-2da7-11e8-8019-0242ac101b34 SUCCESS
   03/22/18 09:17:47Task complete
   Task: 10
   03/22/18 09:05:11Task started
   03/22/18 09:17:47Issue all service libs SUCCESS
   03/22/18 09:17:48Create monitoring obj stage 1: resolve profile create-monitoring-object SUCCESS
   03/22/18 09:17:48Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:17:48Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:17:48Updated token to customer project scope SUCCESS
   03/22/18 09:17:48create monitored object for device 16635dec-2da7-11e8-8019-0242ac101b34 SUCCESS
   03/22/18 09:17:49Task complete
   Task: 11
   03/22/18 09:05:11Task started
   03/22/18 09:18:06Activate OTT Task Start, task_id = 11 ...
   03/22/18 09:18:06Initiate all service libs SUCCESS
   03/22/18 09:18:06Activate OTT Stage 1: get vpn id 8928d6d3-c3e4-4dc4-b344-a102902c2538 and topo device uuid d007a0d1-8004-4817-81d1-6f4540930311 SUCCESS
   03/22/18 09:18:06notification handler info: {"notification_info": {"queue": "tssm.ztp.queue.e756eb85-cb01-4d71-a328-1353ae1a45b0", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "activate_ott_e756eb85-cb01-4d71-a328-1353ae1a45b0", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   03/22/18 09:18:06Activate OTT Stage 2: request for activate-ott SUCCESS, request_id = 913c82eb-64ce-4cd8-ae4a-5487fe439d6c
   03/22/18 09:19:20Activate OTT Stage 3: receive activate-ott notification = {"status": "success", "message": "Job finished successfully, please check task status for details Create device discover job successfully", "request_id": "913c82eb-64ce-4cd8-ae4a-5487fe439d6c"}
   03/22/18 09:19:20Activate OTT Stage 3: activate ott SUCCESS
   03/22/18 09:19:21Activate OTT Stage 4: update topo device management state to activated SUCCESS
   03/22/18 09:19:21Activate OTT Task Complete success
   03/22/18 09:19:21Task complete
   Task: 9
   03/22/18 09:05:11Task started
   03/22/18 09:17:49Start service monitoring issue all service libs SUCCESS
   03/22/18 09:17:50Register link monitoring : resolve profile start-fmpm-service-monitoring SUCCESS
   03/22/18 09:17:50Topo device d007a0d1-8004-4817-81d1-6f4540930311 maps to topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6
   03/22/18 09:17:50Topo site 6a4e7286-24cc-4694-b4cf-8f13e3ce55d6 maps to tssm site e73923e8-56d0-4cd0-875f-5e8d824ef8e5
   03/22/18 09:17:51Updated token to customer project scope SUCCESS
   03/22/18 09:17:51Issue all service libs SUCCESS
   03/22/18 09:17:51Calling monitor_service_batch_execute RPC SUCCESS , object_id: 16635dec-2da7-11e8-8019-0242ac101b34
   03/22/18 09:17:51notification handler info: {"notification_info": {"queue": "tssm.fmpm_api_que-16635dec-2da7-11e8-8019-0242ac101b34", "exchange": "fmpm_api_status", "routing_key": "#.16635dec-2da7-11e8-8019-0242ac101b34", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   03/22/18 09:17:58Received notification of monitor_service_batch_execute RPC:
   03/22/18 09:17:58Start Service Monitoring SUCCESS
   03/22/18 09:17:59Received notification of monitor_service_batch_execute RPC:
   03/22/18 09:17:59Start Service Monitoring SUCCESS
   03/22/18 09:18:05Received notification of monitor_service_batch_execute RPC:
   03/22/18 09:18:05Start Service Monitoring SUCCESS
   03/22/18 09:18:05Start service monitoring for device 16635dec-2da7-11e8-8019-0242ac101b34 SUCCESS
   03/22/18 09:18:05Task complete
   Task: 12
   03/22/18 09:05:11Task started
   03/22/18 09:19:21Stage 2 config start, task_id = 12 ...
   03/22/18 09:19:22Start stage-2-config stage 1: resolve profile stage-2-config success
   03/22/18 09:19:22Start stage-2-config stage 2: create abstract configs success: {'JDM': [], 'JUNOS': [], 'JCP': [], 'GWR': []}
   03/22/18 09:19:22No config to be published and deployed at this time
   03/22/18 09:19:22Start stage-2-config task SUCCESS
   03/22/18 09:19:22Task complete
   03/22/18 09:19:24Ztp-activation finished complete for ems-device 16635dec-2da7-11e8-8019-0242ac101b34
   

You will now see the Device in the Site as “Provisioned”. After this no new ZTP process is possible for this device to prevent malicious attackers to hijack devices.

|image170|

#

# After provisioning is completed

#

|image171|

Select the configuration tab

|image172|

Select the “VLAN Configuration” Tab left and click (+) to add you LAN side client configuration.

|image173|

Use:

VLAN Id=99

IRB Ip Prefix=10.99.99.1/24

Edit the LAN Ports and select ge-0/0/0 like below before you save

.. note:: The LAN Port itself will be access/native without a VLAN tag as the VLAN id might indicate.

|image174|

|image175|

|image176|

After the configuration change has been saved you need to deploy it

|image177|

This will tell CSO to activate the LAN Port. Review your success in the monitoring page.

|image178|

After deploy use VNC to desktop1-VM to emulate a client. Review Chapter 2.8 above for instructions how to use VNC. Example below

.. code-block:: none

   virsh vncdisplay desktop1
   :8

|image179|

If you open a Terminal on the Client Desktop you should be able to ping 8.8.8.8 or access any other internet host to prove the forwarding is ok.

|image180|

If you let the Ping continuously run you can expect the session forwarding table on the vSRX in the NFX250

.. code-block:: none

   show security flow session destination-prefix 8.8.8.8
   Session ID: 81, Policy name: allow_all/4, Timeout: 2, Valid
     In: 10.99.99.99/30 --> 8.8.8.8/2538;icmp, Conn Tag: 0x0, If: ge-0/0/4.0, Pkts
     Out: 8.8.8.8/2538 --> 10.99.99.99/30;icmp, Conn Tag: 0x0, If: ge-0/0/2.0, Pkt
   
   Session ID: 82, Policy name: allow_all/4, Timeout: 2, Valid
     In: 10.99.99.99/31 --> 8.8.8.8/2538;icmp, Conn Tag: 0x0, If: ge-0/0/4.0, Pkts
     Out: 8.8.8.8/2538 --> 10.99.99.99/31;icmp, Conn Tag: 0x0, If: ge-0/0/2.0, Pkt
   
   Session ID: 83, Policy name: allow_all/4, Timeout: 4, Valid
     In: 10.99.99.99/32 --> 8.8.8.8/2538;icmp, Conn Tag: 0x0, If: ge-0/0/4.0, Pkts
     Out: 8.8.8.8/2538 --> 10.99.99.99/32;icmp, Conn Tag: 0x0, If: ge-0/0/2.0, Pkt
   Total sessions: 3

.. note:: In this deployment option the vSRX from LAN to WAN as in the same Zone as you see below. So any Firewall rule has to be configured trust <-> trust

.. code-block:: none

   show security zones

   Security zone: HOST
     Send reset for non-SYN session TCP packets: Off
     Policy configurable: Yes
     Interfaces bound: 0
     Interfaces:

   Security zone: trust
     Send reset for non-SYN session TCP packets: Off
     Policy configurable: Yes
     Interfaces bound: 6
     Interfaces:
       ge-0/0/1.0
       ge-0/0/2.0    # WAN Port for default MPLS
       ge-0/0/4.0    # LAN Port with Desktop client
       ge-0/0/5.0
       ge-0/0/6.0
       st0.1         # IPsec Tunnel End for Backup Internet Path

   Security zone: untrust
     Send reset for non-SYN session TCP packets: Off
     Policy configurable: Yes
     Interfaces bound: 1
     Interfaces:
       ge-0/0/3.0

   Security zone: junos-host
     Send reset for non-SYN session TCP packets: Off
     Policy configurable: Yes
     Interfaces bound: 0
     Interfaces:

.. warning:: /\* fixme more test cases to be added and documented here:Firewall configuration changeInternet Backup failoverRiverbed VNF inclusion*/

/\* The below is just a place holder and not a completed and tested scenario for now \*/

#

# RIVERBED

#

#

# Caution! **Do NOT use the console port to this VM** during a demo as CSO needs it to configure the IP-addresses

#

.. code-block:: none

   RAW_TOKEN=`curl -d '{"auth":{"tenantName":"admin", "passwordCredentials":{"username":"admin", "password":"passw0rd"}}}' -H "Content-type: application/json" http://172.30.200.161:5000/v2.0/tokens`
   TOKEN=`echo $RAW_TOKEN | python -c "import sys; import json; tok = json.loads(sys.stdin.read()); print tok['access']['token']['id'];"`
   echo $TOKEN


   curl -v --insecure -X POST -H "x-auth-token:$TOKEN" -H "Content-Type: multipart/form-data" -F "imagefile=@/root/RIVERBED.tgz" -F "cname=riverbed-img" -F "image_type=VNF_IMAGE" -F "description=riverbed image" -F "device_family=riverbed-vx" -F "supported_platform=Riverbed" -F "vendor=Riverbed" -F "major_version=1" -F "minor_version=1" -F "build_num=1.1"  "https://172.30.200.162/ims-central/upload_image_file"

Checking VNF network reachability.

Ping Succeeded. The VNF is up!

{"eth0br_ip": "10.10.20.1/24", "eth0br_gateway": "10.10.20.254", "csp_prefix": "192.168.128.0/24", "oam_ip_address": "", "primary_dns": "8.8.8.8", "hostname": "Riverbed-WANOPT", "oam_gateway": ""}

.. code-block:: none

   ssh admin@10.10.20.1 (password)

   riverbed > ena
   riverbed # tcpdump -n -e -i wan0_0 host 8.8.8.8



   Connected to domain Riverbed-WANOPT
   Escape character is ^]

   Riverbed SteelHead
   amnesiac login:
   admin
   Riverbed SteelHead
   amnesiac login: admin
   Password: password


   Riverbed SteelHead configuration wizard.

   Do you want to auto-configure using a SCno
   C? no

   Do you want to use the wizard for initial configurationyes
   ? yes

   Step 1: HostnamRiverbed-WANOPT
   e? [amnesiac] Riverbed-WANOPT
   Step 2: Use DHCP on primary interfaceyes
   ? [yes] yes
   Step 3: Admin passworpassword
   d? password
   Step 4: SMTP server

   ? []
   Step 5: Notification email address?


   Step 6: Set the primary interface speed? [auto]
   auto

   Step 7: Set the primary interface duplex? [auto]
   auto

   Step 8: Would you like to activate the in-path configuration? [no] auto

   Please enter 'y' to activate the In-Path
   configuration.  You will be asked to fill in additional
   configuration settings for the in path network port. If you
   choose not to activate the in-path configuration by entering 'n',
   you can always enable it later.
   Step 8: Wno
   ould you like to activate the in-path configuration? [no] auto

   Please enter 'y' to activate the In-Path
   configuration.  You will be asked to fill in additional
   configuration settings for the in path network port. If you
   choose not to activate the in-path configuration by entering 'n',
   you can always enable it later.
   Step 8: Would you like to activate the in-path configuration? [no] nono

   no
   Step 9: Would you like to activate the out-of-path configurationno
   ? [no] no
   no

   You have entered the following information:

      1. Hostname: Riverbed-WANOPT
      2. Use DHCP on primary interface: yes
      3. Admin password: password
      4. SMTP server:
      5. Notification email address:
      6. Set the primary interface speed: auto
      7. Set the primary interface duplex: auto
      8. Would you like to activate the in-path configuration: no
      9. Would you like to activate the out-of-path configuration: no

   To change an answer, enter the step number to return to.
   Otherwise hit <enter> to save changes and exit.

   Choice: no



   To change an answer, enter the step number to return to.
   Otherwise hit <enter> to save changes and exit.

   Choice:


   Configuration changes saved.

   To return to the wizard from the CLI, use the "configuration jump-start"
   command in configure mode. Enter configuration mode using commands "enable"
   and "configure terminal."  Launching CLI...

   Riverbed-WANOPT > enable

   Riverbed-WANOPT > enable
   Riverbed-WANOPT # conf t
   conf t
   Riverbed-WANOPT (config) # no interface aux dhcp
   no interface aux dhcp
   Riverbed-WANOPT (config) # interface aux ip address 10.10.20.1 255.255.255.0
   interface aux ip address 10.10.20.1 255.255.255.0
   Riverbed-WANOPT (config) # ip default-gateway 10.10.20.254
   ip default-gateway 10.10.20.254
   Riverbed-WANOPT (config) # ip route 192.168.128.0 /24 10.10.20.254
   ip route 192.168.128.0 /24 10.10.20.254
   Riverbed-WANOPT (config) # write mem
   write mem
   Riverbed-WANOPT (config) # configuration write
   configuration write
   Riverbed-WANOPT (config) # restart
   restart
   Terminating optimization service....
   Relaunching optimization service.
   Riverbed-WANOPT (config) # exit
   exit
   Riverbed-WANOPT # exit


   Connected to domain Riverbed-WANOPT
   Escape character is ^]

   Riverbed SteelHead
   Riverbed-WANOPT login:
   root@jdm:/var/tmp#

Test case execution related to SD-WAN BASIC use-cases
=====================================================

Hub1 (srx1500-1) install for SD-WAN BASIC
-----------------------------------------

In this Chapter we don’t do the first stage of ZTP via remote download to show you the difference. It’s done on purpose; as this may also help you in the Field to bring up devices via a changed local configuration if something was not foreseen by CSO to be applied during initial device on-boarding.

If you want you can use the regular ZTP procedure but then you need to add a phone-home server configuration to the default config; download the certificate and in the template don’t leave ZTP enable in default (blue) state. After the configuration is applied do not forget to add default routes to ge-0/0/1 as example.

Change the Template of the Device first to:

|image181|

|image182|

.. note:: If your Hub is a SRX4x00 you need to modify this template before you apply it. On this Platform all Interfaces are named “\ **xe**-?/?/?” and **not** “\ **ge**-?/?/?” so you need to change that below!

Disable Activation code and disable ZTP_Enabled as we need the config in Junos format to **OVERRIDE** it. A ZTP process would overwrite the whole existing config!!!

We also need to change the OAM_CE_0 Interface as we have our BGP-Peering on a separate interface and not one of the WAN interfaces.

.. warning:: Starting with CSO 4.1.0 the device root passwords are no longer “Embe1mpls” after you have installed CSO. We are changing it back here, as it’s easier in a lab to debug items with known passswords, but this is **NOT RECOMMENDED FOR PRODUCTION**.

|image183|

|image184|

Now. Just create a blank PoP with a name but NO device, VIM or EMS added.

|image185|

|image186|

.. code-block:: none

   cat <<EOF >sdwan-pop.json
   {
       "input": {
           "job_name_prefix": "sdwan-pop",
           "pop": [
               {
                   "dc_name": "regional",
                   "name": "sdwan-pop",
                   "coordinates": {},
                   "address": {
                       "country": "US"
                   }
               }
           ]
       }
   }
   EOF

Add a new Cloud Hub

|image187|

|image188|

|image189|

|image190|

|image191|

|image192|

.. note:: Everything you do in the GUI in terms of hub/spoke config can be reviewed as JSON on the central-msvm in the directory /opt/csp/logs/tssm-api/apidump after you applied it.

.. code-block:: none

   cat <<EOF >sdwan-hub1.json
   {
       "input": {
           "tenant_name": "default-project",
           "job_name_prefix": "hub1-HUB-SITE",
           "site": [
               {
                   "on_premise_site_info": {
                       "region": "regional",
                       "pop": "sdwan-pop",
                       "site_role": "HUB",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       },
                       "device": [
                           {
                               "wan_link": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/0",
                                       "overlay_tunnel": [],
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.190.1",
                                           "ip_address": "192.168.190.254/24"
                                       },
                                       "traffic_type": "DATA_ONLY",
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC"
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/1",
                                       "overlay_tunnel": [],
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.191.1",
                                           "ip_address": "192.168.191.254/24"
                                       },
                                       "traffic_type": "DATA_ONLY",
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC"
                                   }
                               ],
                               "device_name": "hub1",
                               "device_template": "SRX_Advanced_SDWAN_HUB_option_1",
                               "device_details": {
                                   "serial_number": "CZ0317AF0302",
                                   "boot_image": ""
                               },
                               "vpn_authentication": "preshared_key",
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.1/32"
                               }
                           }
                       ],
                       "site_capabilities": "OAM_AND_DATA"
                   },
                   "site_name": "hub1",
                   "user_defined_properties": [
                       {
                           "name": "oam-ce-intf",
                           "value": "ge-0/0/4"
                       },
                       {
                           "name": "oam-ce-intf-prefix",
                           "value": "192.168.194.254/24"
                       },
                       {
                           "name": "oam-gateway",
                           "value": "192.168.194.1"
                       },
                       {
                           "name": "ebgp_peer_as",
                           "value": "65000"
                       }
                   ]
               }
           ]
       }
   }
   EOF

|image193|

|image194|

.. note:: **Some devices like the SRX4xxx do NOT support phone-home in their Junos Firmware!** This is another of the reasons why we apply the Stage-1 config directly and not via Phone-Home. As this is the Hub, it is better and safer to use this approach instead.

This will bring up a window with the Stage-1 Junos config

|image195|

Copy the ENTIRE configuration from this window and Ssh to srx1500-1 192.168.190.254 (root/Embe1mpls)

.. code-block:: none

   start shell
   #rm /var/tmp/srx1500-1.stage1
   vi /var/tmp/srx1500-1.stage1

.. warning:: You can **NOT REUSE OLDER** Stage-1 configs! They contain outdated outbound-ssh Keys and won’t login into CSO anymore.

Paste the Config from CSO in your Editor and save&quit the editor

.. code-block:: none

   exit
   edit
   load override /var/tmp/srx1500-1.stage1
   #
   # CSO doesn’t set a default route so add this here
   #
   set routing-options static route 0.0.0.0/0 next-hop 192.168.191.1
   set routing-options static route 0.0.0.0/0 no-readvertise
   #
   # Also the following routes help in your environment to ensure the right path is used as we don’t have a routing protocol helping us.
   #
   set routing-options static route 192.168.130.0/24 next-hop 192.168.190.1
   set routing-options static route 192.168.130.0/24 no-readvertise
   set routing-options static route 192.168.133.0/24 next-hop 192.168.191.1
   set routing-options static route 192.168.133.0/24 no-readvertise
   set routing-options static route 192.168.150.0/24 next-hop 192.168.190.1
   set routing-options static route 192.168.150.0/24 no-readvertise
   set routing-options static route 192.168.153.0/24 next-hop 192.168.191.1
   set routing-options static route 192.168.153.0/24 no-readvertise
   set routing-options static route 192.168.170.0/24 next-hop 192.168.190.1
   set routing-options static route 192.168.170.0/24 no-readvertise
   set routing-options static route 192.168.173.0/24 next-hop 192.168.191.1
   set routing-options static route 192.168.173.0/24 no-readvertise
   
   commit and-quit

**You WILL lose the ssh connection** after the committed configuration is applied.

This is normal! It proves that the Hub is now using the OAM-IP which was applied as part of the stage1 configuration.

**You need to change now to the new SSH IP-Address to futher look at the device.**

|image196|

You should now re-login using the OAM-IP (or alternatively the WAN_1-IP if the BGP peering in the underlay is not working as expected).

.. code-block:: none

   ssh root@192.168.210.1
   or alternatively in worst case
   ssh root@192.168.191.254

Test reachability to central-msvm.

.. note:: This output is from the QFX5100-1

.. code-block:: none

   show bgp summary
   Groups: 1 Peers: 1 Down peers: 0
   Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
   192.168.194.254       64512          5          3       0       0          12 Establ
     secure-oam.inet.0: 1/1/1/0

   show route table secure-oam
   secure-oam.inet.0: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 15:24:36
                       > to 192.168.70.1 via irb.70
   192.168.10.0/24    *[Static/5] 15:24:36
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 15:24:36
                       > via irb.70
   192.168.70.254/32  *[Local/0] 15:24:36
                         Local via irb.70
   192.168.194.0/24   *[Direct/0] 14:10:03
                       > via ge-0/0/41.0
   192.168.194.1/32   *[Local/0] 14:10:03
                         Local via ge-0/0/41.0
   192.168.210.1/32   *[BGP/170] 00:01:30, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via ge-0/0/41.0

You see the reverse now happening on the Hub device

.. code-block:: none

   show bgp summary
   Groups: 1 Peers: 1 Down peers: 0
   Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
   inet.0
                          0          0          0          0          0          0
   Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
   192.168.194.1         65000          9         10       0       0        3:08 Establ
     oam-vrf.inet.0: 1/1/1/0

   show route table oam-vrf

   oam-vrf.inet.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   192.168.10.0/24    *[BGP/170] 00:08:39, localpref 100
                         AS path: 65000 I, validation-state: unverified
                       > to 192.168.194.1 via ge-0/0/4.0
   192.168.194.0/24   *[Direct/0] 00:08:44
                       > via ge-0/0/4.0
   192.168.194.254/32 *[Local/0] 00:08:44
                         Local via ge-0/0/4.0
   192.168.210.1/32   *[Direct/0] 00:08:44
                       > via lo0.1

   # check if the system has a secure-shell connection using port 7804 
   # that will verify CSO can do Netconf with the device
   show security flow session destination-prefix 192.168.10.42
   Session ID: 19, Policy name: self-traffic-policy/1, Timeout: 1786, Valid
     In: 192.168.210.1/52527 --> 192.168.10.42/7804;tcp, Conn Tag: 0x0, If: .local..0, Pkts: 54, Bytes: 13098,
     Out: 192.168.10.42/7804 --> 192.168.210.1/52527;tcp, Conn Tag: 0x0, If: xe-0/0/4.0, Pkts: 38, Bytes: 5689,
   Total sessions: 1

   ping 192.168.10.42 routing-instance oam-vrf
   PING 192.168.10.42 (192.168.10.42): 56 data bytes
   64 bytes from 192.168.10.42: icmp_seq=0 ttl=62 time=1.355 ms
   64 bytes from 192.168.10.42: icmp_seq=1 ttl=62 time=1.075 ms
   ^C
   --- 192.168.10.42 ping statistics ---
   2 packets transmitted, 2 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 1.075/1.215/1.355/0.140 ms

When you see the BGP Peering between Hub and underlay QFX5100 happing you then need to **activate the Device** so that CSO will Provision it and bring it under it’s control.

The system will not start with the provison until you trigger this and you will wait until doomsday. Wait until the Management Status changes to “Device_Connected” the do the activation.

|image197|

|image198|

When the window above state “active” you still need to wait until the process is really finished as below visible via the monitoring window. After a few minutes the provisioning process should automatically start (lasting 2-3minutes typically)

|image199|

As result of this process you should see an established bgp peering with the vRR AND the QFX5100 underlay. If not do not continue and resolve this first.

.. code-block:: none

   show bgp summary
   Groups: 2 Peers: 2 Down peers: 0
   Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
   inet.0
                          0          0          0          0          0          0
   bgp.l3vpn.0
                          0          0          0          0          0          0
   Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
   192.168.10.49         64512          5          6       0       0        3:20 Establ
     bgp.l3vpn.0: 0/0/0/0
   192.168.194.1         65000         26         28       0       0       11:10 Establ
     oam-vrf.inet.0: 1/1/1/0 

|image200|

The hub is now ready to be used.

Create a Tenant
---------------

In this step we create one Tenant to be used by your Spokes/Hub independent if you have just one Spoke or multiple and which device-types they are.

Still be in the global admin account and click on Tenant -> Add

|image201|

.. warning:: Advice: Do not change the Name Tenant Name to anything else then “hubspoketenant”. This will make it harder for you to debug and fix issues that may appear.Do not try to be creative here and follow the conventions as are.

.. note:: You might get an message that SMPT is not configured. IGNORE this message. Usually it’s used to send the password to the tenant account but we don’t use this in this lab as we are “cspadmin” and can change directly to a Tenant-View

|image202|

.. note:: We are using the older Bandwidth optimized mode on purpose to be able to show later the Realtime mode using AppQoE. If you are short on time and need to demo mesh as well you might straight use realtime but note that the whole config inside the device will change and stuff may be different.

|image203|

No need to change anything below

|image204|

|image205|

.. code-block:: none

   {
       "input": {
           "tenant_admin": {
               "password_expiration_interval": 0,
               "admin_user_name": "juniperse@juniper.net",
               "last_name": "Doe",
               "first_name": "Joe",
               "roles": [
                   "9fe2ff9e-e438-4b18-94a9-0878d3e92bab"
               ]
           },
           "tenant_name": "hubspoketenant",
           "default_ssl_proxy_profile": {
               "enabled": false
           },
           "supported_deployment_scenario": [
               "managed_wan_v2"
           ],
           "departments": [
               {
                   "vpn_name": "hubspoketenant_DefaultVPN",
                   "department_name": "Default"
               }
           ],
           "ipsec_vpn_cfg": {
               "vpn_authentication": {
                   "preshared_key_enabled": true
               },
               "overlay_tunnel_encryption": {
                   "encryption_type": "aes-256-gcm"
               }
           },
           "password_expiration_radio": "never",
           "vpn": [
               {
                   "vpn_name": "hubspoketenant_DefaultVPN",
                   "tunnel_type": "GRE_IPSEC",
                   "topology": "hub_spoke"
               }
           ],
           "managed_wan_topology_v2": {},
           "properties": {
               "property": [
                   {
                       "name": "default-tenant-topology",
                       "value": "hub_spoke"
                   },
                   {
                       "name": "sla_mgmt",
                       "value": "COARSE"
                   }
               ]
           }
       }
   } 

After the Tenant is created you should see him here:

|image206|

Add the Hub to your Tenant
--------------------------

Now change directly to the View of the Tenant itself

|image207|

Here we now need to import the Cloud Hub with is our “hub1” object.

|image208|

|image209|

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "hubspoketenant",
           "job_name_prefix": "Create-Site-for-hub1",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "hub1",
                   "cloud_hub_site_info": {
                       "hub_device": "hub1",
                       "wan_links": [
                           "WAN_1",
                           "lo0.0",
                           "WAN_0"
                       ],
                       "pop": "sdwan-pop"
                   },
                   "site_basic_properties": {
                       "site_address": {
                           "country": "US"
                       },
                       "site_description": "",
                       "site_role": "HUB",
                       "cloud_service": "NONE",
                       "site_type": "cloud"
                   }
               }
           ]
       }
   }
   

This is a fast process that after a minute should show your hub avail.

|image210|

SRX345 as Spoke for SD-WAN BASIC
--------------------------------

First change back to the Global View to change the Device Template as cspadmin

|image211|

First patch the template not to ask for an authorization code. This would else cause that someone local to the device will have to fill in the code to get the provisioning started.

|image212|

|image213|

.. warning:: Starting with CSO 4.1.0 the device root passwords are no longer “Embe1mpls” after you have installed CSO. We are changing it back here, as it’s easier in a lab to debug items with known passswords, but this is **NOT RECOMMENDED FOR PRODUCTION**.

|image214|

|image215|

.. warning:: If your device is an SRX300/320 you also MUST disable Auto_install_default_Certificate. The reason is mentioned in chapter 2.12 above. If you forget this the Device-provisioning may fail!!!

|image216|

Now change directly to the View of the Tenant itself

|image217|

|image218|

|image219|

|image220|

|image221|

|image222|

Do NOT enable any sophisticated features such as local-breakout for the lab yet. Just default links to every to interfaces and you are set.

|image223|

|image224|

|image225|

|image226|

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "hubspoketenant",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "sdwansite1",
                   "site_basic_properties": {
                       "local_breakout": {},
                       "gatewaySite": false,
                       "site_type": "on_premise",
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": false,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "provider": "abc",
                                       "wan_link": "WAN_0",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "092cf611-3f6f-5df3-96c3-14f37a7ebce7",
                                       "cost": 2222,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "provider": "xyz",
                                       "wan_link": "WAN_1",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "afbdcdda-239f-0a61-2dd8-3cab7c06a5ce",
                                       "cost": 111,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "SRX_Advanced_SDWAN_CPE_option_1",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "10.88.88.1/24",
                                       "lan_segment_name": "desktop2",
                                       "vlan": 1088,
                                       "lan_ports": [
                                           "LAN_4"
                                       ],
                                       "department": "Default",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwansite1"
                           }
                       ],
                       "0": {
                           "ip_prefix": "10.88.88.1/24",
                           "lan_segment_name": "desktop2",
                           "vlan": 1088,
                           "lan_ports": [
                               "LAN_4"
                           ],
                           "department": "Default",
                           "dhcp": false
                       },
                       "site_role": "SPOKE",
                       "sla_mgmt": "COARSE",
                       "device_profile_name": "SRX as SD-WAN CPE",
                       "site_name": "sdwansite1",
                       "site_group": null,
                       "dvpn_params": {
                           "delete_dvpn_threshold": "1",
                           "create_dvpn_threshold": "5"
                       },
                       "topology": "Bandwidth Optimized"
                   }
               }
           ]
       }
   }
   

|image227|

|image228|

|image229|

Set the correct **Loopback IP** for management session **192.168.210.3/32**

|image230|

|image231|

|image232|

|image233|

|image234|

.. note:: You NEED to perform a Device activation!!!

|image235|

.. warning:: Wait until you see that Stage-1 ZTP was successful and the Device_Detected Stage appears. THEN you activate the Device.

|image236|

|image237|

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "hubspoketenant",
           "job_name_prefix": "hubspoketenant-sdwansite1",
           "site": [
               {
                   "on_premise_site_info": {
                       "device": [
                           {
                               "device_template": "SRX_Advanced_SDWAN_CPE_option_1",
                               "is_gateway_site": false,
                               "wan_link": [
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/0",
                                       "used_for_oam": true,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.170.1",
                                           "ip_address": "192.168.170.2/24"
                                       },
                                       "local_breakout_enabled": false,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/1",
                                       "used_for_oam": true,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.173.1",
                                           "ip_address": "192.168.173.2/24"
                                       },
                                       "local_breakout_enabled": false,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   }
                               ],
                               "device_name": "sdwansite1",
                               "device_family": "juniper-srx",
                               "device_details": {
                                   "serial_number": "CV2116AF0288"
                               },
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.3/32"
                               }
                           }
                       ],
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "region": "regional",
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       }
                   },
                   "site_name": "sdwansite1",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }
   

.. note:: In the past, when a Hardware SRX waits more than 24hours for ZTP, it could hang up internally. All looks good as it would still attempt to ZTP but nothing really happens. If you wait more then 10 minutes then reboot the device to solve this.

**/\* fixme provision of SRX300 fails in CSO 4.1.0 beta this testcase couldn’t be verified \*/**

#

# WAIT ~10MINUTES!!!! That's how long this process takes with all the commits to the SRX345

#

|image238|

.. note:: Again during the provision Process you may lose the SSH-connection same as for your hub in the previous chapter. Re-Login via the Device OAM-IP

.. code-block:: none

   ssh root@192.168.210.3

.. code-block:: none

   
   root@CV2116AF0288.sdwansite1.hubspoketenant> show bgp neighbor
   Peer: 192.168.10.49+51542 AS 64512 Local: 192.168.210.3+179 AS 64512
     Type: Internal    State: Established    Flags: <Sync>
     Last State: OpenConfirm   Last Event: RecvKeepAlive
     Last Error: Open Message Error
     Export: [ static-export ] Import: [ next-hop-change ]
     Options: <Preference LocalAddress HoldTime AddressFamily Rib-group Refresh>
     Options: <VpnApplyExport LLGR>
     Address families configured: inet-vpn-unicast
     Local Address: 192.168.210.3 Holdtime: 200 Preference: 170
     NLRI inet-vpn-unicast:
     Number of flaps: 0
     Error: 'Open Message Error' Sent: 1 Recv: 0
     Peer ID: 192.168.10.49   Local ID: 192.168.210.3     Active Holdtime: 200
     Keepalive Interval: 66         Group index: 1    Peer index: 0
     BFD: disabled, down
     NLRI for restart configured on peer: inet-vpn-unicast
     NLRI advertised by peer: inet-vpn-unicast
     NLRI for this session: inet-vpn-unicast
     Peer supports Refresh capability (2)
     Stale routes from peer are kept for: 300
     Restart time requested by this peer: 0
     Restart flag received from the peer: Notification
     NLRI that peer supports restart for: inet-vpn-unicast
     NLRI peer can save forwarding state: inet-vpn-unicast
     NLRI that peer saved forwarding for: inet-vpn-unicast
     NLRI that restart is negotiated for: inet-vpn-unicast
     NLRI of received end-of-rib markers: inet-vpn-unicast
     NLRI of all end-of-rib markers sent: inet-vpn-unicast
     NLRI and times for LLGR configured for peer: inet-vpn-unicast 27w5d 04:20:15
     NLRI and times that peer supports LLGR Restarter for: inet-vpn-unicast 27w5d 0                                                                                         4:20:15
     NLRI that peer saved LLGR forwarding for: inet-vpn-unicast
     Peer supports 4 byte AS extension (peer-as 64512)
     Peer does not support Addpath
     Table bgp.l3vpn.0
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: not advertising
       Active prefixes:              14
       Received prefixes:            14
       Accepted prefixes:            14
       Suppressed due to damping:    0
     Table transit.inet.0 Bit: 30000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          9
     Table LAN-hubspoketenant_DefaultVPN.inet.0 Bit: 60000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table Default-hubspoketenant_DefaultVPN.inet.0 Bit: 70000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table Default-reverse-hubspoketenant_DefaultVPN.inet.0 Bit: 80000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table mpls-hubspoketenant_DefaultVPN.inet.0 Bit: 90000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table internet-hubspoketenant_DefaultVPN.inet.0 Bit: a0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC1-hubspoketenant_DefaultVPN.inet.0 Bit: b0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC2-hubspoketenant_DefaultVPN.inet.0 Bit: c0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC3-hubspoketenant_DefaultVPN.inet.0 Bit: d0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC4-hubspoketenant_DefaultVPN.inet.0 Bit: e0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC5-hubspoketenant_DefaultVPN.inet.0 Bit: f0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC6-hubspoketenant_DefaultVPN.inet.0 Bit: 100000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC7-hubspoketenant_DefaultVPN.inet.0 Bit: 110000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC8-hubspoketenant_DefaultVPN.inet.0 Bit: 120000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC9-hubspoketenant_DefaultVPN.inet.0 Bit: 130000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC10-hubspoketenant_DefaultVPN.inet.0 Bit: 140000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Last traffic (seconds): Received 30   Sent 28   Checked 56
     Input messages:  Total 58     Updates 25      Refreshes 0     Octets 2921
     Output messages: Total 76     Updates 40      Refreshes 2     Octets 4505
     Output Queue[2]: 0            (transit.inet.0, inet-vpn-unicast)
     Output Queue[5]: 0            (LAN-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[6]: 0            (Default-hubspoketenant_DefaultVPN.inet.0, inet-                                                                                         vpn-unicast)
     Output Queue[7]: 0            (Default-reverse-hubspoketenant_DefaultVPN.inet.                                                                                         0, inet-vpn-unicast)
     Output Queue[8]: 0            (mpls-hubspoketenant_DefaultVPN.inet.0, inet-vpn                                                                                         -unicast)
     Output Queue[9]: 0            (internet-hubspoketenant_DefaultVPN.inet.0, inet                                                                                         -vpn-unicast)
     Output Queue[10]: 0           (TC1-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[11]: 0           (TC2-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[12]: 0           (TC3-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[13]: 0           (TC4-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[14]: 0           (TC5-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[15]: 0           (TC6-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[16]: 0           (TC7-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[17]: 0           (TC8-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[18]: 0           (TC9-hubspoketenant_DefaultVPN.inet.0, inet-vpn-                                                                                         unicast)
     Output Queue[19]: 0           (TC10-hubspoketenant_DefaultVPN.inet.0, inet-vpn                                                                                         -unicast)
   
   Peer: 192.168.210.1+179 AS 64512 Local: 192.168.210.3+59998 AS 64512
     Type: Internal    State: Established    Flags: <Sync>
     Last State: OpenConfirm   Last Event: RecvKeepAlive
     Last Error: None
     Export: [ oam-route-export-prim ] Import: [ prim-lp-import ]
     Options: <Preference LocalAddress AddressFamily Refresh>
     Address families configured: inet-unicast
     Local Address: 192.168.210.3 Holdtime: 90 Preference: 170
     Number of flaps: 0
     Peer ID: 192.168.210.1   Local ID: 192.168.210.3     Active Holdtime: 90
     Keepalive Interval: 30         Group index: 0    Peer index: 0
     BFD: disabled, down
     NLRI for restart configured on peer: inet-unicast
     NLRI advertised by peer: inet-unicast
     NLRI for this session: inet-unicast
     Peer supports Refresh capability (2)
     Stale routes from peer are kept for: 300
     Peer does not support Restarter functionality
     Restart flag received from the peer: Notification
     NLRI that restart is negotiated for: inet-unicast
     NLRI of received end-of-rib markers: inet-unicast
     NLRI of all end-of-rib markers sent: inet-unicast
     Peer does not support LLGR Restarter functionality
     Peer supports 4 byte AS extension (peer-as 64512)
     Peer does not support Addpath
     Table inet.0 Bit: 10000
       RIB State: BGP restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Last traffic (seconds): Received 2    Sent 2    Checked 46
     Input messages:  Total 137    Updates 2       Refreshes 0     Octets 2642
     Output messages: Total 139    Updates 1       Refreshes 0     Octets 2749
     Output Queue[0]: 0            (inet.0, inet-unicast)
   
   root@CV2116AF0288.sdwansite1.hubspoketenant> show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   ge-0/0/0                up    up
   ge-0/0/0.0              up    up   inet     192.168.170.2/24
   gr-0/0/0                up    up
   gr-0/0/0.4000           up    up   inet     172.19.193.54/31
                                      mpls
   gr-0/0/0.4002           up    up   inet     172.16.31.234/31
                                      mpls
   ip-0/0/0                up    up
   lsq-0/0/0               up    up
   lt-0/0/0                up    up
   mt-0/0/0                up    up
   sp-0/0/0                up    up
   sp-0/0/0.0              up    up   inet
                                      inet6
   sp-0/0/0.16383          up    up   inet     10.0.0.1            --> 10.0.0.16
                                               10.0.0.6            --> 0/0
                                               128.0.0.1           --> 128.0.1.16
                                               128.0.0.6           --> 0/0
   ge-0/0/1                up    up
   ge-0/0/1.0              up    up   inet     192.168.173.2/24
   ge-0/0/2                up    down
   ge-0/0/3                up    down
   ge-0/0/4                up    up
   ge-0/0/4.1088           up    up   inet     10.88.88.1/24
   ge-0/0/4.32767          up    up
   ge-0/0/5                up    up
   ge-0/0/6                up    up
   ge-0/0/7                up    down
   gre                     up    up
   ipip                    up    up
   irb                     up    up
   jsrv                    up    up
   jsrv.1                  up    up   inet     128.0.0.127/2
   lo0                     up    up
   lo0.0                   up    up   inet     192.168.210.3       --> 0/0
   lo0.16384               up    up   inet     127.0.0.1           --> 0/0
   lo0.16385               up    up   inet     10.0.0.1            --> 0/0
                                               10.0.0.16           --> 0/0
                                               128.0.0.1           --> 0/0
                                               128.0.0.4           --> 0/0
                                               128.0.1.16          --> 0/0
   lo0.32768               up    up
   lsi                     up    up
   lsi.0                   up    up   inet
                                      iso
                                      inet6
   lsi.1                   up    up   inet
                                      iso
                                      inet6
   lsi.2                   up    up   inet
                                      iso
                                      inet6
   lsi.3                   up    up   inet
                                      iso
                                      inet6
   lsi.4                   up    up   inet
                                      iso
                                      inet6
   lsi.5                   up    up   inet
                                      iso
                                      inet6
   lsi.6                   up    up   inet
                                      iso
                                      inet6
   lsi.7                   up    up   inet
                                      iso
                                      inet6
   lsi.8                   up    up   inet
                                      iso
                                      inet6
   lsi.9                   up    up   inet
                                      iso
                                      inet6
   lsi.10                  up    up   inet
                                      iso
                                      inet6
   lsi.11                  up    up   inet
                                      iso
                                      inet6
   lsi.12                  up    up   inet
                                      iso
                                      inet6
   lsi.13                  up    up   inet
                                      iso
                                      inet6
   lsi.14                  up    up   inet
                                      iso
                                      inet6
   mtun                    up    up
   pimd                    up    up
   pime                    up    up
   pp0                     up    up
   ppd0                    up    up
   ppe0                    up    up
   st0                     up    up
   st0.4000                up    up   inet     172.22.160.172/31  <- First OAM Tunnel
   st0.4001                up    up   inet     172.25.96.74/31    <- Second OAM Tunnel
   st0.4002                up    up   inet     172.16.40.64/31    <- First DATA Tunnel
   st0.4003                up    up   inet     172.18.202.88/31   <- Second DATA Tunnel
   tap                     up    up
   vlan                    up    down
   vtep                    up    up
   
   
   root@CV2116AF0288.sdwansite1.hubspoketenant> show services rpm probe-results
       Owner: c1c2c1e72a7ccc33334e9b68443d7c2d, Test: test-icmp-ping
       Target address: 172.19.193.55, Probe type: icmp-ping
       Routing Instance Name: transit
       Destination interface name: gr-0/0/0.4000
       Test size: 5 probes
       Probe results:
         Response received
         Wed Aug 22 15:24:35 2018
         Wed Aug 22 15:24:35 2018, No hardware timestamps
         Rtt: 1975 usec, Round trip jitter: 10 usec, Round trip interarrival jitter: 5416 usec
       Results over current test:
         Probes sent: 4, Probes received: 4, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 4, Minimum: 1736 usec, Maximum: 17799 usec, Average: 5869 usec, Peak to peak: 16063 usec, Stddev: 6889 usec, Sum: 23475 usec
         Measurement: Positive round trip jitter
           Samples: 2, Minimum: 10 usec, Maximum: 16063 usec, Average: 8037 usec, Peak to peak: 16053 usec, Stddev: 8026 usec, Sum: 16073 usec
         Measurement: Negative round trip jitter
           Samples: 2, Minimum: 207 usec, Maximum: 15834 usec, Average: 8021 usec, Peak to peak: 15627 usec, Stddev: 7814 usec, Sum: 16041 usec
       Results over last test:
         Probes sent: 5, Probes received: 5, Loss percentage: 0.000000
         Test completed on Wed Aug 22 15:24:00 2018
         Measurement: Round trip time
           Samples: 5, Minimum: 1879 usec, Maximum: 2213 usec, Average: 2045 usec, Peak to peak: 334 usec, Stddev: 121 usec, Sum: 10226 usec
         Measurement: Positive round trip jitter
           Samples: 2, Minimum: 56 usec, Maximum: 334 usec, Average: 195 usec, Peak to peak: 278 usec, Stddev: 139 usec, Sum: 390 usec
         Measurement: Negative round trip jitter
           Samples: 3, Minimum: 65 usec, Maximum: 270 usec, Average: 173 usec, Peak to peak: 205 usec, Stddev: 84 usec, Sum: 519 usec
       Results over all tests:
         Probes sent: 179, Probes received: 164, Loss percentage: 8.379889
         Measurement: Round trip time
           Samples: 164, Minimum: 1506 usec, Maximum: 50467 usec, Average: 3773 usec, Peak to peak: 48961 usec, Stddev: 7300 usec, Sum: 618757 usec
         Measurement: Positive round trip jitter
           Samples: 86, Minimum: 7 usec, Maximum: 48359 usec, Average: 3691 usec, Peak to peak: 48352 usec, Stddev: 9733 usec, Sum: 317411 usec
         Measurement: Negative round trip jitter
           Samples: 77, Minimum: 2 usec, Maximum: 48555 usec, Average: 4123 usec, Peak to peak: 48553 usec, Stddev: 10195 usec, Sum: 317461 usec
   
       Owner: ca5c6a23c7b5572ed269e46f6064eac7, Test: test-icmp-ping
       Target address: 172.16.31.235, Probe type: icmp-ping
       Routing Instance Name: transit
       Destination interface name: gr-0/0/0.4002
       Test size: 5 probes
       Probe results:
         Response received
         Wed Aug 22 15:24:35 2018
         Wed Aug 22 15:24:35 2018, No hardware timestamps
         Rtt: 1912 usec, Round trip jitter: -150 usec, Round trip interarrival jitter: 1651 usec
       Results over current test:
         Probes sent: 4, Probes received: 4, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 4, Minimum: 1746 usec, Maximum: 2062 usec, Average: 1931 usec, Peak to peak: 316 usec, Stddev: 120 usec, Sum: 7725 usec
         Measurement: Positive round trip jitter
           Samples: 2, Minimum: 57 usec, Maximum: 259 usec, Average: 158 usec, Peak to peak: 202 usec, Stddev: 101 usec, Sum: 316 usec
         Measurement: Negative round trip jitter
           Samples: 2, Minimum: 150 usec, Maximum: 154 usec, Average: 152 usec, Peak to peak: 4 usec, Stddev: 2 usec, Sum: 304 usec
       Results over last test:
         Probes sent: 5, Probes received: 5, Loss percentage: 0.000000
         Test completed on Wed Aug 22 15:24:00 2018
         Measurement: Round trip time
           Samples: 5, Minimum: 1752 usec, Maximum: 2017 usec, Average: 1867 usec, Peak to peak: 265 usec, Stddev: 89 usec, Sum: 9333 usec
         Measurement: Positive round trip jitter
           Samples: 2, Minimum: 72 usec, Maximum: 76 usec, Average: 74 usec, Peak to peak: 4 usec, Stddev: 2 usec, Sum: 148 usec
         Measurement: Negative round trip jitter
           Samples: 3, Minimum: 37 usec, Maximum: 181 usec, Average: 101 usec, Peak to peak: 144 usec, Stddev: 60 usec, Sum: 302 usec
       Results over all tests:
         Probes sent: 179, Probes received: 164, Loss percentage: 8.379889
         Measurement: Round trip time
           Samples: 164, Minimum: 1448 usec, Maximum: 47032 usec, Average: 2655 usec, Peak to peak: 45584 usec, Stddev: 4479 usec, Sum: 435433 usec
         Measurement: Positive round trip jitter
           Samples: 82, Minimum: 6 usec, Maximum: 45182 usec, Average: 1654 usec, Peak to peak: 45176 usec, Stddev: 6220 usec, Sum: 135658 usec
         Measurement: Negative round trip jitter
           Samples: 81, Minimum: 6 usec, Maximum: 45000 usec, Average: 1675 usec, Peak to peak: 44994 usec, Stddev: 6227 usec, Sum: 135666 usec 
   
   root@CV2116AF0288.sdwansite1.hubspoketenant> show route
   
   inet.0: 16 destinations, 16 routes (16 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 04:29:05
                         to 192.168.170.1 via ge-0/0/0.0
                       > to 192.168.173.1 via ge-0/0/1.0
   172.22.160.172/31  *[Direct/0] 00:33:28
                       > via st0.4000
   172.22.160.172/32  *[Local/0] 01:06:16
                         Local via st0.4000
   172.25.96.74/31    *[Direct/0] 01:05:34
                       > via st0.4001
   172.25.96.74/32    *[Local/0] 01:06:16
                         Local via st0.4001
   192.168.10.0/24    *[BGP/170] 01:05:38, localpref 200, from 192.168.210.1
                         AS path: 65000 I, validation-state: unverified
                       > via st0.4000                                         <- This is where and the device communicates to CSO
                         via st0.4001
   192.168.170.0/24   *[Direct/0] 04:29:05
                       > via ge-0/0/0.0
   192.168.170.2/32   *[Local/0] 04:29:19
                         Local via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 01:06:16
                       > via ge-0/0/1.0
   192.168.173.2/32   *[Local/0] 01:06:16
                         Local via ge-0/0/1.0
   192.168.190.0/24   *[Static/5] 00:31:32
                       > to 192.168.170.1 via ge-0/0/0.0
   192.168.190.254/32 *[Static/5] 01:06:21
                       > to 192.168.170.1 via ge-0/0/0.0
   192.168.191.0/24   *[Static/5] 00:31:32
                       > to 192.168.173.1 via ge-0/0/1.0
   192.168.191.254/32 *[Static/5] 01:06:21
                       > to 192.168.173.1 via ge-0/0/1.0
   192.168.210.1/32   *[Static/5] 01:05:44
                         via st0.4000
                       > via st0.4001
   192.168.210.3/32   *[Direct/0] 01:06:16
                       > via lo0.0
   
   inet.3: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   172.16.31.235/32   *[Static/5] 00:29:09
                       > via gr-0/0/0.4002
   172.19.193.55/32   *[Static/5] 00:29:09
                       > via gr-0/0/0.4000
   192.168.0.1/32     *[Static/5] 00:29:09, metric2 0
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   192.168.56.46/32   *[Static/5] 00:29:09
                       > via gr-0/0/0.4000
                         via gr-0/0/0.4002
   192.168.84.238/32  *[Static/5] 00:29:09
                       > via gr-0/0/0.4000
   192.168.142.248/32 *[Static/5] 00:29:09
                       > via gr-0/0/0.4002
   192.168.210.1/32   *[Static/12] 00:29:09
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   
   transit.inet.0: 13 destinations, 13 routes (13 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   172.16.31.234/31   *[Direct/0] 00:29:09
                       > via gr-0/0/0.4002
   172.16.31.234/32   *[Local/0] 00:31:21
                         Local via gr-0/0/0.4002
   172.16.40.64/31    *[Direct/0] 00:29:10
                       > via st0.4002
   172.16.40.64/32    *[Local/0] 00:31:21
                         Local via st0.4002
   172.18.202.88/31   *[Direct/0] 00:29:10
                       > via st0.4003
   172.18.202.88/32   *[Local/0] 00:31:21
                         Local via st0.4003
   172.19.193.54/31   *[Direct/0] 00:29:09
                       > via gr-0/0/0.4000
   172.19.193.54/32   *[Local/0] 00:31:21
                         Local via gr-0/0/0.4000
   172.22.160.172/31  *[Direct/0] 00:33:28
                       > via st0.4000
   172.25.96.74/31    *[Direct/0] 00:37:13
                       > via st0.4001
   192.168.170.0/24   *[Direct/0] 00:37:13
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:37:13
                       > via ge-0/0/1.0
   192.168.210.3/32   *[Direct/0] 00:37:13
                       > via lo0.0
   
   transit.inet.3: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   172.16.31.235/32   *[Static/5] 00:29:09
                       > via gr-0/0/0.4002
   172.19.193.55/32   *[Static/5] 00:29:09
                       > via gr-0/0/0.4000
   192.168.0.1/32     *[Static/5] 00:31:32, metric2 0
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   192.168.56.46/32   *[Static/5] 00:29:09
                       > via gr-0/0/0.4000
                         via gr-0/0/0.4002
   192.168.84.238/32  *[Static/5] 00:29:09
                       > via gr-0/0/0.4000
   192.168.142.248/32 *[Static/5] 00:29:09
                       > via gr-0/0/0.4002
   192.168.210.1/32   *[Static/12] 00:29:09
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   
   default-local-breakout.inet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.88.88.0/24      *[Direct/0] 00:31:21
                       > via ge-0/0/4.1088
   172.22.160.172/31  *[Direct/0] 00:33:28
                       > via st0.4000
   172.25.96.74/31    *[Direct/0] 00:37:13
                       > via st0.4001
   192.168.170.0/24   *[Direct/0] 00:37:13
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:37:13
                       > via ge-0/0/1.0
   192.168.210.3/32   *[Direct/0] 00:37:13
                       > via lo0.0
   
   mpls-local-breakout.inet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.88.88.0/24      *[Direct/0] 00:31:21
                       > via ge-0/0/4.1088
   172.22.160.172/31  *[Direct/0] 00:33:28
                       > via st0.4000
   172.25.96.74/31    *[Direct/0] 00:37:13
                       > via st0.4001
   192.168.170.0/24   *[Direct/0] 00:37:13
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:37:13
                       > via ge-0/0/1.0
   192.168.210.3/32   *[Direct/0] 00:37:13
                       > via lo0.0
   
   internet-local-breakout.inet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.88.88.0/24      *[Direct/0] 00:31:21
                       > via ge-0/0/4.1088
   172.22.160.172/31  *[Direct/0] 00:33:28
                       > via st0.4000
   172.25.96.74/31    *[Direct/0] 00:37:13
                       > via st0.4001
   192.168.170.0/24   *[Direct/0] 00:37:13
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:37:13
                       > via ge-0/0/1.0
   192.168.210.3/32   *[Direct/0] 00:37:13
                       > via lo0.0
   
   LAN-hubspoketenant_DefaultVPN.inet.0: 3 destinations, 3 routes (3 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:29:09, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4002, Push 16
   10.88.88.0/24      *[Direct/0] 00:31:21
                       > via ge-0/0/4.1088
   10.88.88.1/32      *[Local/0] 00:31:21
                         Local via ge-0/0/4.1088
   
   natVR-hubspoketenant_DefaultVPN.inet.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   Default-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:29:09, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4002, Push 16
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   Default-reverse-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:29:09, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 18
                         via gr-0/0/0.4002, Push 18
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   mpls-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:29:09, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 41
                       [Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   internet-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:29:09, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 39
                       [Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC1-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC2-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC3-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC4-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC5-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC6-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC7-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC8-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC9-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC10-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   mpls.0: 24 destinations, 24 routes (24 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   16                 *[VPN/0] 00:31:32
                         to table Default-hubspoketenant_DefaultVPN.inet.0, Pop
   17                 *[VPN/0] 00:31:32
                         to table Default-reverse-hubspoketenant_DefaultVPN.inet.0, Pop
   18                 *[VPN/0] 00:31:32
                         to table LAN-hubspoketenant_DefaultVPN.inet.0, Pop
   19                 *[VPN/0] 00:31:32
                         to table TC1-hubspoketenant_DefaultVPN.inet.0, Pop
   20                 *[VPN/0] 00:31:32
                         to table TC10-hubspoketenant_DefaultVPN.inet.0, Pop
   21                 *[VPN/0] 00:31:32
                         to table TC2-hubspoketenant_DefaultVPN.inet.0, Pop
   22                 *[VPN/0] 00:31:32
                         to table TC3-hubspoketenant_DefaultVPN.inet.0, Pop
   23                 *[VPN/0] 00:31:32
                         to table TC4-hubspoketenant_DefaultVPN.inet.0, Pop
   24                 *[VPN/0] 00:31:32
                         to table TC5-hubspoketenant_DefaultVPN.inet.0, Pop
   25                 *[VPN/0] 00:31:32
                         to table TC6-hubspoketenant_DefaultVPN.inet.0, Pop
   26                 *[VPN/0] 00:31:32
                         to table TC7-hubspoketenant_DefaultVPN.inet.0, Pop
   27                 *[VPN/0] 00:31:32
                         to table TC8-hubspoketenant_DefaultVPN.inet.0, Pop
   28                 *[VPN/0] 00:31:32
                         to table TC9-hubspoketenant_DefaultVPN.inet.0, Pop
   29                 *[VPN/0] 00:31:32
                         to table internet-hubspoketenant_DefaultVPN.inet.0, Pop
   30                 *[VPN/0] 00:31:32
                         to table mpls-hubspoketenant_DefaultVPN.inet.0, Pop
   299792             *[VPN/170] 00:36:21
                       > via st0.4001, Pop
   299808             *[VPN/170] 00:36:21
                         receive table transit.inet.0, Pop
   299840             *[VPN/170] 00:33:28
                       > via st0.4000, Pop
   299920             *[VPN/170] 00:29:10
                       > via st0.4003, Pop
   299936             *[VPN/170] 00:29:10
                       > via st0.4002, Pop
   299952             *[VPN/170] 00:29:09
                       > via gr-0/0/0.4002, Pop
   299952(S=0)        *[VPN/170] 00:29:09
                       > via gr-0/0/0.4002, Pop
   299968             *[VPN/170] 00:29:09
                       > via gr-0/0/0.4000, Pop
   299968(S=0)        *[VPN/170] 00:29:09
                       > via gr-0/0/0.4000, Pop
   
   transit.mpls.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0                  *[MPLS/0] 00:31:32, metric 1
                         Receive
   1                  *[MPLS/0] 00:31:32, metric 1
                         Receive
   2                  *[MPLS/0] 00:31:32, metric 1
                         Receive
   13                 *[MPLS/0] 00:31:32, metric 1
                         Receive
   
   bgp.l3vpn.0: 14 destinations, 14 routes (14 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   192.168.210.1:25:0.0.0.0/0
                      *[BGP/170] 00:30:01, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 18
                         via gr-0/0/0.4002, Push 18
   239.0.62.46:24:0.0.0.0/0
                      *[BGP/170] 00:30:01, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4002, Push 16
   239.0.62.46:26:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 19
                         via gr-0/0/0.4002, Push 19
   239.0.62.46:27:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 23
                         via gr-0/0/0.4002, Push 23
   239.0.62.46:28:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 25
                         via gr-0/0/0.4002, Push 25
   239.0.62.46:29:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 27
                         via gr-0/0/0.4002, Push 27
   239.0.62.46:30:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 29
                         via gr-0/0/0.4002, Push 29
   239.0.62.46:31:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 31
                         via gr-0/0/0.4002, Push 31
   239.0.62.46:32:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 33
                       > via gr-0/0/0.4002, Push 33
   239.0.62.46:33:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 35
                       > via gr-0/0/0.4002, Push 35
   239.0.62.46:34:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 37
                       > via gr-0/0/0.4002, Push 37
   239.0.62.46:35:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 21
                       > via gr-0/0/0.4002, Push 21
   239.0.62.46:36:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 41
   239.0.62.46:37:0.0.0.0/0
                      *[BGP/170] 00:30:00, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 39 

To have the LAN segment been able to send traffic to anything else we now have to apply a Firewall Rule to pass traffic.

If you don’t have already a rule set then it time to create your first rule now.

|image239|

|image240|

Deploy your saved Firewall ruleset

|image241|

|image242|

|image243|

.. warning:: ALSO check “show services rpm probe-results” on the Spoke. If any Tunnel has a 100% Packet loss REBOOT THE DEVICE. Especially the SRX300 is known to may run into this issue. A PR is open but STILL not fixed yet.

AFTER Firewall deploy first as a condition; you should be able to use VNC to desktop2-VM to emulate a client. Review Chapter 2.8 above for instructions how to use VNC. Example below

.. code-block:: none

   virsh vncdisplay desktop2
   :92

|image244|

If you open two Terminals on the Client Desktop you should be able to ping 8.8.8.8 and 8.8.4.4 with the second window. Access to other internet hosts will also to prove the forwarding is ok.

|image245|

Now check the sessions for the two destinations on the Spoke and will see that for this traffic they either use interface gr-0/0/0.4000 with is WAN_0 OR gr-0/0/0.4002 which is WAN_1.

This certifies the ECMP based load-balancer is working correctly. As you did not yet configure an SLA for App-Based-Routeing this should be the default behaviour as in the configuration above there is NO preferences for non-SLA traffic.

.. code-block:: none

   show security flow session destination-prefix 8.8.8.8
   Session ID: 5953, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.88.88.88/804 --> 8.8.8.8/22219;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/22219 --> 10.88.88.88/804;icmp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 1, Bytes: 84,
   
   Session ID: 5955, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.88.88.88/805 --> 8.8.8.8/22219;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/22219 --> 10.88.88.88/805;icmp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 1, Bytes: 84,
   
   Session ID: 5957, Policy name: Intent_1/7, Timeout: 4, Valid
     In: 10.88.88.88/806 --> 8.8.8.8/22219;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/22219 --> 10.88.88.88/806;icmp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 1, Bytes: 84,
   Total sessions: 3
   
   show security flow session destination-prefix 8.8.4.4
   Session ID: 5974, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.88.88.88/792 --> 8.8.4.4/22233;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.4.4/22233 --> 10.88.88.88/792;icmp, Conn Tag: 0x0, If: gr-0/0/0.4002, Pkts: 1, Bytes: 84,
   
   Session ID: 5976, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.88.88.88/793 --> 8.8.4.4/22233;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.4.4/22233 --> 10.88.88.88/793;icmp, Conn Tag: 0x0, If: gr-0/0/0.4002, Pkts: 1, Bytes: 84,
   
   Session ID: 5978, Policy name: Intent_1/7, Timeout: 4, Valid
     In: 10.88.88.88/794 --> 8.8.4.4/22233;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.4.4/22233 --> 10.88.88.88/794;icmp, Conn Tag: 0x0, If: gr-0/0/0.4002, Pkts: 1, Bytes: 84,
   
   Session ID: 5980, Policy name: Intent_1/7, Timeout: 4, Valid
     In: 10.88.88.88/795 --> 8.8.4.4/22233;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.4.4/22233 --> 10.88.88.88/795;icmp, Conn Tag: 0x0, If: gr-0/0/0.4002, Pkts: 1, Bytes: 84,
   Total sessions: 4

As we have checked the Lab connectivity and provision of the Device by this you can now focus on the common SD-WAN test cases of this lab starting in Chapter 6.6 below

NFX250 as Spoke for SD-WAN BASIC
--------------------------------

First change back to the Global View to change the Device Template as cspadmin

|image246|

**BEFORE you start any demo** with an NFX250 (and DHCP on WAN_0) make sure that it is really ready and not still booting/coming up. Even when you see the command-prompt and can login into the device it does NOT mean all Ports are ready and have their configuration. The Junos VM (**JCP**) that configures the switch ports **TAKES LONGER** to come up.

Its save when you see messages like the below with indicated parts of the phone-home process are already working (here the message means the device is no configured in CSO yet).

You can alternatively check the jsxe.0 interface in JDM and that the local routing table has a default gateway towards WAN_0 interface

.. code-block:: none

   ifconfig
   bme1      Link encap:Ethernet  HWaddr 52:54:00:38:76:22
             inet addr:192.0.2.254  Bcast:192.0.2.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fe38:7622/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:24853 errors:0 dropped:0 overruns:0 frame:0
             TX packets:9076 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:2671030 (2.6 MB)  TX bytes:604797 (604.7 KB)
   
   bme2      Link encap:Ethernet  HWaddr 52:54:00:dc:1f:67
             inet addr:128.0.0.254  Bcast:128.0.255.255  Mask:255.255.0.0
             inet6 addr: fe80::5054:ff:fedc:1f67/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:18 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:1314 (1.3 KB)  TX bytes:648 (648.0 B)
   
   jmgmt0    Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cb
             inet addr:192.168.10.24  Bcast:192.168.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:435376 errors:0 dropped:0 overruns:0 frame:0
             TX packets:2278 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:143436555 (143.4 MB)  TX bytes:277637 (277.6 KB)
   
   jsxe0     Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:19 errors:0 dropped:0 overruns:0 frame:0
             TX packets:94 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:3022 (3.0 KB)  TX bytes:28332 (28.3 KB)
   
   jsxe0.0   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:192.168.130.103  Bcast:192.168.130.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:8 errors:0 dropped:0 overruns:0 frame:0
             TX packets:35 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:1988 (1.9 KB)  TX bytes:10698 (10.6 KB)
   
   jsxe0.1   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:29 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:8646 (8.6 KB)
   
   jsxe0.2   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:3 errors:0 dropped:0 overruns:0 frame:0
             TX packets:30 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:188 (188.0 B)  TX bytes:8988 (8.9 KB)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:728 errors:0 dropped:0 overruns:0 frame:0
             TX packets:728 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:57923 (57.9 KB)  TX bytes:57923 (57.9 KB)
   
   phc       Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cd
             inet addr:10.10.10.1  Bcast:10.10.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:45 errors:0 dropped:0 overruns:0 frame:0
             TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:11466 (11.4 KB)  TX bytes:0 (0.0 B)
   
   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.130.1   0.0.0.0         UG    0      0        0 jsxe0.0
   10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 phc
   128.0.0.0       0.0.0.0         255.255.0.0     U     0      0        0 bme2
   192.0.2.0       0.0.0.0         255.255.255.0   U     0      0        0 bme1
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 jmgmt0
   192.168.130.0   0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.0

Now,after this is checked, change back to the Global View to change the Device Template as cspadmin

|image247|

First patch the template on the three items below that will assure a smooth ZTP for this lab.

|image248|

|image249|

You need change THREE Values:

-  Activation Code Enabled needs to be “disabled” (grey) so we don’t need to login to the Device webserver to enter an activation-code.
-  OOB_Management needs to be “disabled” (grey)
-  Use Single SSH to NFX needs to be “enabled” (blue)

.. warning:: Starting with CSO 4.1.0 the device root passwords are no longer “Embe1mpls” after you have installed CSO. We are changing it back here, as it’s easier in a lab to debug items with known passswords, but this is **NOT RECOMMENDED FOR PRODUCTION**.

|image250|

Now change directly to the View of the Tenant itself

|image251|

|image252|

|image253|

|image254|

|image255|

|image256|

|image257|

Do NOT enable any sophisticated features such as local-breakout for the lab yet. Just default links to every to interfaces and you are set.

|image258|

|image259|

|image260|

|image261|

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "hubspoketenant",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "sdwansite2",
                   "site_basic_properties": {
                       "local_breakout": {},
                       "gatewaySite": false,
                       "site_type": "on_premise",
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": false,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "provider": "abc",
                                       "wan_link": "WAN_0",
                                       "access_type": "Ethernet",
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "5043de3e-b1a3-8d4f-3eba-01c85cc4d520",
                                       "cost": 2222,
                                       "subscribed_bandwidth": 1000,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "provider": "xyz",
                                       "wan_link": "WAN_1",
                                       "access_type": "Ethernet",
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "6f677613-6c68-b4a0-7f3a-7351f4b0831f",
                                       "cost": 111,
                                       "subscribed_bandwidth": 1000,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "NFX_Advanced_SDWAN_CPE_option_1",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "10.66.66.1/24",
                                       "lan_segment_name": "desktop4",
                                       "vlan": 1066,
                                       "lan_ports": [
                                           "LAN_0"
                                       ],
                                       "department": "Default",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwansite2"
                           }
                       ],
                       "0": {
                           "ip_prefix": "10.66.66.1/24",
                           "lan_segment_name": "desktop4",
                           "vlan": 1066,
                           "lan_ports": [
                               "LAN_0"
                           ],
                           "department": "Default",
                           "dhcp": false
                       },
                       "site_role": "SPOKE",
                       "sla_mgmt": "COARSE",
                       "device_profile_name": "NFX250 as SD-WAN CPE",
                       "site_name": "sdwansite2",
                       "site_group": null,
                       "dvpn_params": {
                           "delete_dvpn_threshold": "1",
                           "create_dvpn_threshold": "5"
                       },
                       "topology": "Bandwidth Optimized"
                   }
               }
           ]
       }
   } 
   

|image262|

|image263|

|image264|

|image265|

|image266|

|image267|

|image268|

Wait until the device is created!

|image269|

.. note:: You NEED to perform a Device activation!!!

|image270|

.. warning:: Wait until you see that Stage-1 ZTP was successful and the Device_Detected Stage appears. THEN you activate the Device.

|image271|

|image272|

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "hubspoketenant",
           "job_name_prefix": "hubspoketenant-sdwansite2",
           "site": [
               {
                   "on_premise_site_info": {
                       "device": [
                           {
                               "is_gateway_site": false,
                               "wan_link": [
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/10",
                                       "local_breakout_enabled": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.130.1",
                                           "ip_address": "192.168.130.2/24"
                                       },
                                       "used_for_oam": true,
                                       "traffic_type": "OAM_AND_DATA",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/11",
                                       "local_breakout_enabled": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.133.1",
                                           "ip_address": "192.168.133.2/24"
                                       },
                                       "used_for_oam": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   }
                               ],
                               "device_name": "sdwansite2",
                               "device_template": "NFX_Advanced_SDWAN_CPE_option_1",
                               "device_details": {
                                   "serial_number": "DD2116AF0059"
                               },
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.4/32"
                               }
                           }
                       ],
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "region": "regional",
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       }
                   },
                   "site_name": "sdwansite2",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }
   

#

# WAIT ~20MINUTES!!!! That's how long this process takes to load the vSRX onto the NFX with all the commits to check and bring up IPsec etc.

#

|image273|

.. hidden-code-block:: none

   
   Job logs:
   Feb 12, 2019, 12:07:59 PMcsp.tssm_ztp.ffabf035-e72f-4951-a20f-86bf36913667
   Feb 12, 2019, 12:21:21 PMUpdated token to customer project scope SUCCESS
   Feb 12, 2019, 12:21:43 PMReceived notification from Routing Manager {"status": "SUCCESS", "X-Request-Id": "api_server_db_2b1bea43-fce1-4eb5-b38c-90641a60153f,AXdP,Ejc5", "rpc_type": "ACTIVATE_SITE_ROUTING", "request_id": "51538379-adca-4748-b32e-f31efa1f2ec2"}
   Feb 12, 2019, 12:21:43 PMSuccess in executing Routing Manager workflow
   Feb 12, 2019, 12:22:18 PMReceived notification from VPN Manager {"status": "SUCCESS", "output": {"sub_status": [{"status": "SUCCESS", "ott_link_id": "f71f1e05-8368-4f00-a9c5-97f8a76ba24d", "message": ""}, {"status": "SUCCESS", "ott_link_id": "5b007880-9b58-49a9-83ea-b74d2a20f418", "message": ""}]}, "request_id": "028088b6-9682-40af-8003-3f14ddf6fd3e"}
   Feb 12, 2019, 12:22:18 PMSuccess in executing VPN Manager workflow
   Feb 12, 2019, 12:22:34 PMReceived notification from Routing Manager {"status": "SUCCESS", "X-Request-Id": "api_server_db_2b1bea43-fce1-4eb5-b38c-90641a60153f,AXdP,yWgC", "rpc_type": "ACTIVATE_VPN_ROUTING", "request_id": "3789117f-085a-4487-b5ed-7664f8a3831d"}
   Feb 12, 2019, 12:22:34 PMSuccess in executing Routing Manager workflow
   Feb 12, 2019, 12:22:39 PMReceived notification from Routing Manager {"status": "SUCCESS", "X-Request-Id": "api_server_db_2b1bea43-fce1-4eb5-b38c-90641a60153f,AXdP,KV3q", "rpc_type": "ADD_DEPARTMENT_TO_VPN", "request_id": "36efa9ed-76a2-4c55-947d-2b2702a951a1"}
   Feb 12, 2019, 12:22:39 PMSuccess in executing Routing Manager workflow
   Task: ztp-init
   Feb 12, 2019, 12:07:59 PMTask started
   Feb 12, 2019, 12:07:59 PMztp-init completed successfully.
   Feb 12, 2019, 12:07:59 PMTask complete
   Task: gateway-bring-up
   Feb 12, 2019, 12:08:00 PMCreate VM Task Start, task_id = gateway-bring-up ...
   Feb 12, 2019, 12:08:00 PMNFX device ffabf035-e72f-4951-a20f-86bf36913667 maps to topo device ffabf035-e72f-4951-a20f-86bf36913667
   Feb 12, 2019, 12:08:00 PMUpdated token to customer project scope SUCCESS
   Feb 12, 2019, 12:08:00 PMInitiate all service libs SUCCESS
   Feb 12, 2019, 12:08:00 PMUpdate topo device ffabf035-e72f-4951-a20f-86bf36913667 management state to managed SUCCESS
   Feb 12, 2019, 12:08:00 PMTopo device ffabf035-e72f-4951-a20f-86bf36913667 map to nso vim-instance af808a4f-10fd-4634-947f-1a072db58bf5
   Feb 12, 2019, 12:08:00 PMTopo device ffabf035-e72f-4951-a20f-86bf36913667 map to topology vim 0c7d6210-fcb7-489b-8713-cc7a04050a7f
   Feb 12, 2019, 12:08:00 PMTopo device ffabf035-e72f-4951-a20f-86bf36913667 maps to topo site d8d7fd62-5e41-4c33-80c9-ce66ff93ff5a
   Feb 12, 2019, 12:08:01 PMTopology site d8d7fd62-5e41-4c33-80c9-ce66ff93ff5a map to topology pop 4250c0eb-0cf0-48f6-96fb-bf0dfa903721
   Feb 12, 2019, 12:08:01 PMTopology pop 4250c0eb-0cf0-48f6-96fb-bf0dfa903721 map to topology region d061a1fb-584b-4112-8614-a8daac0156f1
   Feb 12, 2019, 12:08:01 PMTopo region name is regional
   Feb 12, 2019, 12:08:01 PMTopo site d8d7fd62-5e41-4c33-80c9-ce66ff93ff5a maps to tssm site fd651718-bb9b-40b3-9ccb-f5f15829d1a2
   Feb 12, 2019, 12:08:01 PMDevice template id e4b7a848-68ca-359e-9538-ca60bf980856
   Feb 12, 2019, 12:08:01 PMNo resource pool for this nso vim yet, about to create
   Feb 12, 2019, 12:08:04 PMCalling nso create resource pool SUCCESS
   Feb 12, 2019, 12:08:04 PMResource pool id = 914a191f-7728-4254-802d-a2ff4ec256fa
   Feb 12, 2019, 12:08:05 PMUpdate resource pool info for porter vim SUCCESS
   Feb 12, 2019, 12:08:05 PMCreate VM Stage 1: create resource pool SUCCESS, resource_pool_id = 914a191f-7728-4254-802d-a2ff4ec256fa
   Feb 12, 2019, 12:08:06 PMCreate VM Stage 2: resolve device profile SUCCESS, profile_id = e4b7a848-68ca-359e-9538-ca60bf980856, results = {'config_templates': {u'gwr-boot-config': {u'input_param': u'{\n \n\n\n \n\n \n \n \n \n \n\n\n\n \n \n \n\n \n \n \n\n "_dp_globals": {"GWR_WAN_PORT_NAMES": {"WAN_2": "ge-0/0/7", "WAN_3": "ge-0/0/8", "WAN_0": "ge-0/0/2", "WAN_1": "ge-0/0/3"}, "TUNNEL_DETAILS": [{"link_name": "WAN_1", "tunnels": [{"interface": "st0.1", "index": 0, "type": "IPSEC", "name": "WAN_1_IPSEC_0"}]}], "S_TRCRT_BANDWIDTH_LIMIT": 1000000, "S_LOG_ROTATION_MAX_FILES": 10, "S2_MODEL_HUGEPAGE_COUNT": 13, "S_MAINTENANCE_USER": "juniper", "DSL_VLAN": 4087, "S_LOGIN_BACKOFF_FACTOR": 5, "WAN_DETAILS": [{"name": "WAN_0", "gwr_port": "ge-0/0/2", "vlan": 4050, "vim_port_name": "wan0", "vl_name": "vl-wan-0", "gwr_port_index": 3}, {"name": "WAN_1", "gwr_port": "ge-0/0/3", "vlan": 4051, "vim_port_name": "wan1", "vl_name": "vl-wan-1", "gwr_port_index": 4}, {"name": "WAN_2", "gwr_port": "ge-0/0/7", "vlan": 4052, "vim_port_name": "wan2", "vl_name": "vl-wan-2", "gwr_port_index": 8}, {"name": "WAN_3", "gwr_port": "ge-0/0/8", "vlan": 4053, "vim_port_name": "wan3", "vl_name": "vl-wan-3", "gwr_port_index": 9}], "S_IKE_DHGROUP": "group14", "ADSL_VPI": 8, "GWR_CPU_PIN": {"nfx250_s2_10_t": "3,4,5", "nfx250_s1e": "3,4,5", "nfx250_10_t": "3,4,5", "nfx250_ls1_10_t": "1,2,3", "nfx250_att_s1_10_t": "3,4,5", "nfx250_att_ls1_10_t": "1,2,3", "nfx250_att_s2_10_t": "3,4,5"}, "ADSL_ENCAP": "llcsnap-bridged-802.1q", "VNF_OAM_TRANSLATED_PORT_START": 49152, "LTE_VLAN_DETAILS": {"ctrl_vlan": 4093, "data_vlan": 20}, "WAN_PORT_NAMES": {"WAN_2": "xe-0/0/12", "WAN_3": "xe-0/0/13", "WAN_0": "ge-0/0/10", "WAN_1": "ge-0/0/11"}, "ADSL_VCI": 36, "AUTO_INSTALL_LICENSE_TO_DEVICE": false, "LAN_DETAILS": [{"subnet": "10.10.1.0/24", "vl_name": "vl-lan-0", "name": "LAN_0", "vlan": 4032}, {"subnet": "10.10.2.0/24", "vl_name": "vl-lan-1", "name": "LAN_1", "vlan": 4033}], "AUTO_INSTALL_DEFAULT_TRUSTED_CERTS_TO_DEVICE": true, "ZSCALER_ENCRYPTION_ALGORITHM": ["aes-256-cbc"], "S_LOG_ROTATION_MAX_FILE_SIZE": 10, "OAM_DETAILS": {"subnet": "10.10.10.0/24", "gwr_port": "ge-0/0/1", "vlan": 4010, "vim_port_name": "mgmt", "vl_name": "vl-mgmt", "gwr_port_index": 2}, "RESERVED_VLAN_FOR_EM1": 4088, "S_MAX_SSH_CONNECTIONS": 50, "S_IDLE_TIMEOUT": 10, "MAX_DVPN_TUNNELS_ON_SITE": {"default-value": 300, "nfx250_s1e": 750, "nfx250_10_t": 750, "nfx250_ls1_10_t": 750, "nfx250_att_s1_10_t": 300, "nfx250_s2_10_t": 750, "nfx250_att_ls1_10_t": 300, "nfx250_att_s2_10_t": 300}, "S_ROOT_LOGIN_DENY": false, "GWR_LAN_PORT": "ge-0/0/4", "S_MAX_SESSIONS_PER_CONN": 50, "VNF_OAM_REACHABILITY": {"GWR_EXTERNAL_OAM_ROUTING_INSTANCE": "default", "GWR_EXTERNAL_OAM_INTERFACE": "lo0.0", "GWR_ETH0BR_IP": "10.10.20.254/24", "GWR_EXTERNAL_OAM_ZONE": "oam"}, "S_LOGIN_ATTEMPTS": 3, "LAN_SEG_UI_VALIDATION_PARAMS": {"vlan_id_mandatory": false, "ip_prefix_mandatory": false, "dhcp_mandatory": false, "department_mandatory": true, "min_max_ports": "1-10"}, "CSP_AGENT_USER": "cspagent", "S_MAX_SSH_CONNECTION_RATE": 50, "ENC_ROOT_PASSWORD": "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0", "GWR_VSRX_IMAGE_LOCAL_FILE_PATH": "", "RECONFIGURE_FXP0": true, "TERMINATION_POINT_NAMES": ["JCP.%s.%s", "GWR.%s.%s"], "S1_MODEL_HUGEPAGE_COUNT": 9, "USE_SINGLE_SSH_TO_NFX": true, "CSP_MGMT_USER": "csp", "GWR_VSRX_IMAGE_CNAME_IN_CSO": "vsrx-vmdisk-15.1.qcow2", "S_ICMP_BURST_SIZE_LIMIT": 2000, "ACTIVATION_CODE_ENABLED": false, "S_LOGIN_LOCKOUT": 5, "S_DNS_BANDWIDTH_LIMIT": 1000000, "S_ENABLE_TACACS": false, "WAN_LINK_INFO": {"WAN_0": {"required": true, "wan_link_type": "MPLS", "fieldsHidden": true}, "WAN_1": {"required": false, "wan_link_type": "Internet", "fieldsHidden": true}}, "S_ICMP_BANDWIDTH_LIMIT": 1000000, "S_LOGIN_ANNOUNCE": "This system is private property.", "AUX_DETAILS": [{"subnet": "10.10.0.0/24", "name": "AUX_0", "gwr_port": "ge-0/0/4", "vlan": 4001, "vim_port_name": "aux0", "vl_name": "vl-aux-0", "gwr_port_index": 5}, {"subnet": "10.10.12.0/24", "name": "AUX_1", "gwr_port": "ge-0/0/5", "vlan": 4002, "vim_port_name": "aux1", "vl_name": "vl-aux-1", "gwr_port_index": 6}, {"subnet": "10.10.13.0/24", "name": "AUX_2", "gwr_port": "ge-0/0/6", "vlan": 4003, "vim_port_name": "aux2", "vl_name": "vl-aux-2", "gwr_port_index": 7}], "OBFUSCATE_PRE_SHARED_KEY": false, "INTERNAL_OAM_SUBNET": "10.10.10.0/24", "SECURE_OAM_SUPPORTED": true, "AUX_SUBNETS": {"AUX_2": "10.10.13.0/24", "AUX_0": "10.10.0.0/24", "AUX_1": "10.10.12.0/24"}, "S_RESTRICT_SSH": false, "PCC_LAN_PHY_PORT": "hsxe1", "S_TRCRT_BURST_SIZE_LIMIT": 15000, "S_LOGIN_MAX_TIME_FOR_PASSWORD": 20, "OOB_MGMT_ENABLED": false, "S_DHCP_BANDWIDTH_LIMIT": 1000000, "S_LOGIN_BACKOFF_THRESHOLD": 2, "LAN_PORT_NAMES": {"LAN_1": "ge-0/0/1", "LAN_0": "ge-0/0/0", "LAN_3": "ge-0/0/3", "LAN_2": "ge-0/0/2", "LAN_5": "ge-0/0/5", "LAN_4": "ge-0/0/4", "LAN_7": "ge-0/0/7", "LAN_6": "ge-0/0/6", "LAN_9": "ge-0/0/9", "LAN_8": "ge-0/0/8"}, "LAN_SUBNETS": {"LAN_1": "10.10.2.0/24", "LAN_0": "10.10.1.0/24"}, "WAN_ACCESS_TECHNOLOGIES": ["Ethernet", "LTE", "ADSL", "VDSL"], "AUTO_DEPLOY_STAGE2_CONFIG": false, "S_LOGIN_MESSAGE": "Unauthorized access will be reported.", "MIN_DVPN_TUNNELS_TO_START_DEACTIVATE": {"default-value": 100, "nfx250_s1e": 250, "nfx250_10_t": 250, "nfx250_ls1_10_t": 250, "nfx250_att_s1_10_t": 100, "nfx250_s2_10_t": 250, "nfx250_att_ls1_10_t": 100, "nfx250_att_s2_10_t": 100}, "S_ENABLE_SNMP": false, "S_DHCP_BURST_SIZE_LIMIT": 15000, "S_DNS_BURST_SIZE_LIMIT": 15000},\n "crl_port": "8060",\n "wan_link_info": [{"ip_prefix": "192.168.130.2/24", "enable_pppoe": false, "wan_link_type": "MPLS", "neighbor_ip": "None", "access_type": "Ethernet", "gateway_ip": "192.168.130.1", "port_name": "ge-0/0/2", "used_for_oam": true, "peer_as": "None", "traffic_type": "OAM_AND_DATA", "wan_link_name": "GWR.WAN_0.DATA", "is_lte": false}, {"ip_prefix": "192.168.133.2/24", "enable_pppoe": false, "wan_link_type": "Internet", "neighbor_ip": "None", "access_type": "Ethernet", "gateway_ip": "192.168.133.1", "port_name": "ge-0/0/3", "used_for_oam": true, "peer_as": "None", "traffic_type": "DATA_ONLY", "wan_link_name": "GWR.WAN_1.DATA", "is_lte": false}],\n "cpe_as": "None",\n "sdwan_as_num": "64512",\n "hostname": "GWR.sdwanspoke2.hubspoketenant",\n "management_userid": "csp",\n "agent_userid": "cspagent",\n "ssh_public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCnNwyRD0uoHfyF2GmTouu0luOv5ZEEjeTn0trNAoaXPlBxta1wtHPXZNYfJ6My2n7SuoBEOsMX4/THT01mpde7NVU6TL07FCWE2/0ThSs9Ok1KdMu4eIOoSWEVx0CNhVbN/Z7HToKIERy1fYLyb4hmSHX885jQRPBl1ZSzO6kP/z0+70uDnEKCLTf7hbWVYsh6559CSD7Ms4xmxeT0N/Mu5uT6l58CSjQwaT0HD6UQDYXU0cFK1yoduv1kgzu/bIB8Ikx3SbdfpLh4x1dCYgsSe96y6UOYImrV6yqK+MuhWQx6qqkg3CAaQgKzjAVsgPO9ka9jxg380yAztbS4dwTp",\n "jdm_public_key": "AAAAB3NzaC1yc2EAAAADAQABAAABAQCn478Z/E7faegBut17IihlUe+zHLc9WkKX0nMq6I6xUSUQaot/XB+Q8cKcM9gpeiHLLT7nnMGe0/PeiWSIjHvmk9WtFTEgKY/Mb1GH7coozHETjy6KJK6NM/twllWTTct3rZOeqhaJY5MS8See6zDlPjY8IU+cRLTcjgETcDE4WjpcMlg6vccCtiIboXee9K+NREsVU86OstNmY/YcDMJfA7w0Kge620LtWT/LjfCrTt9k444SiPkp+bJV8GrYZU9ki1pGAo0UFtTTDermuQ5EdAez8skQMCvRgbBNhuSgNroV7s57IgfJI0KC6BsY0Z3ZrPM7pDzG+kYjvXZbCIXL",\n "encrypted_root_password": "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0",\n\n "gateway": false,\n\n "cos": {\n\n\n\n \n \n "ge-0/0/2" : "1000"\n \n \n \n \n\n\n\n \n \n \n \n , "ge-0/0/3" : "1000"\n \n \n\n\n },\n\n\n \n \n "site_advanced_config": {"timezone": "Europe/Amsterdam", "nameserver": ["8.8.8.8"]},\n\n \n "name_server": "8.8.8.8",\n\n \n \n "time_zone": "Europe/Amsterdam",\n\n\n\n "cso_dic_vip": "192.168.10.42",\n\n "cso_dic_port": "7804",\n "cso_security_log_host": "192.168.10.47",\n "cso_security_log_port": "514",\n "cso_app_log_port": "3514",\n\n\n\n "oam_traffic_defined": "no",\n\n\n\n "mode": "no_oam",\n\n\n \n\n\n\n\n "preferred_wan_link": "WAN_0",\n \n\n\n\n\n\n\n\n \n\n\n\n\n\n "wan_0_port": "ge-0/0/2",\n "wan_0_pppoe": false,\n "wan_0_oam" : true,\n\n "wan_0_ip_prefix" : "192.168.130.2/24",\n\n "wan_0_link_type": "MPLS",\n\n\n\n\n\n "preferred_wan_link_gateway" : "192.168.130.1",\n\n\n\n\n\n\n\n\n "wan_1_port": "ge-0/0/3",\n "wan_1_pppoe": false,\n "wan_1_oam" : true,\n\n "wan_1_ip_prefix" : "192.168.133.2/24",\n\n "wan_1_link_type": "Internet",\n\n\n\n\n\n\n\n\n\n "csp_prefix": "192.168.10.0/24",\n "cpe_mgmt_ip": "192.168.210.4/32",\n "hub_device_family": "juniper-srx",\n "oam_gateway": "None",\n "oam_port": "ge-0/0/1",\n "oam_gwr_ip": "10.10.10.3/24",\n "aux_0_port": "ge-0/0/4",\n "aux_1_port": "ge-0/0/5",\n "aux_2_port": "ge-0/0/6",\n "aux_0_vlanid": "4001",\n "aux_2_vlanid": "4003",\n "aux_0_ip": "10.10.0.2/24",\n "aux_1_ip": "10.10.12.2/24",\n "aux_2_ip": "10.10.13.2/24",\n\n \n\n\n "crl_url": "http://192.168.10.42:8060/activation-service/crl/Tenant_0df2e57b-4ea3-4e21-b27c-a062975eeb6a.crl",\n\n\n\n \n "ipsec_config_blob_list": [{"tenant_name": "hubspoketenant", "ike_identity_name": "OAM-SDWANSPOKE2_WAN_0_HUB1_WAN_0_IPSEC_0", "group_name": "hubspoketenant_OAM-SDWANSPOKE2_WAN_0_HUB1_WAN_0_IPSEC_0", "encryption_algorithm": "aes-256-gcm", "prim_hub": "True", "backup_link": "False", "flavor": "dynamic", "remote_tunnel_ip_prefix": "10.176.0.64/31", "hub_device_family": "juniper-srx", "ott_name": "6e71f901efb0d901a0b4a253c96af4e8", "remote_gw_ip_prefix": "192.168.190.254/24", "remote_gw_next_hop": "192.168.130.1", "dh_group": "group14", "encryption_algorithms": ["aes-256-cbc"], "pre_shared_key": "OAM_SDWANSPOKE2_WAN_0_HUB1_WAN_0_IPSEC_0", "link_name": "OAM-SDWANSPOKE2_WAN_0_HUB1_WAN_0_IPSEC_0", "role": "spoke", "authentication_method": "pre-shared-keys", "remote_mgmt_ip": "192.168.210.1/32", "cpe_mgmt_ip": "192.168.210.4/32", "underlay_interface": "ge-0/0/2.0", "traffic_list": [{"ip_addr": "192.168.10.49"}], "oam_tunnel": true, "cert_name": "", "tunnel_interface": "st0.4000", "local_tunnel_ip_prefix": "10.176.0.65/31", "local_identity_ipprefix": "192.168.130.2/24", "peer_ike_identity_name": "OAM-SDWANSPOKE2_WAN_0_HUB1_WAN_0_IPSEC_0", "csp_prefix": "192.168.10.0/24", "topo_role": "spoke", "hub_loopback_ip": "192.168.210.1", "policy_mode": "aggressive", "underlay_name": "WAN_0", "remote_identity_ipprefix": "192.168.190.254/24", "underlay_wan_link_type": "MPLS"}, {"tenant_name": "hubspoketenant", "ike_identity_name": "OAM-SDWANSPOKE2_WAN_1_HUB1_WAN_1_IPSEC_0", "group_name": "hubspoketenant_OAM-SDWANSPOKE2_WAN_1_HUB1_WAN_1_IPSEC_0", "encryption_algorithm": "aes-256-gcm", "prim_hub": "True", "backup_link": "False", "flavor": "dynamic", "remote_tunnel_ip_prefix": "10.176.0.66/31", "hub_device_family": "juniper-srx", "ott_name": "77037ea27b322b2642d831afc085471d", "remote_gw_ip_prefix": "192.168.191.254/24", "remote_gw_next_hop": "192.168.133.1", "dh_group": "group14", "encryption_algorithms": ["aes-256-cbc"], "pre_shared_key": "OAM_SDWANSPOKE2_WAN_1_HUB1_WAN_1_IPSEC_0", "link_name": "OAM-SDWANSPOKE2_WAN_1_HUB1_WAN_1_IPSEC_0", "role": "spoke", "authentication_method": "pre-shared-keys", "remote_mgmt_ip": "192.168.210.1/32", "cpe_mgmt_ip": "192.168.210.4/32", "underlay_interface": "ge-0/0/3.0", "traffic_list": [{"ip_addr": "192.168.10.49"}], "oam_tunnel": true, "cert_name": "", "tunnel_interface": "st0.4001", "local_tunnel_ip_prefix": "10.176.0.67/31", "local_identity_ipprefix": "192.168.133.2/24", "peer_ike_identity_name": "OAM-SDWANSPOKE2_WAN_1_HUB1_WAN_1_IPSEC_0", "csp_prefix": "192.168.10.0/24", "topo_role": "spoke", "hub_loopback_ip": "192.168.210.1", "policy_mode": "aggressive", "underlay_name": "WAN_1", "remote_identity_ipprefix": "192.168.191.254/24", "underlay_wan_link_type": "Internet"}]\n\n}\n', u'hide': False, u'name': u'gwr-boot-config', u'display_name': u'SDWAN Gateway Router Bootstrap Config', u'template_uuid': u'49a7238b-c7cb-346b-992f-ce489e026598', u'conditional_template_uuid': None, u'cluster_role': None, u'device_component_name': u'GWR', u'selective_tenant': [], u'initial_config': None, u'copy_input_param_from': None, u'enable_for': None}}, 'resources': {u'create_vm_api_input': {u'vm_name': u'GWR.sdwanspoke2.hubspoketenant', u'lte_wan': {}, u'vim_id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vim_resource_id': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'networks': [{u'port_specification': {u'port_ip': u'10.10.10.3/24', u'port_index': 2, u'port_type': u'MGMT'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4010}, u'name': u'mgmt'}, {u'port_specification': {u'port_ip': u'192.168.130.2/24', u'peer_interfaces': [u'ge-0/0/10'], u'port_index': 3, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4050}, u'name': u'wan0'}, {u'port_specification': {u'port_ip': u'192.168.133.2/24', u'peer_interfaces': [u'ge-0/0/11'], u'port_index': 4, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4051}, u'name': u'wan1'}, {u'port_specification': {u'port_index': 8, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4052}, u'name': u'wan2'}, {u'port_specification': {u'port_index': 9, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4053}, u'name': u'wan3'}, {u'port_specification': {u'port_ip': u'10.10.0.2/24', u'port_index': 5, u'access_mode': u'trunk', u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4001}, u'name': u'aux0'}, {u'port_specification': {u'port_ip': u'10.10.12.2/24', u'port_index': 6, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4002}, u'name': u'aux1'}, {u'port_specification': {u'port_ip': u'10.10.13.2/24', u'port_index': 7, u'port_type': u'DATA'}, u'vlink_info': {u'bridge_info': {u'bridge_name': u'ovs-sys-br'}, u'vlan_id': 4003}, u'name': u'aux2'}], u'resources': {u'vcpu': 3, u'physical_cpus_to_pin': [3, 4, 5], u'memory_mb': 6144, u'disk_gb': 10, u'image_file_uri': u'/var/third-party/images/media-vsrx-vmdisk-15.1X49-D170.qcow2,vsrx-vmdisk-15.1.qcow2'}}}}
   Feb 12, 2019, 12:08:07 PMCreate VM Stage 3: render boot config SUCCESS, config = groups { global { security { policies { default-policy { deny-all; } } } } } apply-groups global; chassis { fpc 0 { pic 0 { traffic-manager { queue-buffer-size small; } } } } system { host-name GWR.sdwanspoke2.hubspoketenant; default-address-selection; root-authentication { encrypted-password "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0"; } name-server { 8.8.8.8; } time-zone Europe/Amsterdam; login { class admin { idle-timeout 10; permissions all; } user csp { class admin; authentication { ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCnNwyRD0uoHfyF2GmTouu0luOv5ZEEjeTn0trNAoaXPlBxta1wtHPXZNYfJ6My2n7SuoBEOsMX4/THT01mpde7NVU6TL07FCWE2/0ThSs9Ok1KdMu4eIOoSWEVx0CNhVbN/Z7HToKIERy1fYLyb4hmSHX885jQRPBl1ZSzO6kP/z0+70uDnEKCLTf7hbWVYsh6559CSD7Ms4xmxeT0N/Mu5uT6l58CSjQwaT0HD6UQDYXU0cFK1yoduv1kgzu/bIB8Ikx3SbdfpLh4x1dCYgsSe96y6UOYImrV6yqK+MuhWQx6qqkg3CAaQgKzjAVsgPO9ka9jxg380yAztbS4dwTp"; ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCn478Z/E7faegBut17IihlUe+zHLc9WkKX0nMq6I6xUSUQaot/XB+Q8cKcM9gpeiHLLT7nnMGe0/PeiWSIjHvmk9WtFTEgKY/Mb1GH7coozHETjy6KJK6NM/twllWTTct3rZOeqhaJY5MS8See6zDlPjY8IU+cRLTcjgETcDE4WjpcMlg6vccCtiIboXee9K+NREsVU86OstNmY/YcDMJfA7w0Kge620LtWT/LjfCrTt9k444SiPkp+bJV8GrYZU9ki1pGAo0UFtTTDermuQ5EdAez8skQMCvRgbBNhuSgNroV7s57IgfJI0KC6BsY0Z3ZrPM7pDzG+kYjvXZbCIXL"; } } } services { ssh; netconf { ssh; rfc-compliant; } } syslog { user * { any emergency; } host 192.168.10.47 { authorization any; daemon warning; port 514; structured-data; } file messages { any any; authorization info; archive size 10m files 10; } file interactive-commands { interactive-commands any; archive size 10m files 10; } } license { autoupdate { url https://ae1.juniper.net/junos/key_retrieval; } } } security { advance-policy-based-routing { tunables { enable-logging; } } log { utc-timestamp; mode stream; source-address 192.168.210.4; format sd-syslog; transport { protocol tcp; } stream app-track-logs { format sd-syslog; category all; rate-limit 10000; host { 192.168.10.47; port 3514; } } stream all-logs { format sd-syslog; category all; rate-limit 10000; host { 192.168.10.47; port 514; } } } application-tracking; nat { source { rule-set underlay-mgmt-traffic-nat { from routing-instance default; to zone untrust; rule r4 { match { source-address 192.168.210.4/32; } then { source-nat { interface; } } } } } } flow { allow-dns-reply; allow-embedded-icmp; aging { early-ageout 65535; } tcp-mss { ipsec-vpn { mss 1200; } all-tcp { mss 1350; } } tcp-session { no-syn-check; no-syn-check-in-tunnel; no-sequence-check; } } screen { ids-option untrust-screen { icmp { ip-sweep; fragment; flood threshold 1000; ping-death; } ip { bad-option; source-route-option; unknown-protocol; tear-drop; } tcp { syn-fin; fin-no-ack; tcp-no-flag; syn-frag; port-scan threshold 1000; land; winnuke; tcp-sweep threshold 1000; syn-flood { alarm-threshold 1024; attack-threshold 200; source-threshold 1024; destination-threshold 2048; queue-size 2000; ## Warning: 'queue-size' is deprecated timeout 20; } } udp { udp-sweep threshold 1000; } } } policies { from-zone oam to-zone untrust { policy default-permit { match { source-address any; destination-address any; application any; } then { permit; } } } from-zone trust to-zone untrust { policy default-permit { match { source-address any; destination-address any; application any; } then { permit; } } } from-zone oam to-zone oam { policy default-permit { match { source-address any; destination-address any; application any; } then { permit; } } } default-policy { deny-all; } } zones { security-zone trust { tcp-rst; host-inbound-traffic { system-services { all; } protocols { all; } } } security-zone oam { tcp-rst; host-inbound-traffic { system-services { all; } protocols { all; } } interfaces { ge-0/0/1; lo0.0; } interfaces { st0.4000; st0.4001; } } security-zone untrust { screen untrust-screen; host-inbound-traffic { system-services { dhcp; ike; ssh; ping; } protocols { bgp; } } interfaces { ge-0/0/2; ge-0/0/3; } } } nat { source { pool oam_pool { address 192.168.210.4/32; } rule-set mgmt-traffic-nat { from interface ge-0/0/1.0; to interface st0.4000; to interface st0.4001; rule r1 { match { destination-address 192.168.10.0/24; } then { source-nat { pool { oam_pool; } } } } } pool oam_pool { address 192.168.210.4/32; } rule-set own-mgmt-traffic-nat { from routing-instance default; to interface st0.4000; to interface st0.4001; rule r2 { match { source-address 0.0.0.0/0; protocol icmp; } then { source-nat { off; } } } rule r3 { match { source-address 0.0.0.0/0; } then { source-nat { pool { oam_pool; } } } } } } } } interfaces { st0 { per-unit-scheduler; unit 4000 { family inet { address 10.176.0.65/31; } } unit 4001 { family inet { address 10.176.0.67/31; } } } /* Loopback Interface */ lo0 { description "Loopback Interface"; unit 0 { family inet { address 192.168.210.4/32; } } } /* Internal management port */ fxp0 { description "Internal management port"; unit 0 { family inet { dhcp-client { lease-time infinite; force-discover; } } } } /* Internal OAM interface */ ge-0/0/1 { unit 0 { family inet { address 10.10.10.3/24; } } } /* wan_0 interface */ ge-0/0/2 { description "WAN-0 interface"; unit 0 { family inet { address 192.168.130.2/24; } disable; } } /* wan_1 interface */ ge-0/0/3 { description "WAN-1 interface"; unit 0 { family inet { address 192.168.133.2/24; } } } /* wan_2 interface */ /* wan_3 interface */ /* AUX_0 Connected to JCP */ ge-0/0/4 { description "AUX_0 Connected to JCP"; vlan-tagging; unit 0 { vlan-id 4001; family inet { address 10.10.0.2/24; } } } /* AUX_1 */ ge-0/0/5 { description "AUX_1"; unit 0 { family inet { address 10.10.12.2/24; } } } /* AUX_2 */ ge-0/0/6 { description "AUX_2"; unit 0 { family inet { address 10.10.13.2/24; } } } } routing-options { autonomous-system 64512; static { route 192.168.210.1/32 { next-hop st0.4000 } route 192.168.190.254/32 next-hop 192.168.130.1; route 192.168.210.1/32 { next-hop st0.4001 } route 192.168.191.254/32 next-hop 192.168.133.1; } forwarding-table { export rejject_access_internal_fxp0; } } routing-options { static { route 0.0.0.0/0 { next-hop 192.168.133.1; no-readvertise; } } } protocols { bgp { group oam-bgp { type internal; local-address 192.168.210.4; family inet { unicast; } import prim-lp-import; neighbor 192.168.210.1 { export oam-route-export-prim; } neighbor 192.168.210.1 { export oam-route-export-prim; } } } } policy-options { community Hub-Primary-Select members target:192.168.210.1:1; community Hub-Primary-Select members target:192.168.210.1:1; policy-statement prim-lp-import { term 1 { from next-hop 192.168.210.1; then { local-preference 200; accept; } } } policy-statement prim-lp-import { term 1 { from next-hop 192.168.210.1; then { local-preference 200; accept; } } } policy-statement oam-route-export-prim { term 1 { from { protocol direct; route-filter 192.168.210.4/32 exact; } then { community add Hub-Primary-Select; accept; } } term default { then reject; } } policy-statement oam-route-export { term 1 { from { protocol direct; route-filter 192.168.210.4/32 exact; } then { accept; } } term default { then reject; } } policy-statement ebgp-export { term static { from protocol static; then accept; } term reject { then reject; } } policy-statement rejject_access_internal_fxp0 { from { protocol access-internal; interface fxp0.0; } then reject; } } class-of-service { interfaces { ge-0/0/3 { shaping-rate 1000m; } ge-0/0/2 { shaping-rate 1000m; } } } snmp { engine-id { local gwr; } } security { ike { proposal aes-256-gcm-PSK { authentication-method pre-shared-keys; dh-group group14; encryption-algorithm aes-256-gcm; } proposal aes-256-cbc-PSK { authentication-method pre-shared-keys; dh-group group14; authentication-algorithm sha-256; encryption-algorithm aes-256-cbc; } policy f3101151fcf4eab7721f180002a4ea76 { mode aggressive; proposals [ aes-256-gcm-PSK aes-256-cbc-PSK ]; pre-shared-key ascii-text "OAM_SDWANSPOKE2_WAN_0_HUB1_WAN_0_IPSEC_0"; } gateway a1840494e2f3b631ce13410c78d03ca4 { ike-policy f3101151fcf4eab7721f180002a4ea76; address 192.168.190.254; local-identity hostname OAM-SDWANSPOKE2_WAN_0_HUB1_WAN_0_IPSEC_0; dead-peer-detection { interval 10; threshold 3; } external-interface ge-0/0/2.0; version v2-only; } } ipsec { proposal 2f617c8225123e73c501f2fab326a104 { protocol esp; encryption-algorithm aes-256-gcm; } proposal 4b3a3ace650cdcd8c697b07306b6d38d { protocol esp; authentication-algorithm hmac-sha-256-128; encryption-algorithm aes-256-cbc; } policy 09d7d4e25c36be0a1bd846a9b9dc7e81 { perfect-forward-secrecy { keys group14; } proposals [ 2f617c8225123e73c501f2fab326a104 4b3a3ace650cdcd8c697b07306b6d38d ]; } vpn 6e71f901efb0d901a0b4a253c96af4e8 { bind-interface st0.4000; ike { gateway a1840494e2f3b631ce13410c78d03ca4; ipsec-policy 09d7d4e25c36be0a1bd846a9b9dc7e81; proxy-identity { local 10.176.0.65/31; remote 10.176.0.64/31; } } establish-tunnels immediately; } } ike { proposal aes-256-gcm-PSK { authentication-method pre-shared-keys; dh-group group14; encryption-algorithm aes-256-gcm; } proposal aes-256-cbc-PSK { authentication-method pre-shared-keys; dh-group group14; authentication-algorithm sha-256; encryption-algorithm aes-256-cbc; } policy 09c23266f7f1a68fd43760d641114a62 { mode aggressive; proposals [ aes-256-gcm-PSK aes-256-cbc-PSK ]; pre-shared-key ascii-text "OAM_SDWANSPOKE2_WAN_1_HUB1_WAN_1_IPSEC_0"; } gateway c5955a9ef806914db987f7e0d799c6bc { ike-policy 09c23266f7f1a68fd43760d641114a62; address 192.168.191.254; local-identity hostname OAM-SDWANSPOKE2_WAN_1_HUB1_WAN_1_IPSEC_0; dead-peer-detection { interval 10; threshold 3; } external-interface ge-0/0/3.0; version v2-only; } } ipsec { proposal 2f617c8225123e73c501f2fab326a104 { protocol esp; encryption-algorithm aes-256-gcm; } proposal 4b3a3ace650cdcd8c697b07306b6d38d { protocol esp; authentication-algorithm hmac-sha-256-128; encryption-algorithm aes-256-cbc; } policy 09d7d4e25c36be0a1bd846a9b9dc7e81 { perfect-forward-secrecy { keys group14; } proposals [ 2f617c8225123e73c501f2fab326a104 4b3a3ace650cdcd8c697b07306b6d38d ]; } vpn 77037ea27b322b2642d831afc085471d { bind-interface st0.4001; ike { gateway c5955a9ef806914db987f7e0d799c6bc; ipsec-policy 09d7d4e25c36be0a1bd846a9b9dc7e81; proxy-identity { local 10.176.0.67/31; remote 10.176.0.66/31; } } establish-tunnels immediately; } } } groups { cso-security-base { interfaces { ge-0/0/2 { unit 0 { family inet { filter { group 2; } } } } st0 { unit 4000 { family inet { filter { group 2; } } } unit 4001 { family inet { filter { group 2; } } } } ge-0/0/3{ unit 0 { family inet { filter { group 3; } } } } ge-0/0/4 { unit <*> { family inet { filter { group 1; } } } } ge-0/0/6 { unit <*> { family inet { filter { group 1; } } } } fxp0 { unit 0 { family inet { filter { group 55; } } } } ge-0/0/1 { unit 0 { family inet { filter { group 54; } } } } lo0 { unit 0 { family inet { filter { input protect_re_ipv4; } } } } } system { no-redirects; authentication-order password; login { announcement "This system is private property."; message "Unauthorized access will be reported."; retry-options { tries-before-disconnect 3; lockout-period 5; backoff-threshold 2; backoff-factor 5; maximum-time 20; } user juniper { class admin; authentication { encrypted-password "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0"; } } } services { ssh { root-login allow; no-tcp-forwarding; protocol-version v2; connection-limit 50; rate-limit 50; } netconf { ssh { connection-limit 49; rate-limit 49; } } } } policy-options { prefix-list re-ntp { apply-path "system ntp server <*>"; } prefix-list re-ssh { 192.168.10.0/24; 192.168.210.4/32; 10.10.10.0/24; 192.0.2.254/32; } prefix-list bgp-neighbors { apply-path "protocols bgp group <*> neighbor <*>"; } prefix-list re-bgp-vrf { apply-path "routing-instances <*> protocols bgp group <*> neighbor <*>"; } prefix-list re-dns { apply-path "system name-server <*>"; } prefix-list loopback-ipv4 { apply-path "interfaces lo0 unit 0 family inet address <*>"; } prefix-list re-ospf { apply-path "interfaces <*> unit <*> family inet address <*>"; } prefix-list re-tacacs { apply-path "system tacplus-server <*>"; } prefix-list re-snmp { 192.168.10.0/24; } } firewall { family inet { filter protect_re_ipv4 { term bfd { from { source-prefix-list { re-bgp-vrf; re-ospf; } protocol udp; source-port 49152-65535; destination-port [ 3784 4784 ]; } then { count bfd; accept; } } term ssh { from { interface-group [ 2 55 54]; protocol tcp; port ssh; } then { count ssh; accept; } } term cso-port-444-permit { from { interface-group [ 2 55]; source-prefix-list { re-ssh; } protocol tcp; port 444; } then { count cso-port-444; accept; } } term icmp { from { protocol icmp; icmp-type [ echo-request echo-reply unreachable time-exceeded ]; } then { policer icmp; count icmp; accept; } } term trace-route { from { protocol udp; destination-port 33434-33523; } then { policer tracert; accept; } } term dhcp { from { protocol udp; port [ 67 68 ]; } then { policer dhcp; count dhcp; accept; } } term bgp { from { source-prefix-list { bgp-neighbors; re-bgp-vrf; } protocol tcp; port bgp; } then { count bgp; accept; } } term ntp-local { from { source-prefix-list { re-ntp; loopback-ipv4; } protocol udp; port ntp; } then { count ntp; accept; } } term ike { from { interface-group [ 2 3]; protocol udp; destination-port [ 500 4500 ]; } then { count ike; accept; } } term gre-oam { from { protocol udp; source-port 49153; destination-port 49153; } then { count gre-oam; accept; } } term ospf { from { interface-group 1; source-prefix-list { re-ospf; } protocol ospf; } then { count ospf; accept; } } term dns { from { interface-group [ 2 3]; prefix-list { re-dns; } protocol udp; port domain; } then { policer dns-policer; count dns; accept; } } term https_discard { from { interface-group 1; protocol tcp; source-port https; } then { count https-discard; discard; } } term https { from { protocol tcp; source-port https; } then { count https; accept; } } term http { from { interface-group 2; protocol tcp; source-port 8060; } then { count http; accept; } } term external-syslog { from { source-prefix-list { re-ssh; } protocol [ tcp udp ]; port [ 514 3514 ]; } then { count external-syslog; accept; } } term default { then { count discard-count; log; discard; } } } } policer icmp { if-exceeding { bandwidth-limit 1000000; burst-size-limit 2000; } then discard; } policer tracert { if-exceeding { bandwidth-limit 1000000; burst-size-limit 15000; } then discard; } policer dhcp { if-exceeding { bandwidth-limit 1000000; burst-size-limit 15000; } then discard; } policer dns-policer { if-exceeding { bandwidth-limit 1000000; burst-size-limit 15000; } then discard; } } } } apply-groups cso-security-base;
   Feb 12, 2019, 12:08:07 PMCreate VM Stage 4: create abstract config SUCCESS
   Feb 12, 2019, 12:08:08 PMResolve vlink device profile SUCCESS, profile_id = e4b7a848-68ca-359e-9538-ca60bf980856, results = {'config_templates': {}, 'resources': {u'create_vlinks': {u'vlinks': [{u'subnets': [{u'subnet': u'10.10.1.2/24'}], u'job-name': u'create_vl-lan-0_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4032, u'enable-dhcp': False, u'port-cross-connect-info': {u'pcc-fixed-endpoint': {u'pcc-endpoint-type': u'physical-interface', u'pcc-port': u'hsxe1'}, u'pcc-name': u'pcc-vl-lan-0'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'4807e324-4ec1-3d24-85b6-4b60b1f6d4de', u'vl-instance-name': u'vl-lan-0', u'onboard': False}, {u'subnets': [{u'subnet': u'10.10.2.2/24'}], u'job-name': u'create_vl-lan-1_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4033, u'enable-dhcp': False, u'port-cross-connect-info': {u'pcc-fixed-endpoint': {u'pcc-endpoint-type': u'physical-interface', u'pcc-port': u'hsxe1'}, u'pcc-name': u'pcc-vl-lan-1'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'4807e324-4ec1-3d24-85b6-4b60b1f6d4de', u'vl-instance-name': u'vl-lan-1', u'onboard': False}, {u'subnets': [{u'subnet': u'10.10.0.1/24'}], u'job-name': u'create_vl-aux-0_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4001, u'enable-dhcp': False, u'port-cross-connect-info': {u'pcc-fixed-endpoint': {u'pcc-endpoint-type': u'virtual-network-function', u'pcc-vnf-name': u'GWR.sdwanspoke2.hubspoketenant', u'pcc-port': u'eth5'}, u'pcc-name': u'pcc-vl-aux-0'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'd1ce9770-ddda-35d6-bbcb-f7e441d3e618', u'vl-instance-name': u'vl-aux-0', u'onboard': False}, {u'subnets': [{u'subnet': u'10.10.12.1/24'}], u'job-name': u'create_vl-aux-1_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4002, u'enable-dhcp': False, u'port-cross-connect-info': {u'pcc-fixed-endpoint': {u'pcc-endpoint-type': u'virtual-network-function', u'pcc-vnf-name': u'GWR.sdwanspoke2.hubspoketenant', u'pcc-port': u'eth6'}, u'pcc-name': u'pcc-vl-aux-1'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'd1ce9770-ddda-35d6-bbcb-f7e441d3e618', u'vl-instance-name': u'vl-aux-1', u'onboard': False}, {u'subnets': [{u'subnet': u'10.10.13.1/24'}], u'job-name': u'create_vl-aux-2_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4003, u'enable-dhcp': False, u'port-cross-connect-info': {u'pcc-fixed-endpoint': {u'pcc-endpoint-type': u'virtual-network-function', u'pcc-vnf-name': u'GWR.sdwanspoke2.hubspoketenant', u'pcc-port': u'eth7'}, u'pcc-name': u'pcc-vl-aux-2'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'd1ce9770-ddda-35d6-bbcb-f7e441d3e618', u'vl-instance-name': u'vl-aux-2', u'onboard': False}, {u'job-name': u'create_vl-wan-0_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4050, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'd9138dcd-f40a-36e8-aa89-ca8bb84ddcae', u'vl-instance-name': u'vl-wan-0', u'onboard': False}, {u'job-name': u'create_vl-wan-1_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4051, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'd9138dcd-f40a-36e8-aa89-ca8bb84ddcae', u'vl-instance-name': u'vl-wan-1', u'onboard': False}, {u'job-name': u'create_vl-wan-2_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4052, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'd9138dcd-f40a-36e8-aa89-ca8bb84ddcae', u'vl-instance-name': u'vl-wan-2', u'onboard': False}, {u'job-name': u'create_vl-wan-3_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4053, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'd9138dcd-f40a-36e8-aa89-ca8bb84ddcae', u'vl-instance-name': u'vl-wan-3', u'onboard': False}, {u'subnets': [{u'subnet': u'10.10.10.0/24'}], u'job-name': u'create_vl-mgmt_ffabf035-e72f-4951-a20f-86bf36913667', u'vlink-info': {u'vlan-id': 4010, u'enable-dhcp': False, u'bridge-name': {u'bridge-name': u'ovs-sys-br'}}, u'resource-pool': u'914a191f-7728-4254-802d-a2ff4ec256fa', u'vim-id': u'af808a4f-10fd-4634-947f-1a072db58bf5', u'vld-id': u'16c4d32b-1d5e-3df2-a9cb-e21a5998b712', u'vl-instance-name': u'vl-mgmt', u'onboard': False}]}}}
   Feb 12, 2019, 12:08:08 PMNotification handler info: {"notification_info": {"queue": "tssm.ztp.queue.3d05df60-9e54-418e-b7c3-f4a035bd8c84", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "vm_create_3d05df60-9e54-418e-b7c3-f4a035bd8c84", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-expires": 900000, "x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   Feb 12, 2019, 12:08:09 PMCreate VM Stage 5: create_vm rpc SUCCESS, error: , request_id: 7f7d60e9-b0c9-4c9a-8049-8a56afb1a601, vm_uuid: b6424e50-9d2f-4628-a110-b0706ed03378, job_id: 7f7d60e9-b0c9-4c9a-8049-8a56afb1a601
   Feb 12, 2019, 12:19:04 PMCreate VM Stage 6: received notification {"status": "SUCCESS", "X-Request-Id": "api_server_db_2b1bea43-fce1-4eb5-b38c-90641a60153f,AXdP,hWUw,ajzX", "api_key": "v3", "rpc_type": "Create_VM", "request_id": "7f7d60e9-b0c9-4c9a-8049-8a56afb1a601"}
   Feb 12, 2019, 12:19:04 PMUpdated token to customer project scope SUCCESS
   Feb 12, 2019, 12:19:04 PMCreate VM Stage 6: got notification and create vm SUCCESS
   Feb 12, 2019, 12:19:05 PMCreate VM Task Complete SUCCESS
   Feb 12, 2019, 12:19:05 PMTask complete
   Task: switch-wan-ip-to-gwr
   Feb 12, 2019, 12:19:05 PMIssue all service libs SUCCESS
   Feb 12, 2019, 12:19:06 PMPreferred wan_link: WAN_0
   Feb 12, 2019, 12:19:06 PMSwitching WAN IP to GWR stage 1: resolve profile switch-wan-ip-to-gwr SUCCESS
   Feb 12, 2019, 12:19:07 PMIssue all service libs SUCCESS
   Feb 12, 2019, 12:19:07 PMnotification handler info: {"notification_info": {"queue": "tssm.ztp.queue.55993c6b-7e5f-4213-ad17-57ca71746b1b", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "switch_ip_to_gwr55993c6b-7e5f-4213-ad17-57ca71746b1b", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-expires": 900000, "x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   Feb 12, 2019, 12:19:07 PMCalling install_device_package RPC SUCCESS, request_id: dc9bb154-a51a-4e8a-b378-b3913abecdd8
   Feb 12, 2019, 12:19:12 PMReceived notification of install_device_package RPC: {"package_image_uuid": "abfd47de-8a45-410c-9c11-dcd82a23a663", "reason": null, "requestid": "dc9bb154-a51a-4e8a-b378-b3913abecdd8", "device_id": "ffabf035-e72f-4951-a20f-86bf36913667", "response": "SUCCESS", "component_name": "JDM"}
   Feb 12, 2019, 12:19:12 PMInstall_device_package SUCCESS
   Feb 12, 2019, 12:19:12 PMNotification handler info: {"notification_info": {"queue": "tssm.ztp.queue.55993c6b-7e5f-4213-ad17-57ca71746b1b", "exchange": "dms_notification", "routing_key": "ffabf035-e72f-4951-a20f-86bf36913667.#", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-expires": 900000, "x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   Feb 12, 2019, 12:20:33 PMSwitching WAN IP to GWR: received notification {"hapi_remote_host": "csp.csp-dms-cms-inv-central-core-101468512-5c3vl", "hapi_user_client_ip": "172.16.73.24", "device_state": "ACTIVE", "device_previous_state": "GWR_SPAWNED", "hapi_request_id": "api_server_db_1c912ca2-aa44-4bf1-80af-a39c570776c7,Fuzh", "device_id": "ffabf035-e72f-4951-a20f-86bf36913667"}
   Feb 12, 2019, 12:20:34 PMSwitching WAN IP to GWR stage 2: switching ip to gwr for device ffabf035-e72f-4951-a20f-86bf36913667 SUCCESS
   Feb 12, 2019, 12:20:34 PMTask complete
   Task: spawn-cluster-gwr
   Feb 12, 2019, 12:20:34 PMIssue all service libs SUCCESS
   Feb 12, 2019, 12:20:34 PMWorkflow not found in given device profile Workflow cluster-formation not found in the given device profile or its super profiles.
   Feb 12, 2019, 12:20:34 PMCluster GWR not required
   Feb 12, 2019, 12:20:34 PMTask complete
   Task: deploy-jcp-config
   Feb 12, 2019, 12:20:35 PMDeploy Config Stage 1: component JCP does not have abstract config to push and deploy
   Feb 12, 2019, 12:20:35 PMTask complete
   Task: deploy-jdm-config
   Feb 12, 2019, 12:20:36 PMDeploy Config Stage 1: component JDM does not have abstract config to push and deploy
   Feb 12, 2019, 12:20:36 PMTask complete
   Task: deploy-gwr-config
   Feb 12, 2019, 12:20:36 PMDeploy Config Stage 1: component GWR does not have abstract config to push and deploy
   Feb 12, 2019, 12:20:36 PMTask complete
   Task: activate-jcp
   Feb 12, 2019, 12:20:36 PMActivate Component Task Start, task_id = activate-jcp ...
   Feb 12, 2019, 12:20:37 PMInitiate all service libs SUCCESS
   Feb 12, 2019, 12:20:37 PMnotification handler info: {"notification_info": {"queue": "tssm.ztp.queue.6b16f729-707a-4f62-80ec-ac244bd04b56", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "cmp_activate_6b16f729-707a-4f62-80ec-ac244bd04b56", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-expires": 900000, "x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   Feb 12, 2019, 12:20:37 PMActivation Component Try: 1
   Feb 12, 2019, 12:20:37 PMActivate Component Stage 1: activate_component rpc SUCCESS, requstid = 33719745-eedf-49c0-88db-bbabb2a6013a
   Feb 12, 2019, 12:20:38 PMActivate Component Stage 2: received notification {"hapi_remote_host": "csp.csp-dms-cms-inv-central-core-101468512-5c3vl", "hapi_request_id": "api_server_db_2b1bea43-fce1-4eb5-b38c-90641a60153f,AXdP,Tzj0,61bD", "reason": null, "requestid": "33719745-eedf-49c0-88db-bbabb2a6013a", "device_id": "ffabf035-e72f-4951-a20f-86bf36913667", "response": "SUCCESS", "component_name": "JCP"}
   Feb 12, 2019, 12:20:38 PMActivate Component Stage 2: notification received and activation SUCCESS
   Feb 12, 2019, 12:20:39 PMActivate Component Task Complete SUCCESS
   Feb 12, 2019, 12:20:39 PMTask complete
   Task: activate-gwr
   Feb 12, 2019, 12:20:39 PMActivate Component Task Start, task_id = activate-gwr ...
   Feb 12, 2019, 12:20:39 PMInitiate all service libs SUCCESS
   Feb 12, 2019, 12:20:39 PMnotification handler info: {"notification_info": {"queue": "tssm.ztp.queue.391e540c-52f7-4cb7-9cf8-0392b066ce45", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "cmp_activate_391e540c-52f7-4cb7-9cf8-0392b066ce45", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-expires": 900000, "x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   Feb 12, 2019, 12:20:39 PMActivation Component Try: 1
   Feb 12, 2019, 12:20:39 PMActivate Component Stage 1: activate_component rpc SUCCESS, requstid = 54139c76-4bd1-4d41-996c-2a19417dde98
   Feb 12, 2019, 12:20:51 PMActivate Component Stage 2: received notification {"hapi_remote_host": "csp.csp-dms-cms-inv-central-core-101468512-5c3vl", "hapi_request_id": "api_server_db_2b1bea43-fce1-4eb5-b38c-90641a60153f,AXdP,VzQi,rYgW", "reason": null, "requestid": "54139c76-4bd1-4d41-996c-2a19417dde98", "device_id": "ffabf035-e72f-4951-a20f-86bf36913667", "response": "SUCCESS", "component_name": "GWR"}
   Feb 12, 2019, 12:20:51 PMActivate Component Stage 2: notification received and activation SUCCESS
   Feb 12, 2019, 12:20:51 PMActivate Component Task Complete SUCCESS
   Feb 12, 2019, 12:20:52 PMTask complete
   Task: install-monitoring-agent
   Feb 12, 2019, 12:20:52 PMIssue all service libs SUCCESS
   Feb 12, 2019, 12:20:53 PMInstall Monitor Obj Stage 1: resolve profile install-monitoring-agent SUCCESS
   Feb 12, 2019, 12:20:53 PMIssue all service libs SUCCESS
   Feb 12, 2019, 12:20:53 PMnotification handler info: {"notification_info": {"queue": "tssm.ztp.queue.0ddc9955-f19c-47f1-8220-5685b7af2a8a", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "mnt_agt_inst_0ddc9955-f19c-47f1-8220-5685b7af2a8a", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-expires": 900000, "x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   Feb 12, 2019, 12:20:53 PMCalling install_device_package RPC SUCCESS, request_id: d980ff1c-0116-4767-8902-a81d160cef35
   Feb 12, 2019, 12:21:13 PMReceived notification of install_device_package RPC: {"package_image_uuid": "c7c4d072-b8c1-4c83-a823-abda3d8ae49b", "reason": null, "requestid": "d980ff1c-0116-4767-8902-a81d160cef35", "device_id": "ffabf035-e72f-4951-a20f-86bf36913667", "response": "SUCCESS", "component_name": "JDM"}
   Feb 12, 2019, 12:21:13 PMInstall_device_package SUCCESS
   Feb 12, 2019, 12:21:13 PMInstall Monitor Obj Stage 2: install fmpm agent for device ffabf035-e72f-4951-a20f-86bf36913667 SUCCESS
   Feb 12, 2019, 12:21:13 PMTask complete
   Task: create-monitored-object
   Feb 12, 2019, 12:21:14 PMIssue all service libs SUCCESS
   Feb 12, 2019, 12:21:15 PMCreate monitoring obj stage 1: resolve profile create-monitoring-object SUCCESS
   Feb 12, 2019, 12:21:15 PMcreate monitored object for device ffabf035-e72f-4951-a20f-86bf36913667 is {'pop_uuid': u'4250c0eb-0cf0-48f6-96fb-bf0dfa903721', 'site_uuid': u'fd651718-bb9b-40b3-9ccb-f5f15829d1a2', 'components': [u'JDM', u'JCP', u'GWR', u'FW', u'NAT'], 'region_uuid': u'd061a1fb-584b-4112-8614-a8daac0156f1', 'image_type': u'NFX/nfx250_s2_10_t', 'tenant_id': 'd3da09f9-2de2-4663-9534-7220df5a31ba', 'role': None, 'object_type': u'UCPE_DEVICE'}
   Feb 12, 2019, 12:21:15 PMUpdated token to customer project scope SUCCESS
   Feb 12, 2019, 12:21:16 PMnotification handler info: {"notification_info": {"queue": "tssm.fmpm_api_que-ffabf035-e72f-4951-a20f-86bf36913667", "exchange": "fmpm_api_status", "routing_key": "#.ffabf035-e72f-4951-a20f-86bf36913667", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-expires": 900000, "x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   Feb 12, 2019, 12:21:19 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:21:19 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:21:19 PMcreate monitored object for device ffabf035-e72f-4951-a20f-86bf36913667 SUCCESS
   Feb 12, 2019, 12:21:19 PMTask complete
   Task: install-site-pki-cert
   Feb 12, 2019, 12:21:20 PMStart install site pki certificates for device ffabf035-e72f-4951-a20f-86bf36913667 SUCCESS
   Feb 12, 2019, 12:21:20 PMTask complete
   Task: site-activation
   Feb 12, 2019, 12:21:26 PMSite activation rpc called for device ffabf035-e72f-4951-a20f-86bf36913667
   Feb 12, 2019, 12:21:43 PMSite activation rpc completed successfully in RM
   Feb 12, 2019, 12:22:58 PMDevice ffabf035-e72f-4951-a20f-86bf36913667: Config-Deploy SUCCESS
   Feb 12, 2019, 12:24:29 PMDevice 6aa35e32-7bd0-44ed-8525-35afc7f1ce32: Config-Deploy SUCCESS (Resource-discovery SUCCESS)
   Feb 12, 2019, 12:24:40 PMTask complete
   Task: add-department
   Feb 12, 2019, 12:21:44 PMStage 2 config start, task_id = add-department ...
   Feb 12, 2019, 12:21:45 PMStart stage-2-config stage 1: resolve profile add-department success
   Feb 12, 2019, 12:21:45 PMStart stage-2-config stage 2: create abstract configs success: {'JDM': [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JDM/jdm-add-department-config']], 'JUNOS': [], 'JCP': [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JCP/jcp-add-department-config']], 'GWR': [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'GWR/gwr-add-department-config']]}
   Feb 12, 2019, 12:21:45 PMConfigs to be deployed include {'JDM': [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JDM/jdm-add-department-config']], 'JCP': [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JCP/jcp-add-department-config']], 'GWR': [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'GWR/gwr-add-department-config']]}
   Feb 12, 2019, 12:21:45 PMAbout to publish and deploy JDM configs [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JDM/jdm-add-department-config']]
   Feb 12, 2019, 12:21:48 PMStage 2 config for JDM: [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JDM/jdm-add-department-config']] deployed success
   Feb 12, 2019, 12:21:48 PMAbout to publish and deploy JCP configs [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JCP/jcp-add-department-config']]
   Task: 15
   Feb 12, 2019, 12:21:49 PMDeploy Config Stage 1: publish config [u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JCP/jcp-add-department-config'] for component JCP SUCCESS
   Feb 12, 2019, 12:21:49 PMDeploy Config Stage 2: deploy config [u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JCP/jcp-add-department-config'] for component JCP SUCCESS, request_id: 2d3afdc3-df32-410e-91e7-10934fb57a18
   Feb 12, 2019, 12:21:53 PMDeploy Config Stage 3: JCP received notification: {"status": "SUCCESS", "hapi_remote_host": "csp.csp-dms-cms-inv-central-core-101468512-5c3vl", "description": null, "hapi_request_id": "api_server_db_2b1bea43-fce1-4eb5-b38c-90641a60153f,AXdP,owl3,Lx2o", "details": {"620e070a-4b1c-4e44-9814-ce4ce8fa573e": {"status": "SUCCESS", "abstract_config_uuid": "620e070a-4b1c-4e44-9814-ce4ce8fa573e", "description": "delete apply-groups dept-configuration \nwarning: element 'dept-configuration' not found\n\n{master:0}[edit]\ncsp@vjunos0# delete apply-groups dept-configuration \nwarning: element 'dept-configuration' not found\n\n{master:0}[edit]\ncsp@vjunos0# delete groups dept-configuration \nwarning: statement not found\n\n{master:0}[edit]\ncsp@vjunos0# set groups dept-configuration interfaces sxe-0/0/1 unit 0 famcsp@vjunos0# ...ration interfaces sxe-0/0/1 unit 0 fami \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bly ethernet-switchicsp@vjunos0# ...e-0/0/1 unit 0 family ethernet-switchin \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bg vlan members ls_ccsp@vjunos0# ...y ethernet-switching vlan members ls_cf \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bg_desktop4 \n\n{master:0}[edit]\ncsp@vjunos0# set groups dept-configuration interfaces ge-0/0/0 unit 0 famicsp@vjunos0# ...ration interfaces ge-0/0/0 unit 0 famil \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\by ethernet-switchincsp@vjunos0# ...-0/0/0 unit 0 family ethernet-switching \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b interface-mode trucsp@vjunos0# ... ethernet-switching interface-mode trun \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bk \n\n{master:0}[edit]\ncsp@vjunos0# set groups dept-configuration interfaces ge-0/0/0 unit 0 famicsp@vjunos0# ...ration interfaces ge-0/0/0 unit 0 famil \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\by ethernet-switchincsp@vjunos0# ...-0/0/0 unit 0 family ethernet-switching \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b vlan members ls_cfcsp@vjunos0# ... ethernet-switching vlan members ls_cfg \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b_desktop4 \n\n{master:0}[edit]\ncsp@vjunos0# set groups dept-configuration interfaces ge-0/0/0 \u0007mtu 9192 \n\n{master:0}[edit]\ncsp@vjunos0# set groups dept-configuration interfaces ge-0/0/0 speed auto \n\n{master:0}[edit]\ncsp@vjunos0# set groups dept-configuration interfaces ge-0/0/0 ether-optiocsp@vjunos0# ...ration interfaces ge-0/0/0 ether-option \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bs auto-negotiation \n\n{master:0}[edit]\ncsp@vjunos0# set groups dept-configuration vlans ls_cfg_desktop4 vlan-id 1csp@vjunos0# ...ration vlans ls_cfg_desktop4 vlan-id 10 \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b66 \n\n{master:0}[edit]\ncsp@vjunos0# set apply-groups dept-configuration \n\n{master:0}[edit]\ncsp@vjunos0# ", "abstract_config_name": ["default-domain", "hubspoketenant", "sdwanspoke2", "JCP/jcp-add-department-config"], "config_change_id_list": ["676559ee-66a4-44d2-9178-29babc9a7b71"], "device_component_name": "JCP", "device_uuid": "ffabf035-e72f-4951-a20f-86bf36913667"}}, "requestid": "2d3afdc3-df32-410e-91e7-10934fb57a18"}
   Feb 12, 2019, 12:21:53 PMDeploy Config Stage 3: deploy config SUCCESS
   Feb 12, 2019, 12:21:53 PMTask complete
   Feb 12, 2019, 12:21:53 PMStage 2 config for JCP: [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'JCP/jcp-add-department-config']] deployed success
   Feb 12, 2019, 12:21:53 PMAbout to publish and deploy GWR configs [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'GWR/gwr-add-department-config']]
   Task: 16
   Feb 12, 2019, 12:21:54 PMDeploy Config Stage 1: publish config [u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'GWR/gwr-add-department-config'] for component GWR SUCCESS
   Feb 12, 2019, 12:21:54 PMDeploy Config Stage 2: deploy config [u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'GWR/gwr-add-department-config'] for component GWR SUCCESS, request_id: b2c32b75-80db-4bb1-9018-cc8cd0bb8eac
   Feb 12, 2019, 12:22:00 PMDeploy Config Stage 3: GWR received notification: {"status": "SUCCESS", "hapi_remote_host": "csp.csp-dms-cms-inv-central-core-101468512-5c3vl", "description": null, "hapi_request_id": "api_server_db_2b1bea43-fce1-4eb5-b38c-90641a60153f,AXdP,0xfJ,4l0x", "details": {"3680c29c-7061-4021-afb6-6ab49fc73c90": {"status": "SUCCESS", "abstract_config_uuid": "3680c29c-7061-4021-afb6-6ab49fc73c90", "description": "delete apply-groups dept-configurationcsp@GWR.sdwanspoke2.hubspoketenant# ...t-configuration \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\nwarning: element 'dept-configuration' not found\n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# delete apply-groups dept-configurationcsp@GWR.sdwanspoke2.hubspoketenant# ...t-configuration \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\nwarning: element 'dept-configuration' not found\n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# delete groups dept-configuration \nwarning: statement not found\n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set security application-tracking \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration securitycsp@GWR.sdwanspoke2.hubspoketenant# ...ration security \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bzones security-zonecsp@GWR.sdwanspoke2.hubspoketenant# ...s security-zone \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bDefault host-inbouncsp@GWR.sdwanspoke2.hubspoketenant# ...ult host-inbound \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b-traffic system-sercsp@GWR.sdwanspoke2.hubspoketenant# ...ffic system-serv \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bices all \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration securitycsp@GWR.sdwanspoke2.hubspoketenant# ...ration security \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bzones security-zonecsp@GWR.sdwanspoke2.hubspoketenant# ...s security-zone \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bDefault host-inbouncsp@GWR.sdwanspoke2.hubspoketenant# ...ult host-inbound \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b-traffic protocols csp@GWR.sdwanspoke2.hubspoketenant# ...ffic protocols a \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bll \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set security zones security-zone Defaucsp@GWR.sdwanspoke2.hubspoketenant# ...rity-zone Defaul \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bt application-trackcsp@GWR.sdwanspoke2.hubspoketenant# ...plication-tracki \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bng \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration interfaccsp@GWR.sdwanspoke2.hubspoketenant# ...ration interface \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bs ge-0/0/4 vlan-tagcsp@GWR.sdwanspoke2.hubspoketenant# ...-0/0/4 vlan-tagg \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bing \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration interfaccsp@GWR.sdwanspoke2.hubspoketenant# ...ration interface \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bs ge-0/0/4 unit 106csp@GWR.sdwanspoke2.hubspoketenant# ...-0/0/4 unit 1066 \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b vlan-id 1066 \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration routing-csp@GWR.sdwanspoke2.hubspoketenant# ...ration routing-i \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bnstances LAN-hubspocsp@GWR.sdwanspoke2.hubspoketenant# ...nces LAN-hubspok \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\betenant_DefaultVPN csp@GWR.sdwanspoke2.hubspoketenant# ...ant_DefaultVPN i \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bnterface ge-0/0/4.1csp@GWR.sdwanspoke2.hubspoketenant# ...face ge-0/0/4.10 \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b66 \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration firewallcsp@GWR.sdwanspoke2.hubspoketenant# ...ration firewall \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bfamily inet filter csp@GWR.sdwanspoke2.hubspoketenant# ...ly inet filter a \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bppqoe_filter term acsp@GWR.sdwanspoke2.hubspoketenant# ...e_filter term aq \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b_term1 from destinacsp@GWR.sdwanspoke2.hubspoketenant# ...m1 from destinat \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bion-port 36000 \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration firewallcsp@GWR.sdwanspoke2.hubspoketenant# ...ration firewall \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bfamily inet filter csp@GWR.sdwanspoke2.hubspoketenant# ...ly inet filter a \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bppqoe_filter term acsp@GWR.sdwanspoke2.hubspoketenant# ...e_filter term aq \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b_term1 then count acsp@GWR.sdwanspoke2.hubspoketenant# ...m1 then count aq \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b_counter1 \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration firewallcsp@GWR.sdwanspoke2.hubspoketenant# ...ration firewall \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bfamily inet filter csp@GWR.sdwanspoke2.hubspoketenant# ...ly inet filter a \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bppqoe_filter term acsp@GWR.sdwanspoke2.hubspoketenant# ...e_filter term aq \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b_term1 then discardcsp@GWR.sdwanspoke2.hubspoketenant# ...m1 then discard \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration firewallcsp@GWR.sdwanspoke2.hubspoketenant# ...ration firewall \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bfamily inet filter csp@GWR.sdwanspoke2.hubspoketenant# ...ly inet filter a \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bppqoe_filter term dcsp@GWR.sdwanspoke2.hubspoketenant# ...e_filter term de \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bfault then accept \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration interfaccsp@GWR.sdwanspoke2.hubspoketenant# ...ration interface \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bs ge-0/0/4 unit 106csp@GWR.sdwanspoke2.hubspoketenant# ...-0/0/4 unit 1066 \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b family inet filtercsp@GWR.sdwanspoke2.hubspoketenant# ...ily inet filter \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\binput-list appqoe_fcsp@GWR.sdwanspoke2.hubspoketenant# ...t-list appqoe_fi \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\blter \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration interfaccsp@GWR.sdwanspoke2.hubspoketenant# ...ration interface \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bs ge-0/0/4 unit 106csp@GWR.sdwanspoke2.hubspoketenant# ...-0/0/4 unit 1066 \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b family inet addrescsp@GWR.sdwanspoke2.hubspoketenant# ...ily inet address \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b 10.66.66.1/24 \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set groups dept-configuration securitycsp@GWR.sdwanspoke2.hubspoketenant# ...ration security \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bzones security-zonecsp@GWR.sdwanspoke2.hubspoketenant# ...s security-zone \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bDefault interfaces csp@GWR.sdwanspoke2.hubspoketenant# ...ult interfaces g \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\be-0/0/4.1066 \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# set apply-groups dept-configuration \n\n[edit]\ncsp@GWR.sdwanspoke2.hubspoketenant# ", "abstract_config_name": ["default-domain", "hubspoketenant", "sdwanspoke2", "GWR/gwr-add-department-config"], "config_change_id_list": ["f9553ead-f394-420d-bafd-daa2ce072137"], "device_component_name": "GWR", "device_uuid": "ffabf035-e72f-4951-a20f-86bf36913667"}}, "requestid": "b2c32b75-80db-4bb1-9018-cc8cd0bb8eac"}
   Feb 12, 2019, 12:22:00 PMDeploy Config Stage 3: deploy config SUCCESS
   Feb 12, 2019, 12:22:01 PMTask complete
   Feb 12, 2019, 12:22:01 PMStage 2 config for GWR: [[u'default-domain', u'hubspoketenant', u'sdwanspoke2', u'GWR/gwr-add-department-config']] deployed success
   Feb 12, 2019, 12:22:01 PMStart stage-2-config stage 3: publish and deploy all config success
   Feb 12, 2019, 12:22:23 PMActivating VPN routing ..
   Task: deploy-stage2-configs
   Feb 12, 2019, 12:24:40 PMStage 2 config start, task_id = deploy-stage2-configs ...
   Feb 12, 2019, 12:24:41 PMStart stage-2-config stage 1: resolve profile stage-2-config success
   Feb 12, 2019, 12:24:41 PMStart stage-2-config stage 2: create abstract configs success: {'JDM': [], 'JUNOS': [], 'JCP': [], 'GWR': []}
   Feb 12, 2019, 12:24:41 PMNo config to be published and deployed at this time
   Feb 12, 2019, 12:24:41 PMStart stage-2-config task SUCCESS
   Feb 12, 2019, 12:24:41 PMTask complete
   Task: install-license-to-device
   Feb 12, 2019, 12:24:42 PMInstall license to device start, task_id = install-license-to-device ...
   Feb 12, 2019, 12:24:42 PMinstall license to device is not required
   Feb 12, 2019, 12:24:42 PMTask complete
   Task: install-default-trustedCAs
   Feb 12, 2019, 12:24:42 PMIssue all service libs SUCCESS - CSLM
   Feb 12, 2019, 12:24:42 PMcslm notification handler info: {"notification_info": {"queue": "tssm.ztp.queue.e3c7094f-cb54-4683-998a-4cabd65b9483", "exchange": "rm-cm.tssm_ztp_exchange", "routing_key": "install_trustcas_e3c7094f-cb54-4683-998a-4cabd65b9483", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-expires": 900000, "x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   Feb 12, 2019, 12:24:43 PMCalling install default trust certificate RPC - SUCCESS, {'reason': 'Default install certificate job is in-progress', 'job_id': 'ace573d5-5596-4740-ae85-1154763a4cda'}
   Feb 12, 2019, 12:27:29 PMCSLM: received notification {"status": "success", "hapi_request_id": "api_server_db_2b1bea43-fce1-4eb5-b38c-90641a60153f,AXdP,sZrC", "is_job_timeout": false, "hapi_remote_host": "csp.csp-job-service-core-1333316040-5vff6", "jobid": "ace573d5-5596-4740-ae85-1154763a4cda"}
   Feb 12, 2019, 12:27:30 PMStart install default trusted certificates for device ffabf035-e72f-4951-a20f-86bf36913667 SUCCESS
   Feb 12, 2019, 12:27:30 PMTask complete
   Task: start-service-monitoring
   Feb 12, 2019, 12:27:31 PMStart service monitoring issue all service libs SUCCESS
   Feb 12, 2019, 12:27:32 PMRegister link monitoring : resolve profile start-fmpm-service-monitoring SUCCESS
   Feb 12, 2019, 12:27:32 PMUpdated token to customer project scope SUCCESS
   Feb 12, 2019, 12:27:33 PMIssue all service libs SUCCESS
   Feb 12, 2019, 12:27:36 PMCalling monitor_service_batch_execute RPC SUCCESS , object_id: ffabf035-e72f-4951-a20f-86bf36913667
   Feb 12, 2019, 12:27:36 PMnotification handler info: {"notification_info": {"queue": "tssm.fmpm_api_que-ffabf035-e72f-4951-a20f-86bf36913667", "exchange": "fmpm_api_status", "routing_key": "#.ffabf035-e72f-4951-a20f-86bf36913667", "opts": {"connection_opts": {"heartbeat": 300}, "unbind_queue_on_exit": false, "delete_queue_on_exit": true, "queue_opts": {"x-expires": 900000, "x-ha-policy": "all"}, "exchange_opts": {}, "connection_acquire_timeout": 1800}, "amqp_urls": "XXXXXXXX"}}
   Feb 12, 2019, 12:27:38 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:38 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:40 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:40 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:42 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:42 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:44 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:44 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:46 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:46 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:48 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:48 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:49 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:49 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:51 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:51 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:54 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:54 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:56 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:56 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:57 PMReceived notification of monitor RPC:
   Feb 12, 2019, 12:27:57 PMStart Service Monitoring SUCCESS
   Feb 12, 2019, 12:27:58 PMStart service monitoring for device ffabf035-e72f-4951-a20f-86bf36913667 SUCCESS
   Feb 12, 2019, 12:27:58 PMTask complete
   Task: ztp-summary
   Feb 12, 2019, 12:27:58 PMTask started
   Feb 12, 2019, 12:27:58 PMStart ZTP Summary start, task_id = ztp-summary ...
   Feb 12, 2019, 12:27:58 PMZTP Summary input_data {u'cluster_device_uuid': u'ffabf035-e72f-4951-a20f-86bf36913667', u'status_message': u'', u'site_name': u'sdwanspoke2', u'new_state': u'ACTIVE', u'device_uuid': u'ffabf035-e72f-4951-a20f-86bf36913667', u'device_redundancy': False, u'topo_site_uuid': u'd8d7fd62-5e41-4c33-80c9-ce66ff93ff5a', u'job_id': u'f1f7a5ff-2d6d-4ed7-b08a-ff85732da456', u'prev_job_id': None, u'device_name': u'sdwanspoke2', u'is_member_rma': False, u'device_redundancy_role': None, u'topo_device_uuid': u'ffabf035-e72f-4951-a20f-86bf36913667', u'old_state': u'EXPECTED', u'topo_cluster_device_uuid': u'ffabf035-e72f-4951-a20f-86bf36913667', u'topo_site_role': u'spoke', u'cluster_type': None, u'deplynt_scenario': u'managed_wan_v2'}...
   Feb 12, 2019, 12:27:58 PMZTP Summary kwargs {'topo_dev_state': u'PROVISIONED', 'result': True}...
   Feb 12, 2019, 12:27:59 PMZTP summary completed successfully
   Feb 12, 2019, 12:27:59 PMTask complete
   Feb 12, 2019, 12:27:59 PMZtp-activation finished complete for ems-device ffabf035-e72f-4951-a20f-86bf36913667

.. hidden-code-block:: none

   #
   # Note: This is the situation BEFORE and DURING Provisioning.
   # After provisioning the JDM connectivity changes to use the GWR
   #
   
   root@jdm:~# ifconfig
   bme1      Link encap:Ethernet  HWaddr 52:54:00:ce:bd:0a
             inet addr:192.0.2.254  Bcast:192.0.2.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fece:bd0a/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:24782 errors:0 dropped:0 overruns:0 frame:0
             TX packets:11022 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:2832635 (2.8 MB)  TX bytes:803881 (803.8 KB)
   
   bme2      Link encap:Ethernet  HWaddr 52:54:00:da:6b:be
             inet addr:128.0.0.254  Bcast:128.0.255.255  Mask:255.255.0.0
             inet6 addr: fe80::5054:ff:feda:6bbe/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:19 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:1378 (1.3 KB)  TX bytes:648 (648.0 B)
   
   jmgmt0    Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cb
             inet addr:192.168.10.24  Bcast:192.168.10.255  Mask:255.255.255.0
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:2221201 errors:0 dropped:0 overruns:0 frame:0
             TX packets:400262 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:3903144818 (3.9 GB)  TX bytes:26609557 (26.6 MB)
   
   jsxe0     Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:42 errors:0 dropped:0 overruns:0 frame:0
             TX packets:221 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:5574 (5.5 KB)  TX bytes:64134 (64.1 KB)
   
   jsxe0.0   Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:192.168.130.101  Bcast:192.168.130.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:3 errors:0 dropped:0 overruns:0 frame:0
             TX packets:7 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:948 (948.0 B)  TX bytes:1122 (1.1 KB)
   
   jsxe0.4010 Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cc
             inet addr:10.10.10.1  Bcast:10.10.10.255  Mask:255.255.255.0
             inet6 addr: fe80::f6cc:55ff:fe2b:58cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:7 errors:0 dropped:0 overruns:0 frame:0
             TX packets:5 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:322 (322.0 B)  TX bytes:438 (438.0 B)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:3405 errors:0 dropped:0 overruns:0 frame:0
             TX packets:3405 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:274212 (274.2 KB)  TX bytes:274212 (274.2 KB)
   
   phc       Link encap:Ethernet  HWaddr f4:cc:55:2b:58:cd
             UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1
             RX packets:33 errors:0 dropped:0 overruns:0 frame:0
             TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:7362 (7.3 KB)  TX bytes:0 (0.0 B)
   
   root@jdm:~# route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.130.1   0.0.0.0         UG    0      0        0 jsxe0.0
   10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.40
   128.0.0.0       0.0.0.0         255.255.0.0     U     0      0        0 bme2
   192.0.2.0       0.0.0.0         255.255.255.0   U     0      0        0 bme1
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 jmgmt0
   192.168.130.0   0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.0
   
   root@jdm:~# cd /var/third-party/CSP/
   root@jdm:/var/third-party/CSP# ls -l
   total 4
   drwxr-xr-x 2 root root 4096 Apr  9 09:16 GWR.sdwansite2.hubspoketenant
   root@jdm:/var/third-party/CSP# cd GWR.sdwansite2.hubspoketenant/
   root@jdm:/var/third-party/CSP/GWR.sdwansite2.hubspoketenant# ls -l
   total 3213992
   -rw-r--r-- 1 root root     364544 Apr  9 09:13 bootstrap_cfg.iso
   -rw-r--r-- 1 root root 3290759168 Apr  9 09:20 media-vsrx-vmdisk-15.1X49-D133.q2
   root@jdm:/var/third-party/CSP/GWR.sdwansite2.hubspoketenant#
   root@jdm:~# virsh list --all
    Id    Name                           State
   ----------------------------------------------------
    2     vjunos0                        running
    3     GWR.sdwansite2.hubspoketenant  running
   
   root@jdm:~# virsh console 3 
   
   Escape character is ^]
   Consoles: serial port
   BIOS drive C: is disk0
   BIOS drive D: is disk1
   BIOS drive E: is disk2
   BIOS drive F: is disk3
   BIOS drive G: is disk4
   BIOS 639kB/999416kB available memory
   
   FreeBSD/i386 bootstrap loader, Revision 1.2
   (builder@mayland.juniper.net, Sat Mar 24 01:33:01  2018)
   Loading /boot/defaults/loader.conf
   /kernel text=0xa7ed88 data=0x6431c+0x121544 syms=[0x4+0xb6b30+0x4+0x10c619]
   /boot/modules/libmbpool.ko text=0xce8 data=0x114 /
   /boot/modules/if_em_vsrx.ko text=0x186dc data=0x840+0x1a4 -
   /boot/modules/virtio.ko text=0x2168 data=0x208 syms=[0x4+0x7f0+0x4+0x972]
   /boot/modules/virtio_pci.ko text=0x2de8 data=0x200+0x8 syms=[0x4+0x900+0x4+0xb2]
   /boot/modules/virtio_blk.ko text=0x299c data=0x1dc+0xc syms=[0x4+0x970+0x4+0xa0]
   /boot/modules/if_vtnet.ko text=0x61bc data=0x344+0x10 syms=[0x4+0xe20+0x4+0xf2f]
   /boot/modules/pci_hgcomm.ko text=0x12fc data=0x1a4+0x44 syms=[0x4+0x570+0x4+0x6]
   /boot/modules/pvi_db.ko text=0x27f8 data=0x314+0x2c syms=[0x4+0x610+0x4+0x5be]
   /boot/modules/chassis.ko text=0x9bc data=0x1d2+0x12 syms=[0x4+0x3a0+0x4+0x399]
   
   
   Hit [Enter] to boot immediately, or space bar for command prompt.
   Booting [/kernel]...
   platform_early_bootinit: Early Boot Initialization
   tvp mode is true  jnx_reboot_reason: 16384
   mac base ff:ff:ff:ff:ff:ff len 255
   GDB: debug ports: sio
   GDB: current port: sio
   KDB: debugger backends: ddb gdb
   KDB: current backend: ddb
   Copyright (c) 1996-2018, Juniper Networks, Inc.
   All rights reserved.
   Copyright (c) 1992-2007 The FreeBSD Project.
   Copyright (c) 1979, 1980, 1983, 1986, 1988, 1989, 1991, 1992, 1993, 1994
           The Regents of the University of California. All rights reserved.
   FreeBSD is a registered trademark of The FreeBSD Foundation.
   JUNOS 15.1X49-D133 #0: 2018-03-24 03:13:46 UTC
       builder@mayland.juniper.net:/volume/build/junos/15.1/service/15.1X49-D133/ol
   Timecounter "i8254" frequency 1193182 Hz quality 0
   CPU: Intel Core Processor (Haswell) (1900.24-MHz 686-class CPU)
     Origin = "GenuineIntel"  Id = 0x306c1  Stepping = 1
     Features=0xf8bfbff<FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,C>
     Features2=0xf7fa3203<SSE3,<b1>,SSSE3,<b12>,CX16,<b17>,SSE4.1,SSE4.2,x2APIC,MO>
     AMD Features=0x20100800<SYSCALL,NX,LM>
     AMD Features2=0x121<LAHF,ABM,Prefetch>
   real memory  = 1024458752 (977 MB)
   avail memory = 986316800 (940 MB)
   ACPI APIC Table: <BOCHS  BXPCAPIC>
   tvp mode is true  jnx_reboot_reason: 16384
   mac base ff:ff:ff:ff:ff:ff len 255
   Security policy loaded: Junos MAC/veriexec (mac_veriexec)
   MAC/veriexec fingerprint module loaded: SHA256
   MAC/veriexec fingerprint module loaded: SHA1
   ioapic0 <Version 1.1> irqs 0-23 on motherboard
   Initializing SRXTVP platform properties ..
   
   pci-hgcomdev module loadedacpi0: <BOCHS BXPCRSDT> on motherboard
   acpi0: Power Button (fixed)
   Timecounter "ACPI-safe" frequency 3579545 Hz quality 1000
   acpi_timer0: <24-bit timer at 3.579545MHz> port 0xb008-0xb00b on acpi0
   pcib0: <ACPI Host-PCI bridge> port 0xcf8-0xcff on acpi0
   pci0: <ACPI PCI bus> on pcib0
   isab0: <PCI-ISA bridge> at device 1.0 on pci0
   isa0: <ISA bus> on isab0
   atapci0: <Intel PIIX3 WDMA2 controller> port 0x1f0-0x1f7,0x3f6,0x170-0x177,0x370
   ata0: <ATA channel 0> on atapci0
   ata1: <ATA channel 1> on atapci0
   uhci0: <Intel 82371SB (PIIX3) USB controller> port 0xc180-0xc19f irq 11 at devi0
   usb0: <Intel 82371SB (PIIX3) USB controller> on uhci0
   usb0: USB revision 1.0
   uhub0: Intel UHCI root hub, class 9/0, rev 1.00/1.00, addr 1
   uhub0: 2 ports with 2 removable, self powered
   smb0: <Intel 82371AB SMB controller> irq 9 at device 1.3 on pci0
   virtio_pci0: <VirtIO PCI Network adapter> port 0xc1a0-0xc1bf mem 0xfebe0000-0xf0
   em0: <VirtIO Networking Adapter> on virtio_pci0
   virtio_pci0: host features: 0x719fffe3 <EventIdx,RingIndirect,NotifyOnEmpty,0x8>
   virtio_pci0: negotiated features: 0x110f8020 <RingIndirect,NotifyOnEmpty,VLanFi>
   virtio_pci1: <VirtIO PCI Network adapter> port 0xc1c0-0xc1df mem 0xfebe1000-0xf0
   em1: <VirtIO Networking Adapter> on virtio_pci1
   virtio_pci1: host features: 0x719fffe3 <EventIdx,RingIndirect,NotifyOnEmpty,0x8>
   virtio_pci1: negotiated features: 0x110f8020 <RingIndirect,NotifyOnEmpty,VLanFi>
   virtio_pci2: <VirtIO PCI Network adapter> port 0xc1e0-0xc1ff mem 0xfebe2000-0xf0
   em2: <VirtIO Networking Adapter> on virtio_pci2
   virtio_pci2: host features: 0x719fffe3 <EventIdx,RingIndirect,NotifyOnEmpty,0x8>
   virtio_pci2: negotiated features: 0x110f8020 <RingIndirect,NotifyOnEmpty,VLanFi>
   virtio_pci3: <VirtIO PCI Block adapter> port 0xc000-0xc03f mem 0xfebe3000-0xfeb0
   vtblk0: <VirtIO Block Adapter> on virtio_pci3
   virtio_pci3: host features: 0x71000cd4 <EventIdx,RingIndirect,NotifyOnEmpty,0x8>
   virtio_pci3: negotiated features: 0x10000054 <RingIndirect,BlockSize,DiskGeomet>
   vtblk0: 509MB (1044288 512 byte sectors)
   virtio_pci4: <VirtIO PCI Block adapter> port 0xc040-0xc07f mem 0xfebe4000-0xfeb0
   vtblk1: <VirtIO Block Adapter> on virtio_pci4
   virtio_pci4: host features: 0x71000cd4 <EventIdx,RingIndirect,NotifyOnEmpty,0x8>
   virtio_pci4: negotiated features: 0x10000054 <RingIndirect,BlockSize,DiskGeomet>
   vtblk1: 3072MB (6291456 512 byte sectors)
   virtio_pci5: <VirtIO PCI Block adapter> port 0xc080-0xc0bf mem 0xfebe5000-0xfeb0
   vtblk2: <VirtIO Block Adapter> on virtio_pci5
   virtio_pci5: host features: 0x71000cd4 <EventIdx,RingIndirect,NotifyOnEmpty,0x8>
   virtio_pci5: negotiated features: 0x10000054 <RingIndirect,BlockSize,DiskGeomet>
   vtblk2: 102MB (209715 512 byte sectors)
   virtio_pci6: <VirtIO PCI Block adapter> port 0xc0c0-0xc0ff mem 0xfebe6000-0xfeb0
   vtblk3: <VirtIO Block Adapter> on virtio_pci6
   virtio_pci6: host features: 0x71000cd4 <EventIdx,RingIndirect,NotifyOnEmpty,0x8>
   virtio_pci6: negotiated features: 0x10000054 <RingIndirect,BlockSize,DiskGeomet>
   vtblk3: 128MB (262144 512 byte sectors)
   virtio_pci7: <VirtIO PCI Block adapter> port 0xc100-0xc13f mem 0xfebe7000-0xfeb0
   vtblk4: <VirtIO Block Adapter> on virtio_pci7
   virtio_pci7: host features: 0x71000cd4 <EventIdx,RingIndirect,NotifyOnEmpty,0x8>
   virtio_pci7: negotiated features: 0x10000054 <RingIndirect,BlockSize,DiskGeomet>
   vtblk4: 614MB (1259059 512 byte sectors)
   em3: <Intel(R) PRO/1000 Network Connection Version - 3.2.18> port 0xc140-0xc17f0
   em3: Memory Access and/or Bus Master bits were not set!
   hgcommdev0: <HGCOMMDEV For Host VM communication> mem 0xfebe8000-0xfebe8fff at 0
   hgcommdev0: hgcommdev: registers at 0xdf889000
   cpu0: <ACPI CPU> on acpi0
   atkbdc0: <Keyboard controller (i8042)> port 0x60,0x64 irq 1 on acpi0
   atkbd0: <AT Keyboard> irq 1 on atkbdc0
   kbd0 at atkbd0
   psm0: <PS/2 Mouse> irq 12 on atkbdc0
   psm0: model IntelliMouse Explorer, device ID 4
   sio0: <16550A-compatible COM port> port 0x3f8-0x3ff irq 4 flags 0x90 on acpi0
   sio0: type 16550A, console
   orm0: <ISA Option ROM> at iomem 0xe5800-0xeffff on isa0
   vga0: <Generic ISA VGA> at port 0x3b0-0x3bb iomem 0xb0000-0xb7fff on isa0
   sc0: <System console> at flags 0x100 on isa0
   sc0: MDA <16 virtual consoles, flags=0x300>
   sio1: configured irq 5 not in bitmap of probed irqs 0
   sio1: port may not be enabled
   sio2: configured irq 3 not in bitmap of probed irqs 0
   sio2: port may not be enabled
   sio3: configured irq 7 not in bitmap of probed irqs 0
   sio3: port may not be enabled
   tvp mode is true  jnx_reboot_reason: 16384
   mac base ff:ff:ff:ff:ff:ff len 255
   TVP: Model Name read from HostOS is vsrx
   Initializing product: 192 ..
   fxp0: bus=0, device=16, func=0, Ethernet address f4:cc:55:2b:58:ce
   fxp0 MAC address f4:cc:55:2b:58:ce
   Timecounter "TSC" frequency 1900243860 Hz quality 800
   Registered AMT tunnel Encap with UDP Tunnel!
    Loading Redundant LT driver
   ###PCB Group initialized for udppcbgroup
   ###PCB Group initialized for tcppcbgroup
   Loading JUNOS chassis module
   chassis_init_hw_chassis_startup_time: chassis startup time 0.000000
   Kernel thread "wkupdaemon" (pid 52) exited prematurely.
   Trying to mount root from ufs:/dev/vtbd0s1a
   Attaching /cf/packages/junos via /dev/mdctl...
   Mounted junos package on /dev/md0...
   
   Automatic reboot in progress...
   ** /dev/vtbd0s1a
   FILE SYSTEM CLEAN; SKIPPING CHECKS
   clean, 71475 free (3 frags, 17868 blocks, 0.0% fragmentation)
   Verified jboot signed by PackageProductionEc_2018 method ECDSA256+SHA256
   Verified junos signed by PackageProductionEc_2018 method ECDSA256+SHA256
   Verified junos-srxjcp-15.1X49-D133-domestic signed by PackageProductionEc_2018 6
   Detected data disk
   Formatting data disk /dev/vtbd1
   /dev/vtbd1s1e: 307.2MB (629080 sectors) block size 16384, fragment size 2048
           using 4 cylinder groups of 76.80MB, 4915 blks, 9856 inodes.
   super-block backups (for fsck -b #) at:
    32, 157312, 314592, 471872
   /dev/vtbd1s1f: 2764.5MB (5661764 sectors) block size 16384, fragment size 2048
           using 16 cylinder groups of 183.69MB, 11756 blks, 23552 inodes.
   super-block backups (for fsck -b #) at:
    32, 376224, 752416, 1128608, 1504800, 1880992, 2257184, 2633376, 3009568,
    3385760, 3761952, 4138144, 4514336, 4890528, 5266720, 5642912
   cp: /config/*: No such file or directory
   sed: /etc/fstab: Read-only file system
   ** /dev/vtbd1s1e
   FILE SYSTEM CLEAN; SKIPPING CHECKS
   clean, 154731 free (27 frags, 19338 blocks, 0.0% fragmentation)
   ** /dev/vtbd1s1f
   FILE SYSTEM CLEAN; SKIPPING CHECKS
   clean, 1391622 free (22 frags, 173950 blocks, 0.0% fragmentation)
   remount /config...success
   remount /var...success
   Initialize /var subdirs...
   Mounting shared partition /var/host ..
   ***Creating /var/host directory
   Detected swap drive
   Enable swap
   *** Creating PVIDb..\n
   1247+0 records in
   1247+0 records out
   648440 bytes transferred in 0.695239 secs (932686 bytes/sec)
   Copied libschema-filter-dd.tlv to /opt/lib/dd/filter\n
   Executing the Junos host files signature script
   Verified manifest signed by PackageDevelopmentEc_2018 method ECDSA256+SHA256
   hw.re.gres_sync_other: 0 -> 1
   hw.re.gres_sync_other: 1 -> 0
   Found junos config on shared disk. Override the existing one!
   vmguest: setup ...
   vmguest: Found smbios variables, skipping reboot.
   Loading configuration ...
   /config/juniper.conf:255:(43) invalid interface type: .0 at '.0'
     [edit security nat source rule-set mgmt-traffic-nat to interface]
       'to interface [ ge-0/0/2.0 ge-0/0/3.0 .0 .0 ];'
         invalid interface type: .0
   /config/juniper.conf:255:(48) invalid value at ']'
     [edit security nat source rule-set mgmt-traffic-nat to interface]
       'to interface [ ge-0/0/2.0 ge-0/0/3.0 .0 .0 ];'
         invalid value
   warning: statement must contain additional statements
   /config/juniper.conf:270:(43) invalid interface type: .0 at '.0'
     [edit security nat source rule-set own-mgmt-traffic-nat to interface]
       'to interface [ ge-0/0/2.0 ge-0/0/3.0 .0 .0 ];'
         invalid interface type: .0
   /config/juniper.conf:270:(48) invalid value at ']'
     [edit security nat source rule-set own-mgmt-traffic-nat to interface]
       'to interface [ ge-0/0/2.0 ge-0/0/3.0 .0 .0 ];'
         invalid value
   warning: statement must contain additional statements
   mgd: Running FIPS Self-tests
   veriexec: no fingerprint for file='/sbin/kats/cannot-exec' fsid=81 fileid=246593
   mgd: FIPS Self-tests Passed
   Generating RSA key /etc/ssh/ssh_host_key
   Generating public/private rsa1 key pair.
   Your identification has been saved in /etc/ssh/ssh_host_key.
   Your public key has been saved in /etc/ssh/ssh_host_key.pub.
   The key fingerprint is:
   SHA256:+Reg1aUpUR6m5DuGsP5ny4EMarZhJI+RHbAjPauSd3o root@GWR.sdwansite2.hubspoket
   The key's randomart image is:
   +---[RSA1 2048]---+
   |  .       o.+ .  |
   | . o     o * =   |
   |. = . .   * =    |
   | . * . o = +     |
   |  = o o S + .    |
   | o * o o + . .   |
   |+ o O . o o .    |
   |.. *Eo . .oo     |
   |  ...   .oo.     |
   +----[SHA256]-----+
   Generating DSA key /etc/ssh/ssh_host_dsa_key
   Generating public/private dsa key pair.
   Your identification has been saved in /etc/ssh/ssh_host_dsa_key.
   Your public key has been saved in /etc/ssh/ssh_host_dsa_key.pub.
   The key fingerprint is:
   SHA256:dNmjHNeNDKA58e49HnHJn04OBYrasczav2eU6rZlGsk root@GWR.sdwansite2.hubspoket
   The key's randomart image is:
   +---[DSA 1024]----+
   |        . ...    |
   |         = o + o |
   |        = = +.+ .|
   |       . =.+.o.. |
   |        So+.. =. |
   |        =.+..=...|
   |       . =.E*+ o.|
   |        o  +===  |
   |       . .+**  o |
   +----[SHA256]-----+
   Generating RSA2 key /etc/ssh/ssh_host_rsa_key
   Generating public/private rsa key pair.
   Your identification has been saved in /etc/ssh/ssh_host_rsa_key.
   Your public key has been saved in /etc/ssh/ssh_host_rsa_key.pub.
   The key fingerprint is:
   SHA256:xqDcqBJqgXfnu9oOVgIhnueZelVbIro2uDcnZKTEPKw root@GWR.sdwansite2.hubspoket
   The key's randomart image is:
   +---[RSA 2048]----+
   |. .              |
   |....             |
   |+o.. ..o .       |
   |.*o+++oo+        |
   |=.==*.+.S        |
   |E++=o= .         |
   |o++=o .          |
   |..+=.+ .         |
   | .. =o=.         |
   +----[SHA256]-----+
   Generating ECDSA key /etc/ssh/ssh_host_ecdsa_key
   Generating public/private ecdsa key pair.
   Your identification has been saved in /etc/ssh/ssh_host_ecdsa_key.
   Your public key has been saved in /etc/ssh/ssh_host_ecdsa_key.pub.
   The key fingerprint is:
   SHA256:1J5XjDk+G9kfSRFJqMAJ6dCqrFxNH5lsisxIAvvKTcU root@GWR.sdwansite2.hubspoket
   The key's randomart image is:
   +---[ECDSA 256]---+
   |      ..+ .   o+o|
   |.    . o =   = ..|
   |..  . = + o = o. |
   |o.   E O . + =. .|
   |o.= * + S o * .o |
   | ..O o .   . + ..|
   |o.=         .   .|
   |.+ .             |
   |                 |
   +----[SHA256]-----+
   Generating ED25519 key /etc/ssh/ssh_host_ed25519_key
   Generating public/private ed25519 key pair.
   Your identification has been saved in /etc/ssh/ssh_host_ed25519_key.
   Your public key has been saved in /etc/ssh/ssh_host_ed25519_key.pub.
   The key fingerprint is:
   SHA256:pwb2VAsSF7gtAeAw1qT1seUqEQQTPKEzUNplvAFUjJE root@GWR.sdwansite2.hubspoket
   The key's randomart image is:
   +--[ED25519 256]--+
   |=O&#=o.oo.       |
   |+OE+* Bo         |
   |=.+. =.=. .      |
   | o  o +..o .     |
   |   . .o.S o      |
   |    .. + o       |
   |        +        |
   |       .         |
   |                 |
   +----[SHA256]-----+
   mgd: commit complete
   Setting initial options: .
   Starting optional daemons:  usbd.
   Doing initial network setup:.
   Initial interface configuration:
   vmtype is 0
   additional daemons: eventd.
   checking for core dump...
   savecore: Reboot reason(s): 0x4000: VJUNOS reboot
   savecore: Reboot reason(s): 0x4000: VJUNOS reboot
   savecore: no dumps found
   Additional routing options:kern.module_path: /boot//kernel;/boot/modules -> /bo;
   kld netpfe drv: ifpfed_ep ifpfed_esp ifpfed_ism ifpfed_ml_ha ifpfed_ppeer ifpfe1
    ipsec kldcryptosoft0: <software crypto> on motherboard
    kats kldIPsec: Initialized Security Association Processing.
    resrsv.
   Doing additional network setup:.
   Starting final network daemons:.
   setting ldconfig path: /usr/lib /opt/lib
   starting standard daemons: cron.
   Initial rc.i386 initialization:.
   Local package initialization:.
   starting local daemons:set cores for group access
   .
   kern.securelevel: -1 -> 1
   kern.timecounter.hardware: ACPI-safe -> TSC
   kern.maxfiles: 1500 -> 10500
   kern.maxfilesperproc: 1500 -> 10500
   Configuring from config-drive ...
   mount_msdosfs: /dev/vtbd2: Invalid argument
   sed: /config/config_mnt/openstack/latest/meta_data.json: No such file or directy
   umount: /config/config_mnt: not a file system root directory
   The machine id is empty.
   Cleaning up ...
   Mon Apr  9 09:25:49 UTC 2018
   Apr  9 09:25:51 init: exec_command: /usr/sbin/httpd-gk (PID 1684) started
   
   GWR.sdwansite2.hubspoketenant (ttyd0)
   
   login: root
   Password:
   
   --- JUNOS 15.1X49-D133 built 2018-03-24 03:13:46 UTC
   root@GWR% cli
   root@GWR.sdwansite2.hubspoketenant> show bgp neighbor
   BGP is not running
   
   root@GWR.sdwansite2.hubspoketenant> show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   ge-0/0/0                up    up
   gr-0/0/0                up    up
   ip-0/0/0                up    up
   lsq-0/0/0               up    up
   lt-0/0/0                up    up
   mt-0/0/0                up    up
   sp-0/0/0                up    up
   sp-0/0/0.0              up    up   inet
                                      inet6
   sp-0/0/0.16383          up    up   inet
   ge-0/0/1                up    up
   ge-0/0/1.0              up    up   inet     10.10.10.3/24
   ge-0/0/2                up    up
   ge-0/0/2.0              up    up   inet     192.168.130.101/24
   ge-0/0/3                up    up
   ge-0/0/3.0              up    up   inet     192.168.133.102/24
   ge-0/0/4                up    up
   ge-0/0/4.0              up    up   inet     10.10.0.2/24
   ge-0/0/4.32767          up    up
   ge-0/0/5                up    up
   ge-0/0/5.0              up    up   inet     10.10.12.2/24
   ge-0/0/6                up    up
   ge-0/0/6.0              up    up   inet     10.10.13.2/24
   ge-0/0/6.32767          up    up
   ge-0/0/7                up    up
   ge-0/0/8                up    up
   dsc                     up    up
   em0                     up    up
   em0.0                   up    up   inet     128.0.0.1/2
   em1                     up    up
   em1.32768               up    up   inet     192.168.1.2/24
   em2                     up    up
   fxp0                    up    up
   fxp0.0                  up    up   inet     192.0.2.100/24
   gre                     up    up
   ipip                    up    up
   irb                     up    up
   lo0                     up    up
   lo0.0                   up    up   inet     192.168.0.1/24
   lo0.16384               up    up   inet     127.0.0.1           --> 0/0
   lo0.16385               up    up   inet     10.0.0.1            --> 0/0
                                               10.0.0.16           --> 0/0
                                               128.0.0.1           --> 0/0
                                               128.0.0.4           --> 0/0
                                               128.0.1.16          --> 0/0
   lo0.32768               up    up
   lsi                     up    up
   mtun                    up    up
   pimd                    up    up
   pime                    up    up
   pp0                     up    up
   ppd0                    up    up
   ppe0                    up    up
   st0                     up    up
   tap                     up    up
   vlan                    up    down
   vtep                    up    up
   
   #
   # AFTER ALL is up and running
   #
   root@GWR.sdwansite2.hubspoketenant> show bgp neighbor
   Peer: 192.168.10.49+54728 AS 64512 Local: 192.168.210.4+179 AS 64512
     Type: Internal    State: Established    Flags: <Sync>
     Last State: OpenConfirm   Last Event: RecvKeepAlive
     Last Error: Open Message Error
     Export: [ static-export ] Import: [ next-hop-change ]
     Options: <Preference LocalAddress HoldTime AddressFamily Rib-group Refresh>
     Options: <VpnApplyExport LLGR>
     Address families configured: inet-vpn-unicast
     Local Address: 192.168.210.4 Holdtime: 200 Preference: 170
     NLRI inet-vpn-unicast:
     Number of flaps: 0
     Error: 'Open Message Error' Sent: 1 Recv: 0
     Peer ID: 192.168.10.49   Local ID: 192.168.210.4     Active Holdtime: 200
     Keepalive Interval: 66         Group index: 1    Peer index: 0
     BFD: disabled, down
     NLRI for restart configured on peer: inet-vpn-unicast
     NLRI advertised by peer: inet-vpn-unicast
     NLRI for this session: inet-vpn-unicast
     Peer supports Refresh capability (2)
     Stale routes from peer are kept for: 300
     Restart time requested by this peer: 0
     Restart flag received from the peer: Notification
     NLRI that peer supports restart for: inet-vpn-unicast
     NLRI peer can save forwarding state: inet-vpn-unicast
     NLRI that peer saved forwarding for: inet-vpn-unicast
     NLRI that restart is negotiated for: inet-vpn-unicast
     NLRI of received end-of-rib markers: inet-vpn-unicast
     NLRI of all end-of-rib markers sent: inet-vpn-unicast
     NLRI and times for LLGR configured for peer: inet-vpn-unicast 27w5d 04:20:15
     NLRI and times that peer supports LLGR Restarter for: inet-vpn-unicast 27w5d 04:20:15
     NLRI that peer saved LLGR forwarding for: inet-vpn-unicast
     Peer supports 4 byte AS extension (peer-as 64512)
     Peer does not support Addpath
     Table bgp.l3vpn.0
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: not advertising
       Active prefixes:              15
       Received prefixes:            19
       Accepted prefixes:            19
       Suppressed due to damping:    0
     Table transit.inet.0 Bit: 30000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          13
     Table LAN-hubspoketenant_DefaultVPN.inet.0 Bit: 60000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              2
       Received prefixes:            3
       Accepted prefixes:            3
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table Default-hubspoketenant_DefaultVPN.inet.0 Bit: 70000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            2
       Accepted prefixes:            2
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table Default-reverse-hubspoketenant_DefaultVPN.inet.0 Bit: 80000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            2
       Accepted prefixes:            2
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table mpls-hubspoketenant_DefaultVPN.inet.0 Bit: 90000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            2
       Accepted prefixes:            2
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table internet-hubspoketenant_DefaultVPN.inet.0 Bit: a0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            2
       Accepted prefixes:            2
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC1-hubspoketenant_DefaultVPN.inet.0 Bit: b0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC2-hubspoketenant_DefaultVPN.inet.0 Bit: c0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC3-hubspoketenant_DefaultVPN.inet.0 Bit: d0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC4-hubspoketenant_DefaultVPN.inet.0 Bit: e0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC5-hubspoketenant_DefaultVPN.inet.0 Bit: f0000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC6-hubspoketenant_DefaultVPN.inet.0 Bit: 100000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC7-hubspoketenant_DefaultVPN.inet.0 Bit: 110000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC8-hubspoketenant_DefaultVPN.inet.0 Bit: 120000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC9-hubspoketenant_DefaultVPN.inet.0 Bit: 130000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Table TC10-hubspoketenant_DefaultVPN.inet.0 Bit: 140000
       RIB State: BGP restart is complete
       RIB State: VPN restart is complete
       Send state: in sync
       Active prefixes:              0
       Received prefixes:            0
       Accepted prefixes:            0
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Last traffic (seconds): Received 56   Sent 56   Checked 94
     Input messages:  Total 136    Updates 104     Refreshes 0     Octets 12103
     Output messages: Total 71     Updates 35      Refreshes 2     Octets 4415
     Output Queue[2]: 0            (transit.inet.0, inet-vpn-unicast)
     Output Queue[5]: 0            (LAN-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[6]: 0            (Default-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[7]: 0            (Default-reverse-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[8]: 0            (mpls-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[9]: 0            (internet-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[10]: 0           (TC1-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[11]: 0           (TC2-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[12]: 0           (TC3-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[13]: 0           (TC4-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[14]: 0           (TC5-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[15]: 0           (TC6-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[16]: 0           (TC7-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[17]: 0           (TC8-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[18]: 0           (TC9-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
     Output Queue[19]: 0           (TC10-hubspoketenant_DefaultVPN.inet.0, inet-vpn-unicast)
   
   Peer: 192.168.210.1+179 AS 64512 Local: 192.168.210.4+49462 AS 64512
     Type: Internal    State: Established    Flags: <Sync>
     Last State: OpenConfirm   Last Event: RecvKeepAlive
     Last Error: None
     Export: [ oam-route-export-prim ] Import: [ prim-lp-import ]
     Options: <Preference LocalAddress AddressFamily Refresh>
     Address families configured: inet-unicast
     Local Address: 192.168.210.4 Holdtime: 90 Preference: 170
     Number of flaps: 0
     Peer ID: 192.168.210.1   Local ID: 192.168.210.4     Active Holdtime: 90
     Keepalive Interval: 30         Group index: 0    Peer index: 0
     BFD: disabled, down
     NLRI for restart configured on peer: inet-unicast
     NLRI advertised by peer: inet-unicast
     NLRI for this session: inet-unicast
     Peer supports Refresh capability (2)
     Stale routes from peer are kept for: 300
     Peer does not support Restarter functionality
     Restart flag received from the peer: Notification
     NLRI that restart is negotiated for: inet-unicast
     NLRI of received end-of-rib markers: inet-unicast
     NLRI of all end-of-rib markers sent: inet-unicast
     Peer does not support LLGR Restarter functionality
     Peer supports 4 byte AS extension (peer-as 64512)
     Peer does not support Addpath
     Table inet.0 Bit: 10000
       RIB State: BGP restart is complete
       Send state: in sync
       Active prefixes:              1
       Received prefixes:            1
       Accepted prefixes:            1
       Suppressed due to damping:    0
       Advertised prefixes:          1
     Last traffic (seconds): Received 21   Sent 7    Checked 42
     Input messages:  Total 87     Updates 2       Refreshes 0     Octets 1692
     Output messages: Total 90     Updates 1       Refreshes 0     Octets 1818
     Output Queue[0]: 0            (inet.0, inet-unicast)
   
   root@GWR.sdwansite2.hubspoketenant> show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   ge-0/0/0                up    up
   gr-0/0/0                up    up
   gr-0/0/0.4000           up    up   inet     172.26.55.32/31
                                      mpls
   gr-0/0/0.4002           up    up   inet     172.18.123.238/31
                                      mpls
   ip-0/0/0                up    up
   lsq-0/0/0               up    up
   lt-0/0/0                up    up
   mt-0/0/0                up    up
   sp-0/0/0                up    up
   sp-0/0/0.0              up    up   inet
                                      inet6
   sp-0/0/0.16383          up    up   inet
   ge-0/0/1                up    up
   ge-0/0/1.0              up    up   inet     10.10.10.3/24
   ge-0/0/2                up    up
   ge-0/0/2.0              up    up   inet     192.168.130.2/24
   ge-0/0/3                up    up
   ge-0/0/3.0              up    up   inet     192.168.133.2/24
   ge-0/0/4                up    up
   ge-0/0/4.0              up    up   inet     10.10.0.2/24
   ge-0/0/4.1066           up    up   inet     10.66.66.1/24
   ge-0/0/4.32767          up    up
   ge-0/0/5                up    up
   ge-0/0/5.0              up    up   inet     10.10.12.2/24
   ge-0/0/6                up    up
   ge-0/0/6.0              up    up   inet     10.10.13.2/24
   ge-0/0/7                up    up
   ge-0/0/8                up    up
   dsc                     up    up
   em0                     up    up
   em0.0                   up    up   inet     128.0.0.1/2
   em1                     up    up
   em1.32768               up    up   inet     192.168.1.2/24
   em2                     up    up
   fxp0                    up    up
   fxp0.0                  up    up   inet     192.0.2.100/24
   gre                     up    up
   ipip                    up    up
   irb                     up    up
   lo0                     up    up
   lo0.0                   up    up   inet     192.168.210.4       --> 0/0
   lo0.16384               up    up   inet     127.0.0.1           --> 0/0
   lo0.16385               up    up   inet     10.0.0.1            --> 0/0
                                               10.0.0.16           --> 0/0
                                               128.0.0.1           --> 0/0
                                               128.0.0.4           --> 0/0
                                               128.0.1.16          --> 0/0
   lo0.32768               up    up
   lsi                     up    up
   lsi.0                   up    up   inet
                                      iso
                                      inet6
   lsi.1                   up    up   inet
                                      iso
                                      inet6
   lsi.2                   up    up   inet
                                      iso
                                      inet6
   lsi.3                   up    up   inet
                                      iso
                                      inet6
   lsi.4                   up    up   inet
                                      iso
                                      inet6
   lsi.5                   up    up   inet
                                      iso
                                      inet6
   lsi.6                   up    up   inet
                                      iso
                                      inet6
   lsi.7                   up    up   inet
                                      iso
                                      inet6
   lsi.8                   up    up   inet
                                      iso
                                      inet6
   lsi.9                   up    up   inet
                                      iso
                                      inet6
   lsi.10                  up    up   inet
                                      iso
                                      inet6
   lsi.11                  up    up   inet
                                      iso
                                      inet6
   lsi.12                  up    up   inet
                                      iso
                                      inet6
   lsi.13                  up    up   inet
                                      iso
                                      inet6
   lsi.14                  up    up   inet
                                      iso
                                      inet6
   mtun                    up    up
   pimd                    up    up
   pime                    up    up
   pp0                     up    up
   ppd0                    up    up
   ppe0                    up    up
   st0                     up    up
   st0.4000                up    up   inet     172.29.4.154/31
   st0.4001                up    up   inet     172.23.122.150/31
   st0.4002                up    up   inet     172.17.98.50/31
   st0.4003                up    up   inet     172.16.34.104/31
   tap                     up    up
   vlan                    up    down
   vtep                    up    up 
   
   root@GWR.sdwansite2.hubspoketenant> show route
   
   inet.0: 26 destinations, 26 routes (26 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:41:01
                       > to 192.168.133.1 via ge-0/0/3.0
   10.10.0.0/24       *[Direct/0] 00:41:01
                       > via ge-0/0/4.0
   10.10.0.2/32       *[Local/0] 00:41:02
                         Local via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:41:01
                       > via ge-0/0/1.0
   10.10.10.3/32      *[Local/0] 00:41:02
                         Local via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:41:01
                       > via ge-0/0/5.0
   10.10.12.2/32      *[Local/0] 00:41:02
                         Local via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:41:01
                       > via ge-0/0/6.0
   10.10.13.2/32      *[Local/0] 00:41:02
                         Local via ge-0/0/6.0
   172.23.122.150/31  *[Direct/0] 00:40:52
                       > via st0.4001
   172.23.122.150/32  *[Local/0] 00:41:11
                         Local via st0.4001
   172.29.4.154/31    *[Direct/0] 00:40:14
                       > via st0.4000
   172.29.4.154/32    *[Local/0] 00:41:11
                         Local via st0.4000
   192.0.2.0/24       *[Direct/0] 00:40:06
                       > via fxp0.0
   192.0.2.100/32     *[Local/0] 00:40:06
                         Local via fxp0.0
   192.168.10.0/24    *[BGP/170] 00:40:44, localpref 200, from 192.168.210.1
                         AS path: 65000 I, validation-state: unverified
                       > via st0.4000
                         via st0.4001
   192.168.130.0/24   *[Direct/0] 00:40:18
                       > via ge-0/0/2.0
   192.168.130.2/32   *[Local/0] 00:41:02
                         Local via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:41:01
                       > via ge-0/0/3.0
   192.168.133.2/32   *[Local/0] 00:41:02
                         Local via ge-0/0/3.0
   192.168.190.0/24   *[Static/5] 00:29:44
                       > to 192.168.130.1 via ge-0/0/2.0
   192.168.190.254/32 *[Static/5] 00:40:18
                       > to 192.168.130.1 via ge-0/0/2.0
   192.168.191.0/24   *[Static/5] 00:29:44
                       > to 192.168.133.1 via ge-0/0/3.0
   192.168.191.254/32 *[Static/5] 00:41:01
                       > to 192.168.133.1 via ge-0/0/3.0
   192.168.210.1/32   *[Static/5] 00:40:52
                         via st0.4000
                       > via st0.4001
   192.168.210.4/32   *[Direct/0] 00:41:20
                       > via lo0.0
   
   inet.3: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   172.18.123.239/32  *[Static/5] 00:27:37
                       > via gr-0/0/0.4002
   172.26.55.33/32    *[Static/5] 00:27:37
                       > via gr-0/0/0.4000
   192.168.0.1/32     *[Static/5] 00:27:37, metric2 0
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   192.168.56.46/32   *[Static/5] 00:27:37
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   192.168.84.238/32  *[Static/5] 00:27:37
                       > via gr-0/0/0.4000
   192.168.142.248/32 *[Static/5] 00:27:37
                       > via gr-0/0/0.4002
   192.168.210.1/32   *[Static/12] 00:27:37
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   
   transit.inet.0: 18 destinations, 18 routes (18 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.10.0.0/24       *[Direct/0] 00:33:47
                       > via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/6.0
   10.88.88.0/24      *[BGP/170] 00:27:37, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 18
                       > via gr-0/0/0.4002, Push 18
   172.16.34.104/31   *[Direct/0] 00:27:37
                       > via st0.4003
   172.16.34.104/32   *[Local/0] 00:29:43
                         Local via st0.4003
   172.17.98.50/31    *[Direct/0] 00:27:37
                       > via st0.4002
   172.17.98.50/32    *[Local/0] 00:29:43
                         Local via st0.4002
   172.18.123.238/31  *[Direct/0] 00:27:37
                       > via gr-0/0/0.4002
   172.18.123.238/32  *[Local/0] 00:29:43
                         Local via gr-0/0/0.4002
   172.23.122.150/31  *[Direct/0] 00:33:47
                       > via st0.4001
   172.26.55.32/31    *[Direct/0] 00:27:37
                       > via gr-0/0/0.4000
   172.26.55.32/32    *[Local/0] 00:29:43
                         Local via gr-0/0/0.4000
   172.29.4.154/31    *[Direct/0] 00:33:47
                       > via st0.4000
   192.168.130.0/24   *[Direct/0] 00:33:47
                       > via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:33:47
                       > via ge-0/0/3.0
   192.168.210.4/32   *[Direct/0] 00:33:47
                       > via lo0.0
   
   transit.inet.3: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   172.18.123.239/32  *[Static/5] 00:27:37
                       > via gr-0/0/0.4002
   172.26.55.33/32    *[Static/5] 00:27:37
                       > via gr-0/0/0.4000
   192.168.0.1/32     *[Static/5] 00:29:44, metric2 0
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   192.168.56.46/32   *[Static/5] 00:27:37
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   192.168.84.238/32  *[Static/5] 00:27:37
                       > via gr-0/0/0.4000
   192.168.142.248/32 *[Static/5] 00:27:37
                       > via gr-0/0/0.4002
   192.168.210.1/32   *[Static/12] 00:27:37
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4002
   
   default-local-breakout.inet.0: 10 destinations, 10 routes (10 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.10.0.0/24       *[Direct/0] 00:33:47
                       > via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/6.0
   10.66.66.0/24      *[Direct/0] 00:29:43
                       > via ge-0/0/4.1066
   172.23.122.150/31  *[Direct/0] 00:33:47
                       > via st0.4001
   172.29.4.154/31    *[Direct/0] 00:33:47
                       > via st0.4000
   192.168.130.0/24   *[Direct/0] 00:33:47
                       > via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:33:47
                       > via ge-0/0/3.0
   192.168.210.4/32   *[Direct/0] 00:33:47
                       > via lo0.0
   
   mpls-local-breakout.inet.0: 10 destinations, 10 routes (10 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.10.0.0/24       *[Direct/0] 00:33:47
                       > via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/6.0
   10.66.66.0/24      *[Direct/0] 00:29:43
                       > via ge-0/0/4.1066
   172.23.122.150/31  *[Direct/0] 00:33:47
                       > via st0.4001
   172.29.4.154/31    *[Direct/0] 00:33:47
                       > via st0.4000
   192.168.130.0/24   *[Direct/0] 00:33:47
                       > via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:33:47
                       > via ge-0/0/3.0
   192.168.210.4/32   *[Direct/0] 00:33:47
                       > via lo0.0
   
   internet-local-breakout.inet.0: 10 destinations, 10 routes (10 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.10.0.0/24       *[Direct/0] 00:33:47
                       > via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:33:47
                       > via ge-0/0/6.0
   10.66.66.0/24      *[Direct/0] 00:29:43
                       > via ge-0/0/4.1066
   172.23.122.150/31  *[Direct/0] 00:33:47
                       > via st0.4001
   172.29.4.154/31    *[Direct/0] 00:33:47
                       > via st0.4000
   192.168.130.0/24   *[Direct/0] 00:33:47
                       > via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:33:47
                       > via ge-0/0/3.0
   192.168.210.4/32   *[Direct/0] 00:33:47
                       > via lo0.0
   
   LAN-hubspoketenant_DefaultVPN.inet.0: 4 destinations, 5 routes (4 active, 0 holddown, 1 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:27:37, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4002, Push 16
   10.66.66.0/24      *[Direct/0] 00:29:43
                       > via ge-0/0/4.1066
   10.66.66.1/32      *[Local/0] 00:29:43
                         Local via ge-0/0/4.1066
   10.88.88.0/24      *[BGP/170] 00:27:37, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 18
                       > via gr-0/0/0.4002, Push 18
   
   natVR-hubspoketenant_DefaultVPN.inet.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   Default-hubspoketenant_DefaultVPN.inet.0: 3 destinations, 3 routes (2 active, 0 holddown, 1 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:27:37, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4002, Push 16
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   Default-reverse-hubspoketenant_DefaultVPN.inet.0: 3 destinations, 3 routes (2 active, 0 holddown, 1 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:27:37, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 18
                         via gr-0/0/0.4002, Push 18
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   mpls-hubspoketenant_DefaultVPN.inet.0: 3 destinations, 4 routes (2 active, 0 holddown, 1 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:27:37, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 41
                       [Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   internet-hubspoketenant_DefaultVPN.inet.0: 3 destinations, 4 routes (2 active, 0 holddown, 1 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:27:37, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 39
                       [Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC1-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC2-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC3-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC4-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC5-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC6-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC7-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC8-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC9-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   TC10-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0
   
   mpls.0: 24 destinations, 24 routes (24 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   16                 *[VPN/0] 00:29:44
                         to table Default-hubspoketenant_DefaultVPN.inet.0, Pop
   17                 *[VPN/0] 00:29:44
                         to table Default-reverse-hubspoketenant_DefaultVPN.inet.0, Pop
   18                 *[VPN/0] 00:29:44
                         to table LAN-hubspoketenant_DefaultVPN.inet.0, Pop
   19                 *[VPN/0] 00:29:44
                         to table TC1-hubspoketenant_DefaultVPN.inet.0, Pop
   20                 *[VPN/0] 00:29:44
                         to table TC10-hubspoketenant_DefaultVPN.inet.0, Pop
   21                 *[VPN/0] 00:29:44
                         to table TC2-hubspoketenant_DefaultVPN.inet.0, Pop
   22                 *[VPN/0] 00:29:44
                         to table TC3-hubspoketenant_DefaultVPN.inet.0, Pop
   23                 *[VPN/0] 00:29:44
                         to table TC4-hubspoketenant_DefaultVPN.inet.0, Pop
   24                 *[VPN/0] 00:29:44
                         to table TC5-hubspoketenant_DefaultVPN.inet.0, Pop
   25                 *[VPN/0] 00:29:44
                         to table TC6-hubspoketenant_DefaultVPN.inet.0, Pop
   26                 *[VPN/0] 00:29:44
                         to table TC7-hubspoketenant_DefaultVPN.inet.0, Pop
   27                 *[VPN/0] 00:29:44
                         to table TC8-hubspoketenant_DefaultVPN.inet.0, Pop
   28                 *[VPN/0] 00:29:44
                         to table TC9-hubspoketenant_DefaultVPN.inet.0, Pop
   29                 *[VPN/0] 00:29:44
                         to table internet-hubspoketenant_DefaultVPN.inet.0, Pop
   30                 *[VPN/0] 00:29:44
                         to table mpls-hubspoketenant_DefaultVPN.inet.0, Pop
   299776             *[VPN/170] 00:33:22
                       > via st0.4001, Pop
   299792             *[VPN/170] 00:33:22
                       > via st0.4000, Pop
   299808             *[VPN/170] 00:33:22
                         receive table transit.inet.0, Pop
   299888             *[VPN/170] 00:27:37
                       > via st0.4003, Pop
   299904             *[VPN/170] 00:27:37
                       > via gr-0/0/0.4002, Pop
   299904(S=0)        *[VPN/170] 00:27:37
                       > via gr-0/0/0.4002, Pop
   299920             *[VPN/170] 00:27:37
                       > via st0.4002, Pop
   299936             *[VPN/170] 00:27:37
                       > via gr-0/0/0.4000, Pop
   299936(S=0)        *[VPN/170] 00:27:37
                       > via gr-0/0/0.4000, Pop
   
   transit.mpls.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0                  *[MPLS/0] 00:29:44, metric 1
                         Receive
   1                  *[MPLS/0] 00:29:44, metric 1
                         Receive
   2                  *[MPLS/0] 00:29:44, metric 1
                         Receive
   13                 *[MPLS/0] 00:29:44, metric 1
                         Receive
   
   bgp.l3vpn.0: 19 destinations, 19 routes (15 active, 0 holddown, 4 hidden)
   + = Active Route, - = Last Active, * = Both
   
   239.0.62.46:24:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4002, Push 16
   239.0.62.46:26:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 19
                         via gr-0/0/0.4002, Push 19
   239.0.62.46:27:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 23
                         via gr-0/0/0.4002, Push 23
   239.0.62.46:28:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 25
                         via gr-0/0/0.4002, Push 25
   239.0.62.46:29:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 27
                         via gr-0/0/0.4002, Push 27
   239.0.62.46:30:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 29
                         via gr-0/0/0.4002, Push 29
   239.0.62.46:31:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 31
                         via gr-0/0/0.4002, Push 31
   239.0.62.46:32:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 33
                       > via gr-0/0/0.4002, Push 33
   239.0.62.46:33:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 35
                       > via gr-0/0/0.4002, Push 35
   239.0.62.46:34:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 37
                       > via gr-0/0/0.4002, Push 37
   239.0.62.46:35:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 21
                       > via gr-0/0/0.4002, Push 21
   239.0.62.46:36:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 41
   239.0.62.46:37:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 39
   192.168.210.1:25:0.0.0.0/0
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 18
                         via gr-0/0/0.4002, Push 18
   192.168.210.3:25:10.88.88.0/24
                      *[BGP/170] 00:29:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 18
                       > via gr-0/0/0.4002, Push 18
   
   root@GWR.sdwansite2.hubspoketenant> show configuration
   ## Last commit: 2018-08-22 16:06:36 CEST by csp
   version 15.1X49-D144.1;
   groups {
       global {
           security {
               policies {
                   default-policy {
                       deny-all;
                   }
               }
               zones {
                   security-zone HOST {
                       host-inbound-traffic {
                           system-services {
                               any-service;
                           }
                           protocols {
                               all;
                           }
                       }
                   }
               }
           }
       }
       nfx-gwr-site-routing-config-192.168.210.4 {
           security {
               zones {
                   security-zone trust {
                       enable-reverse-reroute;
                   }
               }
           }
           routing-options {
               interface-routes {
                   rib-group inet local-breakout-rib;
               }
               rib-groups {
                   transit-inet3-to-inet3 {
                       import-rib [ transit.inet.3 inet.3 ];
                   }
                   local-breakout-rib {
                       import-rib [ inet.0 transit.inet.0 default-local-breakout.inet.0 mpls-local-breakout.inet.0 internet-local-breakout.inet.0 ];
                       import-policy direct-routes;
                   }
               }
               router-id 192.168.210.4;
               autonomous-system 64512;
               forwarding-table {
                   export pplb;
               }
           }
           protocols {
               bgp {
                   group ibgp {
                       type internal;
                       local-address 192.168.210.4;
                       hold-time 200;
                       family inet-vpn {
                           unicast {
                               graceful-restart {
                                   long-lived {
                                       restarter {
                                           stale-time 16777215;
                                       }
                                   }
                               }
                           }
                       }
                       neighbor 192.168.10.49;
                   }
               }
           }
           policy-options {
               policy-statement pplb {
                   then {
                       load-balance per-packet;
                   }
               }
               policy-statement direct-routes {
                   term 1 {
                       from protocol direct;
                       then accept;
                   }
                   term 2 {
                       then reject;
                   }
               }
           }
           routing-instances {
               transit {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:64512;
                   vrf-target target:192.168.210.4:64512;
                   routing-options {
                       rib transit.inet.3 {
                           static {
                               rib-group transit-inet3-to-inet3;
                           }
                       }
                   }
               }
               default-local-breakout {
                   instance-type forwarding;
               }
               mpls-local-breakout {
                   instance-type forwarding;
               }
               internet-local-breakout {
                   instance-type forwarding;
               }
           }
       }
       dept-configuration {
           security {
               zones {
                   security-zone Default {
                       host-inbound-traffic {
                           system-services {
                               all;
                           }
                           protocols {
                               all;
                           }
                       }
                       interfaces {
                           ge-0/0/4.1066;
                       }
                   }
               }
           }
           interfaces {
               ge-0/0/4 {
                   vlan-tagging;
                   unit 1066 {
                       vlan-id 1066;
                       family inet {
                           filter {
                               input appqoe_filter;
                           }
                           address 10.66.66.1/24;
                       }
                   }
               }
           }
           firewall {
               family inet {
                   filter appqoe_filter {
                       term aq_term1 {
                           from {
                               destination-port 36000;
                           }
                           then {
                               count aq_counter1;
                               discard;
                           }
                       }
                       term default {
                           then accept;
                       }
                   }
               }
           }
           routing-instances {
               LAN-hubspoketenant_DefaultVPN {
                   interface ge-0/0/4.1066;
               }
           }
       }
       hubspoketenant_SDWANSITE2_WAN_0_HUB1_WAN_0_IPSEC_0 {
           security {
               ipsec {
                   proposal DEFAULT_IPSEC_PROPOSAL {
                       protocol esp;
                       encryption-algorithm aes-256-gcm;
                   }
                   policy 09d7d4e25c36be0a1bd846a9b9dc7e81 {
                       perfect-forward-secrecy {
                           keys group14;
                       }
                       proposals DEFAULT_IPSEC_PROPOSAL;
                   }
                   vpn 43c06c54720fb17763f227cd6a5bfd6a {
                       bind-interface st0.4002;
                       ike {
                           gateway 5ed970ab60572e7f500fbaf90cc6c074;
                           proxy-identity {
                               local 172.17.98.50/31;
                               remote 172.17.98.51/31;
                           }
                           ipsec-policy 09d7d4e25c36be0a1bd846a9b9dc7e81;
                       }
                       establish-tunnels immediately;
                   }
               }
               zones {
                   security-zone trust {
                       host-inbound-traffic {
                           system-services {
                               all;
                           }
                           protocols {
                               all;
                           }
                       }
                       interfaces {
                           st0.4002;
                       }
                   }
               }
           }
           interfaces {
               st0 {
                   unit 4002 {
                       family inet {
                           address 172.17.98.50/31;
                       }
                   }
               }
           }
           routing-options {
               static {
                   route 192.168.190.0/24 next-hop 192.168.130.1;
               }
           }
           routing-instances {
               transit {
                   interface st0.4002;
               }
           }
       }
       hubspoketenant_SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 {
           security {
               zones {
                   security-zone trust {
                       tcp-rst;
                       host-inbound-traffic {
                           system-services {
                               all;
                           }
                           protocols {
                               all;
                           }
                       }
                       interfaces {
                           gr-0/0/0.4000;
                       }
                   }
               }
           }
           interfaces {
               gr-0/0/0 {
                   unit 4000 {
                       tunnel {
                           source 172.17.98.50;
                           destination 172.17.98.51;
                           routing-instance {
                               destination transit;
                           }
                       }
                       family inet {
                           address 172.26.55.32/31;
                       }
                       family mpls;
                   }
               }
           }
           protocols {
               oam {
                   gre-tunnel {
                       interface gr-0/0/0.4000 {
                           keepalive-time 1;
                           hold-time 5;
                       }
                   }
               }
           }
           routing-instances {
               transit {
                   interface gr-0/0/0.4000;
               }
           }
       }
       rpm-cfg-sdwansite2 {
           services {
               rpm {
                   probe 8e241e3c129b739642164334fa96cdad {
                       test test-icmp-ping {
                           probe-type icmp-ping;
                           target address 172.26.55.33;
                           probe-count 5;
                           probe-interval 10;
                           test-interval 5;
                           source-address 172.26.55.32;
                           routing-instance transit;
                           destination-interface gr-0/0/0.4000;
                       }
                   }
                   probe 53ba76921e67d185af38435c3dd2eb2c {
                       test test-icmp-ping {
                           probe-type icmp-ping;
                           target address 172.18.123.239;
                           probe-count 5;
                           probe-interval 10;
                           test-interval 5;
                           source-address 172.18.123.238;
                           routing-instance transit;
                           destination-interface gr-0/0/0.4002;
                       }
                   }
               }
           }
       }
       app-qoe-sdwansite2 {
           class-of-service {
               classifiers {
                   dscp DSCP {
                       forwarding-class VOICE-VIDEO {
                           loss-priority high code-points af41;
                       }
                       forwarding-class INTERNET {
                           loss-priority high code-points af11;
                       }
                       forwarding-class CONTROL {
                           loss-priority low code-points cs6;
                       }
                       forwarding-class OAM {
                           loss-priority low code-points af21;
                       }
                   }
               }
               host-outbound-traffic {
                   forwarding-class CONTROL;
               }
               forwarding-classes {
                   queue 0 VOICE-VIDEO;
                   queue 1 INTERNET;
                   queue 3 CONTROL;
                   queue 5 OAM;
               }
               interfaces {
                   gr-0/0/0 {
                       unit * {
                           classifiers {
                               dscp DSCP;
                           }
                           rewrite-rules {
                               dscp DSCP-RW;
                           }
                       }
                   }
                   st0 {
                       unit * {
                           classifiers {
                               dscp DSCP;
                           }
                           rewrite-rules {
                               dscp DSCP-RW;
                           }
                       }
                   }
               }
               rewrite-rules {
                   dscp DSCP-RW {
                       forwarding-class VOICE-VIDEO {
                           loss-priority high code-point af41;
                       }
                       forwarding-class INTERNET {
                           loss-priority high code-point af11;
                       }
                       forwarding-class OAM {
                           loss-priority low code-point af21;
                       }
                   }
               }
               scheduler-maps {
                   sched-map {
                       forwarding-class VOICE-VIDEO scheduler QOS-VOICE-VIDEO-QGRP;
                       forwarding-class INTERNET scheduler QOS-INTERNET-QGRP;
                       forwarding-class CONTROL scheduler QOS-CONTROL-QGRP;
                       forwarding-class OAM scheduler QOS-OAM-QGRP;
                   }
               }
               schedulers {
                   QOS-VOICE-VIDEO-QGRP {
                       transmit-rate percent 20;
                       shaping-rate percent 20;
                       buffer-size percent 5;
                       priority low;
                   }
                   QOS-INTERNET-QGRP {
                       transmit-rate percent 15;
                       shaping-rate percent 20;
                       buffer-size percent 5;
                       priority low;
                   }
                   QOS-CONTROL-QGRP {
                       transmit-rate percent 5;
                       buffer-size percent 5;
                       priority high;
                   }
                   QOS-OAM-QGRP {
                       transmit-rate percent 2;
                       buffer-size percent 2;
                       priority low;
                   }
               }
           }
       }
       hubspoketenant_SDWANSITE2_WAN_1_HUB1_WAN_1_IPSEC_0 {
           security {
               ipsec {
                   proposal DEFAULT_IPSEC_PROPOSAL {
                       protocol esp;
                       encryption-algorithm aes-256-gcm;
                   }
                   policy 09d7d4e25c36be0a1bd846a9b9dc7e81 {
                       perfect-forward-secrecy {
                           keys group14;
                       }
                       proposals DEFAULT_IPSEC_PROPOSAL;
                   }
                   vpn 406ee3edb578a528ae859d5ea6dc91cf {
                       bind-interface st0.4003;
                       ike {
                           gateway 29fc998681aefd5976f3cad67d221b77;
                           proxy-identity {
                               local 172.16.34.104/31;
                               remote 172.16.34.105/31;
                           }
                           ipsec-policy 09d7d4e25c36be0a1bd846a9b9dc7e81;
                       }
                       establish-tunnels immediately;
                   }
               }
               zones {
                   security-zone trust {
                       host-inbound-traffic {
                           system-services {
                               all;
                           }
                           protocols {
                               all;
                           }
                       }
                       interfaces {
                           st0.4003;
                       }
                   }
               }
           }
           interfaces {
               st0 {
                   unit 4003 {
                       family inet {
                           address 172.16.34.104/31;
                       }
                   }
               }
           }
           routing-options {
               static {
                   route 192.168.191.0/24 next-hop 192.168.133.1;
               }
           }
           routing-instances {
               transit {
                   interface st0.4003;
               }
           }
       }
       hubspoketenant_SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 {
           security {
               zones {
                   security-zone trust {
                       tcp-rst;
                       host-inbound-traffic {
                           system-services {
                               all;
                           }
                           protocols {
                               all;
                           }
                       }
                       interfaces {
                           gr-0/0/0.4002;
                       }
                   }
               }
           }
           interfaces {
               gr-0/0/0 {
                   unit 4002 {
                       tunnel {
                           source 172.16.34.104;
                           destination 172.16.34.105;
                           routing-instance {
                               destination transit;
                           }
                       }
                       family inet {
                           address 172.18.123.238/31;
                       }
                       family mpls;
                   }
               }
           }
           protocols {
               oam {
                   gre-tunnel {
                       interface gr-0/0/0.4002 {
                           keepalive-time 1;
                           hold-time 5;
                       }
                   }
               }
           }
           routing-instances {
               transit {
                   interface gr-0/0/0.4002;
               }
           }
       }
       spoke-policy-default {
           policy-options {
               policy-statement next-hop-change {
                   term default {
                       then accept;
                   }
               }
               policy-statement transit-import {
                   term default {
                       then reject;
                   }
               }
           }
       }
       spoke-hubspoketenant_DefaultVPN-vpn-routing-config {
           routing-options {
               rib-groups {
                   LAN-hubspoketenant_DefaultVPN-to-breakout {
                       import-rib [ LAN-hubspoketenant_DefaultVPN.inet.0 default-local-breakout.inet.0 mpls-local-breakout.inet.0 internet-local-breakout.inet.0 ];
                       import-policy direct-routes;
                   }
               }
               forwarding-table {
                   export [ LAN-hubspoketenant_DefaultVPN Default-hubspoketenant_DefaultVPN-reverse ];
               }
           }
           protocols {
               bgp {
                   group ibgp {
                       import next-hop-change;
                       export static-export;
                       vpn-apply-export;
                   }
               }
           }
           policy-options {
               policy-statement donotexport {
                   then reject;
               }
               policy-statement direct-routes {
                   term 1 {
                       from protocol direct;
                       then accept;
                   }
                   term 2 {
                       then reject;
                   }
               }
               policy-statement LAN-hubspoketenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-Default-hubspoketenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Spoke-Routes-LAN-hubspoketenant_DefaultVPN;
                       then accept;
                   }
                   term 3 {
                       from community Hub-Primary-Routes-Default-hubspoketenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement LAN-hubspoketenant_DefaultVPN {
                   term 1 {
                       from {
                           protocol bgp;
                           rib LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                       then {
                           next-hop next-table Default-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               policy-statement Default-hubspoketenant_DefaultVPN-reverse {
                   term 1 {
                       from {
                           protocol bgp;
                           rib transit.inet.0;
                           community Spoke-Routes-LAN-hubspoketenant_DefaultVPN;
                       }
                       then {
                           next-hop next-table Default-reverse-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               policy-statement Default-hubspoketenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-Default-hubspoketenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Hub-Primary-Routes-Default-hubspoketenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
                   term default {
                       then reject;
                   }
               }
               policy-statement transit-import {
                   term hubspoketenant_DefaultVPN {
                       from community Spoke-Routes-LAN-hubspoketenant_DefaultVPN;
                       then accept;
                   }
               }
               policy-statement Default-reverse-hubspoketenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-Default-reverse-hubspoketenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Hub-Primary-Routes-Default-reverse-hubspoketenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
                   term default {
                       then reject;
                   }
               }
               policy-statement Default-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-Default-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           next-hop 192.168.210.4;
                           accept;
                       }
                   }
               }
               policy-statement LAN-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-LAN-hubspoketenant_DefaultVPN;
                           next-hop 192.168.210.4;
                           accept;
                       }
                   }
               }
               policy-statement Default-reverse-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-Default-reverse-hubspoketenant_DefaultVPN;
                           next-hop 192.168.210.4;
                           accept;
                       }
                   }
               }
               policy-statement mpls-hubspoketenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-mpls-hubspoketenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Hub-Primary-Routes-mpls-hubspoketenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement mpls-hubspoketenant_DefaultVPN-export {
                   term 1-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-mpls-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           next-hop 192.168.216.200;
                           accept;
                       }
                   }
               }
               policy-statement next-hop-change {
                   term hubspoketenant_DefaultVPN1 {
                       from community SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0-hubspoketenant_DefaultVPN;
                       then {
                           next-hop 172.26.55.33;
                           accept;
                       }
                   }
                   term hubspoketenant_DefaultVPN2 {
                       from community SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0-hubspoketenant_DefaultVPN;
                       then {
                           next-hop 172.18.123.239;
                           accept;
                       }
                   }
                   term spoke-import-hubspoketenant_DefaultVPN {
                       from community Spoke-Routes-LAN-hubspoketenant_DefaultVPN;
                       then {
                           next-hop 192.168.0.1;
                           accept;
                       }
                   }
                   term default-hubspoketenant_DefaultVPN1 {
                       from {
                           next-hop 192.168.210.1;
                           community Hub-Primary-Routes-Default-hubspoketenant_DefaultVPN;
                       }
                       then {
                           next-hop 192.168.56.46;
                       }
                   }
                   term default-hubspoketenant_DefaultVPN2 {
                       from {
                           next-hop 192.168.210.1;
                           community Hub-Primary-Routes-Default-hubspoketenant_DefaultVPN;
                       }
                       then {
                           next-hop 192.168.56.46;
                       }
                   }
               }
               policy-statement static-export {
                   term hubspoketenant_DefaultVPN1 {
                       from community Spoke-Routes-mpls-hubspoketenant_DefaultVPN;
                       then {
                           community add spoke-community;
                           next-hop 192.168.216.200;
                           accept;
                       }
                   }
                   term hubspoketenant_DefaultVPN2 {
                       from community Spoke-Routes-internet-hubspoketenant_DefaultVPN;
                       then {
                           community add spoke-community;
                           next-hop 192.168.69.136;
                           accept;
                       }
                   }
                   term default {
                       then {
                           community add spoke-community;
                           accept;
                       }
                   }
               }
               policy-statement PATH-POLICY-hubspoketenant_DefaultVPN {
                   term hubspoketenant_DefaultVPN1 {
                       from community SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0-hubspoketenant_DefaultVPN;
                       then accept;
                   }
                   term hubspoketenant_DefaultVPN2 {
                       from community SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0-hubspoketenant_DefaultVPN;
                       then accept;
                   }
               }
               policy-statement internet-hubspoketenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-internet-hubspoketenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Hub-Primary-Routes-internet-hubspoketenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement internet-hubspoketenant_DefaultVPN-export {
                   term 2-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-internet-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           next-hop 192.168.69.136;
                           accept;
                       }
                   }
               }
               policy-statement TC1-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC1-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC1-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC1-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               policy-statement TC2-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC2-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC2-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC2-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               policy-statement TC3-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC3-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC3-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC3-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               policy-statement TC4-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC4-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC4-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC4-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               policy-statement TC5-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC5-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC5-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC5-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               policy-statement TC6-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC6-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC6-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC6-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               policy-statement TC7-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC7-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC7-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC7-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               policy-statement TC8-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC8-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC8-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC8-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               policy-statement TC9-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC9-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC9-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC9-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               policy-statement TC10-hubspoketenant_DefaultVPN-import {
                   term 2 {
                       from {
                           community Hub-Primary-Routes-TC10-hubspoketenant_DefaultVPN;
                           policy PATH-POLICY-hubspoketenant_DefaultVPN;
                       }
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement TC10-hubspoketenant_DefaultVPN-export {
                   term hubspoketenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-TC10-hubspoketenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           accept;
                       }
                   }
               }
               community Hub-Primary-Select members target:192.168.210.1:1;
               community Hub-Primary-Routes-Default-hubspoketenant_DefaultVPN members target:192.168.210.1:24;
               community Hub-Primary-Routes-Default-reverse-hubspoketenant_DefaultVPN members target:192.168.210.1:25;
               community Spoke-Routes-Default-hubspoketenant_DefaultVPN members target:64512:24;
               community Spoke-Routes-Default-reverse-hubspoketenant_DefaultVPN members target:64512:25;
               community Spoke-Routes-LAN-hubspoketenant_DefaultVPN members target:192.168.0.1:25;
               community Spoke-Routes-mpls-hubspoketenant_DefaultVPN members target:64512:36;
               community Hub-Primary-Routes-mpls-hubspoketenant_DefaultVPN members target:192.168.210.1:36;
               community SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0-hubspoketenant_DefaultVPN members 64512:1;
               community Spoke-Routes-internet-hubspoketenant_DefaultVPN members target:64512:37;
               community Hub-Primary-Routes-internet-hubspoketenant_DefaultVPN members target:192.168.210.1:37;
               community SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0-hubspoketenant_DefaultVPN members 64512:2;
               community spoke-community members 64512:64512;
               community Spoke-Routes-TC1-hubspoketenant_DefaultVPN members target:64512:26;
               community Hub-Primary-Routes-TC1-hubspoketenant_DefaultVPN members target:192.168.210.1:26;
               community Spoke-Routes-TC2-hubspoketenant_DefaultVPN members target:64512:27;
               community Hub-Primary-Routes-TC2-hubspoketenant_DefaultVPN members target:192.168.210.1:27;
               community Spoke-Routes-TC3-hubspoketenant_DefaultVPN members target:64512:28;
               community Hub-Primary-Routes-TC3-hubspoketenant_DefaultVPN members target:192.168.210.1:28;
               community Spoke-Routes-TC4-hubspoketenant_DefaultVPN members target:64512:29;
               community Hub-Primary-Routes-TC4-hubspoketenant_DefaultVPN members target:192.168.210.1:29;
               community Spoke-Routes-TC5-hubspoketenant_DefaultVPN members target:64512:30;
               community Hub-Primary-Routes-TC5-hubspoketenant_DefaultVPN members target:192.168.210.1:30;
               community Spoke-Routes-TC6-hubspoketenant_DefaultVPN members target:64512:31;
               community Hub-Primary-Routes-TC6-hubspoketenant_DefaultVPN members target:192.168.210.1:31;
               community Spoke-Routes-TC7-hubspoketenant_DefaultVPN members target:64512:32;
               community Hub-Primary-Routes-TC7-hubspoketenant_DefaultVPN members target:192.168.210.1:32;
               community Spoke-Routes-TC8-hubspoketenant_DefaultVPN members target:64512:33;
               community Hub-Primary-Routes-TC8-hubspoketenant_DefaultVPN members target:192.168.210.1:33;
               community Spoke-Routes-TC9-hubspoketenant_DefaultVPN members target:64512:34;
               community Hub-Primary-Routes-TC9-hubspoketenant_DefaultVPN members target:192.168.210.1:34;
               community Spoke-Routes-TC10-hubspoketenant_DefaultVPN members target:64512:35;
               community Hub-Primary-Routes-TC10-hubspoketenant_DefaultVPN members target:192.168.210.1:35;
           }
           routing-instances {
               LAN-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   interface ge-0/0/4.1066;
                   route-distinguisher 192.168.210.4:25;
                   vrf-import LAN-hubspoketenant_DefaultVPN-import;
                   vrf-export LAN-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       interface-routes {
                           rib-group inet LAN-hubspoketenant_DefaultVPN-to-breakout;
                       }
                   }
               }
               natVR-hubspoketenant_DefaultVPN {
                   instance-type virtual-router;
                   routing-options {
                       static {
                           route 0.0.0.0/0 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               Default-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:24;
                   vrf-import Default-hubspoketenant_DefaultVPN-import;
                   vrf-export Default-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               Default-reverse-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 239.0.11.252:24;
                   vrf-import Default-reverse-hubspoketenant_DefaultVPN-import;
                   vrf-export Default-reverse-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               transit {
                   interface gr-0/0/0.4000;
                   interface gr-0/0/0.4002;
                   vrf-import transit-import;
                   routing-options {
                       rib transit.inet.3 {
                           static {
                               route 172.26.55.33/32 next-hop gr-0/0/0.4000;
                               route 192.168.84.238/32 next-hop gr-0/0/0.4000;
                               route 192.168.210.1/32 {
                                   qualified-next-hop gr-0/0/0.4000 {
                                       preference 12;
                                   }
                                   qualified-next-hop gr-0/0/0.4002 {
                                       preference 12;
                                   }
                               }
                               route 172.18.123.239/32 next-hop gr-0/0/0.4002;
                               route 192.168.142.248/32 next-hop gr-0/0/0.4002;
                               route 192.168.56.46/32 next-hop [ gr-0/0/0.4000 gr-0/0/0.4002 ];
                               route 192.168.0.1/32 {
                                   next-hop 192.168.210.1;
                                   no-readvertise;
                                   resolve;
                               }
                           }
                       }
                   }
                   protocols {
                       mpls {
                           interface gr-0/0/0.4000;
                           interface gr-0/0/0.4002;
                       }
                   }
               }
               mpls-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:36;
                   vrf-import mpls-hubspoketenant_DefaultVPN-import;
                   vrf-export mpls-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               internet-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:37;
                   vrf-import internet-hubspoketenant_DefaultVPN-import;
                   vrf-export internet-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC1-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:26;
                   vrf-import TC1-hubspoketenant_DefaultVPN-import;
                   vrf-export TC1-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC2-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:27;
                   vrf-import TC2-hubspoketenant_DefaultVPN-import;
                   vrf-export TC2-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC3-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:28;
                   vrf-import TC3-hubspoketenant_DefaultVPN-import;
                   vrf-export TC3-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC4-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:29;
                   vrf-import TC4-hubspoketenant_DefaultVPN-import;
                   vrf-export TC4-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC5-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:30;
                   vrf-import TC5-hubspoketenant_DefaultVPN-import;
                   vrf-export TC5-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC6-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:31;
                   vrf-import TC6-hubspoketenant_DefaultVPN-import;
                   vrf-export TC6-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC7-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:32;
                   vrf-import TC7-hubspoketenant_DefaultVPN-import;
                   vrf-export TC7-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC8-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:33;
                   vrf-import TC8-hubspoketenant_DefaultVPN-import;
                   vrf-export TC8-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC9-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:34;
                   vrf-import TC9-hubspoketenant_DefaultVPN-import;
                   vrf-export TC9-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
               TC10-hubspoketenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:35;
                   vrf-import TC10-hubspoketenant_DefaultVPN-import;
                   vrf-export TC10-hubspoketenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-hubspoketenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-hubspoketenant_DefaultVPN.inet.0;
                       }
                   }
               }
           }
       }
   }
   apply-groups [ global nfx-gwr-site-routing-config-192.168.210.4 dept-configuration hubspoketenant_SDWANSITE2_WAN_0_HUB1_WAN_0_IPSEC_0 hubspoketenant_SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 rpm-cfg-sdwansite2 app-qoe-sdwansite2 hubspoketenant_SDWANSITE2_WAN_1_HUB1_WAN_1_IPSEC_0 hubspoketenant_SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 spoke-hubspoketenant_DefaultVPN-vpn-routing-config spoke-policy-default ];
   system {
       host-name GWR.sdwansite2.hubspoketenant;
       time-zone Europe/Amsterdam;
       default-address-selection;
       root-authentication {
           encrypted-password "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81"; ## SECRET-DATA
       }
       name-server {
           8.8.8.8;
       }
       login {
           user csp {
               uid 2000;
               class super-user;
               authentication {
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC4XFrX1NGr9wK1GI5jtja5Mjeenh0jyh8Vc2+owelAPr6KGDVThuJi4xF0x1F/JQaOfRpP31TCkJbRvBYdgo19oA9u2RkCC6xwIZ8A1yLAX1Xvt+9FRyBKiZN6GURHAcoN0yaj4PEliMv7YJXwkmG33jpIjOnWu7jKBW6fs0U1W5EZSGYrhJb/kpCGkhfMH5iJ6DdOYE98FWy6bylSbb3lq2JaCxEPr07PpBhl4Z6Q8o53IBt30trYc0Byphpl4pKOXDB4o87OTmAH4KnVVMjmnfNzvRyLhv/vqsyyrXsObrC4BkOx7suv0yRvvPi+qwd2Og9l+UGJt8b5uQxNEW7r"; ## SECRET-DATA
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCplcjSdMeYPkgMUh7vMhzcc9eQhK5fBYzJ8Gp7YLHh++J3IJROC02PV6qsC6qvEb8oKTspnSmJpDpzW3O0RP+EtclDbkrmfxXUYHRz5m7JCxzz9VMaHjkEGn0+kI/WVQDQhRqk0BUpePbxZnD6e59EU2fggAI7JSTe1Og+LemQJ0+MV3rRnletmmARsX0YhmVH7Q53nRC8pg8jH44PcsLE41hJvebwVK0WZaFoc54qGNHaICmBY+coRT7D7gA1WGs90sxQyL0c5P1jaILbnQCnOv/BBwqZ4aoGEarC69HAU9+OVyHsew75Kl3jWA5SVv2zcfau+Sc+wCLFAm0fDwAD"; ## SECRET-DATA
               }
           }
           user cspagent {
               uid 2001;
               class operator;
               authentication {
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC4XFrX1NGr9wK1GI5jtja5Mjeenh0jyh8Vc2+owelAPr6KGDVThuJi4xF0x1F/JQaOfRpP31TCkJbRvBYdgo19oA9u2RkCC6xwIZ8A1yLAX1Xvt+9FRyBKiZN6GURHAcoN0yaj4PEliMv7YJXwkmG33jpIjOnWu7jKBW6fs0U1W5EZSGYrhJb/kpCGkhfMH5iJ6DdOYE98FWy6bylSbb3lq2JaCxEPr07PpBhl4Z6Q8o53IBt30trYc0Byphpl4pKOXDB4o87OTmAH4KnVVMjmnfNzvRyLhv/vqsyyrXsObrC4BkOx7suv0yRvvPi+qwd2Og9l+UGJt8b5uQxNEW7r"; ## SECRET-DATA
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCplcjSdMeYPkgMUh7vMhzcc9eQhK5fBYzJ8Gp7YLHh++J3IJROC02PV6qsC6qvEb8oKTspnSmJpDpzW3O0RP+EtclDbkrmfxXUYHRz5m7JCxzz9VMaHjkEGn0+kI/WVQDQhRqk0BUpePbxZnD6e59EU2fggAI7JSTe1Og+LemQJ0+MV3rRnletmmARsX0YhmVH7Q53nRC8pg8jH44PcsLE41hJvebwVK0WZaFoc54qGNHaICmBY+coRT7D7gA1WGs90sxQyL0c5P1jaILbnQCnOv/BBwqZ4aoGEarC69HAU9+OVyHsew75Kl3jWA5SVv2zcfau+Sc+wCLFAm0fDwAD"; ## SECRET-DATA
               }
           }
       }
       services {
           ssh;
           netconf {
               ssh;
               rfc-compliant;
           }
           web-management {
               http {
                   interface fxp0.0;
               }
           }
       }
       syslog {
           user * {
               any emergency;
           }
           host 192.168.10.47 {
               authorization any;
               port 514;
               structured-data;
           }
           file messages {
               any any;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
   }
   security {
       log {
           utc-timestamp;
           mode stream;
           format sd-syslog;
           source-address 192.168.210.4;
           transport {
               protocol tcp;
           }
           stream app-track-logs {
               format sd-syslog;
               category all;
               host {
                   192.168.10.47;
                   port 3514;
               }
               rate-limit {
                   10000;
               }
           }
           stream all-logs {
               format sd-syslog;
               category all;
               host {
                   192.168.10.47;
                   port 514;
               }
               rate-limit {
                   10000;
               }
           }
       }
       pki {
           ca-profile DEFAULT_CSO_1 {
               ca-identity DEFAULT_CSO_1;
           }
           ca-profile DEFAULT_CSO_2 {
               ca-identity DEFAULT_CSO_2;
           }
           ca-profile DEFAULT_CSO_3 {
               ca-identity DEFAULT_CSO_3;
           }
           ca-profile DEFAULT_CSO_4 {
               ca-identity DEFAULT_CSO_4;
           }
           ca-profile DEFAULT_CSO_5 {
               ca-identity DEFAULT_CSO_5;
           }
           ca-profile DEFAULT_CSO_6 {
               ca-identity DEFAULT_CSO_6;
           }
           ca-profile DEFAULT_CSO_7 {
               ca-identity DEFAULT_CSO_7;
           }
           ca-profile DEFAULT_CSO_8 {
               ca-identity DEFAULT_CSO_8;
           }
           ca-profile DEFAULT_CSO_9 {
               ca-identity DEFAULT_CSO_9;
           }
           ca-profile DEFAULT_CSO_10 {
               ca-identity DEFAULT_CSO_10;
           }
           ca-profile DEFAULT_CSO_11 {
               ca-identity DEFAULT_CSO_11;
           }
           ca-profile DEFAULT_CSO_12 {
               ca-identity DEFAULT_CSO_12;
           }
           ca-profile DEFAULT_CSO_13 {
               ca-identity DEFAULT_CSO_13;
           }
           ca-profile DEFAULT_CSO_14 {
               ca-identity DEFAULT_CSO_14;
           }
           ca-profile DEFAULT_CSO_15 {
               ca-identity DEFAULT_CSO_15;
           }
           ca-profile DEFAULT_CSO_16 {
               ca-identity DEFAULT_CSO_16;
           }
           ca-profile DEFAULT_CSO_17 {
               ca-identity DEFAULT_CSO_17;
           }
           ca-profile DEFAULT_CSO_18 {
               ca-identity DEFAULT_CSO_18;
           }
           ca-profile DEFAULT_CSO_19 {
               ca-identity DEFAULT_CSO_19;
           }
           ca-profile DEFAULT_CSO_20 {
               ca-identity DEFAULT_CSO_20;
           }
           ca-profile DEFAULT_CSO_21 {
               ca-identity DEFAULT_CSO_21;
           }
           ca-profile DEFAULT_CSO_22 {
               ca-identity DEFAULT_CSO_22;
           }
           ca-profile DEFAULT_CSO_23 {
               ca-identity DEFAULT_CSO_23;
           }
           ca-profile DEFAULT_CSO_24 {
               ca-identity DEFAULT_CSO_24;
           }
           ca-profile DEFAULT_CSO_25 {
               ca-identity DEFAULT_CSO_25;
           }
           ca-profile DEFAULT_CSO_26 {
               ca-identity DEFAULT_CSO_26;
           }
           ca-profile DEFAULT_CSO_27 {
               ca-identity DEFAULT_CSO_27;
           }
           ca-profile DEFAULT_CSO_28 {
               ca-identity DEFAULT_CSO_28;
           }
           ca-profile DEFAULT_CSO_29 {
               ca-identity DEFAULT_CSO_29;
           }
           ca-profile DEFAULT_CSO_30 {
               ca-identity DEFAULT_CSO_30;
           }
           ca-profile DEFAULT_CSO_31 {
               ca-identity DEFAULT_CSO_31;
           }
           ca-profile DEFAULT_CSO_32 {
               ca-identity DEFAULT_CSO_32;
           }
           ca-profile DEFAULT_CSO_33 {
               ca-identity DEFAULT_CSO_33;
           }
           ca-profile DEFAULT_CSO_34 {
               ca-identity DEFAULT_CSO_34;
           }
           ca-profile DEFAULT_CSO_35 {
               ca-identity DEFAULT_CSO_35;
           }
           ca-profile DEFAULT_CSO_36 {
               ca-identity DEFAULT_CSO_36;
           }
           ca-profile DEFAULT_CSO_37 {
               ca-identity DEFAULT_CSO_37;
           }
           ca-profile DEFAULT_CSO_38 {
               ca-identity DEFAULT_CSO_38;
           }
           ca-profile DEFAULT_CSO_39 {
               ca-identity DEFAULT_CSO_39;
           }
           ca-profile DEFAULT_CSO_40 {
               ca-identity DEFAULT_CSO_40;
           }
           ca-profile DEFAULT_CSO_41 {
               ca-identity DEFAULT_CSO_41;
           }
           ca-profile DEFAULT_CSO_42 {
               ca-identity DEFAULT_CSO_42;
           }
           ca-profile DEFAULT_CSO_43 {
               ca-identity DEFAULT_CSO_43;
           }
           ca-profile DEFAULT_CSO_44 {
               ca-identity DEFAULT_CSO_44;
           }
           ca-profile DEFAULT_CSO_45 {
               ca-identity DEFAULT_CSO_45;
           }
           ca-profile DEFAULT_CSO_46 {
               ca-identity DEFAULT_CSO_46;
           }
           ca-profile DEFAULT_CSO_47 {
               ca-identity DEFAULT_CSO_47;
           }
           ca-profile DEFAULT_CSO_48 {
               ca-identity DEFAULT_CSO_48;
           }
           ca-profile DEFAULT_CSO_49 {
               ca-identity DEFAULT_CSO_49;
           }
           ca-profile DEFAULT_CSO_50 {
               ca-identity DEFAULT_CSO_50;
           }
           ca-profile DEFAULT_CSO_51 {
               ca-identity DEFAULT_CSO_51;
           }
           ca-profile DEFAULT_CSO_52 {
               ca-identity DEFAULT_CSO_52;
           }
           ca-profile DEFAULT_CSO_53 {
               ca-identity DEFAULT_CSO_53;
           }
           ca-profile DEFAULT_CSO_54 {
               ca-identity DEFAULT_CSO_54;
           }
           ca-profile DEFAULT_CSO_55 {
               ca-identity DEFAULT_CSO_55;
           }
           ca-profile DEFAULT_CSO_56 {
               ca-identity DEFAULT_CSO_56;
           }
           ca-profile DEFAULT_CSO_57 {
               ca-identity DEFAULT_CSO_57;
           }
           ca-profile DEFAULT_CSO_58 {
               ca-identity DEFAULT_CSO_58;
           }
           ca-profile DEFAULT_CSO_59 {
               ca-identity DEFAULT_CSO_59;
           }
           ca-profile DEFAULT_CSO_60 {
               ca-identity DEFAULT_CSO_60;
           }
           ca-profile DEFAULT_CSO_61 {
               ca-identity DEFAULT_CSO_61;
           }
           ca-profile DEFAULT_CSO_62 {
               ca-identity DEFAULT_CSO_62;
           }
           ca-profile DEFAULT_CSO_63 {
               ca-identity DEFAULT_CSO_63;
           }
           ca-profile DEFAULT_CSO_64 {
               ca-identity DEFAULT_CSO_64;
           }
           ca-profile DEFAULT_CSO_65 {
               ca-identity DEFAULT_CSO_65;
           }
           ca-profile DEFAULT_CSO_66 {
               ca-identity DEFAULT_CSO_66;
           }
           ca-profile DEFAULT_CSO_67 {
               ca-identity DEFAULT_CSO_67;
           }
           ca-profile DEFAULT_CSO_68 {
               ca-identity DEFAULT_CSO_68;
           }
           ca-profile DEFAULT_CSO_69 {
               ca-identity DEFAULT_CSO_69;
           }
           ca-profile DEFAULT_CSO_70 {
               ca-identity DEFAULT_CSO_70;
           }
           ca-profile DEFAULT_CSO_71 {
               ca-identity DEFAULT_CSO_71;
           }
           ca-profile DEFAULT_CSO_72 {
               ca-identity DEFAULT_CSO_72;
           }
           ca-profile DEFAULT_CSO_73 {
               ca-identity DEFAULT_CSO_73;
           }
           ca-profile DEFAULT_CSO_74 {
               ca-identity DEFAULT_CSO_74;
           }
           ca-profile DEFAULT_CSO_75 {
               ca-identity DEFAULT_CSO_75;
           }
           ca-profile DEFAULT_CSO_76 {
               ca-identity DEFAULT_CSO_76;
           }
           ca-profile DEFAULT_CSO_77 {
               ca-identity DEFAULT_CSO_77;
           }
           ca-profile DEFAULT_CSO_78 {
               ca-identity DEFAULT_CSO_78;
           }
           ca-profile DEFAULT_CSO_79 {
               ca-identity DEFAULT_CSO_79;
           }
           ca-profile DEFAULT_CSO_80 {
               ca-identity DEFAULT_CSO_80;
           }
           ca-profile DEFAULT_CSO_81 {
               ca-identity DEFAULT_CSO_81;
           }
           ca-profile DEFAULT_CSO_82 {
               ca-identity DEFAULT_CSO_82;
           }
           ca-profile DEFAULT_CSO_83 {
               ca-identity DEFAULT_CSO_83;
           }
           ca-profile DEFAULT_CSO_84 {
               ca-identity DEFAULT_CSO_84;
           }
           ca-profile DEFAULT_CSO_85 {
               ca-identity DEFAULT_CSO_85;
           }
           ca-profile DEFAULT_CSO_86 {
               ca-identity DEFAULT_CSO_86;
           }
           ca-profile DEFAULT_CSO_87 {
               ca-identity DEFAULT_CSO_87;
           }
           ca-profile DEFAULT_CSO_88 {
               ca-identity DEFAULT_CSO_88;
           }
           ca-profile DEFAULT_CSO_89 {
               ca-identity DEFAULT_CSO_89;
           }
           ca-profile DEFAULT_CSO_90 {
               ca-identity DEFAULT_CSO_90;
           }
           ca-profile DEFAULT_CSO_91 {
               ca-identity DEFAULT_CSO_91;
           }
           ca-profile DEFAULT_CSO_92 {
               ca-identity DEFAULT_CSO_92;
           }
           ca-profile DEFAULT_CSO_93 {
               ca-identity DEFAULT_CSO_93;
           }
           ca-profile DEFAULT_CSO_94 {
               ca-identity DEFAULT_CSO_94;
           }
           ca-profile DEFAULT_CSO_95 {
               ca-identity DEFAULT_CSO_95;
           }
           ca-profile DEFAULT_CSO_96 {
               ca-identity DEFAULT_CSO_96;
           }
           ca-profile DEFAULT_CSO_97 {
               ca-identity DEFAULT_CSO_97;
           }
           ca-profile DEFAULT_CSO_98 {
               ca-identity DEFAULT_CSO_98;
           }
           ca-profile DEFAULT_CSO_99 {
               ca-identity DEFAULT_CSO_99;
           }
           ca-profile DEFAULT_CSO_100 {
               ca-identity DEFAULT_CSO_100;
           }
           ca-profile DEFAULT_CSO_101 {
               ca-identity DEFAULT_CSO_101;
           }
           ca-profile DEFAULT_CSO_102 {
               ca-identity DEFAULT_CSO_102;
           }
           ca-profile DEFAULT_CSO_103 {
               ca-identity DEFAULT_CSO_103;
           }
           ca-profile DEFAULT_CSO_104 {
               ca-identity DEFAULT_CSO_104;
           }
           ca-profile DEFAULT_CSO_105 {
               ca-identity DEFAULT_CSO_105;
           }
           ca-profile DEFAULT_CSO_106 {
               ca-identity DEFAULT_CSO_106;
           }
           ca-profile DEFAULT_CSO_107 {
               ca-identity DEFAULT_CSO_107;
           }
           ca-profile DEFAULT_CSO_108 {
               ca-identity DEFAULT_CSO_108;
           }
           ca-profile DEFAULT_CSO_109 {
               ca-identity DEFAULT_CSO_109;
           }
           ca-profile DEFAULT_CSO_110 {
               ca-identity DEFAULT_CSO_110;
           }
           ca-profile DEFAULT_CSO_111 {
               ca-identity DEFAULT_CSO_111;
           }
           ca-profile DEFAULT_CSO_112 {
               ca-identity DEFAULT_CSO_112;
           }
           ca-profile DEFAULT_CSO_114 {
               ca-identity DEFAULT_CSO_114;
           }
           ca-profile DEFAULT_CSO_115 {
               ca-identity DEFAULT_CSO_115;
           }
           ca-profile DEFAULT_CSO_116 {
               ca-identity DEFAULT_CSO_116;
           }
           ca-profile DEFAULT_CSO_117 {
               ca-identity DEFAULT_CSO_117;
           }
           ca-profile DEFAULT_CSO_118 {
               ca-identity DEFAULT_CSO_118;
           }
           ca-profile DEFAULT_CSO_119 {
               ca-identity DEFAULT_CSO_119;
           }
           ca-profile DEFAULT_CSO_120 {
               ca-identity DEFAULT_CSO_120;
           }
           ca-profile DEFAULT_CSO_121 {
               ca-identity DEFAULT_CSO_121;
           }
           ca-profile DEFAULT_CSO_122 {
               ca-identity DEFAULT_CSO_122;
           }
           ca-profile DEFAULT_CSO_123 {
               ca-identity DEFAULT_CSO_123;
           }
           ca-profile DEFAULT_CSO_124 {
               ca-identity DEFAULT_CSO_124;
           }
           ca-profile DEFAULT_CSO_125 {
               ca-identity DEFAULT_CSO_125;
           }
           ca-profile DEFAULT_CSO_126 {
               ca-identity DEFAULT_CSO_126;
           }
           ca-profile DEFAULT_CSO_127 {
               ca-identity DEFAULT_CSO_127;
           }
           ca-profile DEFAULT_CSO_128 {
               ca-identity DEFAULT_CSO_128;
           }
           ca-profile DEFAULT_CSO_129 {
               ca-identity DEFAULT_CSO_129;
           }
           ca-profile DEFAULT_CSO_130 {
               ca-identity DEFAULT_CSO_130;
           }
           ca-profile DEFAULT_CSO_131 {
               ca-identity DEFAULT_CSO_131;
           }
           ca-profile DEFAULT_CSO_132 {
               ca-identity DEFAULT_CSO_132;
           }
           ca-profile DEFAULT_CSO_133 {
               ca-identity DEFAULT_CSO_133;
           }
           ca-profile DEFAULT_CSO_134 {
               ca-identity DEFAULT_CSO_134;
           }
           ca-profile DEFAULT_CSO_135 {
               ca-identity DEFAULT_CSO_135;
           }
           ca-profile DEFAULT_CSO_136 {
               ca-identity DEFAULT_CSO_136;
           }
           ca-profile DEFAULT_CSO_137 {
               ca-identity DEFAULT_CSO_137;
           }
           ca-profile DEFAULT_CSO_138 {
               ca-identity DEFAULT_CSO_138;
           }
           ca-profile DEFAULT_CSO_139 {
               ca-identity DEFAULT_CSO_139;
           }
           ca-profile DEFAULT_CSO_140 {
               ca-identity DEFAULT_CSO_140;
           }
           ca-profile DEFAULT_CSO_141 {
               ca-identity DEFAULT_CSO_141;
           }
           ca-profile DEFAULT_CSO_142 {
               ca-identity DEFAULT_CSO_142;
           }
           ca-profile DEFAULT_CSO_143 {
               ca-identity DEFAULT_CSO_143;
           }
           ca-profile DEFAULT_CSO_144 {
               ca-identity DEFAULT_CSO_144;
           }
           ca-profile DEFAULT_CSO_145 {
               ca-identity DEFAULT_CSO_145;
           }
           ca-profile DEFAULT_CSO_146 {
               ca-identity DEFAULT_CSO_146;
           }
           ca-profile DEFAULT_CSO_147 {
               ca-identity DEFAULT_CSO_147;
           }
           ca-profile DEFAULT_CSO_148 {
               ca-identity DEFAULT_CSO_148;
           }
           ca-profile DEFAULT_CSO_149 {
               ca-identity DEFAULT_CSO_149;
           }
           ca-profile DEFAULT_CSO_150 {
               ca-identity DEFAULT_CSO_150;
           }
           ca-profile DEFAULT_CSO_151 {
               ca-identity DEFAULT_CSO_151;
           }
           ca-profile DEFAULT_CSO_152 {
               ca-identity DEFAULT_CSO_152;
           }
           ca-profile DEFAULT_CSO_153 {
               ca-identity DEFAULT_CSO_153;
           }
           ca-profile DEFAULT_CSO_154 {
               ca-identity DEFAULT_CSO_154;
           }
           ca-profile DEFAULT_CSO_155 {
               ca-identity DEFAULT_CSO_155;
           }
           ca-profile-group DEFAULT_CSO {
               cert-base-count 155;
           }
       }
       ike {
           proposal DEFAULT_IKE_PROPOSAL {
               authentication-method pre-shared-keys;
               dh-group group14;
               encryption-algorithm aes-256-gcm;
           }
           policy b9b0ecb204fe1f45a9bd67f9ebda518f {
               mode aggressive;
               proposals DEFAULT_IKE_PROPOSAL;
               pre-shared-key ascii-text "$9$N/b2oJZD.PT8XDHk.TQrlKMWXaJUH.f9AWX7-sYfTQnuBylvW8xJGRcSyKvmP5TF6p01EhyCAw2aZHk.mfQn9ylvMLxz301IRrlg4aZUi.m5/t0f5"; ## SECRET-DATA
           }
           policy 7d2e00c46d0acc167f22d3edb30a8c98 {
               mode aggressive;
               proposals DEFAULT_IKE_PROPOSAL;
               pre-shared-key ascii-text "$9$dZs4JGUiP5zX7iq.PzFeKM8L7ZGjqPTApL7-V2gTzF/OIlKWLXNGDhyleW85TzF6CO1ESyepu2oGD.mf5Q39tev8XNd69IhcSvMJZUjH.5TFtOIzF"; ## SECRET-DATA
           }
           gateway 5ed970ab60572e7f500fbaf90cc6c074 {
               ike-policy b9b0ecb204fe1f45a9bd67f9ebda518f;
               address 192.168.190.254;
               dead-peer-detection {
                   interval 10;
                   threshold 3;
               }
               local-identity hostname OAM-SDWANSITE2_WAN_0_HUB1_WAN_0_IPSEC_0;
               external-interface ge-0/0/2.0;
               version v2-only;
           }
           gateway 29fc998681aefd5976f3cad67d221b77 {
               ike-policy 7d2e00c46d0acc167f22d3edb30a8c98;
               address 192.168.191.254;
               dead-peer-detection {
                   interval 10;
                   threshold 3;
               }
               local-identity hostname OAM-SDWANSITE2_WAN_1_HUB1_WAN_1_IPSEC_0;
               external-interface ge-0/0/3.0;
               version v2-only;
           }
       }
       ipsec {
           proposal DEFAULT_IPSEC_PROPOSAL {
               protocol esp;
               encryption-algorithm aes-256-gcm;
           }
           policy 09d7d4e25c36be0a1bd846a9b9dc7e81 {
               perfect-forward-secrecy {
                   keys group14;
               }
               proposals DEFAULT_IPSEC_PROPOSAL;
           }
           vpn 3e5c5331016161473c3ba19fe399419e {
               bind-interface st0.4000;
               ike {
                   gateway 5ed970ab60572e7f500fbaf90cc6c074;
                   proxy-identity {
                       local 172.29.4.154/31;
                       remote 172.29.4.155/31;
                   }
                   ipsec-policy 09d7d4e25c36be0a1bd846a9b9dc7e81;
               }
               establish-tunnels immediately;
           }
           vpn 87b602a8bb00f319166e9a36e42d25c2 {
               bind-interface st0.4001;
               ike {
                   gateway 29fc998681aefd5976f3cad67d221b77;
                   proxy-identity {
                       local 172.23.122.150/31;
                       remote 172.23.122.151/31;
                   }
                   ipsec-policy 09d7d4e25c36be0a1bd846a9b9dc7e81;
               }
               establish-tunnels immediately;
           }
       }
       advance-policy-based-routing {
           tunables {
               enable-logging;
           }
       }
       application-tracking {
           first-update;
           session-update-interval 4;
       }
       flow {
           allow-dns-reply;
           allow-embedded-icmp;
           aging {
               early-ageout 65535;
           }
           tcp-mss {
               all-tcp {
                   mss 1350;
               }
               ipsec-vpn {
                   mss 1200;
               }
           }
           tcp-session {
               no-syn-check;
               no-syn-check-in-tunnel;
               no-sequence-check;
           }
       }
       screen {
           ids-option untrust-screen {
               icmp {
                   ping-death;
               }
               ip {
                   source-route-option;
                   tear-drop;
               }
               tcp {
                   syn-flood {
                       alarm-threshold 1024;
                       attack-threshold 200;
                       source-threshold 1024;
                       destination-threshold 2048;
                       queue-size 2000; ## Warning: 'queue-size' is deprecated
                       timeout 20;
                   }
                   land;
               }
           }
       }
       nat {
           source {
               pool oam_pool {
                   address {
                       192.168.210.4/32;
                   }
               }
               rule-set underlay-mgmt-traffic-nat {
                   from routing-instance default;
                   to zone untrust;
                   rule r4 {
                       match {
                           source-address 192.168.210.4/32;
                       }
                       then {
                           source-nat {
                               interface;
                           }
                       }
                   }
               }
               rule-set mgmt-traffic-nat {
                   from interface ge-0/0/1.0;
                   to interface [ st0.4000 st0.4001 ];
                   rule r1 {
                       match {
                           destination-address 192.168.10.0/24;
                       }
                       then {
                           source-nat {
                               pool {
                                   oam_pool;
                               }
                           }
                       }
                   }
               }
               rule-set own-mgmt-traffic-nat {
                   from routing-instance default;
                   to interface [ st0.4000 st0.4001 ];
                   rule r2 {
                       match {
                           source-address 0.0.0.0/0;
                           protocol icmp;
                       }
                       then {
                           source-nat {
                               off;
                           }
                       }
                   }
                   rule r3 {
                       match {
                           source-address 0.0.0.0/0;
                       }
                       then {
                           source-nat {
                               pool {
                                   oam_pool;
                               }
                           }
                       }
                   }
               }
           }
       }
       policies {
           from-zone oam to-zone untrust {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone trust to-zone untrust {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone oam to-zone oam {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone Default to-zone trust {
               policy Intent_1 {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           default-policy {
               deny-all;
           }
           policy-rematch;
       }
       zones {
           security-zone trust {
               tcp-rst;
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
           }
           security-zone oam {
               tcp-rst;
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/1.0;
                   lo0.0;
                   st0.4000;
                   st0.4001;
               }
           }
           security-zone untrust {
               screen untrust-screen;
               host-inbound-traffic {
                   system-services {
                       dhcp;
                       ike;
                       ssh;
                       ping;
                       netconf;
                       http;
                       https;
                       tftp;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/2.0;
                   ge-0/0/3.0;
               }
           }
           security-zone Default {
               application-tracking;
           }
       }
   }
   interfaces {
       /* Internal OAM interface */
       ge-0/0/1 {
           unit 0 {
               family inet {
                   address 10.10.10.3/24;
               }
           }
       }
       /* wan_0 interface */
       ge-0/0/2 {
           description "WAN-0 interface";
           mac ec:13:db:db:09:4c;
           unit 0 {
               family inet {
                   address 192.168.130.2/24;
               }
           }
       }
       /* wan_1 interface */
       ge-0/0/3 {
           description "WAN-1 interface";
           unit 0 {
               family inet {
                   address 192.168.133.2/24;
               }
           }
       }
       /* wan_2 interface */
       /* wan_3 interface */
       /* AUX_0 Connected to JCP */
       ge-0/0/4 {
           description "AUX_0 Connected to JCP";
           vlan-tagging;
           unit 0 {
               vlan-id 4001;
               family inet {
                   address 10.10.0.2/24;
               }
           }
       }
       /* AUX_1 */
       ge-0/0/5 {
           description AUX_1;
           unit 0 {
               family inet {
                   address 10.10.12.2/24;
               }
           }
       }
       /* AUX_2 */
       ge-0/0/6 {
           description AUX_2;
           unit 0 {
               family inet {
                   address 10.10.13.2/24;
               }
           }
       }
       /* Internal management port */
       fxp0 {
           description "Internal management port";
           unit 0 {
               family inet {
                   address 192.0.2.100/24;
               }
           }
       }
       /* Loopback Interface */
       lo0 {
           description "Loopback Interface";
           unit 0 {
               family inet {
                   address 192.168.210.4/32;
               }
           }
       }
       st0 {
           per-unit-scheduler;
           unit 4000 {
               family inet {
                   address 172.29.4.154/31;
               }
           }
           unit 4001 {
               family inet {
                   address 172.23.122.150/31;
               }
           }
       }
   }
   routing-options {
       static {
           route 192.168.210.1/32 next-hop [ st0.4000 st0.4001 ];
           route 192.168.190.254/32 next-hop 192.168.130.1;
           route 192.168.191.254/32 next-hop 192.168.133.1;
           route 0.0.0.0/0 {
               next-hop 192.168.133.1;
               no-readvertise;
           }
       }
       autonomous-system 64512;
       forwarding-table {
           export rejject_access_internal_fxp0;
       }
   }
   protocols {
       bgp {
           group oam-bgp {
               type internal;
               local-address 192.168.210.4;
               import prim-lp-import;
               family inet {
                   unicast;
               }
               neighbor 192.168.210.1 {
                   export oam-route-export-prim;
               }
           }
       }
   }
   policy-options {
       policy-statement ebgp-export {
           term static {
               from protocol static;
               then accept;
           }
           term reject {
               then reject;
           }
       }
       policy-statement oam-route-export {
           term 1 {
               from {
                   protocol direct;
                   route-filter 192.168.210.4/32 exact;
               }
               then accept;
           }
           term default {
               then reject;
           }
       }
       policy-statement oam-route-export-prim {
           term 1 {
               from {
                   protocol direct;
                   route-filter 192.168.210.4/32 exact;
               }
               then {
                   community add Hub-Primary-Select;
                   accept;
               }
           }
           term default {
               then reject;
           }
       }
       policy-statement prim-lp-import {
           term 1 {
               from next-hop 192.168.210.1;
               then {
                   local-preference 200;
                   accept;
               }
           }
       }
       policy-statement rejject_access_internal_fxp0 {
           from {
               protocol access-internal;
               interface fxp0.0;
           }
           then reject;
       }
       community Hub-Primary-Select members target:192.168.210.1:1;
   }
   class-of-service {
       interfaces {
           ge-0/0/2 {
               shaping-rate 1g;
           }
           ge-0/0/3 {
               shaping-rate 1g;
           }
       }
   }
   
   
   root@GWR.sdwansite2.hubspoketenant> show services rpm probe-results
       Owner: 53ba76921e67d185af38435c3dd2eb2c, Test: test-icmp-ping
       Target address: 172.18.123.239, Source address: 172.18.123.238,
       Probe type: icmp-ping
       Routing Instance Name: transit
       Destination interface name: gr-0/0/0.4002
       Test size: 5 probes
       Probe results:
         Response received
         Wed Aug 22 16:35:59 2018
         Wed Aug 22 16:35:59 2018, No hardware timestamps
         Rtt: 1681 usec, Round trip jitter: 31 usec,
         Round trip interarrival jitter: 694 usec
       Results over current test:
         Probes sent: 1, Probes received: 1, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 1, Minimum: 1681 usec, Maximum: 1681 usec, Average: 1681 usec,
           Peak to peak: 0 usec, Stddev: 0 usec, Sum: 1681 usec
         Measurement: Positive round trip jitter
           Samples: 1, Minimum: 31 usec, Maximum: 31 usec, Average: 31 usec,
           Peak to peak: 0 usec, Stddev: 0 usec, Sum: 31 usec
       Results over last test:
         Probes sent: 5, Probes received: 5, Loss percentage: 0.000000
         Test completed on Wed Aug 22 16:35:54 2018
         Measurement: Round trip time
           Samples: 5, Minimum: 1650 usec, Maximum: 2861 usec, Average: 2077 usec,
           Peak to peak: 1211 usec, Stddev: 417 usec, Sum: 10383 usec
         Measurement: Positive round trip jitter
           Samples: 1, Minimum: 1005 usec, Maximum: 1005 usec, Average: 1005 usec,
           Peak to peak: 0 usec, Stddev: 0 usec, Sum: 1005 usec
         Measurement: Negative round trip jitter
           Samples: 4, Minimum: 96 usec, Maximum: 771 usec, Average: 303 usec,
           Peak to peak: 675 usec, Stddev: 273 usec, Sum: 1211 usec
       Results over all tests:
         Probes sent: 221, Probes received: 209, Loss percentage: 5.429864
         Measurement: Round trip time
           Samples: 209, Minimum: 1610 usec, Maximum: 11284 usec,
           Average: 1978 usec, Peak to peak: 9674 usec, Stddev: 798 usec,
           Sum: 413409 usec
         Measurement: Positive round trip jitter
           Samples: 104, Minimum: 0 usec, Maximum: 9445 usec, Average: 261 usec,
           Peak to peak: 9445 usec, Stddev: 924 usec, Sum: 27146 usec
         Measurement: Negative round trip jitter
           Samples: 104, Minimum: 1 usec, Maximum: 6269 usec, Average: 262 usec,
           Peak to peak: 6268 usec, Stddev: 692 usec, Sum: 27248 usec
   
       Owner: 8e241e3c129b739642164334fa96cdad, Test: test-icmp-ping
       Target address: 172.26.55.33, Source address: 172.26.55.32,
       Probe type: icmp-ping
       Routing Instance Name: transit
       Destination interface name: gr-0/0/0.4000
       Test size: 5 probes
       Probe results:
         Response received
         Wed Aug 22 16:35:58 2018
         Wed Aug 22 16:35:58 2018, No hardware timestamps
         Rtt: 1793 usec, Round trip jitter: 47 usec,
         Round trip interarrival jitter: 361 usec
       Results over current test:
         Probes sent: 1, Probes received: 1, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 1, Minimum: 1793 usec, Maximum: 1793 usec, Average: 1793 usec,
           Peak to peak: 0 usec, Stddev: 0 usec, Sum: 1793 usec
         Measurement: Positive round trip jitter
           Samples: 1, Minimum: 47 usec, Maximum: 47 usec, Average: 47 usec,
           Peak to peak: 0 usec, Stddev: 0 usec, Sum: 47 usec
       Results over last test:
         Probes sent: 5, Probes received: 5, Loss percentage: 0.000000
         Test completed on Wed Aug 22 16:35:53 2018
         Measurement: Round trip time
           Samples: 5, Minimum: 1746 usec, Maximum: 2105 usec, Average: 1866 usec,
           Peak to peak: 359 usec, Stddev: 135 usec, Sum: 9331 usec
         Measurement: Positive round trip jitter
           Samples: 2, Minimum: 53 usec, Maximum: 193 usec, Average: 123 usec,
           Peak to peak: 140 usec, Stddev: 70 usec, Sum: 246 usec
         Measurement: Negative round trip jitter
           Samples: 3, Minimum: 60 usec, Maximum: 184 usec, Average: 137 usec,
           Peak to peak: 124 usec, Stddev: 55 usec, Sum: 412 usec
       Results over all tests:
         Probes sent: 221, Probes received: 209, Loss percentage: 5.429864
         Measurement: Round trip time
           Samples: 209, Minimum: 1576 usec, Maximum: 6896 usec,
           Average: 1968 usec, Peak to peak: 5320 usec, Stddev: 541 usec,
           Sum: 411387 usec
         Measurement: Positive round trip jitter
           Samples: 105, Minimum: 2 usec, Maximum: 4906 usec, Average: 241 usec,
           Peak to peak: 4904 usec, Stddev: 608 usec, Sum: 25291 usec
         Measurement: Negative round trip jitter
           Samples: 103, Minimum: 1 usec, Maximum: 4164 usec, Average: 248 usec,
           Peak to peak: 4163 usec, Stddev: 550 usec, Sum: 25500 usec
   
   

To have the LAN segment been able to send traffic to anything else we now have to apply a Firewall Rule to pass traffic.

If you don’t have already a rule set then it time to create your first rule now.

|image274|

|image275|

Deploy your saved Firewall ruleset

|image276|

|image277|

|image278|

AFTER Firewall deploy first as a condition; you should be able to use VNC to desktop4-VM to emulate a client. Review Chapter 2.8 above for instructions how to use VNC. Example below

.. code-block:: none

   virsh vncdisplay desktop4
   :94

|image279|

If you open two Terminals on the Client Desktop you should be able to ping 8.8.8.8 and 8.8.4.4 with the second window. Access to other internet hosts will also to prove the forwarding is ok.

|image280|

Now check the sessions for the two destinations on the Spoke and will see that for this traffic they either use interface gr-0/0/0.4000 with is WAN_0 OR gr-0/0/0.4002 which is WAN_1.

This certifies the ECMP based load-balancer is working correctly. As you did not yet configure an SLA for App-Based-Routeing this should be the default behaviour as in the configuration above there is NO preferences for non-SLA traffic.

.. code-block:: none

   show security flow session destination-prefix 8.8.8.8
   Session ID: 5134, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.66.66.66/35731 --> 8.8.8.8/2092;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/2092 --> 10.66.66.66/35731;icmp, Conn Tag: 0x0, If: gr-0/0/0.4002, Pkts: 1, Bytes: 84,
   
   Session ID: 5136, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.66.66.66/35732 --> 8.8.8.8/2092;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/2092 --> 10.66.66.66/35732;icmp, Conn Tag: 0x0, If: gr-0/0/0.4002, Pkts: 1, Bytes: 84,
   
   Session ID: 5140, Policy name: Intent_1/7, Timeout: 4, Valid
     In: 10.66.66.66/35733 --> 8.8.8.8/2092;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/2092 --> 10.66.66.66/35733;icmp, Conn Tag: 0x0, If: gr-0/0/0.4002, Pkts: 1, Bytes: 84,
   Total sessions: 3

   show security flow session destination-prefix 8.8.4.4
   Session ID: 5215, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.66.66.66/35749 --> 8.8.4.4/2106;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.4.4/2106 --> 10.66.66.66/35749;icmp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 1, Bytes: 84,
   
   Session ID: 5217, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.66.66.66/35750 --> 8.8.4.4/2106;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.4.4/2106 --> 10.66.66.66/35750;icmp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 1, Bytes: 84,
   
   Session ID: 5219, Policy name: Intent_1/7, Timeout: 4, Valid
     In: 10.66.66.66/35751 --> 8.8.4.4/2106;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.4.4/2106 --> 10.66.66.66/35751;icmp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 1, Bytes: 84,
   Total sessions: 3

As we have checked the Lab connectivity and provision of the Device by this you can now focus on the common SD-WAN test cases of this lab starting in Chapter 6.6 below

Shared test cases for SRX and NFX250 as Spoke devices
-----------------------------------------------------

.. note:: This entire set of features has not been re-qualified with CSO 4.1.0 as we don’t expect changes. Should you find an error please let us know.

MANDATORY STEP – add/review Licenses for later tests
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For the NFX250 license upload (after EVERY TIME it’s new provisioned) we first add a license in the GUI:

|image281|

The License file (attached is an example you might use for your lab BUT NOT SHARE) needs to be created/obtained locally on your notebook for the upload.

.. code-block:: none

   cat <<EOF >vSRX-License.lic
   JUNOS988878 aeaqib qbo4fq 4ojrg4 ztaqjq gaztan bsgq4q
    ycsmif bg64df nzwgcy qhfblr iodnqp f5qjma yeo56q somr4x
    7g5lhk odjend xs6evw u2bmyx qdmgas jgtxel tas64
   
   JUNOS851122 aeaqic a6ajc4 fuohde bhhqwr y4mqeq 6c2hdr saq5yl
    i4ogic dpbndr yzbmhd smjxgm yecmbq gi2dao bqhagb etcbij
    fhk3tj obsxei ctpfzx izltoq dsrnpk jjgpis 36dt5b ve3h6f
    tkrzgr jhfpg3 qtr74l w7w7sy btq2da vzkvue 7ba2us eemy
   EOF

Example for a Hardware SRX as Spoke where you need individual Licenses!

.. hidden-code-block:: none

   Serial No :              CZ1616AF0021
   Model :                  SRX345
   Features :               SRX345-CS-BUN-1
   Issue Date :             17-Apr-2018
   Expiration Date :        17-Apr-2019
   License Id :             JUNOS1005420
   License Key : 
   JUNOS1005420 aeaqia qminnd cnrrgz aummbq giyqqb qcdpco
                nrsua4 umyjse c3zlnk vw4u5m tuzazb ak4y3m
                r7tb7x m27in2 6lbri3 lwiwfn whstcv qxtg7v
                hsq
   
   Serial No :              CZ1616AF0021
   Model :                  SRX345
   Features :               SRX345-CS-BUN-1
   Issue Date :             17-Apr-2018
   Expiration Date :        17-Apr-2019
   License Id :             JUNOS1005421
   License Key : 
   JUNOS1005421 aeaqia qminnd cnrrgz aummbq giyqqb qcdxco
                nrsua4 uga3fa lby4r4 ytplb3 hlasah v44ysu
                cswzpl bcppoe iu23jb pcrncg s6xkma zfazop
                usa
   
   Serial No :              CZ1616AF0021
   Model :                  SRX345
   Features :               SRX345-CS-BUN-1
   Issue Date :             17-Apr-2018
   Expiration Date :        17-Apr-2019
   License Id :             JUNOS1005422
   License Key : 
   JUNOS1005422 aeaqia qminnd cnrrgz aummbq giyqqb qcixco
                nrsua4 ubwjcd oq2lw4 oy5vwl i2ubu7 5lmgti
                5g3vah ql7lf7 xdujb2 kyq7n2 3mvhpe 2pmhmk
                cwq
   
   Serial No :              CZ1616AF0021
   Model :                  SRX345
   Features :               SRX345-CS-BUN-1
   Issue Date :             17-Apr-2018
   Expiration Date :        17-Apr-2019
   License Id :             JUNOS1005423
   License Key : 
   JUNOS1005423 aeaqia qminnd cnrrgz aummbq giyqqb qcopco
                nrsua4 uemwym 5zhwuk 22ow7p afphls 5e47af
                fafdv4 vy4v4a xtp65k ex6frd prlmra wg5sov
                piq

|image282|

|image283|

|image284|

Wait until License push job was successful

|image285|

You may want to check this locally on the Device (in the GWR-VM)

.. code-block:: none

   show system license
   License usage:
                                    Licenses     Licenses    Licenses    Expiry
     Feature name                       used    installed      needed
     anti_spam_key_sbl                     0            1           0    2019-11-01 00:00:00 UTC
     idp-sig                               0            1           0    2019-11-01 00:00:00 UTC
     appid-sig                             0            1           0    2019-11-01 00:00:00 UTC
     av_key_sophos_engine                  0            1           0    2019-11-01 00:00:00 UTC
     wf_key_websense_ewf                   0            1           0    2019-11-01 00:00:00 UTC
     Virtual Appliance                     1            1           0    permanent
     remote-access-ipsec-vpn-client        0            2           0    permanent
   
   Licenses installed:
     License identifier: E420588955
     License version: 4
     Software Serial Number: 20150625
     Customer ID: vSRX-JuniperEval
     Features:
       Virtual Appliance - Virtual Appliance
         count-down, Original validity: 60 days
   
     License identifier: JUNOS851122
     License version: 4
     Software Serial Number: 91730A00240808
     Customer ID: LABJuniper Systest
     Features:
       av_key_sophos_engine - Anti Virus with Sophos Engine
         date-based, 2016-10-31 00:00:00 UTC - 2019-11-01 00:00:00 UTC
       wf_key_websense_ewf - Web Filtering EWF
         date-based, 2016-10-31 00:00:00 UTC - 2019-11-01 00:00:00 UTC
       appid-sig        - APPID Signature
         date-based, 2016-10-31 00:00:00 UTC - 2019-11-01 00:00:00 UTC
       idp-sig          - IDP Signature
         date-based, 2016-10-31 00:00:00 UTC - 2019-11-01 00:00:00 UTC
       anti_spam_key_sbl - Anti-Spam
         date-based, 2016-10-31 00:00:00 UTC - 2019-11-01 00:00:00 UTC
   
     License identifier: JUNOS988878
     License version: 4
     Software Serial Number: 91730A00304249
     Customer ID: LABopenlab
     Features:
       Virtual Appliance - Virtual Appliance
         permanent

For your Hardware SRX the final result should look like this

.. code-block:: none

   show system license
   License usage:
                                    Licenses     Licenses    Licenses    Expiry
     Feature name                       used    installed      needed
     anti_spam_key_sbl                     0            1           0    2019-04-18 02:00:00 CEST
     idp-sig                               0            2           0    2019-04-18 02:00:00 CEST
     dynamic-vpn                           0            2           0    permanent
     av_key_sophos_engine                  1            1           0    2019-04-18 02:00:00 CEST
     wf_key_websense_ewf                   0            1           0    2019-04-18 02:00:00 CEST
     remote-access-ipsec-vpn-client        0            2           0    permanent
   
   Licenses installed:
     License identifier: JUNOS1005420
     License version: 4
     Valid for device: CZ1616AF0021
     Features:
       anti_spam_key_sbl - Anti-Spam
         date-based, 2018-04-17 02:00:00 CEST - 2019-04-18 02:00:00 CEST
   
     License identifier: JUNOS1005421
     License version: 4
     Valid for device: CZ1616AF0021
     Features:
       idp-sig          - IDP Signature
         date-based, 2018-04-17 02:00:00 CEST - 2019-04-18 02:00:00 CEST
   
     License identifier: JUNOS1005422
     License version: 4
     Valid for device: CZ1616AF0021
     Features:
       av_key_sophos_engine - Anti Virus with Sophos Engine
         date-based, 2018-04-17 02:00:00 CEST - 2019-04-18 02:00:00 CEST
   
     License identifier: JUNOS1005423
     License version: 4
     Valid for device: CZ1616AF0021
     Features:
       wf_key_websense_ewf - Web Filtering EWF
         date-based, 2018-04-17 02:00:00 CEST - 2019-04-18 02:00:00 CEST
   
     License identifier: JUNOS952069
     License version: 4
     Valid for device: CZ1616AF0021
     Features:
       idp-sig          - IDP Signature
         date-based, 2017-09-14 02:00:00 CEST - 2018-09-02 02:00:00 CEST

MANDATORY STEP – Load IDP-Signatures
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Now you need to load the latest IDP-Signatures to make the device ready for an SD-WAN lab.

If the device is and NFX250 there will be no old signatures stored so you have to do this AFTER EVERY NEW PROVISIONING!

|image286|

Signatures only need to be loaded on Spoke-Devices

|image287|

This download process takes about 4-5minutes! So it is much faster than triggering a local download from external and installation from the device.

|image288|

Demonstrate Application detection for SD-WAN
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Open a Device that you manage.

|image289|

Open the WAN-Tab of the Device and make sure Overlay is selected for the moment. Then you can also extend the view on the device clicking on “2” the hub.

|image290|

You should now see a Picture similar to the below and some small applications already detected (dependent what you have done on the client VM).

|image291|

Now use VLC to the respective desktop2/4 VM, open a Mozilla browser and search for something random.

|image292|

Now also browse to 3-4 news websites etc. just to generate some traffic patterns the IDP-Engine can look at and report (avoid SSH and FTP etc. use external websites please).

After about 3 Minutes you should see the new Applications in the GUI reported like below

|image293|

Top-Right is also the possibility to lower the reporting time (please check again if you refresh the window).

|image294|

If you have a **MINIMUM OF 15 Minutes** of collected Samples from the Device after the IDP-Signatures are loaded you can also generate a first Report and review it like below

|image295|

Embedded below in this document is an example PDF-Report File that we have generated with this lab. Please extract it if you need it.

**DOWNLOAD**
`Application_and_User_Usage-example.pdf <Application_and_User_Usage-example.pdf>`__


|image296|

If you are a CLI savvy User you may also look at the reported detections on the device itself as the example below:

.. code-block:: none

   show services application-identification statistics applications
   Last Reset: 2018-04-09 09:26:11 UTC
                         Application           Sessions              Bytes    Encrypted
                             ADDTHIS                  1               3763           No
                               ADOBE                  3              16821           No
                     ADSAFEPROTECTED                  9             150719           No
                     ADVERTISING-COM                  2               9893           No
                          AMAZON-AWS                  4              83297           No
                            APPNEXUS                  4             142957           No
                      ATLASSOLUTIONS                  4              85358           No
                                 BBC                 23            1128174           No
                                BILD                  1               4321           No
                                BING                  1              15424           No
                              CRITEO                  2               9703           No
                                 DNS                366             159665           No
                         DOUBLECLICK                  3              16639           No
                        EVEREST-TECH                  1              12056           No
                     FACEBOOK-ACCESS                  3              53638           No
                              FASTLY                  3              15063           No
                      FIREFOX-UPDATE                  7              67254           No
                              GOOGLE                 14            4474099           No
               GOOGLE-ADSERVICES-SSL                 17            1259833           No
           GOOGLE-ANALYTICS-TRACKING                  1               5046           No
                       GOOGLE-STATIC                  5             136538           No
                  GOOGLE-SYNDICATION                  1              74013           No
                         GOOGLE-TAGS                  1               4386           No
                                HTTP                 95            1326135           No
                               HTTP2                 16             317633           No
                     ICMP-ECHO-REPLY              10470            1758960           No
                              LOTAME                  4              35033           No
                           MEDIAMATH                  2              17564           No
                                MOAT                  3             101439           No
                             MOZILLA                 22            2679818           No
                      NETFLIX-STREAM                  5             126135           No
                                 NTP                  2                304           No
                                OCSP                 45             222788           No
                               OPENX                  4              27403           No
                          OPTIMIZELY                  1               2745           No
                              ORACLE                  5              30619           No
                            OUTBRAIN                 18             264630           No
                               RLCDN                  1              12920           No
                      RUBICONPROJECT                 13             150966           No
                   SCORECARDRESEARCH                  2              15440           No
                       SMARTADSERVER                 10             140334           No
                             SPIEGEL                 29            2320919           No
                                 SSL                109            3327986          Yes
                                TURN                  1               5278           No
                               YAHOO                  3              29186           No
   
   show services application-identification application-system-cache
   Application System Cache Configurations:
     application-cache: on
     cache-entry-timeout: 3600 seconds
   pic: 0/0
   Logical system name: 0
   IP address: 151.101.1.194                            Port: 80     Protocol: TCP
   Application: HTTP:FASTLY                             Encrypted: No
   Classification Path: IP:TCP:HTTP:FASTLY
   
   Logical system name: 0
   IP address: 23.208.78.21                             Port: 443    Protocol: TCP
   Application: SSL:HTTP2                               Encrypted: Yes
   Classification Path: IP:TCP:SSL:HTTP2
   
   Logical system name: 0
   IP address: 107.22.187.51                            Port: 80     Protocol: TCP
   Application: HTTP                                    Encrypted: No
   Classification Path: IP:TCP:HTTP
   
   Logical system name: 0
   IP address: 152.163.51.3                             Port: 80     Protocol: TCP
   Application: HTTP:ADVERTISING-COM                    Encrypted: No
   Classification Path: IP:TCP:HTTP:ADVERTISING-COM
   
   Logical system name: 0
   IP address: 172.217.17.66                            Port: 443    Protocol: TCP
   Application: SSL:HTTP2                               Encrypted: Yes
   Classification Path: IP:TCP:SSL:HTTP2
   
   Logical system name: 0
   IP address: 54.213.189.248                           Port: 80     Protocol: TCP
   Application: HTTP                                    Encrypted: No
   Classification Path: IP:TCP:HTTP
   
   Logical system name: 0
   IP address: 185.29.135.233                           Port: 443    Protocol: TCP
   Application: SSL:MEDIAMATH                           Encrypted: Yes
   Classification Path: IP:TCP:SSL:MEDIAMATH
   
   Logical system name: 0
   IP address: 52.59.167.114                            Port: 443    Protocol: TCP
   Application: SSL                                     Encrypted: Yes
   Classification Path: IP:TCP:SSL
   
   Logical system name: 0
   IP address: 54.230.15.239                            Port: 80     Protocol: TCP
   Application: HTTP:OCSP                               Encrypted: No
   Classification Path: IP:TCP:HTTP:OCSP
   
   Logical system name: 0
   IP address: 52.88.246.100                            Port: 443    Protocol: TCP
   Application: SSL:MOZILLA                             Encrypted: Yes
   Classification Path: IP:TCP:SSL:MOZILLA
   
   Logical system name: 0
   IP address: 54.173.248.228                           Port: 80     Protocol: TCP
   Application: HTTP                                    Encrypted: No
   Classification Path: IP:TCP:HTTP
   
   Logical system name: 0
   IP address: 69.172.216.55                            Port: 443    Protocol: TCP
   Application: SSL:ADSAFEPROTECTED                     Encrypted: Yes
   Classification Path: IP:TCP:SSL:ADSAFEPROTECTED
   
   Logical system name: 0
   IP address: 172.217.20.98                            Port: 80     Protocol: TCP
   Application: HTTP:GOOGLE-SYNDICATION                 Encrypted: No
   Classification Path: IP:TCP:HTTP:GOOGLE-SYNDICATION
   
   Logical system name: 0
   IP address: 52.36.130.57                             Port: 443    Protocol: TCP
   Application: SSL:NETFLIX-STREAM                      Encrypted: Yes
   Classification Path: IP:TCP:SSL:NETFLIX-STREAM
   .
   .
   . (output truncated here)

Static SD-WAN policy
~~~~~~~~~~~~~~~~~~~~

If only the path preference (MPLS or Internet) is defined and none of the SLA parameters are defined in the SLA profile, then the policy is called a **static SLA policy**.

.. note:: The screen-shot below was taken from an older CSO version.

|image297|

In static policies, if the defined WAN link under path preference is unable to meet the SLA requirements, link switching cannot occur and SLA performance deteriorates.

The Application is sticky to the link.

However if the link fully breaks a switchover happens as there is otherwise no remaining path.

After switchover, when the original link is restored, a switch-back will automatically happen in the nominal case if you don’t change the advised configuration below.

With CSO >= 4.0.1 and Secure OAM used (we always do that in this lab) you can finally also interrupt the WAN_0 Link without affecting the entire device operation (because of the new additional OAM IPsec Tunnels). This was not advisable in the previous versions.

BEFORE you can use any SD-WAN Profiles the SP-Admin has to activate at least one! With a default CSO V3.3 installation NONE is ACTIVATED and you would get an error message like below:

|image298|

Change to the “All Tenants” view

|image299|

Go to Configuration -> Application Traffic Type Profiles -> Select one Profile (Internet)

.. note:: You can’t enable all profiles at the same time because of overlapping config.

|image300|

Edit the profile

|image301|

Change the status to Enable (blue) and press “OK”

|image302|

Do this with other profiles as well if you like but you need to have at least one!

After you have enabled (or created ones) a few profiles switch back to the Tenant view.

|image303|

Now create an application profile first that is static towards internet-link.

|image304|

Setup the Profile exactly as below and do not enter any other values not to make it a dynamic profile by accident. Make sure you enable Failover!!!

|image305|

|image306|

|image307|

|image308|

|image309|

|image310|

|image311|

.. warning:: Do not use/configure overlapping or the same services between this and the next Chapter. Also do NOT REUSE services between the two chapters. **Use one service for one lab and another service for the next lab.** If you don’t follow this practice you may run into issue with deleting policies or getting them wrong displayed. You’ve been warned!

|image312|

|image313|

|image314|

|image315|

|image316|

|image317|

It is now needed to deploy your policy else it is not implemented on the device.

|image318|

WAIT until the policy deployment is successfully done!

|image319|

Then go to the appropriate Desktop VM and browse to YouTube as we have configured it.

|image320|

Let a video run in a continuous loop so that the browser will generate traffic.

If you review the link performance and applications for the device.

Make sure that you are aware of the different scaling of those traffic statistics similar to the example blow as the first line is only Kilobytes but seem to be higher but the second is scaled in Megabytes so has much more traffic.

|image321|

Remember there is a lag/delay of minimum 3 minutes until you will see a change on the links and their throughput.

Check the WAN_1 link before (or shortly after) you started to view the video. It should hopefully show some old traffic behaviour before the video will get visible after a few minutes.

|image322|

Check back after >5minutes!!! Now you should see the traffic on the predefined link.

.. note:: The delay of not reporting the last ~4minutes is normal in the 15minutes zoom window!!!

Now login to the Delay-VM and disable the Link towards the Hub on WAN_1 (review Chapter 3.2.13 above for more details) represented by eth0.135

.. code-block:: none

   virsh console delayvm --force
   Connected to domain delayvm
   Escape character is ^]

   # you can review the traffic on the link (here from two spokes)
   root@delayvm:~# tcpdump -n -i eth0.135
   tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
   listening on eth0.135, link-type EN10MB (Ethernet), capture size 262144 bytes
   16:50:27.524771 IP 192.168.133.102.4500 > 192.168.191.254.4500: UDP-encap: ESP(spi=0xd978ce54,seq=0x56cc), length 148
   16:50:27.526551 IP 192.168.191.254.4500 > 192.168.133.102.4500: UDP-encap: ESP(spi=0xa2d47e4d,seq=0xf547), length 148
   16:50:27.727512 IP 192.168.191.254 > 192.168.173.2: ESP(spi=0x32149487,seq=0x980), length 116
   16:50:27.729576 IP 192.168.173.2 > 192.168.191.254: ESP(spi=0x7dfac7eb,seq=0x989), length 92
   16:50:27.775701 IP 192.168.133.102.4500 > 192.168.191.254.4500: UDP-encap: ESP(spi=0xd978ce54,seq=0x56cd), length 116
   16:50:27.776710 IP 192.168.191.254.4500 > 192.168.133.102.4500: UDP-encap: ESP(spi=0xa2d47e4d,seq=0xf548), length 92
   16:50:27.880264 IP 192.168.173.2 > 192.168.191.254: ESP(spi=0x7dfac7eb,seq=0x98a), length 148
   16:50:27.881829 IP 192.168.191.254 > 192.168.173.2: ESP(spi=0x32149487,seq=0x981), length 148
   16:50:27.887452 IP 192.168.191.254.4500 > 192.168.133.102.4500: UDP-encap: ESP(spi=0xa2d47e4d,seq=0xf549), length 116

   root@delayvm:~# ifconfig eth0.135 down

Traffic failover will almost immediately happen without interrupting the current Video. You can look at the device to see that.

.. code-block:: none

   root@GWR.sdwansite2.hubspoketenant> show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   ge-0/0/0                up    up
   gr-0/0/0                up    up
   gr-0/0/0.4000           up    up   inet     172.24.63.190/31
                                      mpls
   gr-0/0/0.4001           up    down inet     172.16.215.176/31
                                      mpls
   ip-0/0/0                up    up
   .
   .
   st0                     up    up
   st0.4000                up    up   inet     172.22.168.178/31
   st0.4001                up    down inet     172.22.210.92/31

Reporting in the GUI of the current event may lag/delay 1-2minutes before you see it like below

|image323|

In the overview page two tunnels will be reported down as for the WAN_1 link of the device you affected the DATA Tunnel and the Secure OAM Tunnel at the same time.

.. note:: This window sometime does refresh automatically. It’s best if you play around on the Period display like below to get the expected results.

|image324|

**You will not see a link-switch event** similar to a dynamic Policy as in the next Chapter. This is because internally a link switch is only reported when CSO inspects the information from Devices and triggers via the vRR a link-switch on the VRF that does the internal Traffic forwarding on the Spoke device.

This doesn’t happen here on a static Policy as the fail-over of the traffic is done by the device itself seeing that the GRE tunnel (and so the IPsec as well) is not avail anymore.

What you should see about the traffic (wait 10 minutes please) is that the load is now on the other link (WAN_0) as expected.

|image325|

Now heal the link and enter the following (or even reboot the VM).

.. note:: It is a absolute requirement not only to “up” the link but also add the remaining two lines of code to heal the link else it won’t work!

.. code-block:: none

   ifconfig eth0.135 up
   ip route add 192.168.135.0/24 via 192.168.135.254 dev eth0.135 table wan1hub
   ip route add default via 192.168.135.1 dev eth0.135 table wan1hub
   
   # review the relevant table id restored
   ip route show table wan1hub
   default via 192.168.135.1 dev eth0.135
   192.168.135.0/24 via 192.168.135.254 dev eth0.135

After a 1-2 minutes

|image326|

If you now look at the traffic pattern and bandwidth usage again you will see the static policy has fallen back to the preferred link.

|image327|

Dynamic SD-WAN policy
~~~~~~~~~~~~~~~~~~~~~

.. warning:: /\* fixme path preference for dynamic is now definable (CSO >= 3.3) but might not work correctly we need to add this as a second option for this lab later \*/

If one or more SLA parameters in the SLA profile are defined, then the policy is called a **dynamic SLA policy**.

.. note:: The screen-shot below was taken from an older CSO version.

|image328|

Pre CSO 3.3 all SLA parameter of a single Template form a **logical AND** condition before a switchover happens. So all parameters defined have to be violated same time!

Starting with **CSO >=3.3** the default changed to a **logical OR** and you can select between both modes when you create the SLA

|image329|

If SLA parameters are violated then **WITH A DELAY of typical ~3 Minutes** CSO will evaluate all links (over a DB) and probably issue a link-switch (though the vRR).

If you need to demonstrate faster react times then use the Realtime-Mode w. AppQoE in the expanded test case section chapter **Error! Reference source not found.**.

A link switch will only happen if the new link is not also violating the SLA already so in a demo only make one link bad at a time and not both links.

After switchover, when the original link is restored, **a switch-back will NOT automatically happen** by design.

A switch-over (or switch-back) for a dynamic SLA Policy only happens if the current link violates the SLA parameters and the new does not do that.

With CSO 4.0.1 and Secure OAM activated (which we allways do in this lab) it is now save to also interrupt the WAN_0 without impacting the device operation.

BEFORE you can use any SD-WAN Profiles the SP-Admin has to activate at least one! With a default CSO V3.3 installation NONE is ACTIVATED and you would get an error message like below:

|image330|

Change to the “All Tenants” view

|image331|

Go to Configuration -> Application Traffic Type Profiles -> Select one Profile (Video)

|image332|

Edit the profile

.. note:: You can’t enable all profiles at the same time because of overlapping config.

|image333|

Change the status to Enable (blue) and press “OK”

|image334|

Do this with other profiles as well if you like but you need to have at least one!

After you have enabled (or created ones) a few profiles switch back to the Tenant view.

|image335|

There are **two modes** that we recommend you to show in a demonstration:

#. No Path preference (and Fallback disabled)
#. A Path preference with Fallback enabled

Let’s start with the first:

Dynamic Policy with no path preference
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

This mode is kind of default as it is also avail in older versions of CSO and has the following expected behaviour:

Suppose both links are ok at the start and both don’t violate any SLA Parameter an ECMP based scheduler will select the best path (default). This means that almost RANDOMLY one of the two links will be chosen for the Traffic transport of the Application.

If the Link chosen degrades and the SLA is violated then CSO will trigger a link failover (through the vRR) towards Spoke and Hub (to keep the Traffic symmetrically) to the remaining link. Naturally the new link needs to be better and not also violate the Policy.

The Traffic will then continue to flow over the new link.

Should the old link be restored/heal or get better so that it can be used again the Application will STAY on the new Link! There is no path preference set and so any link is good until an new SLA violation happens on it and CSO need to look if there is a better path still avail.

Now create an application profile first that is dynamic for video as traffic class.

|image336|

Setup the Profile exactly as below and do not enter any other values as this is exactly what we want in a simple test-drive.

.. note:: **That we change the default parameters ONLY to look at Latency/RTT for this test.** Prior CSO 4.0.1 you could get into trouble with other parameters like packet-loss if you affect WAN_0 where your OAM Traffic also is. This should be better now so you may play around with that as well. Still for a save Demo stick to what we do here.

|image337|

.. note:: You can additionally play around with adding Packet Loss which may reduce the resolution of a Video until the link-switch has happened.Review the demo in this `Video from the BU <https://junipernetworks.sharepoint.com/:v:/s/Projects1/nethranpi/Ea-AIvTGKNRPpPcyaSOEjrEBufh4bL2x5LwzJrOdmwXfAg?e=4MWacu>`__ from minute 4:50 to 9:00 for more information. It is recommended that this tested before you show it in the PoC.

|image338|

|image339|

Add a new Policy

|image340|

|image341|

.. warning:: Do not use/configure overlapping or the same services between this and the previous Chapter. Also do NOT REUSE services between the two chapters. **Use one service for one lab and another service for the next lab.** If you don’t follow this practice you may run into issue with deleting policies or getting them wrong displayed. You’ve been warned!

|image342|

|image343|

|image344|

|image345|

|image346|

|image347|

It is now needed to deploy your policy else it is not implemented on the device.

|image348|

WAIT until the policy deployment is successfully done!

|image349|

Then go to the appropriate Desktop VM and browse and use the URL http://www.dailymotion.com as this is what we have configured to see/inspect for this Chapter.

|image350|

Let a longer video (>5min) run so that the browser will generate traffic.

Usually we try to search for “movie” and then selct something with a really long playtime. Now review the link performance and applications for the device.

Make sure that you are aware of the different scaling of those traffic statistics similar to the example blow as the first line is only Kilobytes but seem to be higher but the second is scaled in Megabytes so has much more traffic.

|image351|

Remember there is a lag/delay of minimum 3 minutes until you will see a change on the links and their throughput.

As this is a dynamic policy you now need to find out which path of WAN_0 or WAN_1 was been selected to contain the traffic. Remember in this mode the ECMP based load balancer makes this an almost random decision.

|image352|

|image353|

.. note:: For vimeo some traffic will be offloaded via Akamai-ssl so you may see this instead of the direct service-name.

So WAN_0 is having the Traffic currently.

Alternatively you can also look onto the device itself to find out to which Tunnel the taffic is currently directed to like this:

.. code-block:: none

   # identify the application name and if there is taffic detected
   show services application-identification statistics applications
   Last Reset: 2018-08-22 15:50:50 CEST
                         Application           Sessions              Bytes    Encrypted
                             ADDTHIS                  1               7082           No
                              ADFORM                  4              34858           No
                     ADVERTISING-COM                  8              67692           No
                              AMAZON                 26             888502           No
                     AMAZON-ADSYSTEM                  2              21252           No
                          AMAZON-AWS                  5              15036           No
        ANDROID-MARKETPLACE-DOWNLOAD                  1              12329           No
                             AOL-ONE                 10             217983           No
                            APPNEXUS                 32             618490           No
                           BIDSWITCH                  3              28119           No
                                BING                  1              10453           No
                          CLOUDFLARE                  7              82021           No
                              CRITEO                  1               6125           No
                         DAILYMOTION                271          135359382           No
                                 DNS               1964             459032           No
   .
   .
   .

   # Review the configuration for the application to fine the traffic rule that CSO has generated for it
   show configuration | display set | match DAILYMOTION
   set groups nfx-gwr-apbr-policy-config security advance-policy-based-routing profile pr_apbr_Default rule r_apbr_d_Default_p_Intent-2_s_dynamicvideo match dynamic-application junos:DAILYMOTION-UPLOAD
   set groups nfx-gwr-apbr-policy-config security advance-policy-based-routing profile pr_apbr_Default rule r_apbr_d_Default_p_Intent-2_s_dynamicvideo match dynamic-application junos:DAILYMOTION
   set groups nfx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-2_s_dynamicvideo match application junos:DAILYMOTION-UPLOAD
   set groups nfx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-2_s_dynamicvideo match application junos:DAILYMOTION

   # check the traffic rule config to find which routing instance is used for the traffic
   show configuration | display set | match r_apbr_d_Default_p_Intent-2_s_dynamicvideo
   set groups nfx-gwr-apbr-policy-config security advance-policy-based-routing profile pr_apbr_Default rule r_apbr_d_Default_p_Intent-2_s_dynamicvideo match dynamic-application junos:DAILYMOTION-UPLOAD
   set groups nfx-gwr-apbr-policy-config security advance-policy-based-routing profile pr_apbr_Default rule r_apbr_d_Default_p_Intent-2_s_dynamicvideo match dynamic-application junos:DAILYMOTION
   set groups nfx-gwr-apbr-policy-config security advance-policy-based-routing profile pr_apbr_Default rule r_apbr_d_Default_p_Intent-2_s_dynamicvideo then routing-instance TC1-hubspoketenant_DefaultVPN

   # Now check the current routing table inside this instance
   show route table TC1-hubspoketenant_DefaultVPN

   TC1-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 00:50:47, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 19  <- This is your current active Datapath for this application
                       [Static/175] 23:50:15
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 23:50:15
                         to table LAN-hubspoketenant_DefaultVPN.inet.0

   show services rpm probe-results

Now login to the Delay-VM and add a Traffic class delay command to the appropriate link toward the hub which (review Chapter 3.2.13 above for more details).

-  To make WAN_0 “bad” use eth0.132
-  To make WAN_1 “bad” use eth0.135

Change the command below if you need:

.. code-block:: none

   virsh console delayvm --force
   Connected to domain delayvm
   Escape character is ^]

   # you can review the traffic on the link (here from two spokes)
   root@delayvm:~# tcpdump -n -i eth0.135
   tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
   listening on eth0.135, link-type EN10MB (Ethernet), capture size 262144 bytes
   16:50:27.524771 IP 192.168.133.102.4500 > 192.168.191.254.4500: UDP-encap: ESP(spi=0xd978ce54,seq=0x56cc), length 148
   16:50:27.526551 IP 192.168.191.254.4500 > 192.168.133.102.4500: UDP-encap: ESP(spi=0xa2d47e4d,seq=0xf547), length 148
   16:50:27.727512 IP 192.168.191.254 > 192.168.173.2: ESP(spi=0x32149487,seq=0x980), length 116
   16:50:27.729576 IP 192.168.173.2 > 192.168.191.254: ESP(spi=0x7dfac7eb,seq=0x989), length 92
   16:50:27.775701 IP 192.168.133.102.4500 > 192.168.191.254.4500: UDP-encap: ESP(spi=0xd978ce54,seq=0x56cd), length 116
   16:50:27.776710 IP 192.168.191.254.4500 > 192.168.133.102.4500: UDP-encap: ESP(spi=0xa2d47e4d,seq=0xf548), length 92
   16:50:27.880264 IP 192.168.173.2 > 192.168.191.254: ESP(spi=0x7dfac7eb,seq=0x98a), length 148
   16:50:27.881829 IP 192.168.191.254 > 192.168.173.2: ESP(spi=0x32149487,seq=0x981), length 148
   16:50:27.887452 IP 192.168.191.254.4500 > 192.168.133.102.4500: UDP-encap: ESP(spi=0xa2d47e4d,seq=0xf549), length 116

   root@delayvm:~# tc qdisc add dev eth0.135 root netem delay 100ms

.. note:: It will take **more than 3 minutes** until you will see the impact of this command in the GUI. If you are very hasty and want to review it earlier check the values on the device please

.. code-block:: none

   show services rpm probe-results
       Owner: 2865acf4b621bb7bc3e999567091b74f, Test: test-icmp-ping
       Target address: 172.16.215.177, Probe type: icmp-ping
       Routing Instance Name: transit
       Destination interface name: gr-0/0/0.4001    # belongs to WAN1
       Test size: 5 probes
       Probe results:
         Response received
         Tue Apr 10 08:28:28 2018
         Tue Apr 10 08:28:28 2018, No hardware timestamps
         Rtt: 2026 usec, Round trip jitter: 169 usec,     # still good ~2ms
         Round trip interarrival jitter: 355 usec
       Results over current test:
         Probes sent: 4, Probes received: 4, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 4, Minimum: 1857 usec, Maximum: 2969 usec, Average: 2190 usec,
           Peak to peak: 1112 usec, Stddev: 454 usec, Sum: 8760 usec
         Measurement: Positive round trip jitter
           Samples: 2, Minimum: 169 usec, Maximum: 1061 usec, Average: 615 usec,
           Peak to peak: 892 usec, Stddev: 446 usec, Sum: 1230 usec
         Measurement: Negative round trip jitter
           Samples: 2, Minimum: 76 usec, Maximum: 1112 usec, Average: 594 usec,
           Peak to peak: 1036 usec, Stddev: 518 usec, Sum: 1188 usec
       Results over last test:
         Probes sent: 5, Probes received: 5, Loss percentage: 0.000000
         Test completed on Tue Apr 10 08:27:53 2018
         Measurement: Round trip time
           Samples: 5, Minimum: 1948 usec, Maximum: 2117 usec, Average: 2022 usec,
           Peak to peak: 169 usec, Stddev: 58 usec, Sum: 10111 usec
         Measurement: Positive round trip jitter
           Samples: 3, Minimum: 14 usec, Maximum: 103 usec, Average: 51 usec,
           Peak to peak: 89 usec, Stddev: 38 usec, Sum: 153 usec
         Measurement: Negative round trip jitter
           Samples: 2, Minimum: 69 usec, Maximum: 100 usec, Average: 85 usec,
           Peak to peak: 31 usec, Stddev: 16 usec, Sum: 169 usec
       Results over all tests:
         Probes sent: 9109, Probes received: 8937, Loss percentage: 1.888242
         Measurement: Round trip time
           Samples: 8937, Minimum: 1582 usec, Maximum: 29383 usec,
           Average: 2286 usec, Peak to peak: 27801 usec, Stddev: 1032 usec,
           Sum: 20429090 usec
         Measurement: Positive round trip jitter
           Samples: 4518, Minimum: 0 usec, Maximum: 27175 usec, Average: 483 usec,
           Peak to peak: 27175 usec, Stddev: 1281 usec, Sum: 2182955 usec
         Measurement: Negative round trip jitter
           Samples: 4418, Minimum: 1 usec, Maximum: 26977 usec, Average: 494 usec,
           Peak to peak: 26976 usec, Stddev: 1312 usec, Sum: 2183057 usec
   
       Owner: 656edd19527963652559fcf6c35f27ae, Test: test-icmp-ping
       Target address: 172.24.63.191, Probe type: icmp-ping
       Routing Instance Name: transit
       Destination interface name: gr-0/0/0.4000    # belongs to WAN0
       Test size: 5 probes
       Probe results:
         Response received
         Tue Apr 10 08:28:28 2018
         Tue Apr 10 08:28:28 2018, No hardware timestamps
         Rtt: 101917 usec, Round trip jitter: 294 usec,    # bad now >100ms
         Round trip interarrival jitter: 2359 usec
       Results over current test:
         Probes sent: 4, Probes received: 4, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 4, Minimum: 101602 usec, Maximum: 101917 usec,
           Average: 101740 usec, Peak to peak: 315 usec, Stddev: 132 usec,
           Sum: 406960 usec
         Measurement: Positive round trip jitter
           Samples: 2, Minimum: 216 usec, Maximum: 294 usec, Average: 255 usec,
           Peak to peak: 78 usec, Stddev: 39 usec, Sum: 510 usec
         Measurement: Negative round trip jitter
           Samples: 2, Minimum: 117 usec, Maximum: 195 usec, Average: 156 usec,
           Peak to peak: 78 usec, Stddev: 39 usec, Sum: 312 usec
       Results over last test:
         Probes sent: 5, Probes received: 5, Loss percentage: 0.000000
         Test completed on Tue Apr 10 08:27:53 2018
         Measurement: Round trip time
           Samples: 5, Minimum: 101599 usec, Maximum: 101739 usec,
           Average: 101668 usec, Peak to peak: 140 usec, Stddev: 57 usec,
           Sum: 508339 usec
         Measurement: Positive round trip jitter
           Samples: 2, Minimum: 120 usec, Maximum: 132 usec, Average: 126 usec,
           Peak to peak: 12 usec, Stddev: 6 usec, Sum: 252 usec
         Measurement: Negative round trip jitter
           Samples: 3, Minimum: 25 usec, Maximum: 140 usec, Average: 78 usec,
           Peak to peak: 115 usec, Stddev: 47 usec, Sum: 233 usec
       Results over all tests:
         Probes sent: 9144, Probes received: 9134, Loss percentage: 0.109361
         Measurement: Round trip time
           Samples: 9134, Minimum: 1012 usec, Maximum: 102044 usec,
           Average: 1884 usec, Peak to peak: 101032 usec, Stddev: 4319 usec,
           Sum: 17210315 usec
         Measurement: Positive round trip jitter
           Samples: 4582, Minimum: 0 usec, Maximum: 100102 usec, Average: 153 usec,
           Peak to peak: 100102 usec, Stddev: 1510 usec, Sum: 702331 usec
         Measurement: Negative round trip jitter
           Samples: 4551, Minimum: 1 usec, Maximum: 6652 usec, Average: 132 usec,
           Peak to peak: 6651 usec, Stddev: 317 usec, Sum: 602171 usec
   

Ignore the Latency report in the global view as it is for BOTH links together. Wait until you see the link-switch happen.

|image354|

|image355|

Now review the link switch events. Here we had two devices active and as we made the WAN_0 path bad to the same link to the Hub they both switched.

|image356|

You can also re-check the Spoke VRF Table for this traffic for the change

.. code-block:: none

   show route table TC1-hubspoketenant_DefaultVPN

   TC1-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 00:01:17, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 19 <- This is your new Datapath
                       [Static/175] 1d 00:14:21
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 1d 00:14:21
                         to table LAN-hubspoketenant_DefaultVPN.inet.0

After you’ve reviewed everything “heal” the formerly bad link so that both links are good again.

.. code-block:: none

   root@delayvm:~# tc qdisc del dev eth0.135 root netem

As stated above a switch-back will not happen due to the current design as link-preference is only for static SLA Policies!

(optional) Dynamic Policy with path preference and Fallback enabled
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The next item you may show is the path preference for an Application.

Here we edit the existing config from the last chapter for ease:

|image357|

|image358|

Change these two parameters

|image359|

|image360|

Deploy your changes!!!

|image361|

Wait until the changed policy is applied.

|image362|

Now re-do the same as in the previous chapter.

Play a longer video from Dailymotion.com

Here you should see the traffic on the Internet link per default

.. code-block:: none

   show route table TC1-hubspoketenant_DefaultVPN

   TC1-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 00:29:40, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 19
                       [Static/175] 1d 00:49:59
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 1d 00:49:59
                         to table LAN-hubspoketenant_DefaultVPN.inet.0

|image363|

Go to the delayvm and issue

.. code-block:: none

   root@delayvm:~# tc qdisc add dev eth0.135 root netem delay 100ms

Wait the 3 minutes until the link switch occurs

|image364|

Verify its new destination in the routing table on the device.

.. code-block:: none

   show route table TC1-hubspoketenant_DefaultVPN

   TC1-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 00:01:12, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 19
                       [Static/175] 1d 01:05:31
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 1d 01:05:31
                         to table LAN-hubspoketenant_DefaultVPN.inet.0

Go again to the delayVM and remove the latency configuration

.. code-block:: none

   root@delayvm:~# tc qdisc del dev eth0.135 root netem

After the usyal waitng time of 3 minutes you now see the link has flipped back to the original link that you configured as preferred path.

.. code-block:: none

   show route table TC1-hubspoketenant_DefaultVPN

   TC1-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 00:02:28, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 19
                       [Static/175] 1d 01:14:49
                         to table Default-hubspoketenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 1d 01:14:49
                         to table LAN-hubspoketenant_DefaultVPN.inet.0

|image365|

Review the link switch events

|image366|

|image367|

(optional) DSCP-Field re-writing and copying to outer Tunnel
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note:: This test case is HIGHLY **RECOMMENDED if your audience is an SP** with an own MPLS-Network. They are looking for those features to augment their invest in MPLS with it’s QoS capabilities.

.. warning:: There are known issues with previous Junos Versions (CXU-31843) ! Make sure you have D170 or higher that are shipped with CSO 4.1!

This can also be the answer to the question of “SD-WAN QoS-Support (for MPLS)”.

The SP (see example below) can configure SLA Traffic Profiles that contain DSCP values of QoS Profiles HE utilizes in his MPLS network. The Tenant can then use these Profiles for his application SLAs. The Juniper SD-WAN detects the Application and re-writes the DSCP Value according to the Profile. The inside DSCP Values are also wrapped to the outside GRE or IPsec Transport Tunnel used by SD-WAN. THIS enables the MPLS Network to recognize the QoS to be apply based on these DSCP values!

The benefit of this is that wherever the Packtes enter the MPLS Network the DSCP values can be recognized and used inside the MPLS network to prioritize this Traffic. Even after the Hub, when the Tunnels are taken away, the rewritten DSCP Values remain on the Traffic and can be further used in the Network.

.. note:: This is currently only working when the packet is send from Spoke to Hub and not in the reverse direction.

First go to the global view and show again that two Application Traffic Profiles have been enabled by the cspadmin. For this test we will use “Voice-Video” and the default value should be “af41”. We don’t need to change any of those values as we don’t really have an MPLS network that will work based on these values. For the demo it is enough to show that these values are changed and signalled to the Tunnel. It is assumed that the MPLS network will use them to threat the Traffic accordingly.

|image368|

Go back to the Tenant View and create a and create a new Application SLA Profile.

|image369|

|image370|

Here it is important to use the predefined Traffic Type Profile “Voice-Video” and set “MPLS” as Path Preference for this demo.

|image371|

Then create an a new SD-WAN Policy for ssh-traffic

|image372|

|image373|

Deploy your changes

|image374|

Wait until this is done

|image375|

Now use VNC to Desktop 2/4 whatever is connected and open a Terminal there. Use SSH to login into the CSO-Host itself

|image376|

Inside this ssh-connection issue a ping to internet with a shorter interval then the usual 1 second like below

.. code-block:: none

   ping -i 0.2 8.8.8.8

|image377|

Let this continously run!

This will now generate a constant stream of ssh-packtes as the reporting of the output will be send back to the Spoke inside this connection.

Now let’s hop onto the delayvm and inspect the transient Traffic between Spoke and Hub. As we configured the traffic to use the MPLS path we should see the Traffic on “eth0.132” and not “eth0.135” . Issue a tcpdump like below and inspect the traffic.

.. code-block:: none

   virsh console delayvm --force
   Connected to domain delayvm
   Escape character is ^]

   root@delayvm:~# tcpdump -i eth0.132 -nvv dst host 192.168.190.254
   tcpdump: listening on eth0.132, link-type EN10MB (Ethernet), capture size 262144 bytes
   09:26:39.764525 IP (tos 0x88, ttl 61, id 40129, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d16), length 116
   09:26:39.966339 IP (tos 0x88, ttl 61, id 40130, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d17), length 116
   09:26:40.166451 IP (tos 0x88, ttl 61, id 40131, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d18), length 116
   09:26:40.170184 IP (tos 0xc0, ttl 61, id 28098, offset 0, flags [none], proto ESP (50), length 136)
       192.168.150.2 > 192.168.190.254: ESP(spi=0xb44b22fb,seq=0x3ae), length 116
   09:26:40.367594 IP (tos 0x88, ttl 61, id 40132, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d19), length 116
   09:26:40.555968 IP (tos 0xc0, ttl 61, id 40133, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d1a), length 116
   09:26:40.566913 IP (tos 0x88, ttl 61, id 40134, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d1b), length 116
   09:26:40.595993 IP (tos 0xc0, ttl 61, id 40135, offset 0, flags [none], proto ESP (50), length 108)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d1c), length 88
   09:26:40.767672 IP (tos 0x88, ttl 61, id 40136, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d1d), length 116
   09:26:40.967991 IP (tos 0x88, ttl 61, id 40137, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d1e), length 116
   09:26:41.168557 IP (tos 0x88, ttl 61, id 40138, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d1f), length 116
   09:26:41.369097 IP (tos 0x88, ttl 61, id 40139, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d20), length 116
   09:26:41.424387 IP (tos 0x0, ttl 61, id 40140, offset 0, flags [none], proto ESP (50), length 112)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d21), length 92
   09:26:41.569582 IP (tos 0x88, ttl 61, id 40141, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d22), length 116
   09:26:41.733580 IP (tos 0x0, ttl 61, id 28099, offset 0, flags [none], proto ESP (50), length 112)
       192.168.150.2 > 192.168.190.254: ESP(spi=0xb44b22fb,seq=0x3af), length 92
   09:26:41.770079 IP (tos 0x88, ttl 61, id 40142, offset 0, flags [none], proto ESP (50), length 136)
       192.168.130.2 > 192.168.190.254: ESP(spi=0x1377a4d0,seq=0x1d23), length 116

The majority of the Traffic should have a ToS-Field set to 0x88 which is equal to DSCP-Value=af41 when the ECN bits are not used. See Table https://www.tucny.com/home/dscp-tos

.. note:: The Traffic you see marked as 0xc0 is control Traffic to the OAM-Hub (mostly syslog) as in our Lab OAM-Hub and Data-Hub are the same devices. You can identify the two tunnels by the different spi-values of the ESP IPsec payload.

The final test is to look now on the CSO-Host if the Packets still have these DSCP-Values after the Tunnel has been Terminated on the Hub. So open a shell to the cso-host (or exit the delay vm). Dependent on which Desktop VM you are using you must create the right filter (Desktop2=10.88.88.88 and Desktop4=10.66.66.66)

.. code-block:: none

   root@cso-host:~# tcpdump -ni virbr0 -c 10 -vv src host 10.66.66.66
   tcpdump: listening on virbr0, link-type EN10MB (Ethernet), capture size 65535 bytes
   01:48:22.277860 IP (tos 0x10, ttl 64, id 44354, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0x175d (incorrect -> 0xec4a), seq 2462759951, ack 2507326587, win 344, options [nop,nop,TS val 1676347899 ecr 558059815], length 0
   01:48:22.278170 IP (tos 0x88, ttl 61, id 44354, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0xec4a (correct), seq 0, ack 1, win 344, options [nop,nop,TS val 1676347899 ecr 558059815], length 0
   01:48:22.278246 IP (tos 0x88, ttl 60, id 44354, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0xec4a (correct), seq 0, ack 1, win 344, options [nop,nop,TS val 1676347899 ecr 558059815], length 0
   01:48:22.478374 IP (tos 0x10, ttl 64, id 44355, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0x175d (incorrect -> 0xeaeb), seq 0, ack 101, win 344, options [nop,nop,TS val 1676348100 ecr 558059865], length 0
   01:48:22.478740 IP (tos 0x88, ttl 61, id 44355, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0xeaeb (correct), seq 0, ack 101, win 344, options [nop,nop,TS val 1676348100 ecr 558059865], length 0
   01:48:22.478818 IP (tos 0x88, ttl 60, id 44355, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0xeaeb (correct), seq 0, ack 101, win 344, options [nop,nop,TS val 1676348100 ecr 558059865], length 0
   01:48:22.679087 IP (tos 0x10, ttl 64, id 44356, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0x175d (incorrect -> 0xe98c), seq 0, ack 201, win 344, options [nop,nop,TS val 1676348301 ecr 558059915], length 0
   01:48:22.679438 IP (tos 0x88, ttl 61, id 44356, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0xe98c (correct), seq 0, ack 201, win 344, options [nop,nop,TS val 1676348301 ecr 558059915], length 0
   01:48:22.679570 IP (tos 0x88, ttl 60, id 44356, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0xe98c (correct), seq 0, ack 201, win 344, options [nop,nop,TS val 1676348301 ecr 558059915], length 0
   01:48:22.879619 IP (tos 0x10, ttl 64, id 44357, offset 0, flags [DF], proto TCP (6), length 52)
       10.66.66.66.59572 > 192.168.10.10.22: Flags [.], cksum 0x175d (incorrect -> 0xe82d), seq 0, ack 301, win 344, options [nop,nop,TS val 1676348501 ecr 558059966], length 0
   10 packets captured
   15 packets received by filter
   0 packets dropped by kernel

For reference we are here listing the actual configuration on the device below:

.. hidden-code-block:: none

   
   set groups app-qoe-sdwanspoke2 class-of-service classifiers dscp DSCP forwarding-class INTERNET loss-priority high code-points af11
   set groups app-qoe-sdwanspoke2 class-of-service classifiers dscp DSCP forwarding-class VOICE-VIDEO loss-priority high code-points af41
   set groups app-qoe-sdwanspoke2 class-of-service classifiers dscp DSCP forwarding-class CONTROL loss-priority low code-points cs6
   set groups app-qoe-sdwanspoke2 class-of-service classifiers dscp DSCP forwarding-class OAM loss-priority low code-points af21
   set groups app-qoe-sdwanspoke2 class-of-service host-outbound-traffic forwarding-class CONTROL
   set groups app-qoe-sdwanspoke2 class-of-service host-outbound-traffic dscp-code-point cs6
   set groups app-qoe-sdwanspoke2 class-of-service forwarding-classes queue 0 INTERNET
   set groups app-qoe-sdwanspoke2 class-of-service forwarding-classes queue 1 VOICE-VIDEO
   set groups app-qoe-sdwanspoke2 class-of-service forwarding-classes queue 3 CONTROL
   set groups app-qoe-sdwanspoke2 class-of-service forwarding-classes queue 5 OAM
   set groups app-qoe-sdwanspoke2 class-of-service interfaces gr-0/0/0 unit * classifiers dscp DSCP
   set groups app-qoe-sdwanspoke2 class-of-service interfaces gr-0/0/0 unit * rewrite-rules dscp DSCP-RW
   set groups app-qoe-sdwanspoke2 class-of-service interfaces st0 unit * classifiers dscp DSCP
   set groups app-qoe-sdwanspoke2 class-of-service interfaces st0 unit * rewrite-rules dscp DSCP-RW
   set groups app-qoe-sdwanspoke2 class-of-service rewrite-rules dscp DSCP-RW forwarding-class INTERNET loss-priority high code-point af11
   set groups app-qoe-sdwanspoke2 class-of-service rewrite-rules dscp DSCP-RW forwarding-class VOICE-VIDEO loss-priority high code-point af41
   set groups app-qoe-sdwanspoke2 class-of-service rewrite-rules dscp DSCP-RW forwarding-class OAM loss-priority low code-point af21
   set groups app-qoe-sdwanspoke2 class-of-service scheduler-maps sched-map forwarding-class INTERNET scheduler QOS-INTERNET-QGRP
   set groups app-qoe-sdwanspoke2 class-of-service scheduler-maps sched-map forwarding-class VOICE-VIDEO scheduler QOS-VOICE-VIDEO-QGRP
   set groups app-qoe-sdwanspoke2 class-of-service scheduler-maps sched-map forwarding-class CONTROL scheduler QOS-CONTROL-QGRP
   set groups app-qoe-sdwanspoke2 class-of-service scheduler-maps sched-map forwarding-class OAM scheduler QOS-OAM-QGRP
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-INTERNET-QGRP transmit-rate percent 15
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-INTERNET-QGRP shaping-rate percent 20
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-INTERNET-QGRP buffer-size percent 5
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-INTERNET-QGRP priority low
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-VOICE-VIDEO-QGRP transmit-rate percent 20
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-VOICE-VIDEO-QGRP shaping-rate percent 20
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-VOICE-VIDEO-QGRP buffer-size percent 5
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-VOICE-VIDEO-QGRP priority low
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-CONTROL-QGRP transmit-rate percent 5
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-CONTROL-QGRP buffer-size percent 5
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-CONTROL-QGRP priority high
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-OAM-QGRP transmit-rate percent 2
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-OAM-QGRP buffer-size percent 2
   set groups app-qoe-sdwanspoke2 class-of-service schedulers QOS-OAM-QGRP priority low
   
   set groups nfx-gwr-cos-policy-config security policies from-zone <Default> to-zone <trust> policy <*> then permit application-services application-traffic-control rule-set pr_cos_Default
   set groups nfx-gwr-cos-policy-config security policies from-zone <Default> to-zone <untrust> policy <*> then permit application-services application-traffic-control rule-set pr_cos_Default
   set groups nfx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-1_s_signalqos match application junos:SSH
   set groups nfx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-1_s_signalqos then forwarding-class VOICE-VIDEO
   set groups nfx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-1_s_signalqos then dscp-code-point af41
   set groups nfx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-1_s_signalqos then log
   
   set groups hubspoketenant_SDWANSPOKE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 security zones security-zone trust interfaces gr-0/0/0.4001
   set groups hubspoketenant_SDWANSPOKE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 tunnel source 10.144.0.65
   set groups hubspoketenant_SDWANSPOKE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 tunnel destination 10.144.0.64
   set groups hubspoketenant_SDWANSPOKE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 tunnel routing-instance destination transit
   set groups hubspoketenant_SDWANSPOKE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 family inet address 10.152.0.65/31
   set groups hubspoketenant_SDWANSPOKE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 family mpls
   set groups hubspoketenant_SDWANSPOKE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 copy-tos-to-outer-ip-header
   

Security feature related Test-cases for SD-WAN
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

This is where Juniper can play its true **advantage against the competition** because they mostly lack those features because they aren’t security vendors.

Try to play this card and execute those test cases with the customer if the time permits.

.. note:: A condition for all these tests is that you have at least ONE already active Spoke executing Chapter 6.2 or 6.5 (an active NFX250 is preferred).

As a preparation please review the demo in this `Video from the BU <https://junipernetworks.sharepoint.com/:v:/s/Projects1/nethranpi/Ea-AIvTGKNRPpPcyaSOEjrEBufh4bL2x5LwzJrOdmwXfAg?e=4MWacu>`__ from minute 11:50 to 25:10 or show it to the customer if you don’t have time for those test case execution.

Intend based Firewall Policy
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Why Intent based Firewall

-  Policy based on business objects like Sites, Departments, Applications, etc.
-  Connectivity agnostic policy definition

   -  User need not know the zones, interfaces, breakout

-  Auto ordering of rules

   -  Policy is analyzed and rules are placed in correct order
   -  Specific rules are placed before generic rules

-  Auto-deployment on topology changes (e.g. new sites, new departments, new Lan-segments, etc.)

Our Policy Endpoints are:

-  Source Endpoints

   -  Internet
   -  Addresses
   -  Users
   -  Locations (Site/Site Groups/Departments)

-  Destination Endpoints

   -  Addresses
   -  Locations
   -  Applications (L4/L7)

-  Advanced Security (UTM)
-  Other Options (Logging/Schedulers)

In this test case we leave it to you what firewall policies you want to create for demonstration purposes. Please make heavy usage of Sites (which represent as Branch location) or Departments with is an IP-Subnet on an interface of one or more Sites. This will show the Power of the abstraction we have when you create such policy and when the system grows and you add new devices they are automatically applied to those as well. Below is an example of such a filter.

|image378|

Keep in mind that that after all changes are made you have to deploy the ruleset onto the existing devices.

|image379|

Wait until everything is deployed ok.

|image380|

Then you can go to a Spoke-Device and show the deployed Firewall policy individual rendered for the device during deploy.

.. code-block:: none

   show configuration security policies from-zone Default to-zone trust
   policy Intent_2 {
       match {
           source-address any;
           destination-address any;
           application any;
       }
       then {
           permit {
               application-services {
                   utm-policy myutmprofile;
               }
           }
       }
   }

The Zone **Default** represents the Department and should be on every device if you have not changed or created a new department for the first interface of the device during setup in the dialogue below.

|image381|

You can also show the ability to schedule the deployment of Firewall rulesets at a given time/date here:

|image382|

NAT
^^^

.. warning:: /\* fixme test case has to be developed \*/

Which NAT types do we support:

-  Auto-NAT:

   -  Source NAT rules are automatically created if indicated during site onboarding
   -  Auto-NAT rules can be over-ridden with manually configured source NAT rules.

-  All 3 NAT types supported on spokes (only source at Hubs):

   -  Source NAT: with NAT Pools and Persistence (in advanced settings).
   -  Static NAT: Mapped Port and Routing Instance (for translated address).
   -  Destination NAT

-  Auto Proxy-Arp management can be enabled at NAT policy level.

SSL-Proxy Test-case
^^^^^^^^^^^^^^^^^^^

.. warning:: Caution: This Test case can NOT be executed on a SRX300/320 as Spoke. Use the NFX250 of the Lab or a SRX345 if you happen to have one as Spoke.

.. note:: If the device for this test is an Hardware SRX you need to manually install the default certificates to **avoid a Bug** in CSO 4.0.1. More details are given in chapter 2.12 above.

Why is this test-case important to customers:

-  Most of the traffic is HTTPS traffic
-  To be able to detect some nested apps (FACEBOOK-CHAT, FACEBOOK-BIGPHOTO, etc.), traffic needs to be decrypted
-  Our SSL Proxy on CPE will terminate HTTPS connection
-  Decrypted traffic can then go through deep-inspection engine
-  Now new and better decision can be made selectively to drop some nested apps (like FACEBOOK-CHAT) but allow FACEBOOK-BIGPHOTO

.. note:: In the regular environment the certificates we use will have to be generated in the Enterprise CA of the Customer. It is also expected that the Enterprise CA is known and loaded already to the Browser of the Employee. This will make it possible to use the local proxy without loading certificates which we have to do in this lab. How this pre-loading archived is out of scope for this PoC as Test case and we use self-signed certificates instead.

First you need to generate a self-signed certificate for the ssl-proxy on the spoke device. This will then be needed to be uploaded to CSO so that CSO can re-distribute this to the Spokes with the local proxy. As a result the SD-WAN IDP can work on encrypted SSL traffic and analyse deeper.

You can also just use the pre-generated cert below and import it without need to generate one:

.. code-block:: none

   apt-get -y install openssl
   
   mkdir -p /etc/pki/tls/keys 
   mkdir -p /etc/pki/tls/certs 
   cd /etc/pki/tls 
   
   # Create a CA certificate key:
   openssl genrsa -des3 -out keys/ssl-proxy-ca.key 2048 
   Generating RSA private key, 2048 bit long modulus
   .........+++
   ...........................................................................................+++
   e is 65537 (0x10001)
   Enter pass phrase for keys/ssl-proxy-ca.key:juniper123
   Verifying - Enter pass phrase for keys/ssl-proxy-ca.key:juniper123


   # Create a CA certificate based on the CA private key (created in the previous step):
   openssl req -new -x509 -days 1095 -key keys/ssl-proxy-ca.key -out certs/ssl-inspect-ca.cer 
   Enter pass phrase for keys/ssl-proxy-ca.key:juniper123
   You are about to be asked to enter information that will be incorporated
   into your certificate request.
   What you are about to enter is what is called a Distinguished Name or a DN.
   There are quite a few fields but you can leave some blank
   For some fields there will be a default value,
   If you enter '.', the field will be left blank.
   -----
   Country Name (2 letter code) [AU]:NL
   State or Province Name (full name) [Some-State]:Amsterdam
   Locality Name (eg, city) []:Amsterdam
   Organization Name (eg, company) [Internet Widgits Pty Ltd]:Juniper TEST
   Organizational Unit Name (eg, section) []:ASTT
   Common Name (e.g. server FQDN or YOUR name) []:ca.example.net
   Email Address []:joedoe@example.net

   #Copy the private key and certificate to a single pem file:
   cat keys/ssl-proxy-ca.key > ssl-server.pem
   cat certs/ssl-inspect-ca.cer >> ssl-server.pem

   # create the proxy-certificate as signing request to the CA
   openssl req -new -x509 -days 1095 -key keys/ssl-proxy-ca.key -out certs/ssl-inspect-ca.cer
   Enter pass phrase for keys/ssl-proxy-ca.key:juniper123
   You are about to be asked to enter information that will be incorporated
   into your certificate request.
   What you are about to enter is what is called a Distinguished Name or a DN.
   There are quite a few fields but you can leave some blank
   For some fields there will be a default value,
   If you enter '.', the field will be left blank.
   -----
   Country Name (2 letter code) [AU]:US
   State or Province Name (full name) [Some-State]:CA
   Locality Name (eg, city) []:Sunnyvale
   Organization Name (eg, company) [Internet Widgits Pty Ltd]:Juniper Networks Inc.
   Organizational Unit Name (eg, section) []:IT-Department
   Common Name (e.g. server FQDN or YOUR name) []:proxy.example.net
   Email Address []:proxy@example.net
   
   ls -l certs keys ssl-server.pem
   -rw-r--r-- 1 root root 3195 Apr 12 03:19 ssl-server.pem
   
   certs:
   total 4
   -rw-r--r-- 1 root root 1489 Apr 12 03:22 ssl-inspect-ca.cer
   
   keys:
   total 4
   -rw-r--r-- 1 root root 1743 Apr 12 03:10 ssl-proxy-ca.key
   
   cat keys/ssl-proxy-ca.key > new-ssl-server.pem
   cat certs/ssl-inspect-ca.cer >> new-ssl-server.pem
   
   # now list the cert so that you can copy and paste if for the next step
   cat new-ssl-server.pem
   -----BEGIN RSA PRIVATE KEY-----
   Proc-Type: 4,ENCRYPTED
   DEK-Info: DES-EDE3-CBC,627F1139BC312E6B
   
   nWjlMfCg7puFt9p4vJzM1nwqQmbp5coilQKhh+AWDXX9du+e67CII5CVVczF7ZgV
   84JJnZrgCyjI7zaJ2+apKvHvjYHE6HFMoVxOaj5K2HY81LzFQTtRf8+eSBd4e7B+
   r7MXsREsVWZZlUzL+RGArMlvLjxSEaIR36HSphsv4nsVMcC6UboR3LgbxB9j9BdB
   9k2nJznojhtJxLTusPwDk+EvQIHfkDBWei9V/U78ffgTUKJVAKqor6o3scPEzG+Q
   xUOUFqCkHJ7s8QXDnwUOGBJ51DSn356HKNZ5yuf0dFZLV7aj+5v+V5BNtITIzCeA
   FLo4hbJuOKczORLkJOuf/gzNDRORZYHNpk8rSiYx++G6cHRTqZIiOoSNEhMO2bDA
   4dcR0tftSWYPmL4UIL5Y0/8WykVMfayVLOrGtC6NA54oigccSQrYbFdjPI8nAHCx
   GEUeIqaqUu044DAafUrbuPmYxAHCD9vQDi6HMFCDmb62Wvh9HgkuaUxs7X/JGGsJ
   HbOGp0u8D6NjwN3To50FiGbYVPuvi4ZDWTCTQJxkPGxkQNtxGPBd8IR9I8evXz7t
   +JoS56ny7kTUk/JnNMdq2r05fwk0g5K5YjqwVZx/W7LKA5OOaGL7f33LUCm3/VrX
   LKvzOW2v01Rnmn5jTGm2t/xKFeoCPhRYHirAPOy/SmFQpxnTpiRDQ/2Z3rlptIn+
   cuBYhPXA95e2OAsw9IZkEQrkpISXNXarzmkXqFYX1EUimuMWRjccMJKq6MOj0NdV
   go8z4+vdseyz3X4AvTySYBHNUHk53pK9OGOXx7UV+Empgo2obK/Vq6NAWaOkQcm3
   kLoZbPA+fh5dMrb889gBObHzmgoEXjVOmZBGnWw1e452dEteDo5iViNzAyBZlObe
   Q/cczRv0SMzAaN7lGqTjgwwdyz6k/kLh2PshjFco9dL9VkOo6YBBG8RLu2P9xgRC
   m1fom+jz8x1gRFqtCYIUZm3mAF3XPtDUXgbtA36Cm0Q8afWGL3ycxfmtWfjoj+pa
   eHTScfycjMmgc1jAXJ4K8+BqjdVRzHMWo8FZ0AIQPuNEBdDnHVZSrAehth4bsvr7
   Eyg+iKiq2ytb10QYqk4z3d0/PQSVwIgXDF8B/VaDDp4dmrts2qBHenKq90O5ok+y
   kiloXYWNSgeGk+RQtWyHpyTFLQd4SztCi27onRsQ8WPZ8GN8MKe/D67q+BjqRP9+
   V9vsTT/16HPYrHOTDBDbjDGXt6pqVRQM9T2HhMjbmIBP+YH8m/1Un65sjs2iPJo6
   XhOqT9jyrGoFFkc0wieWyJBBI8SCHriwcv7cc+9CxDKghHukd1S+EIvqCFdqunnR
   hIQQA6W+2r1dnTDXIIFctUU8SpwZ8T3oU4kFg9MoyQs9WCQvJ82OlgjuEiMpQFcg
   iGViikQRyIvGLvBOqWZYnLOiCqX//W2H+IgYa/OwliaqXb0UeW3rXa2NSDNlK7Fu
   OfhhAii4m0wCpGGM2K0Qxb+ZlcTV0hSbqnWEsYN3BiSrqLOo+zbGXG2xBy+HHved
   yS0ujmI0zMkN7PAEyZhq0W+S6FHAUpPOOvj3m3fN/I6/TBIKnd/qHQ==
   -----END RSA PRIVATE KEY-----
   -----BEGIN CERTIFICATE-----
   MIIEHTCCAwWgAwIBAgIJAJggTirgSPZkMA0GCSqGSIb3DQEBCwUAMIGkMQswCQYD
   VQQGEwJVUzELMAkGA1UECAwCQ0ExEjAQBgNVBAcMCVN1bm55dmFsZTEeMBwGA1UE
   CgwVSnVuaXBlciBOZXR3b3JrcyBJbmMuMRYwFAYDVQQLDA1JVC1EZXBhcnRtZW50
   MRowGAYDVQQDDBFwcm94eS5leGFtcGxlLm5ldDEgMB4GCSqGSIb3DQEJARYRcHJv
   eHlAZXhhbXBsZS5uZXQwHhcNMTgwNDEyMDkyMjM3WhcNMjEwNDExMDkyMjM3WjCB
   pDELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkNBMRIwEAYDVQQHDAlTdW5ueXZhbGUx
   HjAcBgNVBAoMFUp1bmlwZXIgTmV0d29ya3MgSW5jLjEWMBQGA1UECwwNSVQtRGVw
   YXJ0bWVudDEaMBgGA1UEAwwRcHJveHkuZXhhbXBsZS5uZXQxIDAeBgkqhkiG9w0B
   CQEWEXByb3h5QGV4YW1wbGUubmV0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
   CgKCAQEA0LbfTYi4mDxHxv/ywMQLqvNfnJpgXeZqKsQBh+Wsh/gvazX5oKjDaV0N
   9VKzImH6+c/Zp+XfWiEzKRP+ogDKPF9CwdkOjqFG4ph7WR4EtMu4HhcjE0AA/9/v
   Vyz0XdLcKoKCwcWp0ki3C+IofR77szom8fZTlc7iXbcqCBjSCQTeJVQ08J+5T8E+
   TAO0mGF6Y3KjQLduBtQq1QjS7e40e9OWocHZYg8W7GRyV8e7hYMA9sgd/sSFplGl
   1bFb8vf/6+fM0/B4kBZ5tCz1XBXBmYTyTHNXA819ymZnVawG040VCLyAaz9ENKVo
   tb1TjlIrHyW4GufU0wW7+0x5OIcZjwIDAQABo1AwTjAdBgNVHQ4EFgQUkSkBgACk
   JtE6dOrzUdxfBgjT/ZIwHwYDVR0jBBgwFoAUkSkBgACkJtE6dOrzUdxfBgjT/ZIw
   DAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAwoX74mvJMeWWM89tvRfY
   qOcB0dR3Dr+0YMDnNH/as/hQjPsHRYgr5KDGW3t6avyJqDHMEDLK/wKjFSaUZoxp
   3d2izWlMR2qPKhDPe2OcSji5ExT2sVHiX0XWt01YxbLoco2wc+Ku36ud+hsfNRlu
   UnodHVbE6g+WLeRlM2q6JrbQi8qNnJsYjh7bf9LFhl8k00A8wTam3uHzdRFeOH8l
   g+DoXQNqmWZvtBg9jYIWVOcnGM6sSHf4UVtKdAjV9BTfXbPgpD4XSW9cdvb6qVqh
   ExydnfReQmp7kw3xehu8F1C2wVPSMxToSGIQxPxlgtauGSjNagMnsc+VVih4Ip9r
   jA==
   -----END CERTIFICATE-----

Upload the generated proxy-cert to CSO

|image383|

|image384|

|image385|

|image386|

Check if your cert will be valid in the timeframe the Desktop client will see it.

|image387|

|image388|

|image389|

|image390|

Now create a proxy profile

|image391|

|image392|

|image393|

|image394|

Create the SSL-Proxy policy

|image395|

|image396|

Now create a firewall rule to capture Traffic for that site through the SSL-Proxy

|image397|

|image398|

DO NOT FORGET TO DEPLOY YOUR CHANGES!

|image399|

Make sure all Jobs have succeeded before you continue

|image400|

In our example the ssl-proxy has not yet been applied so do that now.

|image401|

Check that the proxy policy has been applied

|image402|

Now use the appropriate desktop client that emulates the end-user

As Google today encrypts every traffic a simple random search should display something like this, which also indicates the Proxy is attempting to intercept the traffic for deeper inspection.

|image403|

As we don’t have a certificate from a trusted CA (it’s a Lab) and Mozilla doesn’t want to make an exception we need to change the security settings of Mozilla.

First download our CA-File local to that Desktop VM via a terminal window using scp

|image404|

Then open privacy settings in Mozilla

|image405|

|image406|

|image407|

|image408|

|image409|

|image410|

Now use google to serach for something random which should work now and inspect the security settings:

|image411|

|image412|

|image413|

This verifies finally you are talking through a proxy for encrypted traffic.

You can also verify the SSL-Proxy stats on the CPE

|image414|

UTM Filters Test cases
^^^^^^^^^^^^^^^^^^^^^^

In this Test case we are testing multiple UTM Filter abilities of the SRX for SD-WAN

Here we test the ability to Filter Traffic based on

-  Category-Filters which means Juniper compiles a list of known websites and rates them into different categories. A category you select to be blocked would then be effective for all the pre-configured websites WITHOUT the need to configure an individual Site by URL. This is very powerful and time saving.
-  URL-Filters are meant to give you the ability to block individual sites that are either not in one of the pre-defined categories or you want that particular URL to treat special. When you create a URL Filter you have to define an own category for this filter which allows you to use individual and pre-defined easily in the same structure.
-  Content-Filters means that the system looks into the data stream of what is received not just which URL is used as above. It’s not limited to HTTP and can also be used in other protocols like FTP, SMTP, POP and IMAP3. In our case we will block to download \*.exe Files as they may be a risk.

First we add a custom URL category with a custom filter

|image415|

Click Add (+) and add information similar to the below

|image416|

|image417|

|image418|

Now we create a Custom Web filter Profile (that will also include our URL Filter)

|image419|

Click Add (+) and add information similar to the below

|image420|

Choose Option to add URL Category

|image421|

Select Whole categories to Block. In our example block the “Shopping” Category

|image422|

|image423|

Leave the fallback-options as they are. No change needed here.

|image424|

|image425|

Demonstrate/show the predefined Filter categories

|image426|

The next filter option we create is a content filter

Create a New Custom Content Filter

|image427|

Click Add (+) and add information similar to the below

|image428|

Leave Protocol Commands as they are and CLICK NEXT

|image429|

Block some standard contents like \*.exe

|image430|

Add File extensions like zip, exe, pdf, dmg etc.

|image431|

No need to enter a MIME-Type and just click NEXT

|image432|

|image433|

Create a new UTM Profile

|image434|

Click Add (+) and add information similar to the below

|image435|

Choose the Custom Web Filtering Profile that was created in first step

|image436|

|image437|

No need to enter Antispam for this test case so just click NEXT

|image438|

|image439|

|image440|

Now we have to craft a Firewall Policy that uses our custom UTM-Profile

|image441|

Just use a normal any <- to -> any communication as before.

|image442|

Important change is now to activate the UTM button and select the custom “myutmprofile”. Then Save your policy.

|image443|

Just to be sure delete the old policy that was without UTM

|image444|

Now you need to deploy your change.

|image445|

Wait until everything is deployed ok.

|image446|

On the Device you would see now something like this.

.. code-block:: none

   root@GWR.sdwansite2.hubspoketenant> show configuration security utm
   custom-objects {
       filename-extension {
           CF_mycontentfilter {
               value [ zip exe pdf dmg ];
           }
       }
       url-pattern {
           myurlfilter {
               value www.bild.de;
           }
       }
       custom-url-category {
           mycategory {
               value myurlfilter;
           }
       }
   }
   feature-profile {
       anti-virus {
           type sophos-engine;
       }
       web-filtering {
           type juniper-enhanced;
           juniper-enhanced {
               profile myfilter {
                   category {
                       mycategory {
                           action block;
                           reputation-action;
                       }
                       Enhanced_Adult_Content {
                           action block;
                           reputation-action;
                       }
                       Enhanced_Adult_Material {
                           action block;
                           reputation-action;
                       }
                   }
                   site-reputation-action {
                       very-safe permit;
                       moderately-safe log-and-permit;
                       fairly-safe log-and-permit;
                       suspicious quarantine;
                       harmful block;
                   }
                   default log-and-permit;
                   custom-block-message "*** This is blocked by Juniper ***";
                   fallback-settings {
                       default log-and-permit;
                       server-connectivity log-and-permit;
                       timeout log-and-permit;
                       too-many-requests log-and-permit;
                   }
               }
           }
       }
       content-filtering {
           profile mycontentfilter {
               block-extension CF_mycontentfilter;
               block-content-type {
                   exe;
               }
               notification-options {
                   type message;
                   notify-mail-sender;
                   custom-message "This content is BLOCKED by Juniper";
               }
           }
       }
   }
   utm-policy myutmprofile {
       anti-virus {
           http-profile junos-sophos-av-defaults;
           ftp {
               upload-profile junos-sophos-av-defaults;
               download-profile junos-sophos-av-defaults;
           }
           smtp-profile junos-sophos-av-defaults;
           pop3-profile junos-sophos-av-defaults;
           imap-profile junos-sophos-av-defaults;
       }
       content-filtering {
           http-profile mycontentfilter;
           ftp {
               upload-profile mycontentfilter;
               download-profile mycontentfilter;
           }
           smtp-profile mycontentfilter;
           pop3-profile mycontentfilter;
           imap-profile mycontentfilter;
       }
       web-filtering {
           http-profile myfilter;
       }
   }

   root@GWR.sdwansite2.hubspoketenant> show security utm status
   UTM service status: Running

Now for testing the features and see how they all work go to the Desktop Client VM start a Brower to http://www.bild.de

|image447|

The response verifies that we have been block by the URL Filter we have created. Now let’s test the category blocker

Use http://www.playboy.com and you see that we’ve been blocked by category not URL

|image448|

The last test is about the content filter and we try to download an \*.exe file to check this feature. Go to http://www.ghisler.com/download.htm and click the download link.

|image449|

When you click the link you should see this as return verifying the block by file extension.

|image450|

UTM Anti-Virus Test-case
^^^^^^^^^^^^^^^^^^^^^^^^

This test case leverages the embedded Sophos AV Engine on the Spoke SRX/NFX to block Viruses from being downloaded onto the Employee Client via his Browser.

As we only want to show the function working we are using the **test-file** from Eicar.org and attempt to download that to get a proper Alert. Major AV-Engines are trained to detect this and report it as malicious.

Check the default AV-Profiles that they are there

|image451|

Check the default UTM-Profiles that they are have AV configuration. You will need the one called “sophos-av-policy” for this test.

|image452|

Now we have to craft a Firewall Policy that uses our UTM-Profiles

|image453|

Just use a normal any <- to -> any communication as before.

|image454|

Important change is now to activate the UTM button and select the predefined “sophos-av-policy”. Then Save your policy.

|image455|

Just to be sure delete the old policy that was without UTM

|image456|

Now you need to deploy your change.

|image457|

Wait until everything is deployed ok.

|image458|

http://www.eicar.org/85-0-Download.html

|image459|

|image460|

It you don’t get this message the please check that:

-  You have a proper license on the Device and have not ignored Chapter 6.6.1 above
-  There’s no other AV-Engine between the lab and your internet connection that prevents this download.

Thread Virtualization (more a Demo then a Test-case)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Thread Virtualization is nothing you can easily show as a Part of a PoC because it will be pretty **hard to simulate Attackers** from the outside including them coming from different countries.

If you want you can demonstrate what happens and what is visible in such case with a pre-loaded simulated pattern but we can’t really execute this as a test-case for the reason above mentioned.

Please have the customer to agree that a simulation instead would be fine with him as well.

File “Threat-Visualization.tar” embedded

**DOWNLOAD**
`Threat-Visualization.tar <Threat-Visualization.tar>`__


|image461|

For preparation load the embedded File onto your CSO host, untar it and load some required python modules.

.. code-block:: none

   mkdir threadsimulation
   cd threadsimulation
   ls -l
   -rw-r--r-- 1 root root 317440 Apr 12 09:12 Threat-Visualization.tar

   tar xfv Threat-Visualization.tar
   demo_idp.log
   idpLoop2.sh
   IDPSite1.log
   IDPSite2.log
   ISPSite3.log
   README.md
   run_idp.sh
   run.py
   run.sh

   apt-get -y install scapy python-dateutil

To simulate Attacks use the command below and use the correct name of the device. It is best you go to the device and check the system name CSO has configured like in our case for the NFX250 it is:

.. code-block:: none

   show configuration system host-name
   host-name GWR.sdwansite2.hubspoketenant;

Now run the two scripts with your correct system name for Attacker simulation

.. code-block:: none

   python run.py GWR.sdwansite2.hubspoketenant 192.168.10.47 2 demo_idp.log
   
   python ./run.py GWR.sdwansite2.hubspoketenant 192.168.10.47 1 IDPSite1.log

Now review the reported IPS events in the GUI

|image462|

Review sorted by source country to know where the attackers are coming from

|image463|

Now click to the live Thread Map

|image464|

Show and individual country (Germany in this case)

|image465|

Logging and Report generation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In this section we are going to the “Monitor” and the “Reporting” section of CSO and review the reported events and messages as a test case about visible information to the customer about security and other aspects of his SD-WAN installation.

As a preparation please review the demo in this `Video from the BU <https://junipernetworks.sharepoint.com/:v:/s/Projects1/nethranpi/Ea-AIvTGKNRPpPcyaSOEjrEBufh4bL2x5LwzJrOdmwXfAg?e=4MWacu>`__ from minute 25:10 on or show it to the customer if you don’t have time for those test case execution.

.. note:: Not all windows and information screens may display usable information. This is because you may have not used a certain feature or have not yet violated a certain policy. So that’s normal.

Below we show only screens that are containing information if you have executed all test cases in this whole Chapter. So those are save to click to retrieve some information.

Monitoring and Logging

First check the Alarms window

|image466|

Then show All Events for security.

|image467|

Show Web filter Events

|image468|

Show Content Filter Events

|image469|

Show Antivirus Events

|image470|

Then leave the security section and display device events.

Explain that this show FLOW-Based information which is a high granularity in terms of reported information.

|image471|

Show Application SLA Performance

|image472|

Show the very nice Application Visibility Screen (click over some of the bubbles for more info please)

|image473|

Reporting

In this (last) section of the SD-WAN basic test cases we generate some reports that are available per default and show them to the customer

Go to report generation as below and chose the existing Application and User report for bandwidth usage.

|image474|

|image475|

Download and review the report in a PDF viewer. An example of such a Report is embedded in this document in Chapter 6.6.3 above “Demonstrate Application Detection”

Try to generate other reports. Same as with the logging some may be empty as you didn’t generate an event in this Lab yet.

If you uploaded the IDP Signatures for threat visualisation then use the IPS report for example

|image476|

As a new feature of CSO 3.3 the customer can instruct CSO to Email him reports regularly about the SD-WAN performance.

.. note:: You can show this in the PoC to claim that this ability exist now but we have no SMPT server in the lab configured (as of now) to retrieve this Email and show the content you may use external ones if you want to show this.

|image477|

With this all Test-cases for the SD-WAN Basic PoC have hopefully passed.

Test case execution related to SD-WAN EXTENDED and FULL
=======================================================

Local-Breakout at Spoke to Internet
-----------------------------------

.. warning:: This lab has no separate Automation configuration as it’s based on the SD-WAN BASIC Scenario. Apply that at you should be good to go.

.. warning:: This feature has not been re-qualified with CSO 4.1.0 as we don’t expect changes. Should you find an error please let us know.Background information on limits of this test-case you must aware of.

Review the feature presentation on SharePoint please

`https://junipernetworks.sharepoint.com/:p:/r/sites/open1/cloud-srv/_layouts/15/doc.aspx?sourcedoc={AE246EBA-32BE-4BCC-A63D-3DB606B071E8}&file=Local-breakout.pptx <https://junipernetworks.sharepoint.com/:p:/r/sites/open1/cloud-srv/_layouts/15/doc.aspx?sourcedoc=%7bAE246EBA-32BE-4BCC-A63D-3DB606B071E8%7d&file=Local-breakout.pptx>`__

**When you activate local breakout** for a Spoke-site (where it usually makes the most sense) the traffic forwarding changes to do:

**ALL TRAFFIC PER DEFAULT goes to the LOCAL-BREAKOUT** interface!

**Only Site to Site traffic** remains back and will **utilize the SD-WAN links** still and is subject to your SLA-Policies. As a result you should have **minimum two Spokes** and one Hub to demonstrate this feature.

However in our Test cases we will use an **SD-WAN policy to steer** Traffic from a default local breakout link (WAN_1 in this case) **to ANOTHER local breakout link** (WAN_0 in this case).

Also in our Test cases always use and **activate “Auto create Source-Nat Rule”** on the WAN-Links where we breakout. Our lab needs this feature to function correctly as else the LAN IP’s would appear in the Underlay environment and the return route would have to dynamically change form hub to spoke depending which interface is used. We avoid such a complex change here. In a real-life environment Source-Nat would be expected to be performed at the Internet GW anyway so that would be then the VR on the QFX5100 to mimic this. It is much simpler with this and the WAN-Interfaces already and would work for real-life environments as well.

.. note:: A breakout to a local interface is not the only Method. Starting with CSO V4.1 the Breakout may also happen towards a Cloud instance. We’ve added Zscaler support which will forward the breakout Traffic via additional IPsec Tunnels to a Zscaler cloud based installation and the Traffic is inpected there again before send to the final destination. This is not something to be demonstrated easily because one need a Zscaler Account.

Preparation (on boarding first Spoke)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

This test case assumes that:

- The SD-WAN BASIC Topology is used

- PoP created

- Cloud Hub created

- Cloud Hub if ZTPed and Provisioned in CSO

- The Tenant is created

- NO SD-WAN policy is created right now

- The Cloud Hub is assigned to the Tenant

The Picture below indicates the expected state:

|image478|

We are starting with on boarding a new Site and bring a device up. The SRX345 is out first device and right after we use the NFX250 as second Site.

First patch the template not to ask for an authorization code

|image479|

|image480|

|image481|

|image482|

|image483|

|image484|

|image485|

.. warning:: Here is a CHANGE. Enable Local-Breakout. Use BOTH Links for offload and use WAN_1 as default preference for the offload.

|image486|

|image487|

|image488|

|image489|

|image490|

.. code-block:: none

   {
       "input": {
           "tenant_name": "hubspoketenant",
           "site": [
               {
                   "site_name": "sdwansite1",
                   "site_basic_properties": {
                       "local_breakout": {
                           "breakout_type": "site_wide_breakout",
                           "enabled": true
                       },
                       "site_name": "sdwansite1",
                       "enable_mh": true,
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": false,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "local_breakout_enabled": true,
                                       "wan_link": "WAN_0",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "b7d77bcf-2a6f-870f-0cdd-f895294d016c",
                                       "cost": 2222,
                                       "default_link": true,
                                       "provider": "abc",
                                       "cost_currency": "USD",
                                       "backup_link": false
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "local_breakout_enabled": true,
                                       "wan_link": "WAN_1",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "2b55a245-afbd-d7c4-75ec-32b750dfbc1b",
                                       "cost": 111,
                                       "default_link": true,
                                       "provider": "xyz",
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": true,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "SRX_Advanced_SDWAN_CPE_option_1",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "10.88.88.1/24",
                                       "lan_segment_name": "desktop2",
                                       "vlan": 1088,
                                       "lan_ports": [
                                           "LAN_4"
                                       ],
                                       "department": "Default",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwansite1"
                           }
                       ],
                       "0": {
                           "ip_prefix": "10.88.88.1/24",
                           "lan_segment_name": "desktop2",
                           "vlan": 1088,
                           "lan_ports": [
                               "LAN_4"
                           ],
                           "department": "Default",
                           "dhcp": false
                       },
                       "site_type": "on_premise",
                       "showDualCpeDp": true,
                       "site_role": "SPOKE",
                       "sla_mgmt": "COARSE",
                       "device_profile_name": "SRX_Advanced_SDWAN_CPE_option_1",
                       "site_group": "",
                       "topology": "Hub & Spoke"
                   }
               }
           ]
       }
   }

|image491|

|image492|

|image493|

|image494|

|image495|

|image496|

|image497|

|image498|

.. code-block:: none

   {
       "input": {
           "tenant_name": "hubspoketenant",
           "job_name_prefix": "hubspoketenant-sdwansite1",
           "site": [
               {
                   "on_premise_site_info": {
                       "device": [
                           {
                               "device_template": "SRX_Advanced_SDWAN_CPE_option_1",
                               "device_details": {
                                   "serial_number": "CZ1616AF0021"
                               },
                               "wan_link": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/0",
                                       "overlay_tunnel": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN",
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "nat_info": {
                                           "nat_enabled": true
                                       },
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.170.1",
                                           "ip_address": "192.168.170.2/24"
                                       },
                                       "local_breakout_enabled": true,
                                       "traffic_type": "OAM_AND_DATA",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC"
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/1",
                                       "overlay_tunnel": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN",
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "nat_info": {
                                           "nat_enabled": true
                                       },
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.173.1",
                                           "ip_address": "192.168.173.2/24"
                                       },
                                       "local_breakout_enabled": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC"
                                   }
                               ],
                               "device_name": "sdwansite1"
                           }
                       ],
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "region": "regional",
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       }
                   },
                   "site_name": "sdwansite1",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }

|image499|

|image500|

#

# WAIT 15-20MINUTES!!!! That's how long this process takes with all the commits to the SRX345

#

|image501|

The next steps are similar to other labs

- Execute Chapter 6.6.1 above to add a license

- Execute Chapter 6.6.2 above to load SD-WAN IDP-Signatures

- Add a simple Firewall rule to pass all traffic

- Deploy the Firewall rule and check that this is done

Use the Desktop client and launch two permanent Pings to 8.8.8.8 and 8.8.4.4

|image502|

Test case local-breakout to default (without SLA-Policy)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Review where the system now forwards these two destination packets to:

.. code-block:: none

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show security flow session destination-prefix 8.8.8.8
   Session ID: 93053, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.88.88.88/46818 --> 8.8.8.8/8209;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/8209 --> 192.168.173.2/26458;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,


   root@CZ1616AF0021.sdwansite1.hubspoketenant> show security flow session destination-prefix 8.8.4.4

   Session ID: 92976, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.88.88.88/46850 --> 8.8.4.4/8230;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.4.4/8230 --> 192.168.173.2/14465;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,

Remember that when you use local breakout it is the DEFAULT now to send any Traffic to the internet. As we have only ONE Interface configured for local breakout it will use this interface (in our case WAN_1 = ge-0/0/1 = 192.168.173.2). The trace above indicates the usage of NAT towards the interface ip of the WAN_1 interface.

To demonstrate also SD-WAN Traffic at the same time we need a second Spoke to talk to. We will now bring up the NFX250.

NFX250 as second Spoke bring-up
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note:: We only describe the diffs to Chapter 6.5 above here. Follow Chapter 6.5 above and change/add the local break-out information accordingly.

|image503|

.. code-block:: none

   {
       "input": {
           "tenant_name": "hubspoketenant",
           "site": [
               {
                   "site_name": "sdwansite2",
                   "site_basic_properties": {
                       "local_breakout": {
                           "breakout_type": "site_wide_breakout",
                           "enabled": true
                       },
                       "site_name": "sdwansite2",
                       "enable_mh": true,
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": false,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "local_breakout_enabled": true,
                                       "wan_link": "WAN_0",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "c283cf25-b27b-2116-6477-972d0a3767e7",
                                       "cost": 2222,
                                       "access_type": "Ethernet",
                                       "default_link": true,
                                       "provider": "abc",
                                       "cost_currency": "USD",
                                       "backup_link": false
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "local_breakout_enabled": true,
                                       "wan_link": "WAN_1",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "a388673d-7a51-1206-b9e0-481ea4a8676d",
                                       "cost": 111,
                                       "access_type": "Ethernet",
                                       "default_link": true,
                                       "provider": "xyz",
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": true,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "NFX_Advanced_SDWAN_CPE_option_1",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "10.66.66.1/24",
                                       "lan_segment_name": "desktop4",
                                       "vlan": 1066,
                                       "lan_ports": [
                                           "LAN_0"
                                       ],
                                       "department": "Default",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwansite2"
                           }
                       ],
                       "0": {
                           "ip_prefix": "10.66.66.1/24",
                           "lan_segment_name": "desktop4",
                           "vlan": 1066,
                           "lan_ports": [
                               "LAN_0"
                           ],
                           "department": "Default",
                           "dhcp": false
                       },
                       "site_type": "on_premise",
                       "showDualCpeDp": true,
                       "site_role": "SPOKE",
                       "sla_mgmt": "COARSE",
                       "device_profile_name": "NFX_Advanced_SDWAN_CPE_option_1",
                       "site_group": "",
                       "topology": "Hub & Spoke"
                   }
               }
           ]
       }
   }

|image504|

|image505|

|image506|

.. code-block:: none

   {
       "input": {
           "tenant_name": "hubspoketenant",
           "job_name_prefix": "hubspoketenant-sdwansite2",
           "site": [
               {
                   "on_premise_site_info": {
                       "device": [
                           {
                               "device_template": "NFX_Advanced_SDWAN_CPE_option_1",
                               "device_details": {
                                   "serial_number": "DD2316AF0103"
                               },
                               "wan_link": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/10",
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "nat_info": {
                                           "nat_enabled": true
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.130.1",
                                           "ip_address": "192.168.130.2/24"
                                       },
                                       "local_breakout_enabled": true,
                                       "traffic_type": "OAM_AND_DATA",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC"
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/11",
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "nat_info": {
                                           "nat_enabled": true
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.133.1",
                                           "ip_address": "192.168.133.2/24"
                                       },
                                       "local_breakout_enabled": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC"
                                   }
                               ],
                               "device_name": "sdwansite2"
                           }
                       ],
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "region": "regional",
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       }
                   },
                   "site_name": "sdwansite2",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }

|image507|

Be sure you **execute Chapter 6.6.1 above + Chapter 6.6.2 above** to push a license and upload a SD-WAN Policies before you continue.

Test case Spoke to Spoke communication (no breakout)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Now add a firewall policy to allow traffic between the two Sites. Here we have a single Policy to allow the state full inspection to include site1+site2 as Source and Destination Target

|image508|

The result should look like this:

|image509|

Don’t forget to deploy your changes! Monitor that they are applied correctly.

|image510|

Now from the desktop2 VM which is attached to the SRX345 Spoke ping the desktop4 VM (10.66.66.66) which is attached to the LAN of NFX250.

|image511|

You can do the reverse on desktop4 towards desktop2 and ping 10.88.88.88 there

|image512|

Now ssh to the SRX345 (192.168.170.2 root/Embe1mpls) and review the pings to the other Spoke (dest.ip=10.66.66.66) and the Internet (dest.ip=8.8.8.8)

.. code-block:: none

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show security flow session destination-prefix 10.66.66.66
   Session ID: 89460, Policy name: Intent_2__1/9, Timeout: 2, Valid
     In: 10.88.88.88/906 --> 10.66.66.66/27677;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 10.66.66.66/27677 --> 10.88.88.88/906;icmp, Conn Tag: 0x0, If: gr-0/0/0.4001, Pkts: 1, Bytes: 84,
   .
   .

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show security flow session destination-prefix 8.8.8.8
   Session ID: 89493, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.88.88.88/17718 --> 8.8.8.8/8209;icmp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/8209 --> 192.168.173.2/6106;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,
   .
   .

You see that the destination flow to the spoke will not be NATed and use one of the two gr-0/0/0.400x Tunnels for SD-WAN traffic towards the Hub which both Spoke share.

The remaining Traffic uses internet break-out and is send via NAT (using 192.168.173.2 as Source IP of WAN_1 Spoke) towards the underlay ge-0/0/1/.0 Interface

Remember that you have two routes with this default breakout metric as we also may use the WAN_0 interface if we identify an app via SD-WAN policy for this traffic.

You can also review the routeing tables to verify this claim:

.. code-block:: none

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show route table LAN-hubspoketenant_DefaultVPN.inet.0

   LAN-hubspoketenant_DefaultVPN.inet.0: 4 destinations, 6 routes (4 active, 0 holddown, 1 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/8] 4d 23:58:07
                         to table default-local-breakout.inet.0
                       [BGP/170] 4d 23:57:46, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4001, Push 16
   10.66.66.0/24      *[BGP/170] 00:54:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 18
                       > via gr-0/0/0.4001, Push 18
   10.88.88.0/24      *[Direct/0] 4d 23:58:07
                       > via ge-0/0/4.1088
   10.88.88.1/32      *[Local/0] 4d 23:58:07
                         Local via ge-0/0/4.1088

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show route table default-local-breakout.inet.0

   default-local-breakout.inet.0: 7 destinations, 8 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 00:57:23, metric2 0
                       > to 192.168.173.1 via ge-0/0/1.0
                       [Static/8] 00:57:23, metric2 0
                       > to 192.168.170.1 via ge-0/0/0.0
   10.88.88.0/24      *[Direct/0] 00:53:32
                       > via ge-0/0/4.1088
   172.28.28.1/32     *[Static/1] 00:57:11, metric2 0
                       > to 192.168.173.1 via ge-0/0/1.0
   172.28.28.2/32     *[Static/1] 00:57:11, metric2 0
                       > to 192.168.170.1 via ge-0/0/0.0
   192.168.0.0/24     *[Direct/0] 00:57:23
                       > via lo0.0
   192.168.170.0/24   *[Direct/0] 00:57:23
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:57:23
                       > via ge-0/0/1.0

Test case local-breakout with SLA Policy
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Now we define a static SD-WAN policy to steer certain Apps towards the second breakout link. WAN_1 is our default link and our Policy should use WAN_0 with the MPLS breakout instead.

Now make sure that you did not forgot to enable an Application Traffic Type Profile in the

“All Tenants” view. (we do that in the beginning of Chapter 6.6.5 above Dynamic SD-WAN ) policy.

Check: Configuration -> Application Traffic Type Profiles for enabled profile and if not enable what is appropriate to you:

|image513|

Come back to the “hubspoketenant” view and configure an SLA Profile

Configuration -> SD-WAN -> Application SLA Profiles -> add(+)

|image514|

|image515|

|image516|

Use the department “Default” as source as it is assigned to both devices.

As application use “YouTube*” and “Wikipedia”.

As SLA-Profile we use “mplsbreakout” that we have just created.

|image517|

Apply your Profile and DEPLOY it immediately.

Make SURE it’s deployed before you continue.

|image518|

Now use the desktop2 VM and use the following three URL’s:

As example for a non-cacheable application use YouTube:

|image519|

As example for a cacheable application use Wikipedia:

|image520|

And we use Dailymotion as a not SLA-classified application.

|image521|

Now when you now look you look at the outbound interface you should see that instead of ge-0/0/1 as default as for DAILYMOTION the outbound interface is ge-0/0/0 as it was classified via our SLA Policy.

For **NON-CACHEABLE Applications** like “YouTube” you **MAY** also see a **single session** per SLA Policy application that should use the different link but it is **using the default ge-0/0/1 Interface**. This is an expected behaviour!!!

**For non-cacheable application we don’t switch on the first session** to a new link as it would interrupt the traffic and won’t work thru NAT. However most of these services use more sessions after the initial one so it should not be a big deal.

This behaviour should not be seen with a cacheable-application where we should be able to steer the traffic correctly on the first session.

.. code-block:: none

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show security flow session dynamic-application junos:YOUTUBE
   Session ID: 28940, Policy name: Intent_1/7, Timeout: 1772, Valid
     In: 10.88.88.88/58816 --> 216.58.212.174/443;tcp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 522, Bytes: 48113,
     Out: 216.58.212.174/443 --> 192.168.173.2/3098;tcp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1158, Bytes: 1375469,
   .
   .
   .

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show security flow session dynamic-application junos:WIKIPEDIA
   Session ID: 28921, Policy name: Intent_1/7, Timeout: 1760, Valid
     In: 10.88.88.88/56128 --> 91.198.174.192/443;tcp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 40, Bytes: 3801,
     Out: 91.198.174.192/443 --> 192.168.173.2/27321;tcp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 47, Bytes: 37475,
   .
   .
   .

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show security flow session dynamic-application junos:DAILYMOTION
   Session ID: 32272, Policy name: Intent_1/7, Timeout: 1790, Valid
     In: 10.88.88.88/57230 --> 35.190.84.46/443;tcp, Conn Tag: 0x0, If: ge-0/0/4.1088, Pkts: 66, Bytes: 13482,
     Out: 35.190.84.46/443 --> 192.168.173.2/28805;tcp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 115, Bytes: 97423,
   .
   .
   .

Below is how you can demonstrate if a certain Application is classified as cacheable or non-cacheable.

.. code-block:: none

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show services application-identification application detail junos:YOUTUBE
   Application Name: junos:YOUTUBE
   Application type: YOUTUBE
   Description: This signature detects video streaming from Youtube.com, a video sharing site.
   Application ID: 240
   Priority: high
   Order: 0
   Disabled: No
   Cacheable: No
   Activation Date: 2007-07-02
   Last Modified: 2016-05-02
   Number of Parent Group(s): 1
   Application Groups:
       junos:web:multimedia:web-based
   Application Tags:
       characteristic        : Loss of Productivity
       characteristic        : Bandwidth Consumer
       risk                  : 4
       subcategory           : Multimedia
       category              : Web
   Layer-7 Protocol(s):
       Protocol: SSL         / 199
       Protocol: SPDY        / 1469
       Protocol: RTSP        / 176
       Protocol: RTMP        / 337
       Protocol: QUIC        / 2521
       Protocol: HTTPS       / 68
       Protocol: HTTP2       / 2553
       Protocol: HTTP        / 67
       Protocol: GOOGLE-PLUS / 1125
       Protocol: GOOGLE-GEN  / 943
       Protocol: APPLE-HLS   / 1799
   Alias List:
       junos:YOUTUBE-STREAM
   Port Mapping:
       Default ports: N/A

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show services application-identification application detail junos:WIKIPEDIA
   Application Name: junos:WIKIPEDIA
   Application type: WIKIPEDIA
   Description: This signature detects Wikipedia, which is a Web-based encyclopedia application where users can
                contribute to global knowledge over the Internet.
   Application ID: 222
   Priority: high
   Order: 0
   Disabled: No
   Cacheable: Yes
   Activation Date: 2012-04-04
   Last Modified: 2015-10-16
   Number of Parent Group(s): 1
   Application Groups:
       junos:web:reference
   Application Tags:
       characteristic        : Prone to Misuse
       characteristic        : Loss of Productivity
       risk                  : 2
       subcategory           : Reference
       category              : Web
   Layer-7 Protocol(s):
       Protocol: SSL         / 199
       Protocol: SPDY        / 1469
       Protocol: HTTPS       / 68
       Protocol: HTTP2       / 2553
       Protocol: HTTP        / 67
   Port Mapping:
       Default ports: N/A

Local-Breakout at Spoke towards (Zscaler-) Cloud
------------------------------------------------

.. warning:: This is lab is NOT listed as testcase scenario in the official list as it can’t be executed without support from our Partner Zscaler with an Account and running Instance.

**/\* fixme to be developed \*/**

Hub-Redundancy aka Hub Multihoming
----------------------------------

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. This will **SAVE** you huge amount of **TIME** and will guarantee that the lab configuration is in **PROPER STATE**. It will **AVOID** any **MISCONFIGURATION** you do via manual cut&paste.

If you want to bring this lab into this state you should click here:

|image522|

.. note:: As you see it will take care to apply the changes from chapter 7.3.1 and chapter 7.3.2 so you can jump over those.

With the CSO feature of “Hub multihoming” you are able to archive an Active/Passive Hub redundancy. During Spoke Site creation one can select which of the two Hubs is Primary and which is the Secondary Hub. From the Spoke view the Provisioning from CSO will then create 4 instead of 2 IPsec Tunnels as the second pair is for instant failover to the second Hub.

Preparation

This test case assumes that:

- The SD-WAN BASIC Topology is used

- PoP created

- Cloud Hub Nr.1 is created

- Cloud Hub Nr.1 is ZTPed and Provisioned in CSO

- The Tenant is created

- NO SD-WAN policy is created right now

- The Cloud Hub Nr.1 is assigned to the Tenant

The Picture below indicates the expected state:

|image523|

QFX5100-1 changes to add second Hub Device
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. If you have applied the changes from executing the “Multi-Hub (or Hub-Redundancy)” then you can ignore this section.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

We need to extend the Physical Underlay with a new Apply Group on the QFX5100-1 first to be able to on-board and use the second Hub in this scenario that we need here.

.. code-block:: none

   delete interfaces xe-0/0/42
   delete protocols rstp interface xe-0/0/42
   set groups sdwan-hubredunant interfaces xe-0/0/42 unit 0 family inet address 192.168.200.1/24
   set groups sdwan-hubredunant routing-instances hub-wan0 interface xe-0/0/42.0
   
   delete interfaces xe-0/0/43
   delete protocols rstp interface xe-0/0/43
   set groups sdwan-hubredunant interfaces xe-0/0/43 unit 0 family inet address 192.168.201.1/24
   set groups sdwan-hubredunant routing-instances hub-wan1 interface xe-0/0/43.0
   
   # also make sure the other interfaces towards SRX1500-2 unused in this demo are disabled
   set groups sdwan-hubredunant interfaces xe-0/0/44 disable
   set groups sdwan-hubredunant interfaces xe-0/0/45 disable
   
   # these are the additional changes in CSO >=4.0.1 to support Secure OAM
   delete interfaces xe-0/0/46
   delete protocols rstp interface xe-0/0/46
   set groups sdwan-hubredunant interfaces xe-0/0/46 unit 0 family inet address 192.168.204.1/24
   set groups sdwan-hubredunant routing-instances secure-oam interface xe-0/0/46.0
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.204.254
   
   set apply-groups sdwan-hubredunant
   commit and-quit

Check the configration

.. code-block:: none

   show interfaces terse
   .
   .
   xe-0/0/42               up    up
   xe-0/0/42.0             up    up   inet     192.168.200.1/24
   xe-0/0/43               up    up
   xe-0/0/43.0             up    up   inet     192.168.201.1/24
   xe-0/0/44               down  down
   xe-0/0/44.0             up    down eth-switch
   xe-0/0/45               down  down
   xe-0/0/45.0             up    down eth-switch
   xe-0/0/46               up    up
   xe-0/0/46.0             up    up   inet     192.168.204.1/24
   .
   .
   
   show route table secure-oam
   
   secure-oam.inet.0: 10 destinations, 10 routes (10 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 3w1d 00:58:33
                       > to 192.168.70.1 via irb.70
   192.168.10.0/24    *[Static/5] 3w1d 00:58:33
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 3w1d 00:58:33
                       > via irb.70
   192.168.70.254/32  *[Local/0] 3w1d 00:58:33
                         Local via irb.70
   192.168.194.0/24   *[Direct/0] 2d 00:57:47
                       > via xe-0/0/41.0
   192.168.194.1/32   *[Local/0] 2d 00:57:47
                         Local via xe-0/0/41.0
   192.168.204.0/24   *[Direct/0] 00:08:56
                       > via xe-0/0/46.0
   192.168.204.1/32   *[Local/0] 00:08:56
                         Local via xe-0/0/46.0
   192.168.210.1/32   *[BGP/170] 1d 22:25:00, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   192.168.210.3/32   *[BGP/170] 1d 21:41:21, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   
   show route table hub-wan0
   
   hub-wan0.inet.0: 12 destinations, 12 routes (12 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 13w3d 22:07:52
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 13w3d 22:07:52
                       > via irb.70
   192.168.70.254/32  *[Local/0] 13w3d 22:07:52
                         Local via irb.70
   192.168.130.0/24   *[Static/5] 13w3d 22:07:52
                       > to 192.168.132.254 via irb.132
   192.168.132.0/24   *[Direct/0] 13w3d 22:07:52
                       > via irb.132
   192.168.132.1/32   *[Local/0] 13w3d 22:07:52
                         Local via irb.132
   192.168.150.0/24   *[Static/5] 8w1d 19:24:49
                       > to 192.168.132.254 via irb.132
   192.168.170.0/24   *[Static/5] 13w3d 22:07:52
                       > to 192.168.132.254 via irb.132
   192.168.190.0/24   *[Direct/0] 2d 00:58:07
                       > via xe-0/0/37.0
   192.168.190.1/32   *[Local/0] 2d 00:58:07
                         Local via xe-0/0/37.0
   192.168.200.0/24   *[Direct/0] 00:09:16
                       > via xe-0/0/42.0
   192.168.200.1/32   *[Local/0] 00:09:16
                         Local via xe-0/0/42.0
   
   show route table hub-wan1
   
   hub-wan1.inet.0: 14 destinations, 14 routes (14 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 13w3d 22:07:59
                       > to 192.168.70.1 via irb.70
   10.66.66.0/24      *[Static/5] 2d 00:58:14
                       > to 192.168.191.254 via xe-0/0/38.0
   10.88.88.0/24      *[Static/5] 2d 00:58:14
                       > to 192.168.191.254 via xe-0/0/38.0
   192.168.70.0/24    *[Direct/0] 13w3d 22:07:59
                       > via irb.70
   192.168.70.254/32  *[Local/0] 13w3d 22:07:59
                         Local via irb.70
   192.168.133.0/24   *[Static/5] 13w3d 22:07:59
                       > to 192.168.135.254 via irb.135
   192.168.135.0/24   *[Direct/0] 13w3d 22:07:59
                       > via irb.135
   192.168.135.1/32   *[Local/0] 13w3d 22:07:59
                         Local via irb.135
   192.168.153.0/24   *[Static/5] 8w1d 19:24:56
                       > to 192.168.135.254 via irb.135
   192.168.173.0/24   *[Static/5] 13w3d 22:07:59
                       > to 192.168.135.254 via irb.135
   192.168.191.0/24   *[Direct/0] 2d 00:58:14
                       > via xe-0/0/38.0
   192.168.191.1/32   *[Local/0] 2d 00:58:14
                         Local via xe-0/0/38.0
   192.168.201.0/24   *[Direct/0] 00:09:23
                       > via xe-0/0/43.0
   192.168.201.1/32   *[Local/0] 00:09:23
                         Local via xe-0/0/43.0

SRX1500-2 initial configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. If you have applied the changes from executing the “Multi-Hub (or Hub-Redundancy)” then you can ignore this section.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

This is more or less a cut and paste from Chapter 3.3.4.4 above with the changes highlighted here in red.

.. note:: If your Hub is a SRX4x00 you need to modify this template before you apply it. On this Platform all Interfaces are named “\ **xe**-?/?/?” and **not** “\ **ge**-?/?/?” so you need to change that below!

.. code-block:: none

   start shell
   #rm /var/tmp/srx1500-2.default
   vi /var/tmp/srx1500-2.default

Copy and Paste this config into your editor and save

.. code-block:: none

   system {
       host-name srx1500-2;
       root-authentication {
           encrypted-password "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81"; ## SECRET-DATA
       }
       services {
           ftp;
           rlogin;
           ssh;
           telnet;
           netconf {
               ssh;
               rfc-compliant;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any any;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
   }
   security {
       policies {
           from-zone trust to-zone untrust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone trust to-zone trust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone trust {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
           }
           security-zone untrust {
               host-inbound-traffic {
                   system-services {
                       ssh;
                       ping;
                       netconf;
                       http;
                       https;
                       dhcp;
                       ike;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/0.0;
               }
           }
       }
   }
   interfaces {
       ge-0/0/0 {
           unit 0 {
               family inet {
                   address 192.168.200.254/24;
               }
           }
       }
   }
   routing-options {
       static {
           route 192.168.10.0/24 {
               next-hop 192.168.200.1;
               no-readvertise;
           }
       }
   }

.. code-block:: none

   exit
   edit
   load override /var/tmp/srx1500-2.default
   commit

On-board Hub2 to CSO and Tenant
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The Steps here are similar to the Steps in Chapter 6.1 above the only changes are:

-  The Device name is now “hub2”
-  Subnet 192.168.190.x will now be 192.168.200.x
-  Subnet 192.168.191.x will now be 192.168.201.x
-  The new OAM Loop-Back IP is now 192.168.210.2/32
-  As a result the static routes that we additionally apply after stage-1 is applied also change
-  The new Device ID is (from “show chassis hardware”) is DB1916AK1443

As a result of these minimal changes we do not document the whole bringup process again here in these chapter. We only show the diffs to Chapter 6.1 above here:

|image524|

|image525|

|image526|

|image527|

|image528|

.. code-block:: none

   {
       "input": {
           "tenant_name": "default-project",
           "job_name_prefix": "hub2-HUB-SITE",
           "site": [
               {
                   "on_premise_site_info": {
                       "region": "regional",
                       "pop": "sdwan-pop",
                       "site_role": "HUB",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       },
                       "device": [
                           {
                               "wan_link": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/0",
                                       "overlay_tunnel": [],
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.200.1",
                                           "ip_address": "192.168.200.254/24"
                                       },
                                       "proxy_oam_link_name": "WAN_0",
                                       "traffic_type": "DATA_ONLY",
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC"
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/1",
                                       "overlay_tunnel": [],
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.201.1",
                                           "ip_address": "192.168.201.254/24"
                                       },
                                       "proxy_oam_link_name": "WAN_0",
                                       "traffic_type": "DATA_ONLY",
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC"
                                   }
                               ],
                               "device_name": "hub2",
                               "device_template": "SRX_Advanced_SDWAN_HUB_option_1",
                               "device_details": {
                                   "serial_number": "CZ0417AF0130",
                                   "boot_image": ""
                               },
                               "vpn_authentication": "preshared_key",
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.2/32"
                               }
                           }
                       ],
                       "site_capabilities": "OAM_AND_DATA"
                   },
                   "site_name": "hub2",
                   "user_defined_properties": [
                       {
                           "name": "oam-ce-intf",
                           "value": "ge-0/0/4"
                       },
                       {
                           "name": "oam-ce-intf-prefix",
                           "value": "192.168.204.254/24"
                       },
                       {
                           "name": "oam-gateway",
                           "value": "192.168.204.1"
                       },
                       {
                           "name": "ebgp_peer_as",
                           "value": "65000"
                       }
                   ]
               }
           ]
       }
   }

Display the generated Stage-1 config

|image529|

Copy the ENTIRE configuration from this window and ssh to srx1500-2 192.168.200.254 (root/Embe1mpls)

.. code-block:: none

   start shell
   #rm /var/tmp/srx1500-2.stage1
   vi /var/tmp/srx1500-2.stage1

Paste the Config from CSO in your Editor and save&quit the editor

.. code-block:: none

   exit
   edit
   load override /var/tmp/srx1500-2.stage1
   #
   # CSO doesn’t set a default route so add this here
   #
   set routing-options static route 0.0.0.0/0 next-hop 192.168.201.1
   set routing-options static route 0.0.0.0/0 no-readvertise
   #
   # Also the following routes help in your environment to ensure the right path is used as we don’t have a routing protocol helping us.
   #
   set routing-options static route 192.168.130.0/24 next-hop 192.168.200.1
   set routing-options static route 192.168.130.0/24 no-readvertise
   set routing-options static route 192.168.133.0/24 next-hop 192.168.201.1
   set routing-options static route 192.168.133.0/24 no-readvertise
   set routing-options static route 192.168.150.0/24 next-hop 192.168.200.1
   set routing-options static route 192.168.150.0/24 no-readvertise
   set routing-options static route 192.168.153.0/24 next-hop 192.168.201.1
   set routing-options static route 192.168.153.0/24 no-readvertise
   set routing-options static route 192.168.170.0/24 next-hop 192.168.200.1
   set routing-options static route 192.168.170.0/24 no-readvertise
   set routing-options static route 192.168.173.0/24 next-hop 192.168.201.1
   set routing-options static route 192.168.173.0/24 no-readvertise
   
   commit and-quit

After you have applied this you should now see the new loop-back IP on the QFX

.. code-block:: none

   ping 192.168.204.254 routing-instance secure-oam
   PING 192.168.204.254 (192.168.204.254): 56 data bytes
   64 bytes from 192.168.204.254: icmp_seq=0 ttl=64 time=0.869 ms
   64 bytes from 192.168.204.254: icmp_seq=1 ttl=64 time=11.131 ms
   64 bytes from 192.168.204.254: icmp_seq=2 ttl=64 time=11.129 ms
   ^C
   --- 192.168.204.254 ping statistics ---
   3 packets transmitted, 3 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 0.869/7.710/11.131/4.837 ms

   show route table secure-oam

   secure-oam.inet.0: 11 destinations, 11 routes (11 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 3w1d 01:40:09
                       > to 192.168.70.1 via irb.70
   192.168.10.0/24    *[Static/5] 3w1d 01:40:09
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 3w1d 01:40:09
                       > via irb.70
   192.168.70.254/32  *[Local/0] 3w1d 01:40:09
                         Local via irb.70
   192.168.194.0/24   *[Direct/0] 2d 01:39:23
                       > via xe-0/0/41.0
   192.168.194.1/32   *[Local/0] 2d 01:39:23
                         Local via xe-0/0/41.0
   192.168.204.0/24   *[Direct/0] 00:50:32
                       > via xe-0/0/46.0
   192.168.204.1/32   *[Local/0] 00:50:32
                         Local via xe-0/0/46.0
   192.168.210.1/32   *[BGP/170] 1d 23:06:36, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   192.168.210.2/32   *[BGP/170] 00:09:12, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.204.254 via xe-0/0/46.0
   192.168.210.3/32   *[BGP/170] 1d 22:22:57, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0

Wait until the Management Status of the new Device turns into “Device_Connected”

|image530|

Now ACTIVATE the device

|image531|

|image532|

Wait until the device is fully provisioned

|image533|

.. note::  The below is taken from a different lab

|image534|

Change to the already existing “hubspoketenant”

|image535|

Use Sites -> Site Management -> Add -> Cloud Hub to make this new hub visible to the customer

|image536|

|image537|

On-board Spoke with Hub Redundancy configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Use Sites -> Site Management -> Add -> On-Premise Spoke

|image538|

|image539|

|image540|\ |image541|

|image542|

|image543|

|image544|

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "hubspoketenant",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "sdwansite2",
                   "site_basic_properties": {
                       "local_breakout": {},
                       "multi_homing_enabled": true,
                       "gatewaySite": false,
                       "site_type": "on_premise",
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": false,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "provider": "abc",
                                       "wan_link": "WAN_0",
                                       "access_type": "Ethernet",
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "029b00eb-18c7-29bc-983f-ec2e5f8668e2",
                                       "cost": 2222,
                                       "subscribed_bandwidth": 1000,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "provider": "xyz",
                                       "wan_link": "WAN_1",
                                       "access_type": "Ethernet",
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "6bb78dee-2063-2eea-57ba-0315182f9721",
                                       "cost": 111,
                                       "subscribed_bandwidth": 1000,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "NFX_Advanced_SDWAN_CPE_option_1",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "10.66.66.1/24",
                                       "lan_segment_name": "desktop4",
                                       "vlan": 1066,
                                       "lan_ports": [
                                           "LAN_0"
                                       ],
                                       "department": "Default",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwansite2"
                           }
                       ],
                       "0": {
                           "ip_prefix": "10.66.66.1/24",
                           "lan_segment_name": "desktop4",
                           "vlan": 1066,
                           "lan_ports": [
                               "LAN_0"
                           ],
                           "department": "Default",
                           "dhcp": false
                       },
                       "site_role": "SPOKE",
                       "sla_mgmt": "COARSE",
                       "device_profile_name": "NFX250 as SD-WAN CPE",
                       "site_name": "sdwansite2",
                       "site_group": null,
                       "dvpn_params": {
                           "delete_dvpn_threshold": "1",
                           "create_dvpn_threshold": "5"
                       },
                       "topology": "Bandwidth Optimized"
                   }
               }
           ]
       }
   }
   

Configure the new site now:

|image545|

|image546|

|image547|

|image548|

|image549|

|image550|

|image551|

|image552|

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "hubspoketenant",
           "job_name_prefix": "hubspoketenant-sdwansite2",
           "site": [
               {
                   "on_premise_site_info": {
                       "device": [
                           {
                               "is_gateway_site": false,
                               "wan_link": [
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           },
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.200.1",
                                                   "peer_device": "hub2"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 1
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/10",
                                       "local_breakout_enabled": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.130.1",
                                           "ip_address": "192.168.130.2/24"
                                       },
                                       "used_for_oam": true,
                                       "traffic_type": "OAM_AND_DATA",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           },
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.201.1",
                                                   "peer_device": "hub2"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 1
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/11",
                                       "local_breakout_enabled": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.133.1",
                                           "ip_address": "192.168.133.2/24"
                                       },
                                       "used_for_oam": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   }
                               ],
                               "device_name": "sdwansite2",
                               "device_template": "NFX_Advanced_SDWAN_CPE_option_1",
                               "device_details": {
                                   "serial_number": "DD2116AF0059"
                               },
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.4/32"
                               }
                           }
                       ],
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           },
                           {
                               "hub_role": "SECONDARY",
                               "hub_name": "hub2"
                           }
                       ],
                       "region": "regional",
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       }
                   },
                   "site_name": "sdwansite2",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }
   

Then ACTIVATE the device in CSO so that it will be provisioned.

|image553|

|image554|

Now wait ~ 25minutes for the Provision process to finish

|image555|

On the Spoke inside the vSRX GWR you should now see FOUR Tunnels permanently established:

.. code-block:: none

   root@GWR.sdwansite2.hubspoketenant> show interfaces terse
   .
   .
   gr-0/0/0.4000           up    up   inet     10.152.0.129/31
                                      mpls
   gr-0/0/0.4001           up    up   inet     10.152.0.131/31
                                      mpls
   gr-0/0/0.4004           up    up   inet     10.136.0.129/31
                                      mpls
   gr-0/0/0.4005           up    up   inet     10.136.0.131/31
                                      mpls
   .
   .
   # remember the other 4 tunnels are for the OAM-Function on each Hub
   st0.4000                up    up   inet     10.160.0.129/31
   st0.4001                up    up   inet     10.176.0.129/31
   st0.4002                up    up   inet     10.176.0.131/31
   st0.4003                up    up   inet     10.160.0.131/31
   st0.4004                up    up   inet     10.144.0.129/31
   st0.4005                up    up   inet     10.128.0.131/31
   st0.4006                up    up   inet     10.144.0.131/31
   st0.4007                up    up   inet     10.128.0.129/31
   .
   .

After you have created and deployed a default Firewall Rule that allows Traffic to the Internet please verify that the Desktop4 VM is able to ping 8.8.8.8 and 8.8.4.4

|image556|

|image557|

Failover Testcase with Static Routes in the Underlay
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note:: When you execute these two test cases you better use a console session to the Spoke as the SSH connection will break each time.

This test case should be executed with customer who want to see how the system works. As we use static routes at some point we will see interrupted Traffic when the spoke moves to the new hub but some of our routes point to the old hub still. However with this test you can exactly see the failover behaviour and when things are happening in time.

Before you intercept any traffic review the current state on the Spoke:

.. code-block:: none

   show security flow session destination-prefix 8.8.8.8
   Session ID: 135398, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.66.66.66/925 --> 8.8.8.8/1353;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1353 --> 10.66.66.66/925;icmp, Conn Tag: 0x0, If: gr-0/0/0.4004, Pkts: 1, Bytes: 84,
   .
   .
   show interfaces terse

and maybe also on the underlay switch

.. code-block:: none

   show route table secure-oam

   secure-oam.inet.0: 11 destinations, 12 routes (11 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 5w4d 01:25:58
                       > to 192.168.70.1 via irb.70
   192.168.10.0/24    *[Static/5] 5w4d 01:25:58
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 5w4d 01:25:58
                       > via irb.70
   192.168.70.254/32  *[Local/0] 5w4d 01:25:58
                         Local via irb.70
   192.168.194.0/24   *[Direct/0] 4d 21:48:33
                       > via irb.194
   192.168.194.1/32   *[Local/0] 4d 21:48:33
                         Local via irb.194
   192.168.204.0/24   *[Direct/0] 2w2d 19:28:16
                       > via xe-0/0/46.0
   192.168.204.1/32   *[Local/0] 2w2d 19:28:16
                         Local via xe-0/0/46.0
   192.168.210.1/32   *[BGP/170] 4d 21:48:26, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   192.168.210.2/32   *[BGP/170] 4d 18:04:39, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.204.254 via xe-0/0/46.0
   192.168.210.4/32   *[BGP/170] 00:07:47, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
                       [BGP/170] 2d 22:19:58, localpref 100
                         AS path: 64512 64512 I, validation-state: unverified
                       > to 192.168.204.254 via xe-0/0/46.0

Disable BOTH Links at Primary Hub1 via QFX5100-1 to simulate a complete device outage.

.. warning:: Do not isolate just ONE Hub interface as the device might not failover in some sittuations `CXU-26726 <https://aspg-jira.juniper.net/browse/CXU-26726>`__.

The below isolates the WAN_0/1 interfaces of the Hub1

.. code-block:: none

   edit
   set interface xe-0/0/37.0 disable
   set interface xe-0/0/38.0 disable
   commit and-quit

After **10-20seconds** you should the the impacted Tunnels on the Spoke

.. code-block:: none

   root@GWR.sdwansite2.hubspoketenant> show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   .
   gr-0/0/0.4000           up    down inet     172.26.55.32/31
                                      mpls
   gr-0/0/0.4002           up    up   inet     172.20.135.176/31
                                      mpls
   gr-0/0/0.4004           up    down inet     172.18.123.238/31
                                      mpls
   gr-0/0/0.4006           up    up   inet     172.26.79.116/31
                                      mpls
   .
   .
   st0.4000                up    up   inet     172.18.146.242/31
   st0.4001                up    down inet     172.29.4.154/31
   st0.4002                up    up   inet     172.18.86.52/31
   st0.4003                up    down inet     172.23.122.150/31
   st0.4004                up    down inet     172.17.98.50/31
   st0.4005                up    up   inet     172.24.170.156/31
   st0.4006                up    down inet     172.16.34.104/31
   st0.4007                up    up   inet     172.23.112.146/31 
   .

On the QFX5100 the OAM endpoint also moved to Hub2 completely

.. code-block:: none

   run show route table secure-oam
   secure-oam.inet.0: 11 destinations, 11 routes (11 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   .
   .
   192.168.210.4/32   *[BGP/170] 2d 22:02:49, localpref 100
                         AS path: 64512 64512 I, validation-state: unverified
                       > to 192.168.204.254 via xe-0/0/46.0

Also you will see which Tunnel is impacted in the GUI

|image558|

After about a minute where the first Tunnel was brought down you will see that the Traffic from the Desktop VM is no longer responded or stops. This is because the Spoke has now completely moved to the new Hub2 and as a result the overlay Traffic is now going to the WAN_1 of Hub2 instead of formerly (WAN_1 of Hub1).

Right now we still have static routes so we must change them to match the return Path to the new Interface. Apply the config change on the QFX5100-1 below:

.. code-block:: none

   edit
   delete groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.88.88.0/24 next-hop 192.168.191.254
   delete groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.191.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.88.88.0/24 next-hop 192.168.201.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.201.254
   commit and-quit

You should now be able to reach the Internet from the Desktop VM at the LAN side of the Spoke.

.. code-block:: none

   root@GWR.sdwansite2.hubspoketenant> show security flow session destination-prefix 8.8.8.8
   Session ID: 134542, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.66.66.66/333 --> 8.8.8.8/1353;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1353 --> 10.66.66.66/333;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 1, Bytes: 84,
   .
   .

Now Heal the bad links on the primary Spoke on the QFX5100-1.

.. code-block:: none

   edit
   delete interface xe-0/0/37.0 disable
   delete interface xe-0/0/38.0 disable
   commit and-quit

You should see the healed GRE and IPsec Tunnels after a Minute

.. code-block:: none

   root@GWR.sdwansite2.hubspoketenant> show interfaces terse
   .
   gr-0/0/0.4000           up    up   inet     172.26.55.32/31
                                      mpls
   gr-0/0/0.4002           up    up   inet     172.20.135.176/31
                                      mpls
   gr-0/0/0.4004           up    up   inet     172.18.123.238/31
                                      mpls
   gr-0/0/0.4006           up    up   inet     172.26.79.116/31
                                      mpls
   .
   .
   st0.4000                up    up   inet     172.18.146.242/31
   st0.4001                up    up   inet     172.29.4.154/31
   st0.4002                up    up   inet     172.18.86.52/31
   st0.4003                up    up   inet     172.23.122.150/31
   st0.4004                up    up   inet     172.17.98.50/31
   st0.4005                up    up   inet     172.24.170.156/31
   st0.4006                up    up   inet     172.16.34.104/31
   st0.4007                up    up   inet     172.23.112.146/31
   .

After around 30-40 seconds the Traffic on the Desktop VM will stop again as the system has moved over back to the Primary hub and now the Internet traffic uses WAN_1 of Hub1 again but our Routes for the return traffic still point to WAN_1 of Hub2. So revert your change back to the original.

.. code-block:: none

   edit
   delete groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.88.88.0/24 next-hop 192.168.201.254
   delete groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.201.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.88.88.0/24 next-hop 192.168.191.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.191.254
   commit and-quit

Your Traffic should now flow back over the original GRe Tunnel to the Primary Hub.

.. code-block:: none

   root@GWR.sdwansite2.hubspoketenant> show security flow session destination-prefix 8.8.8.8
   Session ID: 135305, Policy name: Intent_1/7, Timeout: 2, Valid
     In: 10.66.66.66/861 --> 8.8.8.8/1353;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1353 --> 10.66.66.66/861;icmp, Conn Tag: 0x0, If: gr-0/0/0.4004, Pkts: 1, Bytes: 84,
   .
   .

Failover Test case with NAT on the Hubs
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In the past section we had to flip static Routes to make the return traffic go to the right Hub after a failover happened. Here, for simplicity, we will implement NAT on each of the Hub-Interfaces.

The below has to be executed on hub1 AND hub2 to have them SNAT on WAN_1 so that the original source IP’s are hidden towards the internet and no routes need to be changed.

.. code-block:: none

   edit
   delete apply-groups tenant-nat
   set groups tenant-nat security policies from-zone trust-hubspoketenant to-zone untrust-WAN_1 policy PermitAll match source-address any
   set groups tenant-nat security policies from-zone trust-hubspoketenant to-zone untrust-WAN_1 policy PermitAll match destination-address any
   set groups tenant-nat security policies from-zone trust-hubspoketenant to-zone untrust-WAN_1 policy PermitAll match application any
   set groups tenant-nat security policies from-zone trust-hubspoketenant to-zone untrust-WAN_1 policy PermitAll then permit
   set groups tenant-nat security nat source rule-set tenantnat from zone trust-hubspoketenant
   set groups tenant-nat security nat source rule-set tenantnat to interface ge-0/0/1.0
   set groups tenant-nat security nat source rule-set tenantnat rule r42 match source-address 0.0.0.0/0 
   set groups tenant-nat security nat source rule-set tenantnat rule r42 then source-nat interface
   set apply-groups tenant-nat
   run request security policies resync
   commit and-quit

Verify that the hub now apply NAT with his WAN_1 Interface IP while the second should not have any traffic yet.

.. code-block:: none

   root@DB0916AK0994.hub1.default-project> show security flow session destination-prefix 8.8.8.8
   Session ID: 1187712, Policy name: trust-hubspoketenant-to-untrust-WAN_1/10, Timeout: 2, Valid
     In: 10.66.66.66/29668 --> 8.8.8.8/8336;icmp, Conn Tag: 0x0, If: gr-0/0/0.4009, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/8336 --> 192.168.191.254/9397;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,
   .
   .
   .

   root@DB0916AK0922.hub2.default-project> show security flow session destination-prefix 8.8.8.8
   Total sessions: 0

Restart the two Pings to 8.8.8.8 and 8.8.4.4 on the Desktop VM so that the counters are reset.

Now simulate again a complete outage of Hub1 in disabling both interfaces at the same time on the QFX5100-1

.. code-block:: none

   set interface xe-0/0/37.0 disable
   set interface xe-0/0/38.0 disable
   commit

On the Spoke you should see:

.. code-block:: none

   root@GWR.sdwansite2.hubspoketenant> show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   .
   gr-0/0/0.4000           up    down inet     172.26.55.32/31
                                      mpls
   gr-0/0/0.4002           up    up   inet     172.20.135.176/31
                                      mpls
   gr-0/0/0.4004           up    down inet     172.18.123.238/31
                                      mpls
   gr-0/0/0.4006           up    up   inet     172.26.79.116/31
                                      mpls 
   .
   .
   st0.4000                up    up   inet     172.18.146.242/31
   st0.4001                up    down inet     172.29.4.154/31
   st0.4002                up    up   inet     172.18.86.52/31
   st0.4003                up    down inet     172.23.122.150/31
   st0.4004                up    down inet     172.17.98.50/31
   st0.4005                up    up   inet     172.24.170.156/31
   st0.4006                up    down inet     172.16.34.104/31
   st0.4007                up    up   inet     172.23.112.146/31 .
   .

On the first hub you should see:

.. code-block:: none

   root@DB0916AK0994.hub1.default-project> ping 192.168.190.1
   PING 192.168.190.1 (192.168.190.1): 56 data bytes
   ^C
   --- 192.168.190.1 ping statistics ---
   2 packets transmitted, 0 packets received, 100% packet loss

   root@DB0916AK0994.hub1.default-project> ping 192.168.191.1
   PING 192.168.191.1 (192.168.191.1): 56 data bytes
   ^C
   --- 192.168.191.1 ping statistics ---
   2 packets transmitted, 0 packets received, 100% packet loss

   root@DB0916AK0994.hub1.default-project> show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   .
   gr-0/0/0.4006           up    down inet     172.26.55.33/31
                                      mpls
   gr-0/0/0.4007           up    up   inet     172.18.123.239/31
                                      mpls 
   .
   .
   st0.4012                up    down inet     172.29.4.155/31
   st0.4013                up    down inet     172.23.122.151/31
   st0.4014                up    down inet     172.17.98.51/31
   st0.4015                up    down inet     172.16.34.105/31 
   .

On the second hub you should see:

.. code-block:: none

   root@DB0916AK0922.hub2.default-project> show security flow session destination-prefix 8.8.8.8
   Session ID: 5895, Policy name: trust-hubspoketenant-to-untrust-WAN_1/10, Timeout: 2, Valid
     In: 10.66.66.66/30376 --> 8.8.8.8/8336;icmp, Conn Tag: 0x0, If: gr-0/0/0.4001, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/8336 --> 192.168.201.254/25366;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,

   Session ID: 5897, Policy name: trust-hubspoketenant-to-untrust-WAN_1/10, Timeout: 2, Valid
     In: 10.66.66.66/30377 --> 8.8.8.8/8336;icmp, Conn Tag: 0x0, If: gr-0/0/0.4001, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/8336 --> 192.168.201.254/1265;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,

   Session ID: 5899, Policy name: trust-hubspoketenant-to-untrust-WAN_1/10, Timeout: 4, Valid
     In: 10.66.66.66/30378 --> 8.8.8.8/8336;icmp, Conn Tag: 0x0, If: gr-0/0/0.4001, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/8336 --> 192.168.201.254/1753;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,
   Total sessions: 3

Stop the Pings on the Desktop VM and review how many Packets have been lost during the transition.

|image559|

Start the two Pings on the Desktop VM again and let them run.

Now heal the links again on the QFX5100-1

.. code-block:: none

   delete interface xe-0/0/37.0 disable
   delete interface xe-0/0/38.0 disable
   commit

Wait a minute or so and then check that the Spoke is back on the Primary Hub sending Traffic again to the Internet

.. code-block:: none

   root@DB0916AK0994.hub1.default-project> show security flow session destination-prefix 8.8.8.8
   Session ID: 1190370, Policy name: trust-hubspoketenant-to-untrust-WAN_1/10, Timeout: 2, Valid
     In: 10.66.66.66/213 --> 8.8.8.8/506;icmp, Conn Tag: 0x0, If: gr-0/0/0.4009, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/506 --> 192.168.191.254/2090;icmp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 1, Bytes: 84,

Now review how many Pings have been lost due to the switch-back and you should see no or a few Ping’s lost as re-establishing the new IPsec and then failover is saver then waiting on timeouts as before.

|image560|

You can discuss with the Customer that you can use also a routing protocol in the underlay to not need to configure NAT on the Hubs but we don’t use this in this Lab as this is not an introduction on routing-protocols and has nothing to do with SD-WAN as such.

Spoke-Redundancy aka Dual-Spoke
-------------------------------

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. This will **SAVE** you huge amount of **TIME** and will guarantee that the lab configuration is in **PROPER STATE**. It will **AVOID** any **MISCONFIGURATION** you do via manual cut&paste.

If you want to bring this lab into this state you should click here:

|image561|

.. note:: As you see it will take care to apply the changes from chapter 7.4.1 and chapter 7.4.2 so you can jump over those.

**MANDATORY!** For this Lab to work correctly you have to patch **two DIRECT, PHYSICAL Links** between the two NFX250 on their SFP+ Ethernet Ports (can be Copper or Fibre). **Use 10GBit/s SFP+** and NOT 1GBit/s SFPs (else you need to change the Device Template as advised below)!!!

|image562|

This feature provides CPE Redundancy for business-critical SD-WAN sites, protecting them against

-  CPE device failures. Heal time is expected around 30-60 Seconds
-  LAN side link failures. Heal time is expected ~3 Seconds (called State full Failover below)
-  WAN side link failures (not executed as test as it’s too trivial)

Starting with CSO 3.3 the Dual-CPE feature is implemented using two identical physical CPE devices:

Either 2 NFX250 or SRX3xx. A single logical secure router is created using the 2 CPE devices as shown below

SD-WAN functionality same as that of a single CPE with 4 active WAN links, but with the following caveats:

-  AppQoE (Real Time Optimized SLA) not supported in 3.3
-  LTE WAN link not supported in 3.3

CPE devices supported:

-  NFX250 with 15.1X53-D472 release

   -  GWR vSRX running 15.1X49-D133 (or higher depending on CSO release)
   -  Leverages vSRX Chassis Cluster technology
   -  NFX software (JDM & JCP) unaware of clustering

-  Branch SRX 300, 320, 340, 345

   -  Two identical devices formed into a Chassis Cluster
   -  15.1X49-D133 release (or higher depending on CSO release)

| 
| Also on the Hub side you have to have 4 WAN interfaces for this feature.

|image563|

Figure: Dual CPE logical implementation

Deployment considerations

-  For NFX250, ports 12 and 13 to be inter-connected back-to-back for control & fab links as shown in Picture below.
-  For SRX, control and fab ports vary based on model
-  LAG links between LAN side switches and the two CPE for redundancy.

   -  This can be a one-time config on the switch
   -  At least 2 links recommended in each LAG for better redundancy

-  LAN switch can be any make/model. Recommendations are:

   -  It should have built-in redundancy
   -  Must support LAG

Connect ports from different members/line-cards to the 2 CPEs. E.g. all links to CPE0 can be from member-1 and all links to CPE1 can be from member-2

|image564|

Figure: Physical connections for NFX Dual CPE

For further details, please refer to:

-  https://junipernetworks-my.sharepoint.com/:p:/g/personal/rjoyce_juniper_net/EeLRKABNg4NGrnVKdFn2EXcBobZ7Ju9-L_uhjs5sspDLtg?e=ZFsaIZ
-  https://junipernetworks.sharepoint.com/sites/open1/cloud-srv/Product/Demo%20Videos/R3.3/Dual_CPE-Hub_Multihoming.mp4

NFX250-2 configuration
~~~~~~~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. If you have applied the changes from executing the “Dual Spoke (HA via NFX250)” then you can ignore this section.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

First we need the second NFX250 now. The configuration changes only minimal to the one in Chapter 3.3.4.5 above but we need to gather the new Serial ID of the Device.

Here you NEED a Terminal Server to access the device via console

.. code-block:: none

   cli
   request system zeroize
   yes
   
   # use the minicom over the ssh 192.168.10.2/172.30.200.152 (root/Lab58fgr#-1)      
   
   cli
   show configuration version
   # make sure you have upgraded the firmware to the right version
   # for CSO 4.1.0 it is required to use 15.1X53-D496
   edit
   set system host-name nfx250-2
   # review the device template for updated huge-page numbers to assign
   # In current CSO the NFX250-S1 has 9 and the NFX250-S2 has 13
   set system memory hugepages page-size 1024 page-count 13
   set system root-authentication plain-text-password
   New password: Embe1mpls
   Retype new password: Embe1mpls
   delete interfaces jmgmt0 unit 0
   # set this interface only for debugging as it shortcuts the OAM
   # set interfaces jmgmt0 unit 0 family inet address 192.168.10.25/24
   delete system phone-home server https://redirect.juniper.net
   set system phone-home server https://centralmsvm.example.net
   set system name-server 192.168.10.10
   commit and-quit
   exit
   
   cat /config/device_serial_id
   DD2316AF0086

   #
   # use the server cert from the Post CSO install procedure
   # and append it to the ca file to be recognized
   #
   cp /var/phone-home/phcd-ca.crt /var/phone-home/phcd-ca.crt.orig
   
   cat <<EOF >>/var/phone-home/phcd-ca.crt
   -----BEGIN CERTIFICATE-----
   MIIDrjCCApYCCQDZ8BNWtFex/DANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMC
   VVMxCzAJBgNVBAgMAkNBMRkwFwYDVQQKDBBKdW5pcGVyIE5ldHdvcmtzMRIwEAYD
   VQQHDAlTdW5ueXZhbGUxIDAeBgNVBAMMF2NlbnRyYWxtc3ZtLmV4YW1wbGUubmV0
   MQwwCgYDVQQLDANDU1AxHTAbBgkqhkiG9w0BCQEWDnRlc3RAZW1haWwubmV0MB4X
   DTE4MDcxMjEzMDYwNFoXDTIxMDQwNjEzMDYwNFowgZgxCzAJBgNVBAYTAlVTMQsw
   CQYDVQQIDAJDQTEZMBcGA1UECgwQSnVuaXBlciBOZXR3b3JrczESMBAGA1UEBwwJ
   U3Vubnl2YWxlMSAwHgYDVQQDDBdjZW50cmFsbXN2bS5leGFtcGxlLm5ldDEMMAoG
   A1UECwwDQ1NQMR0wGwYJKoZIhvcNAQkBFg50ZXN0QGVtYWlsLm5ldDCCASIwDQYJ
   KoZIhvcNAQEBBQADggEPADCCAQoCggEBAKtiYIRnR2Yq0eE/aqGTu+7MDFjxpjWX
   3CNf+yiNpG+dxtCcEXNrq1//UiBdPJlcKXq5mNOY359O0ueQrFhwPqaRwXoC04lR
   /W+2wLwse0ePeweQ0hd6GTQWAOjRfyQew+DZp31W10YDRSc8qzZTkgnYWqBJVFt/
   MnKgWNj8R50l0DK+nPhzDgo3iHVQh1M4x2muI238GSOJOsZNyOf0bUfj8Yti89AN
   wLIuQvbxaxP1qpbwRNK8ciA4DQr7RczNBVT4rsqw4GM3Hqtic7umM/EOQ1RCTjiU
   uGd56FkIqkkYGQ8nMWh7Uxfo1d+G8wjFXBUE6pxsMicU9DmZEKDix9ECAwEAATAN
   BgkqhkiG9w0BAQsFAAOCAQEAICz4G05p96lQToWDLf86XK24m8YtTAMZlckcErCx
   h2nQEDbiltSwspiaeyyenoAnK5KmGR6ijZDFuNIr5GIjbjx9RgrOLBacNDBous8Q
   C77w9BmCZB0TSuGMFeeV07A0lSEqoc2wX89Pic7rchb3LorJKE+ZEB0U2fppXp2o
   y8LnqX6ZgYH9QD5FBbVyTK0sw1aqPP/pRsv6Pa9mfvKivNPzfERJiFJkNdqvIj39
   iwUuwJUF3sN6cdKMj8s1irYnNhsB62M2pNFOCtvzIe+xLhbMlNEY1Qoiyk+KJOvZ
   fzX+nt1TrRi7zq+yGFSkOQ4kwAiWxSPUCZOcGLTjUd1G/Q==
   -----END CERTIFICATE-----
   EOF
   
   # Needed with new firmware else the added cert will be removed during reboot
   # If you forget this new step then ZTP will not work!!!
   cp /var/phone-home/phcd-ca.crt /var/phone-home/ca-bundle-1.crt  
   
   #cat /var/phone-home/phcd-ca.crt


   cli
   request system reboot
   yes

QFX5100-1 changes for this lab
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. If you have applied the changes from executing the “Dual Spoke (HA via NFX250)” then you can ignore this section.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

The configuration changes on the underlay are too much to use the existing sdwan-basic apply group. We disable the existing group and setup a new group called “sdwan-ha-spoke” and use this one to change the underlay configuration.

.. code-block:: none

   delete apply-groups sdwan-basic
   delete apply-groups sdwan-hubredunant
   
   delete groups sdwan-spoke-ha
   set apply-groups sdwan-spoke-ha
   
   delete interfaces xe-0/0/22
   delete protocols rstp interface xe-0/0/22
   set groups sdwan-spoke-ha interfaces xe-0/0/22 unit 0 family inet address 192.168.130.1/24
   delete interfaces xe-0/0/28
   delete protocols rstp interface xe-0/0/28
   set groups sdwan-spoke-ha interfaces xe-0/0/28 unit 0 family inet address 192.168.150.1/24
   set groups sdwan-spoke-ha routing-instances spoke-wan0 instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-spoke-ha routing-instances spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-spoke-ha routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet network 192.168.130.0/24
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet range spoke-wan0-nfx1-pool-range low 192.168.130.100
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet range spoke-wan0-nfx1-pool-range high 192.168.130.199
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet dhcp-attributes router 192.168.130.1
   set groups sdwan-spoke-ha routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet network 192.168.150.0/24
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet range spoke-wan0-nfx2-pool-range low 192.168.150.100
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet range spoke-wan0-nfx2-pool-range high 192.168.150.199
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet dhcp-attributes router 192.168.150.1
   set groups sdwan-spoke-ha routing-instances spoke-wan0 routing-options static route 0.0.0.0/0 next-hop 192.168.131.254
   
   set groups sdwan-spoke-ha interfaces irb unit 131 family inet address 192.168.131.1/24
   set groups sdwan-spoke-ha vlans vlan131 vlan-id 131
   set groups sdwan-spoke-ha vlans vlan131 l3-interface irb.131
   set groups sdwan-spoke-ha routing-instances spoke-wan0 interface irb.131
   
   delete interfaces xe-0/0/23
   delete protocols rstp interface xe-0/0/23
   set groups sdwan-spoke-ha interfaces xe-0/0/23 unit 0 family inet address 192.168.133.1/24
   delete interfaces xe-0/0/29
   delete protocols rstp interface xe-0/0/29
   set groups sdwan-spoke-ha interfaces xe-0/0/29 unit 0 family inet address 192.168.153.1/24
   set groups sdwan-spoke-ha routing-instances spoke-wan1 instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-spoke-ha routing-instances spoke-wan1 interface xe-0/0/29.0
   set groups sdwan-spoke-ha routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet network 192.168.133.0/24
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet range spoke-wan1-nfx1-pool-range low 192.168.133.100
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet range spoke-wan1-nfx1-pool-range high 192.168.133.199
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet dhcp-attributes router 192.168.133.1
   set groups sdwan-spoke-ha routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/29.0
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet network 192.168.153.0/24
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet range spoke-wan1-nfx2-pool-range low 192.168.153.100
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet range spoke-wan1-nfx2-pool-range high 192.168.153.199
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet dhcp-attributes router 192.168.153.1
   set groups sdwan-spoke-ha routing-instances spoke-wan1 routing-options static route 0.0.0.0/0 next-hop 192.168.134.254
   
   set groups sdwan-spoke-ha interfaces irb unit 134 family inet address 192.168.134.1/24
   set groups sdwan-spoke-ha vlans vlan134 vlan-id 134
   set groups sdwan-spoke-ha vlans vlan134 l3-interface irb.134
   set groups sdwan-spoke-ha routing-instances spoke-wan1 interface irb.134
   
   
   delete interfaces xe-0/0/37
   delete protocols rstp interface xe-0/0/37
   set groups sdwan-spoke-ha interfaces xe-0/0/37 unit 0 family inet address 192.168.190.1/24
   delete interfaces xe-0/0/39
   delete protocols rstp interface xe-0/0/39
   set groups sdwan-spoke-ha interfaces xe-0/0/39 unit 0 family inet address 192.168.192.1/24
   set groups sdwan-spoke-ha routing-instances hub-wan0 instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances hub-wan0 interface xe-0/0/37.0
   set groups sdwan-spoke-ha routing-instances hub-wan0 interface xe-0/0/39.0
   set groups sdwan-spoke-ha routing-instances hub-wan0 routing-options static route 192.168.130.0/24 next-hop 192.168.132.254
   set groups sdwan-spoke-ha routing-instances hub-wan0 routing-options static route 192.168.150.0/24 next-hop 192.168.132.254
   
   set groups sdwan-spoke-ha interfaces irb unit 132 family inet address 192.168.132.1/24
   set groups sdwan-spoke-ha vlans vlan132 vlan-id 132
   set groups sdwan-spoke-ha vlans vlan132 l3-interface irb.132
   set groups sdwan-spoke-ha routing-instances hub-wan0 interface irb.132
   
   
   delete interfaces xe-0/0/38
   delete protocols rstp interface xe-0/0/38
   set groups sdwan-spoke-ha interfaces xe-0/0/38 unit 0 family inet address 192.168.191.1/24
   delete interfaces xe-0/0/40
   delete protocols rstp interface xe-0/0/40
   set groups sdwan-spoke-ha interfaces xe-0/0/40 unit 0 family inet address 192.168.193.1/24
   set groups sdwan-spoke-ha routing-instances hub-wan1 instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances hub-wan1 interface xe-0/0/38.0
   set groups sdwan-spoke-ha routing-instances hub-wan1 interface xe-0/0/40.0
   set groups sdwan-spoke-ha routing-instances hub-wan1 routing-options static route 192.168.133.0/24 next-hop 192.168.135.254
   set groups sdwan-spoke-ha routing-instances hub-wan1 routing-options static route 192.168.153.0/24 next-hop 192.168.135.254
   # route for the Spoke LAN’s to go to Internet
   set groups sdwan-spoke-ha routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.191.254
   
   
   set groups sdwan-spoke-ha interfaces irb unit 135 family inet address 192.168.135.1/24
   set groups sdwan-spoke-ha vlans vlan135 vlan-id 135
   set groups sdwan-spoke-ha vlans vlan135 l3-interface irb.135
   set groups sdwan-spoke-ha routing-instances hub-wan1 interface irb.135
   
   
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 131
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 132
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 134
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 135
   
   delete protocols rstp interface xe-0/0/36
   delete protocols rstp interface xe-0/0/41
   
   commit
   
   # setup and connect the LAN interfaces of the two spoke devices
   
   set groups sdwan-spoke-ha vlans desktop4 vlan-id 1066
   
   set chassis aggregated-devices ethernet device-count 10
   
   set groups sdwan-spoke-ha interfaces ae0 aggregated-ether-options lacp periodic fast
   set groups sdwan-spoke-ha interfaces ae0 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-spoke-ha interfaces ae0 unit 0 family ethernet-switching interface-mode trunk
   
   delete interface xe-0/0/18
   delete interface xe-0/0/19
   delete groups sdwan-spoke-ha interfaces xe-0/0/18 unit 0
   set groups sdwan-spoke-ha interfaces xe-0/0/18 ether-options 802.3ad ae0
   delete groups sdwan-spoke-ha interfaces xe-0/0/19 unit 0
   set groups sdwan-spoke-ha interfaces xe-0/0/19 ether-options 802.3ad ae0
   
   set groups sdwan-spoke-ha interfaces ae1 aggregated-ether-options lacp periodic fast
   set groups sdwan-spoke-ha interfaces ae1 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-spoke-ha interfaces ae1 unit 0 family ethernet-switching interface-mode trunk
   
   delete interface xe-0/0/26
   delete interface xe-0/0/27
   delete groups sdwan-spoke-ha interfaces xe-0/0/26 unit 0
   set groups sdwan-spoke-ha interfaces xe-0/0/26 ether-options 802.3ad ae1
   delete groups sdwan-spoke-ha interfaces xe-0/0/27 unit 0
   set groups sdwan-spoke-ha interfaces xe-0/0/27 ether-options 802.3ad ae1
   
   delete protocols rstp interface xe-0/0/18
   delete protocols rstp interface xe-0/0/19
   delete protocols rstp interface xe-0/0/26
   delete protocols rstp interface xe-0/0/27
   
   # IF to Desktop4 VM
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1066
   
   commit
   
   
   # also make sure the other interfaces towards NFX1 unused in this demo are disabled
   delete interfaces xe-0/0/19 disable
   set interfaces xe-0/0/20 disable
   set interfaces xe-0/0/21 disable
   delete interfaces xe-0/0/22 disable
   delete interfaces xe-0/0/23 disable
   set interfaces xe-0/0/24 disable
   set interfaces xe-0/0/25 disable
   
   # also make sure the other interfaces towards NFX2 unused in this demo are disabled
   delete interfaces xe-0/0/26 disable
   delete interfaces xe-0/0/27 disable
   delete interfaces xe-0/0/28 disable
   delete interfaces xe-0/0/29 disable
   set interfaces xe-0/0/30 disable
   set interfaces xe-0/0/31 disable
   
   
   # also make sure the other interfaces towards srx345 unused in this demo are disabled
   set interfaces xe-0/0/32 disable
   set interfaces xe-0/0/33 disable
   set interfaces xe-0/0/34 disable
   set interfaces xe-0/0/35 disable
   set interfaces xe-0/0/36 disable
   
   
   
   # also make sure the other interfaces towards srx1500-1 unused in this demo are disabled
   # you only need ge-0/0/0 and ge-0/0/1 in this demo
   delete interfaces xe-0/0/37 disable
   delete interfaces xe-0/0/38 disable
   delete interfaces xe-0/0/39 disable
   delete interfaces xe-0/0/40 disable
   set interfaces xe-0/0/41 disable
   
   
   
   #
   # Ribgroups and VRs and interfaces for Internet Access
   #
   set groups sdwan-spoke-ha interfaces irb unit 70 family inet address 192.168.70.254/24
   set groups sdwan-spoke-ha vlans natuplink vlan-id 70
   set groups sdwan-spoke-ha vlans natuplink l3-interface irb.70
   
   set groups sdwan-spoke-ha routing-instances internetaccess instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances internetaccess interface irb.70
   set groups sdwan-spoke-ha routing-instances internetaccess routing-options static route 0.0.0.0/0 next-hop 192.168.70.1
   
   delete groups sdwan-spoke-ha policy-options policy-statement directandstatic1
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic1 term a from instance internetaccess
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic1 term a then accept
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic1 term b then reject
   set groups sdwan-spoke-ha routing-instances hub-wan0 routing-options instance-import directandstatic1
   set groups sdwan-spoke-ha routing-instances hub-wan1 routing-options instance-import directandstatic1
   
   delete groups sdwan-spoke-ha policy-options policy-statement directandstatic2
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term c from instance hub-wan0
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term c then accept
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term d from instance hub-wan1
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term d then accept
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term e then reject
   set groups sdwan-spoke-ha routing-instances internetaccess routing-options instance-import directandstatic2
   
   
   # hub1 to NAT gw uplink
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 70
   
   #
   # Changes for CSO 4.1.0
   #
   
   delete interfaces xe-0/0/41
   delete protocols rstp interface xe-0/0/41
   set groups sdwan-spoke-ha  interfaces xe-0/0/41 unit 0 family inet address 192.168.194.1/24
   
   delete groups sdwan-spoke-ha  routing-instances secure-oam
   set groups sdwan-spoke-ha  routing-instances secure-oam instance-type virtual-router
   set groups sdwan-spoke-ha  routing-instances secure-oam interface xe-0/0/41.0
   set groups sdwan-spoke-ha  routing-instances secure-oam routing-options static route 192.168.10.0/24 next-hop 192.168.70.1
   set groups sdwan-spoke-ha  routing-instances secure-oam routing-options autonomous-system 65000
   set groups sdwan-spoke-ha  routing-instances secure-oam routing-options instance-import directandstatic1
   set groups sdwan-spoke-ha  routing-instances secure-oam protocols bgp group ebgp type external
   set groups sdwan-spoke-ha  routing-instances secure-oam protocols bgp group ebgp export export-cso
   set groups sdwan-spoke-ha  routing-instances secure-oam protocols bgp group ebgp peer-as 64512
   set groups sdwan-spoke-ha  routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.194.254
   set groups sdwan-spoke-ha  routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.204.254
   set groups sdwan-spoke-ha  policy-options policy-statement export-cso term cso-net from route-filter 192.168.10.0/24 exact
   set groups sdwan-spoke-ha  policy-options policy-statement export-cso term cso-net then accept
   
   delete groups sdwan-spoke-ha  policy-options policy-statement directandstatic2
   set groups sdwan-spoke-ha  policy-options policy-statement directandstatic2 term c from instance hub-wan0
   set groups sdwan-spoke-ha  policy-options policy-statement directandstatic2 term c then accept
   set groups sdwan-spoke-ha  policy-options policy-statement directandstatic2 term d from instance hub-wan1
   set groups sdwan-spoke-ha  policy-options policy-statement directandstatic2 term d then accept
   set groups sdwan-spoke-ha  policy-options policy-statement directandstatic2 term e from instance secure-oam
   set groups sdwan-spoke-ha  policy-options policy-statement directandstatic2 term e then accept
   set groups sdwan-spoke-ha  policy-options policy-statement directandstatic2 term f then reject
   
   commit
   

After the change the Routes and VLAN’s should look like this:

.. hidden-code-block:: none

   root@qfx5100-1> show route
   
   
   inet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   192.168.10.0/24    *[Direct/0] 17w0d 20:08:23
                       > via vme.0
   192.168.10.20/32   *[Local/0] 17w0d 20:08:23
                         Local via vme.0
   192.168.211.0/24   *[Direct/0] 3w5d 23:41:28
                       > via xe-0/0/2.211
   192.168.211.1/32   *[Local/0] 3w5d 23:41:28
                         Local via xe-0/0/2.211
   192.168.212.0/24   *[Direct/0] 3w5d 23:41:28
                       > via xe-0/0/2.212
   192.168.212.1/32   *[Local/0] 3w5d 23:41:28
                         Local via xe-0/0/2.212
   
   spoke-wan0.inet.0: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 17w0d 20:05:54
                       > to 192.168.131.254 via irb.131
   192.168.130.0/24   *[Direct/0] 00:48:56
                       > via xe-0/0/22.0
   192.168.130.1/32   *[Local/0] 00:48:56
                         Local via xe-0/0/22.0
   192.168.131.0/24   *[Direct/0] 17w0d 20:05:54
                       > via irb.131
   192.168.131.1/32   *[Local/0] 17w0d 20:05:54
                         Local via irb.131
   192.168.150.0/24   *[Direct/0] 3w3d 19:46:29
                       > via xe-0/0/28.0
   192.168.150.1/32   *[Local/0] 3w3d 19:46:29
                         Local via xe-0/0/28.0
   
   spoke-wan1.inet.0: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 17w0d 20:05:54
                       > to 192.168.134.254 via irb.134
   192.168.133.0/24   *[Direct/0] 00:48:56
                       > via xe-0/0/23.0
   192.168.133.1/32   *[Local/0] 00:48:56
                         Local via xe-0/0/23.0
   192.168.134.0/24   *[Direct/0] 17w0d 20:05:54
                       > via irb.134
   192.168.134.1/32   *[Local/0] 17w0d 20:05:54
                         Local via irb.134
   192.168.153.0/24   *[Direct/0] 3w3d 19:46:29
                       > via xe-0/0/29.0
   192.168.153.1/32   *[Local/0] 3w3d 19:46:29
                         Local via xe-0/0/29.0
   
   hub-wan0.inet.0: 11 destinations, 11 routes (11 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:02:05
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 00:02:05
                       > via irb.70
   192.168.70.254/32  *[Local/0] 00:02:05
                         Local via irb.70
   192.168.130.0/24   *[Static/5] 17w0d 20:05:54
                       > to 192.168.132.254 via irb.132
   192.168.132.0/24   *[Direct/0] 17w0d 20:05:54
                       > via irb.132
   192.168.132.1/32   *[Local/0] 17w0d 20:05:54
                         Local via irb.132
   192.168.150.0/24   *[Static/5] 11w5d 17:22:51
                       > to 192.168.132.254 via irb.132
   192.168.190.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/37.0
   192.168.190.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/37.0
   192.168.192.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/39.0
   192.168.192.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/39.0
   
   hub-wan1.inet.0: 12 destinations, 12 routes (12 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:02:05
                       > to 192.168.70.1 via irb.70
   10.66.66.0/24      *[Static/5] 00:00:53
                       > to 192.168.191.254 via xe-0/0/38.0
   192.168.70.0/24    *[Direct/0] 00:02:05
                       > via irb.70
   192.168.70.254/32  *[Local/0] 00:02:05
                         Local via irb.70
   192.168.133.0/24   *[Static/5] 17w0d 20:05:54
                       > to 192.168.135.254 via irb.135
   192.168.135.0/24   *[Direct/0] 17w0d 20:05:54
                       > via irb.135
   192.168.135.1/32   *[Local/0] 17w0d 20:05:54
                         Local via irb.135
   192.168.153.0/24   *[Static/5] 11w5d 17:22:51
                       > to 192.168.135.254 via irb.135
   192.168.191.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/38.0
   192.168.191.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/38.0
   192.168.193.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/40.0
   192.168.193.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/40.0
   
   internetaccess.inet.0: 23 destinations, 23 routes (23 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:02:05
                       > to 192.168.70.1 via irb.70
   10.66.66.0/24      *[Static/5] 00:00:53
                       > to 192.168.191.254 via xe-0/0/38.0
   192.168.10.0/24    *[Static/5] 00:02:05
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 00:02:05
                       > via irb.70
   192.168.70.254/32  *[Local/0] 00:02:05
                         Local via irb.70
   192.168.130.0/24   *[Static/5] 00:02:06
                       > to 192.168.132.254 via irb.132
   192.168.132.0/24   *[Direct/0] 00:02:06
                       > via irb.132
   192.168.132.1/32   *[Local/0] 00:02:06
                         Local via irb.132
   192.168.133.0/24   *[Static/5] 00:02:06
                       > to 192.168.135.254 via irb.135
   192.168.135.0/24   *[Direct/0] 00:02:06
                       > via irb.135
   192.168.135.1/32   *[Local/0] 00:02:06
                         Local via irb.135
   192.168.150.0/24   *[Static/5] 00:02:06
                       > to 192.168.132.254 via irb.132
   192.168.153.0/24   *[Static/5] 00:02:06
                       > to 192.168.135.254 via irb.135
   192.168.190.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/37.0
   192.168.190.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/37.0
   192.168.191.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/38.0
   192.168.191.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/38.0
   192.168.192.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/39.0
   192.168.192.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/39.0
   192.168.193.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/40.0
   192.168.193.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/40.0
   192.168.194.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/41.0
   192.168.194.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/41.0
   
   secure-oam.inet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:02:05
                       > to 192.168.70.1 via irb.70
   192.168.10.0/24    *[Static/5] 00:02:05
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 00:02:05
                       > via irb.70
   192.168.70.254/32  *[Local/0] 00:02:05
                         Local via irb.70
   192.168.194.0/24   *[Direct/0] 00:00:53
                       > via xe-0/0/41.0
   192.168.194.1/32   *[Local/0] 00:00:53
                         Local via xe-0/0/41.0
   
   inet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   ff02::2/128        *[INET6/0] 17w0d 20:08:28
                         MultiRecv 
   
   
   root@qfx5100-121# run show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   gr-0/0/0                up    up
   pfe-0/0/0               up    up
   pfe-0/0/0.16383         up    up   inet
                                      inet6
   pfh-0/0/0               up    up
   pfh-0/0/0.16383         up    up   inet
   pfh-0/0/0.16384         up    up   inet
   xe-0/0/0                up    up
   xe-0/0/0.0              up    up   eth-switch
   xe-0/0/1                up    down
   xe-0/0/1.0              up    down eth-switch
   xe-0/0/2                up    up
   xe-0/0/2.211            up    up   inet     192.168.211.1/24
   xe-0/0/2.212            up    up   inet     192.168.212.1/24
   xe-0/0/2.32767          up    up
   xe-0/0/3                up    up
   xe-0/0/3.0              up    up   eth-switch
   xe-0/0/4                up    up
   xe-0/0/4.0              up    up   eth-switch
   xe-0/0/5                up    up
   xe-0/0/5.0              up    up   eth-switch
   xe-0/0/6                up    up
   xe-0/0/6.0              up    up   eth-switch
   xe-0/0/7                up    up
   xe-0/0/7.0              up    up   eth-switch
   xe-0/0/8                up    up
   xe-0/0/8.0              up    up   eth-switch
   xe-0/0/9                up    down
   xe-0/0/9.0              up    down eth-switch
   xe-0/0/10               up    up
   xe-0/0/10.0             up    up   eth-switch
   xe-0/0/11               up    up
   xe-0/0/11.0             up    up   eth-switch
   xe-0/0/12               up    up
   xe-0/0/12.0             up    up   eth-switch
   xe-0/0/13               up    up
   xe-0/0/13.0             up    up   eth-switch
   xe-0/0/14               up    up
   xe-0/0/14.0             up    up   eth-switch
   xe-0/0/15               up    up
   xe-0/0/15.0             up    up   eth-switch
   xe-0/0/16               up    up
   xe-0/0/16.0             up    up   eth-switch
   xe-0/0/17               up    up
   xe-0/0/17.0             up    up   eth-switch
   xe-0/0/18               up    up
   xe-0/0/18.0             up    up   aenet    --> ae0.0
   xe-0/0/19               up    up
   xe-0/0/19.0             up    up   aenet    --> ae0.0
   xe-0/0/20               down  down
   xe-0/0/20.0             up    down eth-switch
   xe-0/0/21               down  down
   xe-0/0/21.0             up    down eth-switch
   xe-0/0/22               up    up
   xe-0/0/22.0             up    up   inet     192.168.130.1/24
   xe-0/0/23               up    up
   xe-0/0/23.0             up    up   inet     192.168.133.1/24
   xe-0/0/24               down  down
   xe-0/0/25               down  down
   xe-0/0/26               up    up
   xe-0/0/26.0             up    up   aenet    --> ae1.0
   xe-0/0/27               up    up
   xe-0/0/27.0             up    up   aenet    --> ae1.0
   xe-0/0/28               up    up
   xe-0/0/28.0             up    up   inet     192.168.150.1/24
   xe-0/0/29               up    up
   xe-0/0/29.0             up    up   inet     192.168.153.1/24
   xe-0/0/30               down  down
   xe-0/0/30.0             up    down eth-switch
   xe-0/0/31               down  down
   xe-0/0/31.0             up    down eth-switch
   xe-0/0/32               down  down
   xe-0/0/33               down  down
   xe-0/0/34               down  down
   xe-0/0/34.0             up    down eth-switch
   xe-0/0/35               down  down
   xe-0/0/35.0             up    down eth-switch
   xe-0/0/36               down  down
   xe-0/0/37               up    up
   xe-0/0/37.0             up    up   inet     192.168.190.1/24
   xe-0/0/38               up    up
   xe-0/0/38.0             up    up   inet     192.168.191.1/24
   xe-0/0/39               up    up
   xe-0/0/39.0             up    up   inet     192.168.192.1/24
   xe-0/0/40               up    up
   xe-0/0/40.0             up    up   inet     192.168.193.1/24
   xe-0/0/41               up    up
   xe-0/0/41.0             up    up   inet     192.168.194.1/24
   xe-0/0/42               up    up
   xe-0/0/42.16386         up    up
   xe-0/0/43               up    up
   xe-0/0/43.16386         up    up
   xe-0/0/44               up    down
   xe-0/0/44.0             up    down eth-switch
   xe-0/0/45               up    up
   xe-0/0/45.0             up    up   eth-switch
   xe-0/0/46               up    up
   xe-0/0/46.16386         up    up
   xe-0/0/47               up    up
   xe-0/0/47.0             up    up   eth-switch
   xe-0/0/48:0             up    up
   xe-0/0/48:0.0           up    up   eth-switch
   xe-0/0/48:1             up    down
   xe-0/0/48:1.0           up    down eth-switch
   xe-0/0/48:2             up    down
   xe-0/0/48:2.0           up    down eth-switch
   xe-0/0/48:3             up    down
   xe-0/0/48:3.0           up    down eth-switch
   ae0                     up    down
   ae0.0                   up    down eth-switch
   ae1                     up    down
   ae1.0                   up    down eth-switch
   bme0                    up    up
   bme0.0                  up    up   inet     128.0.0.1/2
                                               128.0.0.4/2
                                               128.0.0.16/2
                                               128.0.0.63/2
   bme1                    up    up
   cbp0                    up    up
   dsc                     up    up
   em0                     up    up
   em0.0                   up    up   eth-switch
   em1                     up    down
   em1.0                   up    down inet
   em2                     up    up
   em2.32768               up    up   inet     192.168.1.2/24
   esi                     up    up
   gre                     up    up
   ipip                    up    up
   irb                     up    up
   irb.0                   up    up   inet
   irb.70                  up    up   inet     192.168.70.254/24
   irb.131                 up    up   inet     192.168.131.1/24
   irb.132                 up    up   inet     192.168.132.1/24
   irb.134                 up    up   inet     192.168.134.1/24
   irb.135                 up    up   inet     192.168.135.1/24
   jsrv                    up    up
   jsrv.1                  up    up   inet     128.0.0.127/2
   lo0                     up    up
   lo0.16385               up    up   inet
   lsi                     up    up
   mtun                    up    up
   pimd                    up    up
   pime                    up    up
   pip0                    up    up
   tap                     up    up
   vme                     up    up
   vme.0                   up    up   inet     192.168.10.20/24
   vtep                    up    up
   
   root@qfx5100-121# run show vlans
   
   Routing instance        VLAN name             Tag          Interfaces
   default-switch          default               1
                                                              xe-0/0/0.0*
                                                              xe-0/0/1.0
                                                              xe-0/0/3.0*
                                                              xe-0/0/4.0*
                                                              xe-0/0/5.0*
                                                              xe-0/0/6.0*
                                                              xe-0/0/7.0*
                                                              xe-0/0/8.0*
                                                              xe-0/0/9.0
                                                              xe-0/0/10.0*
                                                              xe-0/0/14.0*
                                                              xe-0/0/16.0*
                                                              xe-0/0/30.0
                                                              xe-0/0/31.0
                                                              xe-0/0/34.0
                                                              xe-0/0/35.0
                                                              xe-0/0/44.0
                                                              xe-0/0/45.0*
                                                              xe-0/0/47.0*
                                                              xe-0/0/48:0.0*
                                                              xe-0/0/48:1.0
                                                              xe-0/0/48:2.0
                                                              xe-0/0/48:3.0
   default-switch          desktop4              1066
                                                              ae0.0
                                                              ae1.0
                                                              xe-0/0/48:0.0*
   default-switch          natuplink             70
                                                              xe-0/0/48:0.0*
   default-switch          ucpe-client1          1099
                                                              xe-0/0/48:0.0*
   default-switch          ucpe-data             66
                                                              xe-0/0/11.0*
                                                              xe-0/0/20.0
   default-switch          ucpe-data-nat         75
                                                              xe-0/0/17.0*
                                                              xe-0/0/48:0.0*
   default-switch          ucpe-internet         67
                                                              xe-0/0/12.0*
                                                              xe-0/0/21.0
   default-switch          ucpe-oam              65
                                                              xe-0/0/11.0*
                                                              xe-0/0/20.0
   default-switch          ucpe-oam-cso          64
                                                              xe-0/0/13.0*
                                                              xe-0/0/48:0.0*
   default-switch          ucpe-oam-nat          76
                                                              xe-0/0/17.0*
                                                              xe-0/0/48:0.0*
   default-switch          vcpe-client3          1077
                                                              xe-0/0/15.0*
                                                              xe-0/0/48:0.0*
   default-switch          vcpe-nat              74
                                                              xe-0/0/17.0*
                                                              xe-0/0/48:0.0*
   default-switch          vlan131               131
                                                              xe-0/0/48:0.0*
   default-switch          vlan132               132
                                                              xe-0/0/48:0.0*
   default-switch          vlan134               134
                                                              xe-0/0/48:0.0*
   default-switch          vlan135               135
                                                              xe-0/0/48:0.0*
   
   
   set groups sdwan-basic interfaces xe-0/0/22 unit 0 family inet address 192.168.130.1/24
   set groups sdwan-basic interfaces xe-0/0/32 unit 0 family inet address 192.168.170.1/24
   set groups sdwan-basic interfaces irb unit 131 family inet address 192.168.131.1/24
   set groups sdwan-basic interfaces irb unit 134 family inet address 192.168.134.1/24
   set groups sdwan-basic interfaces irb unit 132 family inet address 192.168.132.1/24
   set groups sdwan-basic interfaces irb unit 135 family inet address 192.168.135.1/24
   set groups sdwan-basic interfaces irb unit 70 family inet address 192.168.70.254/24
   set groups sdwan-basic interfaces irb unit 190 family inet address 192.168.190.1/24
   set groups sdwan-basic interfaces irb unit 191 family inet address 192.168.191.1/24
   set groups sdwan-basic interfaces irb unit 194 family inet address 192.168.194.1/24
   set groups sdwan-basic interfaces xe-0/0/23 unit 0 family inet address 192.168.133.1/24
   set groups sdwan-basic interfaces xe-0/0/33 unit 0 family inet address 192.168.173.1/24
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 70
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 131-132
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 134-135
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 190-191
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 194
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1088
   set groups sdwan-basic interfaces xe-0/0/36 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-basic interfaces xe-0/0/36 unit 0 family ethernet-switching vlan members 1088
   set groups sdwan-basic interfaces xe-0/0/18 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-basic interfaces xe-0/0/18 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-basic interfaces xe-0/0/28 unit 0 family inet address 192.168.150.1/24
   set groups sdwan-basic interfaces xe-0/0/29 unit 0 family inet address 192.168.153.1/24
   set groups sdwan-basic interfaces xe-0/0/37 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-basic interfaces xe-0/0/37 unit 0 family ethernet-switching vlan members 190
   set groups sdwan-basic interfaces xe-0/0/38 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-basic interfaces xe-0/0/38 unit 0 family ethernet-switching vlan members 191
   set groups sdwan-basic interfaces xe-0/0/41 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-basic interfaces xe-0/0/41 unit 0 family ethernet-switching vlan members 194
   set groups sdwan-basic policy-options policy-statement export-cso term cso-net from route-filter 192.168.10.0/24 exact
   set groups sdwan-basic policy-options policy-statement export-cso term cso-net then accept
   set groups sdwan-basic policy-options policy-statement directandstatic1 term a from instance internetaccess
   set groups sdwan-basic policy-options policy-statement directandstatic1 term a then accept
   set groups sdwan-basic policy-options policy-statement directandstatic1 term b then reject
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c from instance hub-wan0
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d from instance hub-wan1
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term e from instance secure-oam
   set groups sdwan-basic policy-options policy-statement directandstatic2 term e then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term f then reject
   set groups sdwan-basic routing-instances spoke-wan0 instance-type virtual-router
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/32.0
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet network 192.168.130.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range low 192.168.130.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range high 192.168.130.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes router 192.168.130.1
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet network 192.168.170.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet range spoke-wan0-srx-pool-range low 192.168.170.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet range spoke-wan0-srx-pool-range high 192.168.170.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes router 192.168.170.1
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet network 192.168.150.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet range spoke-wan0-nfx5-pool-range low 192.168.150.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet range spoke-wan0-nfx5-pool-range high 192.168.150.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet dhcp-attributes router 192.168.150.1
   set groups sdwan-basic routing-instances spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-basic routing-instances spoke-wan0 interface xe-0/0/32.0
   set groups sdwan-basic routing-instances spoke-wan0 interface irb.131
   set groups sdwan-basic routing-instances spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-basic routing-instances spoke-wan0 routing-options static route 0.0.0.0/0 next-hop 192.168.131.254
   set groups sdwan-basic routing-instances spoke-wan1 instance-type virtual-router
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/33.0
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/29.0
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet network 192.168.133.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range low 192.168.133.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range high 192.168.133.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes router 192.168.133.1
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet network 192.168.173.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet range spoke-wan1-srx-pool-range low 192.168.173.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet range spoke-wan1-srx-pool-range high 192.168.173.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes router 192.168.173.1
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet network 192.168.153.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet range spoke-wan1-nfx5-pool-range low 192.168.153.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet range spoke-wan1-nfx5-pool-range high 192.168.153.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet dhcp-attributes router 192.168.153.1
   set groups sdwan-basic routing-instances spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-basic routing-instances spoke-wan1 interface xe-0/0/33.0
   set groups sdwan-basic routing-instances spoke-wan1 interface irb.134
   set groups sdwan-basic routing-instances spoke-wan1 interface xe-0/0/29.0
   set groups sdwan-basic routing-instances spoke-wan1 routing-options static route 0.0.0.0/0 next-hop 192.168.134.254
   set groups sdwan-basic routing-instances hub-wan0 instance-type virtual-router
   set groups sdwan-basic routing-instances hub-wan0 interface irb.132
   set groups sdwan-basic routing-instances hub-wan0 interface irb.190
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.130.0/24 next-hop 192.168.132.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.170.0/24 next-hop 192.168.132.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 35.156.179.143/32 next-hop 192.168.211.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.150.0/24 next-hop 192.168.132.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options instance-import directandstatic1
   set groups sdwan-basic routing-instances hub-wan1 instance-type virtual-router
   set groups sdwan-basic routing-instances hub-wan1 interface irb.135
   set groups sdwan-basic routing-instances hub-wan1 interface xe-0/0/25.0
   set groups sdwan-basic routing-instances hub-wan1 interface irb.191
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.133.0/24 next-hop 192.168.135.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.173.0/24 next-hop 192.168.135.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 18.184.47.41/32 next-hop 192.168.212.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 35.156.179.143/32 next-hop 192.168.211.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.153.0/24 next-hop 192.168.135.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.88.88.0/24 next-hop 192.168.191.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.191.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options instance-import directandstatic1
   set groups sdwan-basic routing-instances internetaccess instance-type virtual-router
   set groups sdwan-basic routing-instances internetaccess interface irb.70
   set groups sdwan-basic routing-instances internetaccess routing-options static route 0.0.0.0/0 next-hop 192.168.70.1
   set groups sdwan-basic routing-instances internetaccess routing-options instance-import directandstatic2
   set groups sdwan-basic routing-instances secure-oam instance-type virtual-router
   set groups sdwan-basic routing-instances secure-oam interface irb.194
   set groups sdwan-basic routing-instances secure-oam routing-options static route 192.168.10.0/24 next-hop 192.168.70.1
   set groups sdwan-basic routing-instances secure-oam routing-options autonomous-system 65000
   set groups sdwan-basic routing-instances secure-oam routing-options instance-import directandstatic1
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp type external
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp export export-cso
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp peer-as 64512
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.194.254
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.204.254
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.194.253
   set groups sdwan-basic vlans vlan131 vlan-id 131
   set groups sdwan-basic vlans vlan131 l3-interface irb.131
   set groups sdwan-basic vlans vlan134 vlan-id 134
   set groups sdwan-basic vlans vlan134 l3-interface irb.134
   set groups sdwan-basic vlans vlan132 vlan-id 132
   set groups sdwan-basic vlans vlan132 l3-interface irb.132
   set groups sdwan-basic vlans vlan135 vlan-id 135
   set groups sdwan-basic vlans vlan135 l3-interface irb.135
   set groups sdwan-basic vlans desktop2 vlan-id 1088
   set groups sdwan-basic vlans desktop4 vlan-id 1066
   set groups sdwan-basic vlans natuplink vlan-id 70
   set groups sdwan-basic vlans natuplink l3-interface irb.70
   set groups sdwan-basic vlans vlan190 vlan-id 190
   set groups sdwan-basic vlans vlan190 l3-interface irb.190
   set groups sdwan-basic vlans vlan191 vlan-id 191
   set groups sdwan-basic vlans vlan191 l3-interface irb.191
   set groups sdwan-basic vlans vlan194 vlan-id 194
   set groups sdwan-basic vlans vlan194 l3-interface irb.194
   set groups sdwan-hubredunant interfaces xe-0/0/42 unit 0 family inet address 192.168.200.1/24
   set groups sdwan-hubredunant interfaces xe-0/0/43 unit 0 family inet address 192.168.201.1/24
   set groups sdwan-hubredunant interfaces xe-0/0/44 disable
   set groups sdwan-hubredunant interfaces xe-0/0/45 disable
   set groups sdwan-hubredunant interfaces xe-0/0/46 unit 0 family inet address 192.168.204.1/24
   set groups sdwan-hubredunant routing-instances hub-wan0 interface xe-0/0/42.0
   set groups sdwan-hubredunant routing-instances hub-wan1 interface xe-0/0/43.0
   set groups sdwan-hubredunant routing-instances secure-oam interface xe-0/0/46.0
   set groups sdwan-spoke-ha interfaces xe-0/0/22 unit 0 family inet address 192.168.130.1/24
   set groups sdwan-spoke-ha interfaces xe-0/0/28 unit 0 family inet address 192.168.150.1/24
   set groups sdwan-spoke-ha interfaces irb unit 131 family inet address 192.168.131.1/24
   set groups sdwan-spoke-ha interfaces irb unit 134 family inet address 192.168.134.1/24
   set groups sdwan-spoke-ha interfaces irb unit 132 family inet address 192.168.132.1/24
   set groups sdwan-spoke-ha interfaces irb unit 135 family inet address 192.168.135.1/24
   set groups sdwan-spoke-ha interfaces irb unit 70 family inet address 192.168.70.254/24
   set groups sdwan-spoke-ha interfaces xe-0/0/23 unit 0 family inet address 192.168.133.1/24
   set groups sdwan-spoke-ha interfaces xe-0/0/29 unit 0 family inet address 192.168.153.1/24
   set groups sdwan-spoke-ha interfaces xe-0/0/37 unit 0 family inet address 192.168.190.1/24
   set groups sdwan-spoke-ha interfaces xe-0/0/39 unit 0 family inet address 192.168.192.1/24
   set groups sdwan-spoke-ha interfaces xe-0/0/38 unit 0 family inet address 192.168.191.1/24
   set groups sdwan-spoke-ha interfaces xe-0/0/40 unit 0 family inet address 192.168.193.1/24
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 70
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 131-132
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 134-135
   set groups sdwan-spoke-ha interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-spoke-ha interfaces ae0 aggregated-ether-options lacp periodic fast
   set groups sdwan-spoke-ha interfaces ae0 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-spoke-ha interfaces ae0 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-spoke-ha interfaces xe-0/0/18 ether-options 802.3ad ae0
   set groups sdwan-spoke-ha interfaces xe-0/0/19 ether-options 802.3ad ae0
   set groups sdwan-spoke-ha interfaces ae1 aggregated-ether-options lacp periodic fast
   set groups sdwan-spoke-ha interfaces ae1 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-spoke-ha interfaces ae1 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-spoke-ha interfaces xe-0/0/26 ether-options 802.3ad ae1
   set groups sdwan-spoke-ha interfaces xe-0/0/27 ether-options 802.3ad ae1
   set groups sdwan-spoke-ha interfaces xe-0/0/41 unit 0 family inet address 192.168.194.1/24
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic1 term a from instance internetaccess
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic1 term a then accept
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic1 term b then reject
   set groups sdwan-spoke-ha policy-options policy-statement export-cso term cso-net from route-filter 192.168.10.0/24 exact
   set groups sdwan-spoke-ha policy-options policy-statement export-cso term cso-net then accept
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term c from instance hub-wan0
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term c then accept
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term d from instance hub-wan1
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term d then accept
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term e from instance secure-oam
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term e then accept
   set groups sdwan-spoke-ha policy-options policy-statement directandstatic2 term f then reject
   set groups sdwan-spoke-ha routing-instances spoke-wan0 instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-spoke-ha routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet network 192.168.130.0/24
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet range spoke-wan0-nfx1-pool-range low 192.168.130.100
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet range spoke-wan0-nfx1-pool-range high 192.168.130.199
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx1-pool family inet dhcp-attributes router 192.168.130.1
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet network 192.168.150.0/24
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet range spoke-wan0-nfx2-pool-range low 192.168.150.100
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet range spoke-wan0-nfx2-pool-range high 192.168.150.199
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-spoke-ha routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet dhcp-attributes router 192.168.150.1
   set groups sdwan-spoke-ha routing-instances spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-spoke-ha routing-instances spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-spoke-ha routing-instances spoke-wan0 interface irb.131
   set groups sdwan-spoke-ha routing-instances spoke-wan0 routing-options static route 0.0.0.0/0 next-hop 192.168.131.254
   set groups sdwan-spoke-ha routing-instances spoke-wan1 instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-spoke-ha routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/29.0
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet network 192.168.133.0/24
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet range spoke-wan1-nfx1-pool-range low 192.168.133.100
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet range spoke-wan1-nfx1-pool-range high 192.168.133.199
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx1-pool family inet dhcp-attributes router 192.168.133.1
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet network 192.168.153.0/24
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet range spoke-wan1-nfx2-pool-range low 192.168.153.100
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet range spoke-wan1-nfx2-pool-range high 192.168.153.199
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-spoke-ha routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet dhcp-attributes router 192.168.153.1
   set groups sdwan-spoke-ha routing-instances spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-spoke-ha routing-instances spoke-wan1 interface xe-0/0/29.0
   set groups sdwan-spoke-ha routing-instances spoke-wan1 interface irb.134
   set groups sdwan-spoke-ha routing-instances spoke-wan1 routing-options static route 0.0.0.0/0 next-hop 192.168.134.254
   set groups sdwan-spoke-ha routing-instances hub-wan0 instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances hub-wan0 interface xe-0/0/37.0
   set groups sdwan-spoke-ha routing-instances hub-wan0 interface xe-0/0/39.0
   set groups sdwan-spoke-ha routing-instances hub-wan0 interface irb.132
   set groups sdwan-spoke-ha routing-instances hub-wan0 routing-options static route 192.168.130.0/24 next-hop 192.168.132.254
   set groups sdwan-spoke-ha routing-instances hub-wan0 routing-options static route 192.168.150.0/24 next-hop 192.168.132.254
   set groups sdwan-spoke-ha routing-instances hub-wan0 routing-options instance-import directandstatic1
   set groups sdwan-spoke-ha routing-instances hub-wan1 instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances hub-wan1 interface xe-0/0/38.0
   set groups sdwan-spoke-ha routing-instances hub-wan1 interface xe-0/0/40.0
   set groups sdwan-spoke-ha routing-instances hub-wan1 interface irb.135
   set groups sdwan-spoke-ha routing-instances hub-wan1 routing-options static route 192.168.133.0/24 next-hop 192.168.135.254
   set groups sdwan-spoke-ha routing-instances hub-wan1 routing-options static route 192.168.153.0/24 next-hop 192.168.135.254
   set groups sdwan-spoke-ha routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.191.254
   set groups sdwan-spoke-ha routing-instances hub-wan1 routing-options instance-import directandstatic1
   set groups sdwan-spoke-ha routing-instances internetaccess instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances internetaccess interface irb.70
   set groups sdwan-spoke-ha routing-instances internetaccess routing-options static route 0.0.0.0/0 next-hop 192.168.70.1
   set groups sdwan-spoke-ha routing-instances internetaccess routing-options instance-import directandstatic2
   set groups sdwan-spoke-ha routing-instances secure-oam instance-type virtual-router
   set groups sdwan-spoke-ha routing-instances secure-oam interface xe-0/0/41.0
   set groups sdwan-spoke-ha routing-instances secure-oam routing-options static route 192.168.10.0/24 next-hop 192.168.70.1
   set groups sdwan-spoke-ha routing-instances secure-oam routing-options autonomous-system 65000
   set groups sdwan-spoke-ha routing-instances secure-oam routing-options instance-import directandstatic1
   set groups sdwan-spoke-ha routing-instances secure-oam protocols bgp group ebgp type external
   set groups sdwan-spoke-ha routing-instances secure-oam protocols bgp group ebgp export export-cso
   set groups sdwan-spoke-ha routing-instances secure-oam protocols bgp group ebgp peer-as 64512
   set groups sdwan-spoke-ha routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.194.254
   set groups sdwan-spoke-ha routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.204.254
   set groups sdwan-spoke-ha vlans vlan131 vlan-id 131
   set groups sdwan-spoke-ha vlans vlan131 l3-interface irb.131
   set groups sdwan-spoke-ha vlans vlan134 vlan-id 134
   set groups sdwan-spoke-ha vlans vlan134 l3-interface irb.134
   set groups sdwan-spoke-ha vlans vlan132 vlan-id 132
   set groups sdwan-spoke-ha vlans vlan132 l3-interface irb.132
   set groups sdwan-spoke-ha vlans vlan135 vlan-id 135
   set groups sdwan-spoke-ha vlans vlan135 l3-interface irb.135
   set groups sdwan-spoke-ha vlans desktop4 vlan-id 1066
   set groups sdwan-spoke-ha vlans natuplink vlan-id 70
   set groups sdwan-spoke-ha vlans natuplink l3-interface irb.70
   set apply-groups sdwan-spoke-ha
   set system host-name qfx5100-121
   set system arp aging-timer 5
   set system root-authentication encrypted-password "$6$nCsDlN7N$qTG9G3zHHBcF8wwIkuH3VAwbwU4oV4kdhwv7CSyenNDA/qReSfZ2kuUPGcQWmnON4mfKAwjC323c8hkKr3iWh1"
   set system name-server 192.168.10.10
   set system services ssh root-login allow
   set system services ssh client-alive-interval 120
   set system services netconf ssh
   set system syslog user * any emergency
   set system syslog file messages any notice
   set system syslog file messages authorization info
   set system syslog file interactive-commands interactive-commands any
   set system processes dhcp-service traceoptions file dhcp_logfile
   set system processes dhcp-service traceoptions file size 10m
   set system processes dhcp-service traceoptions level all
   set system processes dhcp-service traceoptions flag all
   set system ntp boot-server 192.168.10.10
   set system ntp server 192.168.10.10
   set chassis aggregated-devices ethernet device-count 10
   set interfaces xe-0/0/0 ether-options auto-negotiation
   set interfaces xe-0/0/0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/1 ether-options auto-negotiation
   set interfaces xe-0/0/1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/2 vlan-tagging
   set interfaces xe-0/0/2 unit 211 vlan-id 211
   set interfaces xe-0/0/2 unit 211 family inet address 192.168.211.1/24
   set interfaces xe-0/0/2 unit 212 vlan-id 212
   set interfaces xe-0/0/2 unit 212 family inet address 192.168.212.1/24
   set interfaces xe-0/0/3 ether-options auto-negotiation
   set interfaces xe-0/0/3 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/4 ether-options auto-negotiation
   set interfaces xe-0/0/4 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/5 ether-options auto-negotiation
   set interfaces xe-0/0/5 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/6 ether-options auto-negotiation
   set interfaces xe-0/0/6 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/7 ether-options auto-negotiation
   set interfaces xe-0/0/7 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/8 ether-options auto-negotiation
   set interfaces xe-0/0/8 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/9 ether-options auto-negotiation
   set interfaces xe-0/0/9 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/10 ether-options auto-negotiation
   set interfaces xe-0/0/10 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/11 description "ucpe oam and data to mx"
   set interfaces xe-0/0/11 ether-options auto-negotiation
   set interfaces xe-0/0/11 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/11 unit 0 family ethernet-switching vlan members 65-66
   set interfaces xe-0/0/11 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/12 description "ucpe internet to mx"
   set interfaces xe-0/0/12 ether-options auto-negotiation
   set interfaces xe-0/0/12 unit 0 family ethernet-switching vlan members 67
   set interfaces xe-0/0/12 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/13 description "second CSO OAM for ucpe to nfx"
   set interfaces xe-0/0/13 ether-options auto-negotiation
   set interfaces xe-0/0/13 unit 0 family ethernet-switching vlan members 64
   set interfaces xe-0/0/13 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/14 description "vcpe vnf-mgnt on mx"
   set interfaces xe-0/0/14 ether-options auto-negotiation
   set interfaces xe-0/0/14 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/15 description "vcpe client3"
   set interfaces xe-0/0/15 ether-options auto-negotiation
   set interfaces xe-0/0/15 unit 0 family ethernet-switching vlan members 1077
   set interfaces xe-0/0/15 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/16 ether-options auto-negotiation
   set interfaces xe-0/0/16 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/17 ether-options auto-negotiation
   set interfaces xe-0/0/17 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/17 unit 0 family ethernet-switching vlan members 74-76
   set interfaces xe-0/0/17 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/20 description "ucpe oam and data from nfx"
   set interfaces xe-0/0/20 disable
   set interfaces xe-0/0/20 ether-options auto-negotiation
   set interfaces xe-0/0/20 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/20 unit 0 family ethernet-switching vlan members 65-66
   set interfaces xe-0/0/20 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/21 description "ucpe internet from nfx"
   set interfaces xe-0/0/21 disable
   set interfaces xe-0/0/21 ether-options auto-negotiation
   set interfaces xe-0/0/21 unit 0 family ethernet-switching vlan members 67
   set interfaces xe-0/0/21 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/24 disable
   set interfaces xe-0/0/25 disable
   set interfaces xe-0/0/30 disable
   set interfaces xe-0/0/30 ether-options auto-negotiation
   set interfaces xe-0/0/30 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/31 disable
   set interfaces xe-0/0/31 ether-options auto-negotiation
   set interfaces xe-0/0/31 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/32 disable
   set interfaces xe-0/0/33 disable
   set interfaces xe-0/0/34 disable
   set interfaces xe-0/0/34 ether-options auto-negotiation
   set interfaces xe-0/0/34 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/35 disable
   set interfaces xe-0/0/35 ether-options auto-negotiation
   set interfaces xe-0/0/35 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/36 disable
   set interfaces xe-0/0/44 ether-options auto-negotiation
   set interfaces xe-0/0/44 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/45 ether-options auto-negotiation
   set interfaces xe-0/0/45 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/47 ether-options auto-negotiation
   set interfaces xe-0/0/47 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/48 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/48:0 native-vlan-id 1
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 64
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 74-76
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1077
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1099
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/48:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/48:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/48:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/49 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/49:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/49:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/49:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/49:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/50 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/50:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/50:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/50:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/50:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/51 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/51:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/51:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/51:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/51:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/52 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/52:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/52:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/52:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/52:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/53 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/53:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/53:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/53:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/53:3 unit 0 family ethernet-switching storm-control default
   set interfaces em1 unit 0 family inet
   set interfaces irb unit 0 family inet
   set interfaces vme unit 0 family inet address 192.168.10.20/24
   set forwarding-options storm-control-profiles default all
   set protocols lldp interface all
   set protocols lldp-med interface all
   set protocols igmp-snooping vlan default
   set protocols rstp interface all
   set vlans default vlan-id 1
   set vlans default l3-interface irb.0
   set vlans ucpe-client1 vlan-id 1099
   set vlans ucpe-data vlan-id 66
   set vlans ucpe-data-nat vlan-id 75
   set vlans ucpe-internet vlan-id 67
   set vlans ucpe-oam vlan-id 65
   set vlans ucpe-oam-cso vlan-id 64
   set vlans ucpe-oam-nat vlan-id 76
   set vlans vcpe-client3 vlan-id 1077
   set vlans vcpe-nat vlan-id 74
   

.. warning:: MANDATORY STEP!

After you have applied these changes reboot the two NFX250 devices. This will make sure they get DHCP leases from the QFX from the range 192.168.130.0/24 for NFX250-1 and from the range 192.168.150.0/24 for NFX250-2.

As in other labs the best method is to get to the local Webserver http://192.168.10.24 and http://192.168.10.25 and wait until they no longer display the message “Waiting for JCP..” . In JDM the should then have a route with a default GW “route –n” and be able to “ping 8.8.8.8”. Do not continue before you reached this point.

Hub1 re-provision (SRX1500-1)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

This Feature today enforces that the Hub provides FOUR WAN Links. In all other Lab is had only 2 Links. As a result we must re-provision our Hub1.

If you have the object in CSO then delete it there first and wait until the job is completed.

Now apply the Procedure in Chapter 3.3.4.4 above to bring the device back into a default state.

The old (changed) Template should be fine still so follow the Procedure similar to Chapter 6.1 above to install/on-board the device. You will notice below that we add WAN_2 and WAN_3 as additional MPLS/Internet Interfaces.

|image565|

|image566|

|image567|

|image568|

|image569|

|image570|

This is the complete JSON config

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "default-project",
           "job_name_prefix": "hub1-HUB-SITE",
           "site": [
               {
                   "on_premise_site_info": {
                       "region": "regional",
                       "pop": "sdwan-pop",
                       "site_role": "HUB",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       },
                       "device": [
                           {
                               "wan_link": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/0",
                                       "overlay_tunnel": [],
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.190.1",
                                           "ip_address": "192.168.190.254/24"
                                       },
                                       "traffic_type": "DATA_ONLY",
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC"
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/1",
                                       "overlay_tunnel": [],
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.191.1",
                                           "ip_address": "192.168.191.254/24"
                                       },
                                       "traffic_type": "DATA_ONLY",
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC"
                                   },
                                   {
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/2",
                                       "overlay_tunnel": [],
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.192.1",
                                           "ip_address": "192.168.192.254/24"
                                       },
                                       "traffic_type": "DATA_ONLY",
                                       "wan_link_name": "WAN_2",
                                       "address_assignment": "STATIC"
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/3",
                                       "overlay_tunnel": [],
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.193.1",
                                           "ip_address": "192.168.193.254/24"
                                       },
                                       "traffic_type": "DATA_ONLY",
                                       "wan_link_name": "WAN_3",
                                       "address_assignment": "STATIC"
                                   }
                               ],
                               "device_name": "hub1",
                               "device_template": "SRX_Advanced_SDWAN_HUB_option_1",
                               "device_details": {
                                   "serial_number": "CZ0317AF0302",
                                   "boot_image": ""
                               },
                               "vpn_authentication": "preshared_key",
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.1/32"
                               }
                           }
                       ],
                       "site_capabilities": "OAM_AND_DATA"
                   },
                   "site_name": "hub1",
                   "user_defined_properties": [
                       {
                           "name": "oam-ce-intf",
                           "value": "ge-0/0/4"
                       },
                       {
                           "name": "oam-ce-intf-prefix",
                           "value": "192.168.194.254/24"
                       },
                       {
                           "name": "oam-gateway",
                           "value": "192.168.194.1"
                       },
                       {
                           "name": "ebgp_peer_as",
                           "value": "65000"
                       }
                   ]
               }
           ]
       }
   }
   

Now review Chapter 6.1 above again how you extract the Stage-1 configuration from CSO.

Copy the ENTIRE configuration from this window and ssh to srx1500-1 192.168.190.254 (root/Embe1mpls)

.. code-block:: none

   start shell
   #rm /var/tmp/srx1500-1.stage1
   vi /var/tmp/srx1500-1.stage1

Paste the Config from CSO in your Editor and save&quit the editor.

.. note:: We changed some subnets (changes in red below) so apply this config now!

.. code-block:: none

   exit
   edit
   load override /var/tmp/srx1500-1.stage1
   #
   # CSO doesn’t set a default route so add this here
   #
   set routing-options static route 0.0.0.0/0 next-hop 192.168.191.1
   set routing-options static route 0.0.0.0/0 no-readvertise
   #
   # Also the following routes help in your environment to ensure the right path is used as we don’t have a routing protocol helping us.
   #
   set routing-options static route 192.168.130.0/24 next-hop 192.168.190.1
   set routing-options static route 192.168.130.0/24 no-readvertise
   set routing-options static route 192.168.133.0/24 next-hop 192.168.191.1
   set routing-options static route 192.168.133.0/24 no-readvertise
   set routing-options static route 192.168.150.0/24 next-hop 192.168.190.1
   set routing-options static route 192.168.150.0/24 no-readvertise
   set routing-options static route 192.168.153.0/24 next-hop 192.168.191.1
   set routing-options static route 192.168.153.0/24 no-readvertise
   
   commit and-quit

The Rest is similar to Chapter 6.1 above in waiting for the ZTP to finish and adding the device as “hub1” to the Tenant. Please execute this now.

(optional) Create Tenant
~~~~~~~~~~~~~~~~~~~~~~~~

This is optional in case you have not created the Tenant which is usually used for the Basic SD-WAN demos.

Please review chapter 6.2 above and come back after you have executed everything in it.

Add the CloudHub to the Tenant
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Please review chapter 6.3 above come back after you have executed everything in it.

On-board both NFX250 in HA Cluster-mode
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: MANDATORY STEP!

Check the SFP’s on both units in JCP if you are on 1Gbit/s or 10Gbit/s Interfaces.

.. code-block:: none

   ssh vjunos0
   cli
   show chassis hardware
   Hardware inventory:
   Item             Version  Part number  Serial number     Description
   Chassis                                DD2316AF0086
   Pseudo CB 0
   Routing Engine 0          BUILTIN      BUILTIN           RE-NFX250-S2
   FPC 0            REV 04   650-066113   DD2316AF0086
     CPU                     BUILTIN      BUILTIN           FPC CPU
     PIC 0          REV 04   BUILTIN      BUILTIN           10x10/100/1000 Base-T-2x1G SFP-
       Xcvr 10      REV 01   740-013111   8144610           SFP-T
       Xcvr 11      REV 02   740-013111   9414569           SFP-T
       Xcvr 12      REV 02   740-013111   9066030           SFP-T
       Xcvr 13      REV 01   740-013111   8291530           SFP-T
   Power Supply 0

In this example we have only 1 Gbit/s SFP’s and as a Result of this we must change the Device Template below from the default for the Fields.

Control_Link_Port_Name from xe-0/0/12 to ge-0/0/12

+

Fabric_Link_Port_Name from xe-0/0/13 to ge-0/0/13

If your links are on 10GBit/s as advised you don’t need to change these default values.

In the “All Tenants” view go to Resources -> Device Templates and pick “Dual NFX250 as SD-WAN CPEs” and then edit the Template

|image571|

You only need to disable OOB Mgnt (and may need to change the two links mentioned above).

.. warning:: Starting with CSO 4.1.0 the device root passwords are no longer “Embe1mpls” after you have installed CSO. We are changing it back here, as it’s easier in a lab to debug items with known passswords, but this is **NOT RECOMMENDED FOR PRODUCTION**.

|image572|

Now you can change to your Tenant (that we assume you reuse or re-create as in other labs) and add the new On-Premise Spoke Device like below.

|image573|

Be sure to now select the Dual NFX250 CPE Profile

|image574|

|image575|

Now here is a change to other configuration and WAN_1 on the Spoke is the first MPLS link of the Secondary Device:

|image576|

WAN_2 is now the Internet Link of the Primary Device:

|image577|

And finally WAN_3 the Internet link of the Secondary Device.

|image578|

No need to add anything in the following window

|image579|

Add your LAN Segment as in other Labs. You will notice that the Port only allows you the fixed LAN_0 ae1 group to be selected.

|image580|

|image581|

Here is the resulting JSON File

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "hubspoketenant",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "sdwanhaspoke",
                   "site_basic_properties": {
                       "local_breakout": {},
                       "gatewaySite": false,
                       "site_type": "on_premise",
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": true,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "provider": "abc",
                                       "wan_link": "WAN_0",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "2c744e6b-6f81-ab8c-e129-8c50b888e5a1",
                                       "cost": 2222,
                                       "default_link": false,
                                       "local_breakout_enabled": false,
                                       "wan_link_node_type": "primary",
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "wan_link_type": "MPLS",
                                       "provider": "abc",
                                       "wan_link": "WAN_1",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "7a278d4d-2516-65e3-56c6-3f659ecadd68",
                                       "cost": 2222,
                                       "default_link": false,
                                       "local_breakout_enabled": false,
                                       "wan_link_node_type": "secondary",
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "provider": "xyz",
                                       "wan_link": "WAN_2",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "1ec6c670-660c-fb42-604c-e54d901edc2d",
                                       "cost": 111,
                                       "default_link": false,
                                       "local_breakout_enabled": false,
                                       "wan_link_node_type": "primary",
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "provider": "xyz",
                                       "wan_link": "WAN_3",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "397226b9-4632-99b9-c660-0ff34a64c5f2",
                                       "cost": 111,
                                       "default_link": false,
                                       "local_breakout_enabled": false,
                                       "wan_link_node_type": "secondary",
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "NFX_SDWAN_Dual_CPE",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "10.66.66.1/24",
                                       "lan_segment_name": "desktop4",
                                       "vlan": 1066,
                                       "lan_ports": [
                                           "LAN_0"
                                       ],
                                       "department": "Default",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwanhaspoke"
                           }
                       ],
                       "0": {
                           "ip_prefix": "10.66.66.1/24",
                           "lan_segment_name": "desktop4",
                           "vlan": 1066,
                           "lan_ports": [
                               "LAN_0"
                           ],
                           "department": "Default",
                           "dhcp": false
                       },
                       "site_role": "SPOKE",
                       "sla_mgmt": "COARSE",
                       "device_profile_name": "Dual NFX250 as SD-WAN CPEs",
                       "site_name": "sdwanhaspoke",
                       "site_group": null,
                       "dvpn_params": {
                           "delete_dvpn_threshold": "1",
                           "create_dvpn_threshold": "5"
                       },
                       "topology": "Bandwidth Optimized"
                   }
               }
           ]
       }
   }
   

Now after the Device is created select it and configure it.

|image582|

.. note:: On the Spoke Side you have to configure TWO OAM interfaces.

One for each device like below.

|image583|

|image584|

|image585|

|image586|

Add Time zone, NTP and DNS as minimal config.

|image587|

Now you see you have to fill in the Serial ID of both devices.

|image588|

This is the resulting JSON file

.. code-block:: none

   {
       "input": {
           "tenant_name": "hubspoketenant",
           "job_name_prefix": "hubspoketenant-sdwanhaspoke",
           "site": [
               {
                   "on_premise_site_info": {
                       "device": [
                           {
                               "is_gateway_site": false,
                               "secondary_device_details": {
                                   "serial_number": "DD1816AF0024"
                               },
                               "wan_link": [
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "local_interface": "primary:ge-0/0/10",
                                       "local_breakout_enabled": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.130.1",
                                           "ip_address": "192.168.130.2/24"
                                       },
                                       "used_for_oam": true,
                                       "traffic_type": "OAM_AND_DATA",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_2",
                                                   "internet_gw_ip": "192.168.192.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "local_interface": "secondary:ge-0/0/10",
                                       "local_breakout_enabled": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.150.1",
                                           "ip_address": "192.168.150.2/24"
                                       },
                                       "used_for_oam": true,
                                       "traffic_type": "OAM_AND_DATA",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "local_interface": "primary:ge-0/0/11",
                                       "local_breakout_enabled": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.133.1",
                                           "ip_address": "192.168.133.2/24"
                                       },
                                       "used_for_oam": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_2",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_3",
                                                   "internet_gw_ip": "192.168.193.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "local_interface": "secondary:ge-0/0/11",
                                       "local_breakout_enabled": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.153.1",
                                           "ip_address": "192.168.153.2/24"
                                       },
                                       "used_for_oam": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "hubspoketenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_3",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   }
                               ],
                               "device_name": "sdwanhaspoke",
                               "device_template": "NFX_SDWAN_Dual_CPE",
                               "device_details": {
                                   "serial_number": "DD2116AF0059"
                               },
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.4/32"
                               }
                           }
                       ],
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "region": "regional",
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       }
                   },
                   "site_name": "sdwanhaspoke",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "ntpserver": "192.168.10.10",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }

Now ZTP should start for both devices simultaneously. Review Chapter 6.5 above for a similar procedure.

**Be patient and WAIT!**

The Cluster bring up is longer than the usual bring up of a single device as to form the cluster the vSRX inside the NFX250 has to be rebooted! See below the impact:

|image589|

You see below that the **entire provision process is now ~40minutes** (so 20min longer as without dual-cpe).

|image590|

After the two devices are provisioned you should see the following when you check the WAN-Links of the Device.

|image591|

.. note:: You might see a Packet-Loss of 50% right after the Dual-Spokes are up!In this case: **RELAX!** After 10-15minutes it should be gone. This is a false-positive report unfortunately caused if one device finished the provision phase not at the same time as the other.

|image592|

.. warning:: MANDATORY STEP!Before you continue with the Test case execution make sure you have a Firewall rule assigned and Deployed that allows communication with the outside / Internet.

.. note:: Make SURE the Desktop 4 VM can reach the Internet before you continue.

The Test cases below do not use any SD-WAN SLA Feature so you can execute those without adding Licenses and import Signature Databases as in Chapter 6.6.1 above and Chapter 6.6.2 above . However you will not see any detected Application as Result in the Gui.

Failover Test cases to be executed
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note:: It’s is best if you use a Terminal/Console session to both NFX250 when you do this.

Cluster status verification
^^^^^^^^^^^^^^^^^^^^^^^^^^^

First show and verify the Cluster Status.

It’s best you use a terminal/console connection of your environment (root/Embe1mpls) and then in JDM locally issue “ssh GWR.sdwanhaspoke.hubspoketenant”

.. code-block:: none

   virsh list --all
    Id    Name                           State
   ----------------------------------------------------
    2     vjunos0                        running
    4     GWR.sdwanhaspoke.hubspoketenant running

   virsh console GWR.sdwanhaspoke.hubspoketenant --force
   Connected to domain GWR.sdwanhaspoke.hubspoketenant
   Escape character is ^]

   Unauthorized access will be reported.

   GWR.sdwanhaspoke.hubspoketenant (ttyd0)

   login: root
   Password: Embe1mpls

   --- JUNOS 15.1X49-D170.4 built 2019-02-22 23:02:01 UTC

   root@GWR% cli
   root@GWR.sdwanhaspoke.hubspoketenant> show chassis cluster statistics
   Control link statistics:
       Control link 0:
           Heartbeat packets sent: 7180
           Heartbeat packets received: 7166
           Heartbeat packet errors: 0
   Fabric link statistics:
       Child link 0
           Probes sent: 13877
           Probes received: 13875
       Child link 1
           Probes sent: 0
           Probes received: 0
   Services Synchronized:
       Service name                              RTOs sent    RTOs received
       Translation context                       0            0
       Incoming NAT                              0            0
       Resource manager                          0            0
       DS-LITE create                            0            0
       Session create                            3033         6
       IPv6 session create                       0            0
       Session close                             1542         5
       IPv6 session close                        0            0
       Session change                            538          0
       IPv6 session change                       0            0
       ALG Support Library                       0            0
       Gate create                               0            0
       Session ageout refresh requests           0            2
       IPv6 session ageout refresh requests      0            0
       Session ageout refresh replies            2            0
       IPv6 session ageout refresh replies       0            0
       IPSec VPN                                 4679         4757
       Firewall user authentication              0            0
       MGCP ALG                                  0            0
       H323 ALG                                  0            0
       SIP ALG                                   0            0
       SCCP ALG                                  0            0
       PPTP ALG                                  0            0
       JSF PPTP ALG                              0            0
       RPC ALG                                   0            0
       RTSP ALG                                  0            0
       RAS ALG                                   0            0
       MAC address learning                      0            0
       GPRS GTP                                  0            0
       GPRS SCTP                                 0            0
       GPRS FRAMEWORK                            0            0
       JSF RTSP ALG                              0            0
       JSF SUNRPC MAP                            0            0
       JSF MSRPC MAP                             0            0
       DS-LITE delete                            0            0
       JSF SLB                                   0            0
       APPID                                     0            0
       JSF MGCP MAP                              0            0
       JSF H323 ALG                              0            0
       JSF RAS ALG                               0            0
       JSF SCCP MAP                              0            0
       JSF SIP MAP                               0            0
       PST_NAT_CREATE                            0            0
       PST_NAT_CLOSE                             0            0
       PST_NAT_UPDATE                            0            0
       JSF TCP STACK                             0            0
       JSF IKE ALG                               0            0

   {primary:node0}
   root@GWR.sdwanhaspoke.hubspoketenant> show chassis cluster status
   Monitor Failure codes:
       CS  Cold Sync monitoring        FL  Fabric Connection monitoring
       GR  GRES monitoring             HW  Hardware monitoring
       IF  Interface monitoring        IP  IP monitoring
       LB  Loopback monitoring         MB  Mbuf monitoring
       NH  Nexthop monitoring          NP  NPC monitoring
       SP  SPU monitoring              SM  Schedule monitoring
       CF  Config Sync monitoring      RE  Relinquish monitoring

   Cluster ID: 1
   Node   Priority Status         Preempt Manual   Monitor-failures

   Redundancy group: 0 , Failover count: 1
   node0  100      primary        no      no       None
   node1  1        secondary      no      no       None

   Redundancy group: 1 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   Redundancy group: 2 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   Redundancy group: 3 , Failover count: 0
   node0  1        secondary      yes     no       None
   node1  100      primary        yes     no       None

   Redundancy group: 4 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   {primary:node0}
   root@GWR.sdwanhaspoke.hubspoketenant> show chassis cluster interfaces
   Control link status: Up

   Control interfaces:
       Index   Interface   Monitored-Status   Internal-SA   Security
       0       em0         Up                 Disabled      Disabled

   Fabric link status: Up

   Fabric interfaces:
       Name    Child-interface    Status                    Security
                                  (Physical/Monitored)
       fab0    ge-0/0/7           Up   / Up                 Disabled
       fab0
       fab1    ge-7/0/7           Up   / Up                 Disabled
       fab1

   Redundant-ethernet Information:
       Name         Status      Redundancy-group
       reth0        Up          2
       reth1        Up          3
       reth2        Up          2
       reth3        Up          3
       reth4        Up          1
       reth5        Up          4
       reth6        Up          4
       reth7        Up          4
       reth8        Up          5
       reth9        Up          5

   Redundant-pseudo-interface Information:
       Name         Status      Redundancy-group
       lo0          Up          0

   Interface Monitoring:
       Interface         Weight    Status    Redundancy-group
       ge-0/0/4          255       Up        1

   {primary:node0}

Flow status verification
^^^^^^^^^^^^^^^^^^^^^^^^

On the Desktop4 VM client issue a constant Ping towards the Internet.

|image593|

The open a second Shell and open an SSH session to the CSO Host itself so that you have a single TCP-Connection to track.

|image594|

Issue a constant ping if you are inside the ssh-shell of the cso-host so that we have also something that uses this connection.

.. code-block:: none

   ping 192.168.10.1

Back to the GWR

Now verify the Flow status reports on the two Cluster vSRX instances and you should see on the primary node the report for the two nodes and that they share the session state information.

.. code-block:: none

   root@GWR.sdwanhaspoke.hubspoketenant> show security flow session destination-prefix 8.8.8.8
   node0:
   --------------------------------------------------------------------------
   
   Session ID: 4617, Policy name: Intent_1/9, State: Forward, Timeout: 2, Valid
     In: 10.66.66.66/233 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1282 --> 10.66.66.66/233;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 0, Bytes: 0,
   
   Session ID: 4622, Policy name: Intent_1/9, State: Forward, Timeout: 2, Valid
     In: 10.66.66.66/234 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1282 --> 10.66.66.66/234;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 0, Bytes: 0,
   
   Session ID: 4627, Policy name: Intent_1/9, State: Forward, Timeout: 4, Valid
     In: 10.66.66.66/235 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1282 --> 10.66.66.66/235;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 0, Bytes: 0,
   
   Session ID: 4628, Policy name: Intent_1/9, State: Forward, Timeout: 4, Valid
     In: 10.66.66.66/236 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1282 --> 10.66.66.66/236;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 0, Bytes: 0,
   
   Session ID: 4633, Policy name: Intent_1/9, State: Forward, Timeout: 6, Valid
     In: 10.66.66.66/237 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1282 --> 10.66.66.66/237;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 0, Bytes: 0,
   
   Session ID: 4634, Policy name: Intent_1/9, State: Forward, Timeout: 6, Valid
     In: 10.66.66.66/238 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1282 --> 10.66.66.66/238;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 0, Bytes: 0,
   
   Session ID: 4635, Policy name: Intent_1/9, State: Forward, Timeout: 8, Valid
     In: 10.66.66.66/239 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1282 --> 10.66.66.66/239;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 0, Bytes: 0,
   
   Session ID: 4636, Policy name: Intent_1/9, State: Forward, Timeout: 8, Valid
     In: 10.66.66.66/240 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1282 --> 10.66.66.66/240;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 0, Bytes: 0,
   
   Session ID: 4641, Policy name: Intent_1/9, State: Forward, Timeout: 10, Valid
     In: 10.66.66.66/241 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/1282 --> 10.66.66.66/241;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 0, Bytes: 0,
   Total sessions: 9
   
   node1:
   --------------------------------------------------------------------------
   
   Session ID: 2955, Policy name: Intent_1/9, State: Active, Timeout: 2, Valid
     In: 10.66.66.66/239 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 0, Bytes: 0,
     Out: 8.8.8.8/1282 --> 10.66.66.66/239;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 1, Bytes: 84,
   
   Session ID: 2956, Policy name: Intent_1/9, State: Active, Timeout: 2, Valid
     In: 10.66.66.66/240 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 0, Bytes: 0,
     Out: 8.8.8.8/1282 --> 10.66.66.66/240;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 1, Bytes: 84,
   
   Session ID: 2963, Policy name: Intent_1/9, State: Active, Timeout: 4, Valid
     In: 10.66.66.66/241 --> 8.8.8.8/1282;icmp, Conn Tag: 0x0, If: reth4.1066, Pkts: 0, Bytes: 0,
     Out: 8.8.8.8/1282 --> 10.66.66.66/241;icmp, Conn Tag: 0x0, If: gr-0/0/0.4006, Pkts: 1, Bytes: 84,
   Total sessions: 3
   
   {primary:node0}

   {primary:node0}
   root@GWR.sdwanhaspoke.hubspoketenant> show security flow session destination-prefix 192.168.10.10
   node0:
   --------------------------------------------------------------------------
   
   Session ID: 4535, Policy name: Intent_1/9, State: Active, Timeout: 1734, Valid
     In: 10.66.66.66/43244 --> 192.168.10.10/22;tcp, Conn Tag: 0x0, If: reth4.1066, Pkts: 22, Bytes: 3444,
     Out: 192.168.10.10/22 --> 10.66.66.66/43244;tcp, Conn Tag: 0x0, If: gr-0/0/0.4004, Pkts: 18, Bytes: 3559,
   Total sessions: 1
   
   node1:
   --------------------------------------------------------------------------
   
   Session ID: 2859, Policy name: Intent_1/9, State: Backup, Timeout: 14344, Valid
     In: 10.66.66.66/43244 --> 192.168.10.10/22;tcp, Conn Tag: 0x0, If: reth4.1066, Pkts: 0, Bytes: 0,
     Out: 192.168.10.10/22 --> 10.66.66.66/43244;tcp, Conn Tag: 0x0, If: gr-0/0/0.4004, Pkts: 0, Bytes: 0,
   Total sessions: 1

   {primary:node0}
   root@GWR.sdwanhaspoke.hubspoketenant>

State full Failover on interrupted LAN side
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. note:: This works only if you simulate an LAN-side disconnect of the Primary Device and not an entire loss of the whole device. This is because on the WAN side you do not have also redundant interface groups.

Before we start, using the SSH session to the CSO-Host, start a Ping to outside there so that you see this single TCP session generating output during the Failover.

We have the existing SSH Connection and now we identify the primary device

.. code-block:: none

   root@GWR.sdwanhaspoke.hubspoketenant> show chassis cluster status
   Monitor Failure codes:
       CS  Cold Sync monitoring        FL  Fabric Connection monitoring
       GR  GRES monitoring             HW  Hardware monitoring
       IF  Interface monitoring        IP  IP monitoring
       LB  Loopback monitoring         MB  Mbuf monitoring
       NH  Nexthop monitoring          NP  NPC monitoring
       SP  SPU monitoring              SM  Schedule monitoring
       CF  Config Sync monitoring      RE  Relinquish monitoring

   Cluster ID: 1
   Node   Priority Status         Preempt Manual   Monitor-failures

   Redundancy group: 0 , Failover count: 1
   node0  100      primary        no      no       None
   node1  1        secondary      no      no       None

   Redundancy group: 1 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   Redundancy group: 2 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   Redundancy group: 3 , Failover count: 0
   node0  1        secondary      yes     no       None
   node1  100      primary        yes     no       None

   Redundancy group: 4 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   {primary:node0}
   root@GWR.sdwanhaspoke.hubspoketenant>

After we’ve identified the primary device we jump into the JCP VM of the NFX and disable the two local LAN Links to simulate disconnect causing the Failover.

.. code-block:: none

   root@jdm:/tmp# ssh vjunos0
   Last login: Mon May  7 10:51:55 2018 from 192.0.2.254
   --- JUNOS 15.1X53-D472 Kernel 64-bit FLEX JNPR-10.3-20170523.350481_build
   .
   root@vjunos0:~ # cli
   {master:0}
   root@vjunos0> edit
   Entering configuration mode

   {master:0}[edit]
   root@vjunos0# run show interfaces terse
   Interface               Admin Link Proto    Local                 Remote
   ge-0/0/0                up    up
   ge-0/0/0.0              up    up   aenet    --> ae1.0
   sxe-0/0/0               up    up
   sxe-0/0/0.0             up    up   eth-switch
   ge-0/0/1                up    up
   ge-0/0/1.0              up    up   aenet    --> ae1.0
   sxe-0/0/1               up    up
   sxe-0/0/1.0             up    up   eth-switch
   .
   .
   .

   # review which interfaces are up for the group ae1
   run show interfaces terse | match ae1
   ge-0/0/0.0              up    up   aenet    --> ae1.0
   ge-0/0/1.0              up    up   aenet    --> ae1.0
   ge-0/0/2.0              up    up   aenet    --> ae1.0
   ge-0/0/3.0              up    down aenet    --> ae1.0
   ge-0/0/4.0              up    down aenet    --> ae1.0
   ge-0/0/5.0              up    down aenet    --> ae1.0
   ge-0/0/6.0              up    down aenet    --> ae1.0
   ge-0/0/7.0              up    down aenet    --> ae1.0
   ge-0/0/8.0              up    down aenet    --> ae1.0
   ge-0/0/9.0              up    down aenet    --> ae1.0
   ae1                     up    up
   ae1.0                   up    up   eth-switch

   # disable the up interfaces (regardless of their connection state)
   set interfaces ge-0/0/0 disable
   set interfaces ge-0/0/1 disable
   set interfaces ge-0/0/2 disable
   commit

   # Make sure that all interface of ae1 are really down
   run show interfaces terse | match ae1
   ge-0/0/0.0              up    down aenet    --> ae1.0
   ge-0/0/1.0              up    down aenet    --> ae1.0
   ge-0/0/2.0              up    down aenet    --> ae1.0
   ge-0/0/3.0              up    down aenet    --> ae1.0
   ge-0/0/4.0              up    down aenet    --> ae1.0
   ge-0/0/5.0              up    down aenet    --> ae1.0
   ge-0/0/6.0              up    down aenet    --> ae1.0
   ge-0/0/7.0              up    down aenet    --> ae1.0
   ge-0/0/8.0              up    down aenet    --> ae1.0
   ge-0/0/9.0              up    down aenet    --> ae1.0
   ae1                     up    down
   ae1.0                   up    down eth-switch 

You should see around 3 seconds no output on the Desktop 4 VM but then the LACP session has changed and so the SSH output continues uninterrupted proving state full failover!!!

|image595|

Now we leave JCP and go to the GWR instance to review the Failover State.

.. code-block:: none

   root@vjunos0# exit
   Exiting configuration mode

   {master:0}
   root@vjunos0> exit

   root@vjunos0:~ # exit
   logout
   Connection to vjunos0 closed.
   root@jdm:/tmp# virsh console GWR.sdwanhaspoke.hubspoketenant --force
   Connected to domain GWR.sdwanhaspoke.hubspoketenant
   Escape character is ^]


   {primary:node0}
   root@GWR.sdwanhaspoke.hubspoketenant> show chassis cluster status
   Monitor Failure codes:
       CS  Cold Sync monitoring        FL  Fabric Connection monitoring
       GR  GRES monitoring             HW  Hardware monitoring
       IF  Interface monitoring        IP  IP monitoring
       LB  Loopback monitoring         MB  Mbuf monitoring
       NH  Nexthop monitoring          NP  NPC monitoring
       SP  SPU monitoring              SM  Schedule monitoring
       CF  Config Sync monitoring      RE  Relinquish monitoring

   Cluster ID: 1
   Node   Priority Status         Preempt Manual   Monitor-failures

   Redundancy group: 0 , Failover count: 1
   node0  100      primary        no      no       None
   node1  1        secondary      no      no       None

   Redundancy group: 1 , Failover count: 2
   node0  0        secondary      yes     no       IF
   node1  1        primary        yes     no       None

   Redundancy group: 2 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   Redundancy group: 3 , Failover count: 0
   node0  1        secondary      yes     no       None
   node1  100      primary        yes     no       None

   Redundancy group: 4 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   {primary:node0}

In this step we heal the links and the cluster and that triggers a fall-back back to primary (due to default pre-empt config).

.. code-block:: none

   root@GWR.sdwanhaspoke.hubspoketenant>
   root@jdm:/tmp# ssh vjunos0
   Last login: Mon May  7 12:35:46 2018 from 192.0.2.254
   --- JUNOS 15.1X53-D472 Kernel 64-bit FLEX JNPR-10.3-20170523.350481_build
   root@vjunos0:~ # cli
   {master:0}
   root@vjunos0> edit
   Entering configuration mode

   {master:0}[edit]
   root@vjunos0# rollback 1
   load complete

   {master:0}[edit]
   root@vjunos0# commit
   configuration check succeeds
   commit complete

   {master:0}[edit]
   root@vjunos0# exit
   Exiting configuration mode

   {master:0}
   root@vjunos0> exit

   root@vjunos0:~ # exit
   logout
   Connection to vjunos0 closed.
   root@jdm:/tmp# virsh console GWR.sdwanhaspoke.hubspoketenant --force
   Connected to domain GWR.sdwanhaspoke.hubspoketenant
   Escape character is ^]


   {primary:node0}
   root@GWR.sdwanhaspoke.hubspoketenant> show chassis cluster status
   Monitor Failure codes:
       CS  Cold Sync monitoring        FL  Fabric Connection monitoring
       GR  GRES monitoring             HW  Hardware monitoring
       IF  Interface monitoring        IP  IP monitoring
       LB  Loopback monitoring         MB  Mbuf monitoring
       NH  Nexthop monitoring          NP  NPC monitoring
       SP  SPU monitoring              SM  Schedule monitoring
       CF  Config Sync monitoring      RE  Relinquish monitoring

   Cluster ID: 1
   Node   Priority Status         Preempt Manual   Monitor-failures

   Redundancy group: 0 , Failover count: 1
   node0  100      primary        no      no       None
   node1  1        secondary      no      no       None

   Redundancy group: 1 , Failover count: 3
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   Redundancy group: 2 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   Redundancy group: 3 , Failover count: 0
   node0  1        secondary      yes     no       None
   node1  100      primary        yes     no       None

   Redundancy group: 4 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   {primary:node0}
   root@GWR.sdwanhaspoke.hubspoketenant> show configuration chassis cluster | display inheritance no-comments
   reth-count 8;
   redundancy-group 0 {
       node 0 priority 100;
       node 1 priority 1;
   }
   redundancy-group 1 {
       node 0 priority 100;
       node 1 priority 1;
       preempt;
       interface-monitor {
           ge-0/0/4 weight 255;
       }
   }
   redundancy-group 2 {
       node 0 priority 100;
       node 1 priority 1;
       preempt;
   }
   redundancy-group 3 {
       node 0 priority 1;
       node 1 priority 100;
       preempt;
   }
   redundancy-group 4 {
       node 0 priority 100;
       node 1 priority 1;
       preempt;
   }

   {primary:node0}

Failover due to entire CPE lost
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

In this Test case we simulate a fail of the entire primary CPE. This is NOT a State full Failover by the current design and the Failover Time is expected to be around a Minute with a few times causing Traffic interrupts. However after this all operations continue from the new Device and also the BGP-Sessions remain due to a Failover group.

Before we start we just check that the primary device is really the one in charge with the Traffic. Then we change to JCP on the Device and create an apply group to disable all ge-\* interfaces and apply it.

.. code-block:: none

   root@GWR.sdwanhaspoke.hubspoketenant> request chassis cluster failover redundancy-group 1 node 0
   node0:
   --------------------------------------------------------------------------
   Manual failover is not permitted as redundancy-group 1 on node0 is already in primary state.

   {primary:node0}
   root@GWR.sdwanhaspoke.hubspoketenant> exit

   root@GWR% exit
   logout
   Connection to gwr.sdwanhaspoke.hubspoketenant closed.
   root@jdm:/tmp#
   root@jdm:/tmp# ssh vjunos0
   Last login: Mon May  7 12:56:35 2018 from 192.0.2.254
   --- JUNOS 15.1X53-D472 Kernel 64-bit FLEX JNPR-10.3-20170523.350481_build
   root@vjunos0:~ # cli
   {master:0}
   root@vjunos0> configure
   Entering configuration mode

   {master:0}[edit]
   set groups disableall interfaces <ge-*> disable
   set groups disableall interfaces <xe-*> disable
   set apply-groups disableall
   
   show | compare
   [edit groups]
      dept-configuration { ... }
   +  disableall {
   +      interfaces {
   +          <ge-*> {
   +              disable;
   +          }
   +          <xe-*> {
   +              disable;
   +          }
   +      }
   +  }
   [edit]
   - apply-groups dept-configuration;
   + apply-groups [ dept-configuration disableall ];

   {master:0}[edit]
   root@vjunos0# commit and-quit
   configuration check succeeds
   commit complete
   Exiting configuration mode

   {master:0}

You should now see the SSH session to CSO-Host complete stops (upper shell) and the Ping’s directly from the Desktop 4 VM towards the Internet (shell below) being a few times interrupted. After around one Minute this should be stable again.

|image596|

.. note:: If you are lucky only a few packtes are getting dropped and the fail-over is almost stateful. Unlucky this may not happen all the time so we don’t claim that capability towards customers.

|image597|

Now review the Cluster state on the **remaining** CPE and also the BGP Peering.

.. code-block:: none

   telnet <spoke2-ip/port>

   root@jdm:~# virsh console GWR.sdwanhaspoke.hubspoketenant --force
   Connected to domain GWR.sdwanhaspoke.hubspoketenant
   Escape character is ^]


   {primary:node1}
   root@GWR.sdwanhaspoke.hubspoketenant> show chassis cluster status
   Monitor Failure codes:
       CS  Cold Sync monitoring        FL  Fabric Connection monitoring
       GR  GRES monitoring             HW  Hardware monitoring
       IF  Interface monitoring        IP  IP monitoring
       LB  Loopback monitoring         MB  Mbuf monitoring
       NH  Nexthop monitoring          NP  NPC monitoring
       SP  SPU monitoring              SM  Schedule monitoring
       CF  Config Sync monitoring      RE  Relinquish monitoring

   Cluster ID: 1
   Node   Priority Status         Preempt Manual   Monitor-failures

   Redundancy group: 0 , Failover count: 1
   node0  0        lost           n/a     n/a      n/a
   node1  1        primary        no      no       None

   Redundancy group: 1 , Failover count: 3
   node0  0        lost           n/a     n/a      n/a
   node1  1        primary        yes     no       None

   Redundancy group: 2 , Failover count: 1
   node0  0        lost           n/a     n/a      n/a
   node1  1        primary        yes     no       None

   Redundancy group: 3 , Failover count: 3
   node0  0        lost           n/a     n/a      n/a
   node1  100      primary        yes     no       None

   Redundancy group: 4 , Failover count: 1
   node0  0        lost           n/a     n/a      n/a
   node1  1        primary        yes     no       None

   {primary:node1}
   root@GWR.sdwanhaspoke.hubspoketenant> show bgp summary
   Groups: 6 Peers: 6 Down peers: 2
   Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
   inet.0
                          1          1          0          0          0          0
   bgp.l3vpn.0
                         14         14          0          0          0          0
   Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
   10.10.12.2            64512          0          0       0       0        3:00 Idle
   10.10.12.3            64512          0          0       0       0        3:00 Idle
   10.10.13.2            64512         10          9       0       0        2:51 Establ
     logs-node1.inet.0: 1/1/1/0
   10.10.13.3            64512          8         10       0       0        2:51 Establ
     inet.0: 0/0/0/0
   192.168.10.49         64512         21         27       0       0        2:47 Establ
     bgp.l3vpn.0: 14/14/14/0
     Default-hubspoketenant_DefaultVPN.inet.0: 1/1/1/0
     Default-reverse-hubspoketenant_DefaultVPN.inet.0: 1/1/1/0
     LAN-hubspoketenant_DefaultVPN.inet.0: 1/1/1/0
     internet-hubspoketenant_DefaultVPN.inet.0: 1/1/1/0
     mpls-hubspoketenant_DefaultVPN.inet.0: 1/1/1/0
   192.168.210.1         64512          9         10       0       0        2:55 Establ
     inet.0: 1/1/1/0

   {primary:node1} 
   root@GWR.sdwanhaspoke.hubspoketenant> show route 192.168.10.49

   inet.0: 28 destinations, 28 routes (28 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   192.168.10.0/24    *[BGP/170] 00:04:33, localpref 200, from 192.168.210.1
                         AS path: 65000 I, validation-state: unverified
                       > via st0.4001
                         via st0.4003
   
   logs-node1.inet.0: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   192.168.10.0/24    *[BGP/170] 00:04:29, localpref 200, from 10.10.13.2
                         AS path: 65000 I, validation-state: unverified
                       > to 172.20.134.221 via st0.4001
                         to 172.29.214.17 via st0.4003
   
   Default-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:04:25, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 16
                         via gr-0/0/0.4006, Push 16
   
   Default-reverse-hubspoketenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:04:25, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 18
                         via gr-0/0/0.4006, Push 18
   
   LAN-hubspoketenant_DefaultVPN.inet.0: 3 destinations, 3 routes (3 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:04:25, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 16
                         via gr-0/0/0.4006, Push 16
   .
   .
   .
   
   #
   # just check if the old ssh session MAY still be valid and in the state-table
   #
   {primary:node1}
   root@GWR.sdwanhaspoke.hubspoketenant> show security flow session destination-prefix 192.168.10.10
   node1:
   --------------------------------------------------------------------------
   
   Session ID: 1649, Policy name: Intent_1/11, State: Active, Timeout: 1800, Valid
     In: 10.66.66.66/40462 --> 192.168.10.10/22;tcp, Conn Tag: 0x0, If: reth4.1066, Pkts: 549, Bytes: 30068,
     Out: 192.168.10.10/22 --> 10.66.66.66/40462;tcp, Conn Tag: 0x0, If: gr-0/0/0.4003, Pkts: 528, Bytes: 78071,

Go to the CSO GUI and review Alarms and WAN status

.. note:: You may need to manually refresh this before you see the change!!

|image598|

|image599|

|image600|

.. warning:: Wait 5 minutes before you can issue the next CPE failover!

This is a default cluster timer.

You should NOT ISSUE THE NEXT FAILOVER BEFORE THE CLUSTER HAS STILL A SECONDARY-HOLD ISSUED.

.. code-block:: none

   root@GWR.sdwanhaspoke.hubspoketenant> show chassis cluster status
   Monitor Failure codes:
       CS  Cold Sync monitoring        FL  Fabric Connection monitoring
       GR  GRES monitoring             HW  Hardware monitoring
       IF  Interface monitoring        IP  IP monitoring
       LB  Loopback monitoring         MB  Mbuf monitoring
       NH  Nexthop monitoring          NP  NPC monitoring
       SP  SPU monitoring              SM  Schedule monitoring
       CF  Config Sync monitoring      RE  Relinquish monitoring

   Cluster ID: 1
   Node   Priority Status         Preempt Manual   Monitor-failures

   Redundancy group: 0 , Failover count: 1
   node0  100      primary        no      no       None
   node1  1        secondary-hold no      no       None

   Redundancy group: 1 , Failover count: 5
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   Redundancy group: 2 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   Redundancy group: 3 , Failover count: 2
   node0  1        secondary      yes     no       None
   node1  100      primary        yes     no       None

   Redundancy group: 4 , Failover count: 1
   node0  100      primary        yes     no       None
   node1  1        secondary      yes     no       None

   {primary:node0}

Wait until the Cluster is FULLY converged and no secondary-hold visible anymore; then you can heal the device by deleting the apply group in JCP and review what’s going to happen.

Device RMA
----------

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. This will **SAVE** you huge amount of **TIME** and will guarantee that the lab configuration is in **PROPER STATE**. It will **AVOID** any **MISCONFIGURATION** you do via manual cut&paste.

If you want to bring this lab into this state you should click here:

|image601|

.. note:: As you see it will take care to apply the changes from chapter 7.5.1 and chapter 7.5.2 so you can jump over those.

Preparation

This test case assumes that:

- The SD-WAN BASIC Topology is used (but later modified)

- PoP created

- Cloud Hub Nr.1 is created

- Cloud Hub Nr.1 is ZTPed and Provisioned in CSO

- The Tenant is created

- The Cloud Hub Nr.1 is assigned to the Tenant

- NFX250-1 is on-boarded to CSO and connected to the Hub

- A Firewall Policy is created and deployed onto the Device

- The Desktop4 VM is tested to be able to send Traffic to the Internet

All these are the steps you have to excute as part of chapter 6.1 and 6.5 above so you should be familiar with those.

Modifications on the underlay QFX5100 configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. If you have applied the changes from executing the “Device RMA (via two NFX250)” then you can ignore this section.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

In a real world scenario we would rip out a device that we consider dead/broken and replace it with a similar device that still has the SAME SKU. So no Ports or Functions would change with the replacement device.

In our Lab that would require someone local to exchange the device and re-cable it. This is not practical for a remotely executed lab. Instead we decided to change the local infrastructure to place both devices into the same VLAN’s and instead of using each port of the QFX Switch as routed interface to use IRB’s an use an L3 irb router as GW. Instead of attaching the interface directly to the Spoke-Virtual Routers we then attach the L3 IRB

|image602|

For this reason we need to configure a new apply-group that has this changed configuration and disable the old apply-group for sdwan basic.

.. code-block:: none

   # disable the sdwan-basic group and replace it with sdwan-rma
   delete apply-groups sdwan-basic
   set apply-groups sdwan-rma
   
   set groups sdwan-rma interfaces irb unit 130 family inet address 192.168.130.1/24
   set groups sdwan-rma vlans vlan130 vlan-id 130
   set groups sdwan-rma vlans vlan130 l3-interface irb.130
   delete groups sdwan-rma interfaces xe-0/0/22
   set groups sdwan-rma interfaces xe-0/0/22 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-rma interfaces xe-0/0/22 unit 0 family ethernet-switching vlan members 130
   set groups sdwan-rma interfaces xe-0/0/28 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-rma interfaces xe-0/0/28 unit 0 family ethernet-switching vlan members 130
   
   set groups sdwan-rma routing-instances spoke-wan0 instance-type virtual-router
   set groups sdwan-rma routing-instances spoke-wan0 interface irb.130
   set groups sdwan-rma routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface irb.130
   set groups sdwan-rma routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet network 192.168.130.0/24
   set groups sdwan-rma routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range low 192.168.130.100
   set groups sdwan-rma routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range high 192.168.130.199
   set groups sdwan-rma routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-rma routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-rma routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes router 192.168.130.1
   set groups sdwan-rma routing-instances spoke-wan0 routing-options static route 0.0.0.0/0 next-hop 192.168.131.254
   
   set groups sdwan-rma interfaces irb unit 131 family inet address 192.168.131.1/24
   set groups sdwan-rma vlans vlan131 vlan-id 131
   set groups sdwan-rma vlans vlan131 l3-interface irb.131
   set groups sdwan-rma routing-instances spoke-wan0 interface irb.131
   
   
   set groups sdwan-rma interfaces irb unit 133 family inet address 192.168.133.1/24
   set groups sdwan-rma vlans vlan133 vlan-id 133
   set groups sdwan-rma vlans vlan133 l3-interface irb.133
   delete groups sdwan-rma interfaces xe-0/0/23
   set groups sdwan-rma interfaces xe-0/0/23 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-rma interfaces xe-0/0/23 unit 0 family ethernet-switching vlan members 133
   set groups sdwan-rma interfaces xe-0/0/29 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-rma interfaces xe-0/0/29 unit 0 family ethernet-switching vlan members 133
   
   set groups sdwan-rma interfaces xe-0/0/23 unit 0 family inet address 192.168.133.1/24
   set groups sdwan-rma routing-instances spoke-wan1 instance-type virtual-router
   set groups sdwan-rma routing-instances spoke-wan1 interface irb.133
   set groups sdwan-rma routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface irb.133
   set groups sdwan-rma routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet network 192.168.133.0/24
   set groups sdwan-rma routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range low 192.168.133.100
   set groups sdwan-rma routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range high 192.168.133.199
   set groups sdwan-rma routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-rma routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-rma routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes router 192.168.133.1
   set groups sdwan-rma routing-instances spoke-wan1 routing-options static route 0.0.0.0/0 next-hop 192.168.134.254
   
   set groups sdwan-rma interfaces irb unit 134 family inet address 192.168.134.1/24
   set groups sdwan-rma vlans vlan134 vlan-id 134
   set groups sdwan-rma vlans vlan134 l3-interface irb.134
   set groups sdwan-rma routing-instances spoke-wan1 interface irb.134
   
   
   set groups sdwan-rma interfaces xe-0/0/37 unit 0 family inet address 192.168.190.1/24
   set groups sdwan-rma routing-instances hub-wan0 instance-type virtual-router
   set groups sdwan-rma routing-instances hub-wan0 interface xe-0/0/37.0
   set groups sdwan-rma routing-instances hub-wan0 routing-options static route 192.168.130.0/24 next-hop 192.168.132.254
   set groups sdwan-rma routing-instances hub-wan0 routing-options static route 192.168.170.0/24 next-hop 192.168.132.254
   
   set groups sdwan-rma interfaces irb unit 132 family inet address 192.168.132.1/24
   set groups sdwan-rma vlans vlan132 vlan-id 132
   set groups sdwan-rma vlans vlan132 l3-interface irb.132
   set groups sdwan-rma routing-instances hub-wan0 interface irb.132
   
   
   set groups sdwan-rma interfaces xe-0/0/38 unit 0 family inet address 192.168.191.1/24
   set groups sdwan-rma routing-instances hub-wan1 instance-type virtual-router
   set groups sdwan-rma routing-instances hub-wan1 interface xe-0/0/38.0
   set groups sdwan-rma routing-instances hub-wan1 routing-options static route 192.168.133.0/24 next-hop 192.168.135.254
   set groups sdwan-rma routing-instances hub-wan1 routing-options static route 192.168.173.0/24 next-hop 192.168.135.254
   # route for the Spoke LAN’s to go to Internet
   set groups sdwan-rma routing-instances hub-wan1 routing-options static route 10.88.88.0/24 next-hop 192.168.191.254
   set groups sdwan-rma routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.191.254
   
   
   set groups sdwan-rma interfaces irb unit 135 family inet address 192.168.135.1/24
   set groups sdwan-rma vlans vlan135 vlan-id 135
   set groups sdwan-rma vlans vlan135 l3-interface irb.135
   set groups sdwan-rma routing-instances hub-wan1 interface irb.135
   
   
   set groups sdwan-rma interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 131
   set groups sdwan-rma interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 132
   set groups sdwan-rma interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 134
   set groups sdwan-rma interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 135
   
   commit

   # setup and connect the LAN interfaces of the two spoke devices

   set groups sdwan-rma vlans desktop4 vlan-id 1066
   
   set groups sdwan-rma interfaces xe-0/0/18 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-rma interfaces xe-0/0/18 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-rma interfaces xe-0/0/26 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-rma interfaces xe-0/0/26 unit 0 family ethernet-switching vlan members 1066
   
   set groups sdwan-rma interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1066
   
   commit


   #
   # Ribgroups and VRs and interfaces for Internet Access
   #
   set groups sdwan-rma interfaces irb unit 70 family inet address 192.168.70.254/24
   set groups sdwan-rma vlans natuplink vlan-id 70
   set groups sdwan-rma vlans natuplink l3-interface irb.70
   
   set groups sdwan-rma routing-instances internetaccess instance-type virtual-router
   set groups sdwan-rma routing-instances internetaccess interface irb.70
   set groups sdwan-rma routing-instances internetaccess routing-options static route 0.0.0.0/0 next-hop 192.168.70.1
   
   delete groups sdwan-rma policy-options policy-statement directandstatic1
   set groups sdwan-rma policy-options policy-statement directandstatic1 term a from instance internetaccess
   set groups sdwan-rma policy-options policy-statement directandstatic1 term a then accept
   set groups sdwan-rma policy-options policy-statement directandstatic1 term b then reject
   set groups sdwan-rma routing-instances hub-wan0 routing-options instance-import directandstatic1
   set groups sdwan-rma routing-instances hub-wan1 routing-options instance-import directandstatic1
   
   delete groups sdwan-rma policy-options policy-statement directandstatic2
   set groups sdwan-rma policy-options policy-statement directandstatic2 term c from instance hub-wan0
   set groups sdwan-rma policy-options policy-statement directandstatic2 term c then accept
   set groups sdwan-rma policy-options policy-statement directandstatic2 term d from instance hub-wan1
   set groups sdwan-rma policy-options policy-statement directandstatic2 term d then accept
   set groups sdwan-rma policy-options policy-statement directandstatic2 term e from instance secure-oam
   set groups sdwan-rma policy-options policy-statement directandstatic2 term e then accept
   set groups sdwan-rma policy-options policy-statement directandstatic2 term f then reject
   set groups sdwan-rma routing-instances internetaccess routing-options instance-import directandstatic2

   # hub1 to NAT gw uplink
   set groups sdwan-rma interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 70
   
   commit
   
   
   set groups sdwan-rma interfaces xe-0/0/41 unit 0 family inet address 192.168.194.1/24
   
   delete groups sdwan-rma routing-instances secure-oam
   set groups sdwan-rma routing-instances secure-oam instance-type virtual-router
   set groups sdwan-rma routing-instances secure-oam interface xe-0/0/41.0
   set groups sdwan-rma routing-instances secure-oam routing-options static route 192.168.10.0/24 next-hop 192.168.70.1
   set groups sdwan-rma routing-instances secure-oam routing-options autonomous-system 65000
   set groups sdwan-rma routing-instances secure-oam routing-options instance-import directandstatic1
   set groups sdwan-rma routing-instances secure-oam protocols bgp group ebgp type external
   set groups sdwan-rma routing-instances secure-oam protocols bgp group ebgp export export-cso
   set groups sdwan-rma routing-instances secure-oam protocols bgp group ebgp peer-as 64512
   set groups sdwan-rma routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.194.254
   set groups sdwan-rma policy-options policy-statement export-cso term cso-net from route-filter 192.168.10.0/24 exact
   set groups sdwan-rma policy-options policy-statement export-cso term cso-net then accept
   
   
   commit and-quit
   

After you have applied this configuration check that the former on-boarded NFX250-1 is still able to work

.. code-block:: none

   show route table secure-oam.inet.0

   secure-oam.inet.0: 10 destinations, 10 routes (10 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 00:01:18
                       > to 192.168.70.1 via irb.70
   192.168.10.0/24    *[Static/5] 00:01:18
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 00:01:18
                       > via irb.70
   192.168.70.254/32  *[Local/0] 00:01:18
                         Local via irb.70
   192.168.194.0/24   *[Direct/0] 00:01:18
                       > via xe-0/0/41.0
   192.168.194.1/32   *[Local/0] 00:01:18
                         Local via xe-0/0/41.0
   192.168.204.0/24   *[Direct/0] 00:01:18
                       > via xe-0/0/46.0
   192.168.204.1/32   *[Local/0] 00:01:18
                         Local via xe-0/0/46.0
   192.168.210.1/32   *[BGP/170] 00:01:13, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   192.168.210.4/32   *[BGP/170] 00:01:13, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0

   show route table spoke-wan0

   spoke-wan0.inet.0: 5 destinations, 5 routes (5 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 1w2d 16:31:19
                       > to 192.168.131.254 via irb.131
   192.168.130.0/24   *[Direct/0] 00:03:29
                       > via irb.130
   192.168.130.1/32   *[Local/0] 00:03:29
                         Local via irb.130
   192.168.131.0/24   *[Direct/0] 1w2d 16:31:19
                       > via irb.131
   192.168.131.1/32   *[Local/0] 1w2d 16:31:19
                         Local via irb.131

   show route table spoke-wan1

   spoke-wan1.inet.0: 5 destinations, 5 routes (5 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 1w2d 16:31:59
                       > to 192.168.134.254 via irb.134
   192.168.133.0/24   *[Direct/0] 00:04:09
                       > via irb.133
   192.168.133.1/32   *[Local/0] 00:04:09
                         Local via irb.133
   192.168.134.0/24   *[Direct/0] 1w2d 16:31:59
                       > via irb.134
   192.168.134.1/32   *[Local/0] 1w2d 16:31:59
                         Local via irb.134

Check that the Desktop4 VM can still ping the Internet.

|image603|

Second NFX preparation and check
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. If you have applied the changes from executing the “Device RMA (via two NFX250)” then you can ignore this section.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

If you have not yet applied a valid boot configuration for the second NFX250 then please use and apply the configuration from chapter 7.4.1 above before you continue.

The second NFX may have from other labs still an older DHCP lease from the 192.168.\ **15x**.0/24 range. We **must check that** this is no longer the case and it has a new **IP-Address from** the **192.168.13x.0/24 Range**.

Best use Telnet/Console to the device and check in JDM:

.. code-block:: none

   nfx250-2 login: root
   Password: juniper123
   Last login: Mon Nov 19 17:15:18 UTC 2018 on pts/0
   root@nfx2502:~# route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.153.1   0.0.0.0         UG    0      0        0 jsxe0.0
   10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 phc
   128.0.0.0       0.0.0.0         255.255.0.0     U     0      0        0 bme2
   192.0.2.0       0.0.0.0         255.255.255.0   U     0      0        0 bme1
   192.168.153.0   0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.0
   
   ifconfig jsxe0.0
   jsxe0.0   Link encap:Ethernet  HWaddr ec:13:db:d3:e2:cc
             inet addr:192.168.153.100  Bcast:192.168.153.255  Mask:255.255.255.0
             inet6 addr: fe80::ee13:dbff:fed3:e2cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:132911 errors:0 dropped:0 overruns:0 frame:0
             TX packets:7721 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:16481606 (16.4 MB)  TX bytes:874406 (874.4 KB)

If you see similar then the above then execute the config canges and re-apply steps below.

If your device is already in the 192.168.13x.0/24 range then nothing need to be done and you can jump to the next section.

.. code-block:: none

   cli
   edit
   delete interfaces jsxe0 unit 0 family inet dhcp
   commit and-quit
   exit
   
   # verify that you only see these 3 routes below
   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 phc
   128.0.0.0       0.0.0.0         255.255.0.0     U     0      0        0 bme2
   192.0.2.0       0.0.0.0         255.255.255.0   U     0      0        0 bme1

   cli
   edit
   set interfaces jsxe0 unit 0 family inet dhcp
   commit and-quit
   exit
   
   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.130.1   0.0.0.0         UG    0      0        0 jsxe0.0
   10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 phc
   128.0.0.0       0.0.0.0         255.255.0.0     U     0      0        0 bme2
   192.0.2.0       0.0.0.0         255.255.255.0   U     0      0        0 bme1
   192.168.130.0   0.0.0.0         255.255.255.0   U     0      0        0 jsxe0.0
   
   ifconfig jsxe0.0
   jsxe0.0   Link encap:Ethernet  HWaddr ec:13:db:d3:e2:cc
             inet addr:192.168.130.102  Bcast:192.168.130.255  Mask:255.255.255.0
             inet6 addr: fe80::ee13:dbff:fed3:e2cc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:132976 errors:0 dropped:0 overruns:0 frame:0
             TX packets:7883 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:16499844 (16.4 MB)  TX bytes:889556 (889.5 KB)

Test Case execution
~~~~~~~~~~~~~~~~~~~

First we isolate the two WAN and the LAN interfaces of the first device via disabling them on the QFX5100. This will cause the device to be no longer avail and appears to be “dead” in the CSO management GUI.

This step in the beginning of the test case will also prove that CSO always keeps a local copy (or is able to reconstruct it) of the device configuration that is applied currently. Device-RMA can be used without still being able to pull the config from the actual device. The former device must not be reachable!!!

.. code-block:: none

   cli
   edit
   set interfaces xe-0/0/18 disable
   set interfaces xe-0/0/22 disable
   set interfaces xe-0/0/23 disable
   commit and-quit

After around **~3minutes wait**\ ing time the device will be noticed to be no longer avail.

|image604|

|image605|

To initiate Device-RMA go to device management checing the actual affected device.

|image606|

The open the dialogue for Device RMA

|image607|

|image608|

|image609|

The device status will now change to RMA so CSO will no long try to manage the device.

|image610|

Usually there is now a logistics process in charge to prepare and send a new device out to the Site replaceing the old and broken Device. We already have this device in place and it’s already wired to act as replacement so we can continue immediately after this step.

Now grant an RMA

|image611|

Simply fill in the serial number of the replacement device

|image612|

|image613|

As you see, when the device is not reachable anymore, the Grant-RMA process takes about 15minutes.

As our new NFX was configured to start immediately it’s device configuration starts right after this.

Now

|image614|

After the second device is back working check that the desktop4 client can ping the Internet again with proves the replacement device has fully taken over for the old one.

|image615|

Now looking at the device level there are still items open that you have to push to the new device. Those are optional to THIS lab (as the Firewall Rules are applied automatically). When you click onto the RMA button you see what you still must really to the new device before the RMA process is complete.

|image616|

Our lab doesn’t demand any of those additional steps so we just ackowlegde to RMA and click OK. The new device is then fully converged.

|image617|

This test case is now complete!

.. note:: Revert your config on the underlay QFX5100 switch as the other labs don’t have this configuration.

Real-time optimized (or AppQoE) SD-WAN
--------------------------------------

.. warning:: This lab has no separate Automation configuration as it’s based on the SD-WAN BASIC Scenario. Apply that at you should be good to go.

A public video about this feature is avail here https://youtu.be/yaK0wJQF1bI

The video below shows how you demonstrate this testcase with the Reference Lab.

You can also use this with the customer if you have no time for the preparations.

https://junipernetworks.sharepoint.com/:v:/t/Sales/Technical_Sales/coe/ESXI31GvfTFDkUmiy_3YpmoB4HkrQPeLVLtQhV1vzsbS_g?e=qvgLWM

For executing this test case we assume that you have already onboarded a Hub following the instructions in chapter 6.1 above!

We will now create a new tenant and then on-board a spoke before we execute the test cases.

Create a new Realtime Tenant
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

**We need a new tenant** as the old “hubspoketenant” was only for the bandwith optimized mode and these options can’t be used in the same tenant.

|image618|

.. warning:: Please stick to the name “realtimetenant” and do not customize this name.

|image619|

|image620|

There is no need to change anything in the dialogue field below.

|image621|

|image622|

.. code-block:: none

   
   {
       "input": {
           "tenant_admin": {
               "password_expiration_interval": 0,
               "admin_user_name": "juniperse@juniper.net",
               "last_name": "Doe",
               "first_name": "Joe",
               "roles": [
                   "9fe2ff9e-e438-4b18-94a9-0878d3e92bab"
               ]
           },
           "set_custom_threshold": false,
           "tenant_name": "realtimetenant",
           "default_ssl_proxy_profile": {
               "enabled": false
           },
           "departments": [
               {
                   "vpn_name": "realtimetenant_DefaultVPN",
                   "department_name": "Default"
               }
           ],
           "supported_deployment_scenario": [
               "managed_wan_v2"
           ],
           "create_dvpn_threshold": 5,
           "max_dvpn_tenant_tunnels": 25000,
           "delete_dvpn_threshold": 2,
           "max_dvpn_cso_tunnels": 100000,
           "password_expiration_radio": "never",
           "vpn": [
               {
                   "max_links_per_site": 3,
                   "vpn_name": "realtimetenant_DefaultVPN",
                   "tunnel_type": "GRE_IPSEC",
                   "topology": "mesh"
               }
           ],
           "managed_wan_topology_v2": {},
           "properties": {
               "property": [
                   {
                       "name": "default-fullmesh-type",
                       "value": "redundant-sparse"
                   },
                   {
                       "name": "connect-different-underlay-link-types",
                       "value": false
                   },
                   {
                       "name": "default-max-links-per-site-in-fullmesh",
                       "value": "3"
                   },
                   {
                       "name": "fullmesh-with-cloudhub",
                       "value": true
                   },
                   {
                       "name": "default-tenant-topology",
                       "value": "mesh"
                   },
                   {
                       "name": "sla_mgmt",
                       "value": "FINE"
                   },
                   {
                       "name": "default-tunnel-type",
                       "value": "GRE_IPSEC"
                   },
                   {
                       "name": "ip-encoding-enabled",
                       "value": true
                   },
                   {
                       "name": "dvpn-enabled",
                       "value": true
                   },
                   {
                       "name": "mesh-tags",
                       "value": [
                           "MPLS",
                           "INTERNET"
                       ]
                   },
                   {
                       "name": "create_dvpn_threshold",
                       "value": 5
                   },
                   {
                       "name": "delete_dvpn_threshold",
                       "value": 2
                   },
                   {
                       "name": "max_dvpn_cso_tunnels",
                       "value": 100000
                   },
                   {
                       "name": "max_dvpn_tenant_tunnels",
                       "value": 25000
                   }
               ]
           },
           "ipsec_vpn_cfg": {
               "vpn_authentication": {
                   "preshared_key_enabled": true
               },
               "overlay_tunnel_encryption": {
                   "encryption_type": "aes-256-gcm"
               }
           }
       }
   }
   

Onboard Hub to Tenant
~~~~~~~~~~~~~~~~~~~~~

|image623|

|image624|

|image625|

.. code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "job_name_prefix": "Create-Site-for-hub1",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "hub1",
                   "cloud_hub_site_info": {
                       "hub_device": "hub1",
                       "wan_links": [
                           "WAN_1",
                           "lo0.0",
                           "WAN_0"
                       ],
                       "pop": "sdwan-pop"
                   },
                   "site_basic_properties": {
                       "site_address": {
                           "country": "US"
                       },
                       "site_description": "",
                       "site_role": "HUB",
                       "cloud_service": "NONE",
                       "site_type": "cloud"
                   }
               }
           ]
       }
   }
   

|image626|

Onboard the Spoke Device
~~~~~~~~~~~~~~~~~~~~~~~~

We now on-board a Spoke following the instructions given in chapter 6.4 and 6.5 above depending on the device type you want to use for this demo.

Execute the Spoke onboarding now according to one of these mentioned chapters and come back when this is done.

.. note:: During the creation you see more and extended dialogue options like the ones below. These are because in Realtime mode new features like Dynamic Tunnels, Mesh capabilities and the new Site Gateway are avail. Follow the examples below to fill them out as shown.

|image627|

|image628|

.. hidden-code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "sdwansite2",
                   "site_basic_properties": {
                       "local_breakout": {},
                       "gatewaySite": false,
                       "site_type": "on_premise",
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": false,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "provider": "abc",
                                       "wan_link": "WAN_0",
                                       "access_type": "Ethernet",
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "90d3d046-f74e-b5f8-260e-4986e7498e8f",
                                       "cost": 2222,
                                       "subscribed_bandwidth": 1000,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "provider": "xyz",
                                       "wan_link": "WAN_1",
                                       "access_type": "Ethernet",
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "07fd9186-2b17-ce8e-694a-3acda4cd6921",
                                       "cost": 111,
                                       "subscribed_bandwidth": 1000,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "NFX_Advanced_SDWAN_CPE_option_1",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "10.66.66.1/24",
                                       "lan_segment_name": "desktop2",
                                       "vlan": 1066,
                                       "lan_ports": [
                                           "LAN_0"
                                       ],
                                       "department": "Default",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwansite2"
                           }
                       ],
                       "0": {
                           "ip_prefix": "10.66.66.1/24",
                           "lan_segment_name": "desktop2",
                           "vlan": 1066,
                           "lan_ports": [
                               "LAN_0"
                           ],
                           "department": "Default",
                           "dhcp": false
                       },
                       "site_role": "SPOKE",
                       "sla_mgmt": "FINE",
                       "device_profile_name": "NFX250 as SD-WAN CPE",
                       "site_name": "sdwansite2",
                       "site_group": null,
                       "dvpn_params": {
                           "delete_dvpn_threshold": 2,
                           "create_dvpn_threshold": 5
                       },
                       "topology": "Real-Time Optimized"
                   }
               }
           ]
       }
   }
   

.. hidden-code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "job_name_prefix": "realtimetenant-sdwansite2",
           "site": [
               {
                   "on_premise_site_info": {
                       "device": [
                           {
                               "is_gateway_site": false,
                               "wan_link": [
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/10",
                                       "used_for_meshing": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "traffic_type": "OAM_AND_DATA",
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.130.1",
                                           "ip_address": "192.168.130.2/24"
                                       },
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/11",
                                       "used_for_meshing": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "traffic_type": "DATA_ONLY",
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.133.1",
                                           "ip_address": "192.168.133.2/24"
                                       },
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   }
                               ],
                               "device_name": "sdwansite2",
                               "device_template": "NFX_Advanced_SDWAN_CPE_option_1",
                               "device_details": {
                                   "serial_number": "DD2116AF0059"
                               },
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.4/32"
                               }
                           }
                       ],
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "region": "regional",
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       }
                   },
                   "site_name": "sdwansite2",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }
   

After you have on-boarded a Spoke (here we have used a NFX250 to be very similar with the video above) you can straight start with the Demo or first review the applied configuration because there are dramatic changes made under the hood.

Before you start the next activity make sure that:

-  You have created and deployed a Firewall rule to pass all traffic as in other chapters
-  You have deployed a License to the spoke device as in chapter 6.6.1 above
-  You have loaded a signature DB onto the device as in chapter 6.6.2 above

|image629|

The below is just for reference as you see the config is much cleaner and the routing table is shrinked because we don’t need so much traffic VRF’s anymore to steer the traffic.

.. hidden-code-block:: none

   
   root@GWR.sdwansite2.realtimetenant> show configuration
   ## Last commit: 2019-02-14 14:51:12 CET by root
   version "15.1-2019-01-28.0_JUNOS_151_X49_D170 [ssd-builder]";
   groups {
       global {
           security {
               policies {
                   default-policy {
                       deny-all;
                   }
               }
           }
       }
       cso-security-base {
           system {
               no-redirects;
               authentication-order password;
               login {
                   announcement "This system is private property.";
                   message "Unauthorized access will be reported.";
                   retry-options {
                       tries-before-disconnect 3;
                       backoff-threshold 2;
                       backoff-factor 5;
                       maximum-time 20;
                       lockout-period 5;
                   }
                   user juniper {
                       uid 2001;
                       class admin;
                       authentication {
                           encrypted-password "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0"; ## SECRET-DATA
                       }
                   }
               }
               services {
                   ssh {
                       root-login allow;
                       no-tcp-forwarding;
                       protocol-version v2;
                       connection-limit 50;
                       rate-limit 50;
                   }
                   netconf {
                       ssh {
                           connection-limit 49;
                           rate-limit 49;
                       }
                   }
               }
           }
           interfaces {
               ge-0/0/2 {
                   unit 0 {
                       family inet {
                           filter {
                               group 2;
                           }
                       }
                   }
               }
               st0 {
                   unit 4000 {
                       family inet {
                           filter {
                               group 2;
                           }
                       }
                   }
                   unit 4001 {
                       family inet {
                           filter {
                               group 2;
                           }
                       }
                   }
               }
               ge-0/0/3 {
                   unit 0 {
                       family inet {
                           filter {
                               group 3;
                           }
                       }
                   }
               }
               ge-0/0/4 {
                   unit <*> {
                       family inet {
                           filter {
                               group 1;
                           }
                       }
                   }
               }
               ge-0/0/6 {
                   unit <*> {
                       family inet {
                           filter {
                               group 1;
                           }
                       }
                   }
               }
               fxp0 {
                   unit 0 {
                       family inet {
                           filter {
                               group 55;
                           }
                       }
                   }
               }
               ge-0/0/1 {
                   unit 0 {
                       family inet {
                           filter {
                               group 54;
                           }
                       }
                   }
               }
               lo0 {
                   unit 0 {
                       family inet {
                           filter {
                               input protect_re_ipv4;
                           }
                       }
                   }
               }
           }
           policy-options {
               prefix-list re-ntp {
                   apply-path "system ntp server <*>";
               }
               prefix-list re-ssh {
                   192.168.10.0/24;
                   192.168.210.4/32;
                   10.10.10.0/24;
                   192.0.2.254/32;
               }
               prefix-list bgp-neighbors {
                   apply-path "protocols bgp group <*> neighbor <*>";
               }
               prefix-list re-bgp-vrf {
                   apply-path "routing-instances <*> protocols bgp group <*> neighbor <*>";
               }
               prefix-list re-dns {
                   apply-path "system name-server <*>";
               }
               prefix-list loopback-ipv4 {
                   apply-path "interfaces lo0 unit 0 family inet address <*>";
               }
               prefix-list re-ospf {
                   apply-path "interfaces <*> unit <*> family inet address <*>";
               }
               prefix-list re-tacacs {
                   apply-path "system tacplus-server <*>";
               }
               prefix-list re-snmp {
                   192.168.10.0/24;
               }
           }
           firewall {
               family inet {
                   filter protect_re_ipv4 {
                       term bfd {
                           from {
                               source-prefix-list {
                                   re-bgp-vrf;
                                   re-ospf;
                               }
                               protocol udp;
                               source-port 49152-65535;
                               destination-port [ 3784 4784 ];
                           }
                           then {
                               count bfd;
                               accept;
                           }
                       }
                       term ssh {
                           from {
                               interface-group [ 2 55 54 ];
                               protocol tcp;
                               port ssh;
                           }
                           then {
                               count ssh;
                               accept;
                           }
                       }
                       term cso-port-444-permit {
                           from {
                               interface-group [ 2 55 ];
                               source-prefix-list {
                                   re-ssh;
                               }
                               protocol tcp;
                               port 444;
                           }
                           then {
                               count cso-port-444;
                               accept;
                           }
                       }
                       term icmp {
                           from {
                               protocol icmp;
                               icmp-type [ echo-request echo-reply unreachable time-exceeded ];
                           }
                           then {
                               policer icmp;
                               count icmp;
                               accept;
                           }
                       }
                       term trace-route {
                           from {
                               protocol udp;
                               destination-port 33434-33523;
                           }
                           then {
                               policer tracert;
                               accept;
                           }
                       }
                       term dhcp {
                           from {
                               protocol udp;
                               port [ 67 68 ];
                           }
                           then {
                               policer dhcp;
                               count dhcp;
                               accept;
                           }
                       }
                       term bgp {
                           from {
                               source-prefix-list {
                                   bgp-neighbors;
                                   re-bgp-vrf;
                               }
                               protocol tcp;
                               port bgp;
                           }
                           then {
                               count bgp;
                               accept;
                           }
                       }
                       term ntp-local {
                           from {
                               source-prefix-list {
                                   re-ntp;
                                   loopback-ipv4;
                               }
                               protocol udp;
                               port ntp;
                           }
                           then {
                               count ntp;
                               accept;
                           }
                       }
                       term ike {
                           from {
                               interface-group [ 2 3 ];
                               protocol udp;
                               destination-port [ 500 4500 ];
                           }
                           then {
                               count ike;
                               accept;
                           }
                       }
                       term gre-oam {
                           from {
                               protocol udp;
                               source-port 49153;
                               destination-port 49153;
                           }
                           then {
                               count gre-oam;
                               accept;
                           }
                       }
                       term ospf {
                           from {
                               interface-group 1;
                               source-prefix-list {
                                   re-ospf;
                               }
                               protocol ospf;
                           }
                           then {
                               count ospf;
                               accept;
                           }
                       }
                       term dns {
                           from {
                               interface-group [ 2 3 ];
                               prefix-list {
                                   re-dns;
                               }
                               protocol udp;
                               port domain;
                           }
                           then {
                               policer dns-policer;
                               count dns;
                               accept;
                           }
                       }
                       term https_discard {
                           from {
                               interface-group 1;
                               protocol tcp;
                               source-port https;
                           }
                           then {
                               count https-discard;
                               discard;
                           }
                       }
                       term https {
                           from {
                               protocol tcp;
                               source-port https;
                           }
                           then {
                               count https;
                               accept;
                           }
                       }
                       term http {
                           from {
                               interface-group 2;
                               protocol tcp;
                               source-port 8060;
                           }
                           then {
                               count http;
                               accept;
                           }
                       }
                       term external-syslog {
                           from {
                               source-prefix-list {
                                   re-ssh;
                               }
                               protocol [ tcp udp ];
                               port [ 514 3514 ];
                           }
                           then {
                               count external-syslog;
                               accept;
                           }
                       }
                       term default {
                           then {
                               count discard-count;
                               log;
                               discard;
                           }
                       }
                   }
               }
               policer icmp {
                   if-exceeding {
                       bandwidth-limit 1m;
                       burst-size-limit 2k;
                   }
                   then discard;
               }
               policer tracert {
                   if-exceeding {
                       bandwidth-limit 1m;
                       burst-size-limit 15k;
                   }
                   then discard;
               }
               policer dhcp {
                   if-exceeding {
                       bandwidth-limit 1m;
                       burst-size-limit 15k;
                   }
                   then discard;
               }
               policer dns-policer {
                   if-exceeding {
                       bandwidth-limit 1m;
                       burst-size-limit 15k;
                   }
                   then discard;
               }
           }
       }
       nfx-gwr-site-routing-config-192.168.210.4 {
           security {
               zones {
                   security-zone trust {
                       enable-reverse-reroute;
                   }
               }
           }
           interfaces {
               lo0 {
                   unit 0 {
                       family inet {
                           address 192.168.210.4/32 {
                               primary;
                           }
                       }
                   }
                   unit 300 {
                       family inet {
                           address 172.31.31.14/32;
                       }
                   }
               }
           }
           routing-options {
               interface-routes {
                   rib-group inet local-breakout-rib;
               }
               rib-groups {
                   transit-inet3-to-inet3 {
                       import-rib [ transit.inet.3 inet.3 ];
                   }
                   local-breakout-rib {
                       import-rib [ inet.0 transit.inet.0 default-local-breakout.inet.0 mpls-local-breakout.inet.0 internet-local-breakout.inet.0 default-cloud-breakout.inet.0 ];
                       import-policy direct-routes;
                   }
                   probe-VR-to-inet0 {
                       import-rib [ probe-VR.inet.0 inet.0 ];
                       import-policy direct-policy;
                   }
               }
               router-id 192.168.210.4;
               autonomous-system 64512;
               forwarding-table {
                   export pplb;
               }
           }
           protocols {
               bgp {
                   group ibgp {
                       type internal;
                       local-address 192.168.210.4;
                       hold-time 200;
                       family inet-vpn {
                           unicast {
                               graceful-restart {
                                   long-lived {
                                       restarter {
                                           stale-time 16777215;
                                       }
                                   }
                               }
                           }
                       }
                       neighbor 192.168.10.49;
                   }
               }
           }
           policy-options {
               policy-statement pplb {
                   then {
                       load-balance per-packet;
                   }
               }
               policy-statement direct-routes {
                   term 1 {
                       from protocol direct;
                       then accept;
                   }
                   term 2 {
                       then reject;
                   }
               }
               policy-statement default-local-breakout-import {
                   term 1 {
                       from {
                           instance default-local-breakout;
                           route-filter 0.0.0.0/0 exact;
                       }
                       then accept;
                   }
                   term 2 {
                       then reject;
                   }
               }
               policy-statement mpls-local-breakout-import {
                   term 1 {
                       from {
                           instance mpls-local-breakout;
                           route-filter 0.0.0.0/0 exact;
                       }
                       then accept;
                   }
                   term 2 {
                       then reject;
                   }
               }
               policy-statement internet-local-breakout-import {
                   term 1 {
                       from {
                           instance internet-local-breakout;
                           route-filter 0.0.0.0/0 exact;
                       }
                       then accept;
                   }
                   term 2 {
                       then reject;
                   }
               }
               policy-statement default-cloud-breakout-import {
                   term 1 {
                       from {
                           instance default-cloud-breakout;
                           route-filter 0.0.0.0/0 exact;
                       }
                       then accept;
                   }
                   term 2 {
                       then reject;
                   }
               }
               policy-statement direct-policy {
                   term 1 {
                       from {
                           route-filter 172.31.31.14/32 exact;
                       }
                       then accept;
                   }
               }
           }
           routing-instances {
               transit {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:64512;
                   vrf-target target:192.168.210.4:64512;
                   routing-options {
                       rib transit.inet.3 {
                           static {
                               rib-group transit-inet3-to-inet3;
                           }
                       }
                   }
               }
               default-local-breakout {
                   instance-type forwarding;
               }
               mpls-local-breakout {
                   instance-type forwarding;
               }
               internet-local-breakout {
                   instance-type forwarding;
               }
               default-cloud-breakout {
                   instance-type forwarding;
               }
               probe-VR {
                   instance-type virtual-router;
                   interface lo0.300;
                   routing-options {
                       interface-routes {
                           rib-group inet probe-VR-to-inet0;
                       }
                   }
               }
           }
       }
       dept-configuration {
           security {
               zones {
                   security-zone Default {
                       host-inbound-traffic {
                           system-services {
                               all;
                           }
                           protocols {
                               all;
                           }
                       }
                       interfaces {
                           ge-0/0/4.1066;
                       }
                   }
               }
           }
           interfaces {
               ge-0/0/4 {
                   vlan-tagging;
                   unit 1066 {
                       vlan-id 1066;
                       family inet {
                           filter {
                               input-list appqoe_filter;
                           }
                           address 10.66.66.1/24;
                       }
                   }
               }
           }
           firewall {
               family inet {
                   filter appqoe_filter {
                       term aq_term1 {
                           from {
                               destination-port 36000;
                           }
                           then {
                               count aq_counter1;
                               discard;
                           }
                       }
                       term default {
                           then accept;
                       }
                   }
               }
           }
           routing-instances {
               LAN-realtimetenant_DefaultVPN {
                   interface ge-0/0/4.1066;
               }
           }
       }
       realtimetenant_SDWANSITE2_WAN_0_HUB1_WAN_0_IPSEC_0 {
           security {
               ipsec {
                   proposal 4d97f664a188a96387cb877f4b563fb8 {
                       protocol esp;
                       encryption-algorithm aes-256-gcm;
                   }
                   proposal 9c1a38ae438299b4d727b6733efeb381 {
                       protocol esp;
                       authentication-algorithm hmac-sha-256-128;
                       encryption-algorithm aes-256-cbc;
                   }
                   policy c4c9320690b88d0c57bdd6e5825e5702 {
                       perfect-forward-secrecy {
                           keys group14;
                       }
                       proposals [ 4d97f664a188a96387cb877f4b563fb8 9c1a38ae438299b4d727b6733efeb381 ];
                   }
                   vpn 6622fe2040705127ecf1efb660abac2d {
                       bind-interface st0.4002;
                       ike {
                           gateway d46788dc9e8a04f26798303873a6216e;
                           proxy-identity {
                               local 10.144.0.33/31;
                               remote 10.144.0.32/31;
                           }
                           ipsec-policy c4c9320690b88d0c57bdd6e5825e5702;
                       }
                       establish-tunnels immediately;
                   }
               }
               zones {
                   security-zone trust {
                       interfaces {
                           st0.4002;
                       }
                   }
               }
           }
           interfaces {
               st0 {
                   unit 4002 {
                       family inet {
                           address 10.144.0.33/31;
                       }
                   }
               }
           }
           routing-options {
               static {
                   route 192.168.190.0/24 next-hop 192.168.130.1;
               }
           }
           routing-instances {
               transit {
                   interface st0.4002;
               }
           }
       }
       realtimetenant_SDWANSITE2_WAN_1_HUB1_WAN_1_IPSEC_0 {
           security {
               ipsec {
                   proposal 4d97f664a188a96387cb877f4b563fb8 {
                       protocol esp;
                       encryption-algorithm aes-256-gcm;
                   }
                   proposal 9c1a38ae438299b4d727b6733efeb381 {
                       protocol esp;
                       authentication-algorithm hmac-sha-256-128;
                       encryption-algorithm aes-256-cbc;
                   }
                   policy c4c9320690b88d0c57bdd6e5825e5702 {
                       perfect-forward-secrecy {
                           keys group14;
                       }
                       proposals [ 4d97f664a188a96387cb877f4b563fb8 9c1a38ae438299b4d727b6733efeb381 ];
                   }
                   vpn 2cbb11bf38ab03ff7ebe57045148037d {
                       bind-interface st0.4003;
                       ike {
                           gateway ec02e45ce01e7e718ddcaefaf10c22fa;
                           proxy-identity {
                               local 10.144.0.35/31;
                               remote 10.144.0.34/31;
                           }
                           ipsec-policy c4c9320690b88d0c57bdd6e5825e5702;
                       }
                       establish-tunnels immediately;
                   }
               }
               zones {
                   security-zone trust {
                       interfaces {
                           st0.4003;
                       }
                   }
               }
           }
           interfaces {
               st0 {
                   unit 4003 {
                       family inet {
                           address 10.144.0.35/31;
                       }
                   }
               }
           }
           routing-options {
               static {
                   route 192.168.191.0/24 next-hop 192.168.133.1;
               }
           }
           routing-instances {
               transit {
                   interface st0.4003;
               }
           }
       }
       realtimetenant_SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 {
           security {
               zones {
                   security-zone trust {
                       interfaces {
                           gr-0/0/0.4000;
                       }
                   }
               }
           }
           interfaces {
               gr-0/0/0 {
                   unit 4000 {
                       tunnel {
                           source 10.144.0.33;
                           destination 10.144.0.32;
                           routing-instance {
                               destination transit;
                           }
                       }
                       family inet {
                           address 10.152.0.33/31;
                       }
                       family mpls;
                       copy-tos-to-outer-ip-header;
                   }
               }
           }
           protocols {
               oam {
                   gre-tunnel {
                       interface gr-0/0/0.4000 {
                           keepalive-time 4;
                           hold-time 8;
                       }
                   }
               }
           }
           routing-instances {
               transit {
                   interface gr-0/0/0.4000;
               }
           }
       }
       realtimetenant_SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 {
           security {
               zones {
                   security-zone trust {
                       interfaces {
                           gr-0/0/0.4001;
                       }
                   }
               }
           }
           interfaces {
               gr-0/0/0 {
                   unit 4001 {
                       tunnel {
                           source 10.144.0.35;
                           destination 10.144.0.34;
                           routing-instance {
                               destination transit;
                           }
                       }
                       family inet {
                           address 10.152.0.35/31;
                       }
                       family mpls;
                       copy-tos-to-outer-ip-header;
                   }
               }
           }
           protocols {
               oam {
                   gre-tunnel {
                       interface gr-0/0/0.4001 {
                           keepalive-time 4;
                           hold-time 8;
                       }
                   }
               }
           }
           routing-instances {
               transit {
                   interface gr-0/0/0.4001;
               }
           }
       }
       dg-hub1 {
           security {
               advance-policy-based-routing {
                   overlay-path 6622fe2040705127ecf1efb660abac2d {
                       tunnel-path {
                           local {
                               ip-address {
                                   10.152.0.33;
                               }
                           }
                           remote {
                               ip-address {
                                   10.152.0.32;
                               }
                           }
                       }
                       probe-path {
                           local {
                               ip-address {
                                   10.152.0.33;
                               }
                           }
                           remote {
                               ip-address {
                                   10.152.0.32;
                               }
                           }
                       }
                   }
                   overlay-path 2cbb11bf38ab03ff7ebe57045148037d {
                       tunnel-path {
                           local {
                               ip-address {
                                   10.152.0.35;
                               }
                           }
                           remote {
                               ip-address {
                                   10.152.0.34;
                               }
                           }
                       }
                       probe-path {
                           local {
                               ip-address {
                                   10.152.0.35;
                               }
                           }
                           remote {
                               ip-address {
                                   10.152.0.34;
                               }
                           }
                       }
                   }
                   destination-path-group hub1 {
                       probe-routing-instance {
                           transit;
                       }
                       overlay-path 6622fe2040705127ecf1efb660abac2d;
                       overlay-path 2cbb11bf38ab03ff7ebe57045148037d;
                   }
               }
           }
       }
       spoke-realtimetenant_DefaultVPN-vpn-routing-config {
           routing-options {
               rib-groups {
                   LAN-realtimetenant_DefaultVPN-to-breakout {
                       import-rib [ LAN-realtimetenant_DefaultVPN.inet.0 default-lbo-realtimetenant_DefaultVPN.inet.0 mpls-lbo-realtimetenant_DefaultVPN.inet.0 internet-lbo-realtimetenant_DefaultVPN.inet.0 default-cbo-realtimetenant_DefaultVPN.inet.0 ];
                       import-policy direct-routes;
                   }
               }
               forwarding-table {
                   export [ LAN-realtimetenant_DefaultVPN Default-realtimetenant_DefaultVPN-reverse ];
               }
           }
           protocols {
               bgp {
                   group ibgp {
                       import next-hop-change;
                       export static-export;
                       vpn-apply-export;
                   }
               }
           }
           policy-options {
               policy-statement PATH-POLICY-realtimetenant_DefaultVPN {
                   term realtimetenant_DefaultVPN-hub11 {
                       from community SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0-realtimetenant_DefaultVPN;
                       then accept;
                   }
                   term realtimetenant_DefaultVPN-hub12 {
                       from community SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0-realtimetenant_DefaultVPN;
                       then accept;
                   }
               }
               policy-statement next-hop-change {
                   term default-realtimetenant_DefaultVPN-hub11 {
                       from {
                           next-hop 192.168.210.1;
                           community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN;
                       }
                       then {
                           next-hop 10.192.0.10;
                       }
                   }
                   term default-realtimetenant_DefaultVPN-hub12 {
                       from {
                           next-hop 192.168.210.1;
                           community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN;
                       }
                       then {
                           next-hop 10.192.0.10;
                       }
                   }
                   term spoke-import-realtimetenant_DefaultVPN {
                       from community [ Spoke-Routes-LAN-realtimetenant_DefaultVPN datacenter ];
                       then {
                           next-hop 192.168.0.1;
                           accept;
                       }
                   }
               }
               policy-statement static-export {
                   term realtimetenant_DefaultVPN-1 {
                       from community Spoke-Routes-mpls-realtimetenant_DefaultVPN;
                       then {
                           community add spoke-community;
                           next-hop 10.192.0.17;
                           accept;
                       }
                   }
                   term realtimetenant_DefaultVPN-2 {
                       from community Spoke-Routes-internet-realtimetenant_DefaultVPN;
                       then {
                           community add spoke-community;
                           next-hop 10.192.0.16;
                           accept;
                       }
                   }
               }
               policy-statement donotexport {
                   then reject;
               }
               policy-statement direct-routes {
                   term 1 {
                       from protocol direct;
                       then accept;
                   }
                   term 2 {
                       then reject;
                   }
               }
               policy-statement LAN-realtimetenant_DefaultVPN {
                   term 1 {
                       from {
                           protocol bgp;
                           rib LAN-realtimetenant_DefaultVPN.inet.0;
                       }
                       then {
                           next-hop next-table Default-realtimetenant_DefaultVPN.inet.0;
                       }
                   }
               }
               policy-statement Default-realtimetenant_DefaultVPN-reverse {
                   term 1 {
                       from {
                           protocol bgp;
                           rib transit.inet.0;
                           community Spoke-Routes-LAN-realtimetenant_DefaultVPN;
                       }
                       then {
                           next-hop next-table Default-reverse-realtimetenant_DefaultVPN.inet.0;
                       }
                   }
               }
               policy-statement transit-import {
                   term realtimetenant_DefaultVPN-1 {
                       from community Spoke-Routes-LAN-realtimetenant_DefaultVPN;
                       then accept;
                   }
               }
               policy-statement mpls-realtimetenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-mpls-realtimetenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Hub-Primary-Routes-mpls-realtimetenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement internet-realtimetenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-internet-realtimetenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Hub-Primary-Routes-internet-realtimetenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
               }
               policy-statement mpls-realtimetenant_DefaultVPN-export {
                   term 1-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-mpls-realtimetenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           next-hop 10.192.0.17;
                           accept;
                       }
                   }
               }
               policy-statement internet-realtimetenant_DefaultVPN-export {
                   term 1-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-internet-realtimetenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           next-hop 10.192.0.16;
                           accept;
                       }
                   }
               }
               policy-statement LAN-realtimetenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-Default-realtimetenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Spoke-Routes-LAN-realtimetenant_DefaultVPN;
                       then accept;
                   }
                   term 3 {
                       from community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
                   term 5 {
                       from community datacenter;
                       then accept;
                   }
               }
               policy-statement Default-realtimetenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-Default-realtimetenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
                   term default {
                       then reject;
                   }
               }
               policy-statement Default-reverse-realtimetenant_DefaultVPN-import {
                   term 1 {
                       from community Spoke-Routes-Default-reverse-realtimetenant_DefaultVPN;
                       then accept;
                   }
                   term 2 {
                       from community Hub-Primary-Routes-Default-reverse-realtimetenant_DefaultVPN;
                       then {
                           local-preference 200;
                           accept;
                       }
                   }
                   term default {
                       then reject;
                   }
               }
               policy-statement Default-realtimetenant_DefaultVPN-export {
                   term realtimetenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-Default-realtimetenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           next-hop 192.168.210.4;
                           accept;
                       }
                   }
               }
               policy-statement LAN-realtimetenant_DefaultVPN-export {
                   term realtimetenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-LAN-realtimetenant_DefaultVPN;
                           next-hop 192.168.210.4;
                           accept;
                       }
                   }
               }
               policy-statement Default-reverse-realtimetenant_DefaultVPN-export {
                   term realtimetenant_DefaultVPN-direct {
                       from {
                           route-filter 10.66.66.0/24 exact;
                       }
                       then {
                           community add Spoke-Routes-Default-reverse-realtimetenant_DefaultVPN;
                           community add Hub-Primary-Select;
                           next-hop 192.168.210.4;
                           accept;
                       }
                   }
               }
               community SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0-realtimetenant_DefaultVPN members 64512:1;
               community SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0-realtimetenant_DefaultVPN members 64512:2;
               community Spoke-Routes-mpls-realtimetenant_DefaultVPN members target:64512:36;
               community Spoke-Routes-internet-realtimetenant_DefaultVPN members target:64512:37;
               community Hub-Primary-Routes-mpls-realtimetenant_DefaultVPN members target:192.168.210.1:36;
               community Hub-Primary-Routes-internet-realtimetenant_DefaultVPN members target:192.168.210.1:37;
               community Hub-Primary-Select members target:192.168.210.1:1;
               community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN members target:192.168.210.1:24;
               community Hub-Primary-Routes-Default-reverse-realtimetenant_DefaultVPN members target:192.168.210.1:25;
               community Spoke-Routes-Default-realtimetenant_DefaultVPN members target:64512:24;
               community Spoke-Routes-Default-reverse-realtimetenant_DefaultVPN members target:64512:25;
               community Spoke-Routes-LAN-realtimetenant_DefaultVPN members target:192.168.0.1:25;
               community datacenter members target:192.168.0.1:61151;
               community spoke-community members 64512:64512;
           }
           routing-instances {
               transit {
                   interface gr-0/0/0.4000;
                   interface gr-0/0/0.4001;
                   vrf-import transit-import;
                   routing-options {
                       rib transit.inet.3 {
                           static {
                               route 10.152.0.32/32 {
                                   next-hop gr-0/0/0.4000;
                                   qualified-next-hop gr-0/0/0.4001 {
                                       preference 8;
                                   }
                               }
                               route 10.192.0.9/32 {
                                   next-hop gr-0/0/0.4000;
                                   qualified-next-hop gr-0/0/0.4001 {
                                       preference 8;
                                   }
                               }
                               route 192.168.210.1/32 {
                                   qualified-next-hop gr-0/0/0.4000 {
                                       preference 12;
                                   }
                                   qualified-next-hop gr-0/0/0.4001 {
                                       preference 12;
                                   }
                               }
                               route 10.152.0.34/32 {
                                   next-hop gr-0/0/0.4001;
                                   qualified-next-hop gr-0/0/0.4000 {
                                       preference 8;
                                   }
                               }
                               route 10.192.0.8/32 {
                                   next-hop gr-0/0/0.4001;
                                   qualified-next-hop gr-0/0/0.4000 {
                                       preference 8;
                                   }
                               }
                               route 10.192.0.10/32 next-hop [ gr-0/0/0.4000 gr-0/0/0.4001 ];
                               route 192.168.0.1/32 {
                                   qualified-next-hop 192.168.210.1 {
                                       preference 9;
                                   }
                                   no-readvertise;
                                   resolve;
                               }
                           }
                       }
                   }
                   protocols {
                       mpls {
                           interface gr-0/0/0.4000;
                           interface gr-0/0/0.4001;
                       }
                   }
               }
               mpls-realtimetenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:36;
                   vrf-import mpls-realtimetenant_DefaultVPN-import;
                   vrf-export mpls-realtimetenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-realtimetenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-realtimetenant_DefaultVPN.inet.0;
                       }
                   }
               }
               internet-realtimetenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:37;
                   vrf-import internet-realtimetenant_DefaultVPN-import;
                   vrf-export internet-realtimetenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-realtimetenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                           route 10.66.66.0/24 next-table LAN-realtimetenant_DefaultVPN.inet.0;
                       }
                   }
               }
               default-lbo-realtimetenant_DefaultVPN {
                   instance-type forwarding;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-realtimetenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                       }
                       instance-import default-local-breakout-import;
                   }
               }
               mpls-lbo-realtimetenant_DefaultVPN {
                   instance-type forwarding;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table default-lbo-realtimetenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                       }
                       instance-import mpls-local-breakout-import;
                   }
               }
               internet-lbo-realtimetenant_DefaultVPN {
                   instance-type forwarding;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table default-lbo-realtimetenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                       }
                       instance-import internet-local-breakout-import;
                   }
               }
               default-cbo-realtimetenant_DefaultVPN {
                   instance-type forwarding;
                   routing-options {
                       static {
                           route 0.0.0.0/0 {
                               next-table Default-realtimetenant_DefaultVPN.inet.0;
                               preference 175;
                           }
                       }
                       instance-import default-cloud-breakout-import;
                   }
               }
               natVR-realtimetenant_DefaultVPN {
                   instance-type virtual-router;
                   routing-options {
                       static {
                           route 0.0.0.0/0 next-table LAN-realtimetenant_DefaultVPN.inet.0;
                       }
                   }
               }
               Default-realtimetenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 192.168.210.4:24;
                   vrf-import Default-realtimetenant_DefaultVPN-import;
                   vrf-export Default-realtimetenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 10.66.66.0/24 next-table LAN-realtimetenant_DefaultVPN.inet.0;
                       }
                   }
               }
               Default-reverse-realtimetenant_DefaultVPN {
                   instance-type vrf;
                   route-distinguisher 239.1.0.4:24;
                   vrf-import Default-reverse-realtimetenant_DefaultVPN-import;
                   vrf-export Default-reverse-realtimetenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 10.66.66.0/24 next-table LAN-realtimetenant_DefaultVPN.inet.0;
                       }
                   }
               }
               LAN-realtimetenant_DefaultVPN {
                   instance-type vrf;
                   interface ge-0/0/4.1066;
                   route-distinguisher 192.168.210.4:25;
                   vrf-import LAN-realtimetenant_DefaultVPN-import;
                   vrf-export LAN-realtimetenant_DefaultVPN-export;
                   vrf-table-label;
                   routing-options {
                       interface-routes {
                           rib-group inet LAN-realtimetenant_DefaultVPN-to-breakout;
                       }
                   }
               }
           }
       }
       spoke-policy-default {
           policy-options {
               policy-statement next-hop-change {
                   term default {
                       then accept;
                   }
               }
               policy-statement transit-import {
                   term default {
                       then reject;
                   }
               }
               policy-statement static-export {
                   term default {
                       then {
                           community add spoke-community;
                           accept;
                       }
                   }
               }
           }
       }
   }
   apply-groups [ global cso-security-base nfx-gwr-site-routing-config-192.168.210.4 dept-configuration realtimetenant_SDWANSITE2_WAN_0_HUB1_WAN_0_IPSEC_0 realtimetenant_SDWANSITE2_WAN_1_HUB1_WAN_1_IPSEC_0 realtimetenant_SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 realtimetenant_SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 dg-hub1 spoke-realtimetenant_DefaultVPN-vpn-routing-config spoke-policy-default ];
   system {
       host-name GWR.sdwansite2.realtimetenant;
       time-zone Europe/Amsterdam;
       default-address-selection;
       root-authentication {
           encrypted-password "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0"; ## SECRET-DATA
       }
       name-server {
           8.8.8.8;
       }
       login {
           class admin {
               idle-timeout 10;
               permissions all;
           }
           user csp {
               uid 2000;
               class admin;
               authentication {
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnuFJiRc63GdQfw6eqO7VmZBDuGFPB50JLFZm0hWyJW7FoDhRrJsgU7wnFRpO6MqxwDZ7iYbo9L31uEo6xkDyMKvtKj7xAn7DLOILUCRNZB9PZUwI6l8VodFDJH/O/bXndQgsKUau0edVsx8UkkgJlW4kM9SmKZ1/wFsoKju73kofkOjWAqxQb/utniT/a7Gv3+Chk1PNqBCZuX41kW59jzmOsYDKGZgWCwsLbX2rtdvGL0CZWqQKksQrJqWgtFVtj+mSsClfesDBGFZxIhh5H02EK8F8U1OiksKSsZiqtoImz6YPqisGnjHt6XE+Ap4MFn41GWRbZPM0jxVwxNeQR"; ## SECRET-DATA
                   ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCrCRDFXA4zqX+G7DJTkv8OCp83cA2CEEkDXHw3urU1AwhyGoy64bLlhd+vhI7df5ilFQI5gGYyO4cSYm/c927fdRs0c+MrF9BR3H+cw55OK1j3FnCEhJ1Vf/gZWpOrugoTyHZxWLHfz+b5YW1We4JTQcORXjZAZdffP1irAiL9uiVAuypAf60HDtFc1ZRo2DfmkfIm/O3mjX4/ABdCrY99+y667oMO33NnFe1mD9Q1vR4jFzOYcx7ILwthrKg1SvPN5qYxB3+JazSpZH4Us+rjtmktew5J6N2yb2PQkE7i2pXpYEZuS2DbJQYzZfCkElcOWA8U+gLoWiwLY8DwHxH5"; ## SECRET-DATA
               }
           }
       }
       services {
           ssh;
           netconf {
               ssh;
               rfc-compliant;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           host 192.168.10.47 {
               authorization any;
               daemon warning;
               port 514;
               structured-data;
           }
           file messages {
               any any;
               authorization info;
               archive size 10m files 10;
           }
           file interactive-commands {
               interactive-commands any;
               archive size 10m files 10;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
   }
   chassis {
       fpc 0 {
           pic 0 {
               traffic-manager {
                   queue-buffer-size small;
               }
           }
       }
   }
   services {
       application-identification;
   }
   security {
       log {
           utc-timestamp;
           mode stream;
           format sd-syslog;
           source-address 192.168.210.4;
           transport {
               protocol tcp;
           }
           stream app-track-logs {
               format sd-syslog;
               category all;
               host {
                   192.168.10.47;
                   port 3514;
               }
               rate-limit {
                   10000;
               }
           }
           stream all-logs {
               format sd-syslog;
               category all;
               host {
                   192.168.10.47;
                   port 514;
               }
               rate-limit {
                   10000;
               }
           }
       }
       pki {
           ca-profile DEFAULT_CSO_1 {
               ca-identity DEFAULT_CSO_1;
           }
           ca-profile DEFAULT_CSO_2 {
               ca-identity DEFAULT_CSO_2;
           }
           ca-profile DEFAULT_CSO_3 {
               ca-identity DEFAULT_CSO_3;
           }
           ca-profile DEFAULT_CSO_4 {
               ca-identity DEFAULT_CSO_4;
           }
           ca-profile DEFAULT_CSO_5 {
               ca-identity DEFAULT_CSO_5;
           }
           ca-profile DEFAULT_CSO_6 {
               ca-identity DEFAULT_CSO_6;
           }
           ca-profile DEFAULT_CSO_7 {
               ca-identity DEFAULT_CSO_7;
           }
           ca-profile DEFAULT_CSO_8 {
               ca-identity DEFAULT_CSO_8;
           }
           ca-profile DEFAULT_CSO_9 {
               ca-identity DEFAULT_CSO_9;
           }
           ca-profile DEFAULT_CSO_10 {
               ca-identity DEFAULT_CSO_10;
           }
           ca-profile DEFAULT_CSO_11 {
               ca-identity DEFAULT_CSO_11;
           }
           ca-profile DEFAULT_CSO_12 {
               ca-identity DEFAULT_CSO_12;
           }
           ca-profile DEFAULT_CSO_13 {
               ca-identity DEFAULT_CSO_13;
           }
           ca-profile DEFAULT_CSO_14 {
               ca-identity DEFAULT_CSO_14;
           }
           ca-profile DEFAULT_CSO_15 {
               ca-identity DEFAULT_CSO_15;
           }
           ca-profile DEFAULT_CSO_16 {
               ca-identity DEFAULT_CSO_16;
           }
           ca-profile DEFAULT_CSO_17 {
               ca-identity DEFAULT_CSO_17;
           }
           ca-profile DEFAULT_CSO_18 {
               ca-identity DEFAULT_CSO_18;
           }
           ca-profile DEFAULT_CSO_19 {
               ca-identity DEFAULT_CSO_19;
           }
           ca-profile DEFAULT_CSO_20 {
               ca-identity DEFAULT_CSO_20;
           }
           ca-profile DEFAULT_CSO_21 {
               ca-identity DEFAULT_CSO_21;
           }
           ca-profile DEFAULT_CSO_22 {
               ca-identity DEFAULT_CSO_22;
           }
           ca-profile DEFAULT_CSO_23 {
               ca-identity DEFAULT_CSO_23;
           }
           ca-profile DEFAULT_CSO_24 {
               ca-identity DEFAULT_CSO_24;
           }
           ca-profile DEFAULT_CSO_25 {
               ca-identity DEFAULT_CSO_25;
           }
           ca-profile DEFAULT_CSO_26 {
               ca-identity DEFAULT_CSO_26;
           }
           ca-profile DEFAULT_CSO_27 {
               ca-identity DEFAULT_CSO_27;
           }
           ca-profile DEFAULT_CSO_28 {
               ca-identity DEFAULT_CSO_28;
           }
           ca-profile DEFAULT_CSO_29 {
               ca-identity DEFAULT_CSO_29;
           }
           ca-profile DEFAULT_CSO_30 {
               ca-identity DEFAULT_CSO_30;
           }
           ca-profile DEFAULT_CSO_31 {
               ca-identity DEFAULT_CSO_31;
           }
           ca-profile DEFAULT_CSO_32 {
               ca-identity DEFAULT_CSO_32;
           }
           ca-profile DEFAULT_CSO_33 {
               ca-identity DEFAULT_CSO_33;
           }
           ca-profile DEFAULT_CSO_34 {
               ca-identity DEFAULT_CSO_34;
           }
           ca-profile DEFAULT_CSO_35 {
               ca-identity DEFAULT_CSO_35;
           }
           ca-profile DEFAULT_CSO_36 {
               ca-identity DEFAULT_CSO_36;
           }
           ca-profile DEFAULT_CSO_37 {
               ca-identity DEFAULT_CSO_37;
           }
           ca-profile DEFAULT_CSO_38 {
               ca-identity DEFAULT_CSO_38;
           }
           ca-profile DEFAULT_CSO_39 {
               ca-identity DEFAULT_CSO_39;
           }
           ca-profile DEFAULT_CSO_40 {
               ca-identity DEFAULT_CSO_40;
           }
           ca-profile DEFAULT_CSO_41 {
               ca-identity DEFAULT_CSO_41;
           }
           ca-profile DEFAULT_CSO_42 {
               ca-identity DEFAULT_CSO_42;
           }
           ca-profile DEFAULT_CSO_43 {
               ca-identity DEFAULT_CSO_43;
           }
           ca-profile DEFAULT_CSO_44 {
               ca-identity DEFAULT_CSO_44;
           }
           ca-profile DEFAULT_CSO_45 {
               ca-identity DEFAULT_CSO_45;
           }
           ca-profile DEFAULT_CSO_46 {
               ca-identity DEFAULT_CSO_46;
           }
           ca-profile DEFAULT_CSO_47 {
               ca-identity DEFAULT_CSO_47;
           }
           ca-profile DEFAULT_CSO_48 {
               ca-identity DEFAULT_CSO_48;
           }
           ca-profile DEFAULT_CSO_49 {
               ca-identity DEFAULT_CSO_49;
           }
           ca-profile DEFAULT_CSO_50 {
               ca-identity DEFAULT_CSO_50;
           }
           ca-profile DEFAULT_CSO_51 {
               ca-identity DEFAULT_CSO_51;
           }
           ca-profile DEFAULT_CSO_52 {
               ca-identity DEFAULT_CSO_52;
           }
           ca-profile DEFAULT_CSO_53 {
               ca-identity DEFAULT_CSO_53;
           }
           ca-profile DEFAULT_CSO_54 {
               ca-identity DEFAULT_CSO_54;
           }
           ca-profile DEFAULT_CSO_55 {
               ca-identity DEFAULT_CSO_55;
           }
           ca-profile DEFAULT_CSO_56 {
               ca-identity DEFAULT_CSO_56;
           }
           ca-profile DEFAULT_CSO_57 {
               ca-identity DEFAULT_CSO_57;
           }
           ca-profile DEFAULT_CSO_58 {
               ca-identity DEFAULT_CSO_58;
           }
           ca-profile DEFAULT_CSO_59 {
               ca-identity DEFAULT_CSO_59;
           }
           ca-profile DEFAULT_CSO_60 {
               ca-identity DEFAULT_CSO_60;
           }
           ca-profile DEFAULT_CSO_61 {
               ca-identity DEFAULT_CSO_61;
           }
           ca-profile DEFAULT_CSO_62 {
               ca-identity DEFAULT_CSO_62;
           }
           ca-profile DEFAULT_CSO_63 {
               ca-identity DEFAULT_CSO_63;
           }
           ca-profile DEFAULT_CSO_64 {
               ca-identity DEFAULT_CSO_64;
           }
           ca-profile DEFAULT_CSO_65 {
               ca-identity DEFAULT_CSO_65;
           }
           ca-profile DEFAULT_CSO_66 {
               ca-identity DEFAULT_CSO_66;
           }
           ca-profile DEFAULT_CSO_67 {
               ca-identity DEFAULT_CSO_67;
           }
           ca-profile DEFAULT_CSO_68 {
               ca-identity DEFAULT_CSO_68;
           }
           ca-profile DEFAULT_CSO_69 {
               ca-identity DEFAULT_CSO_69;
           }
           ca-profile DEFAULT_CSO_70 {
               ca-identity DEFAULT_CSO_70;
           }
           ca-profile DEFAULT_CSO_71 {
               ca-identity DEFAULT_CSO_71;
           }
           ca-profile DEFAULT_CSO_72 {
               ca-identity DEFAULT_CSO_72;
           }
           ca-profile DEFAULT_CSO_73 {
               ca-identity DEFAULT_CSO_73;
           }
           ca-profile DEFAULT_CSO_74 {
               ca-identity DEFAULT_CSO_74;
           }
           ca-profile DEFAULT_CSO_75 {
               ca-identity DEFAULT_CSO_75;
           }
           ca-profile DEFAULT_CSO_76 {
               ca-identity DEFAULT_CSO_76;
           }
           ca-profile DEFAULT_CSO_77 {
               ca-identity DEFAULT_CSO_77;
           }
           ca-profile DEFAULT_CSO_78 {
               ca-identity DEFAULT_CSO_78;
           }
           ca-profile DEFAULT_CSO_79 {
               ca-identity DEFAULT_CSO_79;
           }
           ca-profile DEFAULT_CSO_80 {
               ca-identity DEFAULT_CSO_80;
           }
           ca-profile DEFAULT_CSO_81 {
               ca-identity DEFAULT_CSO_81;
           }
           ca-profile DEFAULT_CSO_82 {
               ca-identity DEFAULT_CSO_82;
           }
           ca-profile DEFAULT_CSO_83 {
               ca-identity DEFAULT_CSO_83;
           }
           ca-profile DEFAULT_CSO_84 {
               ca-identity DEFAULT_CSO_84;
           }
           ca-profile DEFAULT_CSO_85 {
               ca-identity DEFAULT_CSO_85;
           }
           ca-profile DEFAULT_CSO_86 {
               ca-identity DEFAULT_CSO_86;
           }
           ca-profile DEFAULT_CSO_87 {
               ca-identity DEFAULT_CSO_87;
           }
           ca-profile DEFAULT_CSO_88 {
               ca-identity DEFAULT_CSO_88;
           }
           ca-profile DEFAULT_CSO_89 {
               ca-identity DEFAULT_CSO_89;
           }
           ca-profile DEFAULT_CSO_90 {
               ca-identity DEFAULT_CSO_90;
           }
           ca-profile DEFAULT_CSO_91 {
               ca-identity DEFAULT_CSO_91;
           }
           ca-profile DEFAULT_CSO_92 {
               ca-identity DEFAULT_CSO_92;
           }
           ca-profile DEFAULT_CSO_93 {
               ca-identity DEFAULT_CSO_93;
           }
           ca-profile DEFAULT_CSO_94 {
               ca-identity DEFAULT_CSO_94;
           }
           ca-profile DEFAULT_CSO_95 {
               ca-identity DEFAULT_CSO_95;
           }
           ca-profile DEFAULT_CSO_96 {
               ca-identity DEFAULT_CSO_96;
           }
           ca-profile DEFAULT_CSO_97 {
               ca-identity DEFAULT_CSO_97;
           }
           ca-profile DEFAULT_CSO_98 {
               ca-identity DEFAULT_CSO_98;
           }
           ca-profile DEFAULT_CSO_99 {
               ca-identity DEFAULT_CSO_99;
           }
           ca-profile DEFAULT_CSO_100 {
               ca-identity DEFAULT_CSO_100;
           }
           ca-profile DEFAULT_CSO_101 {
               ca-identity DEFAULT_CSO_101;
           }
           ca-profile DEFAULT_CSO_102 {
               ca-identity DEFAULT_CSO_102;
           }
           ca-profile DEFAULT_CSO_103 {
               ca-identity DEFAULT_CSO_103;
           }
           ca-profile DEFAULT_CSO_104 {
               ca-identity DEFAULT_CSO_104;
           }
           ca-profile DEFAULT_CSO_105 {
               ca-identity DEFAULT_CSO_105;
           }
           ca-profile DEFAULT_CSO_106 {
               ca-identity DEFAULT_CSO_106;
           }
           ca-profile DEFAULT_CSO_107 {
               ca-identity DEFAULT_CSO_107;
           }
           ca-profile DEFAULT_CSO_108 {
               ca-identity DEFAULT_CSO_108;
           }
           ca-profile DEFAULT_CSO_109 {
               ca-identity DEFAULT_CSO_109;
           }
           ca-profile DEFAULT_CSO_110 {
               ca-identity DEFAULT_CSO_110;
           }
           ca-profile DEFAULT_CSO_111 {
               ca-identity DEFAULT_CSO_111;
           }
           ca-profile DEFAULT_CSO_112 {
               ca-identity DEFAULT_CSO_112;
           }
           ca-profile DEFAULT_CSO_114 {
               ca-identity DEFAULT_CSO_114;
           }
           ca-profile DEFAULT_CSO_115 {
               ca-identity DEFAULT_CSO_115;
           }
           ca-profile DEFAULT_CSO_116 {
               ca-identity DEFAULT_CSO_116;
           }
           ca-profile DEFAULT_CSO_117 {
               ca-identity DEFAULT_CSO_117;
           }
           ca-profile DEFAULT_CSO_118 {
               ca-identity DEFAULT_CSO_118;
           }
           ca-profile DEFAULT_CSO_119 {
               ca-identity DEFAULT_CSO_119;
           }
           ca-profile DEFAULT_CSO_120 {
               ca-identity DEFAULT_CSO_120;
           }
           ca-profile DEFAULT_CSO_121 {
               ca-identity DEFAULT_CSO_121;
           }
           ca-profile DEFAULT_CSO_122 {
               ca-identity DEFAULT_CSO_122;
           }
           ca-profile DEFAULT_CSO_123 {
               ca-identity DEFAULT_CSO_123;
           }
           ca-profile DEFAULT_CSO_124 {
               ca-identity DEFAULT_CSO_124;
           }
           ca-profile DEFAULT_CSO_125 {
               ca-identity DEFAULT_CSO_125;
           }
           ca-profile DEFAULT_CSO_126 {
               ca-identity DEFAULT_CSO_126;
           }
           ca-profile DEFAULT_CSO_127 {
               ca-identity DEFAULT_CSO_127;
           }
           ca-profile DEFAULT_CSO_128 {
               ca-identity DEFAULT_CSO_128;
           }
           ca-profile DEFAULT_CSO_129 {
               ca-identity DEFAULT_CSO_129;
           }
           ca-profile DEFAULT_CSO_130 {
               ca-identity DEFAULT_CSO_130;
           }
           ca-profile DEFAULT_CSO_131 {
               ca-identity DEFAULT_CSO_131;
           }
           ca-profile DEFAULT_CSO_132 {
               ca-identity DEFAULT_CSO_132;
           }
           ca-profile DEFAULT_CSO_133 {
               ca-identity DEFAULT_CSO_133;
           }
           ca-profile DEFAULT_CSO_134 {
               ca-identity DEFAULT_CSO_134;
           }
           ca-profile DEFAULT_CSO_135 {
               ca-identity DEFAULT_CSO_135;
           }
           ca-profile DEFAULT_CSO_136 {
               ca-identity DEFAULT_CSO_136;
           }
           ca-profile DEFAULT_CSO_137 {
               ca-identity DEFAULT_CSO_137;
           }
           ca-profile DEFAULT_CSO_138 {
               ca-identity DEFAULT_CSO_138;
           }
           ca-profile DEFAULT_CSO_139 {
               ca-identity DEFAULT_CSO_139;
           }
           ca-profile DEFAULT_CSO_140 {
               ca-identity DEFAULT_CSO_140;
           }
           ca-profile DEFAULT_CSO_141 {
               ca-identity DEFAULT_CSO_141;
           }
           ca-profile DEFAULT_CSO_142 {
               ca-identity DEFAULT_CSO_142;
           }
           ca-profile DEFAULT_CSO_143 {
               ca-identity DEFAULT_CSO_143;
           }
           ca-profile DEFAULT_CSO_144 {
               ca-identity DEFAULT_CSO_144;
           }
           ca-profile DEFAULT_CSO_145 {
               ca-identity DEFAULT_CSO_145;
           }
           ca-profile DEFAULT_CSO_146 {
               ca-identity DEFAULT_CSO_146;
           }
           ca-profile DEFAULT_CSO_147 {
               ca-identity DEFAULT_CSO_147;
           }
           ca-profile DEFAULT_CSO_148 {
               ca-identity DEFAULT_CSO_148;
           }
           ca-profile DEFAULT_CSO_149 {
               ca-identity DEFAULT_CSO_149;
           }
           ca-profile DEFAULT_CSO_150 {
               ca-identity DEFAULT_CSO_150;
           }
           ca-profile DEFAULT_CSO_151 {
               ca-identity DEFAULT_CSO_151;
           }
           ca-profile DEFAULT_CSO_152 {
               ca-identity DEFAULT_CSO_152;
           }
           ca-profile DEFAULT_CSO_153 {
               ca-identity DEFAULT_CSO_153;
           }
           ca-profile DEFAULT_CSO_154 {
               ca-identity DEFAULT_CSO_154;
           }
           ca-profile DEFAULT_CSO_155 {
               ca-identity DEFAULT_CSO_155;
           }
           ca-profile-group DEFAULT_CSO {
               cert-base-count 155;
           }
       }
       ike {
           proposal aes-256-gcm-PSK {
               authentication-method pre-shared-keys;
               dh-group group14;
               encryption-algorithm aes-256-gcm;
           }
           proposal aes-256-cbc-PSK {
               authentication-method pre-shared-keys;
               dh-group group14;
               authentication-algorithm sha-256;
               encryption-algorithm aes-256-cbc;
           }
           policy 511ff62336e810b9b154a285599a436f {
               mode aggressive;
               proposals [ aes-256-gcm-PSK aes-256-cbc-PSK ];
               pre-shared-key ascii-text "$9$fz6CtpOhSlk.OIRhleZGDiH.At0IhyX7H.P53nyleWdwJGjHkmtu2oaJDjcSrlv8-Vsg4Jx7F6ApIRhcyeWXJGjiqmKMVsY2ZG/9Ap01hcrLNVyr"; ## SECRET-DATA
           }
           policy fc0b9295a231eb88a77cabc82e7aa1c6 {
               mode aggressive;
               proposals [ aes-256-gcm-PSK aes-256-cbc-PSK ];
               pre-shared-key ascii-text "$9$hgwrv8Xx-YgaBI-bwYaJCAp0OILXNbY4HqOIEceK4aJDPT9AuOBRX7F69Cu0g4aJUiP5zn6Cq.eMX7ws2goZjkCt0BRhUjTF3ntp8LxNdwg4JkPTaJ"; ## SECRET-DATA
           }
           gateway d46788dc9e8a04f26798303873a6216e {
               ike-policy 511ff62336e810b9b154a285599a436f;
               address 192.168.190.254;
               dead-peer-detection {
                   interval 10;
                   threshold 3;
               }
               local-identity hostname OAM-SDWANSITE2_WAN_0_HUB1_WAN_0_IPSEC_0;
               external-interface ge-0/0/2.0;
               version v2-only;
           }
           gateway ec02e45ce01e7e718ddcaefaf10c22fa {
               ike-policy fc0b9295a231eb88a77cabc82e7aa1c6;
               address 192.168.191.254;
               dead-peer-detection {
                   interval 10;
                   threshold 3;
               }
               local-identity hostname OAM-SDWANSITE2_WAN_1_HUB1_WAN_1_IPSEC_0;
               external-interface ge-0/0/3.0;
               version v2-only;
           }
       }
       ipsec {
           proposal 4d97f664a188a96387cb877f4b563fb8 {
               protocol esp;
               encryption-algorithm aes-256-gcm;
           }
           proposal 9c1a38ae438299b4d727b6733efeb381 {
               protocol esp;
               authentication-algorithm hmac-sha-256-128;
               encryption-algorithm aes-256-cbc;
           }
           policy c4c9320690b88d0c57bdd6e5825e5702 {
               perfect-forward-secrecy {
                   keys group14;
               }
               proposals [ 4d97f664a188a96387cb877f4b563fb8 9c1a38ae438299b4d727b6733efeb381 ];
           }
           vpn 68bd316586d9e5d293b3a8c7b483a3c6 {
               bind-interface st0.4000;
               ike {
                   gateway d46788dc9e8a04f26798303873a6216e;
                   proxy-identity {
                       local 10.176.0.33/31;
                       remote 10.176.0.32/31;
                   }
                   ipsec-policy c4c9320690b88d0c57bdd6e5825e5702;
               }
               establish-tunnels immediately;
           }
           vpn a9da3efa7c5c682fe497592b4d8c65fb {
               bind-interface st0.4001;
               ike {
                   gateway ec02e45ce01e7e718ddcaefaf10c22fa;
                   proxy-identity {
                       local 10.176.0.35/31;
                       remote 10.176.0.34/31;
                   }
                   ipsec-policy c4c9320690b88d0c57bdd6e5825e5702;
               }
               establish-tunnels immediately;
           }
       }
       address-book {
           global {
               address ls-10.66.66.0/24-sdwansite2-desktop2 10.66.66.0/24;
           }
       }
       advance-policy-based-routing {
           tunables {
               enable-logging;
           }
       }
       application-tracking;
       flow {
           allow-dns-reply;
           allow-embedded-icmp;
           aging {
               early-ageout 65535;
           }
           tcp-mss {
               all-tcp {
                   mss 1350;
               }
               ipsec-vpn {
                   mss 1200;
               }
           }
           tcp-session {
               no-syn-check;
               no-syn-check-in-tunnel;
               no-sequence-check;
           }
       }
       screen {
           ids-option untrust-screen {
               icmp {
                   ip-sweep;
                   fragment;
                   flood threshold 1000;
                   ping-death;
               }
               ip {
                   bad-option;
                   source-route-option;
                   unknown-protocol;
                   tear-drop;
               }
               tcp {
                   syn-fin;
                   fin-no-ack;
                   tcp-no-flag;
                   syn-frag;
                   port-scan threshold 1000;
                   syn-flood {
                       alarm-threshold 1024;
                       attack-threshold 200;
                       source-threshold 1024;
                       destination-threshold 2048;
                       queue-size 2000; ## Warning: 'queue-size' is deprecated
                       timeout 20;
                   }
                   land;
                   winnuke;
                   tcp-sweep threshold 1000;
               }
               udp {
                   udp-sweep threshold 1000;
               }
           }
       }
       nat {
           source {
               pool oam_pool {
                   address {
                       192.168.210.4/32;
                   }
               }
               rule-set underlay-mgmt-traffic-nat {
                   from routing-instance default;
                   to zone untrust;
                   rule r4 {
                       match {
                           source-address 192.168.210.4/32;
                       }
                       then {
                           source-nat {
                               interface;
                           }
                       }
                   }
               }
               rule-set mgmt-traffic-nat {
                   from interface ge-0/0/1.0;
                   to interface [ st0.4000 st0.4001 ];
                   rule r1 {
                       match {
                           destination-address 192.168.10.0/24;
                       }
                       then {
                           source-nat {
                               pool {
                                   oam_pool;
                               }
                           }
                       }
                   }
               }
               rule-set own-mgmt-traffic-nat {
                   from routing-instance default;
                   to interface [ st0.4000 st0.4001 ];
                   rule r2 {
                       match {
                           source-address 0.0.0.0/0;
                           protocol icmp;
                       }
                       then {
                           source-nat {
                               off;
                           }
                       }
                   }
                   rule r3 {
                       match {
                           source-address 0.0.0.0/0;
                       }
                       then {
                           source-nat {
                               pool {
                                   oam_pool;
                               }
                           }
                       }
                   }
               }
           }
       }
       policies {
           from-zone oam to-zone untrust {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone trust to-zone untrust {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone oam to-zone oam {
               policy default-permit {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone Default to-zone trust {
               policy appQoe-36600-Permit-rule {
                   match {
                       source-address any;
                       destination-address any;
                       application appQoe-36000;
                   }
                   then {
                       permit;
                   }
               }
               policy Intent_1 {
                   match {
                       source-address ls-10.66.66.0/24-sdwansite2-desktop2;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone Default to-zone Default {
               policy Intent_2 {
                   match {
                       source-address ls-10.66.66.0/24-sdwansite2-desktop2;
                       destination-address ls-10.66.66.0/24-sdwansite2-desktop2;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           default-policy {
               deny-all;
           }
           policy-rematch;
       }
       zones {
           security-zone trust {
               tcp-rst;
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
           }
           security-zone oam {
               tcp-rst;
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/1.0;
                   lo0.0;
                   st0.4000;
                   st0.4001;
               }
           }
           security-zone untrust {
               screen untrust-screen;
               host-inbound-traffic {
                   system-services {
                       dhcp;
                       ike;
                       ssh;
                       ping;
                   }
                   protocols {
                       bgp;
                   }
               }
               interfaces {
                   ge-0/0/2.0;
                   ge-0/0/3.0;
               }
           }
           security-zone Default {
               application-tracking;
           }
       }
   }
   interfaces {
       /* Internal OAM interface */
       ge-0/0/1 {
           unit 0 {
               family inet {
                   address 10.10.10.3/24;
               }
           }
       }
       /* wan_0 interface */
       ge-0/0/2 {
           description "WAN-0 interface";
           mac ec:13:db:db:09:4c;
           unit 0 {
               family inet {
                   address 192.168.130.2/24;
               }
           }
       }
       /* wan_1 interface */
       ge-0/0/3 {
           description "WAN-1 interface";
           unit 0 {
               family inet {
                   address 192.168.133.2/24;
               }
           }
       }
       /* wan_2 interface */
       /* wan_3 interface */
       /* AUX_0 Connected to JCP */
       ge-0/0/4 {
           description "AUX_0 Connected to JCP";
           vlan-tagging;
           unit 0 {
               vlan-id 4001;
               family inet {
                   address 10.10.0.2/24;
               }
           }
       }
       /* AUX_1 */
       ge-0/0/5 {
           description AUX_1;
           unit 0 {
               family inet {
                   address 10.10.12.2/24;
               }
           }
       }
       /* AUX_2 */
       ge-0/0/6 {
           description AUX_2;
           unit 0 {
               family inet {
                   address 10.10.13.2/24;
               }
           }
       }
       /* Internal management port */
       fxp0 {
           description "Internal management port";
           unit 0 {
               family inet {
                   address 192.0.2.100/24;
               }
           }
       }
       /* Loopback Interface */
       lo0 {
           description "Loopback Interface";
           unit 0 {
               family inet {
                   address 192.168.210.4/32;
               }
           }
       }
       st0 {
           per-unit-scheduler;
           unit 4000 {
               family inet {
                   address 10.176.0.33/31;
               }
           }
           unit 4001 {
               family inet {
                   address 10.176.0.35/31;
               }
           }
       }
   }
   snmp {
       engine-id {
           local gwr;
       }
   }
   routing-options {
       static {
           route 192.168.210.1/32 next-hop [ st0.4000 st0.4001 ];
           route 192.168.190.254/32 next-hop 192.168.130.1;
           route 192.168.191.254/32 next-hop 192.168.133.1;
           route 0.0.0.0/0 {
               next-hop 192.168.133.1;
               no-readvertise;
           }
       }
       autonomous-system 64512;
       forwarding-table {
           export rejject_access_internal_fxp0;
       }
   }
   protocols {
       bgp {
           group oam-bgp {
               type internal;
               local-address 192.168.210.4;
               import prim-lp-import;
               family inet {
                   unicast;
               }
               neighbor 192.168.210.1 {
                   export oam-route-export-prim;
               }
           }
       }
   }
   policy-options {
       policy-statement ebgp-export {
           term static {
               from protocol static;
               then accept;
           }
           term reject {
               then reject;
           }
       }
       policy-statement oam-route-export {
           term 1 {
               from {
                   protocol direct;
                   route-filter 192.168.210.4/32 exact;
               }
               then accept;
           }
           term default {
               then reject;
           }
       }
       policy-statement oam-route-export-prim {
           term 1 {
               from {
                   protocol direct;
                   route-filter 192.168.210.4/32 exact;
               }
               then {
                   community add Hub-Primary-Select;
                   accept;
               }
           }
           term default {
               then reject;
           }
       }
       policy-statement prim-lp-import {
           term 1 {
               from next-hop 192.168.210.1;
               then {
                   local-preference 200;
                   accept;
               }
           }
       }
       policy-statement rejject_access_internal_fxp0 {
           from {
               protocol access-internal;
               interface fxp0.0;
           }
           then reject;
       }
       community Hub-Primary-Select members target:192.168.210.1:1;
   }
   class-of-service {
       interfaces {
           ge-0/0/2 {
               shaping-rate 1g;
           }
           ge-0/0/3 {
               shaping-rate 1g;
           }
       }
   }
   applications {
       application appQoe-36000 {
           protocol udp;
           destination-port 36000;
       }
   }
   
   root@GWR.sdwansite2.realtimetenant> show route
   
   inet.0: 27 destinations, 27 routes (27 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:17:45
                       > to 192.168.133.1 via ge-0/0/3.0
   10.10.0.0/24       *[Direct/0] 00:17:45
                       > via ge-0/0/4.0
   10.10.0.2/32       *[Local/0] 00:17:46
                         Local via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:17:45
                       > via ge-0/0/1.0
   10.10.10.3/32      *[Local/0] 00:17:46
                         Local via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:17:45
                       > via ge-0/0/5.0
   10.10.12.2/32      *[Local/0] 00:17:46
                         Local via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:17:45
                       > via ge-0/0/6.0
   10.10.13.2/32      *[Local/0] 00:17:46
                         Local via ge-0/0/6.0
   10.176.0.32/31     *[Direct/0] 00:16:58
                       > via st0.4000
   10.176.0.33/32     *[Local/0] 00:17:55
                         Local via st0.4000
   10.176.0.34/31     *[Direct/0] 00:17:36
                       > via st0.4001
   10.176.0.35/32     *[Local/0] 00:17:55
                         Local via st0.4001
   172.31.31.14/32    *[Direct/0] 00:15:02
                       > via lo0.300
   192.0.2.0/24       *[Direct/0] 00:16:48
                       > via fxp0.0
   192.0.2.100/32     *[Local/0] 00:16:48
                         Local via fxp0.0
   192.168.10.0/24    *[BGP/170] 00:17:28, localpref 200, from 192.168.210.1
                         AS path: 65000 I, validation-state: unverified
                       > via st0.4000
                         via st0.4001
   192.168.130.0/24   *[Direct/0] 00:17:00
                       > via ge-0/0/2.0
   192.168.130.2/32   *[Local/0] 00:17:46
                         Local via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:17:45
                       > via ge-0/0/3.0
   192.168.133.2/32   *[Local/0] 00:17:46
                         Local via ge-0/0/3.0
   192.168.190.0/24   *[Static/5] 00:13:45
                       > to 192.168.130.1 via ge-0/0/2.0
   192.168.190.254/32 *[Static/5] 00:17:00
                       > to 192.168.130.1 via ge-0/0/2.0
   192.168.191.0/24   *[Static/5] 00:13:45
                       > to 192.168.133.1 via ge-0/0/3.0
   192.168.191.254/32 *[Static/5] 00:17:45
                       > to 192.168.133.1 via ge-0/0/3.0
   192.168.210.1/32   *[Static/5] 00:17:36
                         via st0.4000
                       > via st0.4001
   192.168.210.4/32   *[Direct/0] 00:18:04
                       > via lo0.0
   
   inet.3: 7 destinations, 11 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.152.0.32/32     *[Static/5] 00:11:20
                       > via gr-0/0/0.4000
                       [Static/8] 00:11:20
                       > via gr-0/0/0.4001
   10.152.0.34/32     *[Static/5] 00:11:20
                       > via gr-0/0/0.4001
                       [Static/8] 00:11:20
                       > via gr-0/0/0.4000
   10.192.0.8/32      *[Static/5] 00:11:20
                       > via gr-0/0/0.4001
                       [Static/8] 00:11:20
                       > via gr-0/0/0.4000
   10.192.0.9/32      *[Static/5] 00:11:20
                       > via gr-0/0/0.4000
                       [Static/8] 00:11:20
                       > via gr-0/0/0.4001
   10.192.0.10/32     *[Static/5] 00:11:20
                       > via gr-0/0/0.4000
                         via gr-0/0/0.4001
   192.168.0.1/32     *[Static/9] 00:11:20, metric2 0
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4001
   192.168.210.1/32   *[Static/12] 00:11:20
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4001
   
   transit.inet.0: 17 destinations, 17 routes (17 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.10.0.0/24       *[Direct/0] 00:15:03
                       > via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/6.0
   10.144.0.32/31     *[Direct/0] 00:11:20
                       > via st0.4002
   10.144.0.33/32     *[Local/0] 00:13:45
                         Local via st0.4002
   10.144.0.34/31     *[Direct/0] 00:11:20
                       > via st0.4003
   10.144.0.35/32     *[Local/0] 00:13:45
                         Local via st0.4003
   10.152.0.32/31     *[Direct/0] 00:11:20
                       > via gr-0/0/0.4000
   10.152.0.33/32     *[Local/0] 00:13:45
                         Local via gr-0/0/0.4000
   10.152.0.34/31     *[Direct/0] 00:11:20
                       > via gr-0/0/0.4001
   10.152.0.35/32     *[Local/0] 00:13:45
                         Local via gr-0/0/0.4001
   10.176.0.32/31     *[Direct/0] 00:15:03
                       > via st0.4000
   10.176.0.34/31     *[Direct/0] 00:15:03
                       > via st0.4001
   192.168.130.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/3.0
   192.168.210.4/32   *[Direct/0] 00:15:03
                       > via lo0.0
   
   transit.inet.3: 7 destinations, 11 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.152.0.32/32     *[Static/5] 00:11:20
                       > via gr-0/0/0.4000
                       [Static/8] 00:11:20
                       > via gr-0/0/0.4001
   10.152.0.34/32     *[Static/5] 00:11:20
                       > via gr-0/0/0.4001
                       [Static/8] 00:11:20
                       > via gr-0/0/0.4000
   10.192.0.8/32      *[Static/5] 00:11:20
                       > via gr-0/0/0.4001
                       [Static/8] 00:11:20
                       > via gr-0/0/0.4000
   10.192.0.9/32      *[Static/5] 00:11:20
                       > via gr-0/0/0.4000
                       [Static/8] 00:11:20
                       > via gr-0/0/0.4001
   10.192.0.10/32     *[Static/5] 00:11:20
                       > via gr-0/0/0.4000
                         via gr-0/0/0.4001
   192.168.0.1/32     *[Static/9] 00:13:45, metric2 0
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4001
   192.168.210.1/32   *[Static/12] 00:11:20
                         via gr-0/0/0.4000
                       > via gr-0/0/0.4001
   
   default-local-breakout.inet.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.10.0.0/24       *[Direct/0] 00:15:03
                       > via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/6.0
   10.176.0.32/31     *[Direct/0] 00:15:03
                       > via st0.4000
   10.176.0.34/31     *[Direct/0] 00:15:03
                       > via st0.4001
   192.168.130.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/3.0
   192.168.210.4/32   *[Direct/0] 00:15:03
                       > via lo0.0
   
   mpls-local-breakout.inet.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.10.0.0/24       *[Direct/0] 00:15:03
                       > via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/6.0
   10.176.0.32/31     *[Direct/0] 00:15:03
                       > via st0.4000
   10.176.0.34/31     *[Direct/0] 00:15:03
                       > via st0.4001
   192.168.130.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/3.0
   192.168.210.4/32   *[Direct/0] 00:15:03
                       > via lo0.0
   
   internet-local-breakout.inet.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.10.0.0/24       *[Direct/0] 00:15:03
                       > via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/6.0
   10.176.0.32/31     *[Direct/0] 00:15:03
                       > via st0.4000
   10.176.0.34/31     *[Direct/0] 00:15:03
                       > via st0.4001
   192.168.130.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/3.0
   192.168.210.4/32   *[Direct/0] 00:15:03
                       > via lo0.0
   
   default-cloud-breakout.inet.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.10.0.0/24       *[Direct/0] 00:15:03
                       > via ge-0/0/4.0
   10.10.10.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/1.0
   10.10.12.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/5.0
   10.10.13.0/24      *[Direct/0] 00:15:03
                       > via ge-0/0/6.0
   10.176.0.32/31     *[Direct/0] 00:15:03
                       > via st0.4000
   10.176.0.34/31     *[Direct/0] 00:15:03
                       > via st0.4001
   192.168.130.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/2.0
   192.168.133.0/24   *[Direct/0] 00:15:03
                       > via ge-0/0/3.0
   192.168.210.4/32   *[Direct/0] 00:15:03
                       > via lo0.0
   
   probe-VR.inet.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   172.31.31.14/32    *[Direct/0] 00:15:02
                       > via lo0.300
   
   LAN-realtimetenant_DefaultVPN.inet.0: 3 destinations, 3 routes (3 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:11:20, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4001, Push 16
   10.66.66.0/24      *[Direct/0] 00:13:45
                       > via ge-0/0/4.1066
   10.66.66.1/32      *[Local/0] 00:13:45
                         Local via ge-0/0/4.1066
   
   mpls-realtimetenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:11:20, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 21
                       [Static/175] 00:13:45
                         to table Default-realtimetenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:13:45
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   internet-realtimetenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:11:20, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 19
                       [Static/175] 00:13:45
                         to table Default-realtimetenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Static/5] 00:13:45
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   default-lbo-realtimetenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:13:45
                         to table Default-realtimetenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Direct/0] 00:13:45
                       > via ge-0/0/4.1066
   
   mpls-lbo-realtimetenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:13:45
                         to table default-lbo-realtimetenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Direct/0] 00:13:45
                       > via ge-0/0/4.1066
   
   internet-lbo-realtimetenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:13:45
                         to table default-lbo-realtimetenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Direct/0] 00:13:45
                       > via ge-0/0/4.1066
   
   default-cbo-realtimetenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:13:45
                         to table Default-realtimetenant_DefaultVPN.inet.0
   10.66.66.0/24      *[Direct/0] 00:13:45
                       > via ge-0/0/4.1066
   
   natVR-realtimetenant_DefaultVPN.inet.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:13:45
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   Default-realtimetenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:11:20, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4001, Push 16
   10.66.66.0/24      *[Static/5] 00:13:45
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   Default-reverse-realtimetenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:11:20, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 18
                         via gr-0/0/0.4001, Push 18
   10.66.66.0/24      *[Static/5] 00:13:45
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   mpls.0: 14 destinations, 14 routes (14 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   16                 *[VPN/0] 00:13:45
                         to table Default-realtimetenant_DefaultVPN.inet.0, Pop    
   17                 *[VPN/0] 00:13:45
                         to table Default-reverse-realtimetenant_DefaultVPN.inet.0, Pop
   18                 *[VPN/0] 00:13:45
                         to table LAN-realtimetenant_DefaultVPN.inet.0, Pop
   19                 *[VPN/0] 00:13:45
                         to table internet-realtimetenant_DefaultVPN.inet.0, Pop   
   20                 *[VPN/0] 00:13:45
                         to table mpls-realtimetenant_DefaultVPN.inet.0, Pop
   299776             *[VPN/170] 00:14:51
                       > via st0.4000, Pop
   299792             *[VPN/170] 00:14:51
                       > via st0.4001, Pop
   299808             *[VPN/170] 00:14:51
                         receive table transit.inet.0, Pop
   299888             *[VPN/170] 00:11:20
                       > via st0.4003, Pop
   299904             *[VPN/170] 00:11:20
                       > via gr-0/0/0.4001, Pop
   299904(S=0)        *[VPN/170] 00:11:20
                       > via gr-0/0/0.4001, Pop
   299920             *[VPN/170] 00:11:20
                       > via st0.4002, Pop
   299936             *[VPN/170] 00:11:20
                       > via gr-0/0/0.4000, Pop
   299936(S=0)        *[VPN/170] 00:11:20
                       > via gr-0/0/0.4000, Pop
   
   transit.mpls.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0                  *[MPLS/0] 00:13:45, metric 1
                         Receive
   1                  *[MPLS/0] 00:13:45, metric 1
                         Receive
   2                  *[MPLS/0] 00:13:45, metric 1
                         Receive
   13                 *[MPLS/0] 00:13:45, metric 1
                         Receive
   
   bgp.l3vpn.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   239.1.0.2:24:0.0.0.0/0
                      *[BGP/170] 00:12:33, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4001, Push 16
   239.1.0.2:36:0.0.0.0/0
                      *[BGP/170] 00:12:33, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 21
   239.1.0.2:37:0.0.0.0/0
                      *[BGP/170] 00:12:33, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 19
   192.168.210.1:25:0.0.0.0/0
                      *[BGP/170] 00:12:33, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 18
                         via gr-0/0/0.4001, Push 18
   
   root@GWR.sdwansite2.realtimetenant>
   

Test case execution demonstrating realtime failovers
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Now let’s prepare our environment with some SLA’s we can check and failover to.

BEFORE you can use any SD-WAN Profiles the SP-Admin has to activate at least one! With a default CSO installation NONE is ACTIVATED and you would get an error message like below:

|image630|

If you have not done this as it is needed in other testcases please do the following else ignore it.

Change to the “Global” view

|image631|

Go to Configuration -> Application Traffic Type Profiles -> Select one Profile (Internet)

.. note:: You can’t enable all profiles at the same time because of overlapping config.

|image632|

Edit the profile

|image633|

Change the status to Enable (blue) and press “OK”

|image634|

Do this as well with the voice-video profile.

|image635|

You need to have at least one enabled profile!

Now go back to your Tenant

|image636|

Add a new SLA-Profile

|image637|

|image638|

Now fill in the exact same parameters as you see below. For testing we use:

RTT=100ms

SLA-violation-counts=1 (so a flip would happen at the first violation already)

Sampleing-period=2 (most aggressive setting)

Switch-cool-off-period=120s (default cool-off time)

|image639|

Now you craft an SD-WAN Policy (we use CNN and SSH)

|image640|

|image641|

Do not forget to deploy the Rule else it won’t take place.

|image642|

Check that your Policy has been applied

|image643|

Now use the Desktop2/4 VM to generate traffic to CCN and start some videos so that they consume bandwith

|image644|

Next is to also use Desktop2/4 VM to open an ssh-session (use 192.168.10.10 or else)

|image645|

Start the command “watch –n 0.5 date” onto the host you are logged in as it will always generate some traffic.

Now use ssh to the Spoke via it’s Loop-back 192.168.210.3/4 (root/Embe1mpls).

In our example it happens that the SSH uses a different link then CCN but that is of because we have not set a preference.

.. code-block:: none

   root@GWR.sdwansite2.realtimetenant> show security flow session dynamic-application junos:SSH
   Session ID: 1938, Policy name: Intent_1/8, Timeout: 1800, Valid
     In: 10.66.66.66/38088 --> 192.168.10.10/22;tcp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 317, Bytes: 19412,
     Out: 192.168.10.10/22 --> 10.66.66.66/38088;tcp, Conn Tag: 0x0, If: gr-0/0/0.4001, Pkts: 299, Bytes: 34587,
   Total sessions: 1

   root@GWR.sdwansite2.realtimetenant> show security flow session dynamic-application junos:CNN
   Session ID: 1301, Policy name: Intent_1/8, Timeout: 1756, Valid
     In: 10.66.66.66/44464 --> 23.64.128.102/443;tcp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 686, Bytes: 57875,
     Out: 23.64.128.102/443 --> 10.66.66.66/44464;tcp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 1181, Bytes: 1317923,

   Session ID: 1824, Policy name: Intent_1/8, Timeout: 1794, Valid
     In: 10.66.66.66/47084 --> 23.205.220.82/443;tcp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 55404, Bytes: 2964152,
     Out: 23.205.220.82/443 --> 10.66.66.66/47084;tcp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 115961, Bytes: 140460611,

   Session ID: 2022, Policy name: Intent_1/8, Timeout: 1794, Valid
     In: 10.66.66.66/32856 --> 154.57.158.72/443;tcp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 125, Bytes: 56535,
     Out: 154.57.158.72/443 --> 10.66.66.66/32856;tcp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 109, Bytes: 26687,
   Total sessions: 3

   root@GWR.sdwansite2.realtimetenant> show interfaces terse | match gr-
   gr-0/0/0                up    up
   gr-0/0/0.4000           up    up   inet     172.26.55.32/31
   gr-0/0/0.4001           up    up   inet     172.18.123.238/31

Use the commad below to evaluate the status of the links before you make them “bad”

.. code-block:: none

   show security advance-policy-based-routing sla profile pr_apbr_Default status application junos:CNN destination-group-name hub1
   Application status:
     Num of SLA Violations       0
     Num of Path Switches        1
     Num of monitored sessions   1
     Num of sessions             7

   show security advance-policy-based-routing sla profile pr_apbr_Default status application junos:SSH destination-group-name hub1
   Application status:
     Num of SLA Violations       0
     Num of Path Switches        1
     Num of monitored sessions   1
     Num of sessions             1

   show security advance-policy-based-routing sla active-probe-statistics active-probe-params-name VOICE-VIDEO
   Active Probe Statistics:
     Src-IP          Dst-IP          PKT-LOSS(%)     RTT(us)         2way-Jit(us)    Ing-Jit(us)     Egr-Jit(us)
     172.18.123.238  172.18.123.239  0               825             0               1               9
     172.26.55.32    172.26.55.33    0               789             0               3               4

Now login to the Delay-VM and add a Traffic class delay command to the appropriate link toward the hub which (review Chapter 3.2.13 above for more details).

-  To make WAN_0 “bad” use eth0.132
-  To make WAN_1 “bad” use eth0.135

Change the command below if you need:

.. code-block:: none

   virsh console delayvm --force
   Connected to domain delayvm
   Escape character is ^]

   # you can review the traffic on the link (here from two spokes)
   root@delayvm:~# tcpdump -n -i eth0.135
   tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
   listening on eth0.135, link-type EN10MB (Ethernet), capture size 262144 bytes
   16:50:27.524771 IP 192.168.133.102.4500 > 192.168.191.254.4500: UDP-encap: ESP(spi=0xd978ce54,seq=0x56cc), length 148
   16:50:27.526551 IP 192.168.191.254.4500 > 192.168.133.102.4500: UDP-encap: ESP(spi=0xa2d47e4d,seq=0xf547), length 148
   16:50:27.727512 IP 192.168.191.254 > 192.168.173.2: ESP(spi=0x32149487,seq=0x980), length 116
   16:50:27.729576 IP 192.168.173.2 > 192.168.191.254: ESP(spi=0x7dfac7eb,seq=0x989), length 92
   16:50:27.775701 IP 192.168.133.102.4500 > 192.168.191.254.4500: UDP-encap: ESP(spi=0xd978ce54,seq=0x56cd), length 116
   16:50:27.776710 IP 192.168.191.254.4500 > 192.168.133.102.4500: UDP-encap: ESP(spi=0xa2d47e4d,seq=0xf548), length 92
   16:50:27.880264 IP 192.168.173.2 > 192.168.191.254: ESP(spi=0x7dfac7eb,seq=0x98a), length 148
   16:50:27.881829 IP 192.168.191.254 > 192.168.173.2: ESP(spi=0x32149487,seq=0x981), length 148
   16:50:27.887452 IP 192.168.191.254.4500 > 192.168.133.102.4500: UDP-encap: ESP(spi=0xa2d47e4d,seq=0xf549), length 116

   root@delayvm:~# tc qdisc add dev eth0.135 root netem delay 100ms

Now go immediately (because the fail-over happens so quickly now) back to the shell with the device and review the stats again. In our example ssh has been switch from using gr-0/0/0.4001 to gr-0/0/0.4000 and an the number of path-switches is +1 now.

.. code-block:: none

   show security advance-policy-based-routing sla active-probe-statistics active-probe-params-name VOICE-VIDEO
   Active Probe Statistics:
     Src-IP          Dst-IP          PKT-LOSS(%)     RTT(us)         2way-Jit(us)    Ing-Jit(us)     Egr-Jit(us)
     172.18.123.238  172.18.123.239  0               101108          0               7               10
     172.26.55.32    172.26.55.33    0               872             0               2               7
   
   show security advance-policy-based-routing sla profile pr_apbr_Default status application junos:SSH destination-group-name hub1
   Application status:
     Num of SLA Violations       14
     Num of Path Switches        2
     Num of monitored sessions   1
     Num of sessions             1

   show security advance-policy-based-routing sla profile pr_apbr_Default status application junos:CNN destination-group-name hub1
   Application status:
     Num of SLA Violations       0
     Num of Path Switches        1
     Num of monitored sessions   1
     Num of sessions             3

   show security flow session dynamic-application junos:SSH
   Session ID: 1938, Policy name: Intent_1/8, Timeout: 1800, Valid
     In: 10.66.66.66/38088 --> 192.168.10.10/22;tcp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1380, Bytes: 74688,
     Out: 192.168.10.10/22 --> 10.66.66.66/38088;tcp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 1362, Bytes: 153611,
   Total sessions: 1

   show security flow session dynamic-application junos:CNN
   Session ID: 1301, Policy name: Intent_1/8, Timeout: 1760, Valid
     In: 10.66.66.66/44464 --> 23.64.128.102/443;tcp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 906, Bytes: 73860,
     Out: 23.64.128.102/443 --> 10.66.66.66/44464;tcp, Conn Tag: 0x0, If: gr-0/0/0.4000, Pkts: 1427, Bytes: 1565961,

If you go into the GUI (at least after 2minutes) you should see the switch reported.

|image646|

Before you leave the scene go again to the delayVM and remove the latency configuration

.. code-block:: none

   root@delayvm:~# tc qdisc del dev eth0.135 root netem

Should you try to trigger new events remember that we have configured a guard time of 2minutes before new switches would take place.

You will find more commands to use and background information via this URL:

https://www.juniper.net/documentation/en_US/junos/topics/topic-map/security-appqoe-nfx-series.html

Full Mesh with Local-Breakout
-----------------------------

.. warning:: This lab has no separate Automation configuration as it’s based on the SD-WAN BASIC Scenario. Apply that at you should be good to go.

There are many scenarios to implement mesh networks. We have developed two scenarios with this Reference Architecture that you can easily demonstrate. Starting with CSO V4.1 however this becomes a very powerfull feature with the abliltiy to create the Tunnels Dynamically and the invention of Mesh-Tags that allow you to finetune the connctions between the Spokes that are meshed.

In this Chapter we will use Local Breakout at the Spoke to avoid Application Traffic going towards the Hub. In the next chapter we’ll introduce the new Site GW (which can be called Enterprise/On-Premise Hub if you will) function but for this you need to re-install all Spokes again.

.. warning:: The second scenario that follows this chapter uses the SAME infrastructure and just adds the new Site-Gateway. So even if you jump to the next chapter you should execute the setup steps of this chapter first.

.. note:: That the way this lab is build you can’t cause any lantency, jitter or packt-loss to test sd-wan SLA’s as such. The delay VM in only active between Hub and Spoke but not between the Spokes themselves. You can only interrupt a certain interface of a device simulating an outage. If you want to test sdwan SLA failover behaviour then use the Real-Time optimized Lab that is part of chapter 7.6 above.

.. warning:: In all Mesh scenarious there is minimum one Hub to be used! This is for the case that two Spoke have Interface behind NAT and can not make a direct connection. In this case the Hub is used as a relay for the Spoke to Spoke traffic. (below it’s called an SDWAN Backup Gateway)

|image647|

Add underlay support for third Spoke Device
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. If you have applied the changes from executing the “Reset QFX to SD-WAN BASIC” then you can ignore this section.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

To present an critical impact we will use all possible THREE Spoke devices of the reference lab for this demonstration.

.. code-block:: none

   
   delete interfaces xe-0/0/28
   delete protocols rstp interface xe-0/0/28
   set groups sdwan-basic interfaces xe-0/0/28 unit 0 family inet address 192.168.150.1/24
   set groups sdwan-basic routing-instances spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet network 192.168.150.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet range spoke-wan0-nfx2-pool-range low 192.168.150.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet range spoke-wan0-nfx2-pool-range high 192.168.150.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx2-pool family inet dhcp-attributes router 192.168.150.1
   
   delete interfaces xe-0/0/29
   delete protocols rstp interface xe-0/0/29
   set groups sdwan-basic interfaces xe-0/0/29 unit 0 family inet address 192.168.153.1/24
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/29.0
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet network 192.168.153.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet range spoke-wan1-nfx2-pool-range low 192.168.153.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet range spoke-wan1-nfx2-pool-range high 192.168.153.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx2-pool family inet dhcp-attributes router 192.168.153.1
   
   # route for the Spoke LAN’s to go to Internet
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.77.77.0/24 next-hop 192.168.191.254
   
   set groups sdwan-basic vlans desktop3 vlan-id 1077
   
   delete interface xe-0/0/26
   delete protocols rstp interface xe-0/0/26
   delete groups sdwan-basic interfaces xe-0/0/26 unit 0
   set groups sdwan-basic interfaces xe-0/0/26 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-basic interfaces xe-0/0/26 unit 0 family ethernet-switching vlan members 1077
   
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1077

   # also make sure the other interfaces towards NFX2 unused in this demo are disabled
   delete interfaces xe-0/0/26 disable
   delete interfaces xe-0/0/28 disable
   delete interfaces xe-0/0/29 disable
   set interfaces xe-0/0/27 disable
   set interfaces xe-0/0/30 disable
   set interfaces xe-0/0/31 disable
   
   # You also need to change vlan 1077 that is usually used for uCPE and
   # points to the MX80 as GW 10.77.77.1 which now will be the nfx250-2 
   delete interfaces xe-0/0/15 unit 0 family ethernet-switching vlan members 1077
   set interfaces xe-0/0/26 unit 0 family ethernet-switching vlan members 1077
   

.. warning:: You also need to change the static route entry at the natvm as 10.77.77.0/24 with desktop3 is usually used and preconfigured for uCPE! Do not forget this!

.. code-block:: none

   ssh root@192.168.10.1 (juniper123)
   cli
   edit
   delete routing-options static route 10.77.77.0/24 next-hop 192.168.74.254
   set routing-options static route 10.77.77.0/24 next-hop 192.168.70.254
   commit

Create cloud-hub1
~~~~~~~~~~~~~~~~~

Follow the procedure in chaper 6.1 above to create POP, modifiy device template and on-board the SRX1500 to be your hub. In a real-live scenario you need an OAM and a Data Hub (here combined in one system) for the following two purposes

#. Secure OAM management towards the CSO instance (obvious with CSO >= 4.0)
#. In the Picture above you see a so called “SDWAN Backup Gateway”. This is nothing more then a Data Hub for the case that both endpoints of two Spoke are behind NAT and can not connect directly in the nominal case. Instead this Hub (that has to have a Public IP reachable for both devices) is used then to relay the traffic for these devices. Not optimal but no outher choices until new features, targeted atm for CSO V5.0, become avail.

Make sure that the “hub1” is provisioned and come back to follow the next section.

(optional) Create Realtime Tenant
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In case you have executed chapter 7.6 above the realtime Tenant should already be existing and doesn’t need to be re-created. If the realtime tenant object is NOT in the system then please review chapter 7.6.1 above6.2 above and come back after you have executed everything in it.

.. _onboard-hub-to-tenant-1:

Onboard Hub to Tenant
~~~~~~~~~~~~~~~~~~~~~

In case you have executed chapter 7.6 above the realtime Tenant should already have the hub1 object. If the realtime tenant has no hub1 object still then please review chapter 7.6.2 above and come back after you have executed everything in it.

Add the three Spoke Devices
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Before you start provisioning your Spoke make sure that:

-  A cloudhub is created
-  The realtime-tenant is created
-  The hub-object is included in the realtime-tenant

You should see a picture similar to the below now:

|image648|

.. warning:: In difference to the previous CSO Versions, starting with V4.1 you can provison all Spokes at the same time and do not need to wait until one is ready before you can issue the next spoke.This will speed up the time to create your Testcase.

Before you start review that you have the two default Mesh Tags in place that we want to use as well:

|image649|

Then ADD a new local-breakout Profile

|image650|

|image651|

|image652|

For all three Spokes the same creation happen (with breakout enabled towards Internet). Below we only show the first spoke. This is very similar to chapter 7.1 above.

|image653|

|image654|

We do NOT enable Local Breakout on the MPLS interface of all Spokes

|image655|

We do ENABLE Local Breakout on the Internet interface of all Spokes however

|image656|

|image657|

|image658|

Here are the three JSON Files of all Spoke to repeat this easly

Sdwansite1 w. SRX3xx and Desktop2

.. hidden-code-block:: none

   
   {
      "input":{
         "tenant_name":"realtimetenant",
         "deployment_scenario":"managed_wan_v2",
         "site":[
            {
               "site_name":"sdwansite1",
               "site_basic_properties":{
                  "0":{
                     "dhcp":false,
                     "department":"Default",
                     "lan_ports":[
                        "LAN_4"
                     ],
                     "lan_segment_name":"desktop2",
                     "vlan":1088,
                     "ip_prefix":"10.88.88.1/24"
                  },
                  "topology":"Real-Time Optimized",
                  "sla_mgmt":"FINE",
                  "network_seg":false,
                  "gatewaySite":false,
                  "site_role":"SPOKE",
                  "site_address":{
                     "country":"US"
                  },
                  "site_group":null,
                  "site_name":"sdwansite1",
                  "device_redundancy":false,
                  "device_profile_name":"SRX as SD-WAN CPE",
                  "cloud_service":"EDGE",
                  "site_type":"on_premise",
                  "dvpn_params":{
                     "create_dvpn_threshold":5,
                     "delete_dvpn_threshold":2
                  },
                  "device_template":[
                     {
                        "template_name":"SRX_Advanced_SDWAN_CPE_option_1",
                        "device_name":"sdwansite1",
                        "wan_link_info":[
                           {
                              "wan_link":"WAN_0",
                              "wan_link_type":"MPLS",
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"abc",
                              "cost":2222,
                              "_sys_reserved_row":"1533bd4e-514b-a7d4-b0eb-d3dd24c5a23c",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           },
                           {
                              "wan_link":"WAN_1",
                              "wan_link_type":"Internet",
                              "cost_currency":"USD",
                              "local_breakout_enabled":true,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"xyz",
                              "cost":111,
                              "_sys_reserved_row":"65056c3f-ba09-7ca2-7f14-538cc1222fbd",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":true
                           }
                        ],
                        "lan_segment":[
                           {
                              "dhcp":false,
                              "department":"Default",
                              "lan_ports":[
                                 "LAN_4"
                              ],
                              "lan_segment_name":"desktop2",
                              "vlan":1088,
                              "ip_prefix":"10.88.88.1/24"
                           }
                        ]
                     }
                  ]
               }
            }
         ]
      }
   }
   

Sdwansite2 w. NFX250 and Desktop4

.. hidden-code-block:: none

   
   {
      "input":{
         "tenant_name":"realtimetenant",
         "deployment_scenario":"managed_wan_v2",
         "site":[
            {
               "site_name":"sdwansite2",
               "site_basic_properties":{
                  "0":{
                     "dhcp":false,
                     "department":"Default",
                     "lan_ports":[
                        "LAN_0"
                     ],
                     "lan_segment_name":"desktop4",
                     "vlan":1066,
                     "ip_prefix":"10.66.66.1/24"
                  },
                  "topology":"Real-Time Optimized",
                  "sla_mgmt":"FINE",
                  "network_seg":false,
                  "gatewaySite":false,
                  "site_role":"SPOKE",
                  "site_address":{
                     "country":"US"
                  },
                  "site_group":null,
                  "site_name":"sdwansite2",
                  "device_redundancy":false,
                  "device_profile_name":"NFX250 as SD-WAN CPE",
                  "cloud_service":"EDGE",
                  "site_type":"on_premise",
                  "dvpn_params":{
                     "create_dvpn_threshold":5,
                     "delete_dvpn_threshold":2
                  },
                  "device_template":[
                     {
                        "template_name":"NFX_Advanced_SDWAN_CPE_option_1",
                        "device_name":"sdwansite2",
                        "wan_link_info":[
                           {
                              "wan_link":"WAN_0",
                              "wan_link_type":"MPLS",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"abc",
                              "cost":2222,
                              "_sys_reserved_row":"f01b267d-33e4-901e-75e8-d2067a9d5e54",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           },
                           {
                              "wan_link":"WAN_1",
                              "wan_link_type":"Internet",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":true,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"xyz",
                              "cost":111,
                              "_sys_reserved_row":"2041fb73-c3bf-3f69-3b16-7d6ac6004848",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":true
                           }
                        ],
                        "lan_segment":[
                           {
                              "dhcp":false,
                              "department":"Default",
                              "lan_ports":[
                                 "LAN_0"
                              ],
                              "lan_segment_name":"desktop4",
                              "vlan":1066,
                              "ip_prefix":"10.66.66.1/24"
                           }
                        ]
                     }
                  ]
               }
            }
         ]
      }
   }
   

Sdwansite3 w. NFX250 and Desktop3

.. hidden-code-block:: none

   
   {
      "input":{
         "tenant_name":"realtimetenant",
         "deployment_scenario":"managed_wan_v2",
         "site":[
            {
               "site_name":"sdwansite3",
               "site_basic_properties":{
                  "0":{
                     "dhcp":false,
                     "department":"Default",
                     "lan_ports":[
                        "LAN_0"
                     ],
                     "lan_segment_name":"desktop3",
                     "vlan":1077,
                     "ip_prefix":"10.77.77.1/24"
                  },
                  "topology":"Real-Time Optimized",
                  "sla_mgmt":"FINE",
                  "network_seg":false,
                  "gatewaySite":false,
                  "site_role":"SPOKE",
                  "site_address":{
                     "country":"US"
                  },
                  "site_group":null,
                  "site_name":"sdwansite3",
                  "device_redundancy":false,
                  "device_profile_name":"NFX250 as SD-WAN CPE",
                  "cloud_service":"EDGE",
                  "site_type":"on_premise",
                  "dvpn_params":{
                     "create_dvpn_threshold":5,
                     "delete_dvpn_threshold":2
                  },
                  "device_template":[
                     {
                        "template_name":"NFX_Advanced_SDWAN_CPE_option_1",
                        "device_name":"sdwansite3",
                        "wan_link_info":[
                           {
                              "wan_link":"WAN_0",
                              "wan_link_type":"MPLS",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"abc",
                              "cost":2222,
                              "_sys_reserved_row":"4d10a7b3-25fd-adb8-91dc-c52401a11e22",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           },
                           {
                              "wan_link":"WAN_1",
                              "wan_link_type":"Internet",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":true,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"xyz",
                              "cost":111,
                              "_sys_reserved_row":"43580103-6006-3553-1633-b55813399555",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":true
                           }
                        ],
                        "lan_segment":[
                           {
                              "dhcp":false,
                              "department":"Default",
                              "lan_ports":[
                                 "LAN_0"
                              ],
                              "lan_segment_name":"desktop3",
                              "vlan":1077,
                              "ip_prefix":"10.77.77.1/24"
                           }
                        ]
                     }
                  ]
               }
            }
         ]
      }
   }
   

You should see now the following

|image659|

Now we continue to configure all Spokes (Auto-NAT will also be enabled for Breakout) and provision them. Below we also only show this for the first Spoke.

|image660|

|image661|

|image662|

|image663|

|image664|

|image665|

|image666|

|image667|

JSON of sdwansite1

.. hidden-code-block:: none

   
   {
      "input":{
         "job_name_prefix":"realtimetenant-sdwansite1",
         "tenant_name":"realtimetenant",
         "site":[
            {
               "site_name":"sdwansite1",
               "on_premise_site_info":{
                  "site_role":"spoke",
                  "ha_info":{
                     "ha_topology":"STANDALONE"
                  },
                  "device":[
                     {
                        "is_gateway_site":false,
                        "device_family":"juniper-srx",
                        "wan_link":[
                           {
                              "wan_link_name":"WAN_0",
                              "local_interface":"ge-0/0/0",
                              "wan_link_type":"MPLS",
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "MPLS"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_0",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.190.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.170.2/24",
                                 "gateway_ip":"192.168.170.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           },
                           {
                              "wan_link_name":"WAN_1",
                              "local_interface":"ge-0/0/1",
                              "wan_link_type":"Internet",
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "INTERNET"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "local_breakout_enabled":true,
                              "nat_info":{
                                 "nat_enabled":true
                              },
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_1",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.191.1"
                                    }
                                 }
                              ],
                              "static_ip_assignment":{
                                 "ip_address":"192.168.173.2/24",
                                 "gateway_ip":"192.168.173.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           }
                        ],
                        "oam_traffic":{
                           "ip_prefix":"192.168.210.3/32"
                        },
                        "device_details":{
                           "serial_number":"CV2116AF0288"
                        },
                        "device_name":"sdwansite1",
                        "device_template":"SRX_Advanced_SDWAN_CPE_option_1"
                     }
                  ],
                  "hub_sites":[
                     {
                        "hub_role":"PRIMARY",
                        "hub_name":"hub1"
                     }
                  ]
               },
               "properties":{
                  "property":[
                     {
                        "name":"site_advanced_config",
                        "value":{
                           "nameserver":[
                              "8.8.8.8"
                           ],
                           "timezone":"Europe/Amsterdam"
                        }
                     }
                  ]
               }
            }
         ]
      }
   }
   

JSON of sdwansite2

.. hidden-code-block:: none

   
   {
      "input":{
         "job_name_prefix":"realtimetenant-sdwansite2",
         "tenant_name":"realtimetenant",
         "site":[
            {
               "site_name":"sdwansite2",
               "on_premise_site_info":{
                  "site_role":"spoke",
                  "ha_info":{
                     "ha_topology":"STANDALONE"
                  },
                  "device":[
                     {
                        "is_gateway_site":false,
                        "wan_link":[
                           {
                              "wan_link_name":"WAN_0",
                              "local_interface":"ge-0/0/10",
                              "wan_link_type":"MPLS",
                              "enable_pppoe":false,
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "MPLS"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "access_type":"Ethernet",
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_0",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.190.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.130.2/24",
                                 "gateway_ip":"192.168.130.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"OAM_AND_DATA"
                           },
                           {
                              "wan_link_name":"WAN_1",
                              "local_interface":"ge-0/0/11",
                              "wan_link_type":"Internet",
                              "enable_pppoe":false,
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "INTERNET"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "access_type":"Ethernet",
                              "local_breakout_enabled":true,
                              "nat_info":{
                                 "nat_enabled":true
                              },
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_1",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.191.1"
                                    }
                                 }
                              ],
                              "static_ip_assignment":{
                                 "ip_address":"192.168.133.2/24",
                                 "gateway_ip":"192.168.133.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           }
                        ],
                        "oam_traffic":{
                           "ip_prefix":"192.168.210.4/32"
                        },
                        "device_details":{
                           "serial_number":"DD2116AF0059"
                        },
                        "device_name":"sdwansite2",
                        "device_template":"NFX_Advanced_SDWAN_CPE_option_1"
                     }
                  ],
                  "hub_sites":[
                     {
                        "hub_role":"PRIMARY",
                        "hub_name":"hub1"
                     }
                  ]
               },
               "properties":{
                  "property":[
                     {
                        "name":"site_advanced_config",
                        "value":{
                           "nameserver":[
                              "8.8.8.8"
                           ],
                           "timezone":"Europe/Amsterdam"
                        }
                     }
                  ]
               }
            }
         ]
      }
   }
   

JSON of sdwansite3

.. hidden-code-block:: none

   
   {
      "input":{
         "job_name_prefix":"realtimetenant-sdwansite3",
         "tenant_name":"realtimetenant",
         "site":[
            {
               "site_name":"sdwansite3",
               "on_premise_site_info":{
                  "site_role":"spoke",
                  "ha_info":{
                     "ha_topology":"STANDALONE"
                  },
                  "device":[
                     {
                        "is_gateway_site":false,
                        "wan_link":[
                           {
                              "wan_link_name":"WAN_0",
                              "local_interface":"ge-0/0/10",
                              "wan_link_type":"MPLS",
                              "enable_pppoe":false,
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "MPLS"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "access_type":"Ethernet",
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_0",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.190.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.150.2/24",
                                 "gateway_ip":"192.168.150.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"OAM_AND_DATA"
                           },
                           {
                              "wan_link_name":"WAN_1",
                              "local_interface":"ge-0/0/11",
                              "wan_link_type":"Internet",
                              "enable_pppoe":false,
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "INTERNET"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "access_type":"Ethernet",
                              "local_breakout_enabled":true,
                              "nat_info":{
                                 "nat_enabled":true
                              },
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_1",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.191.1"
                                    }
                                 }
                              ],
                              "static_ip_assignment":{
                                 "ip_address":"192.168.153.2/24",
                                 "gateway_ip":"192.168.153.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           }
                        ],
                        "oam_traffic":{
                           "ip_prefix":"192.168.210.5/32"
                        },
                        "device_details":{
                           "serial_number":"DD1816AF0024"
                        },
                        "device_name":"sdwansite3",
                        "device_template":"NFX_Advanced_SDWAN_CPE_option_1"
                     }
                  ],
                  "hub_sites":[
                     {
                        "hub_role":"PRIMARY",
                        "hub_name":"hub1"
                     }
                  ]
               },
               "properties":{
                  "property":[
                     {
                        "name":"site_advanced_config",
                        "value":{
                           "nameserver":[
                              "8.8.8.8"
                           ],
                           "timezone":"Europe/Amsterdam"
                        }
                     }
                  ]
               }
            }
         ]
      }
   }
   

When all sites are up it should look like this:

|image668|

And this:

|image669|

(optional) Review and check Mesh configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Here we are on the Hub1 and see the IPsec OAM Tunnel Termination and the Backup Tunnels from each device.

.. code-block:: none

   root@CZ0317AF0302.hub1.default-project> show interfaces terse | match st
   st0                     up    up
   st0.4006                up    up   inet     10.176.0.40/31
   st0.4007                up    up   inet     10.176.0.42/31
   st0.4008                up    up   inet     10.176.0.48/31
   st0.4009                up    up   inet     10.176.0.50/31
   st0.4010                up    up   inet     10.176.0.56/31
   st0.4011                up    up   inet     10.176.0.58/31
   st0.4012                up    up   inet     10.144.0.50/31
   st0.4013                up    up   inet     10.144.0.48/31
   st0.4014                up    up   inet     10.144.0.56/31
   st0.4015                up    up   inet     10.144.0.58/31
   st0.4016                up    up   inet     10.144.0.40/31
   st0.4017                up    up   inet     10.144.0.42/31
    
   root@CZ0317AF0302.hub1.default-project> show interfaces terse | match gr
   gr-0/0/0                up    up
   gr-0/0/0.4002           up    up   inet     10.152.0.48/31
   gr-0/0/0.4003           up    up   inet     10.152.0.50/31
   gr-0/0/0.4004           up    up   inet     10.152.0.56/31
   gr-0/0/0.4005           up    up   inet     10.152.0.58/31
   gr-0/0/0.4006           up    up   inet     10.152.0.42/31
   gr-0/0/0.4007           up    up   inet     10.152.0.40/31
   gre                     up    up 

Here we are on sdwansite1 and review the state

.. code-block:: none

   
   show bgp summary
   Groups: 2 Peers: 2 Down peers: 0
   Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
   inet.0
                          1          1          0          0          0          0
   bgp.l3vpn.0
                         14          6          0          0          0          0
   Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
   192.168.10.49         64512         83         45       0       0       21:08 Establ
     bgp.l3vpn.0: 6/14/14/0
     transit.inet.0: 2/2/2/0
     LAN-realtimetenant_DefaultVPN.inet.0: 3/5/5/0
     mpls-realtimetenant_DefaultVPN.inet.0: 1/3/3/0
     internet-realtimetenant_DefaultVPN.inet.0: 1/3/3/0
     Default-realtimetenant_DefaultVPN.inet.0: 1/3/3/0
     Default-reverse-realtimetenant_DefaultVPN.inet.0: 1/3/3/0
   192.168.210.1         64512         72         74       0       0       32:01 Establ
     inet.0: 1/1/1/0 
   
   show interfaces terse | match st
   st0                     up    up
   st0.4000                up    up   inet     10.176.0.41/31
   st0.4001                up    up   inet     10.176.0.43/31
   st0.4002                up    up   inet     10.144.0.41/31
   st0.4003                up    up   inet     10.144.0.43/31
   
   show interfaces terse | match gr
   gr-0/0/0                up    up
   gr-0/0/0.4001           up    up   inet     10.152.0.41/31
   gr-0/0/0.4002           up    up   inet     10.152.0.43/31
   gre                     up    up
   
   
   show route
   
   inet.0: 18 destinations, 18 routes (18 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:37:01
                         to 192.168.170.1 via ge-0/0/0.0
                       > to 192.168.173.1 via ge-0/0/1.0
   10.176.0.40/31     *[Direct/0] 00:33:40
                       > via st0.4000
   10.176.0.41/32     *[Local/0] 00:33:51
                         Local via st0.4000
   10.176.0.42/31     *[Direct/0] 00:33:40
                       > via st0.4001
   10.176.0.43/32     *[Local/0] 00:33:51
                         Local via st0.4001
   172.31.31.9/32     *[Direct/0] 00:22:42
                       > via lo0.0
   172.31.31.14/32    *[Direct/0] 00:22:42
                       > via lo0.300
   192.168.10.0/24    *[BGP/170] 00:33:31, localpref 200, from 192.168.210.1
                         AS path: 65000 I, validation-state: unverified
                       > via st0.4000
                         via st0.4001
   192.168.170.0/24   *[Direct/0] 00:33:51
                       > via ge-0/0/0.0
   192.168.170.2/32   *[Local/0] 00:33:51
                         Local via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:33:51
                       > via ge-0/0/1.0
   192.168.173.2/32   *[Local/0] 00:33:51
                         Local via ge-0/0/1.0
   192.168.190.0/24   *[Static/5] 00:19:40
                       > to 192.168.170.1 via ge-0/0/0.0
   192.168.190.254/32 *[Static/5] 00:33:51
                       > to 192.168.170.1 via ge-0/0/0.0
   192.168.191.0/24   *[Static/5] 00:19:40
                       > to 192.168.173.1 via ge-0/0/1.0
   192.168.191.254/32 *[Static/5] 00:33:51
                       > to 192.168.173.1 via ge-0/0/1.0
   192.168.210.1/32   *[Static/5] 00:33:40
                       > via st0.4000
                         via st0.4001
   192.168.210.3/32   *[Direct/0] 00:33:51
                       > via lo0.0
   
   inet.3: 7 destinations, 11 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.152.0.40/32     *[Static/5] 00:18:16
                       > via gr-0/0/0.4001
                       [Static/8] 00:18:16
                       > via gr-0/0/0.4002
   10.152.0.42/32     *[Static/5] 00:18:16
                       > via gr-0/0/0.4002
                       [Static/8] 00:18:16
                       > via gr-0/0/0.4001
   10.192.0.8/32      *[Static/5] 00:18:16
                       > via gr-0/0/0.4002
                       [Static/8] 00:18:16
                       > via gr-0/0/0.4001
   10.192.0.9/32      *[Static/5] 00:18:16
                       > via gr-0/0/0.4001
                       [Static/8] 00:18:16
                       > via gr-0/0/0.4002
   10.192.0.10/32     *[Static/5] 00:18:16
                         via gr-0/0/0.4001
                       > via gr-0/0/0.4002
   192.168.0.1/32     *[Static/9] 00:15:58, metric2 0
                         via gr-0/0/0.4001
                       > via gr-0/0/0.4002
   192.168.210.1/32   *[Static/12] 00:18:16
                       > via gr-0/0/0.4001
                         via gr-0/0/0.4002
   
   transit.inet.0: 16 destinations, 16 routes (16 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.66.66.0/24      *[BGP/170] 00:18:16, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18
   10.77.77.0/24      *[BGP/170] 00:18:16, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18
   10.144.0.40/31     *[Direct/0] 00:18:20
                       > via st0.4002
   10.144.0.41/32     *[Local/0] 00:19:40
                         Local via st0.4002
   10.144.0.42/31     *[Direct/0] 00:18:20
                       > via st0.4003
   10.144.0.43/32     *[Local/0] 00:19:40
                         Local via st0.4003
   10.152.0.40/31     *[Direct/0] 00:18:16
                       > via gr-0/0/0.4001
   10.152.0.41/32     *[Local/0] 00:19:40
                         Local via gr-0/0/0.4001
   10.152.0.42/31     *[Direct/0] 00:18:16
                       > via gr-0/0/0.4002
   10.152.0.43/32     *[Local/0] 00:19:40
                         Local via gr-0/0/0.4002
   10.176.0.40/31     *[Direct/0] 00:23:03
                       > via st0.4000
   10.176.0.42/31     *[Direct/0] 00:23:03
                       > via st0.4001
   172.31.31.9/32     *[Direct/0] 00:22:42
                       > via lo0.0
   192.168.170.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/1.0
   192.168.210.3/32   *[Direct/0] 00:23:03
                       > via lo0.0
   
   transit.inet.3: 7 destinations, 11 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.152.0.40/32     *[Static/5] 00:18:16
                       > via gr-0/0/0.4001
                       [Static/8] 00:18:16
                       > via gr-0/0/0.4002
   10.152.0.42/32     *[Static/5] 00:18:16
                       > via gr-0/0/0.4002
                       [Static/8] 00:18:16
                       > via gr-0/0/0.4001
   10.192.0.8/32      *[Static/5] 00:18:16
                       > via gr-0/0/0.4002
                       [Static/8] 00:18:16
                       > via gr-0/0/0.4001
   10.192.0.9/32      *[Static/5] 00:18:16
                       > via gr-0/0/0.4001
                       [Static/8] 00:18:16
                       > via gr-0/0/0.4002
   10.192.0.10/32     *[Static/5] 00:18:16
                         via gr-0/0/0.4001
                       > via gr-0/0/0.4002
   192.168.0.1/32     *[Static/9] 00:19:40, metric2 0
                         via gr-0/0/0.4001
                       > via gr-0/0/0.4002
   192.168.210.1/32   *[Static/12] 00:18:16
                       > via gr-0/0/0.4001
                         via gr-0/0/0.4002
   
   default-local-breakout.inet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:23:03, metric2 0
                       > to 192.168.173.1 via ge-0/0/1.0
   10.176.0.40/31     *[Direct/0] 00:23:03
                       > via st0.4000
   10.176.0.42/31     *[Direct/0] 00:23:03
                       > via st0.4001
   172.31.31.5/32     *[Static/1] 00:22:51, metric2 0
                       > to 192.168.173.1 via ge-0/0/1.0
   172.31.31.9/32     *[Direct/0] 00:22:42
                       > via lo0.0
   192.168.170.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/1.0
   192.168.210.3/32   *[Direct/0] 00:23:03
                       > via lo0.0
   
   mpls-local-breakout.inet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.176.0.40/31     *[Direct/0] 00:23:03
                       > via st0.4000
   10.176.0.42/31     *[Direct/0] 00:23:03
                       > via st0.4001
   172.31.31.9/32     *[Direct/0] 00:22:42
                       > via lo0.0
   192.168.170.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/1.0
   192.168.210.3/32   *[Direct/0] 00:23:03
                       > via lo0.0
   
   internet-local-breakout.inet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:23:03, metric2 0
                       > to 192.168.173.1 via ge-0/0/1.0
   10.176.0.40/31     *[Direct/0] 00:23:03
                       > via st0.4000
   10.176.0.42/31     *[Direct/0] 00:23:03
                       > via st0.4001
   172.31.31.5/32     *[Static/1] 00:22:51, metric2 0
                       > to 192.168.173.1 via ge-0/0/1.0
   172.31.31.9/32     *[Direct/0] 00:22:42
                       > via lo0.0
   192.168.170.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/1.0
   192.168.210.3/32   *[Direct/0] 00:23:03
                       > via lo0.0
   
   default-cloud-breakout.inet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   10.176.0.40/31     *[Direct/0] 00:23:03
                       > via st0.4000
   10.176.0.42/31     *[Direct/0] 00:23:03
                       > via st0.4001
   172.31.31.9/32     *[Direct/0] 00:22:42
                       > via lo0.0
   192.168.170.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/0.0
   192.168.173.0/24   *[Direct/0] 00:23:03
                       > via ge-0/0/1.0
   192.168.210.3/32   *[Direct/0] 00:23:03
                       > via lo0.0
   
   probe-VR.inet.0: 3 destinations, 3 routes (3 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   172.31.31.9/32     *[Static/5] 00:23:03
                         Reject
   172.31.31.14/32    *[Direct/0] 00:22:42
                       > via lo0.300
   172.31.31.15/32    *[Static/5] 00:23:03
                         to table inet.0
   
   LAN-realtimetenant_DefaultVPN.inet.0: 5 destinations, 7 routes (5 active, 0 holddown, 2 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:18:16, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 16
                         via gr-0/0/0.4002, Push 16
   10.66.66.0/24      *[BGP/170] 00:18:16, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18
   10.77.77.0/24      *[BGP/170] 00:18:16, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18
   10.88.88.0/24      *[Direct/0] 00:19:40
                       > via ge-0/0/4.1088
   10.88.88.1/32      *[Local/0] 00:19:40
                         Local via ge-0/0/4.1088
   
   mpls-realtimetenant_DefaultVPN.inet.0: 4 destinations, 5 routes (2 active, 0 holddown, 2 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:18:16, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 21
                       [Static/175] 00:19:40
                         to table Default-realtimetenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:19:40
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   internet-realtimetenant_DefaultVPN.inet.0: 4 destinations, 5 routes (2 active, 0 holddown, 2 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:18:16, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 19
                       [Static/175] 00:19:40
                         to table Default-realtimetenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Static/5] 00:19:40
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   default-lbo-realtimetenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:19:40, metric2 0
                       > to 192.168.173.1 via ge-0/0/1.0
                       [Static/175] 00:19:40
                         to table Default-realtimetenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Direct/0] 00:19:40
                       > via ge-0/0/4.1088
   
   mpls-lbo-realtimetenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:19:40
                         to table default-lbo-realtimetenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Direct/0] 00:19:40
                       > via ge-0/0/4.1088
   
   internet-lbo-realtimetenant_DefaultVPN.inet.0: 2 destinations, 3 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:19:40, metric2 0
                       > to 192.168.173.1 via ge-0/0/1.0
                       [Static/175] 00:19:40
                         to table default-lbo-realtimetenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Direct/0] 00:19:40
                       > via ge-0/0/4.1088
   
   default-cbo-realtimetenant_DefaultVPN.inet.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/175] 00:19:40
                         to table Default-realtimetenant_DefaultVPN.inet.0
   10.88.88.0/24      *[Direct/0] 00:19:40
                       > via ge-0/0/4.1088
   
   natVR-realtimetenant_DefaultVPN.inet.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:19:40
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   Default-realtimetenant_DefaultVPN.inet.0: 4 destinations, 4 routes (2 active, 0 holddown, 2 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:18:16, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 16
                         via gr-0/0/0.4002, Push 16
   10.88.88.0/24      *[Static/5] 00:19:40
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   Default-reverse-realtimetenant_DefaultVPN.inet.0: 4 destinations, 4 routes (2 active, 0 holddown, 2 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 00:18:16, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 18
                         via gr-0/0/0.4002, Push 18
   10.88.88.0/24      *[Static/5] 00:19:40
                         to table LAN-realtimetenant_DefaultVPN.inet.0
   
   mpls.0: 14 destinations, 14 routes (14 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   16                 *[VPN/0] 00:19:40
                         to table Default-realtimetenant_DefaultVPN.inet.0, Pop
   17                 *[VPN/0] 00:19:40
                         to table Default-reverse-realtimetenant_DefaultVPN.inet.0, Pop
   18                 *[VPN/0] 00:19:40
                         to table LAN-realtimetenant_DefaultVPN.inet.0, Pop
   19                 *[VPN/0] 00:19:40
                         to table internet-realtimetenant_DefaultVPN.inet.0, Pop
   20                 *[VPN/0] 00:19:40
                         to table mpls-realtimetenant_DefaultVPN.inet.0, Pop
   299776             *[VPN/170] 00:22:38
                       > via st0.4000, Pop
   299792             *[VPN/170] 00:22:38
                       > via st0.4001, Pop
   299808             *[VPN/170] 00:22:38
                         receive table transit.inet.0, Pop
   299824             *[VPN/170] 00:18:20
                       > via st0.4003, Pop
   299840             *[VPN/170] 00:18:20
                       > via st0.4002, Pop
   299856             *[VPN/170] 00:18:16
                       > via gr-0/0/0.4002, Pop
   299856(S=0)        *[VPN/170] 00:18:16
                       > via gr-0/0/0.4002, Pop
   299872             *[VPN/170] 00:18:16
                       > via gr-0/0/0.4001, Pop
   299872(S=0)        *[VPN/170] 00:18:16
                       > via gr-0/0/0.4001, Pop
   
   transit.mpls.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0                  *[MPLS/0] 00:19:40, metric 1
                         Receive
   1                  *[MPLS/0] 00:19:40, metric 1
                         Receive
   2                  *[MPLS/0] 00:19:40, metric 1
                         Receive
   13                 *[MPLS/0] 00:19:40, metric 1
                         Receive
   
   bgp.l3vpn.0: 14 destinations, 14 routes (6 active, 0 holddown, 8 hidden)
   + = Active Route, - = Last Active, * = Both
   
   192.168.210.1:25:0.0.0.0/0
                      *[BGP/170] 00:19:40, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 18
                         via gr-0/0/0.4002, Push 18
   192.168.210.4:25:10.66.66.0/24
                      *[BGP/170] 00:19:40, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18
   192.168.210.5:25:10.77.77.0/24
                      *[BGP/170] 00:19:39, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18
   239.1.0.2:24:0.0.0.0/0
                      *[BGP/170] 00:19:40, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 16
                         via gr-0/0/0.4002, Push 16
   239.1.0.2:36:0.0.0.0/0
                      *[BGP/170] 00:19:40, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 21
   239.1.0.2:37:0.0.0.0/0
                      *[BGP/170] 00:19:40, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 19
   
   show security zones
   
   Security zone: Default
     Send reset for non-SYN session TCP packets: Off
     Policy configurable: Yes
     Interfaces bound: 1
     Interfaces:
       ge-0/0/4.1088
   
   Security zone: oam
     Send reset for non-SYN session TCP packets: Off
     Policy configurable: Yes
     Interfaces bound: 3
     Interfaces:
       lo0.0
       st0.4000
       st0.4001
   
   Security zone: trust
     Send reset for non-SYN session TCP packets: On
     Policy configurable: Yes
     Interfaces bound: 4
     Interfaces:
       gr-0/0/0.4001
       gr-0/0/0.4002
       st0.4002
       st0.4003
   
   Security zone: untrust
     Send reset for non-SYN session TCP packets: Off
     Policy configurable: Yes
     Screen: untrust-screen
     Interfaces bound: 2
     Interfaces:
       ge-0/0/0.0
       ge-0/0/1.0
   
   Security zone: junos-host
     Send reset for non-SYN session TCP packets: Off
     Policy configurable: Yes
     Interfaces bound: 0
     Interfaces:
   
   show services rpm probe-results
       Owner: lbo-probe-192.168.173.1-gw, Test: test-icmp-192.168.173.1
       Target address: 192.168.173.1, Probe type: icmp-ping, Test size: 3 probes
       Probe results:
         Response received
         Fri Feb 15 13:04:33 2019
         Fri Feb 15 13:04:33 2019, No hardware timestamps
         Rtt: 2596 usec, Round trip jitter: 76 usec, Round trip interarrival jitter: 6133 usec
       Results over current test:
         Probes sent: 2, Probes received: 2, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 2, Minimum: 2520 usec, Maximum: 2596 usec, Average: 2558 usec, Peak to peak: 76 usec, Stddev: 38 usec, Sum: 5116 usec
         Measurement: Positive round trip jitter
           Samples: 1, Minimum: 76 usec, Maximum: 76 usec, Average: 76 usec, Peak to peak: 0 usec, Stddev: 0 usec, Sum: 76 usec
         Measurement: Negative round trip jitter
           Samples: 1, Minimum: 8724 usec, Maximum: 8724 usec, Average: 8724 usec, Peak to peak: 0 usec, Stddev: 0 usec, Sum: 8724 usec
       Results over last test:
         Probes sent: 3, Probes received: 3, Loss percentage: 0.000000
         Test completed on Fri Feb 15 13:04:23 2019
         Measurement: Round trip time
           Samples: 3, Minimum: 7830 usec, Maximum: 11244 usec, Average: 9066 usec, Peak to peak: 3414 usec, Stddev: 1545 usec,
           Sum: 27198 usec
         Measurement: Positive round trip jitter
           Samples: 2, Minimum: 294 usec, Maximum: 3120 usec, Average: 1707 usec, Peak to peak: 2826 usec, Stddev: 1413 usec,
           Sum: 3414 usec
         Measurement: Negative round trip jitter
           Samples: 1, Minimum: 1077 usec, Maximum: 1077 usec, Average: 1077 usec, Peak to peak: 0 usec, Stddev: 0 usec, Sum: 1077 usec
       Results over all tests:
         Probes sent: 290, Probes received: 290, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 290, Minimum: 1417 usec, Maximum: 604787 usec, Average: 14315 usec, Peak to peak: 603370 usec, Stddev: 41354 usec,
           Sum: 4151485 usec
         Measurement: Positive round trip jitter
           Samples: 143, Minimum: 15 usec, Maximum: 531852 usec, Average: 15879 usec, Peak to peak: 531837 usec, Stddev: 52432 usec,
           Sum: 2270641 usec
         Measurement: Negative round trip jitter
           Samples: 146, Minimum: 11 usec, Maximum: 602452 usec, Average: 15579 usec, Peak to peak: 602441 usec, Stddev: 55812 usec,
           Sum: 2274578 usec
   
       Owner: lbo-probe-192.168.173.1-local, Test: test-icmp-192.168.173.1
       Target address: 172.31.31.9, Probe type: icmp-ping
       Routing Instance Name: probe-VR
       Test size: 3 probes
       Probe results:
         No route to target
         Fri Feb 15 13:04:33 2019
         Fri Feb 15 13:04:33 2019
       Results over current test:
         Probes sent: 2, Probes received: 0, Loss percentage: 100.00000
       Results over last test:
         Probes sent: 3, Probes received: 0, Loss percentage: 100.00000
       Results over all tests:
         Probes sent: 290, Probes received: 0, Loss percentage: 100.00000
   
   show configuration | display set
   root@CV2116AF0288.sdwansite1.realtimetenant> show configuration | display set
   set version "15.1-2019-01-28.0_JUNOS_151_X49_D170 [ssd-builder]"
   set groups global security forwarding-options family mpls mode flow-based
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-local test test-icmp-192.168.173.1 target address 172.31.31.9
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-local test test-icmp-192.168.173.1 probe-count 3
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-local test test-icmp-192.168.173.1 probe-interval 5
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-local test test-icmp-192.168.173.1 test-interval 5
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-local test test-icmp-192.168.173.1 routing-instance probe-VR
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-local test test-icmp-192.168.173.1 thresholds successive-loss 3
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-local test test-icmp-192.168.173.1 thresholds total-loss 3
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-gw test test-icmp-192.168.173.1 target address 192.168.173.1
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-gw test test-icmp-192.168.173.1 probe-count 3
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-gw test test-icmp-192.168.173.1 probe-interval 5
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-gw test test-icmp-192.168.173.1 test-interval 5
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-gw test test-icmp-192.168.173.1 thresholds successive-loss 3
   set groups srx-gwr-site-routing-config-192.168.210.3 services rpm probe lbo-probe-192.168.173.1-gw test test-icmp-192.168.173.1 thresholds total-loss 3
   set groups srx-gwr-site-routing-config-192.168.210.3 services ip-monitoring policy breakout-policy-192.168.173.1-local match rpm-probe lbo-probe-192.168.173.1-local
   set groups srx-gwr-site-routing-config-192.168.210.3 services ip-monitoring policy breakout-policy-192.168.173.1-local then preferred-route routing-instances default-local-breakout route 172.31.31.5/32 next-hop 192.168.173.1
   set groups srx-gwr-site-routing-config-192.168.210.3 services ip-monitoring policy breakout-policy-192.168.173.1-local-INTERNET match rpm-probe lbo-probe-192.168.173.1-local
   set groups srx-gwr-site-routing-config-192.168.210.3 services ip-monitoring policy breakout-policy-192.168.173.1-local-INTERNET then preferred-route routing-instances internet-local-breakout route 172.31.31.5/32 next-hop 192.168.173.1
   set groups srx-gwr-site-routing-config-192.168.210.3 services ip-monitoring policy breakout-policy-192.168.173.1-gateway match rpm-probe lbo-probe-192.168.173.1-gw
   set groups srx-gwr-site-routing-config-192.168.210.3 services ip-monitoring policy breakout-policy-192.168.173.1-gateway then preferred-route routing-instances probe-VR route 172.31.31.9/32 next-hop 172.31.31.15
   set groups srx-gwr-site-routing-config-192.168.210.3 security zones security-zone trust enable-reverse-reroute
   set groups srx-gwr-site-routing-config-192.168.210.3 interfaces lo0 unit 0 family inet address 192.168.210.3/32 primary
   set groups srx-gwr-site-routing-config-192.168.210.3 interfaces lo0 unit 0 family inet address 172.31.31.9/32
   set groups srx-gwr-site-routing-config-192.168.210.3 interfaces lo0 unit 300 family inet address 172.31.31.14/32
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options interface-routes rib-group inet local-breakout-rib
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups transit-inet3-to-inet3 import-rib transit.inet.3
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups transit-inet3-to-inet3 import-rib inet.3
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups local-breakout-rib import-rib inet.0
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups local-breakout-rib import-rib transit.inet.0
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups local-breakout-rib import-rib default-local-breakout.inet.0
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups local-breakout-rib import-rib mpls-local-breakout.inet.0
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups local-breakout-rib import-rib internet-local-breakout.inet.0
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups local-breakout-rib import-rib default-cloud-breakout.inet.0
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups local-breakout-rib import-policy direct-routes
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups probe-VR-to-inet0 import-rib probe-VR.inet.0
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups probe-VR-to-inet0 import-rib inet.0
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options rib-groups probe-VR-to-inet0 import-policy direct-policy
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options router-id 192.168.210.3
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options autonomous-system 64512
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-options forwarding-table export pplb
   set groups srx-gwr-site-routing-config-192.168.210.3 protocols bgp group ibgp type internal
   set groups srx-gwr-site-routing-config-192.168.210.3 protocols bgp group ibgp local-address 192.168.210.3
   set groups srx-gwr-site-routing-config-192.168.210.3 protocols bgp group ibgp hold-time 200
   set groups srx-gwr-site-routing-config-192.168.210.3 protocols bgp group ibgp family inet-vpn unicast graceful-restart long-lived restarter stale-time 16777215
   set groups srx-gwr-site-routing-config-192.168.210.3 protocols bgp group ibgp neighbor 192.168.10.49
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement pplb then load-balance per-packet
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement direct-routes term 1 from protocol direct
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement direct-routes term 1 then accept
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement direct-routes term 2 then reject
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement default-local-breakout-import term 1 from instance default-local-breakout
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement default-local-breakout-import term 1 from route-filter 0.0.0.0/0 exact
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement default-local-breakout-import term 1 then accept
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement default-local-breakout-import term 2 then reject
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement mpls-local-breakout-import term 1 from instance mpls-local-breakout
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement mpls-local-breakout-import term 1 from route-filter 0.0.0.0/0 exact
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement mpls-local-breakout-import term 1 then accept
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement mpls-local-breakout-import term 2 then reject
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement internet-local-breakout-import term 1 from instance internet-local-breakout
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement internet-local-breakout-import term 1 from route-filter 0.0.0.0/0 exact
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement internet-local-breakout-import term 1 then accept
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement internet-local-breakout-import term 2 then reject
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement default-cloud-breakout-import term 1 from instance default-cloud-breakout
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement default-cloud-breakout-import term 1 from route-filter 0.0.0.0/0 exact
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement default-cloud-breakout-import term 1 then accept
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement default-cloud-breakout-import term 2 then reject
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement direct-policy term 1 from route-filter 172.31.31.14/32 exact
   set groups srx-gwr-site-routing-config-192.168.210.3 policy-options policy-statement direct-policy term 1 then accept
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances transit instance-type vrf
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances transit route-distinguisher 192.168.210.3:64512
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances transit vrf-target target:192.168.210.3:64512
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances transit routing-options rib transit.inet.3 static rib-group transit-inet3-to-inet3
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances default-local-breakout instance-type forwarding
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances default-local-breakout routing-options static route 0.0.0.0/0 qualified-next-hop 172.31.31.5 preference 5
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances default-local-breakout routing-options static route 0.0.0.0/0 resolve
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances mpls-local-breakout instance-type forwarding
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances internet-local-breakout instance-type forwarding
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances internet-local-breakout routing-options static route 0.0.0.0/0 qualified-next-hop 172.31.31.5 preference 5
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances internet-local-breakout routing-options static route 0.0.0.0/0 resolve
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances default-cloud-breakout instance-type forwarding
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances probe-VR instance-type virtual-router
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances probe-VR interface lo0.300
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances probe-VR routing-options interface-routes rib-group inet probe-VR-to-inet0
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances probe-VR routing-options static route 172.31.31.9/32 reject
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances probe-VR routing-options static route 172.31.31.9/32 resolve
   set groups srx-gwr-site-routing-config-192.168.210.3 routing-instances probe-VR routing-options static route 172.31.31.15/32 next-table inet.0
   set groups dept-configuration security zones security-zone Default host-inbound-traffic system-services all
   set groups dept-configuration security zones security-zone Default host-inbound-traffic protocols all
   set groups dept-configuration security zones security-zone Default interfaces ge-0/0/4.1088
   set groups dept-configuration interfaces ge-0/0/4 flexible-vlan-tagging
   set groups dept-configuration interfaces ge-0/0/4 unit 1088 vlan-id 1088
   set groups dept-configuration interfaces ge-0/0/4 unit 1088 family inet filter input-list appqoe_filter
   set groups dept-configuration interfaces ge-0/0/4 unit 1088 family inet filter group 1
   set groups dept-configuration interfaces ge-0/0/4 unit 1088 family inet address 10.88.88.1/24
   set groups dept-configuration firewall family inet filter appqoe_filter term aq_term1 from destination-port 36000
   set groups dept-configuration firewall family inet filter appqoe_filter term aq_term1 then count aq_counter1
   set groups dept-configuration firewall family inet filter appqoe_filter term aq_term1 then discard
   set groups dept-configuration firewall family inet filter appqoe_filter term default then accept
   set groups dept-configuration routing-instances LAN-realtimetenant_DefaultVPN interface ge-0/0/4.1088
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec proposal 4d97f664a188a96387cb877f4b563fb8 protocol esp
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec proposal 4d97f664a188a96387cb877f4b563fb8 encryption-algorithm aes-256-gcm
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec proposal 9c1a38ae438299b4d727b6733efeb381 protocol esp
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec proposal 9c1a38ae438299b4d727b6733efeb381 authentication-algorithm hmac-sha-256-128
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec proposal 9c1a38ae438299b4d727b6733efeb381 encryption-algorithm aes-256-cbc
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec policy c4c9320690b88d0c57bdd6e5825e5702 perfect-forward-secrecy keys group14
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec policy c4c9320690b88d0c57bdd6e5825e5702 proposals 4d97f664a188a96387cb877f4b563fb8
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec policy c4c9320690b88d0c57bdd6e5825e5702 proposals 9c1a38ae438299b4d727b6733efeb381
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec vpn 387429603bb54f7b09e79beab6f25a4e bind-interface st0.4003
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec vpn 387429603bb54f7b09e79beab6f25a4e ike gateway 57f1c23fa34111a85b19e864ed9eb101
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec vpn 387429603bb54f7b09e79beab6f25a4e ike proxy-identity local 10.144.0.43/31
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec vpn 387429603bb54f7b09e79beab6f25a4e ike proxy-identity remote 10.144.0.42/31
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec vpn 387429603bb54f7b09e79beab6f25a4e ike ipsec-policy c4c9320690b88d0c57bdd6e5825e5702
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security ipsec vpn 387429603bb54f7b09e79beab6f25a4e establish-tunnels immediately
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 security zones security-zone trust interfaces st0.4003
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 interfaces st0 unit 4003 family inet address 10.144.0.43/31
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 routing-options static route 192.168.191.0/24 next-hop 192.168.173.1
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0 routing-instances transit interface st0.4003
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec proposal 4d97f664a188a96387cb877f4b563fb8 protocol esp
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec proposal 4d97f664a188a96387cb877f4b563fb8 encryption-algorithm aes-256-gcm
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec proposal 9c1a38ae438299b4d727b6733efeb381 protocol esp
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec proposal 9c1a38ae438299b4d727b6733efeb381 authentication-algorithm hmac-sha-256-128
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec proposal 9c1a38ae438299b4d727b6733efeb381 encryption-algorithm aes-256-cbc
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec policy c4c9320690b88d0c57bdd6e5825e5702 perfect-forward-secrecy keys group14
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec policy c4c9320690b88d0c57bdd6e5825e5702 proposals 4d97f664a188a96387cb877f4b563fb8
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec policy c4c9320690b88d0c57bdd6e5825e5702 proposals 9c1a38ae438299b4d727b6733efeb381
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec vpn 72da4133d23ee60657f2727ae09141c8 bind-interface st0.4002
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec vpn 72da4133d23ee60657f2727ae09141c8 ike gateway a3cc88fe25cc6137de117b0e479780c1
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec vpn 72da4133d23ee60657f2727ae09141c8 ike proxy-identity local 10.144.0.41/31
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec vpn 72da4133d23ee60657f2727ae09141c8 ike proxy-identity remote 10.144.0.40/31
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec vpn 72da4133d23ee60657f2727ae09141c8 ike ipsec-policy c4c9320690b88d0c57bdd6e5825e5702
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security ipsec vpn 72da4133d23ee60657f2727ae09141c8 establish-tunnels immediately
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 security zones security-zone trust interfaces st0.4002
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 interfaces st0 unit 4002 family inet address 10.144.0.41/31
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 routing-options static route 192.168.190.0/24 next-hop 192.168.170.1
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0 routing-instances transit interface st0.4002
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 security zones security-zone trust interfaces gr-0/0/0.4001
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 tunnel source 10.144.0.41
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 tunnel destination 10.144.0.40
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 tunnel routing-instance destination transit
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 family inet address 10.152.0.41/31
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 family mpls
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4001 copy-tos-to-outer-ip-header
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 protocols oam gre-tunnel interface gr-0/0/0.4001 keepalive-time 4
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 protocols oam gre-tunnel interface gr-0/0/0.4001 hold-time 8
   set groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 routing-instances transit interface gr-0/0/0.4001
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 security zones security-zone trust interfaces gr-0/0/0.4002
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4002 tunnel source 10.144.0.43
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4002 tunnel destination 10.144.0.42
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4002 tunnel routing-instance destination transit
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4002 family inet address 10.152.0.43/31
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4002 family mpls
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 interfaces gr-0/0/0 unit 4002 copy-tos-to-outer-ip-header
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 protocols oam gre-tunnel interface gr-0/0/0.4002 keepalive-time 4
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 protocols oam gre-tunnel interface gr-0/0/0.4002 hold-time 8
   set groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 routing-instances transit interface gr-0/0/0.4002
   set groups dg-hub1 security advance-policy-based-routing overlay-path 72da4133d23ee60657f2727ae09141c8 tunnel-path local ip-address 10.152.0.41
   set groups dg-hub1 security advance-policy-based-routing overlay-path 72da4133d23ee60657f2727ae09141c8 tunnel-path remote ip-address 10.152.0.40
   set groups dg-hub1 security advance-policy-based-routing overlay-path 72da4133d23ee60657f2727ae09141c8 probe-path local ip-address 10.152.0.41
   set groups dg-hub1 security advance-policy-based-routing overlay-path 72da4133d23ee60657f2727ae09141c8 probe-path remote ip-address 10.152.0.40
   set groups dg-hub1 security advance-policy-based-routing overlay-path 387429603bb54f7b09e79beab6f25a4e tunnel-path local ip-address 10.152.0.43
   set groups dg-hub1 security advance-policy-based-routing overlay-path 387429603bb54f7b09e79beab6f25a4e tunnel-path remote ip-address 10.152.0.42
   set groups dg-hub1 security advance-policy-based-routing overlay-path 387429603bb54f7b09e79beab6f25a4e probe-path local ip-address 10.152.0.43
   set groups dg-hub1 security advance-policy-based-routing overlay-path 387429603bb54f7b09e79beab6f25a4e probe-path remote ip-address 10.152.0.42
   set groups dg-hub1 security advance-policy-based-routing destination-path-group hub1 probe-routing-instance transit
   set groups dg-hub1 security advance-policy-based-routing destination-path-group hub1 overlay-path 72da4133d23ee60657f2727ae09141c8
   set groups dg-hub1 security advance-policy-based-routing destination-path-group hub1 overlay-path 387429603bb54f7b09e79beab6f25a4e
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-options rib-groups LAN-realtimetenant_DefaultVPN-to-breakout import-rib LAN-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-options rib-groups LAN-realtimetenant_DefaultVPN-to-breakout import-rib default-lbo-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-options rib-groups LAN-realtimetenant_DefaultVPN-to-breakout import-rib mpls-lbo-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-options rib-groups LAN-realtimetenant_DefaultVPN-to-breakout import-rib internet-lbo-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-options rib-groups LAN-realtimetenant_DefaultVPN-to-breakout import-rib default-cbo-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-options rib-groups LAN-realtimetenant_DefaultVPN-to-breakout import-policy direct-routes
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-options forwarding-table export LAN-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-options forwarding-table export Default-realtimetenant_DefaultVPN-reverse
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config protocols bgp group ibgp import next-hop-change
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config protocols bgp group ibgp export static-export
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config protocols bgp group ibgp vpn-apply-export
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement PATH-POLICY-realtimetenant_DefaultVPN term realtimetenant_DefaultVPN-hub11 from community SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement PATH-POLICY-realtimetenant_DefaultVPN term realtimetenant_DefaultVPN-hub11 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement PATH-POLICY-realtimetenant_DefaultVPN term realtimetenant_DefaultVPN-hub12 from community SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement PATH-POLICY-realtimetenant_DefaultVPN term realtimetenant_DefaultVPN-hub12 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term default-realtimetenant_DefaultVPN-hub11 from next-hop 192.168.210.1
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term default-realtimetenant_DefaultVPN-hub11 from community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term default-realtimetenant_DefaultVPN-hub11 then next-hop 10.192.0.10
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term default-realtimetenant_DefaultVPN-hub12 from next-hop 192.168.210.1
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term default-realtimetenant_DefaultVPN-hub12 from community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term default-realtimetenant_DefaultVPN-hub12 then next-hop 10.192.0.10
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term spoke-import-realtimetenant_DefaultVPN from community Spoke-Routes-LAN-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term spoke-import-realtimetenant_DefaultVPN from community datacenter
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term spoke-import-realtimetenant_DefaultVPN then next-hop 192.168.0.1
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement next-hop-change term spoke-import-realtimetenant_DefaultVPN then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement static-export term realtimetenant_DefaultVPN-1 from community Spoke-Routes-mpls-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement static-export term realtimetenant_DefaultVPN-1 then community add spoke-community
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement static-export term realtimetenant_DefaultVPN-1 then next-hop 10.192.0.21
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement static-export term realtimetenant_DefaultVPN-1 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement static-export term realtimetenant_DefaultVPN-2 from community Spoke-Routes-internet-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement static-export term realtimetenant_DefaultVPN-2 then community add spoke-community
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement static-export term realtimetenant_DefaultVPN-2 then next-hop 10.192.0.20
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement static-export term realtimetenant_DefaultVPN-2 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement donotexport then reject
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement direct-routes term 1 from protocol direct
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement direct-routes term 1 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement direct-routes term 2 then reject
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN term 1 from protocol bgp
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN term 1 from rib LAN-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN term 1 then next-hop next-table Default-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-reverse term 1 from protocol bgp
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-reverse term 1 from rib transit.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-reverse term 1 from community Spoke-Routes-LAN-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-reverse term 1 then next-hop next-table Default-reverse-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement transit-import term realtimetenant_DefaultVPN-1 from community Spoke-Routes-LAN-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement transit-import term realtimetenant_DefaultVPN-1 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-import term 1 from community Spoke-Routes-mpls-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-import term 1 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-import term 2 from community Hub-Primary-Routes-mpls-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-import term 2 then local-preference 200
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-import term 2 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-import term 1 from community Spoke-Routes-internet-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-import term 1 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-import term 2 from community Hub-Primary-Routes-internet-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-import term 2 then local-preference 200
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-import term 2 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-export term 1-direct from route-filter 10.88.88.0/24 exact
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-export term 1-direct then community add Spoke-Routes-mpls-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-export term 1-direct then community add Hub-Primary-Select
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-export term 1-direct then next-hop 10.192.0.21
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement mpls-realtimetenant_DefaultVPN-export term 1-direct then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-export term 1-direct from route-filter 10.88.88.0/24 exact
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-export term 1-direct then community add Spoke-Routes-internet-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-export term 1-direct then community add Hub-Primary-Select
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-export term 1-direct then next-hop 10.192.0.20
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement internet-realtimetenant_DefaultVPN-export term 1-direct then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-import term 1 from community Spoke-Routes-Default-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-import term 1 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-import term 2 from community Spoke-Routes-LAN-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-import term 2 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-import term 3 from community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-import term 3 then local-preference 200
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-import term 3 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-import term 5 from community datacenter
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-import term 5 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-import term 1 from community Spoke-Routes-Default-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-import term 1 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-import term 2 from community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-import term 2 then local-preference 200
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-import term 2 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-import term default then reject
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-import term 1 from community Spoke-Routes-Default-reverse-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-import term 1 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-import term 2 from community Hub-Primary-Routes-Default-reverse-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-import term 2 then local-preference 200
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-import term 2 then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-import term default then reject
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct from route-filter 10.88.88.0/24 exact
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then community add Spoke-Routes-Default-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then community add Hub-Primary-Select
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then next-hop 192.168.210.3
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct from route-filter 10.88.88.0/24 exact
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then community add Spoke-Routes-LAN-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then next-hop 192.168.210.3
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement LAN-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct from route-filter 10.88.88.0/24 exact
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then community add Spoke-Routes-Default-reverse-realtimetenant_DefaultVPN
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then community add Hub-Primary-Select
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then next-hop 192.168.210.3
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options policy-statement Default-reverse-realtimetenant_DefaultVPN-export term realtimetenant_DefaultVPN-direct then accept
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0-realtimetenant_DefaultVPN members 64512:1
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0-realtimetenant_DefaultVPN members 64512:2
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Spoke-Routes-mpls-realtimetenant_DefaultVPN members target:64512:36
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Spoke-Routes-internet-realtimetenant_DefaultVPN members target:64512:37
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Hub-Primary-Routes-mpls-realtimetenant_DefaultVPN members target:192.168.210.1:36
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Hub-Primary-Routes-internet-realtimetenant_DefaultVPN members target:192.168.210.1:37
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Hub-Primary-Select members target:192.168.210.1:1
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Hub-Primary-Routes-Default-realtimetenant_DefaultVPN members target:192.168.210.1:24
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Hub-Primary-Routes-Default-reverse-realtimetenant_DefaultVPN members target:192.168.210.1:25
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Spoke-Routes-Default-realtimetenant_DefaultVPN members target:64512:24
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Spoke-Routes-Default-reverse-realtimetenant_DefaultVPN members target:64512:25
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community Spoke-Routes-LAN-realtimetenant_DefaultVPN members target:192.168.0.1:25
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community datacenter members target:192.168.0.1:61151
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config policy-options community spoke-community members 64512:64512
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit interface gr-0/0/0.4001
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit interface gr-0/0/0.4002
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit vrf-import transit-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.152.0.40/32 next-hop gr-0/0/0.4001
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.152.0.40/32 qualified-next-hop gr-0/0/0.4002 preference 8
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.192.0.9/32 next-hop gr-0/0/0.4001
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.192.0.9/32 qualified-next-hop gr-0/0/0.4002 preference 8
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 192.168.210.1/32 qualified-next-hop gr-0/0/0.4001 preference 12
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 192.168.210.1/32 qualified-next-hop gr-0/0/0.4002 preference 12
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.152.0.42/32 next-hop gr-0/0/0.4002
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.152.0.42/32 qualified-next-hop gr-0/0/0.4001 preference 8
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.192.0.8/32 next-hop gr-0/0/0.4002
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.192.0.8/32 qualified-next-hop gr-0/0/0.4001 preference 8
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.192.0.10/32 next-hop gr-0/0/0.4001
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 10.192.0.10/32 next-hop gr-0/0/0.4002
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 192.168.0.1/32 qualified-next-hop 192.168.210.1 preference 9
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 192.168.0.1/32 no-readvertise
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit routing-options rib transit.inet.3 static route 192.168.0.1/32 resolve
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit protocols mpls interface gr-0/0/0.4001
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances transit protocols mpls interface gr-0/0/0.4002
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-realtimetenant_DefaultVPN instance-type vrf
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-realtimetenant_DefaultVPN route-distinguisher 192.168.210.3:36
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-realtimetenant_DefaultVPN vrf-import mpls-realtimetenant_DefaultVPN-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-realtimetenant_DefaultVPN vrf-export mpls-realtimetenant_DefaultVPN-export
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-realtimetenant_DefaultVPN vrf-table-label
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 next-table Default-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 preference 175
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-realtimetenant_DefaultVPN routing-options static route 10.88.88.0/24 next-table LAN-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-realtimetenant_DefaultVPN instance-type vrf
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-realtimetenant_DefaultVPN route-distinguisher 192.168.210.3:37
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-realtimetenant_DefaultVPN vrf-import internet-realtimetenant_DefaultVPN-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-realtimetenant_DefaultVPN vrf-export internet-realtimetenant_DefaultVPN-export
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-realtimetenant_DefaultVPN vrf-table-label
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 next-table Default-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 preference 175
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-realtimetenant_DefaultVPN routing-options static route 10.88.88.0/24 next-table LAN-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances default-lbo-realtimetenant_DefaultVPN instance-type forwarding
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances default-lbo-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 next-table Default-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances default-lbo-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 preference 175
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances default-lbo-realtimetenant_DefaultVPN routing-options instance-import default-local-breakout-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-lbo-realtimetenant_DefaultVPN instance-type forwarding
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-lbo-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 next-table default-lbo-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-lbo-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 preference 175
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances mpls-lbo-realtimetenant_DefaultVPN routing-options instance-import mpls-local-breakout-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-lbo-realtimetenant_DefaultVPN instance-type forwarding
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-lbo-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 next-table default-lbo-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-lbo-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 preference 175
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances internet-lbo-realtimetenant_DefaultVPN routing-options instance-import internet-local-breakout-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances default-cbo-realtimetenant_DefaultVPN instance-type forwarding
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances default-cbo-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 next-table Default-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances default-cbo-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 preference 175
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances default-cbo-realtimetenant_DefaultVPN routing-options instance-import default-cloud-breakout-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances natVR-realtimetenant_DefaultVPN instance-type virtual-router
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances natVR-realtimetenant_DefaultVPN routing-options static route 0.0.0.0/0 next-table LAN-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-realtimetenant_DefaultVPN instance-type vrf
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-realtimetenant_DefaultVPN route-distinguisher 192.168.210.3:24
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-realtimetenant_DefaultVPN vrf-import Default-realtimetenant_DefaultVPN-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-realtimetenant_DefaultVPN vrf-export Default-realtimetenant_DefaultVPN-export
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-realtimetenant_DefaultVPN vrf-table-label
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-realtimetenant_DefaultVPN routing-options static route 10.88.88.0/24 next-table LAN-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-reverse-realtimetenant_DefaultVPN instance-type vrf
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-reverse-realtimetenant_DefaultVPN route-distinguisher 239.1.0.5:24
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-reverse-realtimetenant_DefaultVPN vrf-import Default-reverse-realtimetenant_DefaultVPN-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-reverse-realtimetenant_DefaultVPN vrf-export Default-reverse-realtimetenant_DefaultVPN-export
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-reverse-realtimetenant_DefaultVPN vrf-table-label
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances Default-reverse-realtimetenant_DefaultVPN routing-options static route 10.88.88.0/24 next-table LAN-realtimetenant_DefaultVPN.inet.0
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances LAN-realtimetenant_DefaultVPN instance-type vrf
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances LAN-realtimetenant_DefaultVPN interface ge-0/0/4.1088
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances LAN-realtimetenant_DefaultVPN route-distinguisher 192.168.210.3:25
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances LAN-realtimetenant_DefaultVPN vrf-import LAN-realtimetenant_DefaultVPN-import
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances LAN-realtimetenant_DefaultVPN vrf-export LAN-realtimetenant_DefaultVPN-export
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances LAN-realtimetenant_DefaultVPN vrf-table-label
   set groups spoke-realtimetenant_DefaultVPN-vpn-routing-config routing-instances LAN-realtimetenant_DefaultVPN routing-options interface-routes rib-group inet LAN-realtimetenant_DefaultVPN-to-breakout
   set groups spoke-policy-default policy-options policy-statement next-hop-change term default then accept
   set groups spoke-policy-default policy-options policy-statement transit-import term default then reject
   set groups spoke-policy-default policy-options policy-statement static-export term default then community add spoke-community
   set groups spoke-policy-default policy-options policy-statement static-export term default then accept
   set groups app-qoe-sdwansite1 interfaces ge-0/0/0 per-unit-scheduler
   set groups app-qoe-sdwansite1 interfaces ge-0/0/1 per-unit-scheduler
   set groups app-qoe-sdwansite1 class-of-service classifiers dscp DSCP forwarding-class INTERNET loss-priority high code-points af11
   set groups app-qoe-sdwansite1 class-of-service classifiers dscp DSCP forwarding-class VOICE-VIDEO loss-priority high code-points af41
   set groups app-qoe-sdwansite1 class-of-service classifiers dscp DSCP forwarding-class CONTROL loss-priority low code-points cs6
   set groups app-qoe-sdwansite1 class-of-service classifiers dscp DSCP forwarding-class OAM loss-priority low code-points af21
   set groups app-qoe-sdwansite1 class-of-service host-outbound-traffic forwarding-class CONTROL
   set groups app-qoe-sdwansite1 class-of-service host-outbound-traffic dscp-code-point cs6
   set groups app-qoe-sdwansite1 class-of-service forwarding-classes queue 0 INTERNET
   set groups app-qoe-sdwansite1 class-of-service forwarding-classes queue 1 VOICE-VIDEO
   set groups app-qoe-sdwansite1 class-of-service forwarding-classes queue 3 CONTROL
   set groups app-qoe-sdwansite1 class-of-service forwarding-classes queue 5 OAM
   set groups app-qoe-sdwansite1 class-of-service interfaces gr-0/0/0 unit * classifiers dscp DSCP
   set groups app-qoe-sdwansite1 class-of-service interfaces gr-0/0/0 unit * rewrite-rules dscp DSCP-RW
   set groups app-qoe-sdwansite1 class-of-service interfaces st0 unit * classifiers dscp DSCP
   set groups app-qoe-sdwansite1 class-of-service interfaces st0 unit * rewrite-rules dscp DSCP-RW
   set groups app-qoe-sdwansite1 class-of-service interfaces ge-0/0/0 unit * scheduler-map sched-map
   set groups app-qoe-sdwansite1 class-of-service interfaces ge-0/0/0 unit * classifiers dscp DSCP
   set groups app-qoe-sdwansite1 class-of-service interfaces ge-0/0/0 unit * rewrite-rules dscp DSCP-RW
   set groups app-qoe-sdwansite1 class-of-service interfaces ge-0/0/1 unit * scheduler-map sched-map
   set groups app-qoe-sdwansite1 class-of-service interfaces ge-0/0/1 unit * classifiers dscp DSCP
   set groups app-qoe-sdwansite1 class-of-service interfaces ge-0/0/1 unit * rewrite-rules dscp DSCP-RW
   set groups app-qoe-sdwansite1 class-of-service rewrite-rules dscp DSCP-RW forwarding-class INTERNET loss-priority high code-point af11
   set groups app-qoe-sdwansite1 class-of-service rewrite-rules dscp DSCP-RW forwarding-class VOICE-VIDEO loss-priority high code-point af41
   set groups app-qoe-sdwansite1 class-of-service rewrite-rules dscp DSCP-RW forwarding-class OAM loss-priority low code-point af21
   set groups app-qoe-sdwansite1 class-of-service scheduler-maps sched-map forwarding-class INTERNET scheduler QOS-INTERNET-QGRP
   set groups app-qoe-sdwansite1 class-of-service scheduler-maps sched-map forwarding-class VOICE-VIDEO scheduler QOS-VOICE-VIDEO-QGRP
   set groups app-qoe-sdwansite1 class-of-service scheduler-maps sched-map forwarding-class CONTROL scheduler QOS-CONTROL-QGRP
   set groups app-qoe-sdwansite1 class-of-service scheduler-maps sched-map forwarding-class OAM scheduler QOS-OAM-QGRP
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-INTERNET-QGRP transmit-rate percent 15
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-INTERNET-QGRP shaping-rate percent 20
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-INTERNET-QGRP buffer-size percent 5
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-INTERNET-QGRP priority low
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-VOICE-VIDEO-QGRP transmit-rate percent 20
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-VOICE-VIDEO-QGRP shaping-rate percent 20
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-VOICE-VIDEO-QGRP buffer-size percent 5
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-VOICE-VIDEO-QGRP priority low
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-CONTROL-QGRP transmit-rate percent 5
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-CONTROL-QGRP buffer-size percent 5
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-CONTROL-QGRP priority high
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-OAM-QGRP transmit-rate percent 2
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-OAM-QGRP buffer-size percent 2
   set groups app-qoe-sdwansite1 class-of-service schedulers QOS-OAM-QGRP priority low
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing tunables max-route-change 5
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing tunables enable-logging
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing profile pr_apbr_Default rule r_apbr_d_Default_p_Intent-1_s_sla-dela-100ms match dynamic-application junos:CNN
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing profile pr_apbr_Default rule r_apbr_d_Default_p_Intent-1_s_sla-dela-100ms match dynamic-application junos:SSH
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing profile pr_apbr_Default rule r_apbr_d_Default_p_Intent-1_s_sla-dela-100ms then routing-instance Default-reverse-realtimetenant_DefaultVPN
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing profile pr_apbr_Default rule r_apbr_d_Default_p_Intent-1_s_sla-dela-100ms then sla-rule sla-dela-100ms
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing active-probe-params VOICE-VIDEO settings data-fill deadbead
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing active-probe-params VOICE-VIDEO settings data-size 64
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing active-probe-params VOICE-VIDEO settings probe-interval 10
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing active-probe-params VOICE-VIDEO settings probe-count 30
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing active-probe-params VOICE-VIDEO settings burst-size 3
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing active-probe-params VOICE-VIDEO settings sla-export-interval 60
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing active-probe-params VOICE-VIDEO settings dscp-code-points 100010
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing metrics-profile sla-dela-100ms sla-threshold delay-round-trip 100000
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing metrics-profile sla-dela-100ms sla-threshold match all
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-options local-route-switch enabled
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-options log-type syslog
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-options max-passive-probe-limit number-of-probes 5000
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-options max-passive-probe-limit interval 500
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-rule sla-dela-100ms switch-idle-time 120
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-rule sla-dela-100ms metrics-profile sla-dela-100ms
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-rule sla-dela-100ms active-probe-params VOICE-VIDEO
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-rule sla-dela-100ms passive-probe-params violation-count 1
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-rule sla-dela-100ms passive-probe-params sampling-period 2000
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-rule sla-dela-100ms passive-probe-params sla-export-factor 25
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-rule sla-dela-100ms passive-probe-params type book-ended
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-rule sla-dela-100ms passive-probe-params sampling-frequency interval 200
   set groups srx-gwr-apbr-policy-config security advance-policy-based-routing sla-rule sla-dela-100ms passive-probe-params sampling-frequency ratio 10
   set groups srx-gwr-apbr-policy-config security application-tracking
   set groups srx-gwr-apbr-policy-config security zones security-zone Default application-tracking
   set groups srx-gwr-apbr-policy-config security zones security-zone Default advance-policy-based-routing-profile pr_apbr_Default
   set groups srx-gwr-cos-policy-config security policies from-zone <Default> to-zone <trust> policy <*> then permit application-services application-traffic-control rule-set pr_cos_Default
   set groups srx-gwr-cos-policy-config security policies from-zone <Default> to-zone <untrust> policy <*> then permit application-services application-traffic-control rule-set pr_cos_Default
   set groups srx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-1_s_sla-dela-100ms match application junos:CNN
   set groups srx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-1_s_sla-dela-100ms match application junos:SSH
   set groups srx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-1_s_sla-dela-100ms then forwarding-class VOICE-VIDEO
   set groups srx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-1_s_sla-dela-100ms then dscp-code-point af41
   set groups srx-gwr-cos-policy-config class-of-service application-traffic-control rule-sets pr_cos_Default rule r_cos_d_Default_p_Intent-1_s_sla-dela-100ms then log
   set apply-groups global
   set apply-groups srx-gwr-site-routing-config-192.168.210.3
   set apply-groups dept-configuration
   set apply-groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0
   set apply-groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0
   set apply-groups realtimetenant_SDWANSITE1_WAN_0_HUB1_WAN_0_GRE_IPSEC_0
   set apply-groups realtimetenant_SDWANSITE1_WAN_1_HUB1_WAN_1_GRE_IPSEC_0
   set apply-groups dg-hub1
   set apply-groups spoke-realtimetenant_DefaultVPN-vpn-routing-config
   set apply-groups spoke-policy-default
   set apply-groups app-qoe-sdwansite1
   set apply-groups srx-gwr-apbr-policy-config
   set apply-groups srx-gwr-cos-policy-config
   set system host-name CV2116AF0288.sdwansite1.realtimetenant
   set system time-zone Europe/Amsterdam
   set system default-address-selection
   set system no-redirects
   set system authentication-order password
   set system root-authentication encrypted-password "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0"
   set system name-server 192.168.10.10
   set system name-server 8.8.8.8
   set system login announcement "This system is private property."
   set system login message "Unauthorized access will be reported."
   set system login retry-options tries-before-disconnect 3
   set system login retry-options backoff-threshold 2
   set system login retry-options backoff-factor 5
   set system login retry-options maximum-time 20
   set system login retry-options lockout-period 5
   set system login class admin idle-timeout 10
   set system login class admin permissions all
   set system login user cspuser uid 2000
   set system login user cspuser class admin
   set system login user cspuser authentication ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnuFJiRc63GdQfw6eqO7VmZBDuGFPB50JLFZm0hWyJW7FoDhRrJsgU7wnFRpO6MqxwDZ7iYbo9L31uEo6xkDyMKvtKj7xAn7DLOILUCRNZB9PZUwI6l8VodFDJH/O/bXndQgsKUau0edVsx8UkkgJlW4kM9SmKZ1/wFsoKju73kofkOjWAqxQb/utniT/a7Gv3+Chk1PNqBCZuX41kW59jzmOsYDKGZgWCwsLbX2rtdvGL0CZWqQKksQrJqWgtFVtj+mSsClfesDBGFZxIhh5H02EK8F8U1OiksKSsZiqtoImz6YPqisGnjHt6XE+Ap4MFn41GWRbZPM0jxVwxNeQR"
   set system login user juniper uid 2002
   set system login user juniper class admin
   set system login user juniper authentication encrypted-password "$1$X.14$Ejpov8GfKbZLPN9r7a2kn0"
   set system services ssh root-login allow
   set system services ssh no-tcp-forwarding
   set system services ssh protocol-version v2
   set system services ssh client-alive-count-max 5
   set system services ssh client-alive-interval 60
   set system services ssh connection-limit 50
   set system services ssh rate-limit 50
   set system services netconf ssh connection-limit 49
   set system services netconf ssh rate-limit 49
   set system services netconf rfc-compliant
   set system services outbound-ssh client CSO-52b4faae-3110-11e9-b405-0242ac10103b device-id 11563ec5-aa37-4c5b-8f8b-2f756cdfa0d2.JUNOS
   set system services outbound-ssh client CSO-52b4faae-3110-11e9-b405-0242ac10103b secret "$9$BM1ISrevWNVw8LUjHqQz69ApIEXxNdVYuOxNbs4oP5TQ/Cu0Iyev5QO1IhrlLxN-24JZjmfTZGqfz39CWLXNs2aJDq.5-Vwg4oGUk.PTn/"
   set system services outbound-ssh client CSO-52b4faae-3110-11e9-b405-0242ac10103b keep-alive
   set system services outbound-ssh client CSO-52b4faae-3110-11e9-b405-0242ac10103b services netconf
   set system services outbound-ssh client CSO-52b4faae-3110-11e9-b405-0242ac10103b 192.168.10.42 port 7804
   set system syslog user * any emergency
   set system syslog host 192.168.10.47 authorization any
   set system syslog host 192.168.10.47 daemon warning
   set system syslog host 192.168.10.47 port 514
   set system syslog host 192.168.10.47 structured-data
   set system syslog file messages any any
   set system syslog file messages authorization info
   set system syslog file messages archive size 10m
   set system syslog file messages archive files 10
   set system syslog file interactive-commands interactive-commands any
   set system syslog file interactive-commands archive size 10m
   set system syslog file interactive-commands archive files 10
   set system license autoupdate url https://ae1.juniper.net/junos/key_retrieval
   set services application-identification application jun-appqoe priority high
   set services application-identification application jun-appqoe address-mapping addr1 filter port-range udp 36000
   set security log utc-timestamp
   set security log mode stream
   set security log format sd-syslog
   set security log source-address 192.168.210.3
   set security log transport protocol tcp
   set security log stream app-track-logs format sd-syslog
   set security log stream app-track-logs category all
   set security log stream app-track-logs host 192.168.10.47
   set security log stream app-track-logs host port 3514
   set security log stream all-logs format sd-syslog
   set security log stream all-logs category all
   set security log stream all-logs host 192.168.10.47
   set security log stream all-logs host port 514
   set security ike proposal aes-256-gcm-PSK authentication-method pre-shared-keys
   set security ike proposal aes-256-gcm-PSK dh-group group14
   set security ike proposal aes-256-gcm-PSK encryption-algorithm aes-256-gcm
   set security ike proposal aes-256-cbc-PSK authentication-method pre-shared-keys
   set security ike proposal aes-256-cbc-PSK dh-group group14
   set security ike proposal aes-256-cbc-PSK authentication-algorithm sha-256
   set security ike proposal aes-256-cbc-PSK encryption-algorithm aes-256-cbc
   set security ike policy b176068e5d9ff006eb937442c56782c1 mode aggressive
   set security ike policy b176068e5d9ff006eb937442c56782c1 proposals aes-256-gcm-PSK
   set security ike policy b176068e5d9ff006eb937442c56782c1 proposals aes-256-cbc-PSK
   set security ike policy b176068e5d9ff006eb937442c56782c1 pre-shared-key ascii-text "$9$EcMyKWLXNs2oO1NVbsoa9Ctu018L7Vsgik01Rhle24oG.f69tu018XQ3n6AtsYg4JUqm5zF6iHyeWLdVws2oGj69tpO1aZm5TQ/9KvWLx-wsgDkm2g"
   set security ike policy 8dbe08be531dbdcd304049627e7e0879 mode aggressive
   set security ike policy 8dbe08be531dbdcd304049627e7e0879 proposals aes-256-gcm-PSK
   set security ike policy 8dbe08be531dbdcd304049627e7e0879 proposals aes-256-cbc-PSK
   set security ike policy 8dbe08be531dbdcd304049627e7e0879 pre-shared-key ascii-text "$9$IFMclvW8xbsguOx-dbg46/CtpOMWX-bYDipO1Ryrs2gJkm36CtpOM85z3nCAws2gaGk.fQznjiSlM8-dbwY4ZDn/ApO1aZm5TQ/9KvWLx-wsgDkm2g"
   set security ike gateway a3cc88fe25cc6137de117b0e479780c1 ike-policy b176068e5d9ff006eb937442c56782c1
   set security ike gateway a3cc88fe25cc6137de117b0e479780c1 address 192.168.190.254
   set security ike gateway a3cc88fe25cc6137de117b0e479780c1 dead-peer-detection interval 10
   set security ike gateway a3cc88fe25cc6137de117b0e479780c1 dead-peer-detection threshold 3
   set security ike gateway a3cc88fe25cc6137de117b0e479780c1 local-identity hostname OAM-SDWANSITE1_WAN_0_HUB1_WAN_0_IPSEC_0
   set security ike gateway a3cc88fe25cc6137de117b0e479780c1 external-interface ge-0/0/0.0
   set security ike gateway a3cc88fe25cc6137de117b0e479780c1 version v2-only
   set security ike gateway 57f1c23fa34111a85b19e864ed9eb101 ike-policy 8dbe08be531dbdcd304049627e7e0879
   set security ike gateway 57f1c23fa34111a85b19e864ed9eb101 address 192.168.191.254
   set security ike gateway 57f1c23fa34111a85b19e864ed9eb101 dead-peer-detection interval 10
   set security ike gateway 57f1c23fa34111a85b19e864ed9eb101 dead-peer-detection threshold 3
   set security ike gateway 57f1c23fa34111a85b19e864ed9eb101 local-identity hostname OAM-SDWANSITE1_WAN_1_HUB1_WAN_1_IPSEC_0
   set security ike gateway 57f1c23fa34111a85b19e864ed9eb101 external-interface ge-0/0/1.0
   set security ike gateway 57f1c23fa34111a85b19e864ed9eb101 version v2-only
   set security ipsec proposal 4d97f664a188a96387cb877f4b563fb8 protocol esp
   set security ipsec proposal 4d97f664a188a96387cb877f4b563fb8 encryption-algorithm aes-256-gcm
   set security ipsec proposal 9c1a38ae438299b4d727b6733efeb381 protocol esp
   set security ipsec proposal 9c1a38ae438299b4d727b6733efeb381 authentication-algorithm hmac-sha-256-128
   set security ipsec proposal 9c1a38ae438299b4d727b6733efeb381 encryption-algorithm aes-256-cbc
   set security ipsec policy c4c9320690b88d0c57bdd6e5825e5702 perfect-forward-secrecy keys group14
   set security ipsec policy c4c9320690b88d0c57bdd6e5825e5702 proposals 4d97f664a188a96387cb877f4b563fb8
   set security ipsec policy c4c9320690b88d0c57bdd6e5825e5702 proposals 9c1a38ae438299b4d727b6733efeb381
   set security ipsec vpn cf0622f0981c9db2388b4ff1645b9e72 bind-interface st0.4000
   set security ipsec vpn cf0622f0981c9db2388b4ff1645b9e72 ike gateway a3cc88fe25cc6137de117b0e479780c1
   set security ipsec vpn cf0622f0981c9db2388b4ff1645b9e72 ike proxy-identity local 10.176.0.41/31
   set security ipsec vpn cf0622f0981c9db2388b4ff1645b9e72 ike proxy-identity remote 10.176.0.40/31
   set security ipsec vpn cf0622f0981c9db2388b4ff1645b9e72 ike ipsec-policy c4c9320690b88d0c57bdd6e5825e5702
   set security ipsec vpn cf0622f0981c9db2388b4ff1645b9e72 establish-tunnels immediately
   set security ipsec vpn d18e78888ca9e2b7f6bb26ec072eb52c bind-interface st0.4001
   set security ipsec vpn d18e78888ca9e2b7f6bb26ec072eb52c ike gateway 57f1c23fa34111a85b19e864ed9eb101
   set security ipsec vpn d18e78888ca9e2b7f6bb26ec072eb52c ike proxy-identity local 10.176.0.43/31
   set security ipsec vpn d18e78888ca9e2b7f6bb26ec072eb52c ike proxy-identity remote 10.176.0.42/31
   set security ipsec vpn d18e78888ca9e2b7f6bb26ec072eb52c ike ipsec-policy c4c9320690b88d0c57bdd6e5825e5702
   set security ipsec vpn d18e78888ca9e2b7f6bb26ec072eb52c establish-tunnels immediately
   set security address-book global address ls-10.88.88.0/24-sdwansite1-desktop2 10.88.88.0/24
   set security address-book global address ls-10.77.77.0/24-sdwansite3-desktop3 10.77.77.0/24
   set security address-book global address ls-10.66.66.0/24-sdwansite2-desktop4 10.66.66.0/24
   set security advance-policy-based-routing tunables enable-logging
   set security application-tracking
   set security flow allow-dns-reply
   set security flow allow-embedded-icmp
   set security flow tcp-mss all-tcp mss 1350
   set security flow tcp-mss ipsec-vpn mss 1200
   set security flow tcp-session no-syn-check
   set security flow tcp-session no-syn-check-in-tunnel
   set security flow tcp-session no-sequence-check
   set security screen ids-option untrust-screen icmp ip-sweep
   set security screen ids-option untrust-screen icmp fragment
   set security screen ids-option untrust-screen icmp flood threshold 1000
   set security screen ids-option untrust-screen icmp ping-death
   set security screen ids-option untrust-screen ip bad-option
   set security screen ids-option untrust-screen ip source-route-option
   set security screen ids-option untrust-screen ip unknown-protocol
   set security screen ids-option untrust-screen ip tear-drop
   set security screen ids-option untrust-screen tcp syn-fin
   set security screen ids-option untrust-screen tcp fin-no-ack
   set security screen ids-option untrust-screen tcp tcp-no-flag
   set security screen ids-option untrust-screen tcp syn-frag
   set security screen ids-option untrust-screen tcp port-scan threshold 1000
   set security screen ids-option untrust-screen tcp syn-flood alarm-threshold 1024
   set security screen ids-option untrust-screen tcp syn-flood attack-threshold 200
   set security screen ids-option untrust-screen tcp syn-flood source-threshold 1024
   set security screen ids-option untrust-screen tcp syn-flood destination-threshold 2048
   set security screen ids-option untrust-screen tcp syn-flood queue-size 2000
   set security screen ids-option untrust-screen tcp syn-flood timeout 20
   set security screen ids-option untrust-screen tcp land
   set security screen ids-option untrust-screen tcp winnuke
   set security screen ids-option untrust-screen tcp tcp-sweep threshold 1000
   set security screen ids-option untrust-screen udp udp-sweep threshold 1000
   set security nat source rule-set underlay-mgmt-traffic-nat from routing-instance default
   set security nat source rule-set underlay-mgmt-traffic-nat to zone untrust
   set security nat source rule-set underlay-mgmt-traffic-nat rule r1 match source-address 192.168.210.3/32
   set security nat source rule-set underlay-mgmt-traffic-nat rule r1 then source-nat interface
   set security nat source rule-set Zone_Default-IF_ge-0010 from zone Default
   set security nat source rule-set Zone_Default-IF_ge-0010 to interface ge-0/0/1.0
   set security nat source rule-set Zone_Default-IF_ge-0010 rule AutoNAT-Default-ge-0010 match destination-address 0.0.0.0/0
   set security nat source rule-set Zone_Default-IF_ge-0010 rule AutoNAT-Default-ge-0010 then source-nat interface
   set security policies from-zone trust to-zone untrust policy allow_all match source-address any
   set security policies from-zone trust to-zone untrust policy allow_all match destination-address any
   set security policies from-zone trust to-zone untrust policy allow_all match application any
   set security policies from-zone trust to-zone untrust policy allow_all then permit
   set security policies from-zone trust to-zone trust policy allow_all match source-address any
   set security policies from-zone trust to-zone trust policy allow_all match destination-address any
   set security policies from-zone trust to-zone trust policy allow_all match application any
   set security policies from-zone trust to-zone trust policy allow_all then permit
   set security policies from-zone oam to-zone oam policy allow_all match source-address any
   set security policies from-zone oam to-zone oam policy allow_all match destination-address any
   set security policies from-zone oam to-zone oam policy allow_all match application any
   set security policies from-zone oam to-zone oam policy allow_all then permit
   set security policies from-zone Default to-zone trust policy appQoe-36600-Permit-rule match source-address any
   set security policies from-zone Default to-zone trust policy appQoe-36600-Permit-rule match destination-address any
   set security policies from-zone Default to-zone trust policy appQoe-36600-Permit-rule match application appQoe-36000
   set security policies from-zone Default to-zone trust policy appQoe-36600-Permit-rule then permit
   set security policies from-zone Default to-zone trust policy Intent_2__2 match source-address ls-10.88.88.0/24-sdwansite1-desktop2
   set security policies from-zone Default to-zone trust policy Intent_2__2 match destination-address ls-10.77.77.0/24-sdwansite3-desktop3
   set security policies from-zone Default to-zone trust policy Intent_2__2 match destination-address ls-10.66.66.0/24-sdwansite2-desktop4
   set security policies from-zone Default to-zone trust policy Intent_2__2 match application any
   set security policies from-zone Default to-zone trust policy Intent_2__2 then permit
   set security policies from-zone Default to-zone trust policy Intent_1__0 match source-address ls-10.88.88.0/24-sdwansite1-desktop2
   set security policies from-zone Default to-zone trust policy Intent_1__0 match destination-address any
   set security policies from-zone Default to-zone trust policy Intent_1__0 match application any
   set security policies from-zone Default to-zone trust policy Intent_1__0 then permit
   set security policies from-zone trust to-zone Default policy appQoe-36600-Permit-rule match source-address any
   set security policies from-zone trust to-zone Default policy appQoe-36600-Permit-rule match destination-address any
   set security policies from-zone trust to-zone Default policy appQoe-36600-Permit-rule match application appQoe-36000
   set security policies from-zone trust to-zone Default policy appQoe-36600-Permit-rule then permit
   set security policies from-zone trust to-zone Default policy Intent_2__1 match source-address ls-10.77.77.0/24-sdwansite3-desktop3
   set security policies from-zone trust to-zone Default policy Intent_2__1 match source-address ls-10.66.66.0/24-sdwansite2-desktop4
   set security policies from-zone trust to-zone Default policy Intent_2__1 match destination-address ls-10.88.88.0/24-sdwansite1-desktop2
   set security policies from-zone trust to-zone Default policy Intent_2__1 match application any
   set security policies from-zone trust to-zone Default policy Intent_2__1 then permit
   set security policies from-zone Default to-zone Default policy Intent_2__0 match source-address ls-10.88.88.0/24-sdwansite1-desktop2
   set security policies from-zone Default to-zone Default policy Intent_2__0 match destination-address ls-10.88.88.0/24-sdwansite1-desktop2
   set security policies from-zone Default to-zone Default policy Intent_2__0 match application any
   set security policies from-zone Default to-zone Default policy Intent_2__0 then permit
   set security policies from-zone Default to-zone untrust policy Intent_1__1 match source-address ls-10.88.88.0/24-sdwansite1-desktop2
   set security policies from-zone Default to-zone untrust policy Intent_1__1 match destination-address any
   set security policies from-zone Default to-zone untrust policy Intent_1__1 match application any
   set security policies from-zone Default to-zone untrust policy Intent_1__1 then permit
   set security policies default-policy deny-all
   set security policies policy-rematch
   set security zones security-zone trust tcp-rst
   set security zones security-zone trust host-inbound-traffic system-services all
   set security zones security-zone trust host-inbound-traffic protocols all
   set security zones security-zone oam host-inbound-traffic system-services all
   set security zones security-zone oam host-inbound-traffic protocols all
   set security zones security-zone oam interfaces lo0.0
   set security zones security-zone oam interfaces st0.4000
   set security zones security-zone oam interfaces st0.4001
   set security zones security-zone untrust screen untrust-screen
   set security zones security-zone untrust host-inbound-traffic system-services dhcp
   set security zones security-zone untrust host-inbound-traffic system-services ike
   set security zones security-zone untrust host-inbound-traffic system-services ssh
   set security zones security-zone untrust host-inbound-traffic system-services ping
   set security zones security-zone untrust host-inbound-traffic protocols bgp
   set security zones security-zone untrust interfaces ge-0/0/0.0
   set security zones security-zone untrust interfaces ge-0/0/1.0
   set security zones security-zone Default application-tracking
   set interfaces ge-0/0/0 description WAN_0
   set interfaces ge-0/0/0 per-unit-scheduler
   set interfaces ge-0/0/0 unit 0 family inet filter group 2
   set interfaces ge-0/0/0 unit 0 family inet address 192.168.170.2/24
   set interfaces ge-0/0/1 description WAN_1
   set interfaces ge-0/0/1 per-unit-scheduler
   set interfaces ge-0/0/1 unit 0 family inet filter group 3
   set interfaces ge-0/0/1 unit 0 family inet address 192.168.173.2/24
   set interfaces fxp0 unit 0 family inet filter group 55
   set interfaces lo0 description "Loopback Interface"
   set interfaces lo0 unit 0 family inet filter input protect_re_ipv4
   set interfaces lo0 unit 0 family inet address 192.168.210.3/32
   set interfaces st0 per-unit-scheduler
   set interfaces st0 unit 4000 family inet filter group 2
   set interfaces st0 unit 4000 family inet address 10.176.0.41/31
   set interfaces st0 unit 4001 family inet filter group 2
   set interfaces st0 unit 4001 family inet address 10.176.0.43/31
   set routing-options static route 0.0.0.0/0 next-hop 192.168.170.1
   set routing-options static route 0.0.0.0/0 next-hop 192.168.173.1
   set routing-options static route 0.0.0.0/0 no-readvertise
   set routing-options static route 192.168.210.1/32 next-hop st0.4000
   set routing-options static route 192.168.210.1/32 next-hop st0.4001
   set routing-options static route 192.168.190.254/32 next-hop 192.168.170.1
   set routing-options static route 192.168.191.254/32 next-hop 192.168.173.1
   set routing-options autonomous-system 64512
   set protocols bgp group oam-bgp type internal
   set protocols bgp group oam-bgp local-address 192.168.210.3
   set protocols bgp group oam-bgp import prim-lp-import
   set protocols bgp group oam-bgp family inet unicast
   set protocols bgp group oam-bgp neighbor 192.168.210.1 export oam-route-export-prim
   set policy-options prefix-list re-ntp apply-path "system ntp server <*>"
   set policy-options prefix-list ntp-boot-server apply-path "system ntp boot-server <*>"
   set policy-options prefix-list ntp-servers_src apply-path "system ntp source-address <*>"
   set policy-options prefix-list tacacs-accounting apply-path "system accounting destination tacplus server <*>"
   set policy-options prefix-list re-ssh 192.168.10.0/24
   set policy-options prefix-list re-ssh 192.168.210.3/32
   set policy-options prefix-list bgp-neighbors apply-path "protocols bgp group <*> neighbor <*>"
   set policy-options prefix-list re-bgp-vrf apply-path "routing-instances <*> protocols bgp group <*> neighbor <*>"
   set policy-options prefix-list re-dns apply-path "system name-server <*>"
   set policy-options prefix-list loopback-ipv4 apply-path "interfaces lo0 unit 0 family inet address <*>"
   set policy-options prefix-list re-ospf apply-path "interfaces <*> unit <*> family inet address <*>"
   set policy-options prefix-list re-tacacs apply-path "system tacplus-server <*>"
   set policy-options prefix-list re-snmp 192.168.10.0/24
   set policy-options prefix-list csp-mgmnt-network 192.168.10.0/24
   set policy-options policy-statement oam-route-export term 1 from protocol direct
   set policy-options policy-statement oam-route-export term 1 from route-filter 192.168.210.3/32 exact
   set policy-options policy-statement oam-route-export term 1 then accept
   set policy-options policy-statement oam-route-export term default then reject
   set policy-options policy-statement oam-route-export-prim term 1 from protocol direct
   set policy-options policy-statement oam-route-export-prim term 1 from route-filter 192.168.210.3/32 exact
   set policy-options policy-statement oam-route-export-prim term 1 then community add Hub-Primary-Select
   set policy-options policy-statement oam-route-export-prim term 1 then accept
   set policy-options policy-statement oam-route-export-prim term default then reject
   set policy-options policy-statement prim-lp-import term 1 from next-hop 192.168.210.1
   set policy-options policy-statement prim-lp-import term 1 then local-preference 200
   set policy-options policy-statement prim-lp-import term 1 then accept
   set policy-options community Hub-Primary-Select members target:192.168.210.1:1
   set class-of-service interfaces ge-0/0/0 shaping-rate 1g
   set class-of-service interfaces ge-0/0/1 shaping-rate 1g
   set firewall family inet filter protect_re_ipv4 term bfd from source-prefix-list re-ospf
   set firewall family inet filter protect_re_ipv4 term bfd from source-prefix-list re-bgp-vrf
   set firewall family inet filter protect_re_ipv4 term bfd from protocol udp
   set firewall family inet filter protect_re_ipv4 term bfd from source-port 49152-65535
   set firewall family inet filter protect_re_ipv4 term bfd from destination-port 3784
   set firewall family inet filter protect_re_ipv4 term bfd from destination-port 4784
   set firewall family inet filter protect_re_ipv4 term bfd then count bfd
   set firewall family inet filter protect_re_ipv4 term bfd then accept
   set firewall family inet filter protect_re_ipv4 term ssh from interface-group 2
   set firewall family inet filter protect_re_ipv4 term ssh from interface-group 55
   set firewall family inet filter protect_re_ipv4 term ssh from protocol tcp
   set firewall family inet filter protect_re_ipv4 term ssh from port ssh
   set firewall family inet filter protect_re_ipv4 term ssh then count ssh
   set firewall family inet filter protect_re_ipv4 term ssh then accept
   set firewall family inet filter protect_re_ipv4 term outbound-ssh from interface-group 2
   set firewall family inet filter protect_re_ipv4 term outbound-ssh from interface-group 55
   set firewall family inet filter protect_re_ipv4 term outbound-ssh from source-prefix-list re-ssh
   set firewall family inet filter protect_re_ipv4 term outbound-ssh from protocol tcp
   set firewall family inet filter protect_re_ipv4 term outbound-ssh from port 7804
   set firewall family inet filter protect_re_ipv4 term outbound-ssh then count outbound-ssh
   set firewall family inet filter protect_re_ipv4 term outbound-ssh then accept
   set firewall family inet filter protect_re_ipv4 term cso-port-444-permit from interface-group 2
   set firewall family inet filter protect_re_ipv4 term cso-port-444-permit from interface-group 55
   set firewall family inet filter protect_re_ipv4 term cso-port-444-permit from source-prefix-list re-ssh
   set firewall family inet filter protect_re_ipv4 term cso-port-444-permit from protocol tcp
   set firewall family inet filter protect_re_ipv4 term cso-port-444-permit from port 444
   set firewall family inet filter protect_re_ipv4 term cso-port-444-permit then count cso-port-444
   set firewall family inet filter protect_re_ipv4 term cso-port-444-permit then accept
   set firewall family inet filter protect_re_ipv4 term icmp from protocol icmp
   set firewall family inet filter protect_re_ipv4 term icmp from icmp-type echo-request
   set firewall family inet filter protect_re_ipv4 term icmp from icmp-type echo-reply
   set firewall family inet filter protect_re_ipv4 term icmp from icmp-type unreachable
   set firewall family inet filter protect_re_ipv4 term icmp from icmp-type time-exceeded
   set firewall family inet filter protect_re_ipv4 term icmp then policer icmp
   set firewall family inet filter protect_re_ipv4 term icmp then count icmp
   set firewall family inet filter protect_re_ipv4 term icmp then accept
   set firewall family inet filter protect_re_ipv4 term trace-route from protocol udp
   set firewall family inet filter protect_re_ipv4 term trace-route from destination-port 33434-33523
   set firewall family inet filter protect_re_ipv4 term trace-route then policer tracert
   set firewall family inet filter protect_re_ipv4 term trace-route then accept
   set firewall family inet filter protect_re_ipv4 term dhcp from protocol udp
   set firewall family inet filter protect_re_ipv4 term dhcp from port 67
   set firewall family inet filter protect_re_ipv4 term dhcp from port 68
   set firewall family inet filter protect_re_ipv4 term dhcp then policer dhcp
   set firewall family inet filter protect_re_ipv4 term dhcp then count dhcp
   set firewall family inet filter protect_re_ipv4 term dhcp then accept
   set firewall family inet filter protect_re_ipv4 term bgp from source-prefix-list bgp-neighbors
   set firewall family inet filter protect_re_ipv4 term bgp from source-prefix-list re-bgp-vrf
   set firewall family inet filter protect_re_ipv4 term bgp from protocol tcp
   set firewall family inet filter protect_re_ipv4 term bgp from port bgp
   set firewall family inet filter protect_re_ipv4 term bgp then count bgp
   set firewall family inet filter protect_re_ipv4 term bgp then accept
   set firewall family inet filter protect_re_ipv4 term ntp-local from source-prefix-list re-ntp
   set firewall family inet filter protect_re_ipv4 term ntp-local from source-prefix-list loopback-ipv4
   set firewall family inet filter protect_re_ipv4 term ntp-local from protocol udp
   set firewall family inet filter protect_re_ipv4 term ntp-local from port ntp
   set firewall family inet filter protect_re_ipv4 term ntp-local then count ntp
   set firewall family inet filter protect_re_ipv4 term ntp-local then accept
   set firewall family inet filter protect_re_ipv4 term ike from interface-group 2
   set firewall family inet filter protect_re_ipv4 term ike from interface-group 3
   set firewall family inet filter protect_re_ipv4 term ike from protocol udp
   set firewall family inet filter protect_re_ipv4 term ike from destination-port 500
   set firewall family inet filter protect_re_ipv4 term ike from destination-port 4500
   set firewall family inet filter protect_re_ipv4 term ike then count ike
   set firewall family inet filter protect_re_ipv4 term ike then accept
   set firewall family inet filter protect_re_ipv4 term gre-oam from protocol udp
   set firewall family inet filter protect_re_ipv4 term gre-oam from source-port 49153
   set firewall family inet filter protect_re_ipv4 term gre-oam from destination-port 49153
   set firewall family inet filter protect_re_ipv4 term gre-oam then count gre-oam
   set firewall family inet filter protect_re_ipv4 term gre-oam then accept
   set firewall family inet filter protect_re_ipv4 term ospf from interface-group 1
   set firewall family inet filter protect_re_ipv4 term ospf from source-prefix-list re-ospf
   set firewall family inet filter protect_re_ipv4 term ospf from protocol ospf
   set firewall family inet filter protect_re_ipv4 term ospf then count ospf
   set firewall family inet filter protect_re_ipv4 term ospf then accept
   set firewall family inet filter protect_re_ipv4 term dns from interface-group 2
   set firewall family inet filter protect_re_ipv4 term dns from interface-group 3
   set firewall family inet filter protect_re_ipv4 term dns from prefix-list re-dns
   set firewall family inet filter protect_re_ipv4 term dns from protocol udp
   set firewall family inet filter protect_re_ipv4 term dns from port domain
   set firewall family inet filter protect_re_ipv4 term dns then policer dns-policer
   set firewall family inet filter protect_re_ipv4 term dns then count dns
   set firewall family inet filter protect_re_ipv4 term dns then accept
   set firewall family inet filter protect_re_ipv4 term https-discard from interface-group 1
   set firewall family inet filter protect_re_ipv4 term https-discard from protocol tcp
   set firewall family inet filter protect_re_ipv4 term https-discard from source-port https
   set firewall family inet filter protect_re_ipv4 term https-discard then count https-discard
   set firewall family inet filter protect_re_ipv4 term https-discard then discard
   set firewall family inet filter protect_re_ipv4 term https from protocol tcp
   set firewall family inet filter protect_re_ipv4 term https from source-port https
   set firewall family inet filter protect_re_ipv4 term https then count https
   set firewall family inet filter protect_re_ipv4 term https then accept
   set firewall family inet filter protect_re_ipv4 term http from interface-group 2
   set firewall family inet filter protect_re_ipv4 term http from protocol tcp
   set firewall family inet filter protect_re_ipv4 term http from source-port 8060
   set firewall family inet filter protect_re_ipv4 term http then count http
   set firewall family inet filter protect_re_ipv4 term http then accept
   set firewall family inet filter protect_re_ipv4 term external-syslog from source-prefix-list re-ssh
   set firewall family inet filter protect_re_ipv4 term external-syslog from protocol tcp
   set firewall family inet filter protect_re_ipv4 term external-syslog from protocol udp
   set firewall family inet filter protect_re_ipv4 term external-syslog from port 514
   set firewall family inet filter protect_re_ipv4 term external-syslog from port 3514
   set firewall family inet filter protect_re_ipv4 term external-syslog then count external-syslog
   set firewall family inet filter protect_re_ipv4 term external-syslog then accept
   set firewall family inet filter protect_re_ipv4 term default then count discard-count
   set firewall family inet filter protect_re_ipv4 term default then log
   set firewall family inet filter protect_re_ipv4 term default then discard
   set firewall policer icmp if-exceeding bandwidth-limit 1m
   set firewall policer icmp if-exceeding burst-size-limit 2k
   set firewall policer icmp then discard
   set firewall policer tracert if-exceeding bandwidth-limit 1m
   set firewall policer tracert if-exceeding burst-size-limit 15k
   set firewall policer tracert then discard
   set firewall policer dhcp if-exceeding bandwidth-limit 1m
   set firewall policer dhcp if-exceeding burst-size-limit 15k
   set firewall policer dhcp then discard
   set firewall policer dns-policer if-exceeding bandwidth-limit 1m
   set firewall policer dns-policer if-exceeding burst-size-limit 15k
   set firewall policer dns-policer then discard
   set applications application appQoe-36000 protocol udp
   set applications application appQoe-36000 destination-port 36000
   

Right now there should no be any Traffic across the Sites

|image670|

|image671|

|image672|

Add Firewall rules and deploy
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

It is important (similar to the LBO test case in chapter 7.1 above) to add TWO rules. One allowing Traffic towards Internet and one for Traffic across all Sites. If you don’t have already a proper rule-set then it’s now time to create it as below.

|image673|

The first rule allows Traffic from Spokes to the Internet.

|image674|

The second rule allows Traffic between your Spokes and is essential to build the Mesh Tunnels.

|image675|

When you have these two intents hit “Deploy”

|image676|

Wait and check that all FW-changes got distributed to all devices

|image677|

Traffic between Desktop VM’s and towards Internet
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

At the beginning of the Lab there should no be any Traffic across the Sites. This will display only the two Tunnels each Site will have to the Hub as below.

.. note:: The OAM and Data Tunnels to the Hub are static and will always be there (remember they are kind of last-resort/backup-links). The Mesh Tunnels as usually Dynamic and will be created/deleted on an as needed Basis!

|image678|

|image679|

|image680|

It is assumed you have not change the default values for the Dynamic VPN Tunnels but please review them here

|image681|

.. note:: The latency setting below on the delayvm is only there to be able to identify the Traffic flows via Hub OR LBO (>10ms) or the Spoke-to-Spoke (<10ms) Traffic which is direct between the virtual router on the QFX switch. It is NOT there to verify any SLA Parameters.

Enable Traffic latency on both paths via the Delay VM.

.. code-block:: none

   virsh console delayvm --force

   tc qdisc add dev eth0.132 root netem delay 10ms
   tc qdisc add dev eth0.135 root netem delay 10ms

**For all tests USE DESKTOP4** VM like we do here so you have the same Target-IP’s to test.

Check if you can send Traffic to the Internet using LBO and ping 8.8.8.8

|image682|

Review the that the Traffic is send to the Hub as we did not yet specify an SLA Profile to identify the Application-ICMP and told the system to use LBO for it.

.. code-block:: none

   ssh root@192.168.210.4
   cli
   
   show security flow session destination-prefix 8.8.8.8
   Session ID: 3962, Policy name: Intent_1__0/9, Timeout: 2, Valid
     In: 10.66.66.66/171 --> 8.8.8.8/6634;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/6634 --> 10.66.66.66/171;icmp, Conn Tag: 0x0, If: gr-0/0/0.4001, Pkts: 1, Bytes: 84,
   
   Session ID: 3964, Policy name: Intent_1__0/9, Timeout: 2, Valid
     In: 10.66.66.66/172 --> 8.8.8.8/6634;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/6634 --> 10.66.66.66/172;icmp, Conn Tag: 0x0, If: gr-0/0/0.4001, Pkts: 1, Bytes: 84,
   Total sessions: 2

Review that in the current state there are only two exitsing GRE Tunnels up to the Hub

.. code-block:: none

   show interfaces terse | match gr-
   gr-0/0/0                up    up
   gr-0/0/0.4001           up    up   inet     10.152.0.51/31
   gr-0/0/0.4002           up    up   inet     10.152.0.49/31

Review the routes from the LAN-Interface towards the rest

.. code-block:: none

   show route table LAN-realtimetenant_DefaultVPN

   LAN-realtimetenant_DefaultVPN.inet.0: 5 destinations, 7 routes (5 active, 0 holddown, 2 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 04:39:53, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 16
                         via gr-0/0/0.4001, Push 16
   10.66.66.0/24      *[Direct/0] 04:41:35
                       > via ge-0/0/4.1066
   10.66.66.1/32      *[Local/0] 04:41:35
                         Local via ge-0/0/4.1066
   10.77.77.0/24      *[BGP/170] 04:37:35, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4002, Push 18
                       > via gr-0/0/0.4001, Push 18
   10.88.88.0/24      *[BGP/170] 04:25:37, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4002, Push 18
                       > via gr-0/0/0.4001, Push 18

Now we will start a Ping that constantly runs and ping the Desktop2-vm (IP=10.88.88.88) that is on sdwanspoke1. We’ll let this run now:

|image683|

After ~2-3 minutes you see that from one packet to another (WITHOUT LOSING A SINGLE PING). The TTL changes and the Latency goes down as CSO has now build a direct Mesh Tunnel between the two Spokes and this will no longer flow thru the delayvm causing the artificial latency that we’ve configured.

|image684|

Now verify this on the sdwansite2 via CLI

.. code-block:: none

   show security flow session destination-prefix 10.88.88.88
   Session ID: 6925, Policy name: Intent_2__2/8, Timeout: 2, Valid
     In: 10.66.66.66/712 --> 10.88.88.88/6650;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 10.88.88.88/6650 --> 10.66.66.66/712;icmp, Conn Tag: 0x0, If: gr-0/0/0.4004, Pkts: 1, Bytes: 84,

   Session ID: 6927, Policy name: Intent_2__2/8, Timeout: 2, Valid
     In: 10.66.66.66/713 --> 10.88.88.88/6650;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 10.88.88.88/6650 --> 10.66.66.66/713;icmp, Conn Tag: 0x0, If: gr-0/0/0.4004, Pkts: 1, Bytes: 84,

   Session ID: 6929, Policy name: Intent_2__2/8, Timeout: 4, Valid
     In: 10.66.66.66/714 --> 10.88.88.88/6650;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 10.88.88.88/6650 --> 10.66.66.66/714;icmp, Conn Tag: 0x0, If: gr-0/0/0.4004, Pkts: 1, Bytes: 84,
   Total sessions: 3

   show interfaces terse | match gr-
   gr-0/0/0                up    up
   gr-0/0/0.4001           up    up   inet     10.152.0.51/31
   gr-0/0/0.4002           up    up   inet     10.152.0.49/31
   gr-0/0/0.4003           up    up   inet     10.0.72.7/31
   gr-0/0/0.4004           up    up   inet     10.0.64.7/31

   show route table LAN-realtimetenant_DefaultVPN

   LAN-realtimetenant_DefaultVPN.inet.0: 5 destinations, 7 routes (5 active, 0 holddown, 1 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 04:55:39, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 16
                         via gr-0/0/0.4001, Push 16
   10.66.66.0/24      *[Direct/0] 04:57:21
                       > via ge-0/0/4.1066
   10.66.66.1/32      *[Local/0] 04:57:21
                         Local via ge-0/0/4.1066
   10.77.77.0/24      *[BGP/170] 04:53:21, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4002, Push 18
                       > via gr-0/0/0.4001, Push 18
   10.88.88.0/24      *[BGP/170] 00:10:49, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4003, Push 16
                       > via gr-0/0/0.4004, Push 16
                       [BGP/170] 04:41:23, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4002, Push 18
                       > via gr-0/0/0.4001, Push 18

When you now look into the GUI you will see that

|image685|

|image686|

As as no other site talks to No.3 it remains the old picture

|image687|

|image688|

Now open another terminal on Desktop4 VM and send Pings to Desktop3 (IP=10.77.77.77) that is connected to sdwansite3

|image689|

You will make the similar observation. After ~2-3minutes CSO has installed direct Tunnels between the two Sites and as a result the ttl changes plus the latency gets shorter. Again no single Ping packet was lost in transit!

|image690|

Lets now verify this on the sdwansite2 again

.. code-block:: none

   show security flow session destination-prefix 10.77.77.77
   Session ID: 10021, Policy name: Intent_2__2/8, Timeout: 2, Valid
     In: 10.66.66.66/415 --> 10.77.77.77/6809;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 10.77.77.77/6809 --> 10.66.66.66/415;icmp, Conn Tag: 0x0, If: gr-0/0/0.4005, Pkts: 1, Bytes: 84,

   Session ID: 10024, Policy name: Intent_2__2/8, Timeout: 2, Valid
     In: 10.66.66.66/416 --> 10.77.77.77/6809;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 10.77.77.77/6809 --> 10.66.66.66/416;icmp, Conn Tag: 0x0, If: gr-0/0/0.4005, Pkts: 1, Bytes: 84,
   Total sessions: 2

   show interfaces terse | match gr-
   gr-0/0/0                up    up
   gr-0/0/0.4001           up    up   inet     10.152.0.51/31
   gr-0/0/0.4002           up    up   inet     10.152.0.49/31
   gr-0/0/0.4003           up    up   inet     10.0.72.7/31
   gr-0/0/0.4004           up    up   inet     10.0.64.7/31
   gr-0/0/0.4005           up    up   inet     10.0.104.8/31
   gr-0/0/0.4006           up    up   inet     10.0.96.8/31

   show route table LAN-realtimetenant_DefaultVPN

   LAN-realtimetenant_DefaultVPN.inet.0: 5 destinations, 7 routes (5 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 05:14:07, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 16
                         via gr-0/0/0.4001, Push 16
   10.66.66.0/24      *[Direct/0] 05:15:49
                       > via ge-0/0/4.1066
   10.66.66.1/32      *[Local/0] 05:15:49
                         Local via ge-0/0/4.1066
   10.77.77.0/24      *[BGP/170] 00:04:40, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4005, Push 16
                       > via gr-0/0/0.4006, Push 16
                       [BGP/170] 05:11:49, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4002, Push 18
                       > via gr-0/0/0.4001, Push 18
   10.88.88.0/24      *[BGP/170] 00:29:17, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4003, Push 16
                       > via gr-0/0/0.4004, Push 16
                       [BGP/170] 04:59:51, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4002, Push 18
                       > via gr-0/0/0.4001, Push 18

In the GUI you will see this state now

|image691|

|image692|

|image693|

|image694|

I’ll leave it to you what would happen if you go to Desktop2-VM connected to sdwansite1 and issue a constant ping to Desktop3-VM (IP=10.77.77.77) to create the full circle and have real full mesh.

.. note:: If you stop all these PING’s between the Spoke Subnets the tunnels SHOULD (in theory) be deleted after >900seconds/15minutes as that’s the default. However inside the device template there is a Parameter that prevents this from happen automatically for this Lab setup as we don’t have enough Devices!

.. warning:: You will not see any automatic Tunnel deletions because of this Parameter default in the Device Template below!

This parameter will only start to deleted Tunnels if you are above a 100 of them. It’s set to this value to prevent curn form to many unneeded operations.

|image695|

I

**This was demonstrating the Dynamic Tunnels that will be build between Spokes on an as needed basis.**

If you want you can now configure local breakout rules for matching Traffic. In this case we use ICMP.

Now lets create an SLA profile that steers ALL the Traffic to LBO as this is just a test

|image696|

Review your new Profile

|image697|

Deploy the Profile

|image698|

Once your Profile is deployed to all Sites start a Ping to the Internnet again from Desktop4.

|image699|

Review that the traffic no longer flows thru a GRE-Tunnel and in this case exits on a ge-interface while being NATed

.. code-block:: none

   show security flow session destination-prefix 8.8.8.8
   Session ID: 14622, Policy name: Intent_1__1/13, Timeout: 2, Valid
     In: 10.66.66.66/164 --> 8.8.8.8/6973;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/6973 --> 192.168.133.2/25061;icmp, Conn Tag: 0x0, If: ge-0/0/3.0, Pkts: 1, Bytes: 84,
   
   Session ID: 14623, Policy name: Intent_1__1/13, Timeout: 2, Valid
     In: 10.66.66.66/165 --> 8.8.8.8/6973;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/6973 --> 192.168.133.2/25024;icmp, Conn Tag: 0x0, If: ge-0/0/3.0, Pkts: 1, Bytes: 84,
   
   Session ID: 14624, Policy name: Intent_1__1/13, Timeout: 4, Valid
     In: 10.66.66.66/166 --> 8.8.8.8/6973;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/6973 --> 192.168.133.2/5922;icmp, Conn Tag: 0x0, If: ge-0/0/3.0, Pkts: 1, Bytes: 84,
   
   Session ID: 14625, Policy name: Intent_1__1/13, Timeout: 4, Valid
     In: 10.66.66.66/167 --> 8.8.8.8/6973;icmp, Conn Tag: 0x0, If: ge-0/0/4.1066, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/6973 --> 192.168.133.2/4365;icmp, Conn Tag: 0x0, If: ge-0/0/3.0, Pkts: 1, Bytes: 84,
   Total sessions: 4

Also the routing table on the Lan side of the Spoke changes to support this configuration

.. code-block:: none

   show route table LAN-realtimetenant_DefaultVPN

   LAN-realtimetenant_DefaultVPN.inet.0: 6 destinations, 9 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/11] 00:12:00, metric2 0
                       > to table internet-lbo-realtimetenant_DefaultVPN.inet.0
                       [BGP/170] 05:57:59, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 16
                         via gr-0/0/0.4001, Push 16
   10.66.66.0/24      *[Direct/0] 05:59:41
                       > via ge-0/0/4.1066
   10.66.66.1/32      *[Local/0] 05:59:41
                         Local via ge-0/0/4.1066
   10.77.77.0/24      *[BGP/170] 00:48:32, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4005, Push 16
                       > via gr-0/0/0.4006, Push 16
                       [BGP/170] 05:55:41, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4002, Push 18
                       > via gr-0/0/0.4001, Push 18
   10.88.88.0/24      *[BGP/170] 01:13:09, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4003, Push 16
                       > via gr-0/0/0.4004, Push 16
                       [BGP/170] 05:43:43, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4002, Push 18
                       > via gr-0/0/0.4001, Push 18
   172.31.32.18/32    *[Static/5] 00:12:00
                         to table internet-lbo-realtimetenant_DefaultVPN.inet.0

Last but not least use the Delay VM to the the Packtes in clear text on the breakout path to the Internet

.. code-block:: none

   virsh console delayvm --force

   tcpdump -ni eth0.135 host 8.8.8.8 -c 8
   tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
   listening on eth0.135, link-type EN10MB (Ethernet), capture size 262144 bytes
   17:22:24.391648 IP 192.168.133.2 > 8.8.8.8: ICMP echo request, id 6973, seq 11683, length 64
   17:22:24.399143 IP 8.8.8.8 > 192.168.133.2: ICMP echo reply, id 6973, seq 11683, length 64
   17:22:25.393074 IP 192.168.133.2 > 8.8.8.8: ICMP echo request, id 6973, seq 27062, length 64
   17:22:25.400307 IP 8.8.8.8 > 192.168.133.2: ICMP echo reply, id 6973, seq 27062, length 64
   17:22:26.394365 IP 192.168.133.2 > 8.8.8.8: ICMP echo request, id 6973, seq 13321, length 64
   17:22:26.402428 IP 8.8.8.8 > 192.168.133.2: ICMP echo reply, id 6973, seq 13321, length 64
   17:22:27.395324 IP 192.168.133.2 > 8.8.8.8: ICMP echo request, id 6973, seq 10784, length 64
   17:22:27.403433 IP 8.8.8.8 > 192.168.133.2: ICMP echo reply, id 6973, seq 10784, length 64
   
   #
   # DO NOT FORGET: Remove the link delays you have set
   #

   tc qdisc del dev eth0.132 root netem
   tc qdisc del dev eth0.135 root netem

**STATIC Tunnels**

It is also possible that you MANUALLY setup STATIC Tunnels between Spoke devices.

There is a new option in GUI that allows you to set this up as you see in the example below. Go to this screen first:

|image700|

Then scroll down on the RIGHT-Pane:

|image701|

Use the ADD-Button on the “On-Demand VPN Tunnels” Field and fill out the Field as appropriate.

|image702|

As you see you can also trigger the deletion of existing Tunnels through this dialogue (as it won’t happen in this Lab automatically).

|image703|

|image704|

Partial Mesh AND Site-Gateway
-----------------------------

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. This will **SAVE** you huge amount of **TIME** and will guarantee that the lab configuration is in **PROPER STATE**. It will **AVOID** any **MISCONFIGURATION** you do via manual cut&paste.

If you want to bring this lab into this state you should click here:

|image705|

.. note:: As you see it will take care to apply the changes from chapter 7.8.1 and chapter 7.8.2 so you can jump over those.

In this chapter the focus is on the new Site-Gateway. However for the benefit of this Demo we also use more Mesh-Tags to show the Power of them and help to understand more of their nature.

|image706|

.. warning:: The underlay setup and how you have to bring-up the initial start-up configuration is a copy of previous chapter 7.7.1 above to chapter 7.7.4 above including. If you have not done it before you need to execute those chapters now before you can continue. If you have already executed chapter 7.7 above just delete all three sites as we will give them a new configuration.

If you have existing SD-WAN SLA’s please delete them as well

|image707|

Changes on underlay to support hub2 as Site-GW
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. If you have applied the changes from executing the “Partial Mesh & Site-GW” then you can ignore this section.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

On the QFX5100 we need the following changes to use hub2 as a site-gw for this lab

.. code-block:: none

   # cleanup existing settings that may interfere
   delete apply-groups sdwan-hubredunant
   delete groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.204.254
   
   delete interfaces xe-0/0/42
   delete protocols rstp interface xe-0/0/42
   set groups sdwan-sitegw interfaces xe-0/0/42 unit 0 family inet address 192.168.200.1/24
   set groups sdwan-sitegw routing-instances hub-wan0 interface xe-0/0/42.0
   
   delete interfaces xe-0/0/43
   delete protocols rstp interface xe-0/0/43
   set groups sdwan-sitegw interfaces xe-0/0/43 unit 0 family inet address 192.168.201.1/24
   set groups sdwan-sitegw routing-instances hub-wan1 interface xe-0/0/43.0
   
   # also make sure the other interfaces towards SRX1500-2 unused in this demo are disabled
   set groups sdwan-sitegw interfaces xe-0/0/44 disable
   set groups sdwan-sitegw interfaces xe-0/0/45 disable
   set groups sdwan-sitegw interfaces xe-0/0/46 disable
   
   set apply-groups sdwan-sitegw
   commit and-quit

Add Site-Gateway
~~~~~~~~~~~~~~~~

.. warning:: **USE THE LAB AUTOMATION** from chapter 8.15 below. If you have applied the changes from executing the “Partial Mesh & Site-GW” then you can ignore this section.

.. note:: The information below applies if you have not used the lab automation or need to do things manually for some reason.

.. note:: If you happen to have an SRX4x00 as hub2/site-gw then ZTP is not possible and you have to use Stage-1 apply manually as before.

.. warning:: It is mandatory (today) to have the first Site-GW onboarded and ready before you launch any other Sites.

Usually the second srx1500 is not designed to be provisioned via a full ZTP. So we have to add a phone-home sever and load our default certificate to be able to get this process started.

.. code-block:: none

   cli
   edit
   set system phone-home server https://centralmsvm.example.net
   set system phone-home ca-certificate-file /var/tmp/ssl_cert.crt
   set system phone-home rfc-complaint
   set system name-server 192.168.10.10
   #
   set interfaces ge-0/0/1 unit 0 family inet address 192.168.201.254/24
   set security zones security-zone untrust interfaces ge-0/0/1.0
   set routing-options static route 0.0.0.0/0 next-hop 192.168.201.1
   set routing-options static route 0.0.0.0/0 no-readvertise
   #
   # Also the following routes help in your environment to ensure the right path is used as we don’t have a routing protocol helping us.
   #
   set routing-options static route 192.168.130.0/24 next-hop 192.168.200.1
   set routing-options static route 192.168.130.0/24 no-readvertise
   set routing-options static route 192.168.133.0/24 next-hop 192.168.201.1
   set routing-options static route 192.168.133.0/24 no-readvertise
   set routing-options static route 192.168.150.0/24 next-hop 192.168.200.1
   set routing-options static route 192.168.150.0/24 no-readvertise
   set routing-options static route 192.168.153.0/24 next-hop 192.168.201.1
   set routing-options static route 192.168.153.0/24 no-readvertise
   set routing-options static route 192.168.170.0/24 next-hop 192.168.200.1
   set routing-options static route 192.168.170.0/24 no-readvertise
   set routing-options static route 192.168.173.0/24 next-hop 192.168.201.1
   set routing-options static route 192.168.173.0/24 no-readvertise
   
   # MUST: delete the direct route towards CSO
   delete routing-options static route 192.168.10.0/24 next-hop 192.168.200.1
   delete routing-options static route 192.168.10.0/24 no-readvertise
   
   commit and-quit
   
   start shell
   # You can also load the certificate from the centralmsvm /etc/pki/tls/certs/ssl_cert.crt and append it to this file instead of put&pasteing it here
   # scp root@192.168.10.42:/etc/pki/tls/certs/ssl_cert.crt /var/tmp/ssl_cert.crt
   # As explaind this is needed if you don’t have an nfxweb account

   cat <<EOF >>/var/tmp/ssl_cert.crt
   -----BEGIN CERTIFICATE-----
   MIIDrjCCApYCCQDZ8BNWtFex/DANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMC
   VVMxCzAJBgNVBAgMAkNBMRkwFwYDVQQKDBBKdW5pcGVyIE5ldHdvcmtzMRIwEAYD
   VQQHDAlTdW5ueXZhbGUxIDAeBgNVBAMMF2NlbnRyYWxtc3ZtLmV4YW1wbGUubmV0
   MQwwCgYDVQQLDANDU1AxHTAbBgkqhkiG9w0BCQEWDnRlc3RAZW1haWwubmV0MB4X
   DTE4MDcxMjEzMDYwNFoXDTIxMDQwNjEzMDYwNFowgZgxCzAJBgNVBAYTAlVTMQsw
   CQYDVQQIDAJDQTEZMBcGA1UECgwQSnVuaXBlciBOZXR3b3JrczESMBAGA1UEBwwJ
   U3Vubnl2YWxlMSAwHgYDVQQDDBdjZW50cmFsbXN2bS5leGFtcGxlLm5ldDEMMAoG
   A1UECwwDQ1NQMR0wGwYJKoZIhvcNAQkBFg50ZXN0QGVtYWlsLm5ldDCCASIwDQYJ
   KoZIhvcNAQEBBQADggEPADCCAQoCggEBAKtiYIRnR2Yq0eE/aqGTu+7MDFjxpjWX
   3CNf+yiNpG+dxtCcEXNrq1//UiBdPJlcKXq5mNOY359O0ueQrFhwPqaRwXoC04lR
   /W+2wLwse0ePeweQ0hd6GTQWAOjRfyQew+DZp31W10YDRSc8qzZTkgnYWqBJVFt/
   MnKgWNj8R50l0DK+nPhzDgo3iHVQh1M4x2muI238GSOJOsZNyOf0bUfj8Yti89AN
   wLIuQvbxaxP1qpbwRNK8ciA4DQr7RczNBVT4rsqw4GM3Hqtic7umM/EOQ1RCTjiU
   uGd56FkIqkkYGQ8nMWh7Uxfo1d+G8wjFXBUE6pxsMicU9DmZEKDix9ECAwEAATAN
   BgkqhkiG9w0BAQsFAAOCAQEAICz4G05p96lQToWDLf86XK24m8YtTAMZlckcErCx
   h2nQEDbiltSwspiaeyyenoAnK5KmGR6ijZDFuNIr5GIjbjx9RgrOLBacNDBous8Q
   C77w9BmCZB0TSuGMFeeV07A0lSEqoc2wX89Pic7rchb3LorJKE+ZEB0U2fppXp2o
   y8LnqX6ZgYH9QD5FBbVyTK0sw1aqPP/pRsv6Pa9mfvKivNPzfERJiFJkNdqvIj39
   iwUuwJUF3sN6cdKMj8s1irYnNhsB62M2pNFOCtvzIe+xLhbMlNEY1Qoiyk+KJOvZ
   fzX+nt1TrRi7zq+yGFSkOQ4kwAiWxSPUCZOcGLTjUd1G/Q==
   -----END CERTIFICATE-----
   EOF

   cli
   show route

   inet.0: 12 destinations, 12 routes (12 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:01:11
                       > to 192.168.201.1 via ge-0/0/1.0
   192.168.130.0/24   *[Static/5] 00:01:17
                       > to 192.168.200.1 via ge-0/0/0.0
   192.168.133.0/24   *[Static/5] 00:01:11
                       > to 192.168.201.1 via ge-0/0/1.0
   192.168.150.0/24   *[Static/5] 00:01:17
                       > to 192.168.200.1 via ge-0/0/0.0
   192.168.153.0/24   *[Static/5] 00:01:11
                       > to 192.168.201.1 via ge-0/0/1.0
   192.168.170.0/24   *[Static/5] 00:01:17
                       > to 192.168.200.1 via ge-0/0/0.0
   192.168.173.0/24   *[Static/5] 00:01:11
                       > to 192.168.201.1 via ge-0/0/1.0
   192.168.200.0/24   *[Direct/0] 4d 17:59:33
                       > via ge-0/0/0.0
   192.168.200.254/32 *[Local/0] 4d 17:59:36
                         Local via ge-0/0/0.0
   192.168.201.0/24   *[Direct/0] 00:01:11
                       > via ge-0/0/1.0
   192.168.201.254/32 *[Local/0] 00:01:11
                         Local via ge-0/0/1.0
   
   # Mandatory to get the phone-home server up and running
   request system reboot
   yes

Now we need to provision our site-gw note that it is assumed that:

-  A cloudhub is created
-  The realtime-tenant is created
-  The hub-object is included in the realtime-tenant

|image708|

So let’s start with our Site-GW now:

|image709|

|image710|

|image711|

|image712|

|image713|

The BIG difference with this special Spoke-Type is the ability to define Routing Protocols (BGP and OSPF) instead of static-subnets for a lan-port to be added. Here we use Lan-4 (ge-0/0/4) to be able to talk BGP with the underlay environment (bgp-underlay config will be added later)

|image714|

Make sure that you create a NEW Department. You see there is a special type “Data Center Department=True” below.

|image715|

|image716|

This bgp config will be completed later. For now just fill in these values.

|image717|

|image718|

.. code-block:: none

   
   {
      "input":{
         "tenant_name":"realtimetenant",
         "deployment_scenario":"managed_wan_v2",
         "site":[
            {
               "site_name":"sdwansitegw",
               "site_basic_properties":{
                  "0":{
                     "protocol":"ebgp",
                     "dhcp":false,
                     "department":"datacenter",
                     "lan_ports":[
                        "LAN_4"
                     ],
                     "lan_segment_name":"headquarter",
                     "ip_prefix":"192.168.204.254/24",
                     "bgp":{
                        "peer_ip_address":"192.168.204.1",
                        "peer_as_number":"65100"
                     },
                     "authentication_mode":"NONE",
                     "routing_segment":true
                  },
                  "topology":"Real-Time Optimized",
                  "sla_mgmt":"FINE",
                  "network_seg":false,
                  "gatewaySite":true,
                  "site_role":"SPOKE",
                  "site_address":{
                     "country":"US"
                  },
                  "site_group":null,
                  "site_name":"sdwansitegw",
                  "device_redundancy":false,
                  "device_profile_name":"SRX as SD-WAN CPE",
                  "cloud_service":"EDGE",
                  "site_type":"on_premise",
                  "dvpn_params":{
                     "create_dvpn_threshold":5,
                     "delete_dvpn_threshold":2
                  },
                  "on_premise_gateway":true,
                  "device_template":[
                     {
                        "template_name":"SRX_Advanced_SDWAN_CPE_option_1",
                        "device_name":"sdwansitegw",
                        "wan_link_info":[
                           {
                              "wan_link":"WAN_0",
                              "wan_link_type":"MPLS",
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"abc",
                              "cost":2222,
                              "_sys_reserved_row":"b0d4ac01-5ed8-e52d-106b-d0af9bd6b756",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           },
                           {
                              "wan_link":"WAN_1",
                              "wan_link_type":"Internet",
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"xyz",
                              "cost":111,
                              "_sys_reserved_row":"ff16047e-a246-8514-f609-cb857c0b8d21",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           }
                        ],
                        "lan_segment":[
                           {
                              "protocol":"ebgp",
                              "dhcp":false,
                              "department":"datacenter",
                              "lan_ports":[
                                 "LAN_4"
                              ],
                              "lan_segment_name":"headquarter",
                              "ip_prefix":"192.168.204.254/24",
                              "bgp":{
                                 "peer_ip_address":"192.168.204.1",
                                 "peer_as_number":"65100"
                              },
                              "authentication_mode":"NONE",
                              "routing_segment":true
                           }
                        ]
                     }
                  ]
               }
            }
         ]
      }
   }
   

|image719|

|image720|

|image721|

|image722|

|image723|

|image724|

|image725|

|image726|

.. code-block:: none

   
   {
      "input":{
         "job_name_prefix":"realtimetenant-sdwansitegw",
         "tenant_name":"realtimetenant",
         "site":[
            {
               "site_name":"sdwansitegw",
               "on_premise_site_info":{
                  "site_role":"spoke",
                  "ha_info":{
                     "ha_topology":"STANDALONE"
                  },
                  "device":[
                     {
                        "is_gateway_site":true,
                        "device_family":"juniper-srx",
                        "wan_link":[
                           {
                              "wan_link_name":"WAN_0",
                              "local_interface":"ge-0/0/0",
                              "wan_link_type":"MPLS",
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "MPLS"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_0",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.190.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.200.254/24",
                                 "gateway_ip":"192.168.200.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           },
                           {
                              "wan_link_name":"WAN_1",
                              "local_interface":"ge-0/0/1",
                              "wan_link_type":"Internet",
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "INTERNET"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_1",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.191.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.201.254/24",
                                 "gateway_ip":"192.168.201.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           }
                        ],
                        "oam_traffic":{
                           "ip_prefix":"192.168.210.2/32"
                        },
                        "device_details":{
                           "serial_number":"CZ0417AF0130"
                        },
                        "device_name":"sdwansitegw",
                        "device_template":"SRX_Advanced_SDWAN_CPE_option_1"
                     }
                  ],
                  "hub_sites":[
                     {
                        "hub_role":"PRIMARY",
                        "hub_name":"hub1"
                     }
                  ]
               },
               "properties":{
                  "property":[
                     {
                        "name":"site_advanced_config",
                        "value":{
                           "nameserver":[
                              "8.8.8.8"
                           ],
                           "timezone":"Europe/Amsterdam"
                        }
                     }
                  ]
               }
            }
         ]
      }
   }
   

Wait until the device is provisioned.

|image727|

Ignore any error messages that may appear due to old firewall rules (from old labs) that may no long be deployable.

|image728|

|image729|

Review/change the Firewall configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Before we do anything else let’s clean / review the Firewall setup.

Here we have a ruleset that includes a Department called default but in our setup the only Department we have is the “datacentre” so let’s delete this.

|image730|

Create a new ruleset that matches our config

|image731|

You should also as Rule like the below to alow Internet Access. If not create it.

|image732|

Now your Ruleset should look like this:

|image733|

Deploy the changed ruleset

|image734|

Wait until you see that all Firewall rules have been succcesfully deployed

|image735|

Add your Spokes to the Environment
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: Chose the number of Spokes you want to use for this Lab.

In this lab we’ll leave it you you if you want to onboard just one Spoke, two Spokes or the entire three Spokes we can use in this scenario. It depends on where you are setting the focus on and if you have useded the “Full Mesh with Local-Breakout” Lab already.

We will create additional Mesh-Tags that we will use to limit the Mesh direct connections to be **ONLY BUILD BETWEEN sdwansite1 and sdwansite2**. You can use any other mesh configuration you’d like to demo but keep in mind you do not have so many spokes in this environment.

|image736|

First Tag to be created

|image737|

Second Tag

|image738|

So that you now should have four Tags:

|image739|

For all three Spokes the same creation happens. Below we only show the first spoke.

|image740|

|image741|

|image742|

|image743|

|image744|

|image745|

Here are the three JSON Files of all Spokes to repeat this easly

.. hidden-code-block:: none

   
   {
      "input":{
         "tenant_name":"realtimetenant",
         "deployment_scenario":"managed_wan_v2",
         "site":[
            {
               "site_name":"sdwansite1",
               "site_basic_properties":{
                  "0":{
                     "dhcp":false,
                     "department":"Default",
                     "lan_ports":[
                        "LAN_4"
                     ],
                     "lan_segment_name":"desktop2",
                     "vlan":1088,
                     "ip_prefix":"10.88.88.1/24"
                  },
                  "topology":"Real-Time Optimized",
                  "sla_mgmt":"FINE",
                  "network_seg":false,
                  "gatewaySite":false,
                  "site_role":"SPOKE",
                  "site_address":{
                     "country":"US"
                  },
                  "site_group":null,
                  "site_name":"sdwansite1",
                  "device_redundancy":false,
                  "device_profile_name":"SRX as SD-WAN CPE",
                  "cloud_service":"EDGE",
                  "site_type":"on_premise",
                  "dvpn_params":{
                     "create_dvpn_threshold":5,
                     "delete_dvpn_threshold":2
                  },
                  "device_template":[
                     {
                        "template_name":"SRX_Advanced_SDWAN_CPE_option_1",
                        "device_name":"sdwansite1",
                        "wan_link_info":[
                           {
                              "wan_link":"WAN_0",
                              "wan_link_type":"MPLS",
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"abc",
                              "cost":2222,
                              "_sys_reserved_row":"804eb010-8fed-c3d6-cf5e-17f09c6ef841",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           },
                           {
                              "wan_link":"WAN_1",
                              "wan_link_type":"Internet",
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"xyz",
                              "cost":111,
                              "_sys_reserved_row":"0d3da816-98da-6f7e-152a-aaed4a6cccd2",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           }
                        ],
                        "lan_segment":[
                           {
                              "dhcp":false,
                              "department":"Default",
                              "lan_ports":[
                                 "LAN_4"
                              ],
                              "lan_segment_name":"desktop2",
                              "vlan":1088,
                              "ip_prefix":"10.88.88.1/24"
                           }
                        ]
                     }
                  ]
               }
            }
         ]
      }
   }
   

.. hidden-code-block:: none

   
   {
      "input":{
         "tenant_name":"realtimetenant",
         "deployment_scenario":"managed_wan_v2",
         "site":[
            {
               "site_name":"sdwansite2",
               "site_basic_properties":{
                  "0":{
                     "dhcp":false,
                     "department":"Default",
                     "lan_ports":[
                        "LAN_0"
                     ],
                     "lan_segment_name":"desktop4",
                     "vlan":1066,
                     "ip_prefix":"10.66.66.1/24"
                  },
                  "topology":"Real-Time Optimized",
                  "sla_mgmt":"FINE",
                  "network_seg":false,
                  "gatewaySite":false,
                  "site_role":"SPOKE",
                  "site_address":{
                     "country":"US"
                  },
                  "site_group":null,
                  "site_name":"sdwansite2",
                  "device_redundancy":false,
                  "device_profile_name":"NFX250 as SD-WAN CPE",
                  "cloud_service":"EDGE",
                  "site_type":"on_premise",
                  "dvpn_params":{
                     "create_dvpn_threshold":5,
                     "delete_dvpn_threshold":2
                  },
                  "device_template":[
                     {
                        "template_name":"NFX_Advanced_SDWAN_CPE_option_1",
                        "device_name":"sdwansite2",
                        "wan_link_info":[
                           {
                              "wan_link":"WAN_0",
                              "wan_link_type":"MPLS",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"abc",
                              "cost":2222,
                              "_sys_reserved_row":"55f5234a-c46a-20db-8d22-304931774db0",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           },
                           {
                              "wan_link":"WAN_1",
                              "wan_link_type":"Internet",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"xyz",
                              "cost":111,
                              "_sys_reserved_row":"b86f878c-191e-be09-3d2c-e23db015722c",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           }
                        ],
                        "lan_segment":[
                           {
                              "dhcp":false,
                              "department":"Default",
                              "lan_ports":[
                                 "LAN_0"
                              ],
                              "lan_segment_name":"desktop4",
                              "vlan":1066,
                              "ip_prefix":"10.66.66.1/24"
                           }
                        ]
                     }
                  ]
               }
            }
         ]
      }
   }
   

.. hidden-code-block:: none

   
   {
      "input":{
         "tenant_name":"realtimetenant",
         "deployment_scenario":"managed_wan_v2",
         "site":[
            {
               "site_name":"sdwansite3",
               "site_basic_properties":{
                  "0":{
                     "dhcp":false,
                     "department":"Default",
                     "lan_ports":[
                        "LAN_0"
                     ],
                     "lan_segment_name":"desktop3",
                     "vlan":1077,
                     "ip_prefix":"10.77.77.1/24"
                  },
                  "topology":"Real-Time Optimized",
                  "sla_mgmt":"FINE",
                  "network_seg":false,
                  "gatewaySite":false,
                  "site_role":"SPOKE",
                  "site_address":{
                     "country":"US"
                  },
                  "site_group":null,
                  "site_name":"sdwansite3",
                  "device_redundancy":false,
                  "device_profile_name":"NFX250 as SD-WAN CPE",
                  "cloud_service":"EDGE",
                  "site_type":"on_premise",
                  "dvpn_params":{
                     "create_dvpn_threshold":5,
                     "delete_dvpn_threshold":2
                  },
                  "device_template":[
                     {
                        "template_name":"NFX_Advanced_SDWAN_CPE_option_1",
                        "device_name":"sdwansite3",
                        "wan_link_info":[
                           {
                              "wan_link":"WAN_0",
                              "wan_link_type":"MPLS",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"abc",
                              "cost":2222,
                              "_sys_reserved_row":"e8302d43-1d40-0d01-c02d-ea4174be25b8",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           },
                           {
                              "wan_link":"WAN_1",
                              "wan_link_type":"Internet",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"xyz",
                              "cost":111,
                              "_sys_reserved_row":"95354486-63b5-fade-392e-ca938e35cb56",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           }
                        ],
                        "lan_segment":[
                           {
                              "dhcp":false,
                              "department":"Default",
                              "lan_ports":[
                                 "LAN_0"
                              ],
                              "lan_segment_name":"desktop3",
                              "vlan":1077,
                              "ip_prefix":"10.77.77.1/24"
                           }
                        ]
                     }
                  ]
               }
            }
         ]
      }
   }
   

You should see now the following

|image746|

Now we continue to configure all Spokes and provision them. Below we also only show this for the first Spoke.

|image747|

Don’t forget to now also include the site-gw in your configuration

|image748|

|image749|

|image750|

|image751|

|image752|

|image753|

|image754|

JSON of sdwansite1

.. hidden-code-block:: none

   
   {
      "input":{
         "job_name_prefix":"realtimetenant-sdwansite1",
         "tenant_name":"realtimetenant",
         "site":[
            {
               "site_name":"sdwansite1",
               "on_premise_site_info":{
                  "site_role":"spoke",
                  "ha_info":{
                     "ha_topology":"STANDALONE"
                  },
                  "device":[
                     {
                        "is_gateway_site":false,
                        "device_family":"juniper-srx",
                        "wan_link":[
                           {
                              "wan_link_name":"WAN_0",
                              "local_interface":"ge-0/0/0",
                              "wan_link_type":"MPLS",
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "site1andsite2MPLS"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_0",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.190.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.170.2/24",
                                 "gateway_ip":"192.168.170.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           },
                           {
                              "wan_link_name":"WAN_1",
                              "local_interface":"ge-0/0/1",
                              "wan_link_type":"Internet",
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "site1andsite2INTERNET"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_1",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.191.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.173.2/24",
                                 "gateway_ip":"192.168.173.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           }
                        ],
                        "oam_traffic":{
                           "ip_prefix":"192.168.210.3/32"
                        },
                        "device_details":{
                           "serial_number":"CV2116AF0288"
                        },
                        "device_name":"sdwansite1",
                        "device_template":"SRX_Advanced_SDWAN_CPE_option_1"
                     }
                  ],
                  "hub_sites":[
                     {
                        "hub_role":"PRIMARY",
                        "hub_name":"hub1"
                     }
                  ],
                  "gateway_sites":[
                     {
                        "gateway_name":"sdwansitegw",
                        "gateway_role":"PRIMARY_GW"
                     }
                  ]
               },
               "properties":{
                  "property":[
                     {
                        "name":"site_advanced_config",
                        "value":{
                           "nameserver":[
                              "8.8.8.8"
                           ],
                           "timezone":"Europe/Amsterdam"
                        }
                     }
                  ]
               }
            }
         ]
      }
   }
   

JSON of sdwansite2

.. hidden-code-block:: none

   
   {
      "input":{
         "job_name_prefix":"realtimetenant-sdwansite2",
         "tenant_name":"realtimetenant",
         "site":[
            {
               "site_name":"sdwansite2",
               "on_premise_site_info":{
                  "site_role":"spoke",
                  "ha_info":{
                     "ha_topology":"STANDALONE"
                  },
                  "device":[
                     {
                        "is_gateway_site":false,
                        "wan_link":[
                           {
                              "wan_link_name":"WAN_0",
                              "local_interface":"ge-0/0/10",
                              "wan_link_type":"MPLS",
                              "enable_pppoe":false,
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "site1andsite2MPLS"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "access_type":"Ethernet",
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_0",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.190.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.130.2/24",
                                 "gateway_ip":"192.168.130.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"OAM_AND_DATA"
                           },
                           {
                              "wan_link_name":"WAN_1",
                              "local_interface":"ge-0/0/11",
                              "wan_link_type":"Internet",
                              "enable_pppoe":false,
                              "used_for_meshing":true,
                              "mesh_tag":[
                                 "site1andsite2INTERNET"
                              ],
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "access_type":"Ethernet",
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_1",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.191.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.133.2/24",
                                 "gateway_ip":"192.168.133.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           }
                        ],
                        "oam_traffic":{
                           "ip_prefix":"192.168.210.4/32"
                        },
                        "device_details":{
                           "serial_number":"DD2116AF0059"
                        },
                        "device_name":"sdwansite2",
                        "device_template":"NFX_Advanced_SDWAN_CPE_option_1"
                     }
                  ],
                  "hub_sites":[
                     {
                        "hub_role":"PRIMARY",
                        "hub_name":"hub1"
                     }
                  ],
                  "gateway_sites":[
                     {
                        "gateway_name":"sdwansitegw",
                        "gateway_role":"PRIMARY_GW"
                     }
                  ]
               },
               "properties":{
                  "property":[
                     {
                        "name":"site_advanced_config",
                        "value":{
                           "nameserver":[
                              "8.8.8.8"
                           ],
                           "timezone":"Europe/Amsterdam"
                        }
                     }
                  ]
               }
            }
         ]
      }
   }
   

.. note:: The **third Site** (if you create it) has **no Mesh configured** at all just to show it’s forced to allways use the Hub!

JSON of sdwansite3

.. hidden-code-block:: none

   
   {
      "input":{
         "job_name_prefix":"realtimetenant-sdwansite3",
         "tenant_name":"realtimetenant",
         "site":[
            {
               "site_name":"sdwansite3",
               "on_premise_site_info":{
                  "site_role":"spoke",
                  "ha_info":{
                     "ha_topology":"STANDALONE"
                  },
                  "device":[
                     {
                        "is_gateway_site":false,
                        "wan_link":[
                           {
                              "wan_link_name":"WAN_0",
                              "local_interface":"ge-0/0/10",
                              "wan_link_type":"MPLS",
                              "enable_pppoe":false,
                              "used_for_meshing":false,
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "access_type":"Ethernet",
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_0",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.190.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.150.2/24",
                                 "gateway_ip":"192.168.150.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"OAM_AND_DATA"
                           },
                           {
                              "wan_link_name":"WAN_1",
                              "local_interface":"ge-0/0/11",
                              "wan_link_type":"Internet",
                              "enable_pppoe":false,
                              "used_for_meshing":false,
                              "mesh_overlay_link_type":"GRE_IPSEC",
                              "connect_to_hubs":true,
                              "used_for_oam":true,
                              "access_type":"Ethernet",
                              "local_breakout_enabled":false,
                              "vpn":[
                                 {
                                    "vpn_name":"realtimetenant_DefaultVPN"
                                 }
                              ],
                              "overlay_tunnel":[
                                 {
                                    "tunnel_id":0,
                                    "tunnel_endpoint_role":"SPOKE",
                                    "tunnel_type":"GRE_IPSEC",
                                    "peer_info":{
                                       "interface_name":"WAN_1",
                                       "peer_device":"hub1",
                                       "internet_gw_ip":"192.168.191.1"
                                    }
                                 }
                              ],
                              "nat_info":{
                                 "nat_enabled":false
                              },
                              "static_ip_assignment":{
                                 "ip_address":"192.168.153.2/24",
                                 "gateway_ip":"192.168.153.1"
                              },
                              "address_assignment":"STATIC",
                              "traffic_type":"DATA_ONLY"
                           }
                        ],
                        "oam_traffic":{
                           "ip_prefix":"192.168.210.5/32"
                        },
                        "device_details":{
                           "serial_number":"DD1816AF0024"
                        },
                        "device_name":"sdwansite3",
                        "device_template":"NFX_Advanced_SDWAN_CPE_option_1"
                     }
                  ],
                  "hub_sites":[
                     {
                        "hub_role":"PRIMARY",
                        "hub_name":"hub1"
                     }
                  ],
                  "gateway_sites":[
                     {
                        "gateway_name":"sdwansitegw",
                        "gateway_role":"PRIMARY_GW"
                     }
                  ]
               },
               "properties":{
                  "property":[
                     {
                        "name":"site_advanced_config",
                        "value":{
                           "nameserver":[
                              "8.8.8.8"
                           ],
                           "timezone":"Europe/Amsterdam"
                        }
                     }
                  ]
               }
            }
         ]
      }
   }
   

After around 25minutes all Sites shoul be avail and so you should see:

|image755|

Traffic between Desktop VM’s and Site-Gateway
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

First we add a new Firewall rule that allows all communication among sites

|image756|

|image757|

|image758|

|image759|

|image760|

Now (just for this demo) we manually, directly issue the mesh configuration between sdwansite1 and sdwansite2. You can also use the gynamic approach but we just want to show the difference between the other lab so we do it here:

|image761|

|image762|

Scroll down the right Pane to see the new option to add Tunnels

|image763|

|image764|

When yo save this a new set of direct Tunnels will be created.

.. hidden-code-block:: none

   
   Job logs:
   Feb 18, 2019, 3:23:25 PMProcessing UI CREATE request src_site=2106048b-a870-4415-8f38-c734856db7c6 dest_site=b1748602-0b00-4c47-a1d9-2a2a5f346500 enable_dvpn_thresholds=False
   Feb 18, 2019, 3:23:25 PMenable_dvpn_threshold is set to False from UI. DVPN tunnels between the sites can be created/deleted from UI only. Processing of DVPN notifications based on site-to-site traffic is disabled for this site-pair
   Feb 18, 2019, 3:23:26 PMmesh links end-points: [(u'WAN_1', u'WAN_1'), (u'WAN_0', u'WAN_0')]
   Feb 18, 2019, 3:23:27 PMcreating fullmesh underlay links ...
   Feb 18, 2019, 3:23:27 PMcreating fullmesh overlay links ...
   Feb 18, 2019, 3:23:31 PMActivating the overlay links ...
   Feb 18, 2019, 3:23:48 PMActivating VPN routing ..
   Feb 18, 2019, 3:23:53 PMReceived notification from Routing Manager {"status": "SUCCESS", "X-Request-Id": "UI_15432f91-8e29-a2f3-237e-ec35733100e7,ZrtG,R8Ap", "rpc_type": "ACTIVATE_VPN_ROUTING", "request_id": "1d5b1619-e253-4c9a-953b-0b0385f82e4f"}
   Feb 18, 2019, 3:23:53 PMSuccess in executing Routing Manager workflow
   Feb 18, 2019, 3:23:54 PMLinks activated: [u'sdwansite1_WAN_1_sdwansite2_WAN_1_GRE_IPSEC_0', u'sdwansite1_WAN_0_sdwansite2_WAN_0_GRE_IPSEC_0']
   Feb 18, 2019, 3:23:54 PMDeploying configs on the devices ...
   Feb 18, 2019, 3:25:07 PMDevice sdwansite2: Config-Deploy SUCCESS Device sdwansite1: Config-Deploy SUCCESS
   Feb 18, 2019, 3:25:11 PMSite sdwansite1: resync resources job request created
   Feb 18, 2019, 3:25:11 PMSite sdwansite2: resync resources job request created
   Feb 18, 2019, 3:25:11 PMCREATE fullmesh-tunnels completed successfully
   Task: create-fullmesh-tunnels
   Feb 18, 2019, 3:23:24 PMTask started
   Feb 18, 2019, 3:23:24 PMcreate fullmesh tunnels task in-progress
   Feb 18, 2019, 3:23:24 PMcreate fullmesh tunnels task in-progress
   Feb 18, 2019, 3:25:11 PMcreate fullmesh tunnels task success
   Feb 18, 2019, 3:25:11 PMTask complete
   Feb 18, 2019, 3:25:11 PMcreate fullmesh tunnels task success
   

.. note:: It is important to stress the fact that **other Sites may appear** as possible Destination Site like below:

|image765|

.. warning:: BUT should you select such a Site then CSO will check the DB and if there are **no Mesh-Tags configured to connect those sites directly** it will display an **error message** like the below:

|image766|

Lets continue with our Lab now.

|image767|

|image768|

|image769|

Now go to sdwansite2 CLI to review the current configuration

.. code-block:: none

   ssh root@192.168.210.4 (Embe1mpls)

   show interfaces terse | match gr-
   gr-0/0/0                up    up
   gr-0/0/0.4001           up    up   inet     10.152.0.83/31
   gr-0/0/0.4002           up    up   inet     10.152.0.81/31
   gr-0/0/0.4003           up    up   inet     10.0.192.15/31
   gr-0/0/0.4004           up    up   inet     10.0.200.15/31

   show route table LAN-realtimetenant_DefaultVPN.inet.0

   LAN-realtimetenant_DefaultVPN.inet.0: 5 destinations, 7 routes (5 active, 0 holddown, 1 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 01:04:46, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 16
                         via gr-0/0/0.4002, Push 16
   10.66.66.0/24      *[Direct/0] 01:06:23
                       > via ge-0/0/4.1066
   10.66.66.1/32      *[Local/0] 01:06:23
                         Local via ge-0/0/4.1066
   10.77.77.0/24      *[BGP/170] 01:02:35, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18
   10.88.88.0/24      *[BGP/170] 00:06:35, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4003, Push 16
                       > via gr-0/0/0.4004, Push 16
                       [BGP/170] 01:04:46, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18

Now change to the QFX5100 and establish a BGP-Peer with your Site-gateway. For the this Demo we will announce and connect the Desktop1-VM on subnet 10.99.99.0/24.

.. code-block:: none

   ssh root@192.168.10.20
   cli
   edit
   delete groups sdwan-sitegw interfaces xe-0/0/46 disable
   delete groups sdwan-sitegw routing-instances sitegw
   set groups sdwan-sitegw interfaces xe-0/0/46 unit 0 family inet address 192.168.204.1/24
   set groups sdwan-sitegw routing-instances sitegw instance-type virtual-router
   set groups sdwan-sitegw routing-instances sitegw interface xe-0/0/46.0
   set groups sdwan-sitegw routing-instances sitegw routing-options autonomous-system 65100
   set groups sdwan-sitegw routing-instances sitegw protocols bgp group ebgp type external
   set groups sdwan-sitegw routing-instances sitegw protocols bgp group ebgp export export-sitegw
   set groups sdwan-sitegw routing-instances sitegw protocols bgp group ebgp peer-as 64512
   set groups sdwan-sitegw routing-instances sitegw protocols bgp group ebgp neighbor 192.168.204.254
   set groups sdwan-sitegw policy-options policy-statement export-sitegw term sitegw-net from route-filter 10.99.99.0/24 exact
   set groups sdwan-sitegw policy-options policy-statement export-sitegw term sitegw-net then accept
   # Attach the Desktop1 VM to the routing instance
   set vlans ucpe-client1 vlan-id 1099
   set interfaces xe-0/0/18 description "ucpe client1"
   disable interfaces xe-0/0/18 unit 0 family ethernet-switching vlan members 1099
   set groups sdwan-sitegw vlans ucpe-client1 vlan-id 1099
   set groups sdwan-sitegw vlans ucpe-client1 l3-interface irb.1099
   set groups sdwan-sitegw interfaces irb unit 1099 family inet address 10.99.99.1/24
   set groups sdwan-sitegw routing-instances sitegw interface irb.1099
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1099
   # using a static route for default-gw is not elegant but works for this demo!
   set groups sdwan-sitegw routing-instances sitegw routing-options static route 0.0.0.0/0 next-hop 192.168.204.254
   commit and-quit

On the QFX5100 as peering point towards sitegw you just see the accepted peering plus the small static route for 0/0 and 10.99.99.0/24

.. code-block:: none

   show bgp summary
   Groups: 2 Peers: 2 Down peers: 0
   Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
   192.168.194.254       64512      13150      13243       0       2  4d 3:16:18 Establ
     secure-oam.inet.0: 5/5/5/0
   192.168.204.254       64512        121        117       0       0       53:39 Establ
     sitegw.inet.0: 0/0/0/0
   
   
   show route table sitegw
   
   sitegw.inet.0: 5 destinations, 5 routes (5 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 00:15:24
                       > to 192.168.204.254 via xe-0/0/46.0
   10.99.99.0/24      *[Direct/0] 00:07:17
                       > via irb.1099
   10.99.99.1/32      *[Local/0] 00:07:17
                         Local via irb.1099
   192.168.204.0/24   *[Direct/0] 01:46:29
                       > via xe-0/0/46.0
   192.168.204.1/32   *[Local/0] 01:46:29
                         Local via xe-0/0/46.0

On the Site-Gateway CLI we now see the following

.. code-block:: none

   ssh root@192.168.210.2 (Embe1mpls)

   show bgp summary
   Groups: 3 Peers: 3 Down peers: 0
   Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
   inet.0
                          1          1          0          0          0          0
   bgp.l3vpn.0
                         19          7          0          0          0          0
   Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
   192.168.10.49         64512       1033       1035       0       0    16:48:54 Establ
     bgp.l3vpn.0: 7/19/19/0
     transit.inet.0: 3/6/6/0
     LAN-realtimetenant_DefaultVPN.inet.0: 4/7/7/0
     Default-hub-realtimetenant_DefaultVPN.inet.0: 1/1/1/0
     Default-realtimetenant_DefaultVPN.inet.0: 3/6/6/0
     Default-reverse-hub-realtimetenant_DefaultVPN.inet.0: 1/1/1/0
     Default-reverse-realtimetenant_DefaultVPN.inet.0: 3/6/6/0
     internet-hub-realtimetenant_DefaultVPN.inet.0: 1/1/1/0
     internet-realtimetenant_DefaultVPN.inet.0: 3/6/6/0
     mpls-hub-realtimetenant_DefaultVPN.inet.0: 1/1/1/0
     mpls-realtimetenant_DefaultVPN.inet.0: 3/6/6/0
   192.168.204.1         65100       2345       2344       0       0    17:37:38 Establ
     LAN-realtimetenant_DefaultVPN.inet.0: 1/1/1/0
   192.168.210.1         64512       2834       2857       0       0    21:29:07 Establ
     inet.0: 1/1/1/0

   show route table LAN-realtimetenant_DefaultVPN.inet.0

   LAN-realtimetenant_DefaultVPN.inet.0: 7 destinations, 10 routes (7 active, 0 holddown, 3 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 16:50:13, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 16
                         via gr-0/0/0.4001, Push 16
   10.66.66.0/24      *[BGP/170] 16:50:13, MED 100, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 18
                       > via gr-0/0/0.4001, Push 18
   10.77.77.0/24      *[BGP/170] 16:50:13, MED 100, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 18
                       > via gr-0/0/0.4001, Push 18
   10.88.88.0/24      *[BGP/170] 16:50:13, MED 100, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4000, Push 18
                       > via gr-0/0/0.4001, Push 18
   10.99.99.0/24      *[BGP/170] 15:59:50, localpref 100
                         AS path: 65100 I, validation-state: unverified
                       > to 192.168.204.1 via ge-0/0/4.0
   192.168.204.0/24   *[Direct/0] 17:42:25
                       > via ge-0/0/4.0
   192.168.204.254/32 *[Local/0] 21:23:43
                         Local via ge-0/0/4.0

On sdwansite2 CLI we now see the new network 10.99.99.0/24 has been learned via the vRR because (apart from the Loopback-Peer) that’s the only Peer we have where we could get those Route from.

.. code-block:: none

   ssh root@192.168.210.4 (Embe1mpls)

   show bgp summary
   Groups: 2 Peers: 2 Down peers: 0
   Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
   inet.0
                          1          1          0          0          0          0
   bgp.l3vpn.0
                         24         12          0          0          0          0
   Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
   192.168.10.49         64512       1247       1226       0       0    19:27:10 Establ
     bgp.l3vpn.0: 12/24/24/0
     transit.inet.0: 3/3/3/0
     LAN-realtimetenant_DefaultVPN.inet.0: 5/9/9/0
     mpls-realtimetenant_DefaultVPN.inet.0: 2/5/5/0
     internet-realtimetenant_DefaultVPN.inet.0: 2/5/5/0
     Default-realtimetenant_DefaultVPN.inet.0: 2/5/5/0
     Default-reverse-realtimetenant_DefaultVPN.inet.0: 2/5/5/0
   192.168.210.1         64512       2569       2607       0       0    19:29:23 Establ
     inet.0: 1/1/1/0

   show route table LAN-realtimetenant_DefaultVPN.inet.0

   LAN-realtimetenant_DefaultVPN.inet.0: 7 destinations, 11 routes (7 active, 0 holddown, 3 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[BGP/170] 19:16:23, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 16
                         via gr-0/0/0.4002, Push 16
   10.66.66.0/24      *[Direct/0] 19:18:00
                       > via ge-0/0/4.1066
   10.66.66.1/32      *[Local/0] 19:18:00
                         Local via ge-0/0/4.1066
   10.77.77.0/24      *[BGP/170] 19:14:12, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18
   10.88.88.0/24      *[BGP/170] 18:18:12, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4003, Push 16
                       > via gr-0/0/0.4004, Push 16
                       [BGP/170] 19:16:23, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4002, Push 18
   10.99.99.0/24      *[BGP/170] 15:55:08, localpref 100, from 192.168.10.49
                         AS path: 65100 I, validation-state: unverified
                         via gr-0/0/0.4001, Push 21
                       > via gr-0/0/0.4002, Push 21
   192.168.204.0/24   *[BGP/170] 16:45:31, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 21
                         via gr-0/0/0.4002, Push 21

.. warning:: In this lab it will not be possible to interact / talk / ping with the Internet from the LAN 10.99.99.0/24 where the Desktop1-VM is! We would have needed to also issue changes on the NATVM as 10.99.99.0/24 has a route back to the vCPE lab not the SD-WAN environment. Instead, **we focus to be able to exchange Traffic between Desktop1-VM and all other Sites.**

Now we need to add new Firewalls to be able to talk with the LAN 10.99.99.0/24 that we attached to the Site-Gateway else only the directly learned LAN links would be able to communicate (on the Site-Gateway we have defined 192.168.204.0/24 that we needed also for the peering).

First we need to define an address-group for our 10.99.99.0/24 lan.

So ADD a new Firewall rule

|image770|

Then click on this Button at the right side

|image771|

|image772|

|image773|

Now you can use this object to add it to our Rule definition like this

|image774|

This allows us to add now the following two rules:

|image775|

And

|image776|

|image777|

**Deploy your new Ruleset** now and wait until it’s finished!

|image778|

Now for the final testing we first login to Desktop4 VM on sdwansite2 and test that we can ping 10.88.88.88 which is Desktop2 VM on sdwansite2. Then we ping 10.99.99.99 which is the Desktop1 VM that we attached to the site-gw and exachange route via BGP with.

|image779|

Here we do the reverse in logging in on Desktop1-VM attached via BGP-Peering to the Site-GW and ping the two other VM’s that are attached to sdwansite1/2

|image780|

Should you have sdwansite3 deployed ping this as well please.

|image781|

Simple VNF integration (aka Service-Chaining)
---------------------------------------------

.. warning:: This lab has no separate Automation configuration as it’s based on the SD-WAN BASIC Scenario. Apply that at you should be good to go.

Review the following `Video <https://junipernetworks.sharepoint.com/:v:/r/sites/open1/cloud-srv/Product/Demo%20Videos/R4.0/CSO4.0-Service-chaining-v2.mp4?csf=1&e=JbpaKV>`__ for this Chapter

.. warning:: **DO NOT TRY THIS ON AN NFX150** instead of the NFX250. The tweaks we do here to get this running only work on the 250 for now! You’ve been warned.

CSO 4.0 was the first version where Service-Chaining becomes back avail in SD-WAN scenarios. It was already avail un uCPE designs in prior version but the forwarding model of SD-Wan changed the internal design so dramatically that this ability got lost but now it comes back.

In CSO 4.0 only two models or VNF Types are supported:

#. A single leged Ubuntu VM at the LAN side.
#. A Fortinet Firewall in Transparent Mode also at the LAN side.

.. note:: This **testcase only supports the single-leged-Ubuntu VM** for now. This was already hard enough to develop.

Preparation

This test case assumes that:

- The SD-WAN BASIC Topology is used

- PoP created

- Cloud Hub Nr.1 is created

- Cloud Hub Nr.1 is ZTPed and Provisioned in CSO

- The Tenant is created

- NO SD-WAN policy is created right now

- The Cloud Hub Nr.1 is assigned to the Tenant

- A Spoke using and NFX250 is Created

- The Spoke w. NFX250 is is ZTPed and Provisioned in CSO

.. note:: This testcase works on both scenarios (Bandwidth/Realtime)-Mode the same way.

VNF import to CSO and Template changes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Let’s onboard both VNF’s first so we can play with those

.. code-block:: none

   cd /root
   # Download the Ubuntu cloudimage (here the vmdk-version)
   # DO NOT USE THE ORIGINAL .IMG!!!
   wget http://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.vmdk

   # convert the compressed vmdk image to an uncompressed qcow2 image
   qemu-img convert -f vmdk -O qcow2 xenial-server-cloudimg-amd64-disk1.vmdk xenial-server-cloudimg-amd64-disk1.qcow2
    
   ls -l xe*
   -rw-r--r-- 1 root root 1009516544 Jul 21 19:21 xenial-server-cloudimg-amd64-disk1.qcow2
   -rw-r--r-- 1 root root  296191488 Jul 15 15:40 xenial-server-cloudimg-amd64-disk1.vmdk

Step1: Make an HTTP call to the endpoint http://192.168.10.41:5000/v2.0/tokens with the specified data (-d) and the headers (-H). In the data field, you need to supply the username "admin" and the Keystone Password for admin user which was displayed after the completion of setup_assist script. For more information on the structure of REST calls, refer Contrail Service Orchestration API Reference documentation https://iam-sso.juniper.net/oamfed/idp/samlv20.

.. code-block:: none

   RAW_TOKEN=`curl -d '{"auth":{"tenantName":"admin", "passwordCredentials":{"username":"admin", "password":"5DQkO6ME2Y87"}}}' -H "Content-type: application/json" http://192.168.10.41:5000/v2.0/tokens`

Step2: The following python command reads the value of RAW_TOKEN (retrieved in step 1), converts it to JSON format, and stores the access token id field in the TOKEN variable. The value of the variable, $TOKEN, needs to be supplied to further CSO REST calls for authorization purposes.

.. code-block:: none

   TOKEN=`echo $RAW_TOKEN | python -c "import sys; import json; tok = json.loads(sys.stdin.read()); print tok['access']['token']['id'];"`
   echo $TOKEN
   8c8ee84808a241d29e8dbc44d053338b

Step3: Make a REST call using the TOKEN generated in Step2 to upload the Ubuntu image to the https://192.168.10.42/ims-central/upload_image_file (central-msvm) endpoint. This call may take some time to finish without displaying any progress update.

.. code-block:: none

   curl -v --insecure -X POST -H "x-auth-token:$TOKEN" -H "Content-Type: multipart/form-data" -F "imagefile=@/root/xenial-server-cloudimg-amd64-disk1.qcow2" -F "cname=ubuntu-image" -F "image_type=VNF_IMAGE" -F "description=Ubuntu" -F "device_family=ubuntu" -F "supported_platform=ubuntu" -F "vendor=Ubuntu" -F "major_version=15" -F "minor_version=1" -F "build_num=16045" https://192.168.10.42/ims-central/upload_image_file

The uploaded image must have the name “ubuntu-image” with a filesize close to 1GB.

|image782|

Login to the configuration Portal

https://192.168.10.42:83 cspadmin/Juniper123!

Optional go to the Configuration designer and change the network setup an

|image783|

First open a new design request in NSD

|image784|

|image785|

**DO NOT DRAG** any object on the routing class and just click “next”.

|image786|

Press “create” in the next screen

|image787|

Move the mouse courser here and and click “begin”.

Grab the icon right with the label “Ubuntu fw” and drag it to:

|image788|

The LEFT interface right to the GWR is the place to position this VM

|image789|

Then click “save” in the upper right corner and after this click “publish”

|image790|

Publish

|image791|

Next step is to use Configuration Designer to adapt the VM configuration to our needs. This will enable the 3\ :sup:`rd` interface of the VNF to be really seen on the LAN-Side where the Desktop VM is connected to.

|image792|

Search for “ubuntu” to get the right template

|image793|

Select “ubuntu-nw” and Edit it

|image794|

Say “yes”

|image795|

Add these four lines to the config template

|image796|

Here is the whole config of the template for reference:

.. code-block:: none

   route del default gw 192.168.1.1
   ifconfig ens4 up
   {%- if left_interface.cp_ip and left_interface.nh_ip %}
   ifconfig ens6 up
   ifconfig ens6 {{left_interface.cp_ip}}
   ip route add default gw {{left_interface.nh_ip}}
   {% endif %}
   
   ifconfig ens5 10.66.66.23/24 up
   ip route add 0.0.0.0/0 via 10.66.66.1
   ethtool -K ens5 tx off rx off gso off
   echo nameserver 8.8.8.8 > /etc/resolv.conf

Now you MUST validate the Template else it will not be rendered so go to validate template fill in some ip’s and click “validate” below

|image797|

Check your config and say “Yes, it looks good”

|image798|

Then click next

|image799|

In the next window click “done”

|image800|

You see the status is only “validated”. Now you MUST Publish your changes to CSO to be recognized there.

|image801|

If the status changes to Published this change good.

|image802|

|image803|

|image804|

|image805|

|image806|

|image807|

.. code-block:: none

   delete cross-connect
   set virtual-network-functions {{post_config.vnf}} interfaces eth2 mapping vlan members {{post_config.vlan}}

You need to configure each of the two variables with a default value and remove the Required-check-item. Ate the start it looks like this

|image808|

.. code-block:: none

   ubuntu-fw-fw
   1066

At the end of the change process it should look like this:

|image809|

Generate UI. No need to change anything just hit -> Next

|image810|

You MUST validate the config now:

|image811|

Click “Validate” then “Yes it looks good”

|image812|

|image813|

|image814|

Publish the validated template:

|image815|

If your new template now also changes to “Published” Status you are good.

|image816|

Leave configuration designer and go back to the regular CSO Gui as “Global” Admin.

We must add our new template as Stage-2 config to the NFX250 device template now:

|image817|

We need to change/add Stage-2 config templates

|image818|

|image819|

Here it is important to notice that we use our Template and the Component is “JDM” and not the GWR as usually.

|image820|

Once this is verified click ok!

|image821|

Now select the new Network services design.

|image822|

Press “allocate services”

|image823|

Select a Tenant that should have this service and click “ok”

|image824|

VNF onboarding to Spoke and testing of it
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Change into Tenant View

|image825|

Click on the existing site with the nfx250

|image826|

Go to “Services”

|image827|

Click onto “View Services” and then drag the Ubuntu-vm icon to:

|image828|

Drop at the uCPE sign

|image829|

No we need to give that VM an IP-Address from LAN side and GW will be the vSRX in the NFX250.

|image830|

|image831|

|image832|

After about 5minutes you should see the image running:

|image833|

You might notice that after the VNF has started the Desktop4 VM is no longer able to communicate which its default gw 10.66.66.1 and as result also no longer with the internet.

|image834|

This is normal (for now) as CSO has changed the connection model inside the NFX250.

To get back to the old state, and still connect the new VNF on the LAN-side, we now need to trigger the appropriate changes due to our added Stage-2 config.

|image835|

Go to configuration -> Reconnect-VNF (ignore error messages)

|image836|

Our defaults should be ok.

|image837|

Click “Save” and then “Deploy”

|image838|

|image839|

.. note:: The “Deploy” button may not appear if you try this a second time. In this case change the vlan config to something else, click “save”, change the vlan config back to the original value “1066” and click again “save”. Now CSO thinks there is a change to be applied and you should be able to deploy.

If this trick doesn’twork then login to JDM and apply it manually:

.. code-block:: none

   cli
   edit
   delete cross-connect
   set virtual-network-functions ubuntu-fw-fw interfaces eth2 mapping vlan members 1066
   commit

|image840|

|image841|

You can also ssh into the new VNF itself (root/passw0rd)

|image842|

|image843|

From here you can now connect to the internet and do regular things with your VM.

This test case ends here.

(optional) If you have an SSH/Console to JDM on the NFX you should see this:

.. hidden-code-block:: none

   root@jdm:~# cd /var/third-party/CSP
   root@jdm:/var/third-party/CSP# ll
   total 20
   drwxr-xr-x 5 root root 4096 Sep 14 13:24 ./
   drwxrwxrwt 9 root root 4096 Sep 14 13:25 ../
   drwxr-xr-x 2 root root 4096 Sep 14 12:58 GWR.sdwansite2.hubspoketenant/
   drwxr-xr-x 2 root root 4096 Sep 14 12:58 pki/
   drwxr-xr-x 2 root root 4096 Sep 14 13:24 ubuntu-fw-fw/
   root@jdm:/var/third-party/CSP# cd ubuntu-fw-fw
   root@jdm:/var/third-party/CSP/ubuntu-fw-fw# ll
   total 974780
   drwxr-xr-x 2 root root      4096 Sep 14 13:24 ./
   drwxr-xr-x 5 root root      4096 Sep 14 13:24 ../
   -rw-r--r-- 1 root root    374784 Sep 14 13:31 bootstrap_cfg.iso
   -rw-r--r-- 1 root root 997785600 Sep 14 13:31 xenial-server-cloudimg-amd64-disk1.qcow2
   root@jdm:/var/third-party/CSP/ubuntu-fw-fw# mount -o loop bootstrap_cfg.iso /mnt
   mount: block device /var/third-party/CSP/ubuntu-fw-fw/bootstrap_cfg.iso is write-protected, mounting read-only
   root@jdm:/var/third-party/CSP/ubuntu-fw-fw# cd /mnt
   root@jdm:/mnt# ls -l
   total 1
   -rw-r--r-- 1 root root  30 Sep 14 13:31 meta-data
   -rw-r--r-- 1 root root 506 Sep 14 13:31 user-data
   root@jdm:/mnt# cat user-data
   #cloud-config
   password: passw0rd
   chpasswd: { expire: False }
   ssh_pwauth: True
   users:
     - name: root
       lock-passwd: false
   chpasswd:
     list: |
       root:passw0rd
     expire: False
   
   write_files:
     - path: /root/bootconfig.sh
       owner: root:root
       permissions: '0777'
       content: |
         #!/bin/bash
         ifconfig ens4 up
         ifconfig ens4 10.10.20.1/24
         exit 0
   
   runcmd:
     - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin yes/' /etc/ssh/sshd_config ; service ssh restart
     - /root/bootconfig.sh
   
   root@jdm:/var/third-party/CSP/ubuntu-fw-fw# virsh list --all
    Id    Name                           State
   ----------------------------------------------------
    2     vjunos0                        running
    3     GWR.sdwansite2.hubspoketenant  running
    4     ubuntu-fw-fw                   running
   
   root@jdm:~# virsh console ubuntu-fw-fw
   Connected to domain ubuntu-fw-fw
   Escape character is ^]
   
   Ubuntu 16.04.5 LTS ubuntu-fw-fw ttyS0
   
   ubuntu-fw-fw login: root
   Password: paasw0rd
   Last login: Fri Sep 14 13:26:27 UTC 2018 from 192.0.2.254 on pts/0
   Welcome to Ubuntu 16.04.5 LTS (GNU/Linux 4.4.0-135-generic x86_64)
   
    * Documentation:  https://help.ubuntu.com
    * Management:     https://landscape.canonical.com
    * Support:        https://ubuntu.com/advantage
   
     Get cloud support with Ubuntu Advantage Cloud Guest:
       http://www.ubuntu.com/business/services/cloud
   
   0 packages can be updated.
   0 updates are security updates.
   
   
   root@ubuntu-fw-fw:~# ifconfig
   ens3      Link encap:Ethernet  HWaddr ec:13:db:db:09:58
             inet addr:192.0.2.101  Bcast:192.0.2.255  Mask:255.255.255.0
             inet6 addr: fe80::ee13:dbff:fedb:958/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:1390 errors:0 dropped:4 overruns:0 frame:0
             TX packets:508 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:92211 (92.2 KB)  TX bytes:77401 (77.4 KB)
   
   ens4      Link encap:Ethernet  HWaddr ec:13:db:db:09:59
             inet addr:10.10.20.1  Bcast:10.10.20.255  Mask:255.255.255.0
             inet6 addr: fe80::ee13:dbff:fedb:959/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:33886 errors:0 dropped:14 overruns:0 frame:0
             TX packets:7 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:2072342 (2.0 MB)  TX bytes:578 (578.0 B)
   
   ens5      Link encap:Ethernet  HWaddr ec:13:db:db:09:5a
             inet addr:10.66.66.23  Bcast:10.66.66.255  Mask:255.255.255.0
             inet6 addr: fe80::ee13:dbff:fedb:95a/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:970 errors:0 dropped:0 overruns:0 frame:0
             TX packets:797 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:60026 (60.0 KB)  TX bytes:46779 (46.7 KB)
   
   ens6      Link encap:Ethernet  HWaddr ec:13:db:db:09:5b
             inet addr:10.10.0.1  Bcast:10.10.0.255  Mask:255.255.255.0
             inet6 addr: fe80::ee13:dbff:fedb:95b/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:5 errors:0 dropped:0 overruns:0 frame:0
             TX packets:7 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:246 (246.0 B)  TX bytes:578 (578.0 B)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:588 errors:0 dropped:0 overruns:0 frame:0
             TX packets:588 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1
             RX bytes:49498 (49.4 KB)  TX bytes:49498 (49.4 KB)
   
   root@ubuntu-fw-fw:~# route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         10.66.66.1      0.0.0.0         UG    0      0        0 ens5
   10.10.0.0       0.0.0.0         255.255.255.0   U     0      0        0 ens6
   10.10.20.0      0.0.0.0         255.255.255.0   U     0      0        0 ens4
   10.66.66.0      0.0.0.0         255.255.255.0   U     0      0        0 ens5
   192.0.2.0       0.0.0.0         255.255.255.0   U     0      0        0 ens3
   
   # on the gwr vsrx
   
   root@GWR.sdwansite2.hubspoketenant# show | compare rollback 1
   [edit groups]
      spoke-hubspoketenant_DefaultVPN-vpn-routing-config { ... }
   +  vnf-oam-config {
   +      security {
   +          nat {
   +              source {
   +                  rule-set RS-VNF-OAM-UNTRUST {
   +                      from interface ge-0/0/0.0;
   +                      to zone untrust;
   +                      rule default-source {
   +                          match {
   +                              source-address 0.0.0.0/0;
   +                          }
   +                          then {
   +                              source-nat {
   +                                  interface;
   +                              }
   +                          }
   +                      }
   +                  }
   +              }
   +              destination {
   +                  pool ubuntu-fw-fw-80 {
   +                      address 10.10.20.1/32 port 80;
   +                  }
   +                  pool ubuntu-fw-fw-22 {
   +                      address 10.10.20.1/32 port 22;
   +                  }
   +                  pool ubuntu-fw-fw-443 {
   +                      address 10.10.20.1/32 port 443;
   +                  }
   +                  rule-set RS-VNF-OAM {
   +                      from interface lo0.0;
   +                      rule ubuntu-fw-fw-80 {
   +                          match {
   +                              destination-address 0.0.0.0/0;
   +                              destination-port {
   +                                  49153;
   +                              }
   +                          }
   +                          then {
   +                              destination-nat {
   +                                  pool {
   +                                      ubuntu-fw-fw-80;
   +                                  }
   +                              }
   +                          }
   +                      }
   +                      rule ubuntu-fw-fw-22 {
   +                          match {
   +                              destination-address 0.0.0.0/0;
   +                              destination-port {
   +                                  49154;
   +                              }
   +                          }
   +                          then {
   +                              destination-nat {
   +                                  pool {
   +                                      ubuntu-fw-fw-22;
   +                                  }
   +                              }
   +                          }
   +                      }
   +                      rule ubuntu-fw-fw-443 {
   +                          match {
   +                              destination-address 0.0.0.0/0;
   +                              destination-port {
   +                                  49155;
   +                              }
   +                          }
   +                          then {
   +                              destination-nat {
   +                                  pool {
   +                                      ubuntu-fw-fw-443;
   +                                  }
   +                              }
   +                          }
   +                      }
   +                  }
   +              }
   +          }
   +          zones {
   +              security-zone oam {
   +                  interfaces {
   +                      ge-0/0/0.0;
   +                  }
   +              }
   +          }
   +      }
   +      interfaces {
   +          ge-0/0/0 {
   +              unit 0 {
   +                  family inet {
   +                      address 10.10.20.254/24;
   +                  }
   +              }
   +          }
   +      }
   +  }
   [edit]
   - apply-groups [ global nfx-gwr-site-routing-config-192.168.210.4 dept-configuration hubspoketenant_SDWANSITE2_WAN_0_HUB1_WAN_0_IPSEC_0 hubspoketenant_SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 rpm-cfg-sdwansite2 app-qoe-sdwansite2 hubspoketenant_SDWANSITE2_WAN_1_HUB1_WAN_1_IPSEC_0 hubspoketenant_SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 spoke-hubspoketenant_DefaultVPN-vpn-routing-config spoke-policy-default ];
   + apply-groups [ global nfx-gwr-site-routing-config-192.168.210.4 dept-configuration hubspoketenant_SDWANSITE2_WAN_0_HUB1_WAN_0_IPSEC_0 hubspoketenant_SDWANSITE2_WAN_0_HUB1_WAN_0_GRE_IPSEC_0 rpm-cfg-sdwansite2 app-qoe-sdwansite2 hubspoketenant_SDWANSITE2_WAN_1_HUB1_WAN_1_IPSEC_0 hubspoketenant_SDWANSITE2_WAN_1_HUB1_WAN_1_GRE_IPSEC_0 spoke-hubspoketenant_DefaultVPN-vpn-routing-config spoke-policy-default vnf-oam-config ];
   
   # in JDM
   
   
   cli
   show configuration | display set
   set version "15.1X53-D491.secure [dc-builder]"
   set system host-name jdm
   set system memory hugepages page-size 1024 page-count 13
   set system root-authentication encrypted-password "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81"
   set system name-server 192.168.10.10
   set system name-server 8.8.8.8
   set system login idle-timeout 10
   set system login user csp uid 2002
   set system login user csp class super-user
   set system login user csp authentication ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF5qmcNWbohbsD4fbKvtASr2EblNI1p+poIXMCTn8f0+Qt1hjsjsv5oqnmG3d4j+Eue/L2Wc+hj1+PcIIR9kM32QbFfAg0t83NxO5eDU9kjGHU/X7cyo5oZiOQb5suNE5QFi3fzoPJL2xmZC6cXfRPC8GgJY7cBPGMT0v13hYqp/5T6S8+lbXe9qe2i/7o8Naca6fitdnSKYyyOycMys6riKPJy/SkS42nZC5BTjD8oujE7PZy/qrePcm77NAnVMgl/+5TFqP+vOoMnYmZMlOiSrCqBEaTFn4by2yxq/Yk+OOAG+qtMEZjiLEQx101ZnFFaLUyhruc0+poXQXyYpMj"
   set system login user cspagent uid 2003
   set system login user cspagent class operator
   set system login user cspagent authentication ssh-rsa "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF5qmcNWbohbsD4fbKvtASr2EblNI1p+poIXMCTn8f0+Qt1hjsjsv5oqnmG3d4j+Eue/L2Wc+hj1+PcIIR9kM32QbFfAg0t83NxO5eDU9kjGHU/X7cyo5oZiOQb5suNE5QFi3fzoPJL2xmZC6cXfRPC8GgJY7cBPGMT0v13hYqp/5T6S8+lbXe9qe2i/7o8Naca6fitdnSKYyyOycMys6riKPJy/SkS42nZC5BTjD8oujE7PZy/qrePcm77NAnVMgl/+5TFqP+vOoMnYmZMlOiSrCqBEaTFn4by2yxq/Yk+OOAG+qtMEZjiLEQx101ZnFFaLUyhruc0+poXQXyYpMj"
   set system services ssh client-alive-count-max 5
   set system services ssh client-alive-interval 60
   set system services netconf ssh
   set system services netconf rfc-compliant
   set system services enhanced-orchestration
   set system services outbound-ssh client CSO-83688226-b819-11e8-9f70-0242ac101522 device-id d5e6c1ca-645f-4efd-8698-07480d46f05a.JDM
   set system services outbound-ssh client CSO-83688226-b819-11e8-9f70-0242ac101522 secret "$9$QMOFzCt0BIhylAt7-Vs4o/CA0ORLX7dVY7NjHqPQzBIRhlKM8XVb2N-GDiqf569A0EcSreLxNhcbsYgJZn/9AtOREylvWOBX7-VY25QznAp"
   set system services outbound-ssh client CSO-83688226-b819-11e8-9f70-0242ac101522 keep-alive
   set system services outbound-ssh client CSO-83688226-b819-11e8-9f70-0242ac101522 services netconf
   set system services outbound-ssh client CSO-83688226-b819-11e8-9f70-0242ac101522 192.168.10.42 port 7804
   set interfaces jsxe0 vlan-tagging
   set interfaces jsxe0 unit 0 disable
   set interfaces jsxe0 unit 0 vlan-id 4050
   set interfaces jsxe0 unit 0 family inet address 192.168.130.2/24
   set interfaces jsxe0 unit 4010 vlan-id 4010
   set interfaces jsxe0 unit 4010 family inet address 10.10.10.1/24
   set routing-options static route 0.0.0.0/0 next-hop 192.168.130.1
   set routing-options static route 192.168.10.0/24 next-hop 10.10.10.3
   set routing-options static route 192.168.10.42/32 next-hop 10.10.10.3
   set routing-options static route 192.168.10.47/32 next-hop 10.10.10.3
   set host-os vlans aux0_GWR.sdwansite2.hubspoketenant_vm vlan-id-list 1066
   set host-os vlans aux0_GWR.sdwansite2.hubspoketenant_vm vlan-id-list 4001
   set host-os vlans aux1_GWR.sdwansite2.hubspoketenant_vm vlan-id-list 4002
   set host-os vlans aux2_GWR.sdwansite2.hubspoketenant_vm vlan-id-list 4003
   set host-os vlans mgmt_GWR.sdwansite2.hubspoketenant_vm vlan-id-list 4010
   set host-os vlans wan0_GWR.sdwansite2.hubspoketenant_vm vlan-id-list 4050
   set host-os vlans wan1_GWR.sdwansite2.hubspoketenant_vm vlan-id-list 4051
   set host-os vlans wan2_GWR.sdwansite2.hubspoketenant_vm vlan-id-list 4052
   set host-os vlans wan3_GWR.sdwansite2.hubspoketenant_vm vlan-id-list 4053
   set virtual-network-functions vjunos0 interfaces em1 mapping vlan members 4088
   set virtual-network-functions GWR.sdwansite2.hubspoketenant image /var/third-party/CSP/GWR.sdwansite2.hubspoketenant/media-vsrx-vmdisk-15.1X49-D144.1.qcow2
   set virtual-network-functions GWR.sdwansite2.hubspoketenant virtual-cpu count 2
   set virtual-network-functions GWR.sdwansite2.hubspoketenant virtual-cpu features hardware-virtualization
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth2 description mgmt
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth2 mapping vlan members mgmt_GWR.sdwansite2.hubspoketenant_vm
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth3 description wan0
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth3 mapping vlan members wan0_GWR.sdwansite2.hubspoketenant_vm
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth4 description wan1
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth4 mapping vlan members wan1_GWR.sdwansite2.hubspoketenant_vm
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth5 description aux0
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth5 mapping vlan mode trunk
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth5 mapping vlan members aux0_GWR.sdwansite2.hubspoketenant_vm
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth6 description aux1
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth6 mapping vlan members aux1_GWR.sdwansite2.hubspoketenant_vm
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth7 description aux2
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth7 mapping vlan members aux2_GWR.sdwansite2.hubspoketenant_vm
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth8 description wan2
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth8 mapping vlan members wan2_GWR.sdwansite2.hubspoketenant_vm
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth9 description wan3
   set virtual-network-functions GWR.sdwansite2.hubspoketenant interfaces eth9 mapping vlan members wan3_GWR.sdwansite2.hubspoketenant_vm
   set virtual-network-functions GWR.sdwansite2.hubspoketenant memory size 4194304
   set virtual-network-functions GWR.sdwansite2.hubspoketenant memory features hugepages
   set virtual-network-functions ubuntu-fw-fw image /var/third-party/CSP/ubuntu-fw-fw/xenial-server-cloudimg-amd64-disk1.qcow2
   set virtual-network-functions ubuntu-fw-fw virtual-cpu count 4
   set virtual-network-functions ubuntu-fw-fw virtual-cpu features hardware-virtualization
   set virtual-network-functions ubuntu-fw-fw no-default-interfaces
   set virtual-network-functions ubuntu-fw-fw interfaces eth0 description internal
   set virtual-network-functions ubuntu-fw-fw interfaces eth0 management internal
   set virtual-network-functions ubuntu-fw-fw interfaces eth1 description oob
   set virtual-network-functions ubuntu-fw-fw interfaces eth1 management out-of-band
   set virtual-network-functions ubuntu-fw-fw interfaces eth2 description left-interface
   set virtual-network-functions ubuntu-fw-fw interfaces eth2 mapping vlan members 1066
   set virtual-network-functions ubuntu-fw-fw interfaces eth3 description mgmt-interface
   set virtual-network-functions ubuntu-fw-fw interfaces eth3 mapping vlan members mgmt_GWR.sdwansite2.hubspoketenant_vm
   set virtual-network-functions ubuntu-fw-fw memory size 4194304
   set virtual-network-functions ubuntu-fw-fw memory features hugepages
   
   
   root@jdm:~# virsh dumpxml ubuntu-fw-fw
   <domain type='kvm' id='10' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'>
     <name>ubuntu-fw-fw</name>
     <uuid>6b2cd81d-8948-493b-af8c-30b3837d98e9</uuid>
     <memory unit='KiB'>4194304</memory>
     <currentMemory unit='KiB'>4194304</currentMemory>
     <memoryBacking>
       <hugepages>
         <page size='1048576' unit='KiB'/>
       </hugepages>
       <locked/>
     </memoryBacking>
     <vcpu placement='static'>4</vcpu>
     <cputune>
       <emulatorpin cpuset='0-5,7-11'/>
     </cputune>
     <resource>
       <partition>/machine</partition>
     </resource>
     <sysinfo type='smbios'/>
     <os>
       <type arch='x86_64' machine='pc-i440fx-1.7'>hvm</type>
       <boot dev='hd'/>
       <smbios mode='sysinfo'/>
     </os>
     <features>
       <acpi/>
       <apic/>
       <pae/>
     </features>
     <cpu mode='host-model'>
       <model fallback='allow'/>
       <feature policy='require' name='vmx'/>
     </cpu>
     <clock offset='utc'/>
     <on_poweroff>destroy</on_poweroff>
     <on_reboot>restart</on_reboot>
     <on_crash>restart</on_crash>
     <devices>
       <emulator>/usr/bin/kvm</emulator>
       <disk type='file' device='disk'>
         <driver name='qemu' type='qcow2' cache='none'/>
         <source file='/var/third-party/CSP/ubuntu-fw-fw/xenial-server-cloudimg-amd64-disk1.qcow2'/>
         <backingStore/>
         <target dev='vda' bus='virtio'/>
         <alias name='virtio-disk0'/>
         <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>
       </disk>
       <disk type='file' device='cdrom'>
         <driver name='qemu' type='raw'/>
         <source file='/var/third-party/CSP/ubuntu-fw-fw/bootstrap_cfg.iso'/>
         <backingStore/>
         <target dev='vdb' bus='ide'/>
         <readonly/>
         <alias name='ide0-0-1'/>
         <address type='drive' controller='0' bus='0' target='0' unit='1'/>
       </disk>
       <controller type='usb' index='0'>
         <alias name='usb'/>
         <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/>
       </controller>
       <controller type='pci' index='0' model='pci-root'>
         <alias name='pci.0'/>
       </controller>
       <controller type='ide' index='0'>
         <alias name='ide'/>
         <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/>
       </controller>
       <interface type='network'>
         <mac address='ec:13:db:db:09:58'/>
         <source network='default' bridge='virbr0'/>
         <target dev='vnet8'/>
         <guest dev='eth0'/>
         <model type='virtio'/>
         <alias name='net0'/>
         <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
       </interface>
       <interface type='bridge'>
         <mac address='ec:13:db:db:09:59'/>
         <source bridge='eth0br'/>
         <target dev='vnet9'/>
         <guest dev='eth1'/>
         <model type='virtio'/>
         <driver name='qemu'/>
         <alias name='net1'/>
         <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>
       </interface>
       <interface type='vhostuser'>
         <mac address='ec:13:db:db:09:5a'/>
         <source type='unix' path='/var/run/openvswitch/ubuntu-fw-fw_eth2' mode='client'/>
         <guest dev='eth2'/>
         <model type='virtio'/>
         <alias name='net2'/>
         <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
       </interface>
       <interface type='vhostuser'>
         <mac address='ec:13:db:db:09:5b'/>
         <source type='unix' path='/var/run/openvswitch/ubuntu-fw-fw_eth3' mode='client'/>
         <guest dev='eth3'/>
         <model type='virtio'/>
         <alias name='net3'/>
         <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>
       </interface>
       <serial type='pty'>
         <source path='/dev/pts/4'/>
         <target port='0'/>
         <alias name='serial0'/>
       </serial>
       <console type='pty' tty='/dev/pts/4'>
         <source path='/dev/pts/4'/>
         <target type='serial' port='0'/>
         <alias name='serial0'/>
       </console>
       <memballoon model='none'>
         <alias name='balloon0'/>
       </memballoon>
     </devices>
     <qemu:commandline>
       <qemu:arg value='-object'/>
       <qemu:arg value='memory-backend-file,id=mem,size=4096M,mem-path=/dev/huge1G,share=on'/>
       <qemu:arg value='-numa'/>
       <qemu:arg value='node,memdev=mem'/>
       <qemu:arg value='-mem-prealloc'/>
     </qemu:commandline>
   </domain>
   

SD-WAN endpoint in AWS (aka Multicloud-scenario)
------------------------------------------------

.. warning:: **NO AUTOMATION** will be provided by the Team. Its too complex and individual all the time.

.. warning:: We strongly recommend NOT to try setting this up for a Demo or PoC until the Csutomer clealy insists in it. It way more simple and less configuration effort to execute this on the CSO BYOD OpenLab environment as already described in chapter 9.5 below.

.. warning:: Warning!Executing this lab is not for the weak and faint-hearted!!!

The reason for this is that we cannot be construct this as a canned and known Demo as with the other labs. **We depend on individual forwarding of TWO PUBLIC IP’s to this lab from the outside for this to work.**

Some Customers do not even allow this and as a result you can’t execute this lab as a Workload in AWS needs to talk to CSO and your Hub.

For Customers who are flexible to open their firewall for you, the local IT Folks need to change their Firewall rules accordingly. This is **VERY hard to debug** and errors will definitely happen even with a well prepared list as below.

It is recommended to have a close loop with the local IP Folks managing the Customer Firewall. To our own experience you should foresee a **couple of Days** for this Lab to work flawlessly.

There is also now golden way how you connect from the IT-Firewall of your Customer to CSO and the Hub. The example below is one we realized in Juniper Amsterdam slab. This might not look the same in your environment and you may not be able to clone this.

You need a SOLID understanding of how this reference lab is constructed before you are able to adapt and integrate it locally. This is the reason why this Lab does not appear in the customer facing Test plan not to bring you into trouble.

Another thing to mention here is that for a regular environment you would have to completely reinstall CSO again. During the installation there are a couple of question to put CSO behind NAT in chapter 3.2.8 above which is needed for this feature to work. As we did not fill in those values only a complete re-install would correct this to a production grade environment with no extra steps needed.

**We did not chose to re-install CSO** just for this lab adding ANOTHER Pitfall. **Instead we tweak** several time during and after **installation** and document what to tweak for you. You should be able follow this process as well in own labs.

We are aware this doesn’t look good in front of a customer as it’s manual steps but you should be able to explain that this is a sacrifice we made to the customer to adjust the expectations.

On the other hand this tweak allows us to use other, regular Spoke as well same-time.

Following port forwarding rules on IT FW:

.. code-block:: none

   HTTPS:        Src: EIP1, Dst: PIP1, DestPort:  443, TCP   -> To Regional MSVM,  443
   Outbound SSH: Src: EIP1, Dst: PIP1, DestPort: 7804, TCP   -> To Regional MSVM, 7804
   BGP:          Src: EIP1, Dst: PIP1, DestPort:  179, TCP   -> To vRR,            179
   Syslog:       Src: EIP1, Dst: PIP1, DestPort:  514, UDP   -> To Regional SBLB,  514
   FlowStats:    Src: EIP1, Dst: PIP1, DestPort:  514, TCP   -> To Regional SBLB,  514
   AppTrackLogs: Src: EIP1, Dst: PIP1, DestPort: 3514, TCP   -> To Regional SBLB, 3514
   IKE WAN0:     Src: EIP1, Dst: PIP1, DestPort:  500, UDP   -> To HUB WAN0,       500
   IKE WAN1:     Src: EIP2, Dst: PIP2, DestPort:  500, UDP   -> To HUB WAN1,       500
   IPSec WAN0:   Src: EIP1, Dst: PIP1, DestPort: 4500, UDP   -> To HUB WAN0,      4500
   IPSec WAN1:   Src: EIP2, Dst: PIP2, DestPort: 4500, UDP   -> To HUB WAN1,      4500

Example Lab Topology from Juniper slab Amsterdam.

|image844|

Embedded Lab Plan of this special Setup.

**DOWNLOAD**
`Lab_Plan_AWS-Client.pdf <Lab_Plan_AWS-Client.pdf>`__


|image845|

Before the PoC starts
~~~~~~~~~~~~~~~~~~~~~

These are the conditions to pre

#. You need an AWS Account. (If not use your credit card and get one)
#. You need to select a Region and a VPC in the Region.
#. You need to create set of own Security credentials for SSH Keys to VM’s
#. You have to create 2 free Elastic IP’s in the VPC
#. You have to create 4 Subnets in the VPC
#. You need to implement the local firewall forwarding for the PoC similar to above

.. warning:: The TWO ELASTIC IP’s have to be known to pass you LAB Firewall. If this system is not in your control you have to do this way in advance to communicate this to IT to open it.

A few of these Steps are shown below:

Know or create your VPC-ID (and the IP-Range for it)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

|image846|

Create 2 free Elastic IP’s
^^^^^^^^^^^^^^^^^^^^^^^^^^

Services --> EC2 --> Elastic IP

|image847|

Create 4 Subnets within your VPC
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Services --> VPC --> Subnets |image848|

Changes and updates on the Devices
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To get this feature up and running a few changes on the Devices for the Underlay Traffic have to be done especially to add host routes for the two elastic IP’s and the LAN subnet in AWS.

In your Lab this might not be the same changes but the changes below should give you an idea what needs to be changed!

NAT VM changes
^^^^^^^^^^^^^^

In this lab we use the still free/not-defined eth0 to redirect the traffic from the CSO-VM with have the NAT-VM as default GW for everything outside the 192.168.10.0/24 subnet.

In our case the Traffic for the two AWS Elastic IPs has not to be send to the regular default GW at eth1 of this VM and instead another subnet is created to sed it to the DMZ gw for these two Host IP’s.

This may not be the same in your lab.

.. code-block:: none

   ifconfig eth0 192.168.210.1/24 up
   route add –host 18.184.47.41 gw 192.168.210.254
   route add –host 35.156.179.143 gw 192.168.210.254

You need to add a route for the LAN Subnet in AWS (or do NAT on the Hub)

We are suggesting for a PoC to forward the whole 172.16.0.0/12 VPC subnet range to the InternetAccessVR on the QFX51000-1 with the following Rule

.. code-block:: none

   route add -net 172.16.0.0 netmask 255.240.0.0 gw 192.168.70.254

QFX5100-1 changes
^^^^^^^^^^^^^^^^^

.. code-block:: none

   # define the two VLAN’s that are the destination for the Firewall of the POC lab for the links to the Hub
   delete interfaces xe-0/0/2
   set interfaces xe-0/0/2 vlan-tagging
   set interfaces xe-0/0/2 unit 211 vlan-id 211
   set interfaces xe-0/0/2 unit 211 family inet address 192.168.211.1/24
   set interfaces xe-0/0/2 unit 212 vlan-id 212
   set interfaces xe-0/0/2 unit 212 family inet address 192.168.212.1/24

   # Map AWS Elatic IP1 into host route for WAN_1 as BOTH ARE INTERNET-LINKS!!!
   set groups sdwan-basic routing-instances hub-wan1 interface xe-0/0/2.211
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 35.156.179.143/32 next-hop 192.168.211.254
   # Map AWS Elatic IP2 into host route for WAN_1 as regular Internet
   set groups sdwan-basic routing-instances hub-wan1 interface xe-0/0/2.212
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 18.184.47.41/32 next-hop 192.168.212.254

   # forward for AWS LANside subnets to hub WAN_1 interface
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 172.16.0.0/12 next-hop 192.168.191.254

Changes on Hub
^^^^^^^^^^^^^^

If you already have an existing OTHER Spoke up and running for the same Tenant you can add the Host-routes for the two Elastic IP before the Lab starts.

If not, and the AWS Spoke will be the first Spoke for a Tenant, you need to do this changes after the AWS Spoke is provisioned to get the IPsec Tunnels up.

.. code-block:: none

   set routing-instances WAN_1 routing-options static route 18.184.47.41/32 next-hop 192.168.191.1
   set routing-instances WAN_1 routing-options static route 35.156.179.143/32 next-hop 192.168.191.1

You may apply NAT at the Hub for Spoke internet traffic if you did not choose to add a route

.. code-block:: none

   set security nat source rule-set tointernet from zone trust-hubspoketenant
   set security nat source rule-set tointernet to interface ge-0/0/1.0
   set security nat source rule-set tointernet rule r2 match source-address 0.0.0.0/0
   set security nat source rule-set tointernet rule r2 then source-nat interface

Provision of the AWS Spoke
~~~~~~~~~~~~~~~~~~~~~~~~~~

For this lab the following Values are to be configured somewhere

.. code-block:: none

   Region: Frankfurt
   VPC-ID: vpc-51874e39
   EIP1:   35.156.179.143
   EIP2:   18.184.47.41
   WAN0:   172.31.1.10/24    172.31.1.1 as GW
   WAN1:   172.31.2.10/24    172.31.2.1 as GW
   LAN:    172.31.3.10/24
   MGNT:   172.31.4.10/24
   PIP1:   193.110.52.75
   PIP2:   193.110.52.76

Go to your Sites and add a Cloud-Spoke

|image849|

|image850|

Enter VPC-ID and MGNT Network information.

.. warning:: DO NOT CHANGE THE SPOKENAME!!Use “AWSspoke” please

|image851|

Select the Device Template

|image852|

Configure WAN_0 on the Spoke and EIP1 and WAN0 local subnet.

.. note:: The first 4 addresses of an AWS Subnet ARE NOT FREE that is why all our interface start/use **10**.

|image853|

Configure WAN_1 on the Spoke and EIP2 and WAN1 local subnet.

|image854|

Make no change in the next Field and hit enter.

|image855|

Use ge-0/0/2 for LAN as ge-0/0/0 and ge-0/0/1 are used already automatically for WAN\* and apply the correct subnet.

|image856|

Review LAN

|image857|

Click NEXT -> Ok on the overview dialogue.

Once the object is created select it and press ”Configure Site”

|image858|

Select your existing Hub and change all Overlay-Tunnels to “GRE over IPsec”

|image859|

|image860|

Apply a Name Server and Time zone.

|image861|

Enter an Activation Code you remember for the Template

|image862|

Then apply your configuration so that the cloud formation template will get rendered.

Next change to the Device View and click “Activate Device”

|image863|

Fill in your Activation Code and download the Template to your PC.

|image864|

|image865|

Do NOT press NEXT!!!

Load the cloud formation template into AWS first and once this is finished come back here.

|image866|

Go to AWS and Services --> Cloud Formation

Create a new Stack

|image867|

Upload your Template

|image868|

Click Next

|image869|

Just add your personal SSH Key here.

.. note:: It doesn’t matter really what you fill in here, just something!

|image870|

Just add the key “name” and value “cso”

|image871|

ACK the Checkbox and start the Cloud Formation Template

|image872|

Refresh the Template to review the changes

|image873|

.. warning:: Wait ~25minutes!!! until the Status changes to “Create_Complete”

Now open an SSH-connection as root to the EIP1 (Password “Embe1mpls”)

|image874|

.. code-block:: none

   cli
   edit
   show system services outbound-ssh | display set
   set system services outbound-ssh client CSO-e7303c80-69a5-11e8-81a5-0242ac102836 device-id 4c1c8feb-f4b2-4ad8-813d-aff69c643eb1.JUNOS
   set system services outbound-ssh client CSO-e7303c80-69a5-11e8-81a5-0242ac102836 secret "$9$BVsIEyWLxVb2vMaZDif5EcSyWL4oJH.PjikP5Qn6EcSrM8X7-Y2abwikqPQzEcSrlM7-VgoJXxDiHqf5IEhSyK8LNdwYKvoJZDkq0B1ElK"
   set system services outbound-ssh client CSO-e7303c80-69a5-11e8-81a5-0242ac102836 keep-alive
   set system services outbound-ssh client CSO-e7303c80-69a5-11e8-81a5-0242ac102836 services netconf
   set system services outbound-ssh client CSO-e7303c80-69a5-11e8-81a5-0242ac102836 192.168.10.45 port 7804

   # replace internal regionalmsvm ip with PIP1
   replace pattern 192.168.10.45 with 193.110.52.75
   commit and-quit

   # check if you get a connection to the CSO regional
   show security flow session destination-prefix 193.110.52.75
   Session ID: 146, Policy name: self-traffic-policy/1, Timeout: 1800, Valid
     In: 172.31.1.10/63619 --> 193.110.52.75/7804;tcp, Conn Tag: 0x0, If: .local..0, Pkts: 19, Bytes: 6270,
     Out: 193.110.52.75/7804 --> 172.31.1.10/24169;tcp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 19, Bytes: 3789,
   Total sessions: 1

   # you can also do this
   start shell
   netstat -an | grep 7804
   tcp4       0      0  172.31.1.10.50388                             193.110.52.75.7804                            ESTABLISHED

Only if you have an established connection proceed back to CSO and hit finally “NEXT”

|image875|

Wait a while until you see this state after ~5minutes:

|image876|

This will then kick the big Provisioning/ZTP Process

|image877|

As you certainly notice this Process lasts up to 10minutes!!!

|image878|

.. note:: Because our CSO in not configured behind NAT the IPsec Tunnels will NOT be UP! We have to correct this in the next chapter.

AWS Spoke changes to CSO
~~~~~~~~~~~~~~~~~~~~~~~~

As our CSO is not configured behind NAT we now need to change the configuration on the Spoke to correct the changes and be able to finally establish the IPsec Tunnels.

.. note:: CHECK THE HUB FIRST BEFORE YOU CHANGE THE SPOKEReview Chapter 7.10.2.3 above and implement the changes that “may” be needed.

.. code-block:: none

   cli
   edit
   # Get system name and confirm it's called "*AWSSpoke*"
   show system host-name
   host-name 1e82b24e-bb87-4fce-ad15-87570bc2e338.AWSpoke.hubspoketenant;

   show | display set | match gateway | match address
   set groups AWSSPOKE_WAN_0_HUB1_WAN_1_IPSEC_0 security ike gateway ad031af0b098108b73646b77abd42428 address 192.168.191.254
   set groups AWSSPOKE_WAN_1_HUB1_WAN_1_IPSEC_0 security ike gateway f4dfb1293f1efb8f93596d3db26706d6 address 192.168.191.254

   #use the retrieved dynamic numbers and change them below accordingly

   # delete the old internal Hub ips as tunnel destination
   delete groups AWSSPOKE_WAN_0_HUB1_WAN_1_IPSEC_0 security ike gateway ad031af0b098108b73646b77abd42428 address 192.168.191.254
   delete groups AWSSPOKE_WAN_1_HUB1_WAN_1_IPSEC_0 security ike gateway f4dfb1293f1efb8f93596d3db26706d6 address 192.168.191.254

   # change the tunnel destination to the two PIP*
   set groups AWSSPOKE_WAN_0_HUB1_WAN_1_IPSEC_0 security ike gateway ad031af0b098108b73646b77abd42428 address 193.110.52.75
   set groups AWSSPOKE_WAN_1_HUB1_WAN_1_IPSEC_0 security ike gateway f4dfb1293f1efb8f93596d3db26706d6 address 193.110.52.76 
   # change the tunnel mode to general-ikeid
   set groups AWSSPOKE_WAN_0_HUB1_WAN_1_IPSEC_0 security ike gateway ad031af0b098108b73646b77abd42428 general-ikeid
   set groups AWSSPOKE_WAN_1_HUB1_WAN_1_IPSEC_0 security ike gateway f4dfb1293f1efb8f93596d3db26706d6 general-ikeid
   
   delete groups srx-gwr-site-routing-config-172.31.1.10 protocols bgp group ibgp neighbor 192.168.10.49
   set groups srx-gwr-site-routing-config-172.31.1.10 protocols bgp group ibgp neighbor 193.110.52.75
   
   # delete the logging to southbound loadbalancer
   delete system syslog host 192.168.10.47 authorization any
   delete system syslog host 192.168.10.47 port 514
   delete system syslog host 192.168.10.47 structured-data
   delete security log stream app-track-logs host 192.168.10.47
   delete security log stream all-logs host 192.168.10.47

   # delete the logging to PIP1 instead
   set system syslog host 193.110.52.75 authorization any
   set system syslog host 193.110.52.75 port 514
   set system syslog host 193.110.52.75 structured-data
   set security log stream app-track-logs host 193.110.52.75
   set security log stream all-logs host 193.110.52.75
   
   set routing-options static route 193.110.52.75 next-hop 172.31.1.1
   set routing-options static route 193.110.52.76 next-hop 172.31.2.1
   commit and-quit

Now debug the connection

.. code-block:: none

   show bgp summary
   Groups: 1 Peers: 1 Down peers: 0
   Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
   bgp.l3vpn.0
                         17          0          0          0          0          0
   Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
   193.110.52.75         64512         35         22       0       0        3:37 Establ
     bgp.l3vpn.0: 0/17/17/0
     transit.inet.0: 0/1/1/0
     LAN-hubspoketenant_DefaultVPN.inet.0: 0/3/3/0
     Default-hubspoketenant_DefaultVPN.inet.0: 0/2/2/0
     Default-reverse-hubspoketenant_DefaultVPN.inet.0: 0/2/2/0
     internet-hubspoketenant_DefaultVPN.inet.0: 0/2/2/0
   
   show security ike security-associations
   Index   State  Initiator cookie  Responder cookie  Mode           Remote Address
   4313360 UP     1330c9573fcf3d13  b158fcabbd1f20c7  IKEv2          193.110.52.75
   4313361 UP     197a9b937851f650  3a123cfa467a8a9a  IKEv2          193.110.52.76
   
   show security ipsec security-associations
     Total active tunnels: 2
     ID    Algorithm       SPI      Life:sec/kb  Mon lsys Port  Gateway
     <131073 ESP:aes-gcm-256/None 4e466c0d 3324/ unlim - root 4500 193.110.52.75
     >131073 ESP:aes-gcm-256/None 9ee091cf 3324/ unlim - root 4500 193.110.52.75
     <131074 ESP:aes-gcm-256/None 229b266f 3325/ unlim - root 4500 193.110.52.76
     >131074 ESP:aes-gcm-256/None aadb47b2 3325/ unlim - root 4500 193.110.52.76 

Now make sure that a Firewall Policy is in place and deployed onto the Spoke that allows communication to the Internet like the below.

|image879|

This is a must for the next step!

Verify communication to Internet works (this step MUST work even without correct Firewall) if not you have a major issue.

.. code-block:: none

   ping 8.8.8.8
   PING 8.8.8.8 (8.8.8.8): 56 data bytes
   64 bytes from 8.8.8.8: icmp_seq=0 ttl=56 time=1.917 ms
   64 bytes from 8.8.8.8: icmp_seq=1 ttl=56 time=1.717 ms
   64 bytes from 8.8.8.8: icmp_seq=2 ttl=56 time=1.672 ms
   64 bytes from 8.8.8.8: icmp_seq=3 ttl=56 time=2.665 ms
   64 bytes from 8.8.8.8: icmp_seq=4 ttl=56 time=2.849 ms
   64 bytes from 8.8.8.8: icmp_seq=5 ttl=56 time=1.993 ms
   ^C
   --- 8.8.8.8 ping statistics ---
   6 packets transmitted, 6 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 1.672/2.135/2.849/0.456 ms

Via a second SSH session while the ping is still running you can check that the Traffic goes directly to ge-0/0/0 or ge-0/0/1. This is expected for local inet.0 Traffic from the device.

.. code-block:: none

   show security flow session destination-prefix 8.8.8.8
   Session ID: 14346, Policy name: self-traffic-policy/1, Timeout: 2, Valid
     In: 172.31.1.10/3 --> 8.8.8.8/61573;icmp, Conn Tag: 0x0, If: .local..0, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/61573 --> 172.31.1.10/22701;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84,
   
   Session ID: 14347, Policy name: self-traffic-policy/1, Timeout: 2, Valid
     In: 172.31.1.10/4 --> 8.8.8.8/61573;icmp, Conn Tag: 0x0, If: .local..0, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/61573 --> 172.31.1.10/13535;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84,
   
   Session ID: 14349, Policy name: self-traffic-policy/1, Timeout: 4, Valid
     In: 172.31.1.10/5 --> 8.8.8.8/61573;icmp, Conn Tag: 0x0, If: .local..0, Pkts: 1, Bytes: 84,
     Out: 8.8.8.8/61573 --> 172.31.1.10/25383;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84,
   Total sessions: 3

Verify the routes for the LAN Routeing instance.

The 10.66.66.0/24 Route is from another Spoke and may not be present in your lab.

.. code-block:: none

   show route
   .
   LAN-hubspoketenant_DefaultVPN.inet.0: 4 destinations, 5 routes (4 active, 0 holddown, 1 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 09:02:37, localpref 200, from 193.110.52.75
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 16
                         via gr-0/0/0.4000, Push 16
   10.66.66.0/24      *[BGP/170] 09:02:37, localpref 100, from 193.110.52.75
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4000, Push 18
   172.31.3.0/24      *[Direct/0] 09:24:25
                       > via ge-0/0/2.0
   172.31.3.10/32     *[Local/0] 09:24:25
                         Local via ge-0/0/2.0
   .

No other connectivity testes can be done right now. You need a Desktop VM which we attach in the next Chapter to issue traffic for this.

Before you move over to present other aspects **update the license** on the vSRX AWS Spoke and **download a App-IDP-Signature set MANUALLY**.

It is possible to push toe licence directly via CSO (and the GUI for example) but this is NOT possible for the SLA-Signatures as CSO is not correctly configured behind NAT so the IP-Address CSO would send to the Spoke to download the signature set would be wrong and not PIP1.

The best way is to add the license for this lab directly and then trigger downloading the Signatures directly after that.

.. code-block:: none

   request system license add terminal
   [Type ^D at a new line to end input,
    enter blank line between each license key]
   JUNOS988878 aeaqib qbo4fq 4ojrg4 ztaqjq gaztan bsgq4q
    ycsmif bg64df nzwgcy qhfblr iodnqp f5qjma yeo56q somr4x
    7g5lhk odjend xs6evw u2bmyx qdmgas jgtxel tas64
   
   JUNOS851122 aeaqic a6ajc4 fuohde bhhqwr y4mqeq 6c2hdr saq5yl
    i4ogic dpbndr yzbmhd smjxgm yecmbq gi2dao bqhagb etcbij
    fhk3tj obsxei ctpfzx izltoq dsrnpk jjgpis 36dt5b ve3h6f
   
   <CTRL-D>
   terminal:5 warning: JUNOS851122: license already exists, not modified
   JUNOS988878: successfully added
   add license complete (no errors)

   show system license
   License usage:
                                    Licenses     Licenses    Licenses    Expiry
     Feature name                       used    installed      needed
     anti_spam_key_sbl                     0            1           0    2019-11-01 01:00:00 CET
     idp-sig                               0            1           0    2019-11-01 01:00:00 CET
     appid-sig                             0            1           0    2019-11-01 01:00:00 CET
     av_key_sophos_engine                  0            1           0    2019-11-01 01:00:00 CET
     wf_key_websense_ewf                   0            1           0    2019-11-01 01:00:00 CET
     Virtual Appliance                     1            1           0    permanent
     remote-access-ipsec-vpn-client        0            2           0    permanent
   
   Licenses installed:
     License identifier: E420588955
     License version: 4
     Software Serial Number: 20150625
     Customer ID: vSRX-JuniperEval
     Features:
       Virtual Appliance - Virtual Appliance
         count-down, Original validity: 60 days
   
     License identifier: JUNOS851122
     License version: 4
     Software Serial Number: 91730A00240808
     Customer ID: LABJuniper Systest
     Features:
       av_key_sophos_engine - Anti Virus with Sophos Engine
         date-based, 2016-10-31 01:00:00 CET - 2019-11-01 01:00:00 CET
       wf_key_websense_ewf - Web Filtering EWF
         date-based, 2016-10-31 01:00:00 CET - 2019-11-01 01:00:00 CET
       appid-sig        - APPID Signature
         date-based, 2016-10-31 01:00:00 CET - 2019-11-01 01:00:00 CET
       idp-sig          - IDP Signature
         date-based, 2016-10-31 01:00:00 CET - 2019-11-01 01:00:00 CET
       anti_spam_key_sbl - Anti-Spam
         date-based, 2016-10-31 01:00:00 CET - 2019-11-01 01:00:00 CET
   
     License identifier: JUNOS988878
     License version: 4
     Software Serial Number: 91730A00304249
     Customer ID: LABopenlab
     Features:
       Virtual Appliance - Virtual Appliance
         permanent

Download and install the Signatures manually as in below example

.. code-block:: none

   ping signatures.juniper.net
   PING sus-prod.junipercloud.net (54.69.231.26): 56 data bytes
   64 bytes from 54.69.231.26: icmp_seq=0 ttl=237 time=159.607 ms
   64 bytes from 54.69.231.26: icmp_seq=1 ttl=237 time=159.443 ms
   64 bytes from 54.69.231.26: icmp_seq=2 ttl=237 time=159.443 ms
   ^C
   --- sus-prod.junipercloud.net ping statistics ---
   3 packets transmitted, 3 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 159.443/159.498/159.607/0.077 ms
   
   request services application-identification download
   Please use command
           "request services application-identification download status" to check download status
   
   request services application-identification download status
   Downloading application package 3071 succeeded.

   request services application-identification install
   re0:
   --------------------------------------------------------------------------
   Please use command
           "request services application-identification install status" to check install status

   request services application-identification install status
   Installed
           Application package (3071) and Protocol bundle successfully

Add a Desktop VM in AWS-VPC to Test the configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

We are going to us a nice ready to deploy (but not free) VM from the Amazon Marketplace to provide an Ubuntu Desktop instead of building our own because this is faster and the additional costs are negligible.

Go to your AWS Marketplace https://aws.amazon.com/marketplace and search for “Netspectrum” |image880|

Go with one of the two version below. It doesn’t really matter.

|image881|

|image882|

|image883|

|image884|

|image885|

|image886|

Connect your VM to the right VPC and Subnet “LAN” and do NOT assign a Public IP to make this VM really internal!

|image887|

|image888|

Select or create a new Key Pair. It doesn’t matter for THIS VM as the login credentials are based on the dynamic Instance-ID. Finally launch the instance.

|image889|

Note down the created instance id because this is also the Password for the next Step.

|image890|

.. note:: When this VM launches your SSH-Connection to the Spoke might be interrupted! Simply re-attach and continue.

This VM takes 2-3minutes to come up.

Go to the AWS Console Services -> EC2 -> Instances

|image891|

For your new instance check which Private IP was assigned

|image892|

In this case we have 172.31.3.63 now we need to create a Firewall/Nat rule on the AWS Spoke to forward Traffic for VNC Port 5901 (default for this VM) to the internal Lan else we can’t connect to this VM from the outside to manage it via EIP1 as its bound to ge-0/0/0 Interface of this vSRX for WAN0.

.. code-block:: none

   set security nat destination pool VM address 172.31.3.63
   set security nat destination rule-set toVM from interface ge-0/0/0
   set security nat destination rule-set toVM rule VNC match source-address 0.0.0.0/0
   set security nat destination rule-set toVM rule VNC match destination-address 172.31.1.10/32
   set security nat destination rule-set toVM rule VNC match destination-port 5901
   set security nat destination rule-set toVM rule VNC then destination-nat pool VM
   set security policies from-zone untrust to-zone untrust policy VNC match source-address any
   set security policies from-zone untrust to-zone untrust policy VNC match destination-address any
   set security policies from-zone untrust to-zone untrust policy VNC match application any
   set security policies from-zone untrust to-zone untrust policy VNC then permit
   commit and-quit

In this case the Instance-id/Password is “i-02e53bb06933779c2”

This VM will use the VNC Port 5901 reachable over EIP1

|image893|

|image894|

|image895|

.. code-block:: none

   sudo apt-get install -y traceroute
   traceroute –n 8.8.8.8

|image896|

You should NOW (and not before) finally see Traffic Application detected (or wait at least % minutes for the DB to fill).

|image897|

|image898|

Appendix
========

References and Videos
---------------------

The new Lab Automation offers way to extuce PoC’s faster and prevent Human error. Here is a Demo of it how this makes PoC execution faster for you. https://easylink.juniper.net/AutomateCSORef

`CSO 4.1 new Feature introduction Video <https://easylink.juniper.net/CSO41Demo>`__. Contains a Demo on Mesh-Tags, Dynamic Tunnels and Site-Gateway using a link to a CC13 SDN environment. The details on how this Demo was set-up are shared with you in chapter 9.6 below.

`CSO V4.1.0 ToI Slides and Recordings <https://junipernetworks.sharepoint.com/teams/toi/vCPE/SitePages/Home.aspx?RootFolder=%2Fteams%2Ftoi%2FvCPE%2Fdocs%2FJCS%204%2E1&FolderCTID=0x0120003625164488993749AFDF50FF4BE3021C&View=%7BB9BADFD7%2D3D71%2D45AE%2DA529%2DBCEB37CD6743%7D>`__.

`CSO V4.0.2 Test cases from the BU <https://junipernetworks.sharepoint.com/:f:/s/Projects1/nethranpi/EpNYP5FYq2ZMiqHVP0pA1-UBDA5oqMRKVg0LguTiU9RjdA?e=n590mz>`__. 90% of what is described there is executeable with this Reference Lab. There are some test case for minor features like RBAC you might add but those are usually trivial and don’t need a big description how they work.

CSO V3.3 Solution Document. You should review this for Stuff you want to execute outside of the documentation of this Lab.

https://junipernetworks.sharepoint.com/:w:/s/Projects1/nethranpi/EYI9Hjv0GwpFt0Z7Ys_A1IoBlw9Omrbt3MaAdCMgTobStQ?e=DwNFim

`CSO SD-WAN Design & Architecture Guide <https://www.juniper.net/documentation/en_US/release-independent/solutions/information-products/pathway-pages/sg-007-contrail-sd-wan-design-architecture.pdf>`__ this is a **MUST READ** before you start any PoC because you need to know this background and explain it to the customer.

`All CSO Collateral from the BU <https://junipernetworks.sharepoint.com/sites/open1/cloud-srv/SitePages/Community%20Home.aspx?RootFolder=%2Fsites%2Fopen1%2Fcloud%2Dsrv%2Fdocs%2FJCS%203%2EX%2F3%2E3%2F3%2E3%20GTM%20Content&FolderCTID=0x01200044CA491B18DD00418726A019681830EA&View=%7BB4487209%2DE277%2D4ED3%2DBF47%2DB441134B8EA2%7D>`__ (incl. Roadmaps etc.)

API-Guide https://apps.juniper.net/home/fetch/download.html?file=cso-api-guide-3.3.pdf

To subscribe to the internal Mailing list use: https://junipernetworks.sharepoint.com/sites/CloudServicesPlatform

TDM Deck for CSO 4.0.2 https://junipernetworks.sharepoint.com/:p:/s/Projects1/nethranpi/EVk4kjGOb-NGl5DjTvJYF5wBNs3tT6LegQZN0htLmhveug?e=iS6p3E

Videos of SD-WAN and Security Features (pick the newest)

https://junipernetworks.sharepoint.com/sites/Projects1/nethranpi/controlled/Forms/AllItems.aspx?id=%2Fsites%2FProjects1%2Fnethranpi%2Fcontrolled%2FTME%20Documents%2FCSO3%2E2DemoVideos

All recorded ToI’s are here https://junipernetworks.sharepoint.com/teams/toi/vCPE/SitePages/Home.aspx

Raspberry Pi changes
--------------------

.. code-block:: none

   cat /etc/network/interfaces
   # interfaces(5) file used by ifup(8) and ifdown(8)

   # Please note that this file is written to be used with dhcpcd
   # For static IP, consult /etc/dhcpcd.conf and 'man dhcpcd.conf'

   # Include files from /etc/network/interfaces.d:
   source-directory /etc/network/interfaces.d

   auto lo
   iface lo inet loopback

   auto eth0
   iface eth0 inet static
     address 192.168.10.2
     netmask 255.255.255.0

   auto eth0:1
   iface eth0:1 inet static
     address 172.30.200.152
     netmask 255.255.255.0
     gateway 172.30.200.1
     dns-nameservers 172.30.200.2

   #allow-hotplug wlan0
   #iface wlan0 inet manual
   #    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf

   #allow-hotplug wlan1
   #iface wlan1 inet manual
   #    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf




   systemctl disable openvpn
   service isc-dhcp-server stop


   root@raspberrypi:~# route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         172.30.200.1    0.0.0.0         UG    0      0        0 eth0
   169.254.0.0     0.0.0.0         255.255.0.0     U     202    0        0 eth0
   172.30.200.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0


   #http://www.myteneo.net/blog/-/blogs/create-your-own-serial-terminal-server/
   #https://sourceforge.net/projects/ser2net/

   apt-get -y install ser2net

   #
   # manual compile and install instead of apt-get
   #
   #cd /root
   #wget http://downloads.sourceforge.net/project/ser2net/ser2net/ser2net-3.5.tar.gz
   #tar -zxvf ser2net-3.5.tar.gz
   #cd ser2net-3.5/
   #./configure
   #make
   #make install
   #make clean
   #cp ser2net.conf /etc/
   #cd /root

   cp /etc/ser2net.conf /etc/ser2net.conf.orig

   cat <<EOF >/etc/ser2net.conf
   7000:telnet:0:/dev/ttyUSB0:9600
   7001:telnet:0:/dev/ttyUSB1:9600
   7002:telnet:0:/dev/ttyUSB2:9600
   7003:telnet:0:/dev/ttyUSB3:9600
   7004:telnet:0:/dev/ttyUSB4:9600
   EOF

   service ser2net restart

   #telnet 192.168.10.2 7000
   #telnet 192.168.10.2 7001
   #telnet 192.168.10.2 7002
   #telnet 192.168.10.2 7003
   #telnet 192.168.10.2 7004

Known stable Ubuntu VM as NAT-GW instead of vSRX V3.0
-----------------------------------------------------

.. note:: Prior V2.7 of the lab documentation we used the Ubuntu based natvm approach as it was MORE STABLE. Please do not try again any vSRX V2.0 under Ubuntu 14.04.5 as it’s futile. We now changed to vSRX V3.0 when I came avail end 2018.If you still see something weird with vSRX V3.0 as natvm please use this Ubuntu based appread as it was known to work long ago.

Also this VM gives us the **OPTIONAL** ability to install Apache Guacamole on it for remote access via HTML5.

.. code-block:: none

   ssh root@192.168.10.10
   
   cd /root
   
   # wget https://cloud-images.ubuntu.com/trusty/current/trusty-server-cloudimg-amd64-disk1.img
   
   virsh destroy natvm
   virsh undefine natvm
   # cp trusty-server-cloudimg-amd64-disk1.img /var/lib/libvirt/images/natvm.qcow2
   cp /root/Contrail_Service_Orchestration_4.1.0/artifacts/ubuntu-14.04.5_163.img /var/lib/libvirt/images/natvm.qcow2
   chmod 666 /var/lib/libvirt/images/natvm.qcow2
   
   cat <<EOF > meta-data
   hostname: natvm
   local-hostname: natvm
   instance-id: natvm
   EOF
   
   cat <<EOF > user-data
   #cloud-config
   apt_update: true
   disable_root: false
   manage_etc_hosts: false
   chpasswd:
     list: |
       root:juniper123
     expire: False
   ssh_pwauth: True
   final_message: "The system is finally up, after $UPTIME seconds"
   fqdn: lab-gw.example.net
   groups:
     - cloud-users
   users:
     - default
   runcmd:
     - sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
     - mount /dev/vdb /mnt
     - cp /mnt/vlan_1.9-3ubuntu10.1_amd64.deb /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - dpkg -i /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - sed -i '/net.ipv4.ip_forward/s/^#//g' /etc/sysctl.conf
     - sysctl -p /etc/sysctl.conf
     - touch /etc/cloud/cloud-init.disabled
     - service ssh restart
     - ufw enable; ufw allow ssh
     - iptables -F
     - iptables -X
     - iptables -t nat -F
     - iptables -t nat -X
     - iptables -t mangle -F
     - iptables -t mangle -X
     - iptables -t raw -F
     - iptables -t raw -X
     - iptables -P INPUT ACCEPT
     - iptables -P FORWARD ACCEPT
     - iptables -P OUTPUT ACCEPT
     - iptables -t nat -A POSTROUTING -o eth1.42 -j MASQUERADE
     - iptables -A FORWARD -i eth1.42 -o eth2 -m state --state RELATED,ESTABLISHED -j ACCEPT
     - iptables -A FORWARD -i eth2 -o eth1.42 -j ACCEPT
     - iptables -A FORWARD -i eth1.42 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT
     - iptables -A FORWARD -i eth3 -o eth1.42 -j ACCEPT
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 22 -j DNAT -d 172.30.200.155 --to-destination 192.168.10.10
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 3128 -j DNAT -d 172.30.200.155 --to-destination 192.168.10.10
     - iptables -t nat -A PREROUTING -d 172.30.200.155 -i eth1.42 -p tcp --dport 443 -j DNAT --to-destination 192.168.10.42
     - iptables -t nat -A PREROUTING -d 172.30.200.155 -i eth1.42 -p tcp --dport 83 -j DNAT --to-destination 192.168.10.42
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 5900:5999 -j DNAT -d 172.30.200.155 --to-destination 192.168.10.10
     - iptables-save > /etc/network/iptables.rules
     - |
       cloud-init-per instance set_network_interface
   
       echo 'auto lo
       iface lo inet loopback
   
       auto eth1
       iface eth1 inet manual
   
       auto eth1.42
       iface eth1.42 inet static
       vlan_raw_device eth1
       address 172.30.200.155
       netmask 255.255.255.0
       gateway 172.30.200.1
       pre-up iptables-restore < /etc/network/iptables.rules
   
       auto eth2
       iface eth2 inet static
       address 192.168.10.1
       netmask 255.255.255.0
       up route add -net 192.168.68.0 netmask 255.255.255.0 gw 192.168.10.15
       up route add -net 192.168.69.0 netmask 255.255.255.0 gw 192.168.10.70
   
       auto eth3
       iface eth3 inet manual
   
       auto eth3.70
       iface eth3.70 inet static
       vlan_raw_device eth3
       address 192.168.70.1
       netmask 255.255.255.0
       up route add -net 192.168.128.0 netmask 255.255.128.0 gw 192.168.70.254
       up route add -net 10.88.88.0 netmask 255.255.255.0 gw 192.168.70.254
       up route add -net 10.66.66.0 netmask 255.255.255.0 gw 192.168.70.254
   
       auto eth3.74
       iface eth3.74 inet static
       vlan_raw_device eth3
       address 192.168.74.1
       netmask 255.255.255.0
       up route add -net 10.77.77.0 netmask 255.255.255.0 gw 192.168.74.254
   
       auto eth3.75
       iface eth3.75 inet static
       vlan_raw_device eth3
       address 192.168.75.1
       netmask 255.255.255.0
       up route add -net 10.99.99.0 netmask 255.255.255.0 gw 192.168.75.254
       up route add -net 192.168.66.0 netmask 255.255.255.0 gw 192.168.75.254
       up route add -net 192.168.67.0 netmask 255.255.255.0 gw 192.168.75.254
   
       auto eth3.76
       iface eth3.76 inet static
       vlan_raw_device eth3
       address 192.168.76.1
       netmask 255.255.255.0
       up route add -net 192.168.65.0 netmask 255.255.255.0 gw 192.168.75.254
   
   
       ' > /etc/network/interfaces
   
     - cp /etc/network/interfaces /etc/network/interfaces.default
     - |
       cloud-init-per instance setup_etc_host echo '127.0.1.1 lab-gw.example.net lab-gw' >> /etc/hosts
   power_state:
     mode: reboot
     delay: "now"
     timeout: 120
   EOF
   
   # add vlan package to iso
   #wget http://archive.ubuntu.com/ubuntu/pool/main/v/vlan/vlan_1.9-3ubuntu10.1_amd64.deb
   wget http://launchpadlibrarian.net/289303823/vlan_1.9-3ubuntu10.1_amd64.deb
   
   genisoimage -o natvm.iso -V cidata -r -J meta-data user-data vlan_1.9-3ubuntu10.1_amd64.deb
   
   virt-install -n natvm -r 1024 --vcpus=1 \
   --disk path=/var/lib/libvirt/images/natvm.qcow2,format=qcow2,size=20,device=disk,bus=virtio \
   --import --disk path=/root/natvm.iso,device=cdrom,bus=virtio --os-type linux --hvm \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --graphics vnc,listen=0.0.0.0 --noautoconsole
   
   virsh autostart natvm
   
   virsh console natvm
   
   ifconfig
   eth1      Link encap:Ethernet  HWaddr 52:54:00:da:c3:ce
             inet addr:172.30.200.155  Bcast:172.30.200.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:feda:c3ce/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:16582 errors:0 dropped:38 overruns:0 frame:0
             TX packets:45 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:5478642 (5.4 MB)  TX bytes:3356 (3.3 KB)
   
   eth2      Link encap:Ethernet  HWaddr 52:54:00:49:6b:bc
             inet addr:192.168.10.1  Bcast:192.168.10.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:fe49:6bbc/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:16723 errors:0 dropped:37 overruns:0 frame:0
             TX packets:16 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:5517117 (5.5 MB)  TX bytes:1376 (1.3 KB)
   
   eth3      Link encap:Ethernet  HWaddr 52:54:00:bc:a3:08
             inet6 addr: fe80::5054:ff:febc:a308/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:17497 errors:0 dropped:40 overruns:0 frame:0
             TX packets:31 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:5782764 (5.7 MB)  TX bytes:2614 (2.6 KB)
   
   eth3.74   Link encap:Ethernet  HWaddr 52:54:00:bc:a3:08
             inet addr:192.168.74.1  Bcast:192.168.74.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:febc:a308/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:648 (648.0 B)
   
   eth3.75   Link encap:Ethernet  HWaddr 52:54:00:bc:a3:08
             inet addr:192.168.75.1  Bcast:192.168.75.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:febc:a308/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:648 (648.0 B)
   
   eth3.76   Link encap:Ethernet  HWaddr 52:54:00:bc:a3:08
             inet addr:192.168.76.1  Bcast:192.168.76.255  Mask:255.255.255.0
             inet6 addr: fe80::5054:ff:febc:a308/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
             RX packets:0 errors:0 dropped:0 overruns:0 frame:0
             TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:0 (0.0 B)  TX bytes:648 (648.0 B)
   
   lo        Link encap:Local Loopback
             inet addr:127.0.0.1  Mask:255.0.0.0
             inet6 addr: ::1/128 Scope:Host
             UP LOOPBACK RUNNING  MTU:65536  Metric:1
             RX packets:128 errors:0 dropped:0 overruns:0 frame:0
             TX packets:128 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:0
             RX bytes:9536 (9.5 KB)  TX bytes:9536 (9.5 KB)
   
   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         172.30.200.1    0.0.0.0         UG    0      0        0 eth1
   10.77.77.0      192.168.74.254  255.255.255.0   UG    0      0        0 eth3.74
   10.99.99.0      192.168.75.254  255.255.255.0   UG    0      0        0 eth3.75
   172.30.200.0    0.0.0.0         255.255.255.0   U     0      0        0 eth1
   192.168.10.0    0.0.0.0         255.255.255.0   U     0      0        0 eth2
   192.168.65.0    192.168.75.254  255.255.255.0   UG    0      0        0 eth3.75
   192.168.66.0    192.168.75.254  255.255.255.0   UG    0      0        0 eth3.75
   192.168.67.0    192.168.75.254  255.255.255.0   UG    0      0        0 eth3.75
   192.168.68.0    192.168.10.15   255.255.255.0   UG    0      0        0 eth2
   192.168.69.0    192.168.10.70   255.255.255.0   UG    0      0        0 eth2
   192.168.74.0    0.0.0.0         255.255.255.0   U     0      0        0 eth3.74
   192.168.75.0    0.0.0.0         255.255.255.0   U     0      0        0 eth3.75
   192.168.76.0    0.0.0.0         255.255.255.0   U     0      0        0 eth3.76
   
   cat /etc/network/iptables.rules
   # Generated by iptables-save v1.4.21 on Tue Mar 20 09:11:19 2018
   *raw
   :PREROUTING ACCEPT [12:3851]
   :OUTPUT ACCEPT [0:0]
   COMMIT
   # Completed on Tue Mar 20 09:11:19 2018
   # Generated by iptables-save v1.4.21 on Tue Mar 20 09:11:19 2018
   *mangle
   :PREROUTING ACCEPT [21:6777]
   :INPUT ACCEPT [21:6777]
   :FORWARD ACCEPT [0:0]
   :OUTPUT ACCEPT [0:0]
   :POSTROUTING ACCEPT [0:0]
   COMMIT
   # Completed on Tue Mar 20 09:11:19 2018
   # Generated by iptables-save v1.4.21 on Tue Mar 20 09:11:19 2018
   *nat
   :PREROUTING ACCEPT [0:0]
   :INPUT ACCEPT [0:0]
   :OUTPUT ACCEPT [0:0]
   :POSTROUTING ACCEPT [0:0]
   -A PREROUTING -d 172.30.200.155/32 -i eth1 -p tcp -m tcp --dport 22 -j DNAT --to-destination 192.168.10.10
   -A PREROUTING -d 172.30.200.155/32 -i eth1 -p tcp -m tcp --dport 3128 -j DNAT --to-destination 192.168.10.10
   -A PREROUTING -d 172.30.200.155/32 -i eth1 -p tcp -m tcp --dport 5900:5999 -j DNAT --to-destination 192.168.10.10
   -A POSTROUTING -o eth1 -j MASQUERADE
   COMMIT
   # Completed on Tue Mar 20 09:11:19 2018
   # Generated by iptables-save v1.4.21 on Tue Mar 20 09:11:19 2018
   *filter
   :INPUT ACCEPT [0:0]
   :FORWARD ACCEPT [0:0]
   :OUTPUT ACCEPT [0:0]
   -A FORWARD -i eth1 -o eth2 -m state --state RELATED,ESTABLISHED -j ACCEPT
   -A FORWARD -i eth2 -o eth1 -j ACCEPT
   -A FORWARD -i eth1 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT
   -A FORWARD -i eth3 -o eth1 -j ACCEPT
   COMMIT
   # Completed on Tue Mar 20 09:11:19 2018
   

.. warning:: The following section contains an **OPTIONAL** Apache guacamole installation for easy remote web browsing, vnc-viewer and ssh/telenet via web-browser/html5.\ **YOU DON’T NEED TO CONFIGURE THIS** but it’s good for people struggeling with own vnc-viewers, ssh/telnet-clients and so on.

Basics are explained here https://www.tecmint.com/guacamole-access-remote-linux-windows-machines-via-web-browser/

We use the setup scripts provided here https://jasoncoltrin.com/2017/10/04/setup-guacamole-remote-desktop-gateway-on-ubuntu-with-one-script/

.. code-block:: none

   ssh root@192.168.10.1 (juniper123)
   
   cat <<EOF >/etc/resolv.conf
   nameserver 8.8.8.8
   EOF
   
   wget https://raw.githubusercontent.com/MysticRyuujin/guac-install/master/guac-install.sh
   chmod +x guac-install.sh
   ./guac-install.sh
   
   cat <<EOF >/etc/rc.local
   #!/bin/sh -e
   #
   # rc.local
   #
   # This script is executed at the end of each multiuser runlevel.
   # Make sure that the script will "exit 0" on success or any other
   # value on error.
   #
   # In order to enable or disable this script just change the execution
   # bits.
   #
   service guacd start
   
   exit 0
   EOF
   
   
   http://172.30.200.155:8080/guacamole/  (guacadmin/guacadmin)
   # http://172.30.200.155:8080/guacamole/#/settings/sessions

   # setup accounts and devices OR (faster) use the dumpfile below!

   # backup you mysql db with all the info
   mysqldump -u root -p --databases guacamole_db > dbdump.sql
   gzip dbdump.sql

You should have now a structure similar to the below

|image899|

Here is the dumpfile for the easy reconstruction

**DOWNLOAD**
`dbdump.sql.gz <dbdump.sql.gz>`__


|image900|

.. code-block:: none

   gunzip dbdump.sql.gz
   mysql -u root -p
   
   DROP DATABASE guacamole_db;
   source dbdump.sql;

.. hidden-code-block:: none

   #!/bin/bash
   
   # Version number of Guacamole to install
   GUACVERSION="0.9.14"
   
   # Update apt so we can search apt-cache for newest tomcat version supported
   apt-get update
   
   # Get script arguments for non-interactive mode
   while [ "$1" != "" ]; do
       case $1 in
           -m | --mysqlpwd )
               shift
               mysqlpwd="$1"
               ;;
           -g | --guacpwd )
               shift
               guacpwd="$1"
               ;;
       esac
       shift
   done
   
   # Get MySQL root password and Guacamole User password
   if [ -n "$mysqlpwd" ] && [ -n "$guacpwd" ]; then
           mysqlrootpassword=$mysqlpwd
           guacdbuserpassword=$guacpwd
   else
       echo
       while true
       do
           read -s -p "Enter a MySQL ROOT Password: " mysqlrootpassword
           echo
           read -s -p "Confirm MySQL ROOT Password: " password2
           echo
           [ "$mysqlrootpassword" = "$password2" ] && break
           echo "Passwords don't match. Please try again."
           echo
       done
       echo
       while true
       do
           read -s -p "Enter a Guacamole User Database Password: " guacdbuserpassword
           echo
           read -s -p "Confirm Guacamole User Database Password: " password2
           echo
           [ "$guacdbuserpassword" = "$password2" ] && break
           echo "Passwords don't match. Please try again."
           echo
       done
       echo
   fi
   
   debconf-set-selections <<< "mysql-server mysql-server/root_password password $mysqlrootpassword"
   debconf-set-selections <<< "mysql-server mysql-server/root_password_again password $mysqlrootpassword"
   
   # Ubuntu and Debian have different package names for libjpeg
   # Ubuntu and Debian versions have differnet package names for libpng-dev
   source /etc/os-release
   if [[ "${NAME}" == "Ubuntu" ]]
   then
       JPEGTURBO="libjpeg-turbo8-dev"
       if [[ "${VERSION_ID}" == "16.04" ]]
       then
           LIBPNG="libpng12-dev"
       else
           LIBPNG="libpng-dev"
       fi
   elif [[ "${NAME}" == *"Debian"* ]]
   then
       JPEGTURBO="libjpeg62-turbo-dev"
       if [[ "${PRETTY_NAME}" == *"stretch"* ]]
       then
           LIBPNG="libpng-dev"
       else
           LIBPNG="libpng12-dev"
       fi
   else
       echo "Unsupported Distro - Ubuntu or Debian Only"
       exit
   fi
   
   # Tomcat 8.0.x is End of Life, however Tomcat 7.x is not...
   # If Tomcat 8.5.x or newer is available install it, otherwise install Tomcat 7
   if [[ $(apt-cache show tomcat8 | egrep "Version: 8.[5-9]" | wc -l) -gt 0 ]]
   then
       TOMCAT="tomcat8"
   else
       TOMCAT="tomcat7"
   fi
   
   # Uncomment to manually force a tomcat version
   #TOMCAT=""
   
   # Install features
   apt-get -y install build-essential libcairo2-dev ${JPEGTURBO} ${LIBPNG} libossp-uuid-dev libavcodec-dev libavutil-dev \
   libswscale-dev libfreerdp-dev libpango1.0-dev libssh2-1-dev libtelnet-dev libvncserver-dev libpulse-dev libssl-dev \
   libvorbis-dev libwebp-dev mysql-server mysql-client mysql-common mysql-utilities libmysql-java ${TOMCAT} freerdp-x11 \
   ghostscript wget dpkg-dev
   
   # If apt fails to run completely the rest of this isn't going to work...
   if [ $? -ne 0 ]; then
       echo "apt-get failed to install all required dependencies"
       exit
   fi
   
   # Set SERVER to be the preferred download server from the Apache CDN
   SERVER="http://apache.org/dyn/closer.cgi?action=download&filename=guacamole/${GUACVERSION}"
   
   # Download Guacamole Server
   wget -O guacamole-server-${GUACVERSION}.tar.gz ${SERVER}/source/guacamole-server-${GUACVERSION}.tar.gz
   if [ $? -ne 0 ]; then
       echo "Failed to download guacamole-server-${GUACVERSION}.tar.gz"
       echo "${SERVER}/source/guacamole-server-${GUACVERSION}.tar.gz"
       exit
   fi
   
   # Download Guacamole Client
   wget -O guacamole-${GUACVERSION}.war ${SERVER}/binary/guacamole-${GUACVERSION}.war
   if [ $? -ne 0 ]; then
       echo "Failed to download guacamole-${GUACVERSION}.war"
       echo "${SERVER}/binary/guacamole-${GUACVERSION}.war"
       exit
   fi
   
   # Download Guacamole authentication extensions
   wget -O guacamole-auth-jdbc-${GUACVERSION}.tar.gz ${SERVER}/binary/guacamole-auth-jdbc-${GUACVERSION}.tar.gz
   if [ $? -ne 0 ]; then
       echo "Failed to download guacamole-auth-jdbc-${GUACVERSION}.tar.gz"
       echo "${SERVER}/binary/guacamole-auth-jdbc-${GUACVERSION}.tar.gz"
       exit
   fi
   
   # Extract Guacamole files
   tar -xzf guacamole-server-${GUACVERSION}.tar.gz
   tar -xzf guacamole-auth-jdbc-${GUACVERSION}.tar.gz
   
   # Make directories
   mkdir -p /etc/guacamole/lib
   mkdir -p /etc/guacamole/extensions
   
   # Install guacd
   cd guacamole-server-${GUACVERSION}
   
   # Hack for gcc7
   if [[ $(gcc --version | head -n1 | grep -oP '\)\K.*' | awk '{print $1}' | grep "^7" | wc -l) -gt 0 ]]
   then
       apt-get -y install gcc-6
       if [ $? -ne 0 ]
       then
           echo "apt-get failed to install gcc-6"
           exit
       fi
       CC="gcc-6" ./configure --with-init-dir=/etc/init.d
       CC="gcc-6" make
       CC="gcc-6" make install
   else
       ./configure --with-init-dir=/etc/init.d
       make
       make install
   fi
   
   ldconfig
   systemctl enable guacd
   cd ..
   
   # Get build-folder
   BUILD_FOLDER=$(dpkg-architecture -qDEB_BUILD_GNU_TYPE)
   
   # Move files to correct locations
   mv guacamole-${GUACVERSION}.war /etc/guacamole/guacamole.war
   ln -s /etc/guacamole/guacamole.war /var/lib/${TOMCAT}/webapps/
   ln -s /usr/local/lib/freerdp/guac*.so /usr/lib/${BUILD_FOLDER}/freerdp/
   ln -s /usr/share/java/mysql-connector-java.jar /etc/guacamole/lib/
   cp guacamole-auth-jdbc-${GUACVERSION}/mysql/guacamole-auth-jdbc-mysql-${GUACVERSION}.jar /etc/guacamole/extensions/
   
   # Configure guacamole.properties
   echo "mysql-hostname: localhost" >> /etc/guacamole/guacamole.properties
   echo "mysql-port: 3306" >> /etc/guacamole/guacamole.properties
   echo "mysql-database: guacamole_db" >> /etc/guacamole/guacamole.properties
   echo "mysql-username: guacamole_user" >> /etc/guacamole/guacamole.properties
   echo "mysql-password: $guacdbuserpassword" >> /etc/guacamole/guacamole.properties
   
   # restart tomcat
   service ${TOMCAT} restart
   
   # Create guacamole_db and grant guacamole_user permissions to it
   
   # SQL code
   SQLCODE="
   create database guacamole_db;
   create user 'guacamole_user'@'localhost' identified by \"$guacdbuserpassword\";
   GRANT SELECT,INSERT,UPDATE,DELETE ON guacamole_db.* TO 'guacamole_user'@'localhost';
   flush privileges;"
   
   # Execute SQL code
   echo $SQLCODE | mysql -u root -p$mysqlrootpassword
   
   # Add Guacamole schema to newly created database
   cat guacamole-auth-jdbc-${GUACVERSION}/mysql/schema/*.sql | mysql -u root -p$mysqlrootpassword guacamole_db
   
   # Ensure guacd is started
   service guacd start
   
   # Cleanup
   rm -rf guacamole-*
   
   echo -e "Installation Complete\nhttp://localhost:8080/guacamole/\nDefault login guacadmin:guacadmin\nBe sure to change the password."

Lab restore from backup
-----------------------

.. note:: We know that starting with V4.1.0 CSO has now an own snapshot procedure. However it is missing some functions right now so we can’t use it and remain to our own developed one. Use: ./revert.sh --snapshot

Restore Lab Procedure

#

# restore only the CSO-piece

#

.. code-block:: none

   virsh destroy installervm
   virsh destroy canvm
   virsh destroy centralk8mastervm
   virsh destroy centralinfravm
   virsh destroy centralmsvm
   virsh destroy vrr
   virsh destroy regional-sblb
   
   virsh list --all
    Id    Name                           State
   ----------------------------------------------------
    29    desktop2                       running
    30    desktop3                       running
    31    delayvm                        running
    42    natvm                          running
    43    desktop1                       running
    45    desktop4                       running
    -     canvm                          shut off
    -     centralinfravm                 shut off
    -     centralk8mastervm              shut off
    -     centralmsvm                    shut off
    -     installervm                    shut off
    -     regional-sblb                  shut off
    -     vrr                            shut off

.. code-block:: none

   date
   # rm `find /root/backup/ubuntu_vm -name "*-swap*"`
   cp -R /root/backup/ubuntu_vm/installervm /root/ubuntu_vm
   virsh start installervm
   cp -R /root/backup/ubuntu_vm/canvm /root/ubuntu_vm
   virsh start canvm
   cp -R /root/backup/ubuntu_vm/centralk8mastervm /root/ubuntu_vm
   virsh start centralk8mastervm
   cp -R /root/backup/ubuntu_vm/centralinfravm /root/ubuntu_vm
   virsh start centralinfravm
   sleep 6m
   cp -R /root/backup/ubuntu_vm/centralmsvm  /root/ubuntu_vm
   virsh start centralmsvm
   cp -R /root/backup/ubuntu_vm/regional-sblb  /root/ubuntu_vm
   virsh start regional-sblb
   cp -R /root/backup/ubuntu_vm/vrr  /root/ubuntu_vm
   virsh start vrr
   date
   # needs ~35minutes

Don’t forget to “power-off” the installervm after health-checks are all fine.

.. code-block:: none

   virsh console installervm
   cd /root/Contrail_Service_Orchestration_4.1.0/
   ./components_health.sh
   .
   .
   INFO     =============== Health Check start time: 2018-04-14 16:42:00.750145 ==============
   INFO     =============== Health Check end time: 2018-04-14 16:43:53.335888   ==============
   INFO     =============== Health Check duration: 0:01:52.585743   ==============


   # This must be EMPTY
   cat /root/Contrail_Service_Orchestration_4.1.0/logs/health_check_error.log
   
   # Here is the full log
   cat /root/Contrail_Service_Orchestration_4.1.0/logs/health_check_console.log
   =============== Health Check start time: 2018-08-24 13:43:31.117163 ==============
   
   <<<<<<<< CASSANDRA >>>>>>>>>     [2018-08-24 13:44:21.240360]
   
   192.168.10.41: Status - UP and State - NORMAL
   
   
   <<<<<<<< ELASTICSEARCH >>>>>>>>>         [2018-08-24 13:44:24.343191]
   
   Elasticsearch is running in all 1 nodes
   
   
   <<<<<<<< ETCD >>>>>>>>>  [2018-08-24 13:44:24.676135]
   
   http://192.168.10.41:2379/health
   
   Etcd is running in node 192.168.10.41 and status is HEALTHY
   
   Available healthy members are:
   
   ['192.168.10.41']
   
   Etcd cluster is Healthy
   
   
   <<<<<<<< MARIADB >>>>>>>>>       [2018-08-24 13:44:26.212032]
   
   MariaDB is running in node: 192.168.10.41 and cluster status is: DISCONNECTED
   
   
   <<<<<<<< RABBITMQ >>>>>>>>>      [2018-08-24 13:44:28.147142]
   
   The Healthy nodes are:  ['192.168.10.41']
   The following nodes are running in RabbitMQ cluster in : 192.168.10.41
   
           rabbit@centralinfravm]
   
   
   <<<<<<<< ZOOKEEPER >>>>>>>>>     [2018-08-24 13:44:32.182511]
   
   Zookeeper is running in Standalone mode and is Healthy
   
   
   <<<<<<<< REDIS >>>>>>>>>         [2018-08-24 13:44:33.166238]
   
   Redis is running in node : 192.168.10.41
   
   
   <<<<<<<< ARANGODB >>>>>>>>>      [2018-08-24 13:44:33.803595]
   
   
    ArangoDB running in the Node 192.168.10.41 has a role : SINGLE
   
    ArangoDB is running in STANDALONE mode
   
   
   <<<<<<<< SIM_CLUSTER >>>>>>>>>   [2018-08-24 13:44:35.434645]
   
   Sim_cluster (Icinga) is running in node: 192.168.10.42
   
   
   <<<<<<<< ELK_LOGSTASH >>>>>>>>>  [2018-08-24 13:44:36.021745]
   
   ELK_Logstash is running in node: 192.168.10.41
   
   
   <<<<<<<< ELK_KIBANA >>>>>>>>>    [2018-08-24 13:44:36.614729]
   
   ELK_Kibana is running in node: 192.168.10.41
   
   
   <<<<<<<< KEYSTONE >>>>>>>>>      [2018-08-24 13:44:37.228381]
   
   Keystone token generation is successful
   
   <<<<<<<< SWIFT >>>>>>>>>         [2018-08-24 13:44:38.429600]
   
   Swift is Healthy
   
   
   <<<<<<<< KUBERNETES >>>>>>>>>    [2018-08-24 13:44:41.188222]
   
   Docker is running in KUBEMASTER node:192.168.10.43
   
   Docker port 2375 is in listening state in: 192.168.10.43
   
   Flanneld is running in KUBEMASTER node:192.168.10.43
   
   Docker is running in KUBEMINION node:192.168.10.42
   
   Docker port 2375 is in listening state in: 192.168.10.42
   
   Flanneld is running in KUBEMINION node:192.168.10.42
   
   Both Docker and Flannel are Healthy
   
   All nodes are in Ready state
   
   etcd-empty-dir-cleanup-192.168.10.43    1/1     Running
   kube-addon-manager-192.168.10.43        1/1     Running
   kube-apiserver-192.168.10.43    1/1     Running
   kube-controller-manager-192.168.10.43   1/1     Running
   kube-dns-v11-npq9k      4/4     Running
   kube-proxy-192.168.10.42        1/1     Running
   kube-scheduler-192.168.10.43    1/1     Running
   Kubernetes nodes are in Ready state and Kube-System pods are running
   
   
   <<<<<<<< CONTRAIL_ANALYTICS >>>>>>>>>    [2018-08-24 13:44:45.905733]
   
   ['analytics', 'analyticsdb', 'controller', 'registry']
   Status of analytics in node : 192.168.10.48
   
   192.168.10.48 -- contrail-alarm-gen : ['active']
   192.168.10.48 -- contrail-analytics-api : ['active']
   192.168.10.48 -- contrail-analytics-nodemgr : ['active']
   192.168.10.48 -- contrail-collector : ['active']
   192.168.10.48 -- contrail-query-engine : ['active']
   192.168.10.48 -- contrail-snmp-collector : ['active']
   192.168.10.48 -- contrail-topology : ['active']
   Status of analytics in node: 192.168.10.48
   
   Status of analyticsdb in node : 192.168.10.48
   
   192.168.10.48 -- contrail-database: : ['active']
   192.168.10.48 -- contrail-database-nodemgr : ['active']
   192.168.10.48 -- kafka : ['active']
   Status of analyticsdb in node: 192.168.10.48
   
   Status of controller in node : 192.168.10.48
   
   192.168.10.48 -- contrail-control : ['active']
   192.168.10.48 -- contrail-control-nodemgr : ['active']
   192.168.10.48 -- contrail-dns : ['active']
   192.168.10.48 -- contrail-named : ['active']
   192.168.10.48 -- contrail-api:0 : ['initializing']
   The process contrail-api will be restarted
   
    The process contrail-api in controller containers has been restarted
   192.168.10.48 -- contrail-config-nodemgr : ['active']
   192.168.10.48 -- contrail-device-manager : ['active']
   192.168.10.48 -- contrail-schema : ['active']
   192.168.10.48 -- contrail-svc-monitor : ['active']
   192.168.10.48 -- contrail-database: : ['active']
   192.168.10.48 -- contrail-webui : ['active']
   192.168.10.48 -- contrail-webui-middleware : ['active']
   Status of controller in node: 192.168.10.48
   
   
   Contrail is NOT HEALTHY
   ['analytics', 'analyticsdb', 'controller', 'registry']
   Status of analytics in node : 192.168.10.48
   
   192.168.10.48 -- contrail-alarm-gen : ['active']
   192.168.10.48 -- contrail-analytics-api : ['active']
   192.168.10.48 -- contrail-analytics-nodemgr : ['active']
   192.168.10.48 -- contrail-collector : ['active']
   192.168.10.48 -- contrail-query-engine : ['active']
   192.168.10.48 -- contrail-snmp-collector : ['active']
   192.168.10.48 -- contrail-topology : ['active']
   Status of analytics in node: 192.168.10.48
   
   Status of analyticsdb in node : 192.168.10.48
   
   192.168.10.48 -- contrail-database: : ['active']
   192.168.10.48 -- contrail-database-nodemgr : ['active']
   192.168.10.48 -- kafka : ['active']
   Status of analyticsdb in node: 192.168.10.48
   
   Status of controller in node : 192.168.10.48
   
   192.168.10.48 -- contrail-control : ['active']
   192.168.10.48 -- contrail-control-nodemgr : ['active']
   192.168.10.48 -- contrail-dns : ['active']
   192.168.10.48 -- contrail-named : ['active']
   192.168.10.48 -- contrail-api:0 : ['active']
   192.168.10.48 -- contrail-config-nodemgr : ['active']
   192.168.10.48 -- contrail-device-manager : ['active']
   192.168.10.48 -- contrail-schema : ['active']
   192.168.10.48 -- contrail-svc-monitor : ['active']
   192.168.10.48 -- contrail-database: : ['active']
   192.168.10.48 -- contrail-webui : ['active']
   192.168.10.48 -- contrail-webui-middleware : ['active']
   Status of controller in node: 192.168.10.48
   
   
   Contrail is Healthy
                   *********** HEALTH CHECK COMPLETED IN CENTRAL ENVIRONMENT ***********
   
                   *********** HEALTH CHECK COMPLETED IN REGIONAL ENVIRONMENT ***********
   
   =============== Health Check end time: 2018-08-24 13:45:58.991997   ============== 
   
   exit
   # this VM is no longer needed and we reclaim its resources
   virsh shutdown installervm

The script in the installer VM doesn’t check the canvm so do that now.

.. code-block:: none

   ssh root@192.168.10.48
   
   docker ps
   
   analaytics_docker_id=`docker ps|grep analytics|head -1| awk '{ print $1 }'`
   controller_docker_id=`docker ps|grep controller|head -1| awk '{ print $1 }'`
   analayticsdb_docker_id=`docker ps|grep analyticsdb|head -1| awk '{ print $1 }'`
   
   # services have to be in active state on all containers
   docker exec $analaytics_docker_id contrail-status
   docker exec $controller_docker_id contrail-status
   docker exec $analayticsdb_docker_id contrail-status
   
   .
   == Contrail Config ==
   contrail-api:0                initializing (Generic Connection:Keystone[] connection down)   <-IGNORE THIS!!!
   contrail-config-nodemgr       active
   contrail-device-manager       active
   .

   # in case cassandra db is down
   root@canvm:~# docker exec $analayticsdb_docker_id contrail-status
   == Contrail Database ==
   contrail-database:            inactive  <- DON’T IGNORE THIS!!!

   contrail-database-nodemgr     active
   kafka                         active

   root@canvm:~# docker exec -it $analayticsdb_docker_id bash
   root@canvm(analyticsdb):/# service contrail-database restart
   Cassandra has been down for at least 777600 seconds, not starting


   service cassandra status
   service cassandra start

.. code-block:: none

   http://192.168.10.42:1936/
   http://192.168.10.47:1936/

CSO behind NAT Firewalling
--------------------------

.. warning:: IGNORE the officially documented Firewall Ruleset that you find in the README.md and Deployment Guide. There are unfortunately several mistakes in it. This is a better overview on what you have to configure instead.

|image901|

Embedded Excel-File of Firewalling rules

**DOWNLOAD**
`CSO-behind-NAT-Firewalling.xlsx <CSO-behind-NAT-Firewalling.xlsx>`__


|image902|

Locked CSO Admin account
------------------------

.. code-block:: none

   
   RAW_TOKEN=`curl -d '{"auth":{"tenantName":"admin", "passwordCredentials":{"username":"admin", "password":"5DQkO6ME2Y87"}}}' -H "Content-type: application/json" http://192.168.10.42:5000/v2.0/tokens`
   TOKEN=`echo $RAW_TOKEN | python -c "import sys; import json; tok = json.loads(sys.stdin.read()); print tok['access']['token']['id'];"`
   echo $TOKEN
   
   curl -X GET http://192.168.10.42:5000/v3/users  -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | python -m json.tool
     % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                    Dload  Upload   Total   Spent    Left  Speed
   100  1318  100  1318    0     0  31111      0 --:--:-- --:--:-- --:--:-- 31380
   {
       "links": {
           "next": null,
           "previous": null,
           "self": "http://192.168.10.42:5000/v3/users"
       },
       "users": [
           {
               "change_password": false,
               "domain_id": "default",
               "email": "juniperse@juniper.net",
               "enabled": true,
               "failed_login_attempts": 5,
               "id": "3a3f038856354dc9944a51d2513b6bf2",
               "last_login": "2018-03-23 07:47:54.336709",
               "links": {
                   "self": "http://192.168.10.42:5000/v3/users/3a3f038856354dc9944a51d2513b6bf2"
               },
               "locked": true,
               "max_failed_attempts": 0,
               "name": "cspadmin",
               "password_expires_at": null,
               "system_user": 1
           },
           {
               "domain_id": "default",
               "enabled": true,
               "id": "3a67eb6e6ebc4b9eb8c9b3760f777a36",
               "links": {
                   "self": "http://192.168.10.42:5000/v3/users/3a67eb6e6ebc4b9eb8c9b3760f777a36"
               },
               "name": "swift",
               "system_user": 1
           },
           {
               "domain_id": "default",
               "enabled": true,
               "failed_login_attempts": 0,
               "id": "63a6d23417284160b135203bee6ff4fe",
               "last_login": "2018-03-19 14:14:36.095796",
               "links": {
                   "self": "http://192.168.10.42:5000/v3/users/63a6d23417284160b135203bee6ff4fe"
               },
               "name": "admin",
               "system_user": 1
           },
           {
               "change_password": true,
               "domain_id": "default",
               "enabled": true,
               "first_name": "Joe",
               "id": "ebd3558766e6427b81660e53420aacf4",
               "last_name": "Doe",
               "links": {
                   "self": "http://192.168.10.42:5000/v3/users/ebd3558766e6427b81660e53420aacf4"
               },
               "name": "ucpetenant_admin@ucpetenant.com",
               "password_expires_at": 0
           }
       ]
   }


   curl -H 'Content-Type: application/json' -H "X-Auth-Token:$TOKEN" -X PATCH -d '{"user": {"max_failed_attempts": 0, "failed_login_attempts": 0, "locked": false, "password_expires_at": null, "change_password": false}}' http://192.168.10.42:5000/v3/users/3a3f038856354dc9944a51d2513b6bf2

“No Data Available” displayed
-----------------------------

When you see no link quality reported or no application detected follow the following Procedure to fix it.

|image903|

-  Make sure you have a license applied onto your device
-  Make sure that you have loaded as signature Database onto the device
-  Check the telemetry services on the central/regional-msvm and restart them maybe

.. code-block:: none

   ssh root@192.168.10.45/42
   
   kubectl get pods | grep -v Running
   
   cd /opt/csp/logs/telemetry
   cat agent.log | grep ERROR
   
   cd /opt/csp/logs/csp-telemetry-converter
   
   kubectl get pods | grep tele
   csp.csp-telemetry-agent-383349538-4nl0z         1/1       Running   1          1d
   csp.csp-telemetry-converter-3581191923-35l4c    1/1       Running   1          1d

   kubectl delete pods --force --grace-period=0 csp.csp-telemetry-agent-383349538-4nl0z
   kubectl delete pods --force --grace-period=0 csp.csp-telemetry-converter-3581191923-35l4c

   kubectl get pods | grep tele
   csp.csp-telemetry-agent-383349538-9s3dm         1/1       Running   0          14s
   csp.csp-telemetry-converter-3581191923-d2b8b    1/1       Running   0          9s

   exit

-  Check the telemetry services on the central-msvm and restart them maybe

.. code-block:: none

   ssh root@192.168.10.42
   
   kubectl get pods | grep -v Running
   
   cd /opt/csp/logs/telemetry-converter
   
   kubectl get pods | grep tele
   csp.csp-telemetry-converter-3229722248-rz4zh          1/1       Running   1          1d

   kubectl delete pods --force --grace-period=0 csp.csp-telemetry-converter-3229722248-rz4zh
   
   kubectl get pods | grep tele
   csp.csp-telemetry-converter-3229722248-dxvq6          1/1       Running   0          30s
   
   exit

-  Check the canvm that it is healthy as it collects all DB information

.. code-block:: none

   ssh root@192.168.10.48
   
   docker ps
   
   analaytics_docker_id=`docker ps|grep analytics|head -1| awk '{ print $1 }'`
   controller_docker_id=`docker ps|grep controller|head -1| awk '{ print $1 }'`
   analayticsdb_docker_id=`docker ps|grep analyticsdb|head -1| awk '{ print $1 }'`
   
   # services have to be in active state on all containers
   docker exec $analaytics_docker_id contrail-status
   docker exec $controller_docker_id contrail-status
   docker exec $analayticsdb_docker_id contrail-status
   
   # in case cassandra db is down
   root@canvm:~# docker exec $analayticsdb_docker_id contrail-status
   == Contrail Database ==
   contrail-database:            inactive

   contrail-database-nodemgr     active
   kafka                         active

   root@canvm:~# docker exec -it $analayticsdb_docker_id bash
   root@canvm(analyticsdb):/# service contrail-database restart
   Cassandra has been down for at least 777600 seconds, not starting

   service cassandra status
   service cassandra start

-  Check that the device can deliver syslog over the regional-sblb as haproxy to the regional-msvm

.. code-block:: none

   root@CZ1616AF0021.sdwansite1.hubspoketenant> show security flow session destination-prefix 192.168.10.47
   Session ID: 16087, Policy name: self-traffic-policy/1, Timeout: 1800, Valid
     In: 192.168.0.1/12969 --> 192.168.10.47/514;tcp, Conn Tag: 0x0, If: .local..0, Pkts: 2, Bytes: 84,
     Out: 192.168.10.47/514 --> 192.168.170.2/6183;tcp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 621, Bytes: 24844,

   Session ID: 16088, Policy name: self-traffic-policy/1, Timeout: 1800, Valid
     In: 192.168.0.1/12970 --> 192.168.10.47/3514;tcp, Conn Tag: 0x0, If: .local..0, Pkts: 2, Bytes: 84,
     Out: 192.168.10.47/3514 --> 192.168.170.2/22173;tcp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 621, Bytes: 24844,
   Total sessions: 2


   telnet 192.168.10.47 port 3514 source 192.168.0.1
   Trying 192.168.10.47...
   Connected to regional-sblb.
   Escape character is '^]'.

   ^]
   telnet> quit
   Connection closed.


   telnet 192.168.10.47 port 514 source 192.168.0.1
   Trying 192.168.10.47...
   Connected to regional-sblb.
   Escape character is '^]'.

   ^]
   telnet> quit
   Connection closed.


   ping 192.168.10.47 source 192.168.170.2
   
   clear security flow session

CSO Tuning for faster switchover times
--------------------------------------

There are some CSO environment settings that can be modified to speeding up RPM-based(Bandwidth-optimized SD-WAN mode) SD-WAN link switchover in the event of SLA violation.

PSLAM micro service settings

Set the following parameters (etcd keys) related to PSLAM on the Central Infra VM of CSO:

.. code-block:: none

   etcdctl set /pslam/sla/monitor/interval 5
   etcdctl set /pslam/sla/monitor/gap 5
   etcdctl set /pslam/sla/monitor/samples 2
   etcdctl set /pslam/sla/window 1

Restart pslam microservices (pslam, pslam-core) on the Central MS VM of CSO:

.. note:: This will affect RPM config (shown below) only for ZTPs done after above changes.

.. code-block:: none

   probe fc7ccc9d1c535b47ecd1a8b36a38e935 {
       test test-icmp-ping {
           probe-type icmp-ping;
           target address 172.16.31.53;
           probe-count 2;
           probe-interval 5;
           test-interval 5;
           routing-instance transit;
           destination-interface gr-0/0/0.4000;
       }
   }

Telemetry Agent polling frequency settings

**SRX**

The following parameter(etcd key) needs to modified on the Regional Infra VM of CSO:

.. code-block:: none

   etcdctl set /telemetry-agent/polling_frequency 10

Restart csp-telemetry-agent microservice on the Regional MS VM of CSO.

**NFX**

The following parameter needs to be changed in default.json on JDM:

.. code-block:: none

   root@jdm:~# cat /etc/telemetry_agent/default.json
   {
       "Default": {
           "check_frequency": 60,
           "deploy": "DEVICE",
           "metric_frequency": 120,
           "polling_frequency": 60,
           "sla_frequency": 10    <<<<<<<<<< changed following value from 60 to 10
       },
       "Logging": {
           "CSO-telemetry-agent_log_file": "/var/log/telemetry/agent.log",
           "log_level": "INFO"
       }
   }

README.md file from CSO-Tarball
-------------------------------

.. code-block:: none

   
   root@cso-host:~/Contrail_Service_Orchestration_4.1.0# cat README.md
   # INTRODUCTION
   
   This README gives details of fresh installation and upgrade of Cloud CPE solution.
   
   This is applicable for both MANO/CSO and NSC packages.
   
   The Cloud CPE solution consists of several infrastructure services and micro-services that are deployed in two data centers which are primarily called "central" and "regional". In a deployment environment, there should be one central and multiple regional data centers.
   
   Cloud CPE solution consists of two scenarios - Centralized (aka "vCPE") and Distributed (aka "uCPE"). The vCPE scenario uses Contrail while uCPE solution uses NFX device to create network services.
   
   #FRESH INSTALLATION:
   # Cloud CPE solution components
   
   ## Infrastructure Services
       elasticsearch, cassandra, zookeeper, mariadb, keystone, rabbitmq, elk_kibana, elk_logstash, swift, redis,
       dms, haproxy_confd, etcd, kubemaster, kubeminion, sim_cluster(icinga), sim_client, arangodb, contrail_analytics
   
   ## Microservices
       admin-portal-ui,csp-activation-service-central,csp-ams,csp-cms-central,csp-cms-central-core,csp-data-view-central,csp-design-tools,csp-dms-central,csp-dms-central-core,csp-ems-central,csp-fmpm-collector,csp-fmpm-provider,
       csp-fmpm-provider-core,csp-hybrid-access,csp-hybrid-access-core,csp-iamsvc,csp-iamsvc-noauth,csp-ims-central,csp-ims-central-core,csp-inv-central,csp-inv-central-core,csp-ipam,csp-job-service,csp-job-service-core,
       csp-policy-mgmt,csp-policy-mgmt-core,csp-pslam,csp-pslam-core,csp-routing-manager,csp-routing-manager-core,csp-schema-svc,csp-schema-service,csp-shared-object,csp-shared-object-core,csp-signature-manager,
       csp-signature-manager-core,csp-sse,csp-template-service,csp-topology-service,csp-topology-service-core,csp-tssm,csp-tssm-core,csp-vim,csp-vim-core,logspout,ne,ne-core,nsd-ui,nso,nso-core,secmgt-sm,secmgt-jingest,
       secmgt-monitoring,vnfm,vnfm-core,reporting-service
   
       cadvisor,csp-telemetry-agent,csp-activation-service,csp-cms-regional,csp-cms-regional-core,csp-config-service,csp-device-connectivity,csp-dms-regional,csp-dms-regional-core,
       csp-ems-regional,csp-fmpm-collector,csp-iamsvc-regional,csp-iamsvc-regional-core,csp-ims-regional,csp-ims-regional-core,csp-inv-regional,csp-inv-regional-core,csp-job-service,
       csp-job-service-core,csp-vim,csp-vim-core,logspout,telemetry-converter,csp-schema-svc
   
   **Note**
   
   1. Generally vCPE uses contrail keystone and uCPE/SDWAN uses standalone keystone. But there are some special cases where vCPE can use only standalone keystone and not a contrail keystone
   2. vCPE can use contrail node as contrail analytics node, uCPE/SDWAN requires a seperate contrail analytics installation
   3. Space Node is required to be deployed only for vCPE
   
   # Ubuntu VMs
   
   To have a common OS platform for CSO/NSC solution is recommendation to use Ubuntu cloud Image. The Steps are given in the provision vm section.
   
   
   # Downloading CSO/NSC from CSO Downloader for UI
   
   1. Refer CSO Install/Upgrade guide from juniper site.
       https://www.juniper.net/support/downloads/?p=cso#docs
   
   
   # Downloading CSO/NSC from CSO Downloader for CLI
   
   1. CSO Downloader for CLI based, Please use following URL to download latest version of downloader for your testing.
   
       Url: https://www.juniper.net/support/downloads/?p=cso
   
       CSO Downloader for Windows       : cso_downloader-4.1.0.exe
       CSO Downloader for MacOS         : cso_downloader-4.1.0.dmg
       CSO Downloader for Linux Desktop : cso_downloader-4.1.0.deb
   
   2. Install the downloaded downloader on your mac/windows/linux desktops, Users login with their juniper credentials.
   
   3. CLI based deployment - Fresh
                   - select your hypervisor KVM/ESXI
                   - select installation New
                   - select software (Contrail Service Orchestrator / CSO Network Service controller)
                   - select install later option will download two files CSO/NSC and Hypervisor bundle which contains preinstalled OSS, VRR, and ubuntu cloud image.
                   - once the images are downloaded then copy those to your hosts or installer vm then extract cso/nsc tarball after that copy ESXi-4.1.0.tar.gz or KVM-4.1.0.tar.gz into <tar>/artifacts/ location and then continue with asusual deployment.
                   - In case if your bandwidth is slow and taking more time to download then use below urls to download the directly in the hosts or installer vm
                     Url: https://www.juniper.net/support/downloads/?p=cso
                          Contrail_Service_Orchestration_4.1.0.tar.gz (or) CSO_Network_Service_Controller_4.1.0.tar.gz
                          KVM-4.1.0.tar.gz (or) ESXi-4.1.0.tar.gz
   
   5. CLI based deployment - Upgrade
                   - select your hypervisor KVM/ESXI
                   - select installation Upgrade
                   - select software (Contrail Service Orchestrator / CSO Network Service controller)
                   - select upgrade now option will download a files CSO/NSC into installer vm.
                   - once the images are downloaded then copy those to installer vm to continue with asusual upgrade.
                   - In case if your bandwidth is slow and taking more time to download then use below urls to download the directly in the hosts or installer vm
                     Url: https://www.juniper.net/support/downloads/?p=cso
                          Contrail_Service_Orchestration_4.1.0.tar.gz (or) CSO_Network_Service_Controller_4.1.0.tar.gz
   
   #Large Deployment
   
       * 7 Physical servers, 37 Virtual Machines including Space, Virtual Route Reflector are required for deploying all the services in central and regional regions
       * 41 IPs including 1 VIP for space web GUI and 3 VIP for HAPROXY (Central, Regional and Regional Southbound) are required for this installation.
   
   | S.No   | Components                       | Nodes                     | CPU(Cores)/Memory(GB)   | HDD(GB)
   | ------ |:--------------------------------:|:-------------------------:|:-----------------------:|:------:|
   | 1      | Installer VM                     | csp-installer-vm          | 8/32G                   | 400
   | 2      | Central Infrastructure services  | csp-central-infravm1      | 12/48G                  | 500
   | 3      | Central Infrastructure services  | csp-central-infravm2      | 12/48G                  | 500
   | 4      | Central Infrastructure services  | csp-central-infravm3      | 12/48G                  | 500
   | 5      | Central LB VM                    | csp-central-lbvm1         | 2/6G                    | 100
   | 6      | Central LB VM                    | csp-central-lbvm2         | 2/6G                    | 100
   | 7      | Central LB VM                    | csp-central-lbvm3         | 2/4G                    | 100
   | 8      | Central Microservices            | csp-central-msvm1         | 10/38G                  | 250
   | 9      | Central Microservices            | csp-central-msvm2         | 10/38G                  | 250
   | 10     | Central Microservices            | csp-central-msvm3         | 10/38G                  | 250
   | 11     | Regional Infrastructure services | csp-regional-infravm1     | 12/48G                  | 500
   | 12     | Regional Infrastructure services | csp-regional-infravm2     | 12/48G                  | 500
   | 13     | Regional Infrastructure services | csp-regional-infravm3     | 12/48G                  | 500
   | 14     | Regional Microservices           | csp-regional-msvm1        | 10/38G                  | 250
   | 15     | Regional Microservices           | csp-regional-msvm2        | 10/38G                  | 250
   | 16     | Regional Microservices           | csp-regional-msvm3        | 10/38G                  | 250
   | 17     | Regional LB VM                   | csp-regional-lbvm1        | 2/6G                    | 100
   | 18     | Regional LB VM                   | csp-regional-lbvm2        | 2/6G                    | 100
   | 19     | Regional LB VM                   | csp-regional-lbvm3        | 2/6G                    | 100
   | 20     | Space VM                         | csp-space-vm              | 4/32G (Optional)        |
   | 21     | Central ELK VM                   | csp-central-elkvm1        | 4/16G                   | 400
   | 22     | Central ELK VM                   | csp-central-elkvm2        | 4/16G                   | 400
   | 23     | Central ELK VM                   | csp-central-elkvm3        | 4/16G                   | 400
   | 24     | Regional ELK VM                  | csp-regional-elkvm1       | 4/16G                   | 400
   | 25     | Regional ELK VM                  | csp-regional-elkvm2       | 4/16G                   | 400
   | 26     | Regional ELK VM                  | csp-regional-elkvm3       | 4/16G                   | 400
   | 27     | Regional SBLB VM                 | csp-regional-sblb1        | 2/8G                    | 100
   | 28     | Regional SBLB VM                 | csp-regional-sblb2        | 2/8G                    | 100
   | 29     | Virtual Route Reflector VM       | csp-vrr-vm1               | 4/16G                   |
   | 30     | Virtual Route Reflector VM       | csp-vrr-vm2               | 4/16G                   |
   | 31     | Virtual Route Reflector VM       | csp-vrr-vm3               | 4/16G                   |
   | 32     | Virtual Route Reflector VM       | csp-vrr-vm4               | 4/16G                   |
   | 33     | Virtual Route Reflector VM       | csp-vrr-vm5               | 4/16G                   |
   | 34     | Virtual Route Reflector VM       | csp-vrr-vm6               | 4/16G                   |
   | 35     | Contrail Analytics server        | csp-contrailanalytics-1   | 24/64G                  | 700
   | 36     | Contrail Analytics server        | csp-contrailanalytics-2   | 24/64G                  | 700
   | 37     | Contrail Analytics server        | csp-contrailanalytics-3   | 24/64G                  | 700
   
   
   # Medium Deployment
       * 3 Physical servers, 22 Virtual Machines including Space, Virtual Route Reflector are required for deploying all the services in central and regional regions
       * 26 IPs including 1 VIP for space web GUI and 3 VIP for HAPROXY (Central, Regional and Regional Southbound) are required for this installation.
   
   | S.No   | Components                       | Nodes                     | CPU(Cores)/Memory(GB)   | HDD(GB)
   | ------ |:--------------------------------:|:-------------------------:|:-----------------------:|:-------:|
   | 1      | Installer VM                     | csp-installer-vm          | 4/32G                   | 400
   | 2      | Central Infrastructure services  | csp-central-infravm1      | 12/48G                  | 500
   | 3      | Central Infrastructure services  | csp-central-infravm2      | 12/48G                  | 500
   | 4      | Central Infrastructure services  | csp-central-infravm3      | 12/48G                  | 500
   | 5      | Central LB VM                    | csp-central-lbvm1         | 2/6G                    | 100
   | 6      | Central LB VM                    | csp-central-lbvm2         | 2/6G                    | 100
   | 7      | Central LB VM                    | csp-central-lbvm3         | 2/4G                    | 100
   | 8      | Central Microservices            | csp-central-msvm1         | 10/38G                  | 250
   | 9      | Central Microservices            | csp-central-msvm2         | 10/38G                  | 250
   | 10     | Central Microservices            | csp-central-msvm3         | 10/38G                  | 250
   | 11     | Space VM                         | csp-space-vm              | 4/32G (Optional)        |
   | 12     | Central ELK VM                   | csp-central-elkvm1        | 4/8G                    | 250
   | 13     | Central ELK VM                   | csp-central-elkvm2        | 4/8G                    | 250
   | 14     | Central ELK VM                   | csp-central-elkvm3        | 4/8G                    | 250
   | 15     | Regional SBLB VM                 | csp-regional-sblb1        | 2/4G                    | 100
   | 16     | Regional SBLB VM                 | csp-regional-sblb2        | 2/4G                    | 100
   | 17     | Virtual Route Reflector VM       | csp-vrr-vm1               | 4/16G                   |
   | 18     | Virtual Route Reflector VM       | csp-vrr-vm2               | 4/16G                   |
   | 19     | Contrail Analytics server        | csp-contrailanalytics-1   | 14/64G                  | 300
   | 20     | Contrail Analytics server        | csp-contrailanalytics-2   | 14/64G                  | 300
   | 21     | Contrail Analytics server        | csp-contrailanalytics-3   | 14/64G                  | 300
   
   
   #Small Deployment
       * 1 Physical servers, 8 Virtual Machines including Space, Virtual Route Reflector are required for deploying all the services in central and regional regions
       * 8 IPs are required for this installation.
   
   | S.No   | Components                       | Nodes                     | CPU(Cores)/Memory(GB)   | HDD(GB)
   | ------ |:--------------------------------:|:-------------------------:|:-----------------------:|:------:|
   | 1      | Installer VM                     | csp-installer-vm          | 4/8G                    | 550
   | 2      | Central Infrastructure services  | csp-central-infravm       | 8/48G                   | 500
   | 3      | Central Microservices            | csp-central-msvm          | 8/48G                   | 250
   | 4      | Central K8 Master                | csp-central-k8mastervm    | 2/4G                    | 100
   | 5      | Space VM                         | csp-space-vm              | 4/16G (Optional)        |
   | 6      | Regional SBLB VM                 | csp-regional-sblb         | 2/4G                    | 50
   | 7      | Virtual Route Reflector VM       | csp-vrr-vm                | 4/8G                    |
   | 8      | Contrail Analytics server        | csp-contrailanalytics-1   | 16/48G                  | 300
   
   
   # OS and Data partitions
   
       * Starting from 4.0.1, the feature of separate OS and Data partitions for CSO deployments is introduced.
   
       * Refer provision vm example configurations for disk sizes.
   
       * KVM OS and Data Partitions are automated whereas for ESXI, create a separate partition based on below specifications
   
       * Swap Partition is same as RAM size
   
   --------
   
   # ASSUMPTIONS/PREREQUISITIES
   
       * Network machines (routers) are already configured with required configurations.
   
       * All target machines are in same subnet.
   
       * All physical servers where kvm VMs are provisioned should have ubuntu 14.04.5 LTS
   
       * All VMs (if created NOT using provision_vm.sh)  where csp components are deployed should have Ubuntu 14.04.5 LTS OS
   
       * Refer deployment guide for VM Specifications and provision the VM with the recommended configuration only.
   
       * Make sure the DNS server configuration on the nodes are accurate.
   
       * The installer tool is run from the same subnet as the target machines.
   
       * All the machines are reachable between each other
   
       * Pre-installed contrail cloud is required and Keystone Admin Token is required for vCPE deployment
   
       * All the operations/installations are to be run as "root" user.
   
       * All machines should have FQDN set correctly(hostname -f)
   
   # DEPLOYMENT STEPS
   
       * If user does not already have Space and VMs (KVM/ESXi) already provisioned, then "Provision VM" can be used to spin up Ubuntu and Space cluster on Virtual Machines. Refer to the "Provision VM" section below for more details.
   
       * At high level, deployment has following steps -
           - CLEANUP EXISITING DEPLOYMENT (Based on the need)
           - PROVISION VM
           - SETUP ASSIST (Run from the csp-installer-vm)
           - DEPLOYMENT OF INFRASTRUCUTRE SERVICES
           - DEPLOYMENT OF MICRO SERVICES
           - POST DEPLOYMENT STEPS
              * For vCPE create cspadmin user
           - LOAD DATA (Load initial/default data into the services)
   
   ## CLEANUP EXISITING DEPLOYMENT
   
   In case, you already have a deployment and want to deploy afresh do the following. This only applies if you want to completely reset and deploy again
   (THIS DOES NOT APPLY IF YOU WANT TO UPGRADE THE EXISTING DEPLOYMENT)
   
    - Delete all old VMs on the physical server(s)
   
       * To check existing VM's,
   
   
           $ virsh list --all
   
      * To clean the VM's,
   
   
           $ virsh destroy <Name>
           $ virsh undefine <Name>
   
      * Delete Ubuntu Source & vm
   
   
           $ rm -rf /root/disks
           $ rm -rf /root/disks_can
           $ cd /root/ubuntu_vm
           $ rm -rf <vm directory>
   
      * Delete old salt keys
   
   
           $ salt-key -D
   
   ## PROVISION VM
   
   # Note: Provision VM is mandatory for all type of deployments (KVM and Esxi)
   
   # Space:
   
   1. By default Space image is not packaged along with the CSO/NSC tar.
   2. According to your use case if there is a need to have space (space-15.1R1.11.qcow2) in your CSO/NSC deployments please download space from   below link and keep in "<project_root>/artifacts" and then continue below steps.
       URL: https://webdownload.juniper.net/swdl/dl/secure/site/1/record/59889.html
   
   # Esxi:
   
   1. Have a Ubuntu VM with kernel version 4.4.0-31-generic with 8GB RAM and 2 vcpu with internet access.
   
   2. Copy the tarball to this VM and untar it.
   
   
   3. Create provision_vm.conf file based on the deployment type:
   
   
       - Large
         * copy confs/cso4.1.0/production/ha/provisionvm/provision_vm_example_ESXI.conf to
        confs/provision_vm.conf
         * provision_vm_example_ESXI.conf has the recommended configuration from the deployment guide.
   
       - Medium
         * copy confs/cso4.1.0/production/ha/provisionvm/provision_vm_collocated_example_ESXI.conf to
        confs/provision_vm.conf
         * provision_vm_example_ESXI.conf has the recommended configuration from the deployment guide.
   
       - Small
         * copy confs/cso4.1.0/production/nonha/provisionvm/provision_vm_collocated_example_ESXI.conf to
        confs/provision_vm.conf
         * provision_vm_example_ESXI.conf has the recommended configuration from the deployment guide.
   
   4. Open the file provision_vm.conf with a text editor.
   
   5. In the [TARGETS] section, specify the following values for the network on which CSO resides
      • installer_ip: The IP of this VM.
      • ntp_servers—Comma-separated list of fully qualified domain names (FQDN) of Network Time Protocol (NTP) servers. For networks within firewalls, specify NTP servers specific to your network.
      • Don’t edit the physical and server names
   
   6. Specify the following configuration values for each ESXi host that you specified in Step 5.
   
       • management_address—IP address of the Ethernet management (primary) interface in classless Internet domain routing (CIDR) notation  for ESXi host
       • gateway—VM Network's gateway address
       • dns_search—Domain for DNS operations
       • dns_servers—Comma-separated list of DNS name servers, including DNS servers specific to your network
       • [hostname]—Hostname of the ESXi host.
       • [username]—Username for logging in to the ESXI host. Should be root user or should have root access.
       • password—Password for logging in to the ESXi host
       • vmnetwork— Labels for each virtual network adapter which is used to identify which virtual network adapter is associated with which physical network.
   
       - The vmnetwork data for each VM is available in the Summary tab of each VM in the vSphere Client. You must not specify vmnetwork data within double quotes.
           • datastore—Datastore value to save all VMs files.
   
       - The datastore data for each VM is available in the Summary tab of each VM in the vSphere Client. You must not specify datastore data within double quotes
           • After running the provision_vm_ESXI.sh, it will bring up the CSP VMs with the configuration provided in the files.
   
   # Esxi - VRR Manual provision steps:
   1. Download VRR (.ova format) from below URL and lauch the VRR using vcenter or vsphere tool.
      URL: https://webdownload.juniper.net/swdl/dl/secure/site/1/record/72406.html
   
   2. Apply below configurations once the VRR able to do ssh access.
   
           $ configure
           $ delete groups global system services ssh root-login deny-password
           $ set system root-authentication plain-text-password
           $ set system services sshg
           $ set system services netconf ssh
           $ set routing-options rib inet.3 static route 0.0.0.0/0 discard
           $ commit
           $ exit
   
   # KVM:
   
   Note: Physical servers should have a internet access to download the libvirt packages and perform the prerequisites which are given below.
   
   - Provision VM feature is used to create Virtual machines (ubuntu14.04.5, space, contrail analytics node) in given physical server to install CSO.
      Also the physical server should run ubuntu 14.04.5 LTS
   
   - The PROVISION VM tool can be run from the physical server to create all the Virtual machines including the installer vm. Then the same tarball can be moved to the csp-installer-vm for running the installation.
   
   - A basic setup is required in physical server before launching VM's.
   
   
   - Follow below steps to complete the basic setup to create a bridge interface
   
      * apt-get update
      * ifconfig (can see the primary interface eg: "eth0")
      * apt-get install libvirt-bin
      * ifconfig (can see the virtual interface "virbr0")
   
      * Open "/etc/network/interfaces" and update the config likewise, The given config is assuming "eth0" is going to map with "virbr0".
      If you have more than one interface, create a similar configuration
      for bridging virbr0 to the desired interface. This is required for the VMs to communicate to the network.
   
           <pre>
           # This file describes the network interfaces available on your system
           # and how to activate them. For more information, see interfaces(5).
   
           # The loopback network interface
           auto lo
           iface lo inet loopback
   
           # The primary network interface
           auto eth0
           iface eth0 inet manual
             up ifconfig eth0 0.0.0.0 up
   
           auto virbr0
           iface virbr0 inet static
                   bridge_ports eth0
                   address 192.168.1.2
                   netmask 255.255.255.0
                   network 192.168.1.0
                   broadcast 192.168.1.255
                   gateway 192.168.1.1
                   dns-nameservers 192.168.10.1
                   dns-search example.net
            </pre>
   
      * Edit default.xml of virsh using below command and refer example, (From CSO 4.0.1 onwards VM network on bridge group
        is supported. Set the bridge group in the field management_interface in provision_vm.conf. Editing the default.xml is not required)
   
        - virsh net-edit default
            - Change ip address, stp='off', netmask
            - remove nat and dhcp sections
   
        Example:
   
        Before edit default.xml
        -----------------------
   
            <network>
                 <name>default</name>
                 <uuid>0f04ffd0-a27c-4120-8873-854bbfb02074</uuid>
                 <forward mode='nat'/>
                 <bridge name='virbr0' stp='on' delay='0'/>
                 <ip address='192.168.1.2' netmask='255.255.255.0'>
                   <dhcp>
                     <range start='192.168.1.1' end='192.168.1.254'/>
                   </dhcp>
                 </ip>
            </network>
   
   
        After edit default.xml
        -----------------------
   
            <network>
                 <name>default</name>
                 <uuid>0f04ffd0-a27c-4120-8873-854bbfb02074</uuid>
                 <bridge name='virbr0' stp='off' delay='0'/>
                 <ip address='192.168.1.2' netmask='255.255.255.0'>
                 </ip>
            </network>
   
   
      * Reboot physical server
   
      * After reboot we can see the "eth0" interface is mapped with "virbr0"
   
   
             # brctl show
             bridge name bridge id       STP enabled interfaces
             virbr0      8000.0cc47a010808   no      em1
                                                     vnet1
                                                     vnet2
   
   
   - Once the bridge interface is ready, now can give the details of VM and Host in the provision_vm.conf and start provisioning VM's.
   
      * Refer deployment guide and introduction section for VM Specifications and provision the VM with the recommended configuration only.
      * Enter the configuration in confs/provision_vm.conf (The config file is self explanatory, all fields are mandatory for successful VM provisioning)
   
   ### PROVISION VM CONFIGURATION
   
    - Large
      * copy confs/cso4.1.0/production/ha/provisionvm/provision_vm_example.conf to
        confs/provision_vm.conf
      * provision_vm_example.conf has the recommended configuration from the deployment guide.
   
    - Medium
      * copy confs/cso4.1.0/production/ha/provisionvm/provision_vm_collocated_example.conf to
        confs/provision_vm.conf
      * provision_vm_example.conf has the recommended configuration from the deployment guide.
   
    - Small
      * copy confs/cso4.1.0/production/nonha/provisionvm/provision_vm_collocated_example.conf to
        confs/provision_vm.conf
      * provision_vm_example.conf has the recommended configuration from the deployment guide.
   
   
   - Refer deployment guide and introduction section for VM Specifications and provision the VM with the recommended configuration only.
   - Enter the configuration in confs/provision_vm.conf (The config file is self explanatory, all fields are mandatory to successfull VM provisioning)
   
   
   - Once the Config file is ready, start VM provisioning using below command.
      * go to project_root
     <pre> ./provision_vm.sh
     </pre>
   
   - Logs for VM provisioning.
      Path : <project_root>/logs/provision_vm.log
             <project_root>/logs/provision_vm_console.log
             <project_root>/logs/provision_vm_error.log
   
   ## If CSO is deployed behind NAT, below are NAT rules to access Admin Portal UI, Kibana UI, Rabbitmq Management console etc..
      For example,
      # Central.
      * The Public IP of NAT central region is 20.13.5.180
      * Northbound Private virtual IP in case of Haproxy HA is 15.15.15.41
      * Then the following rules need to be applied on central NAT servers
   
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.180 --dport 443 -j DNAT --to-destination 15.15.15.41:443
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.180 --dport 35357 -j DNAT --to-destination 15.15.15.41:35357
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.180 --dport 5601 -j DNAT --to-destination 15.15.15.41:5601
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.180 --dport 9200 -j DNAT --to-destination 15.15.15.41:9200
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.180 --dport 1947 -j DNAT --to-destination 15.15.15.41:1947
   
      # Regional.
      * The public IP of NAT regional region is 20.13.5.182
      * Southbound load balancer - private virtual IP in case of Haproxy HA is 15.15.15.42
      * Northbound load balancer - private virtual IP in case of Haproxy HA is 15.15.15.43
      * Regional management interface is 15.15.15.2
      * Then the following rules need to be applied on regional NAT servers
   
               iptables -t nat -A POSTROUTING -o virbr0 -p tcp --dport 5601 -d 15.15.15.43 -j SNAT --to-source 15.15.15.2  # For enabling second host with SNAT
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.182 --dport 5601 -j DNAT --to-destination 15.15.15.43:5601
               iptables -t nat -A POSTROUTING -o virbr0 -p tcp --dport 7804 -d 15.15.15.43 -j SNAT --to-source 15.15.15.2
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.182 --dport 7804 -j DNAT --to-destination 15.15.15.43:7804
               iptables -t nat -A POSTROUTING -o virbr0 -p tcp --dport 3514 -d 15.15.15.42 -j SNAT --to-source 15.15.15.2
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.182 --dport 3514 -j DNAT --to-destination 15.15.15.42:3514
               iptables -t nat -A POSTROUTING -o virbr0 -p tcp --dport 514 -d 15.15.15.42 -j SNAT --to-source 15.15.15.2
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.182 --dport 514 -j DNAT --to-destination 15.15.15.42:514
               iptables -t nat -A POSTROUTING -o virbr0 -p tcp --dport 443 -d 15.15.15.43 -j SNAT --to-source 15.15.15.2
               iptables -t nat -A PREROUTING -p tcp -d 20.13.5.182 --dport 443 -j DNAT --to-destination 15.15.15.43:443
               iptables -t nat -A PREROUTING -d 10.213.5.182/32 -p tcp -m tcp --dport 2216 -j DNAT --to-destination 15.15.15.42:2216
               iptables -t nat -A POSTROUTING -d 15.15.15.42/32 -o virbr0 -p tcp -m tcp --dport 2216 -j SNAT --to-source 15.15.15.2
   
   
   
   ## Copying the Installer Package to the Installer VM
   
   After you have provisioned the VMs, move the installer package from the central server to the installer VM.
   
   1. Copy the installer package file from the central CSO server to the installer VM.
   2. Log in to the installer VM as root.
   3. Expand the installer package.
   For example, if the name of the installer package is csoVersion.tar.gz:
   root@host:~/# tar –xvzf csoVersion.tar.gz
   The contents of the installer package are placed in a directory with the same name as the installer package. In this example, the name of the directory is csoVersion.
   4. If you have created an installer VM using the provisioning tool, you must copy the /csoVersion/confs/provision_vm.conf file from the Ubuntu VM to the
   /csoversion/confs/provision_vm.conf directory of the installer VM.
   5. Open the file provision_vm.conf with a text editor.
   6. For installer_ip in the [TARGETS] section, specify the IP address of the installer VM.
   7. Save the file.
   
   ## SETUP ASSIST
   
   This tool assists you in installing/updating your CSO/NSC solution.
   
   First it sets up the installer by downloading packages from the local repo (debian and pip) in installer vm.
   
   Then it starts an interactive script which asks you questions to prepare the configuration files. At the end of the script,
   it will provide the commands to be executed to complete the installation.
   This script is re-runnable. It will remember the values from your previous run. In case you need to change any configuration in your deployment you can just re-run this script.
   
   
   # On-Perm
     <pre> ./setup_assist.sh
     </pre>
   
   # AWS
     <pre> ./setup_assist_aws.sh
     </pre>
   
   ### CONFIGURATION CREATION (TOPOLOGY & ROLES CONF)
   
   1. Setup assist will populate user interactive question to feed the inputs for topolgy and will create the roles.conf w.r.t the topology
   
   2. Major Classifications of user inputs in setup assist.
   
       - Do you have an external private repository (y|n):
           * All the libraries required for the cso4.1 solution will be downloaded from private repository
           * Private repository can be created either on the installer VM or on the external server
           * Entering 'n' will create the private repository in the installer VM
   
           How to create external private repository
              * Copy cso4.1.0 tar file in a server which runs os version ubuntu 14.04.5 LTS
              * Extract the cso4.1.0 tar file (tar -xvzf Contrail_Service_Orchestration_4.1.0.tar.gz)
              * Execute the script ./create_private_repo.sh located under directory /root/Contrail_Service_Orchestration_4.1.0
              * While running setup assist in the installer VM, answer 'y' to the question "Do you have an external private repo(y|n)"
   
       - The deployment environment that you want to setup. (production):
           * Default is production.
   
       - Select the deployment type. (small/medium/large):
           * Input any required deployment type. Topology will be picked up based on this input. Default is small.
   
       - Do you need a HA deployment (y/n):
           * (y) - will pickup the topology w.r.t HA and based on above given environment
           * (n) - will pickup the topology w.r.t NONHA and based on above given environment
   
       - Installer IP Address (This machine's address)
           * Provide the Management IP address from where setup assist script executes
   
       - Timezone for the servers in topology [America/Los_Angeles]:
           * mostly keep it as default, other wise refer ubuntu timezone servers and feed the correct value
   
       - List of ntp servers (comma seperated):
           * Provide the correct ntp address (eg: ntp.ubuntu.net)
   
       - Common password for all infra components [passw0rd]:
           * provide the password which will apply for all infra components except mariadb admin and cluster password
   
       - Public DNS name that will be used to access CSO Administration Portal (example: jcs.juniper.net)[]:
           * provide the correct DNS name, if you want to access admin portal using single sign-on method, otherwise for local authentication please provide dummy hostname
   
       - Do you want to enable TLS mode of authentication between device to FMPM services?. (y/n) []:
           * (y) - this will enable tls settings in haproxy of sblb for communication between device and FMPM services
           * (n) - this will disable tls settings in haproxy of sblb for communication between device and FMPM services
   
       - The Autonomous System Number for BGP [64512]:
           * provide the Autonomous System number
   
       - Provide the regional region name(s) (For centralized deployment,if more than one region, provide comma separated list of region names) [regional]:
           * In case of large deployment, provide regional region names. This does not apply for small/medium deployments.
   
       - Do you have an external keystone (y/n):
           * (y) - Is applicable only for contrail keystone and provide the correct details of contrail keystone
           * (n) - this will install standalone keystone and provide the user specific details for keytone
   
       - Do all your VMs have same password for root [y]:
           * (y) - The password entered will be used for central, regional and contrail analytics VMs
           * (n) - Password will be prompted for all the VMs
   
       - Enter the subnet where all CSO VMs resides, give dummy value for vcpe (network cidr)):
            The LOAD DATA step sets up the static route value in topology microservice to be installed in NFX for csp-dc subnets using the MX interface ip (connected to NFX’s WAN0) as next-hop. Provide this network value here.
   
       - Is CSO behind NAT (y/n) [n]:
           * (y) - is applicable only for VMs are in private network
             - if (y)
               * The public IP of NAT region central[]:  - Provide the public ip which is used for NAT between public and private hosts or VMs
               * The public IP of NAT region regional[]: - Provide the public ip which is used for NAT between public and private hosts or VMs
             - Note: the public ip will not do any NATing, NATing should be done manually but the above IP's used for Swift internal and external data upload
   
           * (n) - by default option is (n) and most of the deployments are with public accessible vms.
   
       - Enter the primary interface for all VMs [eth0]:
           * don't edit the about default input unless there is a change in interface on your host or vms
   
       - Topology Details. Region: central/regions(regional)
           * Provide the management IP's with cidr of server/vm
           * Provide the FQDN based hostname of server/vm
           * Provide the password for root user of server/vm
   
       - Kubernetes overlay network cidr used by the microservices - (central/regions(regional))
           * By default it is 172.16.0.0/16. if this value clash with your network range then change it to a different /16 subnet
   
       - Kubernetes Services overlay network range (cidr) used by the microservices [192.168.3.0/24]:
   
       - Kubernetes Service APIServer IP which is in above cidr range [192.168.3.1]:
   
       - Kubernetes Cluster DNS IP used by skydns which should be in the Kubernetes Services overlay network range [192.168.3.1]:
   
       - Enter the tunnel interface unit range which can be used by cso [4000,6000]
           * This is the tunnel interface unit range which will be used by cso
   
       - The FQDN exposed by load balancer to access the solution (IP Address or domain, virtual IP in case of Haproxy HA) - (central/regions(regional))
           * Non HA - provide lbvm ipaddress to access solution
           * HA - Provide lb VIP to access solution
   
       - Number of replicas of each microservice:
           * Large/Medium - default is 3
           * Small - default is 1
   
   
     #### At the end, Topology, roles.conf will be generated w.r.t above given inputs. On completion setup assist will provide the list of commands to be executed to proceed with the installation.
   
   
   ## Deploy Infraservices
   
   This step deploys the Infrastructure services based on the topology.
   
   For small/medium setup,
   
       $ ./deploy_infra_services.sh
   
   For large setup,
   
       $ DEPLOYMENT_ENV=central ./deploy_infra_services.sh
       $ DEPLOYMENT_ENV=regional ./deploy_infra_services.sh
   
   # Note: central and regional infra deployment can run in parallel with atleast 10 mins of time gap between central first and then regional
   
   ## Deploy Microservices
   
   This step deploys the micro services on top of the infrastructure.
   
   # On-Premises
   
   For small/medium setup,
   
       $ ./deploy_micro_services.sh
   
   For large setup,
   
       $ DEPLOYMENT_ENV=central ./deploy_micro_services.sh
       $ DEPLOYMENT_ENV=regional ./deploy_micro_services.sh
   
   # AWS
       Enable RP Filter for Proxy Nodes
       $ ./scripts/manage_rp_filter.sh add
   
       $ DEPLOYMENT_ENV=central ./deploy_micro_services.sh
       $ DEPLOYMENT_ENV=regional ./deploy_micro_services.sh
   
   
   ### Different usages of deploy Micro services
   
       - To restart all pods (This will delete pods and recreate it)
   
   
       $ DEPLOYMENT_ENV=central ./deploy_micro_services.sh --restart_containers
       $ DEPLOYMENT_ENV=regional ./deploy_micro_services.sh --restart_containers
   
   
       - To cleanup all the databases and reset the entire the kubernetes cluster
   
   
       $ DEPLOYMENT_ENV=central ./deploy_micro_services.sh --reset_databases
       $ DEPLOYMENT_ENV=regional ./deploy_micro_services.sh --reset_databases
   
   
       - To cleanup entire the kubernetes cluster
   
       $ DEPLOYMENT_ENV=central ./deploy_micro_services.sh --reset_cluster
       $ DEPLOYMENT_ENV=regional ./deploy_micro_services.sh --reset_cluster
   
   ## LOAD DATA
   
     Before running load data make sure all microservices are up and running.
   
   # On-Premises
      <pre>
      ./load_services_data.sh
      </pre>
   
   # AWS
      <pre>
      ./load_services_data.sh
      </pre>
   
       Disable RP Filter for Proxy Nodes
       $ ./scripts/manage_rp_filter.sh remove
   
   ## POST DEPLOYMENT STEPS
   
   - For vCPE with contrail keystone use case - create cspadmin user to access Admin Portal and it is validated only for Contrail 3.0.2
   
   1. Run below commands in any of the contrail controller which is using the cso3.3 solution
   
        # source /etc/contrail/keystonerc
        If above source path is not available then use the keystonerc configured path during contrail installation.
   
        # keystone user-create --name="cspadmin" --pass="contrailadmin_password" --tenant="admin"
        # keystone tenant-create --name="default-project" --description="Default Tenant"
        # keystone user-role-add --tenant default-project --user admin --role admin
        # keystone user-role-add --tenant default-project --user cspadmin --role admin
        # keystone role-create operator
        # keystone role-create tenant-operator
   
   2. Created groups including ‘admin’, ‘_member_’, ‘operator’ if keystone does not have
      ** <ip> - central-ms-vm ip or central VIP IP incase of HA setup **
   
      curl -H "x-auth-token:<AdminToken>" -H "content-type:application/json" -d '{"group": {"name": "operator", "domain_id": "default"}}' -XPOST http://<ip>:5000/v3/groups
   
      curl -H "x-auth-token:<AdminToken>" -H "content-type:application/json" -d '{"group": {"name": "admin", "domain_id": "default"}}' -XPOST http://<ip>:5000/v3/groups
   
      curl -H "x-auth-token:<AdminToken>" -H "content-type:application/json" -d '{"group": {"name": "_member_", "domain_id": "default"}}' -XPOST http://<ip>:5000/v3/groups
   
   3. Add ‘admin’ and ‘cspadmin’ to both ‘admin’ group and ‘_member_’ group
      ** <ip> - central-ms-vm ip or central VIP IP incase of HA setup **
   
      curl -g -i -X PUT http://<ip>:5000/v3/groups/<group-id>/users/<user-id>  -H "Accept: application/json" -H "X-Auth-Token:<AdminToken>"
   
   4. Add system_user property to cspadmin, admin & neutron users
      ** <ip> - central-ms-vm ip or central VIP IP incase of HA setup **
   
      curl -X PATCH -H "X-Auth-Token:<AdminToken>" http://<ip>:35357/v3/users/<user-id> -d '{"user": {"system_user": 1 }}'
   
   Note: "contrailadmin_password" is keystone admin_password which is given in roles.conf for vCPE with contrail keystone use case
   
   ## LOAD DATA
   
     Before running load data make sure all microservices are up and running.
   
      <pre>
      ./load_services_data.sh
      </pre>
   
   # UPGRADE:
   Upgrade to CSO Release 4.1.0 from Release 4.0.2 is independent of the deployment type (HA or non-HA) and the hypervisor type(KVM or ESXi)
   
   ## Pre-requisites:
   * Installer VM should be up and running.
   * It is mandatory to have provision_vm.conf under confs/ folder of CSO4.0.2 for the upgrade script to check VM health and take VM snapshot.
   * To create the file, the user can refer example file according to the type of deployment.
       For example, if the type is large, the example file can be found at
           - confs/cso4.1.0/production/ha/provisionvm/provision_vm_example.conf
   * Need to have provisioned as many VMs as mentioned in the example provision_vm.conf file.
       For example, if CAN VM is not provisioned, upgrade will fail, because external CAN is not supported in case of upgrade.
   * For ESXI, make sure that the "vmname" field is not empty for any of the VMs in confs/provision_vm.conf file.
     Specify the name of the VM. The script will fail otherwise.
   
   #### Run ./upgrade.sh to start the upgrade process.
   
   * Check if VMs are reachable and ensure if there is enough free disk space on the host servers (>100 GB)
   * Put CSO to maintenance mode, which means there will be no incoming traffic. Accessing admin portal UI will redirect you to the maintenance page.
   * Ask user choice if a snapshot of the VMs (except installer and VRR) is to be taken. This question is skipped in case of production HA setup, if provision_vm.conf file is present.
     Otherwise, the user has to manually take VM snapshots.
   * After snapshot, the user can manually check if the snapshot is successful.
       * SSH to the host server and run below command.
         $ virsh list --all
   
         For example, if central-infra-vm is the name of the VM in the list, execute below command
         $ qemu-img snapshot -l /root/ubuntu_vm/central-infra-vm/central-infra-vm.img
   * Once the upgrade process is successful, CSO maintenance mode is disabled.
   
       Sample output for a successful upgrade:
   
   
       INFO      ===============================================
       INFO                Overall Upgrade Summary
       INFO      ===============================================
       INFO       Configuration Upgrade : success
       INFO       System Health Check : success
       INFO       CSO Health-Check Before Upgrade : success
       INFO       CSO Maintenance Mode Enabled : success
       INFO       Kernel Upgrade : success
       INFO       VM Snapshot : success
       INFO       Central Infra Upgrade : success
       INFO       Regional Infra Upgrade : success
       INFO       Microservices pre-deploy scripts execution : success
       INFO       Central Microservices Upgrade : success
       INFO       Regional Microservices upgrade : success
       INFO       Microservices post-deploy scripts execution : success
       INFO       CSO Health-Check after Upgrade : success
       INFO       Enable CSO Services : success
       INFO       Load Microservices Data : success
       INFO      ============================================
       INFO      CSO is successfully upgraded to Release Contrail_Service_Orchestration_4.1.0
       INFO      ============================================
   
   
     The status for each of the sub-process is stored in upgrade/upgrade.conf
   
   * If the upgrade process is unsuccessful, run revert.sh to go back to CSO4.0.2
   
     Note: Snapshot availability is a pre-requisite for revert.sh
   
       Sample output for a successful revert:
   
   
       INFO ===============================================
       INFO Overall Revert Summary
       INFO ===============================================
       INFO Revert VM Snapshots : success
       INFO Revert Kernel Upgrade : success
       INFO Revert Salt Master Configuration: success
       INFO Post-revert processes: success
       INFO CSO Health-Check after Revert: success
       INFO Start Kubernet Pods: success
       INFO Enable CSO Services: success
       INFO ================================================
       INFO CSO successfully reverted to the previously installed version
       INFO ================================================
   
   ## Limitations:
   * There are no changes to the device image or device configurations.
   * If upgrade is successful, reverting back to the previous installed version of CSO is not supported.
   
   
   ACCESSING THE UI's:
   ===================
   
   ** Note **
   
   Desgin tools (design-tools) microservices is not applicable for NSC package
   
   - Accessing Admin-portal-ui
   
           https://central-ms-vm/admin-portal-ui/index.html
   
           central VIP IP incase of HA setup.
   
           https://central-vip-ip/admin-portal-ui/index.html
   
           Creds: use keystone credentials used in roles.conf. After first login you have to change the password.
   
   - Accessing NSD-UI
   
           https://central-ms-vm:83/nsd-ui/index.html
   
           Creds: use the password that was changed in the previous step.
   
   
   - Accessing SIM
   
           http://central-ms-vm:1947/icingaweb2
   
           Default Creds: icinga/ <common infra password given during setup assit>
   
   - Accessing KIBANA (No Credentials are required to access the UI)
   
           http://central-infra-vm:5601
   
           http://regional-infra-vm:5601
   
           Please click on the CREATE tab under 'settings' on      kibana UI in order to create the 'csplogs*' index.
   
   - Infra and Microserices - Haproxy status page
   
           http://central-haproxyip:1936
   
           http://regional-haproxyip:1936
   
       haproxyip - for HA use VIP and for non ha use direct microservices vm ip.
   
   Import the Visualizations to Kibana:
   ************************************
   
   - Go to Kibana UI --> Settings --> Indices
   
           Please click on the green colored "CREATE" button under 'settings' on kibana UI in order to create the 'csplogs*' index.
   
   
   - cd <package_name>/deploy_manager/export.json
   
      copy export.json to your desktop from where file can be imported to the kibana UI.( Note: Please make sure not to change the format of the json file).
   
   - Now on Kibana UI : Go to Settings --> Objects
      Click 'Import'
      Navigate to choose the 'export.json' file from the location where we just copied the file to.
   
   - Refresh Kibana UI, go to dashboards to view the visualizations.
   
      Once NS-instantitaion is made, logs will pop up in the kibana dashboard.
   
   # Components health check:
   
   * To check health of infrastructure components
   
   
       $ ./components_health.sh
   
   * To check health of central infrastructure components
   
   
       $ ./components_health.sh central
   
   * To check health of regional infrastructure components
   
   
       $ ./components_health.sh regional
   
   * This health check is called internally after deploy infra services
   
   ## VM Snapshot Utility:
   
   - On the installer VM, navigate to Contrail_Service_Orchestration_4.1.0, run ./snapshot.sh
   
   
   - This script needs confs/provision_vm.conf file to be present.
     For KVM VMs, it is required that VMs are shutdown before taking snapshot of the VM. So, the user has to be warned that the VMs will go down and come up when the script is run.
     For ESXi, there is no shutting down of VMs.
   
   - Before running snapshot, make sure that the "vmname" field is not empty for any of the VMs in confs/provision_vm.conf file. Specify the name of the VM. The script will fail otherwise.
   
   - The utility will not take snapshot of the installer VM and the VRR VMs.
   
   - The user will be able to check the snapshot names of the VMs inside snapshots/ folder that will get created inside CSO folder.
   
   
   ## VM Revert Utility:
   
   - On the installer VM, navigate to Contrail_Service_Orchestration_4.1.0, run ./revert.sh --snapshot
   
   - Sample run:
   
   
       $ ./revert.sh --snapshot
       Going to revert all VMs to a previously taken snapshot. This utility will display a list of snapshots taken, from which you can choose. Would you like to continue? (y/n) []: y
   
       List of snapshots present in the system:
   
       1 : snapshot_2019-02-07_22:42:38
       2 : snapshot_2019-02-05_20:52:36
   
       Choose a snapshot to revert to: < >
   
   - Logging for the same can be found inside snapshots/ folder under the snapshot selected.
   
   
   ## Backup and Restore
   
   - Full backup of all platform, op-co, tenant, and customer data can be run manually or periodically and that data can be restored from the backups
   when and if the need arises.
   
   - Backups are stored in the /backups/ directory on the installer-vm. The storage for this location can be local to the installer-vm or it can be located on a Storage Area Network (SAN). This location is not
   configurable.
   
   - Options available for the cso_backupnrestore command are shown in the following table. Only one of the arguments can be used with any one of the options.
   
   | Option | Purpose                                                            | Arguments
   | ------ |:------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------:|
   | -b     | Specify Operation (REQUIRED)                                       | backup, restore, healthcheck, reindex, backupdetails, listbackups, schedulebackup
   | -s     | Specify the name of the backup or restore                          | backup name
   | -m     | Put CSO in maintenance mode prior to backup [Default Yes]          | Yes or No
   | -c     | Specify which database to backup or restore [Default '*'](OPTIONAL)| For backup: only ‘*’ is allowed. For restore: Comma separated list with any or all of: cassandra, elasticsearch, zookeeper, mariadb, arrangodb, etcd
   | -d     | AWS RDS-DBID (Only for AWS)                                        | rds-dbid
   
   
   ### Recovery:
   
   The recovery utility will recover following infra components in HA environment in case of cluster issues.
   
   Run below command that will prompt the options to select the components,
   
       $ ./recovery.sh
   
       Following components can be recovered
   
       1: mariadb
       2: redis
       3: saltstack
       4: rabbitmq
   
       Specify one of the component to recover (In Number) :
   
   
   ### Enabling Prometheus and cadvisior for On-Premises
   
   By default prometheus and cadvisior is disabled in the CSO setup. To enable it run the below command from the installer VM
   
   
   <region> - denotes central and regional regions ( incase of multi region regional can be multiple and apply the command for each region)
   
   $ kubectl --kubeconfig=/etc/kube/<region>/kubeconfig apply -f cadvisor.yaml
   
   $ kubectl --kubeconfig=/etc/kube/<region>/kubeconfig apply -f prometheus.yaml
   
   FAQ:
   ----
   
   ### Upgrade:
   
   * If your upgrade is stuck with the message ‘Going to sync salt’ for a long time,
       * Open another instance of Installer VM.
       * Execute _salt ‘*’ test.ping_.
       * If you get the message, ‘Salt request timed out. The master is not responding. If this error persists after verifying the master is up,worker_threads may need to be increased’,
       execute, _service salt-master restart_.
       * Execute _salt ‘*’ test.ping_ again. It should return True for all the VMs.  
   
   * If you get the error message ‘Could not free cache on host server <servername>’,
       * SSH to the host server.
       * Execute _free && sync && echo 3 > /proc/sys/vm/drop_caches && free_
   
   * If CSO health check reports, ‘One or more kube-system pods are not running’
       * SSH to the Micro service VM.
       * Execute _kubectl get pods –namespace=kube-system_
       * If kube-proxy is not in “Running” state, execute, _Kubectl apply –f /etc/kubernetes/manifests/kube-proxy.yaml_
   
   * If CSO health check reports, ‘One or more nodes down’ for Kubernetes,
       * SSH to the Micro service VM
       * Execute _kubectl get nodes_
       * Check the node’s IP that is in “NotReady” state.
       * SSH to the corresponding VM
       * Execute _service kubelet restart_.
       * Execute _kubectl get nodes_ again and verify if all the nodes are in “Ready” state.
   
   * If upgrade fails during snapshot and the Overall Upgrade Summary looks like below: 
   
           Configuration Upgrade: success
           System Health Check: success
           CSO Health-Check before Upgrade: success
           CSO Maintenance Mode Enabled: success
           VM Snapshot: failure
   
       * If upgrade fails during snapshot with the following error: ‘Could not shut down the following VMs [< >, < >…]’,
           * SSH to host server
           * Execute _virsh shutdown \<vm name>_ for each of the VMs in the above list.
           * If it is successful, you can continue upgrade by rerunning the script.
           * If it fails, snapshot can’t be taken.
       * If upgrade fails during snapshot with the following error: ‘Could not take a snapshot of the following VMs [< >,  < >..]’, then snapshot can’t be taken.
   
       * In both the failure cases, 
           * SSH to the host server. 
           * Execute virsh list –all 
           * You will see the list of VMs that are shut off
           * Execute _virsh start <vm name>_.
           * Maintain an order when starting VMs manually this way – ['infra', 'lbvm', 'sblb', 'contrail', 'k8', 'msvm']
           * On the installer VM, execute, _cat upgrade/upgrade.conf | grep clear_cache_pods_
           * If you get _clear_cache_pods: success_, execute, _./python.sh vm_snapshot/scale_pods.py revert_
           * SSH to central infra VM.
           * In case of HA, log in to any of the central infra VMs.
           * Execute, _etcdctl set /lb/maintenance false_
   

QFX5100-1 config
----------------

.. note:: This includes sdwan-basic but not vCPE or uCPE configurations!!

.. hidden-code-block:: none

   
   set version 17.2R1.13
   set groups sdwan-basic interfaces xe-0/0/22 unit 0 family inet address 192.168.130.1/24
   set groups sdwan-basic interfaces xe-0/0/32 unit 0 family inet address 192.168.170.1/24
   set groups sdwan-basic interfaces irb unit 131 family inet address 192.168.131.1/24
   set groups sdwan-basic interfaces irb unit 134 family inet address 192.168.134.1/24
   set groups sdwan-basic interfaces irb unit 132 family inet address 192.168.132.1/24
   set groups sdwan-basic interfaces irb unit 135 family inet address 192.168.135.1/24
   set groups sdwan-basic interfaces irb unit 70 family inet address 192.168.70.254/24
   set groups sdwan-basic interfaces xe-0/0/23 unit 0 family inet address 192.168.133.1/24
   set groups sdwan-basic interfaces xe-0/0/33 unit 0 family inet address 192.168.173.1/24
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 70
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 131-132
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 134-135
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1088
   set groups sdwan-basic interfaces xe-0/0/36 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-basic interfaces xe-0/0/36 unit 0 family ethernet-switching vlan members 1088
   set groups sdwan-basic interfaces xe-0/0/18 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-basic interfaces xe-0/0/18 unit 0 family ethernet-switching vlan members 1066
   set groups sdwan-basic interfaces xe-0/0/28 unit 0 family inet address 192.168.150.1/24
   set groups sdwan-basic interfaces xe-0/0/29 unit 0 family inet address 192.168.153.1/24
   set groups sdwan-basic interfaces xe-0/0/41 unit 0 family inet address 192.168.194.1/24
   set groups sdwan-basic interfaces xe-0/0/37 unit 0 family inet address 192.168.190.1/24
   set groups sdwan-basic interfaces xe-0/0/38 unit 0 family inet address 192.168.191.1/24
   set groups sdwan-basic policy-options policy-statement export-cso term cso-net from route-filter 192.168.10.0/24 exact
   set groups sdwan-basic policy-options policy-statement export-cso term cso-net then accept
   set groups sdwan-basic policy-options policy-statement directandstatic1 term a from instance internetaccess
   set groups sdwan-basic policy-options policy-statement directandstatic1 term a then accept
   set groups sdwan-basic policy-options policy-statement directandstatic1 term b then reject
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c from instance hub-wan0
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d from instance hub-wan1
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term e from instance secure-oam
   set groups sdwan-basic policy-options policy-statement directandstatic2 term e then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term f then reject
   set groups sdwan-basic routing-instances spoke-wan0 instance-type virtual-router
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/32.0
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet network 192.168.130.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range low 192.168.130.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range high 192.168.130.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes router 192.168.130.1
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet network 192.168.170.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet range spoke-wan0-srx-pool-range low 192.168.170.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet range spoke-wan0-srx-pool-range high 192.168.170.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes router 192.168.170.1
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet network 192.168.150.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet range spoke-wan0-nfx5-pool-range low 192.168.150.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet range spoke-wan0-nfx5-pool-range high 192.168.150.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx5-pool family inet dhcp-attributes router 192.168.150.1
   set groups sdwan-basic routing-instances spoke-wan0 interface xe-0/0/22.0
   set groups sdwan-basic routing-instances spoke-wan0 interface xe-0/0/32.0
   set groups sdwan-basic routing-instances spoke-wan0 interface irb.131
   set groups sdwan-basic routing-instances spoke-wan0 interface xe-0/0/28.0
   set groups sdwan-basic routing-instances spoke-wan0 routing-options static route 0.0.0.0/0 next-hop 192.168.131.254
   set groups sdwan-basic routing-instances spoke-wan1 instance-type virtual-router
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/33.0
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface xe-0/0/29.0
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet network 192.168.133.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range low 192.168.133.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range high 192.168.133.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes router 192.168.133.1
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet network 192.168.173.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet range spoke-wan1-srx-pool-range low 192.168.173.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet range spoke-wan1-srx-pool-range high 192.168.173.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes router 192.168.173.1
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet network 192.168.153.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet range spoke-wan1-nfx5-pool-range low 192.168.153.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet range spoke-wan1-nfx5-pool-range high 192.168.153.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx5-pool family inet dhcp-attributes router 192.168.153.1
   set groups sdwan-basic routing-instances spoke-wan1 interface xe-0/0/23.0
   set groups sdwan-basic routing-instances spoke-wan1 interface xe-0/0/33.0
   set groups sdwan-basic routing-instances spoke-wan1 interface irb.134
   set groups sdwan-basic routing-instances spoke-wan1 interface xe-0/0/29.0
   set groups sdwan-basic routing-instances spoke-wan1 routing-options static route 0.0.0.0/0 next-hop 192.168.134.254
   set groups sdwan-basic routing-instances hub-wan0 instance-type virtual-router
   set groups sdwan-basic routing-instances hub-wan0 interface xe-0/0/37.0
   set groups sdwan-basic routing-instances hub-wan0 interface irb.132
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.130.0/24 next-hop 192.168.132.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.170.0/24 next-hop 192.168.132.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 35.156.179.143/32 next-hop 192.168.211.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.150.0/24 next-hop 192.168.132.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options instance-import directandstatic1
   set groups sdwan-basic routing-instances hub-wan1 instance-type virtual-router
   set groups sdwan-basic routing-instances hub-wan1 interface xe-0/0/38.0
   set groups sdwan-basic routing-instances hub-wan1 interface irb.135
   set groups sdwan-basic routing-instances hub-wan1 interface xe-0/0/25.0
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.133.0/24 next-hop 192.168.135.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.173.0/24 next-hop 192.168.135.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.88.88.0/24 next-hop 192.168.191.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.191.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 18.184.47.41/32 next-hop 192.168.212.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 35.156.179.143/32 next-hop 192.168.211.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.153.0/24 next-hop 192.168.135.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options instance-import directandstatic1
   set groups sdwan-basic routing-instances internetaccess instance-type virtual-router
   set groups sdwan-basic routing-instances internetaccess interface irb.70
   set groups sdwan-basic routing-instances internetaccess routing-options static route 0.0.0.0/0 next-hop 192.168.70.1
   set groups sdwan-basic routing-instances internetaccess routing-options instance-import directandstatic2
   set groups sdwan-basic routing-instances secure-oam instance-type virtual-router
   set groups sdwan-basic routing-instances secure-oam interface xe-0/0/41.0
   set groups sdwan-basic routing-instances secure-oam routing-options static route 192.168.10.0/24 next-hop 192.168.70.1
   set groups sdwan-basic routing-instances secure-oam routing-options autonomous-system 65000
   set groups sdwan-basic routing-instances secure-oam routing-options instance-import directandstatic1
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp type external
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp export export-cso
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp peer-as 64512
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.194.254
   set groups sdwan-basic vlans vlan131 vlan-id 131
   set groups sdwan-basic vlans vlan131 l3-interface irb.131
   set groups sdwan-basic vlans vlan134 vlan-id 134
   set groups sdwan-basic vlans vlan134 l3-interface irb.134
   set groups sdwan-basic vlans vlan132 vlan-id 132
   set groups sdwan-basic vlans vlan132 l3-interface irb.132
   set groups sdwan-basic vlans vlan135 vlan-id 135
   set groups sdwan-basic vlans vlan135 l3-interface irb.135
   set groups sdwan-basic vlans desktop2 vlan-id 1088
   set groups sdwan-basic vlans desktop4 vlan-id 1066
   set groups sdwan-basic vlans natuplink vlan-id 70
   set groups sdwan-basic vlans natuplink l3-interface irb.70
   set apply-groups sdwan-basic
   set system host-name qfx5100-121
   set system arp aging-timer 5
   set system root-authentication encrypted-password "$6$nCsDlN7N$qTG9G3zHHBcF8wwIkuH3VAwbwU4oV4kdhwv7CSyenNDA/qReSfZ2kuUPGcQWmnON4mfKAwjC323c8hkKr3iWh1"
   set system name-server 192.168.10.10
   set system services ssh root-login allow
   set system services ssh client-alive-interval 120
   set system services netconf ssh
   set system syslog user * any emergency
   set system syslog file messages any notice
   set system syslog file messages authorization info
   set system syslog file interactive-commands interactive-commands any
   set system processes dhcp-service traceoptions file dhcp_logfile
   set system processes dhcp-service traceoptions file size 10m
   set system processes dhcp-service traceoptions level all
   set system processes dhcp-service traceoptions flag all
   set system ntp boot-server 192.168.10.10
   set system ntp server 192.168.10.10
   set interfaces xe-0/0/0 ether-options auto-negotiation
   set interfaces xe-0/0/0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/1 ether-options auto-negotiation
   set interfaces xe-0/0/1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/2 vlan-tagging
   set interfaces xe-0/0/2 unit 211 vlan-id 211
   set interfaces xe-0/0/2 unit 211 family inet address 192.168.211.1/24
   set interfaces xe-0/0/2 unit 212 vlan-id 212
   set interfaces xe-0/0/2 unit 212 family inet address 192.168.212.1/24
   set interfaces xe-0/0/3 ether-options auto-negotiation
   set interfaces xe-0/0/3 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/4 ether-options auto-negotiation
   set interfaces xe-0/0/4 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/5 ether-options auto-negotiation
   set interfaces xe-0/0/5 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/6 ether-options auto-negotiation
   set interfaces xe-0/0/6 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/7 ether-options auto-negotiation
   set interfaces xe-0/0/7 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/8 ether-options auto-negotiation
   set interfaces xe-0/0/8 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/9 ether-options auto-negotiation
   set interfaces xe-0/0/9 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/10 ether-options auto-negotiation
   set interfaces xe-0/0/10 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/11 description "ucpe oam and data to mx"
   set interfaces xe-0/0/11 ether-options auto-negotiation
   set interfaces xe-0/0/11 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/11 unit 0 family ethernet-switching vlan members 65-66
   set interfaces xe-0/0/11 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/12 description "ucpe internet to mx"
   set interfaces xe-0/0/12 ether-options auto-negotiation
   set interfaces xe-0/0/12 unit 0 family ethernet-switching vlan members 67
   set interfaces xe-0/0/12 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/13 description "second CSO OAM for ucpe to nfx"
   set interfaces xe-0/0/13 ether-options auto-negotiation
   set interfaces xe-0/0/13 unit 0 family ethernet-switching vlan members 64
   set interfaces xe-0/0/13 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/14 description "vcpe vnf-mgnt on mx"
   set interfaces xe-0/0/14 ether-options auto-negotiation
   set interfaces xe-0/0/14 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/15 description "vcpe client3"
   set interfaces xe-0/0/15 ether-options auto-negotiation
   set interfaces xe-0/0/15 unit 0 family ethernet-switching vlan members 1077
   set interfaces xe-0/0/15 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/16 ether-options auto-negotiation
   set interfaces xe-0/0/16 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/17 ether-options auto-negotiation
   set interfaces xe-0/0/17 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/17 unit 0 family ethernet-switching vlan members 74-76
   set interfaces xe-0/0/17 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/19 disable
   set interfaces xe-0/0/19 ether-options auto-negotiation
   set interfaces xe-0/0/19 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/20 description "ucpe oam and data from nfx"
   set interfaces xe-0/0/20 disable
   set interfaces xe-0/0/20 ether-options auto-negotiation
   set interfaces xe-0/0/20 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/20 unit 0 family ethernet-switching vlan members 65-66
   set interfaces xe-0/0/20 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/21 description "ucpe internet from nfx"
   set interfaces xe-0/0/21 disable
   set interfaces xe-0/0/21 ether-options auto-negotiation
   set interfaces xe-0/0/21 unit 0 family ethernet-switching vlan members 67
   set interfaces xe-0/0/21 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/24 disable
   set interfaces xe-0/0/26 ether-options auto-negotiation
   set interfaces xe-0/0/26 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/27 ether-options auto-negotiation
   set interfaces xe-0/0/27 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/30 ether-options auto-negotiation
   set interfaces xe-0/0/30 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/31 ether-options auto-negotiation
   set interfaces xe-0/0/31 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/34 disable
   set interfaces xe-0/0/34 ether-options auto-negotiation
   set interfaces xe-0/0/34 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/35 disable
   set interfaces xe-0/0/35 ether-options auto-negotiation
   set interfaces xe-0/0/35 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/39 disable
   set interfaces xe-0/0/39 ether-options auto-negotiation
   set interfaces xe-0/0/39 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/40 disable
   set interfaces xe-0/0/40 ether-options auto-negotiation
   set interfaces xe-0/0/40 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/42 ether-options auto-negotiation
   set interfaces xe-0/0/42 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/43 ether-options auto-negotiation
   set interfaces xe-0/0/43 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/44 ether-options auto-negotiation
   set interfaces xe-0/0/44 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/45 ether-options auto-negotiation
   set interfaces xe-0/0/45 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/46 ether-options auto-negotiation
   set interfaces xe-0/0/46 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/47 ether-options auto-negotiation
   set interfaces xe-0/0/47 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/48 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/48:0 native-vlan-id 1
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 64
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 74-76
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1077
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1099
   set interfaces xe-0/0/48:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/48:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/48:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/48:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/49 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/49:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/49:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/49:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/49:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/50 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/50:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/50:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/50:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/50:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/51 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/51:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/51:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/51:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/51:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/52 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/52:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/52:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/52:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/52:3 unit 0 family ethernet-switching storm-control default
   set interfaces et-0/0/53 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/53:0 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/53:1 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/53:2 unit 0 family ethernet-switching storm-control default
   set interfaces xe-0/0/53:3 unit 0 family ethernet-switching storm-control default
   set interfaces em1 unit 0 family inet
   set interfaces irb unit 0 family inet
   set interfaces vme unit 0 family inet address 192.168.10.20/24
   set forwarding-options storm-control-profiles default all
   set protocols lldp interface all
   set protocols lldp-med interface all
   set protocols igmp-snooping vlan default
   set protocols rstp interface all
   set vlans default vlan-id 1
   set vlans default l3-interface irb.0
   set vlans ucpe-client1 vlan-id 1099
   set vlans ucpe-data vlan-id 66
   set vlans ucpe-data-nat vlan-id 75
   set vlans ucpe-internet vlan-id 67
   set vlans ucpe-oam vlan-id 65
   set vlans ucpe-oam-cso vlan-id 64
   set vlans ucpe-oam-nat vlan-id 76
   set vlans vcpe-client3 vlan-id 1077
   set vlans vcpe-nat vlan-id 74
    

Routes on the 5 VR’s for SD-WAN and vlans

.. hidden-code-block:: none

   root@qfx5100-121> show route
   
   inet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   192.168.10.0/24    *[Direct/0] 13w2d 20:38:10
                       > via vme.0
   192.168.10.20/32   *[Local/0] 13w2d 20:38:10
                         Local via vme.0
   192.168.211.0/24   *[Direct/0] 1d 00:11:15
                       > via xe-0/0/2.211
   192.168.211.1/32   *[Local/0] 1d 00:11:15
                         Local via xe-0/0/2.211
   192.168.212.0/24   *[Direct/0] 1d 00:11:15
                       > via xe-0/0/2.212
   192.168.212.1/32   *[Local/0] 1d 00:11:15
                         Local via xe-0/0/2.212
   
   spoke-wan0.inet.0: 11 destinations, 11 routes (11 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 13w2d 20:35:41
                       > to 192.168.131.254 via irb.131
   192.168.130.0/24   *[Direct/0] 18:43:12
                       > via xe-0/0/22.0
   192.168.130.1/32   *[Local/0] 18:43:12
                         Local via xe-0/0/22.0
   192.168.131.0/24   *[Direct/0] 13w2d 20:35:41
                       > via irb.131
   192.168.131.1/32   *[Local/0] 13w2d 20:35:41
                         Local via irb.131
   192.168.150.0/24   *[Direct/0] 23:12:10
                       > via xe-0/0/28.0
   192.168.150.1/32   *[Local/0] 23:12:10
                         Local via xe-0/0/28.0
   192.168.150.104/32 *[Access-internal/12] 3w0d 16:29:05
                       > to 192.168.150.1 via xe-0/0/28.0
   192.168.150.159/32 *[Access-internal/12] 13:18:28
                       > to 192.168.150.1 via xe-0/0/28.0
   192.168.170.0/24   *[Direct/0] 23:32:59
                       > via xe-0/0/32.0
   192.168.170.1/32   *[Local/0] 23:32:59
                         Local via xe-0/0/32.0
   
   spoke-wan1.inet.0: 12 destinations, 12 routes (12 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 13w2d 20:35:41
                       > to 192.168.134.254 via irb.134
   192.168.133.0/24   *[Direct/0] 18:43:12
                       > via xe-0/0/23.0
   192.168.133.1/32   *[Local/0] 18:43:12
                         Local via xe-0/0/23.0
   192.168.133.101/32 *[Access-internal/12] 1d 00:44:14
                       > to 192.168.133.1 via xe-0/0/23.0
   192.168.134.0/24   *[Direct/0] 13w2d 20:35:41
                       > via irb.134
   192.168.134.1/32   *[Local/0] 13w2d 20:35:41
                         Local via irb.134
   192.168.153.0/24   *[Direct/0] 23:12:10
                       > via xe-0/0/29.0
   192.168.153.1/32   *[Local/0] 23:12:10
                         Local via xe-0/0/29.0
   192.168.153.115/32 *[Access-internal/12] 22:59:09
                       > to 192.168.153.1 via xe-0/0/29.0
   192.168.153.154/32 *[Access-internal/12] 13:25:05
                       > to 192.168.153.1 via xe-0/0/29.0
   192.168.173.0/24   *[Direct/0] 23:32:59
                       > via xe-0/0/33.0
   192.168.173.1/32   *[Local/0] 23:32:59
                         Local via xe-0/0/33.0
   
   hub-wan0.inet.0: 10 destinations, 10 routes (10 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 13w2d 20:35:41
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 13w2d 20:35:41
                       > via irb.70
   192.168.70.254/32  *[Local/0] 13w2d 20:35:41
                         Local via irb.70
   192.168.130.0/24   *[Static/5] 13w2d 20:35:41
                       > to 192.168.132.254 via irb.132
   192.168.132.0/24   *[Direct/0] 13w2d 20:35:41
                       > via irb.132
   192.168.132.1/32   *[Local/0] 13w2d 20:35:41
                         Local via irb.132
   192.168.150.0/24   *[Static/5] 8w0d 17:52:38
                       > to 192.168.132.254 via irb.132
   192.168.170.0/24   *[Static/5] 13w2d 20:35:41
                       > to 192.168.132.254 via irb.132
   192.168.190.0/24   *[Direct/0] 23:25:56
                       > via xe-0/0/37.0
   192.168.190.1/32   *[Local/0] 23:25:56
                         Local via xe-0/0/37.0
   
   hub-wan1.inet.0: 12 destinations, 12 routes (12 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 13w2d 20:35:41
                       > to 192.168.70.1 via irb.70
   10.66.66.0/24      *[Static/5] 23:25:56
                       > to 192.168.191.254 via xe-0/0/38.0
   10.88.88.0/24      *[Static/5] 23:25:56
                       > to 192.168.191.254 via xe-0/0/38.0
   192.168.70.0/24    *[Direct/0] 13w2d 20:35:41
                       > via irb.70
   192.168.70.254/32  *[Local/0] 13w2d 20:35:41
                         Local via irb.70
   192.168.133.0/24   *[Static/5] 13w2d 20:35:41
                       > to 192.168.135.254 via irb.135
   192.168.135.0/24   *[Direct/0] 13w2d 20:35:41
                       > via irb.135
   192.168.135.1/32   *[Local/0] 13w2d 20:35:41
                         Local via irb.135
   192.168.153.0/24   *[Static/5] 8w0d 17:52:38
                       > to 192.168.135.254 via irb.135
   192.168.173.0/24   *[Static/5] 13w2d 20:35:41
                       > to 192.168.135.254 via irb.135
   192.168.191.0/24   *[Direct/0] 23:25:56
                       > via xe-0/0/38.0
   192.168.191.1/32   *[Local/0] 23:25:56
                         Local via xe-0/0/38.0
   
   internetaccess.inet.0: 25 destinations, 25 routes (25 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 13w2d 20:35:41
                       > to 192.168.70.1 via irb.70
   10.66.66.0/24      *[Static/5] 23:25:56
                       > to 192.168.191.254 via xe-0/0/38.0
   10.88.88.0/24      *[Static/5] 23:25:56
                       > to 192.168.191.254 via xe-0/0/38.0
   192.168.10.0/24    *[Static/5] 2w6d 23:18:33
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 13w2d 20:35:41
                       > via irb.70
   192.168.70.254/32  *[Local/0] 13w2d 20:35:41
                         Local via irb.70
   192.168.130.0/24   *[Static/5] 13w2d 20:35:41
                       > to 192.168.132.254 via irb.132
   192.168.132.0/24   *[Direct/0] 13w2d 20:35:41
                       > via irb.132
   192.168.132.1/32   *[Local/0] 13w2d 20:35:41
                         Local via irb.132
   192.168.133.0/24   *[Static/5] 13w2d 20:35:41
                       > to 192.168.135.254 via irb.135
   192.168.135.0/24   *[Direct/0] 13w2d 20:35:41
                       > via irb.135
   192.168.135.1/32   *[Local/0] 13w2d 20:35:41
                         Local via irb.135
   192.168.150.0/24   *[Static/5] 8w0d 17:52:38
                       > to 192.168.132.254 via irb.132
   192.168.153.0/24   *[Static/5] 8w0d 17:52:38
                       > to 192.168.135.254 via irb.135
   192.168.170.0/24   *[Static/5] 13w2d 20:35:41
                       > to 192.168.132.254 via irb.132
   192.168.173.0/24   *[Static/5] 13w2d 20:35:41
                       > to 192.168.135.254 via irb.135
   192.168.190.0/24   *[Direct/0] 23:25:56
                       > via xe-0/0/37.0
   192.168.190.1/32   *[Local/0] 23:25:56
                         Local via xe-0/0/37.0
   192.168.191.0/24   *[Direct/0] 23:25:56
                       > via xe-0/0/38.0
   192.168.191.1/32   *[Local/0] 23:25:56
                         Local via xe-0/0/38.0
   192.168.194.0/24   *[Direct/0] 23:25:56
                       > via xe-0/0/41.0
   192.168.194.1/32   *[Local/0] 23:25:56
                         Local via xe-0/0/41.0
   192.168.210.1/32   *[BGP/170] 20:53:09, localpref 100
                         AS path: 65000 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   192.168.210.3/32   *[BGP/170] 20:09:30, localpref 100
                         AS path: 65000 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   192.168.210.4/32   *[BGP/170] 18:31:18, localpref 100
                         AS path: 65000 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   
   secure-oam.inet.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   0.0.0.0/0          *[Static/5] 2w6d 23:26:42
                       > to 192.168.70.1 via irb.70
   192.168.10.0/24    *[Static/5] 2w6d 23:26:42
                       > to 192.168.70.1 via irb.70
   192.168.70.0/24    *[Direct/0] 2w6d 23:26:42
                       > via irb.70
   192.168.70.254/32  *[Local/0] 2w6d 23:26:42
                         Local via irb.70
   192.168.194.0/24   *[Direct/0] 23:25:56
                       > via xe-0/0/41.0
   192.168.194.1/32   *[Local/0] 23:25:56
                         Local via xe-0/0/41.0
   192.168.210.1/32   *[BGP/170] 20:53:09, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   192.168.210.3/32   *[BGP/170] 20:09:30, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   192.168.210.4/32   *[BGP/170] 18:31:18, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 192.168.194.254 via xe-0/0/41.0
   
   inet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
   
   ff02::2/128        *[INET6/0] 13w2d 20:38:15
                         MultiRecv
   
   
   root@qfx5100-121> show vlans
   
   Routing instance        VLAN name             Tag          Interfaces
   default-switch          default               1
                                                              xe-0/0/0.0*
                                                              xe-0/0/1.0
                                                              xe-0/0/3.0*
                                                              xe-0/0/4.0*
                                                              xe-0/0/5.0*
                                                              xe-0/0/6.0*
                                                              xe-0/0/7.0*
                                                              xe-0/0/8.0*
                                                              xe-0/0/9.0
                                                              xe-0/0/10.0*
                                                              xe-0/0/14.0*
                                                              xe-0/0/16.0*
                                                              xe-0/0/19.0
                                                              xe-0/0/26.0*
                                                              xe-0/0/27.0*
                                                              xe-0/0/30.0*
                                                              xe-0/0/31.0*
                                                              xe-0/0/34.0
                                                              xe-0/0/35.0
                                                              xe-0/0/39.0
                                                              xe-0/0/40.0
                                                              xe-0/0/42.0
                                                              xe-0/0/43.0
                                                              xe-0/0/44.0
                                                              xe-0/0/45.0
                                                              xe-0/0/46.0
                                                              xe-0/0/47.0*
                                                              xe-0/0/48:0.0*
                                                              xe-0/0/48:1.0
                                                              xe-0/0/48:2.0
                                                              xe-0/0/48:3.0
   default-switch          desktop2              1088
                                                              xe-0/0/36.0*
                                                              xe-0/0/48:0.0*
   default-switch          desktop4              1066
                                                              xe-0/0/18.0*
                                                              xe-0/0/48:0.0*
   default-switch          natuplink             70
                                                              xe-0/0/48:0.0*
   default-switch          ucpe-client1          1099
                                                              xe-0/0/48:0.0*
   default-switch          ucpe-data             66
                                                              xe-0/0/11.0*
                                                              xe-0/0/20.0
   default-switch          ucpe-data-nat         75
                                                              xe-0/0/17.0*
                                                              xe-0/0/48:0.0*
   default-switch          ucpe-internet         67
                                                              xe-0/0/12.0*
                                                              xe-0/0/21.0
   default-switch          ucpe-oam              65
                                                              xe-0/0/11.0*
                                                              xe-0/0/20.0
   default-switch          ucpe-oam-cso          64
                                                              xe-0/0/13.0*
                                                              xe-0/0/48:0.0*
   default-switch          ucpe-oam-nat          76
                                                              xe-0/0/17.0*
                                                              xe-0/0/48:0.0*
   default-switch          vcpe-client3          1077
                                                              xe-0/0/15.0*
                                                              xe-0/0/48:0.0*
   default-switch          vcpe-nat              74
                                                              xe-0/0/17.0*
                                                              xe-0/0/48:0.0*
   default-switch          vlan131               131
                                                              xe-0/0/48:0.0*
   default-switch          vlan132               132
                                                              xe-0/0/48:0.0*
   default-switch          vlan134               134
                                                              xe-0/0/48:0.0*
   default-switch          vlan135               135
                                                              xe-0/0/48:0.0*
     

MX80 config
-----------

.. hidden-code-block:: none

   ## Last changed: 2018-03-22 08:37:25 UTC
   version 17.1R2.7;
   groups {
       vcpe {
           chassis {
               fpc 0 {
                   pic 0 {
                       tunnel-services;
                   }
               }
               fpc 1 {
                   pic 0 {
                       tunnel-services;
                   }
                   pic 1 {
                       tunnel-services;
                   }
                   pic 2 {
                       tunnel-services;
                   }
                   pic 3 {
                       tunnel-services;
                   }
               }
           }
           interfaces {
               lo0 {
                   unit 0 {
                       family inet {
                           address 169.254.169.254/32;
                       }
                   }
               }
               ge-1/0/2 {
                   description "Gateway to CSO lan (towards regionalmsvm)";
                   unit 0 {
                       family inet {
                           address 192.168.10.70/24;
                       }
                   }
               }
               ge-1/1/4 {
                   flexible-vlan-tagging;
                   unit 74 {
                       vlan-id 74;
                       family inet {
                           address 192.168.74.254/24;
                       }
                   }
               }
               ge-1/1/2 {
                   description "from desktop3 client";
                   unit 0 {
                       family inet {
                           address 10.77.77.1/24;
                       }
                   }
               }
               ge-1/1/1 {
                   description "Control+Data for Contrail Fabric Dell 610 em2";
                   unit 0 {
                       family inet {
                           address 192.168.68.1/24;
                       }
                   }
               }
           }
           routing-options {
               router-id 169.254.169.254;
               route-distinguisher-id 169.254.169.254;
               autonomous-system 64512;
               dynamic-tunnels {
                   contrail {
                       source-address 169.254.169.254;
                       gre;
                       destination-networks {
                           192.168.68.0/24;
                       }
                   }
               }
           }
           protocols {
               bgp {
                   group contrail {
                       type internal;
                       multihop;
                       local-address 169.254.169.254;
                       hold-time 90;
                       keep all;
                       family inet-vpn {
                           unicast;
                       }
                       family inet6-vpn {
                           unicast;
                       }
                       family evpn {
                           signaling;
                       }
                       family route-target;
                       neighbor 192.168.68.15 {
                           family inet-vpn {
                               unicast;
                           }
                           family inet6-vpn {
                               unicast;
                           }
                           family evpn {
                               signaling;
                           }
                           family route-target;
                           peer-as 64512;
                       }
                   }
                   group contrail_external {
                       type external;
                       multihop;
                       local-address 169.254.169.254;
                       hold-time 90;
                       keep all;
                       family inet-vpn {
                           unicast;
                       }
                       family inet6-vpn {
                           unicast;
                       }
                   }
               }
           }
           routing-instances {
               vnf-mgnt {
                   instance-type vrf;
                   interface ge-1/0/2.0;
                   route-distinguisher 169.254.169.254:10000;
                   vrf-target target:64512:10000;
                   vrf-table-label;
               }
               public-vcpe {
                   instance-type vrf;
                   interface ge-1/1/4.74;
                   route-distinguisher 169.254.169.254:10001;
                   vrf-target target:64512:10001;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 next-hop 192.168.74.1;
                       }
                   }
               }
               site-vcpe {
                   instance-type vrf;
                   interface ge-1/1/2.0;
                   route-distinguisher 10.77.77.1:10002;
                   vrf-target target:64513:10002;
                   vrf-table-label;
               }
           }
       }
       ucpe {
           system {
               services {
                   dhcp-local-server {
                       group ucpe-wan1-pool {
                           interface ge-1/1/0.0;
                       }
                   }
               }
           }
           interfaces {
               ge-1/0/1 {
                   description "Out-off-band management for ucpe";
                   unit 0 {
                       family inet {
                           address 192.168.64.1/24;
                       }
                   }
               }
               ge-1/0/0 {
                   description "WAN0 for NFX250 (MPLS)";
                   flexible-vlan-tagging;
                   unit 65 {
                       vlan-id 65;
                       family inet {
                           address 192.168.65.1/24;
                       }
                   }
                   unit 66 {
                       vlan-id 66;
                       family inet {
                           address 192.168.66.1/24;
                       }
                   }
               }
               ge-1/1/4 {
                   flexible-vlan-tagging;
                   unit 75 {
                       vlan-id 75;
                       family inet {
                           address 192.168.75.254/24;
                       }
                   }
                   unit 76 {
                       vlan-id 76;
                       family inet {
                           address 192.168.76.254/24;
                       }
                   }
               }
               ge-1/1/0 {
                   description "WAN1 for NFX250 (Internet)";
                   unit 0 {
                       family inet {
                           address 192.168.67.1/24 {
                               primary;
                           }
                           address 192.168.67.67/24;
                       }
                   }
               }
           }
           policy-options {
               policy-statement POL-DEFAULT {
                   term default {
                       from {
                           route-filter 0.0.0.0/0 exact;
                       }
                       then accept;
                   }
                   then reject;
               }
           }
           access {
               address-assignment {
                   pool ucpe-wan1-pool {
                       family inet {
                           network 192.168.67.0/24;
                           range valid {
                               low 192.168.67.5;
                               high 192.168.67.250;
                           }
                           dhcp-attributes {
                               domain-name example.net;
                               name-server {
                                   192.168.10.10;
                               }
                               router {
                                   192.168.67.1;
                               }
                           }
                       }
                   }
               }
           }
           routing-instances {
               VRFWAN {
                   instance-type vrf;
                   system {
                       services {
                           dhcp-local-server {
                               group ucpe-wan1-pool {
                                   interface ge-1/1/0.0;
                               }
                           }
                       }
                   }
                   interface ge-1/0/0.66;
                   interface ge-1/1/4.75;
                   route-distinguisher 192.168.66.1:65410;
                   vrf-target target:65410:10010;
                   vrf-table-label;
                   routing-options {
                       static {
                           route 0.0.0.0/0 next-hop 192.168.75.1;
                       }
                       router-id 192.168.66.1;
                       autonomous-system 65410;
                   }
                   protocols {
                       bgp {
                           export POL-DEFAULT;
                           group nfx-gwr-bgp-grp {
                               type external;
                               family inet {
                                   unicast;
                               }
                               peer-as 65500;
                               neighbor 192.168.66.2;
                           }
                       }
                   }
               }
               OAM-to-CSO {
                   instance-type virtual-router;
                   interface ge-1/0/0.65;
                   interface ge-1/0/1.0;
                   interface ge-1/1/4.76;
                   routing-options {
                       static {
                           route 0.0.0.0/0 next-hop 192.168.76.1;
                       }
                   }
               }
           }
       }
   }
   apply-groups [ vcpe ucpe ];
   system {
       host-name mx80-1;
       root-authentication {
           encrypted-password "$1$i5PzQD4d$ovMu2gE5A6wtN9ZCrcxoN1"; ## SECRET-DATA
       }
       name-server {
           192.168.10.10;
       }
       services {
           ssh {
               root-login allow;
           }
           telnet;
           netconf {
               ssh;
               traceoptions {
                   file netconf-ops.log size 3m files 20 world-readable;
                   flag all;
               }
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any notice;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
   }
   interfaces {
       fxp0 {
           unit 0 {
               family inet {
                   address 192.168.10.21/24;
               }
           }
       }
   }

Saved Certificates from central-msvm
------------------------------------

.. code-block:: none

   scp root@192.168.10.42:/etc/pki/tls/certs/* .

**DOWNLOAD**
`centralmsvm-certs.tgz <centralmsvm-certs.tgz>`__


|image904|

The above is an embedded object. It’s known to work for Word on Windows users that they can export this.

Recover lost passwords
----------------------

The new installer >= CSO V3.3 also installs a script to allow decryption of the passwords after the installation is done and you may have missed to store the passwords in a save place. Start the installervm and go to the CSO install directory to use the generated decryption script (that use the saved config file) like below.

.. code-block:: none

   root@installervm:~/Contrail_Service_Orchestration_4.0.2# ./python.sh deploy_manager/utils/decrypt_password.py

Traffic generator script
------------------------

This is an updated script to generate a “low-volume” traffic for the purpose of showing Application Visibility on CSO UI. It’s “engineered” for 20 apps, where the Top 10 showing on Site WAN links UI and rest is under Monitor -> Application Visibility. You can set the timer between each iteration cycle or put it in background cron job.

Top 10 Applications showing-up on Site WAN Links UI

|image905|

20 Applications:

|image906|

.. note:: The fancy characters are used for color-coding and others and are intentional.

.. code-block:: none

   vi trafficgen.sh                                                                                  

   #!/bin/bash
   # **************************************************************************** #
   # **************************** TRAFFIC GENERATOR ***************************** #
   # ******************** For SD-WAN Application Visibility ********************* #
   # **************************************************************************** #
   # Last Modified: 11.29.2018  |  Version: 0.2                                   #
   # By: Shay Dunevich                                                            #
   # ---------------------------------------------------------------------------- #
   # The following Bash Script/App generate traffic, in order to show SD-WAN      #
   # Application Visibility on CSO UI.                                            #
   # ____________________________________________________________________________ #
   # => This script simulates 20 different applications which are visible on CSO  #
   #    UI under Application Visibility monitoring.                               #
   # => This script is a collection of 20 different small-size wget downloads     #
   #    from the URLs listed below.                                               #
   # => The program iterates over these 20 downloads every 5 minutes (300 Seconds)#
   # => To change the Iteration cycle/time - the "TIMER" variable can be set to   #
   #    the desired number (in seconds).                                          #
   # ---------------------------------------------------------------------------- #
   # ~~~~~~~~~~~~ TOP 10 APPLICATIONS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
   # ---- Application Name --- Download URL ------------------------------------- #
   #     ^^^^^^^^^^^^^^^^^^   ^^^^^^^^^^^^^^                                      #
   #  >>> CNN ---------------- cnn.com ------------------------------------------ #
   #  >>> YAHOO -------------- yahoo.com ---------------------------------------- #
   #  >>> FACEBOOK-ACCESS ---- facebook.com ------------------------------------- #
   #  >>> SALESFORCE --------- salesforce.com ----------------------------------- #
   #  >>> DROPBOX ------------ dropbox.com -------------------------------------- #
   #  >>> TWITTER ------------ twitter.com -------------------------------------- #
   #  >>> AMAZON-AWS --------- aws.amazon.com ----------------------------------- #
   #  >>> SKYPE -------------- skype.com ---------------------------------------- #
   #  >>> OFFICE365-CREATE --- office365.com ------------------------------------ #
   #  >>> WEBEX -------------- webex.com ---------------------------------------- #
   # ============================================================================ #
   # ~~~~~~~~~ ADDITIONAL APPLICATIONS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
   # ---- Application Name --- Download URL ------------------------------------- #
   #     ^^^^^^^^^^^^^^^^^^   ^^^^^^^^^^^^^^                                      #
   #  --> UBUNTU ------------- ubuntu.com --------------------------------------- #
   #  --> WIKIPEDIA ---------- wikipedia.org ------------------------------------ #
   #  --> GITHUB ------------- github.com --------------------------------------- #
   #  --> LINKEDIN ----------- linkedin.com ------------------------------------- #
   #  --> WHATSAPP-TCP ------- www.cdn.whatsapp.net ----------------------------- #
   #  --> INSTAGRAM ---------- instagram.com ------------------------------------ #
   #  --> VIMEO -------------- vimeo.com ---------------------------------------- #
   #  --> ONEDRIVE ----------- onedrive.com ------------------------------------- #
   #  --> OUTLOOK ------------ outlook.com -------------------------------------- #
   #  --> GOOGLE-GEN --------- google.com --------------------------------------- #
   # ____________________________________________________________________________ #
   # ____________________________________________________________________________ #
   # ____________________________________________________________________________ #
   
   
   # ->> Main-Runner Loop Starts Here: ------------------------------
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   while true
   do
   
   
   # ->> Setting the TIMER variable to be used for iteration loop ---
   #     (variable set in Minuets) - Default time is 5 Minutes ------
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   TIMER=5
   
   
   # ->> Deleting temporary download directory and all files from ---
   #     previous iteration -----------------------------------------
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   rm -rf /root/wget-TMP-Downloads
   
   
   # ->> Creating temp directory to download all files in the next --
   #     iteration cycle
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   mkdir /root/wget-TMP-Downloads
   cd /root/wget-TMP-Downloads
   
   
   echo -e '
   \e[1;36m# **************************************************************************** #
   # **************************** \e[1;32mTRAFFIC GENERATOR \e[1;36m***************************** #
   # ******************** \e[1;32mFor SD-WAN Application Visibility \e[1;36m********************* #
   # **************************************************************************** #\e[0m
   # Last Modified: 11.28.2018  |  Version: 0.1                                   #
   # By: Shay Dunevich                                                            #
   # ---------------------------------------------------------------------------- #
   \e[1;34m# ============================================================================ #\e[0m
   # ~~~~~~~~~~~~ \e[1;32mTOP 10 APPLICATIONS \e[0m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
   # ---- Application Name --- Download URL ------------------------------------- #
   #     ^^^^^^^^^^^^^^^^^^   ^^^^^^^^^^^^^^                                      #
   #  >>> \e[1;32mCNN \e[0m---------------- cnn.com ------------------------------------------ #
   #  >>> \e[1;32mYAHOO \e[0m-------------- yahoo.com ---------------------------------------- #
   #  >>> \e[1;32mFACEBOOK-ACCESS \e[0m---- facebook.com ------------------------------------- #
   #  >>> \e[1;32mSALESFORCE \e[0m--------- salesforce.com ----------------------------------- #
   #  >>> \e[1;32mDROPBOX \e[0m------------ dropbox.com -------------------------------------- #
   #  >>> \e[1;32mTWITTER \e[0m------------ twitter.com -------------------------------------- #
   #  >>> \e[1;32mAMAZON-AWS \e[0m--------- aws.amazon.com ----------------------------------- #
   #  >>> \e[1;32mSKYPE \e[0m-------------- skype.com ---------------------------------------- #
   #  >>> \e[1;32mOFFICE365-CREATE \e[0m--- office365.com ------------------------------------ #
   #  >>> \e[1;32mWEBEX \e[0m-------------- webex.com ---------------------------------------- #
   \e[1;34m# ============================================================================ #\e[0m
   # ~~~~~~~~~ \e[1;33mADDITIONAL APPLICATIONS \e[0m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
   # ---- Application Name --- Download URL ------------------------------------- #
   #     ^^^^^^^^^^^^^^^^^^   ^^^^^^^^^^^^^^                                      #
   #  --> \e[1;33mUBUNTU \e[0m------------- ubuntu.com --------------------------------------- #
   #  --> \e[1;33mWIKIPEDIA \e[0m---------- wikipedia.org ------------------------------------ #
   #  --> \e[1;33mGITHUB \e[0m------------- github.com --------------------------------------- #
   #  --> \e[1;33mLINKEDIN \e[0m----------- linkedin.com ------------------------------------- #
   #  --> \e[1;33mWHATSAPP-TCP \e[0m------- www.cdn.whatsapp.net ----------------------------- #
   #  --> \e[1;33mINSTAGRAM \e[0m---------- instagram.com ------------------------------------ #
   #  --> \e[1;33mVIMEO \e[0m-------------- vimeo.com ---------------------------------------- #
   #  --> \e[1;33mONEDRIVE \e[0m----------- onedrive.com ------------------------------------- #
   #  --> \e[1;33mOUTLOOK \e[0m------------ outlook.com -------------------------------------- #
   #  --> \e[1;33mGOOGLE-GEN \e[0m--------- google.com --------------------------------------- #
   \e[1;34m# ____________________________________________________________________________ #
   # ____________________________________________________________________________ #\e[0m
   '
   echo ''
   echo -e '\e[1;36m>>>>>>>>>>>> \e[1;32mStarting To Download... \e[1;36m>>>>>>>>>>>>\e[0m'
   echo '-------------------------------------------------'
   echo ''
   
   # ->> Pause for 3 seconds to view Apps list above ----------------
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   sleep 3
   
   
   # ->> Download starts here using wget ----------------------------
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   
   # ****************************************
   # ********* TOP 10 APPLICATIONS **********
   # ****************************************
   
   # >>> CNN ----------------> cnn.com 
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget cnn.com
   
   # >>> YAHOO --------------> yahoo.com
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget yahoo.com
   
   # >>> FACEBOOK-ACCESS ----> facebook.com
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget facebook.com
   
   # >>> SALESFORCE ---------> salesforce.com
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget salesforce.com
   
   # >>> DROPBOX ------------> dropbox.com
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget dropbox.com
   
   # >>> TWITTER ------------> twitter.com 
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget twitter.com
   
   # >>> AMAZON-AWS ---------> aws.amazon.com
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget aws.amazon.com
   
   # >>> SKYPE --------------> skype.com
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget skype.com
   
   # >>> OFFICE365-CREATE ---> office365.com 
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget office365.com
   
   # >>> WEBEX --------------> webex.com -
   # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   wget webex.com
   
   # ****************************************
   # ****************************************
   # ****************************************
   
   
   # ****************************************
   # ********* TOP 10 APPLICATIONS **********
   # ****************************************
   
   # --> UBUNTU -------------> ubuntu.com
   # ----------------------------------------
   wget ubuntu.com
   
   # --> WIKIPEDIA ----------> wikipedia.org
   # ----------------------------------------
   wget wikipedia.org
   
   # --> GITHUB -------------> github.com
   # ----------------------------------------
   wget github.com
   
   # --> LINKEDIN -----------> linkedin.com
   # ----------------------------------------
   wget linkedin.com
   
   # --> WHATSAPP-TCP -------> www.cdn.whatsapp.net
   # ----------------------------------------------
   wget www.cdn.whatsapp.net
   
   # --> INSTAGRAM ----------> instagram.com
   # ----------------------------------------------
   wget instagram.com
   
   # --> VIMEO --------------> vimeo.com
   # ----------------------------------------------
   wget vimeo.com
   
   # --> ONEDRIVE -----------> onedrive.com
   # ----------------------------------------------
   wget onedrive.com
   
   # --> OUTLOOK ------------> outlook.com
   # ----------------------------------------------
   wget outlook.com
   
   # --> GOOGLE-GEN ---------> google.com 
   # ----------------------------------------------
   wget google.com
   
   # ****************************************
   # ****************************************
   # ****************************************
   
   
   # ->> Iteration ends here - Pause time before next cycle ---------
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   
   # ->> Clearing screen and presenting message below ---------------
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   clear
   
   echo ''
   echo ' -------------------------------------------------'
   echo -e ' \e[1;36m>>>>>>>>>>>> \e[1;33mResting for '$TIMER 'Minutes... \e[1;36m>>>>>>>>>>>>\e[0m'
   echo ' -------------------------------------------------'
   echo ''
   echo ''
   
   
   # ->> Countdown Timer (presented in Seconds)----------------------
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   secs=$(($TIMER * 60))
   while [ $secs -gt 0 ]; do
      echo -n -e "\e[1;34m>>>>>>>>>>>> \e[1;32mNext Iteration in --> \e[1;31m$secs\033[0K \e[0mSeconds...\r \e "
      sleep 1
      : $((secs--))
   done
   
   
   
   # ->> Main-Runner loop ends here! --------------------------------
   # ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   done
   

Automation of the Lab setup
---------------------------

Automation of the CSO Reference Architecture (that you see in this entire document starts with version 3.1 of the Architecture.

In the first Phase we are addressing the need to apply a templated underlay configuration each time the lab changes it’s layout and also bring all the devices into a known (pre-configured) State so that you can run the provision against CSO immediately.

We would like to hear from you what automation steps you would like having addressed in future Releases.

.. note:: Even if it’s technically possible to run the Automation in standalone mode as instances we only document then as TWO separate Docker containers that are either inside a VM on the CSO-Host (or external VM-Manager) or somewhere on your Windows/MacOS Laptop.

Building an VM for Automation on the CSO-Host
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you chose this way of working with the automation and do not have the two needed Docker containers externally (maybe on your SE-Laptop) deployed then we assume that you have minimum executed the setup instructions we gave you in the following order

-  You execute chapter 3.3.1.1 so that we have a minimum of lab Switch config so that the CSO-Host can reach the Network.
-  Then execute chapter 3.2.1 to chapter 3.2.5 to install the CSO-Host, KVM, DNS, NTP and NAT-VM so that you can start building all other services on-top.

.. code-block:: none

   cd /root
   # Download the Ubuntu cloudimage (here the vmdk-version)
   # DO NOT USE THE ORIGINAL .IMG!!!
   wget http://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.vmdk

   # convert the compressed vmdk image to an uncompressed qcow2 image
   qemu-img convert -f vmdk -O qcow2 xenial-server-cloudimg-amd64-disk1.vmdk xenial-server-cloudimg-amd64-disk1.qcow2
   
   virsh destroy automation; virsh undefine automation
   
   cp /root/xenial-server-cloudimg-amd64-disk1.qcow2 /var/lib/libvirt/images/automation.qcow2
   qemu-img resize /var/lib/libvirt/images/automation.qcow2 +20G
   chmod 666 /var/lib/libvirt/images/automation.qcow2
   
   cat <<EOF > meta-data
   hostname: automation
   local-hostname: automation
   instance-id: automation
   EOF
   
   cat <<EOF > user-data
   #cloud-config
   disable_root: false
   manage_etc_hosts: false
   chpasswd:
     list: |
       root:juniper123
       ubuntu:ubuntu
     expire: False
   ssh_pwauth: True
   final_message: "The system is finally up, after $UPTIME seconds"
   fqdn: automation.example.net
   groups:
     - cloud-users
   users:
     - default
   
   runcmd:
     - sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
     - service ssh restart
     - touch /etc/cloud/cloud-init.disabled
     - ifconfig ens3 192.168.10.5/24 up
     - route add default gw 192.168.10.1
     - echo nameserver 192.168.10.10 > /etc/resolv.conf
     - cloud-init-per instance setup_etc_host echo '127.0.1.1 automation.example.net automation' >> /etc/hosts
     - apt-get -y remove cloud-init
   EOF
   
   genisoimage -o automation.iso -V cidata -r -J meta-data user-data 
   
   virt-install -n automation -r 4096 --vcpus=2 --disk path=/var/lib/libvirt/images/automation.qcow2,format=qcow2,device=disk,bus=virtio --import --disk path=/root/automation.iso,device=cdrom,bus=virtio --os-type linux --hvm --network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole
   
   virsh console automation --force

After you have logged into the VM as root/juniper123 you execute the following

.. code-block:: none

   apt-get update
   
   apt-get upgrade -y
   
   apt-get install -y docker.io unzip mc
   
   cat <<EOF > /etc/network/interfaces
   # This file describes the network interfaces available on your system
   # and how to activate them. For more information, see interfaces(5).
   
   # The loopback network interface
   auto lo
   iface lo inet loopback
   
   auto ens3
   iface ens3 inet static
     address 192.168.10.5
     netmask 255.255.255.0
     gateway 192.168.10.1
     dns-nameservers 192.168.10.10
   EOF
   
   reboot

Changes on the NAT-VM
~~~~~~~~~~~~~~~~~~~~~

This change already part of chapter 3.2.5 above but if this is not a fresh installation you have to execute this here now.

.. code-block:: none

   ssh root@192.168.10.1
   cli
   edit
   set security nat destination pool automationvm address 192.168.10.5/32
   set security nat destination rule-set natforward rule r9 match source-address-name alladmins
   set security nat destination rule-set natforward rule r9 match destination-address 172.30.52.57/32
   set security nat destination rule-set natforward rule r9 match destination-port 9080
   set security nat destination rule-set natforward rule r9 match destination-port 8670
   set security nat destination rule-set natforward rule r9 match protocol tcp
   set security nat destination rule-set natforward rule r9 then destination-nat pool automationvm
   commit and-quit
   exit
   exit

Build Gitlab Docker Container and configure it
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   ssh root@192.168.10.5
   cd /root

   # upload the automation tar-ball to your VM and then extract it
   scp root@192.168.10.10:/root/CSO_RefLab_automation_v*.tar.gz .
   
   tar xvfz CSO_RefLab_automation_v*.tar.gz
   
   cd cso-ui-git-master
   
   cat README.md
   
   mkdir -p /srv/gitlab/logs
   mkdir -p /srv/gitlab/data
   
   docker run --detach --hostname "192.168.10.5" --name gitlab --restart "always" \
    --volume /srv/gitlab/config:/etc/gitlab --volume /srv/gitlab/logs:/tmp/gitlab/logs --volume /srv/gitlab/data:/tmp/gitlab/data \
    --publish 9080:9080 --publish 3022:22 --publish 9443:9443 \
    --env GITLAB_OMNIBUS_CONFIG="external_url 'http://192.168.10.5:9080'; gitlab_rails['gitlab_shell_ssh_port']=3022;" gitlab/gitlab-ce:latest
   .
   .
   Unable to find image 'gitlab/gitlab-ce:latest' locally
   latest: Pulling from gitlab/gitlab-ce
   7b722c1070cd: Pull complete
   5fbf74db61f1: Pull complete
   ed41cb72e5c9: Pull complete
   7ea47a67709e: Pull complete
   96622dd15060: Pull complete
   dc057a248391: Pull complete
   5beac299b087: Pull complete
   194f6667411b: Pull complete
   38f12a9d769b: Pull complete
   5cbba2366a4f: Pull complete
   Digest: sha256:a4d06405afb69e6eed6f0a8d73a52a346ab2d77657967480e73f4e9a9015597e
   Status: Downloaded newer image for gitlab/gitlab-ce:latest
   243bd7914164f096b9ef129e2b73d21c585d93257ad6b225a2e89c6d063a2759

   sleep 3m
   
   docker ps
   CONTAINER ID        IMAGE                     COMMAND             CREATED             STATUS                   PORTS                                                                                   NAMES
   243bd7914164        gitlab/gitlab-ce:latest   "/assets/wrapper"   2 minutes ago       Up 2 minutes (healthy)   80/tcp, 0.0.0.0:9080->9080/tcp, 443/tcp, 0.0.0.0:9443->9443/tcp, 0.0.0.0:3022->22/tcp   gitlab

Use a Brower towards your lab http://<your-lab-ip>:9080

-  set the new password to "juniper123"
-  press "change password"

-  sign in as "root" with the password from above

-  click "Create a group"
-  Group name = cso-ops
-  Visibility level = public
-  click "Create group"

-  in the new group cso-ops
-  click "New project"
-  click "Blank project"

-  Project name = useCases
-  rest is automatic
-  Visibility level = public
-  click "Browse”. Leave the defaults as they are. Do NOT click on "Init with README"
-  click "Create project"

.. code-block:: none

   # copy the key from below file
   cat /root/cso-ui-git-master/ssh/cso-ui.pub
   ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDPTNq2MIayNSXRLHaRIiL3wOaJ+rEmB4ZKpO3bQiAxr email@example.com

-  Browse to http://<your-lab-ip>:9080/profile/keys
-  paste the key into the window and press "Add Key"

Apply changes of your local Lab to the configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning:: Having the right local certificate file from the CSO is KEY for any ZTP in the lab so be sure to follow the below instructions!

If you intent to use or already using the stored certificates from chapter 8.12 above you do NOT need to load the certificates from the centralmsvm and can continue with the next step. In this Step we assume your CSO-Instance is already up and running and you have the self-generated dynamic certificates already in the centralmsvm. We need a copy of your public ca and push it to each device so that it is accepted for ZTP based provision. Execute the following in the automation VM.

.. code-block:: none

   cd /root/cso-ui-git-master
   scp root@192.168.10.42:/etc/pki/tls/certs/ssl_cert.crt .
   
   mv ssl_cert.crt phcd-ca.crt

.. warning:: Be carefull with the Variables to use here for your own Lab. **Make sure they really belog to your lab!** You can easly remotely zeroize devices one of your colleagues are currently using. So watch your steps.

Now you need to run the bash-script below with the changed terminal server IP and Ports that are valid your own environment. We’re using simple sed-based replacements applied to each of the 10 directrories. I should be ovius with the color coding and nameing conventions what to do in the script below and what to change.

.. code-block:: none

   num=0
   while [ $num -le 9 ]; do
     NEWDIR='cd /root/cso-ui-git-master/useCase'$num
     echo $NEWDIR
     eval $NEWDIR
     echo 'Copy pb.template to pb.yml'
     eval 'cp pb.template pb.yml'
     echo 'Patching pb.yml'
     sed -i 's/_qfx5100TerminalIP_/172.16.xx.yy/g' pb.yml
     sed -i 's/_qfx5100TerminalPORT_/23/g' pb.yml
     sed -i 's/_hub1TerminalIP_/172.16.xx.yy/g' pb.yml
     sed -i 's/_hub1TerminalPORT_/23/g' pb.yml
     sed -i 's/_hub2TerminalIP_/172.16.xx.yy/g' pb.yml
     sed -i 's/_hub2TerminalPORT_/23/g' pb.yml
     sed -i 's/_srxspokeTerminalIP_/172.16.xx.yy/g' pb.yml
     sed -i 's/_srxspokeTerminalPORT_/23/g' pb.yml
     sed -i 's/_nfx2501TerminalIP_/172.16.xx.yy/g' pb.yml
     sed -i 's/_nfx2501TerminalPORT_/23/g' pb.yml
     sed -i 's/_nfx2502TerminalIP_/172.16.xx.yy/g' pb.yml
     sed -i 's/_nfx2502TerminalPORT_/23/g' pb.yml
     num=$(expr $num + 1)
   done
   eval 'cd /root/cso-ui-git-master'

Below is and example from OpenLab DC76

.. hidden-code-block:: none

   num=0
   while [ $num -le 9 ]; do
     NEWDIR='cd /root/cso-ui-git-master/useCase'$num
     echo $NEWDIR
     eval $NEWDIR
     echo 'Copy pb.template to pb.yml'
     eval 'cp pb.template pb.yml'
     echo 'Patching pb.yml'
     sed -i 's/_qfx5100TerminalIP_/10.10.10.178/g' pb.yml
     sed -i 's/_qfx5100TerminalPORT_/7004/g' pb.yml
     sed -i 's/_hub1TerminalIP_/10.10.10.178/g' pb.yml
     sed -i 's/_hub1TerminalPORT_/7005/g' pb.yml
     sed -i 's/_srxspokeTerminalIP_/10.10.10.178/g' pb.yml
     sed -i 's/_srxspokeTerminalPORT_/7006/g' pb.yml
     sed -i 's/_nfx2501TerminalIP_/10.10.10.178/g' pb.yml
     sed -i 's/_nfx2501TerminalPORT_/7001/g' pb.yml
     sed -i 's/_nfx2502TerminalIP_/10.10.10.178/g' pb.yml
     sed -i 's/_nfx2502TerminalPORT_/7002/g' pb.yml
     num=$(expr $num + 1)
   done
   eval 'cd /root/cso-ui-git-master'

Additional patches you might need to do here is an example for OpenLab because instead of having a regular QFX5100-48T-6Q model they have QFX5100-48\ **S**-6Q and most of the ports have only SFP-T and no SFP+.

.. note:: You are highly advised to run a “show chassis hardware” command on the QFX and then adapt your configuration.

Execute the below only if you are confident with the changes it will cause!!!

.. code-block:: none

   num=0
   while [ $num -le 9 ]; do
     NEWDIR='cd /root/cso-ui-git-master/useCase'$num
     echo $NEWDIR
     eval $NEWDIR
     echo 'Patching base_qfx5100.yml (if any)'
     echo 'Patching Lab-access port and vlan'
     sed -i 's/    int: xe-0/    int: ge-0/g' base_qfx5100.yml
     sed -i 's/    vlan_id: 42/    vlan_id: 172/g' base_qfx5100.yml
     echo 'Patching regular Device ports to be ge instead of xe'
     sed -i 's/  int_type: xe/  int_type: ge/g' base_qfx5100.yml
     sed -i 's/    - xe-0/    - ge-0/g' base_qfx5100.yml
     echo 'Patching QFX Management IP (if not DC76)'
     sed -i 's/ip: 10.10.10.179/ip: 10.10.10.179/g' base_qfx5100.yml
     echo 'Patching QFX hostname'
     sed -i 's/host_name: qfx5100-121/host_name: DCxx-qfx5100/g' base_qfx5100.yml
     echo 'Patching nfx250 from S2 to S1 model'
     sed -i 's/page-count 13/page-count 9/g' base_nfx250_1.j2
     sed -i 's/page-count 13/page-count 9/g' base_nfx250_2.j2
     num=$(expr $num + 1)
   done
   eval 'cd /root/cso-ui-git-master'

This step finally applies/submits all your changes to the gitlab instance so that the GUI can use it. Without this step the automation GUI can’t get any proper configuration information.

.. code-block:: none

   cd /root/cso-ui-git-master
   git init
   git add .
   git commit -m "First commit"
   git remote add useCases http://192.168.10.5:9080/cso-ops/usecases.git
   git remote -v
   git push -f --set-upstream useCases master

Build Automation-Gui Docker Contrainer
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   cd /root/cso-ui-master
   
   # get the latest documentation ZIP via this link https://easylink.juniper.net/CSOReferenceLab
   # scp the ASTT-Solutions_-_CSO_generic-testlab-HS*.zip-file to this vm
   scp root@192.168.10.10:/root/ASTT-Solutions_-_CSO_generic-testlab-HS*.zip .
   
   rm -Rf static/docs/*
   mv ASTT-Solutions_-_CSO_generic-testlab-HS*.zip static/docs
   cd static/docs; unzip ASTT-Solutions_-_CSO_generic-testlab-HS*.zip ; cd ../..
   rm static/docs/ASTT-Solutions_-_CSO_generic-testlab-HS*
   
   mkdir -p /tmp/cso-ui/log
   mkdir -p /tmp/cso-ui/data
   
   # remove old images from past trials
   # this won’t touch the RUNNING gitlab container
   docker rm -f cso-ui
   docker system prune -f -a
   docker images -a
   REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
   gitlab/gitlab-ce    latest              2db70ee84b5c        2 weeks ago         1.62GB

In the next step we overwrite the config-file for the automation GUI with a version that is fitting this lab. If you are following our instructions and use the automation VM on the CSO-Host itself the for your own lab you only need to adapt the ws_client_ip with the IP address that your NATVM has for all external access.

Should you host the Containers elsewere then you also need to modify the two RED marked locations (currently 192.168.10.5) where the IP-Address of the GIT Container is else the GUI can’t receive the configuration and push back the rendered device config.

.. code-block:: none

   cat <<EOF >config/config.yml
   driver: pyez
   demo_ref_doc_url: static/docs/readthedocs-html-version/index.html
   jtac_url: https://support.juniper.net/support/
   ws_client_protocol: ws
   ws_client_ip: 172.30.52.57
   ws_client_port: 8670
   git_protocol: http
   git_host: 192.168.10.5
   git_http_port: 9080
   git_ssh_port: 3022
   git_login_url: /oauth/token
   git_repo_url: cso-ops/usecases
   git_device_conf_dir: config
   git_user: root
   git_password: juniper123
   git_branch: master
   tmp_dir: /tmp/cso-ui/data
   log_dir: /tmp/cso-ui/log
   usecases_dir: usecases
   baselog: cso-ui.log
   IS_SSL: False
   DEMONIZE: False
   UI_ADDRESS: 0.0.0.0
   UI_PORT: 8670
   JSNS_URL: https://forums.juniper.net/t5/Security/bg-p/networkingnow
   JTR_URL: https://apacjuniper.net/theshield/
   JTAC_URL: https://support.juniper.net/support/
   EOF
   
   # the giblab container has to be reachable under the below address
   cat <<EOF >config/ssh/config
   Host 192.168.10.5
      StrictHostKeyChecking no
      UserKnownHostsFile=/dev/null
      IdentityFile /root/.ssh/cso-ui
   EOF

This step finally builds and start your automation GUI container.

.. code-block:: none

   cd /root/cso-ui-master
   docker container rm -f cso-ui
   
   # build the container lasts ~4min
   docker build -t cso-ui .
   Sending build context to Docker daemon  75.36MB
   Step 1/9 : FROM python:3
   3: Pulling from library/python
   22dbe790f715: Pull complete
   0250231711a0: Pull complete
   6fba9447437b: Pull complete
   c2b4d327b352: Pull complete
   270e1baa5299: Pull complete
   8dc8edf0ab44: Pull complete
   86ded05de41b: Pull complete
   1eac5266a8fa: Pull complete
   61b3f1392c29: Pull complete
   Digest: sha256:3f8bb7c750e86d031dd14c65d331806105ddc0c6f037ba29510f9b9fbbb35960
   Status: Downloaded newer image for python:3
    ---> 32260605cf7a
   Step 2/9 : RUN mkdir /cso-ui
    ---> Running in 52ef677e36e9
   Removing intermediate container 52ef677e36e9
    ---> 84b365a2c430
   Step 3/9 : COPY . /cso-ui
    ---> 4bef3d7f1bc4
   Step 4/9 : RUN python3 -m pip install --no-cache-dir -r /cso-ui/requirements.txt
    ---> Running in e6ece565577f
   Collecting CherryPy (from -r /cso-ui/requirements.txt (line 1))
     Downloading https://files.pythonhosted.org/packages/3e/a2/cb5636c76781452bacbdb67d666b787ae560fb180d72eb5f94a891fcc03a/CherryPy-18.1.0-py2.py3-none-any.whl (417kB)
   Collecting jinja2 (from -r /cso-ui/requirements.txt (line 2))
     Downloading https://files.pythonhosted.org/packages/7f/ff/ae64bacdfc95f27a016a7bed8e8686763ba4d277a78ca76f32659220a731/Jinja2-2.10-py2.py3-none-any.whl (126kB)
   Collecting six (from -r /cso-ui/requirements.txt (line 3))
     Downloading https://files.pythonhosted.org/packages/73/fb/00a976f728d0d1fecfe898238ce23f502a721c0ac0ecfedb80e0d88c64e9/six-1.12.0-py2.py3-none-any.whl
   Collecting requests (from -r /cso-ui/requirements.txt (line 4))
     Downloading https://files.pythonhosted.org/packages/7d/e3/20f3d364d6c8e5d2353c72a67778eb189176f08e873c9900e10c0287b84b/requests-2.21.0-py2.py3-none-any.whl (57kB)
   Collecting ruamel.yaml (from -r /cso-ui/requirements.txt (line 5))
     Downloading https://files.pythonhosted.org/packages/f3/0d/3370e884749fb8b704457c45ad14c2b6453ca71f99210828e81721f122c4/ruamel.yaml-0.15.89-cp37-cp37m-manylinux1_x86_64.whl (647kB)
   Collecting ws4py (from -r /cso-ui/requirements.txt (line 6))
     Downloading https://files.pythonhosted.org/packages/53/20/4019a739b2eefe9282d3822ef6a225250af964b117356971bd55e274193c/ws4py-0.5.1.tar.gz (51kB)
   Collecting junos-eznc (from -r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/00/b5/3d6d2d572789421b71d2bd7e3bae843db504cad59415bf817c7b9075aad6/junos_eznc-2.2.0-py2.py3-none-any.whl (155kB)
   Collecting jxmlease (from -r /cso-ui/requirements.txt (line 8))
     Downloading https://files.pythonhosted.org/packages/61/66/aea1d3ab6c45bc7653a0d31afcc7b38614ee74c4f205622b668aa175726c/jxmlease-1.0.1-py2.py3-none-any.whl
   Collecting python-gitlab (from -r /cso-ui/requirements.txt (line 9))
     Downloading https://files.pythonhosted.org/packages/e4/79/7cccb27a38e866a8bb16f7780c96a20d1744d8f2b9d900b60ad31447d569/python-gitlab-1.8.0.tar.gz (115kB)
   Collecting gitpython (from -r /cso-ui/requirements.txt (line 10))
     Downloading https://files.pythonhosted.org/packages/fe/e5/fafe827507644c32d6dc553a1c435cdf882e0c28918a5bab29f7fbebfb70/GitPython-2.1.11-py2.py3-none-any.whl (448kB)
   Collecting more-itertools (from CherryPy->-r /cso-ui/requirements.txt (line 1))
     Downloading https://files.pythonhosted.org/packages/ae/d4/d6bad4844831943dd667510947712750004525c5807711982f4ec390da2b/more_itertools-6.0.0-py3-none-any.whl (52kB)
   Collecting cheroot>=6.2.4 (from CherryPy->-r /cso-ui/requirements.txt (line 1))
     Downloading https://files.pythonhosted.org/packages/89/10/96d1db9062afd476e6d63895dd3e41ced836228f904532bc640106be20ef/cheroot-6.5.4-py2.py3-none-any.whl (74kB)
   Collecting zc.lockfile (from CherryPy->-r /cso-ui/requirements.txt (line 1))
     Downloading https://files.pythonhosted.org/packages/58/c2/d7c89bdad237b4b7837609172be3e8bf5630796c0020494a15b97ece8eb1/zc.lockfile-1.4.tar.gz
   Collecting portend>=2.1.1 (from CherryPy->-r /cso-ui/requirements.txt (line 1))
     Downloading https://files.pythonhosted.org/packages/81/43/21afd5914b74d4271184ee76f4093b45aa6a580dc6627d72dfc33664c6ac/portend-2.3-py2.py3-none-any.whl
   Collecting MarkupSafe>=0.23 (from jinja2->-r /cso-ui/requirements.txt (line 2))
     Downloading https://files.pythonhosted.org/packages/98/7b/ff284bd8c80654e471b769062a9b43cc5d03e7a615048d96f4619df8d420/MarkupSafe-1.1.1-cp37-cp37m-manylinux1_x86_64.whl
   Collecting urllib3<1.25,>=1.21.1 (from requests->-r /cso-ui/requirements.txt (line 4))
     Downloading https://files.pythonhosted.org/packages/62/00/ee1d7de624db8ba7090d1226aebefab96a2c71cd5cfa7629d6ad3f61b79e/urllib3-1.24.1-py2.py3-none-any.whl (118kB)
   Collecting chardet<3.1.0,>=3.0.2 (from requests->-r /cso-ui/requirements.txt (line 4))
     Downloading https://files.pythonhosted.org/packages/bc/a9/01ffebfb562e4274b6487b4bb1ddec7ca55ec7510b22e4c51f14098443b8/chardet-3.0.4-py2.py3-none-any.whl (133kB)
   Collecting idna<2.9,>=2.5 (from requests->-r /cso-ui/requirements.txt (line 4))
     Downloading https://files.pythonhosted.org/packages/14/2c/cd551d81dbe15200be1cf41cd03869a46fe7226e7450af7a6545bfc474c9/idna-2.8-py2.py3-none-any.whl (58kB)
   Collecting certifi>=2017.4.17 (from requests->-r /cso-ui/requirements.txt (line 4))
     Downloading https://files.pythonhosted.org/packages/60/75/f692a584e85b7eaba0e03827b3d51f45f571c2e793dd731e598828d380aa/certifi-2019.3.9-py2.py3-none-any.whl (158kB)
   Collecting lxml>=3.2.4 (from junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/af/f7/1d7dc440f4e1b1362c3577b4cf6807fd036d241c33754a8e4769f51172e7/lxml-4.3.2-cp37-cp37m-manylinux1_x86_64.whl (5.7MB)
   Collecting paramiko>=1.15.2 (from junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/cf/ae/94e70d49044ccc234bfdba20114fa947d7ba6eb68a2e452d89b920e62227/paramiko-2.4.2-py2.py3-none-any.whl (193kB)
   Collecting PyYAML>=3.10 (from junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/9f/2c/9417b5c774792634834e730932745bc09a7d36754ca00acf1ccd1ac2594d/PyYAML-5.1.tar.gz (274kB)
   Collecting scp>=0.7.0 (from junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/ed/30/7a0b13dbc6c05a5c58533fc03081cbf1c30fad2d6beac30725233713945e/scp-0.13.1-py2.py3-none-any.whl
   Collecting pyserial (from junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/0d/e4/2a744dd9e3be04a0c0907414e2a01a7c88bb3915cbe3c8cc06e209f59c30/pyserial-3.4-py2.py3-none-any.whl (193kB)
   Collecting netaddr (from junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/ba/97/ce14451a9fd7bdb5a397abf99b24a1a6bb7a1a440b019bebd2e9a0dbec74/netaddr-0.7.19-py2.py3-none-any.whl (1.6MB)
   Collecting ncclient>=0.5.4 (from junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/dc/95/acc44c2ff966743fedd1ad991ecf2498f40fd434883c67138b60a6373d49/ncclient-0.6.3.tar.gz (88kB)
   Collecting gitdb2>=2.0.0 (from gitpython->-r /cso-ui/requirements.txt (line 10))
     Downloading https://files.pythonhosted.org/packages/da/30/a407568aa8d8f25db817cf50121a958722f3fc5f87e3a6fba1f40c0633e3/gitdb2-2.0.5-py2.py3-none-any.whl (62kB)
   Collecting backports.functools-lru-cache (from cheroot>=6.2.4->CherryPy->-r /cso-ui/requirements.txt (line 1))
     Downloading https://files.pythonhosted.org/packages/03/8e/2424c0e65c4a066e28f539364deee49b6451f8fcd4f718fefa50cc3dcf48/backports.functools_lru_cache-1.5-py2.py3-none-any.whl
   Requirement already satisfied: setuptools in /usr/local/lib/python3.7/site-packages (from zc.lockfile->CherryPy->-r /cso-ui/requirements.txt (line 1)) (40.8.0)
   Collecting tempora>=1.8 (from portend>=2.1.1->CherryPy->-r /cso-ui/requirements.txt (line 1))
     Downloading https://files.pythonhosted.org/packages/6a/73/22900a52243fdcb2251a10bdb7c6a75fc8d40ab59ec25c01e26823af5126/tempora-1.14-py2.py3-none-any.whl
   Collecting cryptography>=1.5 (from paramiko>=1.15.2->junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/5b/12/b0409a94dad366d98a8eee2a77678c7a73aafd8c0e4b835abea634ea3896/cryptography-2.6.1-cp34-abi3-manylinux1_x86_64.whl (2.3MB)
   Collecting pyasn1>=0.1.7 (from paramiko>=1.15.2->junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/7b/7c/c9386b82a25115cccf1903441bba3cbadcfae7b678a20167347fa8ded34c/pyasn1-0.4.5-py2.py3-none-any.whl (73kB)
   Collecting bcrypt>=3.1.3 (from paramiko>=1.15.2->junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/d0/79/79a4d167a31cc206117d9b396926615fa9c1fdbd52017bcced80937ac501/bcrypt-3.1.6-cp34-abi3-manylinux1_x86_64.whl (55kB)
   Collecting pynacl>=1.0.1 (from paramiko>=1.15.2->junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/27/15/2cd0a203f318c2240b42cd9dd13c931ddd61067809fee3479f44f086103e/PyNaCl-1.3.0-cp34-abi3-manylinux1_x86_64.whl (759kB)
   Collecting selectors2>=2.0.1 (from ncclient>=0.5.4->junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/c9/89/8a07d6d6c78422c5151f68453e9741af4cd82bebcfa73923f73b3bdbef0d/selectors2-2.0.1-py2.py3-none-any.whl
   Collecting smmap2>=2.0.0 (from gitdb2>=2.0.0->gitpython->-r /cso-ui/requirements.txt (line 10))
     Downloading https://files.pythonhosted.org/packages/55/d2/866d45e3a121ee15a1dc013824d58072fd5c7799c9c34d01378eb262ca8f/smmap2-2.0.5-py2.py3-none-any.whl
   Collecting pytz (from tempora>=1.8->portend>=2.1.1->CherryPy->-r /cso-ui/requirements.txt (line 1))
     Downloading https://files.pythonhosted.org/packages/61/28/1d3920e4d1d50b19bc5d24398a7cd85cc7b9a75a490570d5a30c57622d34/pytz-2018.9-py2.py3-none-any.whl (510kB)
   Collecting jaraco.functools>=1.20 (from tempora>=1.8->portend>=2.1.1->CherryPy->-r /cso-ui/requirements.txt (line 1))
     Downloading https://files.pythonhosted.org/packages/12/a4/3e7366d0f5e75dcad7be88524c8cbd0f3a9fb1db243269550981740c57fe/jaraco.functools-2.0-py2.py3-none-any.whl
   Collecting cffi!=1.11.3,>=1.8 (from cryptography>=1.5->paramiko>=1.15.2->junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/a7/3f/2667a1516d935938245bd256b56a2f96d739ac3683e6778380f06c6e4c79/cffi-1.12.2-cp37-cp37m-manylinux1_x86_64.whl (430kB)
   Collecting asn1crypto>=0.21.0 (from cryptography>=1.5->paramiko>=1.15.2->junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/ea/cd/35485615f45f30a510576f1a56d1e0a7ad7bd8ab5ed7cdc600ef7cd06222/asn1crypto-0.24.0-py2.py3-none-any.whl (101kB)
   Collecting pycparser (from cffi!=1.11.3,>=1.8->cryptography>=1.5->paramiko>=1.15.2->junos-eznc->-r /cso-ui/requirements.txt (line 7))
     Downloading https://files.pythonhosted.org/packages/68/9e/49196946aee219aead1290e00d1e7fdeab8567783e83e1b9ab5585e6206a/pycparser-2.19.tar.gz (158kB)
   Installing collected packages: more-itertools, backports.functools-lru-cache, six, cheroot, zc.lockfile, pytz, jaraco.functools, tempora, portend, CherryPy, MarkupSafe, jinja2, urllib3, chardet, idna, certifi, requests, ruamel.yaml, ws4py, lxml, pycparser, cffi, asn1crypto, cryptography, pyasn1, bcrypt, pynacl, paramiko, PyYAML, scp, pyserial, netaddr, selectors2, ncclient, junos-eznc, jxmlease, python-gitlab, smmap2, gitdb2, gitpython
     Running setup.py install for zc.lockfile: started
       Running setup.py install for zc.lockfile: finished with status 'done'
     Running setup.py install for ws4py: started
       Running setup.py install for ws4py: finished with status 'done'
     Running setup.py install for pycparser: started
       Running setup.py install for pycparser: finished with status 'done'
     Running setup.py install for PyYAML: started
       Running setup.py install for PyYAML: finished with status 'done'
     Running setup.py install for ncclient: started
       Running setup.py install for ncclient: finished with status 'done'
     Running setup.py install for python-gitlab: started
       Running setup.py install for python-gitlab: finished with status 'done'
   Successfully installed CherryPy-18.1.0 MarkupSafe-1.1.1 PyYAML-5.1 asn1crypto-0.24.0 backports.functools-lru-cache-1.5 bcrypt-3.1.6 certifi-2019.3.9 cffi-1.12.2 chardet-3.0.4 cheroot-6.5.4 cryptography-2.6.1 gitdb2-2.0.5 gitpython-2.1.11 idna-2.8 jaraco.functools-2.0 jinja2-2.10 junos-eznc-2.2.0 jxmlease-1.0.1 lxml-4.3.2 more-itertools-6.0.0 ncclient-0.6.3 netaddr-0.7.19 paramiko-2.4.2 portend-2.3 pyasn1-0.4.5 pycparser-2.19 pynacl-1.3.0 pyserial-3.4 python-gitlab-1.8.0 pytz-2018.9 requests-2.21.0 ruamel.yaml-0.15.89 scp-0.13.1 selectors2-2.0.1 six-1.12.0 smmap2-2.0.5 tempora-1.14 urllib3-1.24.1 ws4py-0.5.1 zc.lockfile-1.4
   Removing intermediate container e6ece565577f
    ---> 061d02e53b95
   Step 5/9 : COPY ./config/ssh/config /root/.ssh/config
    ---> d99413cb4bd7
   Step 6/9 : COPY ./config/ssh/cso-ui /root/.ssh/cso-ui
    ---> 1ca73a61c42c
   Step 7/9 : RUN chmod 400 /root/.ssh/cso-ui
    ---> Running in d947d48166ae
   Removing intermediate container d947d48166ae
    ---> d3fa48fe032c
   Step 8/9 : WORKDIR /cso-ui
    ---> Running in 1c6eeeed7c82
   Removing intermediate container 1c6eeeed7c82
    ---> ca08ac840ef8
   Step 9/9 : CMD [ "python3", "./main.py" ]
    ---> Running in 7780ad62b19c
   Removing intermediate container 7780ad62b19c
    ---> 2907f8f1283b
   Successfully built 2907f8f1283b
   Successfully tagged cso-ui:latest
   
   # run the container now
   docker run -d -v /tmp/cso-ui:/tmp/cso-ui -p 8670:8670 --name cso-ui cso-ui
   51edf77c6d4e3e083a76fd27f98e42b9ff1b841d77a583572dd90c31dbd62a81

   # you should now have both containers up and running
   docker ps
   CONTAINER ID        IMAGE                     COMMAND               CREATED              STATUS                PORTS                                                                                   NAMES
   51edf77c6d4e        cso-ui                    "python3 ./main.py"   About a minute ago   Up About a minute     0.0.0.0:8670->8670/tcp                                                                  cso-ui
   45e930a95cd7        gitlab/gitlab-ce:latest   "/assets/wrapper"     6 days ago           Up 6 days (healthy)   80/tcp, 0.0.0.0:9080->9080/tcp, 443/tcp, 0.0.0.0:9443->9443/tcp, 0.0.0.0:3022->22/tcp   gitlab

Useing the automation Framework
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

An introduction Video on the automation is recorded and accessible via this link https://easylink.juniper.net/AutomateCSORef . It is assumed that you have reviewed it before you are allowed to ask any Questions on it :-)

In this section we give additional information that can help you with your task. Please make yourself familiar with them.

It is recommended that you **review the GUI-Logfile** while you run the GUI. Just do like below:

.. code-block:: none

   ssh root@192.168.10.5
   
   docker exec -it cso-ui bash
   tail -f /tmp/cso-ui/log/cso-ui.log

**Changes** or updates **on the automation templates** and lab configuration can be done in two ways:

-  Via GUI in the gitlab Docker Container use: http://192.168.10.5:9080 (or the external-IP).This is recommded for small changes.
-  You do the changes local in the automation VM and push them to Gitlab. This is recommded for larger changes and if you don’t like the Gitlab editor. After you have done your changes this is how you update them in git.

.. code-block:: none

   cd /root/cso-ui-git-master
   git add .
   git config --global push.default simple
   git commit -m "updated all usecaseX for lab xyz"
   git push -f

How to **restart** the Automation **GUI**. It may happen that you run into issues and the automation container doesn’t clear the connection. No issue just reset the container wait a few seconds and login again.

.. code-block:: none

   docker restart cso-ui ; sleep 10 ; docker ps
   CONTAINER ID        IMAGE                     COMMAND               CREATED             STATUS                PORTS                                                                                   NAMES
   51edf77c6d4e        cso-ui                    "python3 ./main.py"   16 minutes ago      Up 10 seconds         0.0.0.0:8670->8670/tcp                                                                  cso-ui
   45e930a95cd7        gitlab/gitlab-ce:latest   "/assets/wrapper"     6 days ago          Up 6 days (healthy)   80/tcp, 0.0.0.0:9080->9080/tcp, 443/tcp, 0.0.0.0:9443->9443/tcp, 0.0.0.0:3022->22/tcp   gitlab

Make sure you really use the reset button after you restarted the GUI-Container. Use the “Refresh”-Button and you should see the login prompt again do not work on an old screen.

|image907|

Automation **can’t push a config** to a device. This happens sometimes when an SRX is zeroized and started it them playes the role of a DHCP server handing out leases. When this happens you can’t apply the device config without clearing the leases before. So use the Telnet session to the device and clear it manually.

.. code-block:: none

   clear dhcp server binding all

**Connnection to Device issues** can have multiple influences:

-  **Somebody else** (maybe yourself) still **has a Telnet Session** to the Device. In the GUI sometimes (depending on the Terminalserver) you see a message like “Connection reset by peer” . That’s a clear indicator for this issue. Terminate the old connection before you do the next attempt!
-  The automation **expects** to see a **“login:” prompt** but you are blocking this by having an editor, shell or other things open still last time you did login. Stop that and logout of the system until you see the login-prompt. If you are unsure power-cycle the device.
-  You try to **login yourself** but **can’t get a prompt**? This is occasionally spotted when the automation was aborted and it still trying to do Netconf. In this case you can close the exesting Netconf session with entering “<><><><>” until you get the prompt again. Sorry for this.

**Initial connection** to device **doesn’t happen** as indicated below. The reasons could be:

-  The automation Container was restarted and you did forget to press the “refresh”-Button in your Browser to login again.
-  You did not correctly configure the “ws_client_ip”-Variable in chapter 8.15.5 above so change that and build the container again else you will get any information (but you can use the logfile).
-  The automation GUI Container “hangs”. Restart the container as shown above.

|image908|

In case you want to develop some own new templates we suggest to render them before you try to apply them offline and review them. Here is an example how to do this

.. code-block:: none

   cat <<EOF >test-render.py
   import yaml
   from jinja2 import Environment, FileSystemLoader
   
   
   # Load the data from the YAML file into a Python Dictionary
   config_data = yaml.load(open('base_qfx5100.yml'))
   
   # Pass the directory containing the template to the FileSystemLoader
   file_loader = FileSystemLoader('.')
   # Load the environment with the relative templates directory set and strip whitespace
   env = Environment(loader=file_loader, trim_blocks=True, lstrip_blocks=True)
   
   # Load the SRX Spoke configuration template into the environment
   template = env.get_template('base_qfx5100.j2')
   
   # Render the merged configuration by passing in the config_data dictionary
   output = template.render(config_data)
   # Print the rendered configuration to the screen
   print(output)
   EOF
   
   python3 test-render.py

Other lab configurations
------------------------

.. hidden-code-block:: none

   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   

Slab Amsterdam
~~~~~~~~~~~~~~

|image909|

Embedded Excel-File of Cable-Plan

**DOWNLOAD**
`CSO-slab-Cabling-Plan-HS01.xlsx <CSO-slab-Cabling-Plan-HS01.xlsx>`__


|image910|

.. hidden-code-block:: none

   
   
   https://172.30.54.194:8143/ admin/contrail123 
   ssh root@172.30.54.194 Poclab123
   
   server-12-ipmi.emealab.jnpr.net has address 172.30.54.147 lenovo/lenovo
   server-8-ipmi.emealab.jnpr.net has address 172.30.54.214 ADMIN/ADMIN
   
   
   172.30.52.57
   
   ssh root@172.30.200.155
   scp Contrail_Service_Orchestration_3.3.1.tar.gz root@172.30.52.57:/root
   scp bionic-server-cloudimg-amd64.img root@172.30.52.57:/root
   scp jinstall-host-qfx-5-17.3R2.10-signed.tgz root@172.30.52.57:/root
   scp junos-* root@172.30.52.57:/root
   scp media-vsrx-vmdisk-15.1X49-D133.qcow2 root@172.30.52.57:/root
   scp contrail-install-packages_3.2.5.0-51~ubuntu-14-04mitaka_all.deb root@172.30.52.57:/root
   scp RIVERBED.tgz root@172.30.52.57:/root
   scp vlan_1.9-3ubuntu10.1_amd64.deb root@172.30.52.57:/root
   
   
   cp /etc/network/interfaces /etc/network/interfaces.orig
   
   cat <<EOF > /etc/network/interfaces
   # This file describes the network interfaces available on your system
   # and how to activate them. For more information, see interfaces(5).
   
   # The loopback network interface
   auto lo
   iface lo inet loopback
   
   # The primary network interface
   auto p7p1
   iface p7p1 inet manual
     up ifconfig p7p1 0.0.0.0 up
   
   auto virbr0
   iface virbr0 inet static
     bridge_ports p7p1
     bridge_stp off
     bridge_fd 0
     bridge_maxwait 0
      address 192.168.10.10
      netmask 255.255.255.0
      gateway 192.168.10.1
      dns-nameservers 192.168.10.10
   EOF
   
   cat <<EOF >/etc/dnsmasq_static_hosts.conf
   192.168.10.1    lab-gw              lab-gw.example.net
   192.168.10.10   cso-host            cso-host.example.net
   192.168.10.15   contrail-host       contrail-host.example.net
   192.168.10.20   qfx5100-121         qfx5100-121.example.net
   192.168.10.21   mx80-10             mx80-10.example.net
   192.168.10.22   srx345-2            srx345-2.example.net
   192.168.10.23   srx345-3            srx345-3.example.net
   192.168.10.24   nfx250-3            nfx250-3.example.net
   192.168.10.25   nfx250-4            nfx250-5.example.net
   192.168.10.26   srx300-1            srx300-1.example.net
   192.168.10.40   installervm         installervm.example.net
   192.168.10.41   centralinfravm      centralinfravm.example.net
   192.168.10.42   centralmsvm         centralmsvm.example.net
   192.168.10.43   centralk8mastervm   centralk8mastervm.example.net
   192.168.10.44   regionalinfravm     regionalinfravm.example.net
   192.168.10.45   regionalmsvm        regionalmsvm.example.net
   192.168.10.46   regionalk8mastervm  regionalk8mastervm.example.net
   192.168.10.47   regional-sblb       regional-sblb.example.net
   192.168.10.48   canvm               canvm.example.net
   192.168.10.49   vrr                 vrr.example.net
   192.168.10.50   spacevm             spacevm.example.net
   192.168.10.51   spacevm-web         spacevm-web.example.net
   192.168.10.60   desktop1            desktop1.example.net
   192.168.10.61   desktop2            desktop2.example.net
   192.168.10.62   desktop3            desktop3.example.net
   192.168.10.63   desktop4            desktop4.example.net
   192.168.10.70   vnf-mgnt            vnf-mgnt.example.net
   192.168.10.71   sdwan-underlay      sdwan-underlay.example.net
   192.168.10.90   ipmi-cso-host       ipmi-cso-host.example.net
   192.168.10.95   ipmi-contrail-host  ipmi-contrail-host.example.net
   EOF
   
   cat <<EOF > user-data
   #cloud-config
   apt_update: true
   disable_root: false
   manage_etc_hosts: false
   chpasswd:
     list: |
       root:juniper123
       ubuntu:ubuntu
     expire: False
   ssh_pwauth: True
   final_message: "The system is finally up, after $UPTIME seconds"
   fqdn: lab-gw.example.net
   groups:
     - cloud-users
   users:
     - default
   runcmd:
     - sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
     - mount /dev/vdb /mnt
     - cp /mnt/vlan_1.9-3ubuntu10.1_amd64.deb /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - dpkg -i /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - sed -i '/net.ipv4.ip_forward/s/^#//g' /etc/sysctl.conf
     - sysctl -p /etc/sysctl.conf
     - touch /etc/cloud/cloud-init.disabled
     - service ssh restart
     - ufw enable; ufw allow ssh
     - iptables -F
     - iptables -X
     - iptables -t nat -F
     - iptables -t nat -X
     - iptables -t mangle -F
     - iptables -t mangle -X
     - iptables -t raw -F
     - iptables -t raw -X
     - iptables -P INPUT ACCEPT
     - iptables -P FORWARD ACCEPT
     - iptables -P OUTPUT ACCEPT
     - iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
     - iptables -A FORWARD -i eth1 -o eth2 -m state --state RELATED,ESTABLISHED -j ACCEPT
     - iptables -A FORWARD -i eth2 -o eth1 -j ACCEPT
     - iptables -A FORWARD -i eth1 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT
     - iptables -A FORWARD -i eth3 -o eth1 -j ACCEPT
     - iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 22 -j DNAT -d 172.30.52.57 --to-destination 192.168.10.10
     - iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 3128 -j DNAT -d 172.30.52.57 --to-destination 192.168.10.10
     - iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 443 -j DNAT -d 172.30.52.57 --to-destination 192.168.10.42
     - iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 4443 -j DNAT -d 172.30.52.57 --to-destination 192.168.10.45:443
     - iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 5000 -j DNAT -d 172.30.52.57 --to-destination 192.168.10.41
     - iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 5900:5999 -j DNAT -d 172.30.52.57 --to-destination 192.168.10.10
     - iptables-save > /etc/network/iptables.rules
     - |
       cloud-init-per instance set_network_interface
   
       echo 'auto lo
       iface lo inet loopback
   
       auto eth1
       iface eth1 inet static
       address 172.30.52.57
       netmask 255.255.255.0
       gateway 172.30.52.1
       pre-up iptables-restore < /etc/network/iptables.rules
   
       auto eth2
       iface eth2 inet static
       address 192.168.10.1
       netmask 255.255.255.0
       up route add -net 192.168.68.0 netmask 255.255.255.0 gw 192.168.10.15
       up route add -net 192.168.69.0 netmask 255.255.255.0 gw 192.168.10.70
   
       auto eth3
       iface eth3 inet manual
   
       auto eth3.70
       iface eth3.70 inet static
       vlan_raw_device eth3
       address 192.168.70.1
       netmask 255.255.255.0
       up route add -net 192.168.128.0 netmask 255.255.128.0 gw 192.168.70.254
       up route add -net 10.88.88.0 netmask 255.255.255.0 gw 192.168.70.254
       up route add -net 10.66.66.0 netmask 255.255.255.0 gw 192.168.70.254
   
       auto eth3.74
       iface eth3.74 inet static
       vlan_raw_device eth3
       address 192.168.74.1
       netmask 255.255.255.0
       up route add -net 10.77.77.0 netmask 255.255.255.0 gw 192.168.74.254
   
       auto eth3.75
       iface eth3.75 inet static
       vlan_raw_device eth3
       address 192.168.75.1
       netmask 255.255.255.0
       up route add -net 10.99.99.0 netmask 255.255.255.0 gw 192.168.75.254
       up route add -net 192.168.66.0 netmask 255.255.255.0 gw 192.168.75.254
       up route add -net 192.168.67.0 netmask 255.255.255.0 gw 192.168.75.254
   
       auto eth3.76
       iface eth3.76 inet static
       vlan_raw_device eth3
       address 192.168.76.1
       netmask 255.255.255.0
       up route add -net 192.168.65.0 netmask 255.255.255.0 gw 192.168.75.254
   
   
       ' > /etc/network/interfaces
   
     - cp /etc/network/interfaces /etc/network/interfaces.default
     - |
       cloud-init-per instance setup_etc_host echo '127.0.1.1 lab-gw.example.net lab-gw' >> /etc/hosts
   power_state:
     mode: reboot
     delay: "now"
     timeout: 120
   EOF
   
   NFX250-3
   ========
   Telnet to 172.30.55.97
   cat /config/device_serial_id
   DD2116AF0059
   ifconfig jmgmt0
   jmgmt0    Link encap:Ethernet  HWaddr ec:13:db:db:09:4b
   
   NFX250-5
   ========
   Telnet to 172.30.55.62
   cat /config/device_serial_id
   DD1816AF0024
   ifconfig jmgmt0
   jmgmt0    Link encap:Ethernet  HWaddr ec:13:db:d3:e2:cb
   
   
   SRX300-1
   ========
   Telnet to 172.30.55.177
   CV2116AF0288
   
   
   SRX345-2
   ========
   Telnet to 172.30.55.72
   CZ0317AF0302
   show interfaces fxp0 f4:a7:39:25:5d:00
   
   
   SRX345-3
   ========
   Telnet to 172.30.55.34
   CZ0417AF0130
   show interfaces fxp0 f4:a7:39:28:e2:80
   
   
   SRX4100-3
   ========
   Telnet to 172.30.55.49
   15.1X49-D133
   DJ5216AR0049
   
   delete interfaces xe-0/0/37
   delete groups sdwan-basic interfaces xe-0/0/37
   delete interfaces xe-0/0/24
   delete protocols rstp interface xe-0/0/24
   set groups sdwan-basic interfaces xe-0/0/24 unit 0 family inet address 192.168.190.1/24
   set groups sdwan-basic routing-instances hub-wan0 interface xe-0/0/24.0
   delete interfaces xe-0/0/38
   delete groups sdwan-basic interfaces xe-0/0/38
   delete interfaces xe-0/0/25
   delete protocols rstp interface xe-0/0/25
   set groups sdwan-basic interfaces xe-0/0/25 unit 0 family inet address 192.168.191.1/24
   set groups sdwan-basic routing-instances hub-wan1 interface xe-0/0/25.0
   set interfaces xe-0/0/37 disable
   set interfaces xe-0/0/38 disable
   delete interfaces xe-0/0/24 disable
   delete interfaces xe-0/0/25 disable
   
   
   
   cat <<EOF > fabfile/testbeds/testbed.py
   from fabric.api import env
   
   #Management ip addresses of hosts in the cluster
   host1 = 'root@192.168.10.15'
   
   
   #External routers if any
   #for eg.
   ext_routers = [('mx80', '169.254.169.254')]
   #ext_routers = []
   
   #Autonomous system number
   router_asn = 64512
   
   #Host from which the fab commands are triggered to install and provision
   host_build = 'root@192.168.10.15'
   
   
   #Role definition of the hosts.
   env.roledefs = {
       'all': [host1],
       'cfgm': [host1],
       'openstack': [host1],
       'control': [host1],
       'compute': [host1],
       'collector': [host1],
       'webui': [host1],
       'database': [host1],
       'build': [host_build],
   }
   
   #Openstack admin password
   env.openstack_admin_password = 'contrail123'
   
   env.hostnames = {
       host1: 'contrail-host',
   }
   
   # Passwords of each host
   # for passwordless login's no need to set env.passwords,
   # instead populate env.key_filename in testbed.py with public key.
   env.passwords = {
       host1: 'juniper123',
       host_build: 'juniper123',
   }
   
   
   #For reimage purpose
   env.ostypes = {
       host1:'ubuntu',
   }
   
   #ntp server the servers should point to
   env.ntp_server = '192.168.10.10'
   
   minimum_diskGB = 128
   
   
   #OPTIONAL SEPARATION OF MANAGEMENT AND CONTROL + DATA and OPTIONAL VLAN INFORMATION
   #==================================================================================
   control_data = {
       host1 : { 'ip': '192.168.68.15/24', 'gw' : '192.168.68.1', 'device': 'p1p2' },
   }
   
   #OPTIONAL STATIC ROUTE CONFIGURATION
   #===================================
   static_route  = {
       host1 : [ { 'ip': '169.254.169.254', 'netmask' : '255.255.255.255', 'gw':'192.168.68.1', 'intf': 'p1p2' }],
   }
   
   #To enable multi-tenancy feature
   multi_tenancy = True
   
   
   #To Enable prallel execution of task in multiple nodes
   do_parallel = True
   
   # To configure the encapsulation priority. Default: MPLSoGRE
   #env.encap_priority =  "'MPLSoUDP','MPLSoGRE','VXLAN'"
   EOF

Openlab DC73
~~~~~~~~~~~~

.. hidden-code-block:: none

   
   172.16.73.253
   
   SRX300   CV1217AF0608
   NFX250-1 DD2516AF0494
   NFX250-2 DD2516AF0383
   SRX345-1 CZ2117AF0287 (hub)
   
   
   apt-get -y install ntp
   
   service ntp stop
   ntpdate 0.us.pool.ntp.org
   service ntp start
   
   mv /etc/ntp.conf /etc/ntp.conf.orig
   touch /var/lib/ntp/drift
   
   cat <<EOF > /etc/ntp.conf
   driftfile /var/lib/ntp/drift
   server 0.us.pool.ntp.org
   restrict -4 default kod notrap nomodify nopeer noquery
   restrict -6 default kod notrap nomodify nopeer noquery
   includefile /etc/ntp/crypto/pw
   keys /etc/ntp/keys
   EOF
   
   service ntp restart
   
   
   
   cat <<EOF > user-data
   #cloud-config
   apt_update: true
   disable_root: false
   manage_etc_hosts: false
   chpasswd:
     list: |
       root:juniper123
       ubuntu:ubuntu
     expire: False
   ssh_pwauth: True
   final_message: "The system is finally up, after $UPTIME seconds"
   fqdn: lab-gw.example.net
   groups:
     - cloud-users
   users:
     - default
   runcmd:
     - sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
     - mount /dev/vdb /mnt
     - cp /mnt/vlan_1.9-3ubuntu10.1_amd64.deb /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - dpkg -i /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - sed -i '/net.ipv4.ip_forward/s/^#//g' /etc/sysctl.conf
     - sysctl -p /etc/sysctl.conf
     - touch /etc/cloud/cloud-init.disabled
     - service ssh restart
     - ufw enable; ufw allow ssh
     - iptables -F
     - iptables -X
     - iptables -t nat -F
     - iptables -t nat -X
     - iptables -t mangle -F
     - iptables -t mangle -X
     - iptables -t raw -F
     - iptables -t raw -X
     - iptables -P INPUT ACCEPT
     - iptables -P FORWARD ACCEPT
     - iptables -P OUTPUT ACCEPT
     - iptables -t nat -A POSTROUTING -o eth1.42 -j MASQUERADE
     - iptables -A FORWARD -i eth1.42 -o eth2 -m state --state RELATED,ESTABLISHED -j ACCEPT
     - iptables -A FORWARD -i eth2 -o eth1.42 -j ACCEPT
     - iptables -A FORWARD -i eth1.42 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT
     - iptables -A FORWARD -i eth3 -o eth1.42 -j ACCEPT
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 22 -j DNAT -d 172.16.73.253 --to-destination 192.168.10.10
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 3128 -j DNAT -d 172.16.73.253 --to-destination 192.168.10.10
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 443 -j DNAT -d 172.16.73.253 --to-destination 192.168.10.42
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 4443 -j DNAT -d 172.16.73.253 --to-destination 192.168.10.45:443
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 5000 -j DNAT -d 172.16.73.253 --to-destination 192.168.10.41
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 5900:5999 -j DNAT -d 172.16.73.253 --to-destination 192.168.10.10
     - iptables-save > /etc/network/iptables.rules
     - |
       cloud-init-per instance set_network_interface
   
       echo 'auto lo
       iface lo inet loopback
   
       auto eth1
       iface eth1 inet manual
   
       auto eth1.42
       iface eth1.42 inet static
       vlan_raw_device eth1
       address 172.16.73.253
       netmask 255.255.255.0
       gateway 172.16.73.254
       pre-up iptables-restore < /etc/network/iptables.rules
   
       auto eth2
       iface eth2 inet static
       address 192.168.10.1
       netmask 255.255.255.0
       up route add -net 192.168.68.0 netmask 255.255.255.0 gw 192.168.10.15
       up route add -net 192.168.69.0 netmask 255.255.255.0 gw 192.168.10.70
   
       auto eth3
       iface eth3 inet manual
   
       auto eth3.70
       iface eth3.70 inet static
       vlan_raw_device eth3
       address 192.168.70.1
       netmask 255.255.255.0
       up route add -net 192.168.128.0 netmask 255.255.128.0 gw 192.168.70.254
       up route add -net 10.88.88.0 netmask 255.255.255.0 gw 192.168.70.254
       up route add -net 10.66.66.0 netmask 255.255.255.0 gw 192.168.70.254
   
       auto eth3.74
       iface eth3.74 inet static
       vlan_raw_device eth3
       address 192.168.74.1
       netmask 255.255.255.0
       up route add -net 10.77.77.0 netmask 255.255.255.0 gw 192.168.74.254
   
       auto eth3.75
       iface eth3.75 inet static
       vlan_raw_device eth3
       address 192.168.75.1
       netmask 255.255.255.0
       up route add -net 10.99.99.0 netmask 255.255.255.0 gw 192.168.75.254
       up route add -net 192.168.66.0 netmask 255.255.255.0 gw 192.168.75.254
       up route add -net 192.168.67.0 netmask 255.255.255.0 gw 192.168.75.254
   
       auto eth3.76
       iface eth3.76 inet static
       vlan_raw_device eth3
       address 192.168.76.1
       netmask 255.255.255.0
       up route add -net 192.168.65.0 netmask 255.255.255.0 gw 192.168.75.254
   
   
       ' > /etc/network/interfaces
   
     - cp /etc/network/interfaces /etc/network/interfaces.default
     - |
       cloud-init-per instance setup_etc_host echo '127.0.1.1 lab-gw.example.net lab-gw' >> /etc/hosts
   power_state:
     mode: reboot
     delay: "now"
     timeout: 120
   EOF
   
   cli
   edit
   delete chassis auto-image-upgrade
   set system host-name qfx5100-1
   set system root-authentication encrypted-password "$6$nCsDlN7N$qTG9G3zHHBcF8wwIkuH3VAwbwU4oV4kdhwv7CSyenNDA/qReSfZ2kuUPGcQWmnON4mfKAwjC323c8hkKr3iWh1"
   commit
   
   set system services ssh root-login allow
   set system services ssh client-alive-interval 120
   set system services netconf ssh
   set system name-server 192.168.10.10
   set system ntp boot-server 192.168.10.10
   set system ntp server 192.168.10.10
   set protocols lldp interface all
   delete protocols rstp
   set protocols rstp interface all
   delete interfaces em1 unit 0 family inet dhcp
   delete interfaces irb unit 0 family inet dhcp
   delete interfaces vme unit 0 family inet dhcp
   wildcard range delete interfaces ge-0/0/[0-47] 
   wildcard range delete interfaces xe-0/0/[0-53] 
   wildcard range set interfaces ge-0/0/[0-47] unit 0 family ethernet-switching storm-control default
   wildcard range set interfaces xe-0/0/[0-53] unit 0 family ethernet-switching storm-control default
   set interfaces vme unit 0 family inet address 10.10.10.234/20
   #
   # Prepare the Port where the CSO-Host is attached
   #
   delete interfaces xe-0/0/2
   set interfaces xe-0/0/2 native-vlan-id 1
   set interfaces xe-0/0/2 unit 0 family ethernet-switching interface-mode trunk
   set interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 1
   set interfaces xe-0/0/2 unit 0 family ethernet-switching storm-control default
   # 
   set vlans lab-access vlan-id 42
   set interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 42
   delete interfaces ge-0/0/0
   set interfaces ge-0/0/0 unit 0 family ethernet-switching interface-mode access
   set interfaces ge-0/0/0 unit 0 family ethernet-switching vlan members 42
   #
   set interfaces irb unit 0 family inet address 192.168.10.20/24
   commit and-quit
   
   
   
   2018-05-25 14:11:54 INFO     calling deployutils.get_vip on *.central
   2018-05-25 14:11:54 INFO     calling deployutils.get_vip on *.central
   2018-05-25 14:11:54 INFO     calling deployutils.get_vip on *.central
   2018-05-25 14:11:55 INFO     Filling micro_services.conf with values from latest topology deployment
   2018-05-25 14:11:56 INFO     ********** downloading microservice images for ['csp-telemetry-converter', 'csp-cms-central', 'cadvisor', 'nso', 'csp-iamsvc-noauth', 'csp-pslam-core', 'csp-schema-svc', 'nso-core', 'csp-sse', 'csp-ims-central-core', 'secmgt-appvisibility', 'vnfm-core', 'csp-data-view-central', 'csp-topology-service-core', 'csp-topology-service', 'csp-ems-central', 'ne-core', 'csp-routing-manager-core', 'csp-job-service-core', 'csp-inv-central', 'ne', 'vnfm', 'nsd-ui', 'csp-ims-central', 'admin-portal-ui', 'csp-design-tools-central', 'csp-fmpm-provider', 'logspout', 'csp-vim', 'csp-signature-manager', 'csp-shared-object', 'csp-schema-service', 'csp-fmpm-provider-core', 'csp-template-service', 'csp-vim-core', 'secmgt-sm', 'csp-cms-central-core', 'csp-iamsvc', 'csp-inv-central-core', 'csp-cslm-core', 'csp-tssm', 'csp-activation-service-central', 'secmgt-seci', 'csp-routing-manager', 'csp-dms-central-core', 'secmgt-ecm', 'csp-policy-mgmt', 'csp-cslm', 'csp-job-service', 'csp-hybrid-access-core', 'csp-pslam', 'csp-fmpm-collector', 'csp-shared-object-core', 'csp-policy-mgmt-core', 'csp-hybrid-access', 'csp-dms-central', 'csp-ams', 'csp-signature-manager-core', 'csp-tssm-core', 'prometheus', 'csp-ipam', 'secmgt-jingest']**********
   2018-05-25 14:11:56 INFO     calling cmd.run_all on G@roles:kubeminion and G@deployment_env:central and G@roles_instances:kubeminion
   2018-05-25 14:11:56 INFO
   2018-05-25 14:11:56 INFO     calling cmd.run_all on G@roles:kubeminion and G@deployment_env:central and G@roles_instances:kubeminion
   ^C
   ^C2018-05-25 14:26:11 CRITICAL Incorrect YAML format in manifest file http://127.0.0.1:90/csp_components/csp331-artifacts-1.0.yaml
   
   
   ==================================
   The Micro Services Deployment has encountered some errors.
   Please check the logs
       deployments/central/logs/ms_console.log
       deployments/central/logs/ms_error.log
       deployments/central/logs/ms.log
   ==================================
   
   mkdir /media/ramdisk
   chmod 777 /media/ramdisk 
   mount -t tmpfs -o size=250G tmpfs /media/ramdisk
   rm /root/ubuntu_vm
   ln -s /media/ramdisk /root/ubuntu_vm
   
   
   ####deploy on ramdisk times
   
                    ['Cassandra', 'ElasticSearch', 'Etcd', 'MariaDb', 'RabbitMQ', 'ZooKeeper', 'Redis', 'ArangoDb', 'Sim_Cluster', 'Elk_Logstash', 'Elk_Kibana', 'Keystone', 'Swift', 'Kubernetes', 'Contrail_Analytics']
   2018-05-25 19:42:47 INFO     =============== Deployment start time : 2018-05-25 18:56:50.961691 ==============
   2018-05-25 19:42:47 INFO     =============== Deployment end time : 2018-05-25 19:42:47.936907   ==============
   2018-05-25 19:42:47 INFO     =============== Deployment duration : 0:45:56.975216   ==============
   
            The following Infrastructure Components are Healthy:
   
                    ['Cassandra', 'ElasticSearch', 'Etcd', 'RabbitMQ', 'ZooKeeper', 'Redis', 'Elk_Logstash', 'Elk_Kibana', 'Swift', 'Kubernetes']
   2018-05-25 20:10:14 INFO     =============== Deployment start time : 2018-05-25 19:44:22.335679 ==============
   2018-05-25 20:10:14 INFO     =============== Deployment end time : 2018-05-25 20:10:14.956740   ==============
   2018-05-25 20:10:14 INFO     =============== Deployment duration : 0:25:52.621061   ==============
   
   100%[===============================================================================================================================>] 8,095       --.-K/s   in 0s
   
   2018-05-25 20:33:26 (284 MB/s) - ‘/root/Contrail_Service_Orchestration_3.3.1/micro_services/manifest.yaml’ saved [8095/8095]
   
   2018-05-25 20:33:32 INFO     Setting up microservices monitoring
   2018-05-25 20:33:34 INFO     url=https://192.168.10.42:5665/v1/objects/hostgroups/CENTRAL_SERVICESresponse={"results":[{"code":200.0,"status":"Object was created"}]}
   2018-05-25 20:33:34 INFO     url=https://192.168.10.42:5665/v1/objects/hosts/192.168.10.43response={"results":[{"code":200.0,"status":"Object was created"}]}
   2018-05-25 20:33:34 INFO     url=https://192.168.10.42:5665/v1/objects/hosts/192.168.10.42response={"results":[{"code":200.0,"status":"Object was created"}]}
   2018-05-25 20:33:35 INFO     =============== Deployment start time : 2018-05-25 20:11:19.415379 ==============
   2018-05-25 20:33:35 INFO     =============== Deployment end time : 2018-05-25 20:33:35.805077   ==============
   2018-05-25 20:33:35 INFO     =============== Deployment duration : 0:22:16.389698   ==========================
   
   
   2018-05-25 20:44:52 INFO     Setting up microservices monitoring
   2018-05-25 20:44:53 INFO     url=https://192.168.10.42:5665/v1/objects/hostgroups/REGIONAL_SERVICESresponse={"results":[{"code":200.0,"status":"Object was created"}]}
   2018-05-25 20:44:53 INFO     url=https://192.168.10.42:5665/v1/objects/hosts/192.168.10.45response={"results":[{"code":200.0,"status":"Object was created"}]}
   2018-05-25 20:44:54 INFO     url=https://192.168.10.42:5665/v1/objects/hosts/192.168.10.46response={"results":[{"code":200.0,"status":"Object was created"}]}
   2018-05-25 20:44:55 INFO     =============== Deployment start time : 2018-05-25 20:34:34.753364 ==============
   2018-05-25 20:44:55 INFO     =============== Deployment end time : 2018-05-25 20:44:55.016160   ==============
   2018-05-25 20:44:55 INFO     =============== Deployment duration : 0:10:20.262796   ==========================
   
   INFO     Success: Verified that default-project is same in services. Keystone b79e6d2e344e4173a33aa96f0063d570, IAMSVC-REGIONAL b79e6d2e-344e-4173-a33a-a96f0063d570
   INFO     Setting pacakge name and version into etcd
   INFO     Setting pacakge name and version into etcd is successful
   INFO     IMPORT SUCCESS
   INFO     =============== Deployment start time : 2018-05-25 20:45:29.804400 ==============
   INFO     =============== Deployment end time : 2018-05-25 20:49:24.661305   ==============
   INFO     =============== Deployment duration : 0:03:54.856905   ==============
   
   
   root@cso-host:~#
   
   RAW_TOKEN=`curl -d '{"auth":{"tenantName":"admin", "passwordCredentials":{"username":"admin", "password":"5DQkO6ME2Y87"}}}' -H "Content-type: application/json" http://192.168.10.41:5000/v2.0/tokens`
   TOKEN=`echo $RAW_TOKEN | python -c "import sys; import json; tok = json.loads(sys.stdin.read()); print tok['access']['token']['id'];"`
   echo $TOKEN
   
   curl -v --insecure -X POST -H "x-auth-token:$TOKEN" -H "Content-Type: multipart/form-data" -F "imagefile=@/root/JNPR-IMGs/NFX250/jinstall-nfx-2-flex-15.1X53-D473.1.secure-domestic-signed.tgz" -F "cname=jinstall-nfx-2-flex-15.1X53-D473.1.secure-domestic-signed.tgz" -F "image_type=DEVICE_IMAGE" -F "description=NFX 15.1" -F "device_family=juniper-nfx" -F "supported_platform=nfx250" -F "vendor=Juniper" -F "major_version=15" -F "minor_version=1" -F "build_num=15.1"  "https://192.168.10.42/ims-central/upload_image_file"
   
   curl -v --insecure -X POST -H "x-auth-token:$TOKEN" -H "Content-Type: multipart/form-data" -F "imagefile=@/root/JNPR-IMGs/vSRX/media-vsrx-vmdisk-15.1X49-D134.2.qcow2" -F "cname=vsrx-vmdisk-15.1.qcow2" -F "image_type=VNF_IMAGE" -F "description=vSRX 15.1 D123" -F "device_family=SRX" -F "supported_platform=vSRX" -F "vendor=Juniper" -F "major_version=15" -F "minor_version=1" -F "build_num=15.1"  "https://192.168.10.42/ims-central/upload_image_file"
   
   root@cso-host:~# df -lh
   Filesystem      Size  Used Avail Use% Mounted on
   udev            252G  4.0K  252G   1% /dev
   
   
   cd /root
   mkdir backup
   date
   cp /var/lib/libvirt/images/delayvm.qcow2 /root/backup
   cp /var/lib/libvirt/images/desktop1.qcow2 /root/backup
   cp /var/lib/libvirt/images/desktop2.qcow2 /root/backup
   cp /var/lib/libvirt/images/desktop3.qcow2 /root/backup
   cp /var/lib/libvirt/images/desktop4.qcow2 /root/backup
   date
   cp -R /media/ramdisk /root/backup
   date
   
   tmpfs            51G  1.6M   51G   1% /run
   /dev/sda3       3.6T   82G  3.4T   3% /
   none            4.0K     0  4.0K   0% /sys/fs/cgroup
   none            5.0M     0  5.0M   0% /run/lock
   none            252G     0  252G   0% /run/shm
   none            100M     0  100M   0% /run/user
   tmpfs           250G  187G   64G  75% /media/ramdisk
   
   
   root@cso-host:~# date
   Fri May 25 17:33:48 EDT 2018
   root@cso-host:~# cp /var/lib/
   
   reboot
   
   mkdir /media/ramdisk
   chmod 777 /media/ramdisk 
   mount -t tmpfs -o size=250G tmpfs /media/ramdisk
   rm /root/ubuntu_vm
   ln -s /media/ramdisk /root/ubuntu_vm
   
   
   ######## after backup
   
   rm /root/backup/ubuntu_vm
   mv /root/backup/ramdisk /root/backup/ubuntu_vm
   
   
   root@cso-host:~/backup# ls -l /root/backup/
   total 8988080
   -rw-r--r--  1 root root       2467 May 25 18:03 canvm.xml
   -rw-r--r--  1 root root       2237 May 25 18:03 centralinfravm.xml
   -rw-r--r--  1 root root       2525 May 25 18:03 centralk8mastervm.xml
   -rw-r--r--  1 root root       2497 May 25 18:03 centralmsvm.xml
   -rw-r--r--  1 root root  380502016 May 25 17:33 delayvm.qcow2
   -rw-r--r--  1 root root       2423 May 25 18:03 delayvm.xml
   -rw-r--r--  1 root root 2194997248 May 25 17:33 desktop1.qcow2
   -rw-r--r--  1 root root       1926 May 25 18:03 desktop1.xml
   -rw-r--r--  1 root root 2217082880 May 25 17:34 desktop2.qcow2
   -rw-r--r--  1 root root       1926 May 25 18:03 desktop2.xml
   -rw-r--r--  1 root root 2217148416 May 25 17:34 desktop3.qcow2
   -rw-r--r--  1 root root       1926 May 25 18:03 desktop3.xml
   -rw-r--r--  1 root root 2194276352 May 25 17:34 desktop4.qcow2
   -rw-r--r--  1 root root       1926 May 25 18:03 desktop4.xml
   -rw-r--r--  1 root root       2225 May 25 18:03 installervm.xml
   -rw-r--r--  1 root root       3729 May 25 18:03 natvm.xml
   -rw-r--r--  1 root root       2241 May 25 18:03 regionalinfravm.xml
   -rw-r--r--  1 root root       2251 May 25 18:03 regionalk8mastervm.xml
   -rw-r--r--  1 root root       2502 May 25 18:03 regionalmsvm.xml
   -rw-r--r--  1 root root       2231 May 25 18:03 regional-sblb.xml
   drwxr-xr-t 12 root root       4096 May 25 17:46 ubuntu_vm
   -rw-r--r--  1 root root       2066 May 25 18:03 vrr.xml
   -rw-r--r--  1 root root          1 May 25 18:03 vsrx.xml
   root@cso-host:~/backup#
   
   
   set apply-groups sdwan-basic
   
   delete interfaces ge-0/0/22
   delete interfaces ge-0/0/32
   delete protocols rstp interface ge-0/0/22
   delete protocols rstp interface ge-0/0/32
   set groups sdwan-basic interfaces ge-0/0/22 unit 0 family inet address 192.168.130.1/24
   set groups sdwan-basic interfaces ge-0/0/32 unit 0 family inet address 192.168.170.1/24
   set groups sdwan-basic routing-instances spoke-wan0 instance-type virtual-router
   set groups sdwan-basic routing-instances spoke-wan0 interface ge-0/0/22.0
   set groups sdwan-basic routing-instances spoke-wan0 interface ge-0/0/32.0
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface ge-0/0/22.0
   set groups sdwan-basic routing-instances spoke-wan0 system services dhcp-local-server group spoke-wan0 interface ge-0/0/32.0
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet network 192.168.130.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range low 192.168.130.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet range spoke-wan0-nfx-pool-range high 192.168.130.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-nfx-pool family inet dhcp-attributes router 192.168.130.1
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet network 192.168.170.0/24
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet range spoke-wan0-srx-pool-range low 192.168.170.100
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet range spoke-wan0-srx-pool-range high 192.168.170.199
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan0 access address-assignment pool spoke-wan0-srx-pool family inet dhcp-attributes router 192.168.170.1
   set groups sdwan-basic routing-instances spoke-wan0 routing-options static route 0.0.0.0/0 next-hop 192.168.131.254
   
   set groups sdwan-basic interfaces irb unit 131 family inet address 192.168.131.1/24
   set groups sdwan-basic vlans vlan131 vlan-id 131
   set groups sdwan-basic vlans vlan131 l3-interface irb.131
   set groups sdwan-basic routing-instances spoke-wan0 interface irb.131
   
   delete interfaces ge-0/0/23
   delete interfaces ge-0/0/33
   delete protocols rstp interface ge-0/0/23
   delete protocols rstp interface ge-0/0/33
   set groups sdwan-basic interfaces ge-0/0/23 unit 0 family inet address 192.168.133.1/24
   set groups sdwan-basic interfaces ge-0/0/33 unit 0 family inet address 192.168.173.1/24
   set groups sdwan-basic routing-instances spoke-wan1 instance-type virtual-router
   set groups sdwan-basic routing-instances spoke-wan1 interface ge-0/0/23.0
   set groups sdwan-basic routing-instances spoke-wan1 interface ge-0/0/33.0
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface ge-0/0/23.0
   set groups sdwan-basic routing-instances spoke-wan1 system services dhcp-local-server group spoke-wan1 interface ge-0/0/33.0
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet network 192.168.133.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range low 192.168.133.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet range spoke-wan1-nfx-pool-range high 192.168.133.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-nfx-pool family inet dhcp-attributes router 192.168.133.1
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet network 192.168.173.0/24
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet range spoke-wan1-srx-pool-range low 192.168.173.100
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet range spoke-wan1-srx-pool-range high 192.168.173.199
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes domain-name example.net
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes name-server 192.168.10.10
   set groups sdwan-basic routing-instances spoke-wan1 access address-assignment pool spoke-wan1-srx-pool family inet dhcp-attributes router 192.168.173.1
   set groups sdwan-basic routing-instances spoke-wan1 routing-options static route 0.0.0.0/0 next-hop 192.168.134.254
   
   set groups sdwan-basic interfaces irb unit 134 family inet address 192.168.134.1/24
   set groups sdwan-basic vlans vlan134 vlan-id 134
   set groups sdwan-basic vlans vlan134 l3-interface irb.134
   set groups sdwan-basic routing-instances spoke-wan1 interface irb.134
   
   
   delete interfaces ge-0/0/37
   delete protocols rstp interface ge-0/0/37
   set groups sdwan-basic interfaces ge-0/0/37 unit 0 family inet address 192.168.190.1/24
   set groups sdwan-basic routing-instances hub-wan0 instance-type virtual-router
   set groups sdwan-basic routing-instances hub-wan0 interface ge-0/0/37.0
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.130.0/24 next-hop 192.168.132.254
   set groups sdwan-basic routing-instances hub-wan0 routing-options static route 192.168.170.0/24 next-hop 192.168.132.254
   
   set groups sdwan-basic interfaces irb unit 132 family inet address 192.168.132.1/24
   set groups sdwan-basic vlans vlan132 vlan-id 132
   set groups sdwan-basic vlans vlan132 l3-interface irb.132
   set groups sdwan-basic routing-instances hub-wan0 interface irb.132
   
   
   delete interfaces ge-0/0/38
   delete protocols rstp interface ge-0/0/38
   set groups sdwan-basic interfaces ge-0/0/38 unit 0 family inet address 192.168.191.1/24
   set groups sdwan-basic routing-instances hub-wan1 instance-type virtual-router
   set groups sdwan-basic routing-instances hub-wan1 interface ge-0/0/38.0
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.133.0/24 next-hop 192.168.135.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 192.168.173.0/24 next-hop 192.168.135.254
   # route for the Spoke LAN’s to go to Internet
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.88.88.0/24 next-hop 192.168.191.254
   set groups sdwan-basic routing-instances hub-wan1 routing-options static route 10.66.66.0/24 next-hop 192.168.191.254
   
   
   set groups sdwan-basic interfaces irb unit 135 family inet address 192.168.135.1/24
   set groups sdwan-basic vlans vlan135 vlan-id 135
   set groups sdwan-basic vlans vlan135 l3-interface irb.135
   set groups sdwan-basic routing-instances hub-wan1 interface irb.135
   
   
   set groups sdwan-basic interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 131
   set groups sdwan-basic interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 132
   set groups sdwan-basic interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 134
   set groups sdwan-basic interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 135
   
   commit
   
   # setup and connect the LAN interfaces of the two spoke devices
   
   set groups sdwan-basic vlans desktop2 vlan-id 1088
   set groups sdwan-basic vlans desktop4 vlan-id 1066
   
   delete interface ge-0/0/36
   set groups sdwan-basic interfaces ge-0/0/36 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-basic interfaces ge-0/0/36 unit 0 family ethernet-switching vlan members 1088
   
   delete interface ge-0/0/18
   set groups sdwan-basic interfaces ge-0/0/18 unit 0 family ethernet-switching interface-mode trunk
   set groups sdwan-basic interfaces ge-0/0/18 unit 0 family ethernet-switching vlan members 1066
   
   set groups sdwan-basic interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 1088
   set groups sdwan-basic interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 1066
   
   commit
   
   
   # also make sure the other interfaces towards NFX unused in this demo are disabled
   set interfaces ge-0/0/19 disable
   set interfaces ge-0/0/20 disable
   set interfaces ge-0/0/21 disable
   delete interfaces ge-0/0/22 disable
   delete interfaces ge-0/0/23 disable
   set interfaces ge-0/0/24 disable
   set interfaces ge-0/0/25 disable
   
   # also make sure the other interfaces towards srx345 unused in this demo are disabled
   delete interfaces ge-0/0/32 disable
   delete interfaces ge-0/0/33 disable
   delete interfaces ge-0/0/36 disable
   set interfaces ge-0/0/34 disable
   set interfaces ge-0/0/35 disable
   
   # also make sure the other interfaces towards srx1500-1 unused in this demo are disabled
   # you only need ge-0/0/0 and ge-0/0/1 in this demo
   delete interfaces ge-0/0/37 disable
   delete interfaces ge-0/0/38 disable
   set interfaces ge-0/0/39 disable
   set interfaces ge-0/0/40 disable
   set interfaces ge-0/0/41 disable
   
   #
   # Ribgroups and VRs and interfaces for Internet Access
   #
   set groups sdwan-basic interfaces irb unit 70 family inet address 192.168.70.254/24
   set groups sdwan-basic vlans natuplink vlan-id 70
   set groups sdwan-basic vlans natuplink l3-interface irb.70
   
   set groups sdwan-basic routing-instances internetaccess instance-type virtual-router
   set groups sdwan-basic routing-instances internetaccess interface irb.70
   set groups sdwan-basic routing-instances internetaccess routing-options static route 0.0.0.0/0 next-hop 192.168.70.1
   
   delete groups sdwan-basic policy-options policy-statement directandstatic1
   set groups sdwan-basic policy-options policy-statement directandstatic1 term a from instance internetaccess
   set groups sdwan-basic policy-options policy-statement directandstatic1 term a then accept
   set groups sdwan-basic policy-options policy-statement directandstatic1 term b then reject
   set groups sdwan-basic routing-instances hub-wan0 routing-options instance-import directandstatic1
   set groups sdwan-basic routing-instances hub-wan1 routing-options instance-import directandstatic1
   
   delete groups sdwan-basic policy-options policy-statement directandstatic2
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c from instance hub-wan0
   set groups sdwan-basic policy-options policy-statement directandstatic2 term c then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d from instance hub-wan1
   set groups sdwan-basic policy-options policy-statement directandstatic2 term d then accept
   set groups sdwan-basic policy-options policy-statement directandstatic2 term e then reject
   set groups sdwan-basic routing-instances internetaccess routing-options instance-import directandstatic2
   
   
   # Some other ports to open
   delete interfaces ge-0/0/16 disable
   
   # hub1 to NAT gw uplink
   set groups sdwan-basic interfaces xe-0/0/2 unit 0 family ethernet-switching vlan members 70
   
   commit and-quit
   
   

JCL Sandbox
~~~~~~~~~~~

.. hidden-code-block:: none

   # sqid proxy is open for all ip’s!!
   cat /etc/squid3/squid.conf
   acl localnet src 0.0.0.0/0     # RFC1918 possible internal network
   acl SSL_ports port 443
   acl SSL_ports port 83           # cso nsd
   acl SSL_ports port 8143         # contrail ui
   .
   .
   .
   
   
   cat <<EOF > user-data
   #cloud-config
   apt_update: true
   disable_root: false
   manage_etc_hosts: false
   chpasswd:
     list: |
       root:juniper123
       ubuntu:ubuntu
     expire: False
   ssh_pwauth: True
   final_message: "The system is finally up, after $UPTIME seconds"
   fqdn: lab-gw.example.net
   groups:
     - cloud-users
   users:
     - default
   runcmd:
     - sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
     - mount /dev/vdb /mnt
     - cp /mnt/vlan_1.9-3ubuntu10.1_amd64.deb /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - dpkg -i /root/vlan_1.9-3ubuntu10.1_amd64.deb
     - sed -i '/net.ipv4.ip_forward/s/^#//g' /etc/sysctl.conf
     - sysctl -p /etc/sysctl.conf
     - touch /etc/cloud/cloud-init.disabled
     - service ssh restart
     - ufw enable; ufw allow ssh
     - iptables -F
     - iptables -X
     - iptables -t nat -F
     - iptables -t nat -X
     - iptables -t mangle -F
     - iptables -t mangle -X
     - iptables -t raw -F
     - iptables -t raw -X
     - iptables -P INPUT ACCEPT
     - iptables -P FORWARD ACCEPT
     - iptables -P OUTPUT ACCEPT
     - iptables -t nat -A POSTROUTING -o eth1.42 -j MASQUERADE
     - iptables -A FORWARD -i eth1.42 -o eth2 -m state --state RELATED,ESTABLISHED -j ACCEPT
     - iptables -A FORWARD -i eth2 -o eth1.42 -j ACCEPT
     - iptables -A FORWARD -i eth1.42 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT
     - iptables -A FORWARD -i eth3 -o eth1.42 -j ACCEPT
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 22        -j DNAT -d 100.123.192.10 --to-destination 192.168.10.10
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp                   -j DNAT -d 100.123.192.26 --to-destination 192.168.170.2
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp                   -j DNAT -d 100.123.192.22 --to-destination 192.168.190.254
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp                   -j DNAT -d 100.123.192.23 --to-destination 192.168.200.254
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 3128      -j DNAT -d 100.123.192.10 --to-destination 192.168.10.10
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 443       -j DNAT -d 100.123.192.10 --to-destination 192.168.10.42
     - iptables -t nat -A PREROUTING -i eth1.42 -p tcp --dport 5900:5999 -j DNAT -d 100.123.192.10 --to-destination 192.168.10.10
     - iptables-save > /etc/network/iptables.rules
     - |
       cloud-init-per instance set_network_interface
   
       echo 'auto lo
       iface lo inet loopback
   
       auto eth1
       iface eth1 inet manual
   
       auto eth1.42
       iface eth1.42 inet static
       vlan_raw_device eth1
       address 100.123.192.10
       netmask 255.255.0.0
       gateway 100.123.0.1
       pre-up iptables-restore < /etc/network/iptables.rules
   
       auto eth2
       iface eth2 inet static
       address 192.168.10.1
       netmask 255.255.255.0
       up route add -net 192.168.68.0  netmask 255.255.255.0 gw 192.168.10.15
       up route add -net 192.168.69.0  netmask 255.255.255.0 gw 192.168.10.70
   
       auto eth3
       iface eth3 inet manual
   
       auto eth3.70
       iface eth3.70 inet static
       vlan_raw_device eth3
       address 192.168.70.1
       netmask 255.255.255.0
       up route add -net 192.168.128.0 netmask 255.255.128.0 gw 192.168.70.254
       up route add -net 10.88.88.0    netmask 255.255.255.0 gw 192.168.70.254
       up route add -net 10.66.66.0    netmask 255.255.255.0 gw 192.168.70.254
       up route add -net 172.16.0.0    netmask 255.240.0.0   gw 192.168.70.254
   
       auto eth3.74
       iface eth3.74 inet static
       vlan_raw_device eth3
       address 192.168.74.1
       netmask 255.255.255.0
       up route add -net 10.77.77.0    netmask 255.255.255.0 gw 192.168.74.254
   
       auto eth3.75
       iface eth3.75 inet static
       vlan_raw_device eth3
       address 192.168.75.1
       netmask 255.255.255.0
       up route add -net 10.99.99.0    netmask 255.255.255.0 gw 192.168.75.254
       up route add -net 192.168.66.0  netmask 255.255.255.0 gw 192.168.75.254
       up route add -net 192.168.67.0  netmask 255.255.255.0 gw 192.168.75.254
   
       auto eth3.76
       iface eth3.76 inet static
       vlan_raw_device eth3
       address 192.168.76.1
       netmask 255.255.255.0
       up route add -net 192.168.65.0 netmask 255.255.255.0 gw 192.168.75.254
   
   
       ' > /etc/network/interfaces
   
     - cp /etc/network/interfaces /etc/network/interfaces.default
     - sed -i '/By default this script does nothing/a ifconfig eth1:1.42 100.123.192.22/16' /etc/rc.local
     - sed -i '/By default this script does nothing/a ifconfig eth1:2.42 100.123.192.23/16' /etc/rc.local
     - sed -i '/By default this script does nothing/a ifconfig eth1:3.42 100.123.192.26/16' /etc/rc.local  - |
       cloud-init-per instance setup_etc_host echo '127.0.1.1 lab-gw.example.net lab-gw' >> /etc/hosts
   power_state:
     mode: reboot
     delay: "now"
     timeout: 120
   EOF
   
   [[[[[[[[[[[[[[[[[[[[[[HeplerVM]]]]]]]]]]]]]]]]]]]]]]
   
   cat <<EOF >/etc/ansible/hosts
   [all:children]
   linux
   juniper
   
   [linux:children]
   _HelperVM
   
   [_HelperVM:children]
   HelperVM
   
   [HelperVM]
   HelperVM-0041  VMName=HelperVM-0041
   
   [juniper:children]
   _ResNAT
   _PodSwitch
   _Devices
   
   [_ResNAT:children]
   ResNAT
   
   [ResNAT]
   ResNAT-010 junos_host=100.123.0.7 mgmt_sub_gw=100.123.0.1 mgmt_sub_mask=16 aliase=ResNAT
   
   [_PodSwitch:children]
   EIRDP-P01-QFX5100
   
   [EIRDP-P01-QFX5100]
   EIRDP-P01-QFX5100-01 junos_host=100.123.192.6 mgmt_sub_gw=100.123.0.1 mgmt_sub_mask=16 aliase=EIRDP-P01-QFX5100  User=jcluser
   
   [_Devices:children]
   SRX345-1
   SRX4100-1
   
   [SRX345-1]
   SRX345-1 junos_host=100.123.192.26 mgmt_sub_gw=100.123.0.1 mgmt_sub_mask=16 aliase=SRX345-1 User=jcluser
   
   [SRX4100-1]
   SRX4100-1 junos_host=100.123.192.22 mgmt_sub_gw=100.123.0.1 mgmt_sub_mask=16 aliase=SRX4100-1 User=jcluser
   
   EOF
   
   cat <<EOF >/etc/ansible/group_vars/juniper/credentials.yaml
   junos_passwd: Juniper!1
   junos_username: jcluser
   EOF
   
   cd /root/JCL_Ansible_Playbooks
   ansible-playbook get-config-from-device.yml
   
   
   
   
   
   version 17.3R2.10;
   groups {
       sdwan-basic {
           interfaces {
               ge-0/0/22 {
                   unit 0 {
                       family inet {
                           address 192.168.130.1/24;
                       }
                   }
               }
               ge-0/0/32 {
                   unit 0 {
                       family inet {
                           address 192.168.170.1/24;
                       }
                   }
               }
               irb {
                   unit 131 {
                       family inet {
                           address 192.168.131.1/24;
                       }
                   }
                   unit 134 {
                       family inet {
                           address 192.168.134.1/24;
                       }
                   }
                   unit 132 {
                       family inet {
                           address 192.168.132.1/24;
                       }
                   }
                   unit 135 {
                       family inet {
                           address 192.168.135.1/24;
                       }
                   }
                   unit 70 {
                       family inet {
                           address 192.168.70.254/24;
                       }
                   }
               }
               ge-0/0/23 {
                   unit 0 {
                       family inet {
                           address 192.168.133.1/24;
                       }
                   }
               }
               ge-0/0/33 {
                   unit 0 {
                       family inet {
                           address 192.168.173.1/24;
                       }
                   }
               }
               ge-0/0/37 {
                   unit 0 {
                       family inet {
                           address 192.168.190.1/24;
                       }
                   }
               }
               ge-0/0/38 {
                   unit 0 {
                       family inet {
                           address 192.168.191.1/24;
                       }
                   }
               }
               xe-0/0/2 {
                   unit 0 {
                       family ethernet-switching {
                           vlan {
                               members [ 70 131-132 134-135 172 1066 1088 ];
                           }
                       }
                   }
               }
               ge-0/0/36 {
                   unit 0 {
                       family ethernet-switching {
                           interface-mode trunk;
                           vlan {
                               members 1088;
                           }
                       }
                   }
               }
               ge-0/0/18 {
                   unit 0 {
                       family ethernet-switching {
                           interface-mode trunk;
                           vlan {
                               members 1066;
                           }
                       }
                   }
               }
               ge-0/0/0 {
                   unit 0 {
                       family ethernet-switching {
                           vlan {
                               members 172;
                           }
                       }
                   }
               }
               xe-0/0/41 {
                   unit 0 {
                       family inet;
                   }
               }
               ge-0/0/41 {
                   unit 0 {
                       family inet {
                           address 192.168.194.1/24;
                       }
                   }
               }
           }
           policy-options {
               policy-statement directandstatic1 {
                   term a {
                       from instance internetaccess;
                       then accept;
                   }
                   term b {
                       then reject;
                   }
               }
               policy-statement export-cso {
                   term cso-net {
                       from {
                           route-filter 192.168.10.0/24 exact;
                       }
                       then accept;
                   }
               }
               policy-statement directandstatic2 {
                   term c {
                       from instance hub-wan0;
                       then accept;
                   }
                   term d {
                       from instance hub-wan1;
                       then accept;
                   }
                   term e {
                       from instance secure-oam;
                       then accept;
                   }
                   term f {
                       then reject;
                   }
               }
           }
           routing-instances {
               spoke-wan0 {
                   instance-type virtual-router;
                   system {
                       services {
                           dhcp-local-server {
                               group spoke-wan0 {
                                   interface ge-0/0/22.0;
                                   interface ge-0/0/32.0;
                               }
                           }
                       }
                   }
                   access {
                       address-assignment {
                           pool spoke-wan0-nfx-pool {
                               family inet {
                                   network 192.168.130.0/24;
                                   range spoke-wan0-nfx-pool-range {
                                       low 192.168.130.100;
                                       high 192.168.130.199;
                                   }
                                   dhcp-attributes {
                                       domain-name example.net;
                                       name-server {
                                           192.168.10.10;
                                       }
                                       router {
                                           192.168.130.1;
                                       }
                                   }
                               }
                           }
                           pool spoke-wan0-srx-pool {
                               family inet {
                                   network 192.168.170.0/24;
                                   range spoke-wan0-srx-pool-range {
                                       low 192.168.170.100;
                                       high 192.168.170.199;
                                   }
                                   dhcp-attributes {
                                       domain-name example.net;
                                       name-server {
                                           192.168.10.10;
                                       }
                                       router {
                                           192.168.170.1;
                                       }
                                   }
                               }
                           }
                       }
                   }
                   interface ge-0/0/22.0;
                   interface ge-0/0/32.0;
                   interface irb.131;
                   routing-options {
                       static {
                           route 0.0.0.0/0 next-hop 192.168.131.254;
                       }
                   }
               }
               spoke-wan1 {
                   instance-type virtual-router;
                   system {
                       services {
                           dhcp-local-server {
                               group spoke-wan1 {
                                   interface ge-0/0/23.0;
                                   interface ge-0/0/33.0;
                               }
                           }
                       }
                   }
                   access {
                       address-assignment {
                           pool spoke-wan1-nfx-pool {
                               family inet {
                                   network 192.168.133.0/24;
                                   range spoke-wan1-nfx-pool-range {
                                       low 192.168.133.100;
                                       high 192.168.133.199;
                                   }
                                   dhcp-attributes {
                                       domain-name example.net;
                                       name-server {
                                           192.168.10.10;
                                       }
                                       router {
                                           192.168.133.1;
                                       }
                                   }
                               }
                           }
                           pool spoke-wan1-srx-pool {
                               family inet {
                                   network 192.168.173.0/24;
                                   range spoke-wan1-srx-pool-range {
                                       low 192.168.173.100;
                                       high 192.168.173.199;
                                   }
                                   dhcp-attributes {
                                       domain-name example.net;
                                       name-server {
                                           192.168.10.10;
                                       }
                                       router {
                                           192.168.173.1;
                                       }
                                   }
                               }
                           }
                       }
                   }
                   interface ge-0/0/23.0;
                   interface ge-0/0/33.0;
                   interface irb.134;
                   routing-options {
                       static {
                           route 0.0.0.0/0 next-hop 192.168.134.254;
                       }
                   }
               }
               hub-wan0 {
                   instance-type virtual-router;
                   interface ge-0/0/37.0;
                   interface irb.132;
                   routing-options {
                       static {
                           route 192.168.130.0/24 next-hop 192.168.132.254;
                           route 192.168.170.0/24 next-hop 192.168.132.254;
                       }
                       instance-import directandstatic1;
                   }
               }
               hub-wan1 {
                   instance-type virtual-router;
                   interface ge-0/0/38.0;
                   interface irb.135;
                   routing-options {
                       static {
                           route 192.168.133.0/24 next-hop 192.168.135.254;
                           route 192.168.173.0/24 next-hop 192.168.135.254;
                           route 10.88.88.0/24 next-hop 192.168.191.254;
                           route 10.66.66.0/24 next-hop 192.168.191.254;
                       }
                       instance-import directandstatic1;
                   }
               }
               internetaccess {
                   instance-type virtual-router;
                   interface irb.70;
                   routing-options {
                       static {
                           route 0.0.0.0/0 next-hop 192.168.70.1;
                       }
                       instance-import directandstatic2;
                   }
               }
               secure-oam {
                   instance-type virtual-router;
                   interface ge-0/0/41.0;
                   routing-options {
                       static {
                           route 192.168.10.0/24 next-hop 192.168.70.1;
                       }
                       autonomous-system 65000;
                       instance-import directandstatic1;
                   }
                   protocols {
                       bgp {
                           group ebgp {
                               type external;
                               export export-cso;
                               peer-as 64512;
                               neighbor 192.168.194.254;
                           }
                       }
                   }
               }
           }
           vlans {
               vlan131 {
                   vlan-id 131;
                   l3-interface irb.131;
               }
               vlan134 {
                   vlan-id 134;
                   l3-interface irb.134;
               }
               vlan132 {
                   vlan-id 132;
                   l3-interface irb.132;
               }
               vlan135 {
                   vlan-id 135;
                   l3-interface irb.135;
               }
               desktop2 {
                   vlan-id 1088;
               }
               desktop4 {
                   vlan-id 1066;
               }
               natuplink {
                   vlan-id 70;
                   l3-interface irb.70;
               }
               internet-uplink {
                   vlan-id 172;
               }
           }
       }
   }
   apply-groups sdwan-basic;
   system {
       host-name EIRDP-P01-QFX5100-01;
       root-authentication {
           encrypted-password "$6$Q3a4oW2n$0eES6Pfz0Z4nuID3ccu0G9KkUtCoi18ZGMffsgnQLMsB.Hl1QgV/HaSJdTxqpJ9g9gEOd2qOWwwvHgFlUHvPb/"; ## SECRET-DATA
       }
       login {
           user aebling {
               uid 2000;
               class super-user;
               authentication {
                   encrypted-password "$1$kpS9Of7N$x0U5BazdM44OYaCIK75CK0"; ## SECRET-DATA
               }
           }
           user jcluser {
               uid 2001;
               class super-user;
               authentication {
                   encrypted-password "$1$vSNmHCvl$7hJCtJ9tTp.5nMnwwEAPV/"; ## SECRET-DATA
               }
           }
       }
       services {
           ssh {
               root-login allow;
           }
           netconf {
               ssh;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any notice;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       extensions {
           providers {
               juniper {
                   license-type juniper deployment-scope commercial;
               }
               chef {
                   license-type juniper deployment-scope commercial;
               }
           }
       }
       processes {
           dhcp-service {
               traceoptions {
                   file dhcp_logfile size 10m;
                   level all;
                   flag all;
               }
           }
           app-engine-virtual-machine-management-service {
               traceoptions {
                   level notice;
                   flag all;
               }
           }
       }
   }
   interfaces {
       xe-0/0/0 {
           unit 0 {
               family ethernet-switching {
                   interface-mode access;
                   vlan {
                       members 42;
                   }
               }
           }
       }
       xe-0/0/2 {
           native-vlan-id 1;
           unit 0 {
               family ethernet-switching {
                   interface-mode trunk;
                   vlan {
                       members [ 1 42 ];
                   }
                   storm-control default;
               }
           }
       }
       ge-0/0/3 {
           unit 0 {
               family ethernet-switching {
                   vlan {
                       members default;
                   }
               }
           }
       }
       ge-0/0/4 {
           unit 0 {
               family ethernet-switching {
                   vlan {
                       members default;
                   }
               }
           }
       }
       ge-0/0/5 {
           unit 0 {
               family ethernet-switching {
                   vlan {
                       members default;
                   }
               }
           }
       }
       ge-0/0/6 {
           unit 0 {
               family ethernet-switching {
                   vlan {
                       members default;
                   }
               }
           }
       }
       ge-0/0/7 {
           unit 0 {
               family ethernet-switching {
                   vlan {
                       members default;
                   }
               }
           }
       }
       ge-0/0/8 {
           unit 0 {
               family ethernet-switching {
                   vlan {
                       members default;
                   }
               }
           }
       }
       ge-0/0/10 {
           unit 0 {
               family ethernet-switching {
                   interface-mode access;
                   vlan {
                       members 42;
                   }
               }
           }
       }
       xe-0/0/10 {
           unit 0 {
               family ethernet-switching {
                   vlan {
                       members default;
                   }
               }
           }
       }
       ge-0/0/19 {
           disable;
       }
       ge-0/0/20 {
           disable;
       }
       ge-0/0/21 {
           disable;
       }
       ge-0/0/24 {
           disable;
       }
       ge-0/0/25 {
           disable;
       }
       ge-0/0/34 {
           disable;
       }
       ge-0/0/35 {
           disable;
       }
       ge-0/0/39 {
           disable;
       }
       ge-0/0/40 {
           disable;
       }
       ge-0/0/92 {
           unit 0 {
               family ethernet-switching {
                   interface-mode access;
                   vlan {
                       members 42;
                   }
               }
           }
       }
       ge-0/0/93 {
           unit 0 {
               family ethernet-switching {
                   interface-mode access;
                   vlan {
                       members 42;
                   }
               }
           }
       }
       ge-0/0/94 {
           unit 0 {
               family ethernet-switching {
                   vlan {
                       members lab-access;
                   }
               }
           }
       }
       irb {
           unit 0 {
               family inet {
                   address 192.168.10.20/24;
               }
           }
           unit 42 {
               family inet {
                   address 100.123.192.6/16;
               }
           }
       }
   }
   forwarding-options {
       storm-control-profiles default {
           all;
       }
   }
   routing-options {
       static {
           route 0.0.0.0/0 next-hop 100.123.0.1;
       }
   }
   protocols {
       lldp {
           interface all;
       }
       lldp-med {
           interface all;
       }
       igmp-snooping {
           vlan default;
       }
       rstp {
           interface xe-0/0/0;
           interface ge-0/0/94;
       }
   }
   vlans {
       default {
           vlan-id 1;
           l3-interface irb.0;
       }
       lab-access {
           vlan-id 42;
           l3-interface irb.42;
       }
   }
   
   
   [root@HelperVM-0041 config_from_devices]# cat SRX345-1.conf
   
   ## Last commit: 2018-07-20 10:51:02 UTC by root
   version 15.1X49-D143.1;
   groups {
       global {
           security {
               forwarding-options {
                   family {
                       mpls {
                           mode flow-based;
                       }
                   }
               }
           }
       }
   }
   apply-groups global;
   system {
       host-name srx345-1;
       root-authentication {
           encrypted-password "$5$ypsGaLWV$RDbX4M42qY5CAmYUgp/lkfFw2veoYfjJYTpi0c6eFn8";
       }
       name-server {
           192.168.10.10;
       }
       login {
           user jcluser {
               uid 2001;
               class super-user;
               authentication {
                   encrypted-password "$1$vSNmHCvl$7hJCtJ9tTp.5nMnwwEAPV/";
               }
           }
       }
       services {
           ftp;
           rlogin;
           ssh {
               root-login allow;
           }
           telnet;
           netconf {
               ssh;
               rfc-compliant;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any any;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
       phone-home {
           server https://centralmsvm.example.net;
           ca-certificate-file /var/tmp/ssl_cert.crt;
           rfc-complaint;
       }
   }
   security {
       log {
           utc-timestamp;
           mode stream;
           format sd-syslog;
           source-address 192.168.0.1;
           transport {
               protocol tcp;
           }
       }
       flow {
           allow-dns-reply;
           allow-embedded-icmp;
           inactive: tcp-mss {
               ipsec-vpn {
                   mss 1350;
               }
           }
           tcp-session {
               no-syn-check;
               no-syn-check-in-tunnel;
               no-sequence-check;
           }
       }
       nat {
           source {
               rule-set own-mgmt-traffic-nat {
                   from routing-instance default;
                   to interface ge-0/0/0.0;
                   rule r1 {
                       match {
                           source-address 0.0.0.0/0;
                       }
                       then {
                           source-nat {
                               interface;
                           }
                       }
                   }
               }
               rule-set syslognat {
                   from routing-instance default;
                   to zone untrust;
                   rule syslognatr1 {
                       match {
                           source-address 192.168.0.1/32;
                           destination-address 0.0.0.0/0;
                       }
                       then {
                           source-nat {
                               interface;
                           }
                       }
                   }
               }
           }
       }
       policies {
           from-zone trust to-zone untrust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone trust to-zone trust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone trust {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
           }
           security-zone oam {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   lo0.0;
               }
           }
           security-zone untrust {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/0.0;
               }
           }
       }
   }
   interfaces {
       ge-0/0/0 {
           unit 0 {
               family inet {
                   address 192.168.170.2/24;
               }
           }
       }
       lo0 {
           description "Loopback Interface";
           unit 0 {
               family inet {
                   address 192.168.0.1/24;
               }
           }
       }
       st0 {
           per-unit-scheduler;
       }
   }
   routing-options {
       static {
           route 0.0.0.0/0 {
               next-hop 192.168.170.1;
               no-readvertise;
           }
           route 100.123.0.0/16 next-hop 192.168.170.1;
       }
   }
   
   
   
   
   ## Last commit: 2018-07-20 20:44:23 UTC by root
   version 15.1X49-D143.1;
   system {
       host-name srx4100-1;
       root-authentication {
           encrypted-password "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81";
       }
       login {
           user jcluser {
               uid 2001;
               class super-user;
               authentication {
                   encrypted-password "$1$vSNmHCvl$7hJCtJ9tTp.5nMnwwEAPV/";
               }
           }
       }
       services {
           ftp;
           rlogin;
           ssh {
               root-login allow;
           }
           telnet;
           netconf {
               ssh;
               rfc-compliant;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any any;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
   }
   security {
       policies {
           from-zone trust to-zone untrust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone trust to-zone trust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone trust {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
           }
           security-zone untrust {
               host-inbound-traffic {
                   system-services {
                       ssh;
                       ping;
                       netconf;
                       http;
                       https;
                       dhcp;
                       ike;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   xe-0/0/0.0;
               }
           }
       }
   }
   interfaces {
       xe-0/0/0 {
           unit 0 {
               family inet {
                   address 192.168.190.254/24;
               }
           }
       }
   }
   routing-options {
       static {
           route 192.168.10.0/24 {
               next-hop 192.168.190.1;
               no-readvertise;
           }
           route 100.123.0.0/16 next-hop 192.168.190.1;
       }
   }
   
   
   
   

UNDER DEVELOPMENT / NOT STABLE / USE AT OWN RISK
================================================

Patch to fix CXU-26429
----------------------

This patch is not working. We are waiting for a new patch from engineering to test it.

.. code-block:: none

   # we need the json query package if you don’t have it already
   apt-get install -y jq

   # we need an authorisation token with the keystone password
   RAW_TOKEN=`curl -d '{"auth":{"tenantName":"admin", "passwordCredentials":{"username":"admin", "password":"5DQkO6ME2Y87"}}}' -H "Content-type: application/json" http://192.168.10.42:5000/v2.0/tokens`
   TOKEN=`echo $RAW_TOKEN | python -c "import sys; import json; tok = json.loads(sys.stdin.read()); print tok['access']['token']['id'];"`
   echo $TOKEN

   # find the uuid where the fq_name contains srx-gwr-rpm-config
   CONFIGID=`curl -k -X GET https://192.168.10.42/ems-central/template -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq -r '.template[] | select(.fq_name[] | contains("srx-gwr-rpm-config")) | .uuid'`
   echo $CONFIGID

   # get the whole template but stip the key config_as_text from it
   CONFIGJSON=`curl -k -X GET https://192.168.10.42/ems-central/template/$CONFIGID -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq -r 'del(.template.config_in_text)'`
   echo $CONFIGJSON

   # create a file with the patch via cut and paste
   cat <<EOF >patch-CXU-26429.uue
   eyUtIGlmIGRpZmZfY29uZmlnLnByb2JlX2luZm8gaXMgZGVmaW5lZCBhbmQgZGlmZl9jb25maWcu
   cHJvYmVfaW5mbyAlfVxueyMtIGNsZWFuIHVwIHRoZSBjb25maWcgZ3JvdXAgYW5kIGFsbCB0aGUg
   cHJvYmVzICN9XG57JS0gaWYgcHJlX2NvbmZpZy5wcm9iZV9pbmZvIGlzIGRlZmluZWQgYW5kIHBy
   ZV9jb25maWcucHJvYmVfaW5mb3xjb3VudCA+IDAgJX1cbnslIHNldCBkZXZpY2UgPSAncnBtLWNm
   Zy0nICsgcHJlX2NvbmZpZy5wcm9iZV9pbmZvWzBdLmRldmljZSAlfVxuZGVsZXRlIGFwcGx5LWdy
   b3VwcyB7e2RldmljZX19XG5kZWxldGUgZ3JvdXBzIHt7ZGV2aWNlfX1cbnslLSBlbmRpZiAlfVxu
   eyUtIGVuZGlmICV9XG57JS0gaWYgcG9zdF9jb25maWd8bGVuZ3RoID4gMCAlfVxueyMtIENyZWF0
   ZSBSUE0gcHJvYmVzIGFuZCBjcmVhdGUgaW5kaXZpZHVhbCB0ZXN0cyBmb3IgZWFjaCBwcm9iZSB0
   eXBlKGVnOiBpY21wLXBpbmcpIGFuZCB0aGUgQ29TIChlZzogQUYsQkUgZXRjLikgI31cbiAgICB7
   JS0gZm9yIHByb2JlIGluIHBvc3RfY29uZmlnLnByb2JlX2luZm8gJX1cbiAgICAgIHslLSBmb3Ig
   cHR5cGUgaW4gcHJvYmUucHJvYmVfdHlwZSAlfVxueyUgc2V0IGRldmljZSA9ICdycG0tY2ZnLScg
   KyBwcm9iZS5kZXZpY2UgJX1cbnNldCBncm91cHMge3tkZXZpY2V9fSBzZXJ2aWNlcyBycG0gcHJv
   YmUge3twcm9iZS5wcm9iZV9uYW1lfX0gdGVzdCB0ZXN0LXt7cHR5cGV9fSBwcm9iZS10eXBlIHt7
   cHR5cGV9fVxuc2V0IGdyb3VwcyB7e2RldmljZX19IHNlcnZpY2VzIHJwbSBwcm9iZSB7e3Byb2Jl
   LnByb2JlX25hbWV9fSB0ZXN0IHRlc3Qte3twdHlwZX19IHNvdXJjZS1hZGRyZXNzIHt7cHJvYmUu
   c291cmNlfX1cbnslLSBpZiBwdHlwZSA9PSAnaHR0cC1nZXQnICV9XG5zZXQgZ3JvdXBzIHt7ZGV2
   aWNlfX0gc2VydmljZXMgcnBtIHByb2JlIHt7cHJvYmUucHJvYmVfbmFtZX19IHRlc3QgdGVzdC17
   e3B0eXBlfX0gdGFyZ2V0IHVybCB7e3Byb2JlLmRlc3RpbmF0aW9ufX1cbnslLSBlbHNlICV9XG5z
   ZXQgZ3JvdXBzIHt7ZGV2aWNlfX0gc2VydmljZXMgcnBtIHByb2JlIHt7cHJvYmUucHJvYmVfbmFt
   ZX19IHRlc3QgdGVzdC17e3B0eXBlfX0gdGFyZ2V0IGFkZHJlc3Mge3twcm9iZS5kZXN0aW5hdGlv
   bn19XG57JS0gZW5kaWYgJX1cbnNldCBncm91cHMge3tkZXZpY2V9fSBzZXJ2aWNlcyBycG0gcHJv
   YmUge3twcm9iZS5wcm9iZV9uYW1lfX0gdGVzdCB0ZXN0LXt7cHR5cGV9fSBwcm9iZS1jb3VudCB7
   e3Byb2JlLmNvdW50fX1cbnNldCBncm91cHMge3tkZXZpY2V9fSBzZXJ2aWNlcyBycG0gcHJvYmUg
   e3twcm9iZS5wcm9iZV9uYW1lfX0gdGVzdCB0ZXN0LXt7cHR5cGV9fSBwcm9iZS1pbnRlcnZhbCB7
   e3Byb2JlLmludGVydmFsfX1cbnNldCBncm91cHMge3tkZXZpY2V9fSBzZXJ2aWNlcyBycG0gcHJv
   YmUge3twcm9iZS5wcm9iZV9uYW1lfX0gdGVzdCB0ZXN0LXt7cHR5cGV9fSB0ZXN0LWludGVydmFs
   IHt7cHJvYmUudGVzdGludGVydmFsfX1cbnNldCBncm91cHMge3tkZXZpY2V9fSBzZXJ2aWNlcyBy
   cG0gcHJvYmUge3twcm9iZS5wcm9iZV9uYW1lfX0gdGVzdCB0ZXN0LXt7cHR5cGV9fSBkZXN0aW5h
   dGlvbi1pbnRlcmZhY2Uge3twcm9iZS5saW5rfX1cbnNldCBncm91cHMge3tkZXZpY2V9fSBzZXJ2
   aWNlcyBycG0gcHJvYmUge3twcm9iZS5wcm9iZV9uYW1lfX0gdGVzdCB0ZXN0LXt7cHR5cGV9fSBy
   b3V0aW5nLWluc3RhbmNlIHRyYW5zaXRcbiAgICAgIHslLSBlbmRmb3IgJX1cbiAgICB7JS0gZW5k
   Zm9yICV9XG57JS0gaWYgcG9zdF9jb25maWcucHJvYmVfaW5mbyAgJX1cbnslIHNldCBkZXZpY2Ug
   PSAncnBtLWNmZy0nICsgcG9zdF9jb25maWcucHJvYmVfaW5mb1swXS5kZXZpY2UgJX1cbnNldCBh
   cHBseS1ncm91cHMge3tkZXZpY2V9fVxueyUtIGVuZGlmICV9XG57JS0gZW5kaWYgJX1cbg==
   EOF

   # create final patch from base64
   base64 -d patch-CXU-26429.uue >patch-CXU-26429.txt
   
   # review if patch has expected size
   ls -l patch-CXU-26429.txt
   -rw-r--r-- 1 root root 1933 Sep  5 08:09 patch-CXU-26429.txt

   # feed patch-content into local variable
   PATCH=`cat patch-CXU-26429.txt`
   echo $PATCH
   
   # add patch via new key to json and create upload file
   echo $CONFIGJSON | jq --arg key1 config_in_text --arg value1 "$PATCH" '.template[$key1] = $value1' > patch.json
   cat patch.json

   # apply changed json
   curl -v -k -X PUT -D headers -H "content-type:application/json" -H "X-Auth-Token:$TOKEN" https://192.168.10.42/ems-central/template/$CONFIGID -d@patch.json

   # review if your changes have been included
   curl -k -X GET https://192.168.10.42/ems-central/template/$CONFIGID -H "Accept: application/json" -H "X-Auth-Token:$TOKEN" | jq .

vSRX as Hub3
------------

If you can, **do not launch the vSRX on the CSO-Host itself**!!!

On the CSO-Host you have to use Ubuntu 14.04.5 which might cause you known issues (like the VM may stuck and only a complete reboot of the entire Server can bring it back to work) with vSRX v15*. It is safer to use a Host which has Ubuntu 16.04.x as Host Operating system. You’ve been warned.

The vSRX will be placed into the same subnet range as the Hub1 with Hardware SRX.

Therefor instead on interfaces with direct IP’s at the Underlay switch we turn these interfaces into VLANs and as L3 IRB’s. The Hub1 side doesn’t need to change for this.

The three subnets/vlan are then extended to the CSO-Hub as trunked interfaces thus when you launch the vSRX there these interfaces need to be defined as tagged again.

The interface xe-0/0/48:0 might change to xe-0/0/2 into your environment (or another one for a separate host for this VM as suggested).

|image911|

Changes to include a virtual SRX as addition or replacement to Hub1

.. code-block:: none

   delete groups sdwan-basic interfaces xe-0/0/37 unit 0 family inet address 192.168.190.1/24
   delete groups sdwan-basic routing-instances hub-wan0 interface xe-0/0/37.0
   set groups sdwan-basic interfaces irb unit 190 family inet address 192.168.190.1/24
   set groups sdwan-basic vlans vlan190 vlan-id 190
   set groups sdwan-basic vlans vlan190 l3-interface irb.190
   set groups sdwan-basic routing-instances hub-wan0 interface irb.190
   delete interfaces xe-0/0/37
   delete groups sdwan-basic interfaces xe-0/0/37
   set groups sdwan-basic interfaces xe-0/0/37 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-basic interfaces xe-0/0/37 unit 0 family ethernet-switching vlan members 190
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 190
   
   delete groups sdwan-basic interfaces xe-0/0/38 unit 0 family inet address 192.168.191.1/24
   delete groups sdwan-basic routing-instances hub-wan1 interface xe-0/0/38.0
   set groups sdwan-basic interfaces irb unit 191 family inet address 192.168.191.1/24
   set groups sdwan-basic vlans vlan191 vlan-id 191
   set groups sdwan-basic vlans vlan191 l3-interface irb.191
   set groups sdwan-basic routing-instances hub-wan1 interface irb.191
   delete interfaces xe-0/0/38
   delete groups sdwan-basic interfaces xe-0/0/38
   set groups sdwan-basic interfaces xe-0/0/38 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-basic interfaces xe-0/0/38 unit 0 family ethernet-switching vlan members 191
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 191
   
   delete groups sdwan-basic interfaces xe-0/0/41 unit 0 family inet address 192.168.194.1/24
   delete groups sdwan-basic routing-instances secure-oam interface xe-0/0/41.0
   set groups sdwan-basic interfaces irb unit 194 family inet address 192.168.194.1/24
   set groups sdwan-basic vlans vlan194 vlan-id 194
   set groups sdwan-basic vlans vlan194 l3-interface irb.194
   set groups sdwan-basic routing-instances secure-oam interface irb.194
   delete interfaces xe-0/0/41
   delete groups sdwan-basic interfaces xe-0/0/41
   set groups sdwan-basic interfaces xe-0/0/41 unit 0 family ethernet-switching interface-mode access
   set groups sdwan-basic interfaces xe-0/0/41 unit 0 family ethernet-switching vlan members 194
   set groups sdwan-basic interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 194
   set groups sdwan-basic routing-instances secure-oam protocols bgp group ebgp neighbor 192.168.194.253

Use this to initially launch the vSRX into KVM

.. code-block:: none

   virsh destroy vsrxoam1
   virsh undefine vsrxoam1
   cp /root/media-vsrx-vmdisk-15.1X49-D144.1.qcow2 /var/lib/libvirt/images/vsrxoam1.qcow2
   chmod 666 /var/lib/libvirt/images/vsrxoam1.qcow2
   
   rm -f juniper.conf vsrxoam1.iso
   vi juniper.conf

   system {
       host-name vsrxoam1;
       root-authentication {
           encrypted-password "$6$g1.wm$UWjbUq7VJp1KjRPViD9W0xW4NSXGSWlE/f5esQ4xyGep8.nOL4RcPEtRgr/a2zj0dl4Kn9.9CTwViGsRj8Pl81"; ## SECRET-DATA
       }
       services {
           ftp;
           rlogin;
           ssh;
           telnet;
           netconf {
               ssh;
               rfc-compliant;
           }
       }
       syslog {
           user * {
               any emergency;
           }
           file messages {
               any any;
               authorization info;
           }
           file interactive-commands {
               interactive-commands any;
           }
       }
       license {
           autoupdate {
               url https://ae1.juniper.net/junos/key_retrieval;
           }
       }
   }
   security {
       policies {
           from-zone trust to-zone untrust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone trust to-zone trust {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone trust {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
           }
           security-zone untrust {
               host-inbound-traffic {
                   system-services {
                       ssh;
                       ping;
                       netconf;
                       http;
                       https;
                       dhcp;
                       ike;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/0.190;
               }
           }
       }
   }
   interfaces {
       ge-0/0/0 {
           flexible-vlan-tagging;
           unit 190 {
               vlan-id 190;
               family inet {
                   address 192.168.190.253/24;
               }
           }
       }
   }
   routing-options {
       static {
           route 192.168.10.0/24 {
               next-hop 192.168.190.1;
               no-readvertise;
           }
       }
   }

   
   genisoimage -o vsrxoam1.iso -volid cidata -joliet -rock juniper.conf
   chmod 666 vsrxoam1.iso
   
   virt-install -n vsrxoam1 -r 4096 --vcpus=2 --arch=x86_64 \
   --disk path=/var/lib/libvirt/images/vsrxoam1.qcow2,size=16,device=disk,bus=ide,format=qcow2 \
   --import --disk path=/root/vsrxoam1.iso,device=cdrom,bus=ide --os-type linux --hvm \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --network=bridge:virbr0,model=virtio \
   --graphics vnc,listen=0.0.0.0 --noautoconsole
   
   virsh autostart vsrxoam1
   
   virsh console vsrxoam1

   # wait 10minutes until the device is up and running

   root@vsrxoam1> show chassis hardware
   Hardware inventory:
   Item             Version  Part number  Serial number     Description
   Chassis                                A90F380A961D      VSRX
   CB 0
   Routing Engine 0          BUILTIN      BUILTIN           VSRX-S
   FPC 0            REV 07   611-049549   RL3714040884      FPC
     PIC 0                   BUILTIN      BUILTIN           VSRX DPDK GE

You now have the dynamic generated Serialnumber you need to know for the next step in creating a new cloud-hub device.

.. note:: For this device as it’s in the KVM domain we need to also configure the VLAN-Tag for each interface.

|image912|

|image913|

|image914|

|image915|

|image916|

This will bring up a window with the Stage-1 Junos config

|image917|

Copy the ENTIRE configuration from this window and Ssh to vsrx 192.168.190.253(root/Embe1mpls)

.. code-block:: none

   start shell
   #rm /var/tmp/vsrx.stage1
   vi /var/tmp/vsrx.stage1

Paste the Config from CSO in your Editor and save&quit the editor

.. code-block:: none

   exit
   edit
   load override /var/tmp/vsrx.stage1
   #
   # CSO doesn’t set a default route so add this here
   #
   set routing-options static route 0.0.0.0/0 next-hop 192.168.191.1
   set routing-options static route 0.0.0.0/0 no-readvertise
   #
   # Also the following routes help in your environment to ensure the right path is used as we don’t have a routing protocol helping us.
   #
   set routing-options static route 192.168.130.0/24 next-hop 192.168.190.1
   set routing-options static route 192.168.130.0/24 no-readvertise
   set routing-options static route 192.168.133.0/24 next-hop 192.168.191.1
   set routing-options static route 192.168.133.0/24 no-readvertise
   set routing-options static route 192.168.150.0/24 next-hop 192.168.190.1
   set routing-options static route 192.168.150.0/24 no-readvertise
   set routing-options static route 192.168.153.0/24 next-hop 192.168.191.1
   set routing-options static route 192.168.153.0/24 no-readvertise
   set routing-options static route 192.168.170.0/24 next-hop 192.168.190.1
   set routing-options static route 192.168.170.0/24 no-readvertise
   set routing-options static route 192.168.173.0/24 next-hop 192.168.191.1
   set routing-options static route 192.168.173.0/24 no-readvertise
   
   commit and-quit

.. code-block:: none

   root@A90F380A961D.hub3.default-project> ping 192.168.10.42 routing-instance oam-vrf
   PING 192.168.10.42 (192.168.10.42): 56 data bytes
   64 bytes from 192.168.10.42: icmp_seq=0 ttl=62 time=2.267 ms
   64 bytes from 192.168.10.42: icmp_seq=1 ttl=62 time=2.660 ms
   ^C
   --- 192.168.10.42 ping statistics ---
   2 packets transmitted, 2 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 2.267/2.463/2.660/0.197 ms

|image918|

|image919|

|image920|

|image921|

Public IP Forwarder to local Lab
--------------------------------

.. warning:: This is just a Prototype right now!!! Contact us if you intend to use it.

This is a proposal/Feasibility Study for Lab sittuations where you have no Public IP’s that you can assign to a Hub. This would usually void that you can demonstrate that the Client device (SRX3xx, NFXxxx or vSRX in AWS) can be externally, in the Internet, connecting to the Hub. If you can’t directly assing the public to the Hub you always have to tweak CSO in the configuration it applies (like we do in chapter 7.10 above).

This “Hack” only needs your credit card to get a Public IP, hosted by Amazon, redirected in a way that it re-appears at your local Hub.

The estimated costs per month and per redirected public IP, are:

1\* Flavor t2.nano (Frankfurt) $0.0067hour = $4.82 Month

2 \* Elastic IP Address $0.005hour = $ 3.6 Month \* 2 = 7.2 Month

Which is a total of about ~$12.-USD pre Month (excluded the Traffic you cause)

|image922|

|image923|

|image924|

Use Console access to the NXX250 to prepare it for the Lab

.. code-block:: none

   ping vjunos0
   
   ssh vjunos0
   exit
   
   cli
   show configuration version
   # make sure you have upgraded the firmware to the right version
   # for CSO 4.1.0 it is required to use 15.1X53-D492
   edit
   set system host-name nfx250
   set system memory hugepages page-size 1024 page-count 13
   # DISABLE PHC to prevent it to offer DHCP lease on default LAN
   delete system phone-home
   set system root-authentication plain-text-password
   .
   .
   commit and-quit
   exit
   sleep 60
   
   ssh vjunos0
   show configuration
   .
   .
   .
   exit
   exit
   
   cli
   request system reboot
   yes

It is assumed the NFX is wired to local LAN (all Ports will work but we have just used ge-0/0/0) and the Local Router is DHCP Server and Router for the Internet.

Once the NFX250 is booted check on your local router which lease has been given to the device (192.168.1.124 in this case)

.. code-block:: none

   ssh root@192.168.1.124  DHCP (juniper123) F4-CC-55-2B-90-CC

Download Ubuntu Cloud-Image and prepare 3 copies to be used local

.. code-block:: none

   cd /var/third-party/images/
   
   wget http://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.vmdk
   
   # convert the compressed vmdk image to an uncompressed qcow2 image
   qemu-img convert -f vmdk -O qcow2 xenial-server-cloudimg-amd64-disk1.vmdk xenial-server-cloudimg-amd64-disk1.qcow2

   # 
   ls –l
   .
   -rw-r--r-- 1 root root 978255872 Nov 14 16:41 xenial-server-cloudimg-amd64-disk1.qcow2
   -rw-r--r-- 1 root root 283978240 Nov 13 10:54 xenial-server-cloudimg-amd64-disk1.vmdk
   .
   # create 3 working copies that the image can contain stored configuration for next boot
   cp xenial-server-cloudimg-amd64-disk1.qcow2 ubuntu1.qcow2
   cp xenial-server-cloudimg-amd64-disk1.qcow2 ubuntu2.qcow2
   cp xenial-server-cloudimg-amd64-disk1.qcow2 ubuntu3.qcow2
   rm xenial-server-cloudimg-amd64-disk1.vmdk

Create/Launch the first VM for the AWS CLI. We need that to manage the remote instance.

.. code-block:: none

   # create a meta-data file just with the VNF name
   cat <<EOF > meta-data
   local-hostname: ubuntu1
   EOF
   
   cat <<EOF > user-data
   #cloud-config
   password: TaUyaPgqkWMhq6YM
   chpasswd: { expire: False }
   ssh_pwauth: True
   users:
     - name: root
       lock-passwd: false
   chpasswd:
     list: |
       root:juniper123
     expire: False
   
   runcmd:
     - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin yes/' /etc/ssh/sshd_config ; service ssh restart
     - touch /etc/cloud/cloud-init.disabled
     - dhclient ens5
     - sleep 30
     - echo nameserver 8.8.8.8 > /etc/resolv.conf
   EOF
   
   
   genisoimage -output ubuntu1.iso -volid cidata -joliet -rock user-data meta-data
   
   cli
   edit
   set system services enhanced-orchestration
   set host-os vlans default vlan-id 4089
   
   delete virtual-network-functions ubuntu1
   set virtual-network-functions ubuntu1 image /var/third-party/images/ubuntu1.qcow2
   set virtual-network-functions ubuntu1 storage vdb type cdrom source file /var/third-party/images/ubuntu1.iso
   set virtual-network-functions ubuntu1 virtual-cpu count 1
   set virtual-network-functions ubuntu1 memory size 1048576
   set virtual-network-functions ubuntu1 virtual-cpu features hardware-virtualization
   set virtual-network-functions ubuntu1 memory features hugepages
   set virtual-network-functions ubuntu1 interfaces eth4 mapping vlan members default
   set virtual-network-functions ubuntu1 interfaces eth4 mapping vlan mode access
   set virtual-network-functions ubuntu1 interfaces eth4 offloads disable
   commit and-quit
   exit
   
   cat /etc/hosts
   127.0.0.1       localhost
   ::1             localhost ip6-localhost ip6-loopback
   ff02::1         ip6-allnodes
   ff02::2         ip6-allrouters

        hypervisor
   192.0.2.2     vjunos0
   192.0.2.3     vjunos1
   192.168.1.4     vsrx
   192.0.2.254     jdm nfx250
   128.0.0.254     jdm nfx250

   192.0.2.5     ipsec-nm
   192.0.2.100    ubuntu1

Login into first VM and prepare AWS CLI

.. code-block:: none

   ssh root@ubuntu1 (TaUyaPgqkWMhq6YM)

   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.1.1     0.0.0.0         UG    0      0        0 ens5
   192.0.2.0       0.0.0.0         255.255.255.0   U     0      0        0 ens3
   192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 ens5

   ping 8.8.8.8
   PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
   64 bytes from 8.8.8.8: icmp_seq=1 ttl=119 time=18.9 ms
   64 bytes from 8.8.8.8: icmp_seq=2 ttl=119 time=20.1 ms


   apt-get update
   
   apt-get upgrade
   
   apt-get -y install awscli

Use a Browser and generate credentials for the VM in AWS to be used

.. code-block:: none

   https://console.aws.amazon.com/

<your-name> -> My Security Credentials

Click "+ Access Keys (Access Key ID and Secret Access Key)" -> Create New Access Key

Download File with Keys -> open keyfile

Now continue back on the first VM

.. code-block:: none

   aws configure
   AWS Access Key ID [None]: xxxxxxxxxxxxxxxxxLV6RJA
   AWS Secret Access Key [None]: xxxxxxxxxxxxxxxxxxxxx/sAFY
   Default region name [None]: eu-central-1
   Default output format [None]:text
   
   aws ec2 create-security-group --group-name PublicIP-VPNserver --description "openvpnserver for PublicIP-forwarder"
   sg-7277a41f
   
   aws ec2 authorize-security-group-ingress --group-name PublicIP-VPNserver --protocol tcp --port 22 --cidr 0.0.0.0/0
   aws ec2 authorize-security-group-ingress --group-name PublicIP-VPNserver --protocol icmp --port -1 --cidr 0.0.0.0/0
   aws ec2 authorize-security-group-ingress --group-name PublicIP-VPNserver --protocol tcp --port 1194 --cidr 0.0.0.0/0
   aws ec2 authorize-security-group-ingress --group-name PublicIP-VPNserver --protocol udp --port 1194 --cidr 0.0.0.0/0

   # create local key to manage this VM
   aws ec2 create-key-pair --key-name PubIPForward-key --query 'KeyMaterial' --output text > PubIPForward.pem
   chmod 400 PubIPForward.pem
   
   #
   # Be sure to never lose the below key
   #
   cat PubIPForward.pem
   -----BEGIN RSA PRIVATE KEY-----
   MIIEowIBAAKCAQEAuC6puE5bhlCfb1kDkDeaDeAYHBJDvqTlDLoTSnx02OrAwATBk6aGX/9q3T3u
   RPxcfodgSptcwRTLi1+AN8ejWYhs1gmNSA2IKTZ+uHD9y6U2GBn/yjq1aW7H2zWG0P83gPnYlPSf
   HLnu9kBj8FJvT4byKfnJ7I+4skOERZp7B/9v3H8PyZX1D7nvCecVitzDXrcBbpBnqhYw9iJvgMaa
   ZmQfSLJexfwvjT5ywtRDzsK+gIJz88v6DTgrAv38tsWoTAX/rwKALV8twKpQGW2aeNk+aR0S+GnJ
   RxUVz7FWaXw5YeSUPGXSqs0bSFMKwENwc7V/+g6Xk0vk2l9j5VE1cwIDAQABAoIBADVsw6pEgGPr
   ivO/fDsfBb60nAm4epIYPqB8cRAQHcy1+4c3Wfc8PIooCpV2W2EDWskQ96tseXFAWPJql0SW0hks
   xxxxxxxxxxxxxxxxxx
   /5MYl6PcsHnvO98oMY4qzwUOUfkHDJ/pg8ELbxr+m2zQZ73rSLjsekpv3yypdZ+To92uXSFp4gMm
   7xWbl1AcR/OBk7JUSM4ilQKBgAh5MsvL5rvCHtfdROtgL7P+I2+tgS/+JXU0iJ0yKB7zxJkPey2A
   25rMBHHttUuHfCinsmI3UkzjNmGsO1B+f8OLlLysCr72R+v6st9Qz8lxTSJydvPbBZrCJBQomgDC
   8+GXvS6gblNos9gxev7xy+m0dkZEgg92E98sTXOE3MpFAoGBANZYVCUjL4ZPa+E/MV2NT3ZPVbEl
   O2i5K9x/X5I48bsa8FdawlK1tenD1Nfb/QQf1RadYrfNjWJTOHqrB5vHb0j0e2B1VCBm556/+gOA
   sF3NVbdg/F2S7K3522VRz7oKEP2Z7xnFciyjonWQwa+mDXxJ98OjIfHsjduUXoGUE/NI
   -----END RSA PRIVATE KEY-----

   # Note: The image-id will change if you are NOT in the eu-central-1 region
   aws ec2 run-instances --image-id ami-2830f947 --security-group-ids PublicIP-VPNserver --count 1 --instance-type t2.nano --key-name PubIPForward-key --query 'Instances[0].InstanceId'
   i-07bf33c76739cd8e3

   aws ec2 describe-instances --instance-ids i-07bf33c76739cd8e3 --query 'Reservations[0].Instances[0].PublicIpAddress'
   3.121.29.33

   # (optional) access without Eleastic-IP assigned
   ssh -i PubIPForward.pem ubuntu@3.121.29.33
   exit
   
   # get one Public-IP
   aws ec2 allocate-address
   eipalloc-0074c06bafbc912ed      vpc     3.121.168.31

   # assign Public-IP to VM
   aws ec2 associate-address --instance-id i-07bf33c76739cd8e3 --public-ip 3.121.168.31
   eipassoc-0c7e7584d5ccd7cb9

Go to your first forwarder instance in AWS

.. code-block:: none

   # now you have to use the public IP to login
   ssh -i PubIPForward.pem ubuntu@3.121.168.31

   # on the AWS Ubuntu sytem execute
   sudo su
   apt-get update
   apt-get -y upgrade
   apt-get -y install openvpn
   
   cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz /etc/openvpn/
   gunzip /etc/openvpn/server.conf.gz
   
   # save config example
   cp /etc/openvpn/server.conf /etc/openvpn/server.conf.orig

   #egrep -v "^[[:space:]]*#|^$" /etc/openvpn/server.conf

   # generate static key for this Point-to-Point connection
   openvpn --genkey --secret static.key

   # list the static key and grab it for the next VM

   cat static.key
   #
   # 2048 bit OpenVPN static key
   #
   -----BEGIN OpenVPN Static key V1-----
   5f028d740810ccbfc0e871cb2093b161
   cf6194e70c809dcf08f9a3da2b420d7d
   29adeffc69f5720451423d825dde164f
   1d63e3e6707d4eeac9261e47a6811869
   7062d4daed4da11740fc612a55a48cc9
   f4001db2093fcb9c390c1f5420b1bb5b
   e681119e085d4ac0415f1cb71fcdc9db
   816f215620496a70342476eb1aa0be0d
   ca1c019ce2a0009f2074a02945f1699f
   a232a1d190d6c14e9d97379c89494c64
   ccfd7b46679ff41674761e706a090f55
   4f2f6dcf872ef52652f8ec3003fe1ac0
   4cdb868a45bbe20f8181db4a3af38714
   32d2e24245b89fe39d4bcdd1ef4aef2a
   92b5a8414f60ab7bf1cbb3903bf859c1
   0cf00e17862e874b81482110363dd55d
   -----END OpenVPN Static key V1-----
   END

   cp static.key /etc/openvpn/static.key


   # apply your config
   cat <<EOF >/etc/openvpn/server.conf
   port 1194
   proto tcp-server
   dev tun
   secret /etc/openvpn/static.key
   ifconfig 169.254.169.1 169.254.169.2
   keepalive 10 120
   cipher AES-128-CBC   # AES
   comp-lzo
   persist-key
   persist-tun
   status openvpn-status.log
   verb 3
   EOF
   
   service openvpn stop
   # TEST the service start
   openvpn --config /etc/openvpn/server.conf
   
   service openvpn restart
   
   reboot

Back to your AWS CLI VM configure and add the second Elastic IP to forwarder VM

.. code-block:: none

   #
   # find the instance id with the security group
   #
   aws ec2 describe-instances --filters --filters "Name=instance.group-name,Values=PublicIP-VPNserver" --query 'Reservations[0].Instances[0].InstanceId'
   i-07bf33c76739cd8e3

   #
   # get the availabilty zone (needed for the subnet-creation)
   #
   aws ec2 describe-instances --instance-ids i-07bf33c76739cd8e3 --query 'Reservations[0].Instances[0].Placement'
   eu-central-1b           default

   # find the vpc if you don’t know it already
   aws ec2 describe-instances --instance-ids i-07bf33c76739cd8e3 --query 'Reservations[0].Instances[0].VpcId'
   vpc-dfeb32b7

   aws ec2 describe-vpcs --vpc-id vpc-dfeb32b7
   VPCS    172.31.0.0/16   dopt-9417fbfc   default True    available       vpc-dfeb32b7

   # review the subnets aws has made avail in the zone you instance is in
   aws ec2 describe-subnets
   SUBNETS eu-central-1b   4089    172.31.16.0/20  True    True    available       subnet-f591328f vpc-dfeb32b7
   SUBNETS eu-central-1a   4091    172.31.0.0/20   True    True    available       subnet-16108e7e vpc-dfeb32b7
   SUBNETS eu-central-1c   4091    172.31.32.0/20  True    True    available       subnet-16ba835c vpc-dfeb32b7

   # create a subnet with a mask >= /28 that is within the range of AWS default (172.31.16.0/20)
   # here we have use 172.31.64.0/24 but you can use anything else
   aws ec2 create-subnet --vpc-id vpc-dfeb32b7 --cidr-block 172.31.64.0/24 --availability-zone eu-central-1b
   SUBNET  eu-central-1b   251     172.31.64.0/24  pending subnet-497ccd34 vpc-dfeb32b7

   # aws ec2 delete-subnet --subnet-id
   # https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html

   aws ec2 describe-subnets
   SUBNETS eu-central-1b   4089    172.31.16.0/20  True    True    available       subnet-f591328f vpc-dfeb32b7
   SUBNETS eu-central-1b   251     172.31.64.0/24  False   False   available       subnet-497ccd34 vpc-dfeb32b7
   SUBNETS eu-central-1a   4091    172.31.0.0/20   True    True    available       subnet-16108e7e vpc-dfeb32b7
   SUBNETS eu-central-1c   4091    172.31.32.0/20  True    True    available       subnet-16ba835c vpc-dfeb32b7
   
   
   aws ec2 create-security-group --group-name PublicIP-ALL --description "PublicIP-to-be-forwarded" --vpc-id vpc-dfeb32b7
   sg-f90fdd94

   # aws ec2 delete-security-group --group-id 

   # allow ALL Traffic to this interface
   aws ec2 authorize-security-group-ingress --group-id sg-f90fdd94 --protocol -1 --port -1 --cidr 0.0.0.0/0

   # register a new fixed IP in the new subnet (172.31.64.10 in this case)
   # Do NEVER use the 4 first avail IP’s as they are used by AWS itself
   aws ec2 create-network-interface --subnet-id subnet-497ccd34 --description "2ndEIP" --groups sg-f90fdd94 --private-ip-address 172.31.64.10
   NETWORKINTERFACE        eu-central-1b   2ndEIP  06:e3:7a:83:70:52       eni-bd4ba997    493180309922    ip-172-31-64-10.eu-central-1.compute.internal      172.31.64.10    False   True    pending subnet-497ccd34 vpc-dfeb32b7
   GROUPS  sg-f90fdd94     PublicIP-ALL
   PRIVATEIPADDRESSES      True    172.31.64.10

   # create a new (second) interface on our forwarder vm and bind the fixed IP
   aws ec2 attach-network-interface --network-interface-id eni-bd4ba997 --instance-id i-07bf33c76739cd8e3 --device-index 1
   eni-attach-051c4324e99a5db8d

   # allocate a new Elastic IP
   # this will be the one we forward to the lab
   aws ec2 allocate-address --domain vpc
   eipalloc-03f66f9a2e6939926      vpc     3.121.47.72

   # bind the elastic ip to the second interface so that 1:1 NAT is applied
   aws ec2 associate-address --allocation-id eipalloc-03f66f9a2e6939926 --network-interface-id eni-bd4ba997
   eipassoc-0fd09b4fa7c886259

Login to the Forwarder VM in AWS and apply the new OpenVPN config with the added route to forward the EIP2 towards the OpenVPN client in the lab

.. code-block:: none

   ssh -i PubIPForward.pem ubuntu@3.121.168.31
   
   sudo su

   # apply your changed config
   cat <<EOF >/etc/openvpn/server.conf
   port 1194
   proto tcp-server
   dev tun
   secret /etc/openvpn/static.key
   ifconfig 169.254.169.1 169.254.169.2
   route 3.121.47.72 255.255.255.255 169.254.169.2
   keepalive 10 120
   cipher AES-128-CBC   # AES
   comp-lzo
   persist-key
   persist-tun
   status openvpn-status.log
   verb 3
   EOF
   
   service openvpn stop
   # TEST the service start
   openvpn --config /etc/openvpn/server.conf
   
   service openvpn restart
   exit
   exit

Go to your NFX JDM to launch the second ubuntu vm acting as local OpenVPN client

.. code-block:: none

   cd /var/third-party/images/
   
   # create a meta-data file just with the VNF name
   cat <<EOF > meta-data
   local-hostname: ubuntu2
   EOF
   
   cat <<EOF > user-data
   #cloud-config
   password: TaUyaPgqkWMhq6YM
   chpasswd: { expire: False }
   ssh_pwauth: True
   users:
     - name: root
       lock-passwd: false
   chpasswd:
     list: |
       root:juniper123
     expire: False
   
   runcmd:
     - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin yes/' /etc/ssh/sshd_config ; service ssh restart
     - touch /etc/cloud/cloud-init.disabled
     - dhclient ens5
     - sleep 30
     - ifconfig ens6 3.121.47.1/24 up
     - echo nameserver 8.8.8.8 > /etc/resolv.conf
   EOF
   
   genisoimage -output ubuntu2.iso -volid cidata -joliet -rock user-data meta-data
   
   cli
   edit
   delete virtual-network-functions ubuntu2
   commit and-quit
   exit
   cp xenial-server-cloudimg-amd64-disk1.qcow2 ubuntu2.qcow2
   
   cli
   edit
   set host-os vlans wan0 vlan-id 100
   set virtual-network-functions ubuntu2 image /var/third-party/images/ubuntu2.qcow2
   set virtual-network-functions ubuntu2 storage vdb type cdrom source file /var/third-party/images/ubuntu2.iso
   set virtual-network-functions ubuntu2 virtual-cpu count 1
   set virtual-network-functions ubuntu2 memory size 1048576
   set virtual-network-functions ubuntu2 virtual-cpu features hardware-virtualization
   set virtual-network-functions ubuntu2 memory features hugepages
   set virtual-network-functions ubuntu2 interfaces eth4 mapping vlan members default
   set virtual-network-functions ubuntu2 interfaces eth4 mapping vlan mode access
   set virtual-network-functions ubuntu2 interfaces eth4 offloads disable
   set virtual-network-functions ubuntu2 interfaces eth5 mapping vlan members wan0
   set virtual-network-functions ubuntu2 interfaces eth5 mapping vlan mode access
   set virtual-network-functions ubuntu2 interfaces eth5 offloads disable
   commit and-quit
   exit

Login to the client VM and create the VPN client

.. code-block:: none

   ssh root@ubuntu2 (TaUyaPgqkWMhq6YM)
   
   route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         192.168.1.1     0.0.0.0         UG    0      0        0 ens5
   3.121.47.0      0.0.0.0         255.255.255.0   U     0      0        0 ens6
   192.0.2.0       0.0.0.0         255.255.255.0   U     0      0        0 ens3
   192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 ens5


   ping 8.8.8.8
   PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
   64 bytes from 8.8.8.8: icmp_seq=1 ttl=119 time=18.9 ms
   64 bytes from 8.8.8.8: icmp_seq=2 ttl=119 time=20.1 ms
   
   
   apt-get update
   
   apt-get upgrade
   
   apt-get -y install openvpn
   
   cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/
   
   # save config example
   cp /etc/openvpn/client.conf /etc/openvpn/client.conf.orig

   #egrep -v "^[[:space:]]*#|^$" /etc/openvpn/client.conf

   # Now copy the static key over that was created on the Server in AWS
   # The keys need to be SAME ON BOTH SIDES
   cat <<EOF >static.key
   #
   # 2048 bit OpenVPN static key
   #
   -----BEGIN OpenVPN Static key V1-----
   5f028d740810ccbfc0e871cb2093b161
   cf6194e70c809dcf08f9a3da2b420d7d
   29adeffc69f5720451423d825dde164f
   1d63e3e6707d4eeac9261e47a6811869
   7062d4daed4da11740fc612a55a48cc9
   f4001db2093fcb9c390c1f5420b1bb5b
   e681119e085d4ac0415f1cb71fcdc9db
   816f215620496a70342476eb1aa0be0d
   ca1c019ce2a0009f2074a02945f1699f
   a232a1d190d6c14e9d97379c89494c64
   ccfd7b46679ff41674761e706a090f55
   4f2f6dcf872ef52652f8ec3003fe1ac0
   4cdb868a45bbe20f8181db4a3af38714
   32d2e24245b89fe39d4bcdd1ef4aef2a
   92b5a8414f60ab7bf1cbb3903bf859c1
   0cf00e17862e874b81482110363dd55d
   -----END OpenVPN Static key V1-----
   END
   EOF
   
   cp static.key /etc/openvpn/static.key
   
   # apply your config
   cat <<EOF >/etc/openvpn/client.conf
   port 1194
   proto tcp-client
   dev tun
   remote 3.121.168.31
   secret /etc/openvpn/static.key
   ifconfig 169.254.169.2 169.254.169.1
   keepalive 10 120
   cipher AES-128-CBC   # AES
   comp-lzo
   persist-key
   persist-tun
   status openvpn-status.log
   verb 3
   EOF
   
   service openvpn stop
   # TEST the service start
   openvpn --config /etc/openvpn/client.conf

   # modify the openvpn daemon config to automatically start the client
   cat <<EOF > /etc/default/openvpn
   # This is the configuration file for /etc/init.d/openvpn
   
   #
   # Start only these VPNs automatically via init script.
   # Allowed values are "all", "none" or space separated list of
   # names of the VPNs. If empty, "all" is assumed.
   # The VPN name refers to the VPN configutation file name.
   # i.e. "home" would be /etc/openvpn/home.conf
   #
   # If you're running systemd, changing this variable will
   # require running "systemctl daemon-reload" followed by
   # a restart of the openvpn service (if you removed entries
   # you may have to stop those manually)
   #
   #AUTOSTART="all"
   #AUTOSTART="none"
   #AUTOSTART="home office"
   #
   # WARNING: If you're running systemd the rest of the
   # options in this file are ignored.
   #
   # Refresh interval (in seconds) of default status files
   # located in /var/run/openvpn.$NAME.status
   # Defaults to 10, 0 disables status file generation
   #
   #STATUSREFRESH=10
   #STATUSREFRESH=0
   # Optional arguments to openvpn's command line
   OPTARGS=""
   #
   # If you need openvpn running after sendsigs, i.e.
   # to let umountnfs work over the vpn, set OMIT_SENDSIGS
   # to 1 and include umountnfs as Required-Stop: in openvpn's
   # init.d script (remember to run insserv after that)
   #
   OMIT_SENDSIGS=0
   #
   AUTOSTART="client"
   EOF
   
   systemctl daemon-reload
   /etc/init.d/openvpn restart

   # enable kernel forwarding
   echo 1 > /proc/sys/net/ipv4/ip_forward
   # and made permanent for next boot
   sed -i '/net.ipv4.ip_forward/s/^#//g' /etc/sysctl.conf
   sysctl -p /etc/sysctl.conf
   
   exit

The third VM is ONLY for testing the prototype

This should be a vSRX next time to play the role of a hub.

Again you need to be in JDM to start the process

.. code-block:: none

   cd /var/third-party/images/
   
   # create a meta-data file just with the VNF name
   cat <<EOF > meta-data
   local-hostname: ubuntu3
   EOF
   
   cat <<EOF > user-data
   #cloud-config
   password: TaUyaPgqkWMhq6YM
   chpasswd: { expire: False }
   ssh_pwauth: True
   users:
     - name: root
       lock-passwd: false
   chpasswd:
     list: |
       root:juniper123
     expire: False
   
   runcmd:
     - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin yes/' /etc/ssh/sshd_config ; service ssh restart
     - touch /etc/cloud/cloud-init.disabled
     - echo nameserver 8.8.8.8 > /etc/resolv.conf
     - modprobe 8021q
     - vconfig add ens5 100
     - ip addr add 3.121.47.72/24 dev ens5.100
     - ip link set up ens5
     - ip link set up ens5.100
     - route add default gw 3.121.47.1
   EOF
   
   genisoimage -output ubuntu3.iso -volid cidata -joliet -rock user-data meta-data
   
   cli
   edit
   delete virtual-network-functions ubuntu3
   commit and-quit
   exit
   cp xenial-server-cloudimg-amd64-disk1.qcow2 ubuntu3.qcow2
   
   cli
   edit
   set virtual-network-functions ubuntu3 image /var/third-party/images/ubuntu3.qcow2
   set virtual-network-functions ubuntu3 storage vdb type cdrom source file /var/third-party/images/ubuntu3.iso
   set virtual-network-functions ubuntu3 virtual-cpu count 1
   set virtual-network-functions ubuntu3 memory size 1048576
   set virtual-network-functions ubuntu3 virtual-cpu features hardware-virtualization
   set virtual-network-functions ubuntu3 memory features hugepages
   set virtual-network-functions ubuntu3 interfaces eth5 mapping vlan members wan0
   set virtual-network-functions ubuntu3 interfaces eth5 mapping vlan mode trunk
   set virtual-network-functions ubuntu3 interfaces eth5 offloads disable
   commit and-quit
   exit

.. code-block:: none

   ssh root@ubuntu3 (TaUyaPgqkWMhq6YM)

   # Check that you can ping the client vm
   ping 169.254.169.2
   PING 169.254.169.2 (169.254.169.2) 56(84) bytes of data.
   64 bytes from 169.254.169.2: icmp_seq=1 ttl=64 time=0.079 ms
   64 bytes from 169.254.169.2: icmp_seq=2 ttl=64 time=0.084 ms
   .
   .

   # Check that you can ping the Aws instance via Tunnel
   ping 169.254.169.1
   PING 169.254.169.1 (169.254.169.1) 56(84) bytes of data.
   64 bytes from 169.254.169.1: icmp_seq=1 ttl=63 time=19.1 ms
   64 bytes from 169.254.169.1: icmp_seq=2 ttl=63 time=16.5 ms
   64 bytes from 169.254.169.1: icmp_seq=3 ttl=63 time=15.8 ms
   .
   .

   exit

Go to the AWS instance to create forwarding from 2ndEIP to tunnel. This needs S/D NAT to translate from the local IP of the second IF of the VM (where the EIP2 sends traffic to) to the EIP2 that we forward internally to the device. This info got lost because AWS converted it.

You need to place the tun0 and eth1 interface into a private routing instance

.. code-block:: none

   ssh root@ubuntu1 (TaUyaPgqkWMhq6YM)
   ssh -i PubIPForward.pem ubuntu@3.121.168.31
   sudo su

   # manually enable the new second interface and get the ip via DHCP or else
   ifconfig eth1 up
   dhclient eth1
   ifconfig eth1
   eth1      Link encap:Ethernet  HWaddr 06:e3:7a:83:70:52
             inet addr:172.31.64.10  Bcast:172.31.64.255  Mask:255.255.255.0
             inet6 addr: fe80::4e3:7aff:fe83:7052/64 Scope:Link
             UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1
             RX packets:655 errors:0 dropped:0 overruns:0 frame:0
             TX packets:10 errors:0 dropped:0 overruns:0 carrier:0
             collisions:0 txqueuelen:1000
             RX bytes:35887 (35.8 KB)  TX bytes:1332 (1.3 KB)
   
   
   ufw enable ; ufw allow ssh
   
   iptables-save -c > /etc/iptables-save
   cat /etc/iptables-save
   #iptables-restore -c < /etc/iptables-save

   ufw disable; ufw enable ; ufw allow ssh

   # create bash-script to flush tables (more save)
   echo <<EOF >clearfw.sh
   #!/bin/bash
   iptables -F
   iptables -X
   iptables -t nat -F
   iptables -t nat -X
   iptables -t mangle -F
   iptables -t mangle -X
   iptables -t raw -F
   iptables -t raw -X
   iptables -P INPUT ACCEPT
   iptables -P FORWARD ACCEPT
   iptables -P OUTPUT ACCEPT
   iptables-save -c > /etc/iptables-save
   EOF
   
   chmod 777 clearfw.sh
   ./clearfw.sh
   
   # add the forwarding conversion to restore original EIP2
   iptables -I INPUT 1 -i eth1 -j ACCEPT
   iptables -t nat -A POSTROUTING -j SNAT -s 3.121.47.72 --to-source 172.31.64.10
   iptables -t nat -A PREROUTING  -j DNAT -d 172.31.64.10 --to-destination 3.121.47.72


   #### Apply this AFTER the firewall setup
   # this will form the private IP routing instance and add the needed ips there

   echo "200 frometh1" >>/etc/iproute2/rt_tables
   
   ip route flush table frometh1
   ip rule add iif eth1 lookup frometh1
   ip rule add iif tun0 lookup frometh1
   ip route add default via 172.31.64.1 dev eth1 table frometh1
   ip rule add from 172.31.64.0/24 table frometh1
   ip rule add to 172.31.64.0/24 table frometh1
   ip rule add from 172.31.64.10/32 table frometh1
   ip rule add to 172.31.64.10/32 table frometh1
   ip rule add from 169.254.169.0/24 table frometh1
   ip rule add to 169.254.169.0/24 table frometh1
   ip rule add from 169.254.169.1/32 table frometh1
   ip rule add to 169.254.169.1/32 table frometh1
   ip rule add from 3.121.47.72/32 table frometh1
   ip rule add to 3.121.47.72/32 table frometh1
   ip route add 3.121.47.72/32 via 169.254.169.2 dev tun0 table frometh1
   ip route flush cache
   
   exit
   exit

Now add the private forwarding instance to the VPN client VM on the NFX

No S/D NAT needed just pure routing

.. code-block:: none

   ssh root@ubuntu2 (TaUyaPgqkWMhq6YM)
   
   echo "200 fromens6" >>/etc/iproute2/rt_tables
   
   ip route flush table fromens6
   ip rule add iif ens6 lookup fromens6
   ip rule add iif tun0 lookup fromens6
   ip route add default via 169.254.169.1 dev tun0 table fromens6
   ip rule add from 3.121.47.0/24 table fromens6
   ip rule add to 3.121.47.0/24 table fromens6
   ip rule add from 3.121.47.1/32 table fromens6
   ip rule add to 3.121.47.1/32 table fromens6
   ip rule add from 169.254.169.0/24 table fromens6
   ip rule add to 169.254.169.0/24 table fromens6
   ip rule add from 169.254.169.2/32 table fromens6
   ip rule add to 169.254.169.2/32 table fromens6
   ip route add 3.121.47.0/24 via 3.121.47.1 dev ens6 table fromens6
   ip route flush cache

Peering between Hub and Legacy environment
------------------------------------------

This is an **example** on how you MAY do the interaction with a Legacy environment. In OUR LAB this is not needed as we have just static routes and we mandate the LAN site IP-Address ranges to be either 10.88.88.0/24 or 10.66.66.0/24 (the NAT VM needs to know them). Thanks to Michael Pergament for this.

---------------

Setup is simple for this test. Hub is connected like this to BGP router:

 

LAN—10.1.10.0/24----CPE--------HUB2 --ge-0/0/2.200-------ge-0/0/11.200—BGP Router---10.122.200.1 legacy route is redistributed to all CPEs inside this tenant and all LAN routes redistributed to BGP router.

 

My tenant name is JNPR_BYOD (so you will need to adapt all occurrence of JNPR_BYOD in configs below + interface names + IPs). Routing policy as of now is – redistribute everything from BGP router (can be modified to filter specific route prefixes).

.. hidden-code-block:: none

   
   root@A4328E27945A.x48-HUB-2.default-project> show configuration groups LEGACY
   security {
       policies {
           from-zone trust-JNPR_BYOD to-zone legacy {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
           from-zone legacy to-zone trust-JNPR_BYOD {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone legacy {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/2.200;
               }
           }
       }
   }
   interfaces {
       ge-0/0/2 {
           vlan-tagging;
           unit 200 {
               vlan-id 200;
               family inet {
                   address 10.121.200.2/24;
               }
           }
       }
   }
   routing-options {
       rib-groups {
           legacy-to-sdwan {
               import-rib [ Legacy.inet.0 JNPR_BYOD_DefaultVPN-JNPR_BYOD.inet.0 ];
           }
       }
   }
   policy-options {
       policy-statement Legacy-export {
           term JNPR_BYOD_DefaultVPN-JNPR_BYOD {
               from protocol bgp;
               then {
                   community add Hub-Routes-Default-JNPR_BYOD_DefaultVPN-JNPR_BYOD;
                   next-hop 10.120.100.1;
                   accept;
               }
           }
       }
       policy-statement PREF-LEGACY {
           term 1 {
               then accept;
           }
       }
   }
   routing-instances {
       Legacy {
           instance-type vrf;
           interface ge-0/0/2.200;
           route-distinguisher 10.120.100.1:4000;
           vrf-import Default-JNPR_BYOD_DefaultVPN-JNPR_BYOD-import;
           vrf-export Legacy-export;
           vrf-table-label;
           routing-options {
               autonomous-system 64512;
           }
           protocols {
               bgp {
                   group Legacy {
                       type external;
                       hold-time 30;
                       family inet {
                           unicast {
                               rib-group legacy-to-sdwan;
                           }
                       }
                       export PREF-LEGACY;
                       bfd-liveness-detection {
                           minimum-interval 1000;
                           multiplier 3;
                       }
                       neighbor 10.121.200.1 {
                           peer-as 64539;
                       }
                   }
               }
           }
       }
   }

And as set:

.. hidden-code-block:: none

   
   root@A4328E27945A.x48-HUB-2.default-project> show configuration groups LEGACY | display set
   set groups LEGACY security policies from-zone trust-JNPR_BYOD to-zone legacy policy allow_all match source-address any
   set groups LEGACY security policies from-zone trust-JNPR_BYOD to-zone legacy policy allow_all match destination-address any
   set groups LEGACY security policies from-zone trust-JNPR_BYOD to-zone legacy policy allow_all match application any
   set groups LEGACY security policies from-zone trust-JNPR_BYOD to-zone legacy policy allow_all then permit
   set groups LEGACY security policies from-zone legacy to-zone trust-JNPR_BYOD policy allow_all match source-address any
   set groups LEGACY security policies from-zone legacy to-zone trust-JNPR_BYOD policy allow_all match destination-address any
   set groups LEGACY security policies from-zone legacy to-zone trust-JNPR_BYOD policy allow_all match application any
   set groups LEGACY security policies from-zone legacy to-zone trust-JNPR_BYOD policy allow_all then permit
   set groups LEGACY security zones security-zone legacy host-inbound-traffic system-services all
   set groups LEGACY security zones security-zone legacy host-inbound-traffic protocols all
   set groups LEGACY security zones security-zone legacy interfaces ge-0/0/2.200
   set groups LEGACY interfaces ge-0/0/2 vlan-tagging
   set groups LEGACY interfaces ge-0/0/2 unit 200 vlan-id 200
   set groups LEGACY interfaces ge-0/0/2 unit 200 family inet address 10.121.200.2/24
   set groups LEGACY routing-options rib-groups legacy-to-sdwan import-rib Legacy.inet.0
   set groups LEGACY routing-options rib-groups legacy-to-sdwan import-rib JNPR_BYOD_DefaultVPN-JNPR_BYOD.inet.0
   set groups LEGACY policy-options policy-statement Legacy-export term JNPR_BYOD_DefaultVPN-JNPR_BYOD from protocol bgp
   set groups LEGACY policy-options policy-statement Legacy-export term JNPR_BYOD_DefaultVPN-JNPR_BYOD then community add Hub-Routes-Default-JNPR_BYOD_DefaultVPN-JNPR_BYOD
   set groups LEGACY policy-options policy-statement Legacy-export term JNPR_BYOD_DefaultVPN-JNPR_BYOD then next-hop 10.120.100.1
   set groups LEGACY policy-options policy-statement Legacy-export term JNPR_BYOD_DefaultVPN-JNPR_BYOD then accept
   set groups LEGACY policy-options policy-statement PREF-LEGACY term 1 then accept
   set groups LEGACY routing-instances Legacy instance-type vrf
   set groups LEGACY routing-instances Legacy interface ge-0/0/2.200
   set groups LEGACY routing-instances Legacy route-distinguisher 10.120.100.1:4000
   set groups LEGACY routing-instances Legacy vrf-import Default-JNPR_BYOD_DefaultVPN-JNPR_BYOD-import
   set groups LEGACY routing-instances Legacy vrf-export Legacy-export
   set groups LEGACY routing-instances Legacy vrf-table-label
   set groups LEGACY routing-instances Legacy routing-options autonomous-system 64512
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy type external
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy hold-time 30
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy family inet unicast rib-group legacy-to-sdwan
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy export PREF-LEGACY
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy bfd-liveness-detection minimum-interval 1000
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy bfd-liveness-detection multiplier 3
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy neighbor 10.121.200.1 peer-as 64539
   

BGP Router config:

.. hidden-code-block:: none

   
   root@POD-x48-RGW# show groups LEGACY
   security {
       policies {
           from-zone legacy to-zone legacy {
               policy allow_all {
                   match {
                       source-address any;
                       destination-address any;
                       application any;
                   }
                   then {
                       permit;
                   }
               }
           }
       }
       zones {
           security-zone legacy {
               host-inbound-traffic {
                   system-services {
                       all;
                   }
                   protocols {
                       all;
                   }
               }
               interfaces {
                   ge-0/0/11.200;
                   lo0.10;
               }
           }
       }
   }
   interfaces {
       ge-0/0/11 {
           vlan-tagging;
           unit 200 {
               vlan-id 200;
               family inet {
                   address 10.121.200.1/24;
               }
           }
       }
       lo0 {
           unit 10 {
               family inet {
                   address 10.122.200.1/32;
               }
           }
       }
   }
   policy-options {
       policy-statement PREF-LEGACY {
           term lo0 {
               from {
                   route-filter 10.122.200.1/32 exact;
               }
               then accept;
           }
           term last {
               then reject;
           }
       }
   }
   routing-instances {
       Legacy {
           instance-type virtual-router;
           interface ge-0/0/11.200;
           interface lo0.10;
           routing-options {
               autonomous-system 64539;
           }
           protocols {
               bgp {
                   group Legacy {
                       type external;
                       hold-time 30;
                       family inet {
                           unicast;
                       }
                       export PREF-LEGACY;
                       bfd-liveness-detection {
                           minimum-interval 1000;
                           multiplier 3;
                       }
                       neighbor 10.121.200.2 {
                           peer-as 64512;
                       }
                   }
               }
           }
       }
   }
   set groups LEGACY security policies from-zone legacy to-zone legacy policy allow_all match source-address any
   set groups LEGACY security policies from-zone legacy to-zone legacy policy allow_all match destination-address any
   set groups LEGACY security policies from-zone legacy to-zone legacy policy allow_all match application any
   set groups LEGACY security policies from-zone legacy to-zone legacy policy allow_all then permit
   set groups LEGACY security zones security-zone legacy host-inbound-traffic system-services all
   set groups LEGACY security zones security-zone legacy host-inbound-traffic protocols all
   set groups LEGACY security zones security-zone legacy interfaces ge-0/0/11.200
   set groups LEGACY security zones security-zone legacy interfaces lo0.10
   set groups LEGACY interfaces ge-0/0/11 vlan-tagging
   set groups LEGACY interfaces ge-0/0/11 unit 200 vlan-id 200
   set groups LEGACY interfaces ge-0/0/11 unit 200 family inet address 10.121.200.1/24
   set groups LEGACY interfaces lo0 unit 10 family inet address 10.122.200.1/32
   set groups LEGACY policy-options policy-statement PREF-LEGACY term lo0 from route-filter 10.122.200.1/32 exact
   set groups LEGACY policy-options policy-statement PREF-LEGACY term lo0 then accept
   set groups LEGACY policy-options policy-statement PREF-LEGACY term last then reject
   set groups LEGACY routing-instances Legacy instance-type virtual-router
   set groups LEGACY routing-instances Legacy interface ge-0/0/11.200
   set groups LEGACY routing-instances Legacy interface lo0.10
   set groups LEGACY routing-instances Legacy routing-options autonomous-system 64539
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy type external
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy hold-time 30
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy family inet unicast
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy export PREF-LEGACY
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy bfd-liveness-detection minimum-interval 1000
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy bfd-liveness-detection multiplier 3
   set groups LEGACY routing-instances Legacy protocols bgp group Legacy neighbor 10.121.200.2 peer-as 64512
   

Some debugging outputs:

.. hidden-code-block:: none

   
   root@A4328E27945A.x48-HUB-2.default-project> show bfd session
                                                     Detect   Transmit
   Address                  State     Interface      Time     Interval  Multiplier
   10.121.200.1             Up        ge-0/0/2.200   3.000     1.000        3
    
   1 sessions, 1 clients
   Cumulative transmit rate 1.0 pps, cumulative receive rate 1.0 pps
    
   root@A4328E27945A.x48-HUB-2.default-project> show bgp summary
   Groups: 4 Peers: 13 Down peers: 9
   10.121.200.1          64539        177        178       0       0       25:59 Establ
     Legacy.inet.0: 1/1/1/0
    
   root@A4328E27945A.x48-HUB-2.default-project> show route table Legacy.inet.0
    
   Legacy.inet.0: 11 destinations, 12 routes (4 active, 0 holddown, 8 hidden)
   + = Active Route, - = Last Active, * = Both
    
   10.1.10.0/24       *[BGP/170] 00:35:19, localpref 200, from 10.0.100.15
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4009, Push 16
   10.121.200.0/24    *[Direct/0] 00:35:14
                       > via ge-0/0/2.200
   10.121.200.2/32    *[Local/0] 00:35:14
                         Local via ge-0/0/2.200
   10.122.200.1/32    *[BGP/170] 00:18:16, localpref 100        <- External route from BGP router
                         AS path: 64539 I, validation-state: unverified
                       > to 10.121.200.1 via ge-0/0/2.200
    
   On CPE:
   root@CV2516AF0022.MP-SRX300.JNPR_BYOD> show route 10.122.200/24
    
   LAN-JNPR_BYOD_DefaultVPN.inet.0: 12 destinations, 21 routes (12 active, 0 holddown, 8 hidden)
   + = Active Route, - = Last Active, * = Both
    
   10.122.200.1/32    *[BGP/170] 00:10:52, localpref 200, from 10.0.100.15
                         AS path: 64539 I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 146
    
   Default-JNPR_BYOD_DefaultVPN.inet.0: 10 destinations, 11 routes (3 active, 0 holddown, 8 hidden)
   + = Active Route, - = Last Active, * = Both
    
   10.122.200.1/32    *[BGP/170] 00:10:52, localpref 200, from 10.0.100.15
                         AS path: 64539 I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 146
    
   bgp.l3vpn.0: 46 destinations, 46 routes (22 active, 0 holddown, 24 hidden)
   + = Active Route, - = Last Active, * = Both
    
   10.120.100.1:4000:10.122.200.1/32
                      *[BGP/170] 00:10:52, localpref 100, from 10.0.100.15
                         AS path: 64539 I, validation-state: unverified
                       > via gr-0/0/0.4000, Push 146
    
   On BGP router:
   root@POD-x48-RGW# run show route table Legacy.inet.0
    
   Legacy.inet.0: 4 destinations, 5 routes (4 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both
    
   10.1.10.0/24       *[BGP/170] 00:30:15, localpref 100             <- LAN route 
                         AS path: 64512 I, validation-state: unverified
                       > to 10.121.200.2 via ge-0/0/11.200
   10.121.200.0/24    *[Direct/0] 00:30:19
                       > via ge-0/0/11.200
                       [BGP/170] 00:30:15, localpref 100
                         AS path: 64512 I, validation-state: unverified
                       > to 10.121.200.2 via ge-0/0/11.200
   10.121.200.1/32    *[Local/0] 00:30:19
                         Local via ge-0/0/11.200
   10.122.200.1/32    *[Direct/0] 00:25:09
                       > via lo0.10

AWS Spoke on CSO-BYOD-OpenLab instance
--------------------------------------

.. warning:: It is way better to use this method then the old one in chapter 7.10 above as in this lab CSO is already configured behind NAT and the Hub has Public IP’s. However the customer must agree that it’s not shown on the local CSO lab instance.

Preparations on AWS before the PoC starts
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

These are the conditions to be prepared for this lab

-  You need to apply to the `CSO-BYOD Lab <https://forms.office.com/Pages/ResponsePage.aspx?id=PIunvttMMEGFSh0ZMjLl9HKKw_mFaFFCuLGSfPg6ChVUMEdQM09CNURKNDlVQzRZUEJVV0tHVU04Ni4u>`__ and have an own Tenant there. Use a Random Serial number for your virtual vSRX Device on AWS or a realdevice that you don’t use for the moment. The System will send you an Email contraining an “OAM lo0”-Host-IP. This is important to have for later configuration.
-  You need an `AWS Account <https://console.aws.amazon.com/>`__. (If not use your credit card and get one)
-  You need to select a Region and a VPC in the Region.
-  You need to create set of own Security credentials for SSH Keys to VM’s
-  You have to create 2 free Elastic IP’s in the VPC
-  You have to create 4 Subnets in the VPC

A few of these Steps are shown below:

.. _know-or-create-your-vpc-id-and-the-ip-range-for-it-1:

Know or create your VPC-ID (and the IP-Range for it)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

|image925|

.. _create-2-free-elastic-ips-1:

Create 2 free Elastic IP’s
^^^^^^^^^^^^^^^^^^^^^^^^^^

Services --> EC2 --> Elastic IP

.. note:: You need to have at least TWO Elastic IP addresses pre-allocated that CSO can use.

|image926|

.. _create-4-subnets-within-your-vpc-1:

Create 4 Subnets within your VPC
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Services --> VPC --> Subnets

|image927|

Now we need to re-define the default route for VM’s that will be attache to the LAN side to madate to use our vSRX interface wich will be located on 172.31.3.10 (.1 and .2 are always uses by AWS itself.)

.. _provision-of-the-aws-spoke-1:

Provision of the AWS Spoke
~~~~~~~~~~~~~~~~~~~~~~~~~~

Login to the BYOD Portal https://x48-byod.mycsolab.com/dashboard/ and add a Cloud Spoke.

|image928|

|image929|

|image930|

|image931|

.. warning:: In this environment you have to use Local-Breakout for the Internet traffic! Your LAN side 172.31.3.0/24 Network is not NATed at the Hub so we use Auto-Nat and LBO!!!Also make sure you only use WAN_0 as interface for LBO (this is how we tested it).

|image932|

|image933|

|image934|

|image935|

|image936|

|image937|

|image938|

|image939|

|image940|

WAIT (~6min) until the Site is configured

|image941|

Now download the rendered template.

|image942|

|image943|

.. warning:: Before the cloudformation template can run you must approve the image in the marketplace if you havn’t done this before. If you miss to do that the template will fail!

Go and look for the vSRX image in the marketplace:

https://aws.amazon.com/marketplace/pp?sku=4ka3ipaoo0u105imvgdsryu05

|image944|

|image945|

Go to AWS and Services –> Cloud Formation

Create a new Stack

|image946|

|image947|

|image948|

ACK the Checkbox and start the Cloud Formation Template

|image949|

Refresh the Template to review the changes (takes ~3minutes)

|image950|

WAIT until the device connects via the OAM Tunnel to the Hub as below going from “expected” to Device connected (this MINIMUM take10 minutes after Stack created as the vSRX boots up so slow).

|image951|

|image952|

|image953|

Wait ~20minutes until the Device is fully provisioned!

|image954|

.. warning:: Before you do anything else CHANGE THE DEFAULT DEVICE PASSWORD!Else someone can hijack this VM as it’s exposed to the Internet via Elastic IP1 and default SSH root/Embe1mpls credentials! You have been warned!!!

|image955|

|image956|

|image957|

If you havn’t done it already create a default Firewall policy allowing all traffic

|image958|

And make sure it’s applied.

|image959|

|image960|

You should now login with your changed password and see if everything is well.

|image961|

|image962|

Check if all is well. Here you see the typical RTT of ~90ms between Frankfurt and Bridgewater NJ, USA

.. hidden-code-block:: none

   root@20fb7d50-c5f9-4ca2-9dff-01a2a8834748.AWSspoke.HSCHROEDER_T> show services rpm probe-results
       Owner: 75ddba7fa3e0c90d6ca864f7c0fd93a3, Test: test-icmp-ping
       Target address: 172.22.203.181, Source address: 172.22.203.180, Probe type: icmp-ping
       Routing Instance Name: transit
       Destination interface name: gr-0/0/0.4002
       Test size: 5 probes
       Probe results:
         Response received
         Thu Dec 20 09:57:12 2018
         Thu Dec 20 09:57:12 2018, No hardware timestamps
         Rtt: 98343 usec, Round trip jitter: -315 usec, Round trip interarrival jitter: 347 usec
       Results over current test:
         Probes sent: 2, Probes received: 2, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 2, Minimum: 98343 usec, Maximum: 98658 usec, Average: 98501 usec, Peak to peak: 315 usec, Stddev: 158 usec,
           Sum: 197001 usec
         Measurement: Positive round trip jitter
           Samples: 1, Minimum: 225 usec, Maximum: 225 usec, Average: 225 usec, Peak to peak: 0 usec, Stddev: 0 usec,
           Sum: 225 usec
         Measurement: Negative round trip jitter
           Samples: 1, Minimum: 315 usec, Maximum: 315 usec, Average: 315 usec, Peak to peak: 0 usec, Stddev: 0 usec,
           Sum: 315 usec
       Results over last test:
         Probes sent: 5, Probes received: 5, Loss percentage: 0.000000
         Test completed on Thu Dec 20 09:56:57 2018
         Measurement: Round trip time
           Samples: 5, Minimum: 98044 usec, Maximum: 98584 usec, Average: 98315 usec, Peak to peak: 540 usec, Stddev: 187 usec,
           Sum: 491573 usec
         Measurement: Positive round trip jitter
           Samples: 3, Minimum: 239 usec, Maximum: 306 usec, Average: 273 usec, Peak to peak: 67 usec, Stddev: 27 usec,
           Sum: 819 usec
         Measurement: Negative round trip jitter
           Samples: 2, Minimum: 124 usec, Maximum: 540 usec, Average: 332 usec, Peak to peak: 416 usec, Stddev: 208 usec,
           Sum: 664 usec
       Results over all tests:
         Probes sent: 6272, Probes received: 6252, Loss percentage: 0.318878
         Measurement: Round trip time
           Samples: 6252, Minimum: 91758 usec, Maximum: 154086 usec, Average: 97978 usec, Peak to peak: 62328 usec,
           Stddev: 2795 usec, Sum: 612559818 usec
         Measurement: Positive round trip jitter
           Samples: 3131, Minimum: 0 usec, Maximum: 53607 usec, Average: 543 usec, Peak to peak: 53607 usec, Stddev: 1765 usec,
           Sum: 1700896 usec
         Measurement: Negative round trip jitter
           Samples: 3120, Minimum: 1 usec, Maximum: 55408 usec, Average: 545 usec, Peak to peak: 55407 usec, Stddev: 1857 usec,
           Sum: 1700883 usec
   
       Owner: 83bc05f7d8fd23a51a5163f5bfda74c1, Test: test-icmp-ping
       Target address: 172.27.183.119, Source address: 172.27.183.118, Probe type: icmp-ping
       Routing Instance Name: transit
       Destination interface name: gr-0/0/0.4000
       Test size: 5 probes
       Probe results:
         Response received
         Thu Dec 20 09:57:20 2018
         Thu Dec 20 09:57:21 2018, No hardware timestamps
         Rtt: 94719 usec, Round trip jitter: -99 usec, Round trip interarrival jitter: 407 usec
       Results over current test:
         Probes sent: 4, Probes received: 4, Loss percentage: 0.000000
         Measurement: Round trip time
           Samples: 4, Minimum: 94283 usec, Maximum: 94864 usec, Average: 94671 usec, Peak to peak: 581 usec, Stddev: 230 usec,
           Sum: 378684 usec
         Measurement: Positive round trip jitter
           Samples: 1, Minimum: 581 usec, Maximum: 581 usec, Average: 581 usec, Peak to peak: 0 usec, Stddev: 0 usec,
           Sum: 581 usec
         Measurement: Negative round trip jitter
           Samples: 3, Minimum: 46 usec, Maximum: 606 usec, Average: 250 usec, Peak to peak: 560 usec, Stddev: 252 usec,
           Sum: 751 usec
       Results over last test:
         Probes sent: 5, Probes received: 5, Loss percentage: 0.000000
         Test completed on Thu Dec 20 09:56:45 2018
         Measurement: Round trip time
           Samples: 5, Minimum: 94663 usec, Maximum: 94920 usec, Average: 94820 usec, Peak to peak: 257 usec, Stddev: 91 usec,
           Sum: 474098 usec
         Measurement: Positive round trip jitter
           Samples: 3, Minimum: 42 usec, Maximum: 217 usec, Average: 148 usec, Peak to peak: 175 usec, Stddev: 76 usec,
           Sum: 443 usec
         Measurement: Negative round trip jitter
           Samples: 2, Minimum: 116 usec, Maximum: 141 usec, Average: 129 usec, Peak to peak: 25 usec, Stddev: 12 usec,
           Sum: 257 usec
       Results over all tests:
         Probes sent: 6274, Probes received: 6255, Loss percentage: 0.302837
         Measurement: Round trip time
           Samples: 6255, Minimum: 92806 usec, Maximum: 156011 usec, Average: 94825 usec, Peak to peak: 63205 usec,
           Stddev: 3331 usec, Sum: 593132833 usec
         Measurement: Positive round trip jitter
           Samples: 3132, Minimum: 0 usec, Maximum: 61549 usec, Average: 623 usec, Peak to peak: 61549 usec, Stddev: 2013 usec,
           Sum: 1952707 usec
         Measurement: Negative round trip jitter
           Samples: 3122, Minimum: 1 usec, Maximum: 61653 usec, Average: 625 usec, Peak to peak: 61652 usec, Stddev: 2085 usec,
           Sum: 1952457 usec

.. warning:: Do not forget to push a License NOW! Use the one that is already in the system.

.. warning:: After you got the license pushed INSTALL A SIGNATURE DB!

If the signature db install doesn’t work APPLY IT MANUALLY so shown below:

.. code-block:: none

   ping signatures.juniper.net
   PING sus-prod.junipercloud.net (54.69.231.26): 56 data bytes
   64 bytes from 54.69.231.26: icmp_seq=0 ttl=237 time=159.607 ms
   64 bytes from 54.69.231.26: icmp_seq=1 ttl=237 time=159.443 ms
   64 bytes from 54.69.231.26: icmp_seq=2 ttl=237 time=159.443 ms
   ^C
   --- sus-prod.junipercloud.net ping statistics ---
   3 packets transmitted, 3 packets received, 0% packet loss
   round-trip min/avg/max/stddev = 159.443/159.498/159.607/0.077 ms
   
   request services application-identification download
   Please use command
           "request services application-identification download status" to check download status
   
   request services application-identification download status
   Downloading application package 3071 succeeded.

   request services application-identification install
   re0:
   --------------------------------------------------------------------------
   Please use command
           "request services application-identification install status" to check install status

   request services application-identification install status
   Installed
           Application package (3071) and Protocol bundle successfully

Add a Traffic-Testing VM to your AWS VPC
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Here we just use an ordinary free Ubuntu VM. Go to your AWS Marketplace https://aws.amazon.com/marketplace and search for “ubuntu 16.04 lts”

|image963|

|image964|

Activate a subscription and wait until you can configure

|image965|

|image966|

|image967|

Chosse t2.micro (best) or t2.small if you want to show videos over it.

|image968|

Connect your VM to your VPC and Subnet “LAN” and do NOT assign a Public IP to make this VM really internal!

|image969|

We need an additional direct interface to WAN0 just to be able to DIRECLTY login into the VM from the vSRX-GW and using the default inet.0 routing instance on the GW else it’s very tricky to provide access to the VM for demos.

|image970|

Before you submit fill in the code under “Advanced Details” to re-configure the VM to set your own PASSWORD and the interfaces. It will reboot once to apply the config.

|image971|

.. warning:: Make sure you change the Password for the Ubuntu VM to your own secret one.

.. code-block:: none

   #cloud-config
   apt_update: true
   disable_root: false
   manage_etc_hosts: false
   chpasswd:
     list: |
       ubuntu:test89build!z
     expire: False
   ssh_pwauth: True
   
   groups:
     - cloud-users
   users:
     - default
   runcmd:
     - touch /etc/cloud/cloud-init.disabled
     - |
       echo '
       # The loopback network interface
       auto lo
       iface lo inet loopback
       # first interface with reprogramming default gw to vSRX
       auto eth0
       iface eth0 inet dhcp
         post-up route del default ; route add default gw 172.31.3.10
       # second interface
       auto eth1
       iface eth1 inet dhcp
       ' > /etc/network/interfaces
     - reboot

Go to the next Page.

Review and press “Launch”

Select or create a new Key Pair. It doesn’t matter for THIS VM as the login credentials are based on the dynamic Instance-ID. Finally launch the instance.

|image972|

Note down the created instance id because this is also the Password for the next Step.

|image973|

.. note:: When this VM launches your SSH-Connection to the Spoke might be interrupted! Simply re-attach and continue.

This VM takes 2-3minutes to come up.

Go to the AWS Console Services -> EC2 -> Instances

|image974|

For your new instance check which SECOND Private IP was assigned

|image975|

Login to the vSRX-GW via ssh and access the new VM.

.. code-block:: none

   root@b98b9d59-7b24-4308-bb85-fa413c406b30% cli
   root@b98b9d59-7b24-4308-bb85-fa413c406b30.AWSspoke.HSCHROEDER_T> ssh ubuntu@172.31.1.57
   The authenticity of host '172.31.1.57 (172.31.1.57)' can't be established.
   ECDSA key fingerprint is SHA256:BIQGk4h0Cce8CTF6aZ8eb/2E/5Pgm3k4FHAYIqBjk4c.
   Are you sure you want to continue connecting (yes/no)? yes
   Warning: Permanently added '172.31.1.57' (ECDSA) to the list of known hosts.
   ubuntu@172.31.1.57's password: test89build!z
   .
   .
   ubuntu@ip-172-31-3-131:~$ route -n
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
   0.0.0.0         172.31.3.10     0.0.0.0         UG    0      0        0 eth0
   172.31.1.0      0.0.0.0         255.255.255.0   U     0      0        0 eth1
   172.31.3.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0
   ubuntu@ip-172-31-3-131:~$ ping 8.8.8.8
   PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
   64 bytes from 8.8.8.8: icmp_seq=1 ttl=118 time=1.61 ms
   64 bytes from 8.8.8.8: icmp_seq=2 ttl=118 time=1.64 ms
   64 bytes from 8.8.8.8: icmp_seq=3 ttl=118 time=1.64 ms
   ^C
   --- 8.8.8.8 ping statistics ---
   3 packets transmitted, 3 received, 0% packet loss, time 2003ms
   rtt min/avg/max/mdev = 1.616/1.633/1.644/0.048 ms

Now you either send Pings or use the Traffic generator Script from chapter 8.14 above.

You should NOW (and not before) finally see Traffic Application detected (or wait at least 5 minutes for the DB to fill).

.. note:: As the majority of the Traffic will use the direct path via LBO make sure that you look for underlay Traffic on the AWSspoke NOT Overlay which will only be used for Site-To-Site Traffic.

|image976|

If you have a second Site you can interact between them. Just make sure you have an ADDITIONAL Firewall rule allowing this Site to Site traffic created and deployed.

Multicloud Demo with CC13 slab environment
------------------------------------------

|image977|

|image978|

Everything is like in chapter 7.8 above but with a few changes.

Additonally to the predefined Mesh-Tags Internet/MPLS we have two additional one called

|image979|

|image980|

|image981|

Those are then bound to the mesh interfaces on sdwansite1+2 and the site-gateway but NOT to sdwansite3!

|image982|

|image983|

.. hidden-code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "sdwansitegw",
                   "site_basic_properties": {
                       "local_breakout": {},
                       "gatewaySite": true,
                       "site_type": "on_premise",
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": false,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "provider": "abc",
                                       "wan_link": "WAN_0",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "b9203a0d-d0d5-77de-f4f0-148b81f9b469",
                                       "cost": 2222,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "provider": "xyz",
                                       "wan_link": "WAN_1",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "bfc49517-16f8-a5aa-6a0f-7eba4894c142",
                                       "cost": 111,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "SRX_Advanced_SDWAN_CPE_option_1",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "192.168.204.254/24",
                                       "protocol": "ebgp",
                                       "lan_segment_name": "headquarter",
                                       "bgp": {
                                           "peer_as_number": "65100",
                                           "peer_ip_address": "192.168.204.1"
                                       },
                                       "routing_segment": true,
                                       "lan_ports": [
                                           "LAN_4"
                                       ],
                                       "authentication_mode": "NONE",
                                       "department": "datacenter",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwansitegw"
                           }
                       ],
                       "0": {
                           "ip_prefix": "192.168.204.254/24",
                           "protocol": "ebgp",
                           "lan_segment_name": "headquarter",
                           "bgp": {
                               "peer_as_number": "65100",
                               "peer_ip_address": "192.168.204.1"
                           },
                           "routing_segment": true,
                           "lan_ports": [
                               "LAN_4"
                           ],
                           "authentication_mode": "NONE",
                           "department": "datacenter",
                           "dhcp": false
                       },
                       "on_premise_gateway": true,
                       "site_role": "SPOKE",
                       "sla_mgmt": "FINE",
                       "device_profile_name": "SRX as SD-WAN CPE",
                       "site_name": "sdwansitegw",
                       "site_group": null,
                       "dvpn_params": {
                           "delete_dvpn_threshold": 2,
                           "create_dvpn_threshold": 5
                       },
                       "topology": "Real-Time Optimized"
                   }
               }
           ]
       }
   }
   

.. hidden-code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "job_name_prefix": "realtimetenant-sdwansitegw",
           "site": [
               {
                   "on_premise_site_info": {
                       "device": [
                           {
                               "device_template": "SRX_Advanced_SDWAN_CPE_option_1",
                               "is_gateway_site": true,
                               "wan_link": [
                                   {
                                       "mesh_tag": [
                                           "germanyMPLS"
                                       ],
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/0",
                                       "used_for_meshing": true,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.200.1",
                                           "ip_address": "192.168.200.254/24"
                                       },
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "mesh_tag": [
                                           "germanyINTERNET"
                                       ],
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/1",
                                       "used_for_meshing": true,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.201.1",
                                           "ip_address": "192.168.201.254/24"
                                       },
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   }
                               ],
                               "device_name": "sdwansitegw",
                               "device_family": "juniper-srx",
                               "device_details": {
                                   "serial_number": "CZ0417AF0130"
                               },
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.2/32"
                               }
                           }
                       ],
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "region": "regional",
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       }
                   },
                   "site_name": "sdwansitegw",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }
   

|image984|

Here are the three JSON Files of all Spokes to repeat this easly

.. hidden-code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "sdwansite1",
                   "site_basic_properties": {
                       "local_breakout": {},
                       "gatewaySite": false,
                       "site_type": "on_premise",
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": false,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "wan_link_type": "MPLS",
                                       "provider": "abc",
                                       "wan_link": "WAN_0",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "6f016152-5db3-ac61-0e6c-e5ddd1068fc3",
                                       "cost": 2222,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "wan_link_type": "Internet",
                                       "provider": "xyz",
                                       "wan_link": "WAN_1",
                                       "subscribed_bandwidth": 1000,
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "9f13da3f-55b5-54f3-d66d-1e49a37e60d5",
                                       "cost": 111,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "SRX_Advanced_SDWAN_CPE_option_1",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "10.88.88.1/24",
                                       "lan_segment_name": "desktop2",
                                       "vlan": 1088,
                                       "lan_ports": [
                                           "LAN_4"
                                       ],
                                       "department": "Default",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwansite1"
                           }
                       ],
                       "0": {
                           "ip_prefix": "10.88.88.1/24",
                           "lan_segment_name": "desktop2",
                           "vlan": 1088,
                           "lan_ports": [
                               "LAN_4"
                           ],
                           "department": "Default",
                           "dhcp": false
                       },
                       "site_role": "SPOKE",
                       "sla_mgmt": "FINE",
                       "device_profile_name": "SRX as SD-WAN CPE",
                       "site_name": "sdwansite1",
                       "site_group": null,
                       "dvpn_params": {
                           "delete_dvpn_threshold": 2,
                           "create_dvpn_threshold": 5
                       },
                       "topology": "Real-Time Optimized"
                   }
               }
           ]
       }
   }
   

.. hidden-code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "deployment_scenario": "managed_wan_v2",
           "site": [
               {
                   "site_name": "sdwansite2",
                   "site_basic_properties": {
                       "local_breakout": {},
                       "gatewaySite": false,
                       "site_type": "on_premise",
                       "cloud_service": "EDGE",
                       "site_address": {
                           "country": "US"
                       },
                       "device_redundancy": false,
                       "network_seg": false,
                       "device_template": [
                           {
                               "wan_link_info": [
                                   {
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "provider": "abc",
                                       "wan_link": "WAN_0",
                                       "access_type": "Ethernet",
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "1f430c65-b556-90b4-c8c9-564524c56797",
                                       "cost": 2222,
                                       "subscribed_bandwidth": 1000,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   },
                                   {
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "provider": "xyz",
                                       "wan_link": "WAN_1",
                                       "access_type": "Ethernet",
                                       "exclusive_for_local_breakout": false,
                                       "_sys_reserved_row": "77e68393-040d-b423-df33-b0c8cd02faa3",
                                       "cost": 111,
                                       "subscribed_bandwidth": 1000,
                                       "default_link": true,
                                       "local_breakout_enabled": false,
                                       "cost_currency": "USD",
                                       "preferred_breakout_link": false,
                                       "backup_link": false
                                   }
                               ],
                               "template_name": "NFX_Advanced_SDWAN_CPE_option_1",
                               "lan_segment": [
                                   {
                                       "ip_prefix": "10.66.66.1/24",
                                       "lan_segment_name": "desktop4",
                                       "vlan": 1066,
                                       "lan_ports": [
                                           "LAN_0"
                                       ],
                                       "department": "Default",
                                       "dhcp": false
                                   }
                               ],
                               "device_name": "sdwansite2"
                           }
                       ],
                       "0": {
                           "ip_prefix": "10.66.66.1/24",
                           "lan_segment_name": "desktop4",
                           "vlan": 1066,
                           "lan_ports": [
                               "LAN_0"
                           ],
                           "department": "Default",
                           "dhcp": false
                       },
                       "site_role": "SPOKE",
                       "sla_mgmt": "FINE",
                       "device_profile_name": "NFX250 as SD-WAN CPE",
                       "site_name": "sdwansite2",
                       "site_group": null,
                       "dvpn_params": {
                           "delete_dvpn_threshold": 2,
                           "create_dvpn_threshold": 5
                       },
                       "topology": "Real-Time Optimized"
                   }
               }
           ]
       }
   }
   

.. hidden-code-block:: none

   
   {
      "input":{
         "tenant_name":"realtimetenant",
         "deployment_scenario":"managed_wan_v2",
         "site":[
            {
               "site_name":"sdwansite3",
               "site_basic_properties":{
                  "0":{
                     "dhcp":false,
                     "department":"Default",
                     "lan_ports":[
                        "LAN_0"
                     ],
                     "lan_segment_name":"desktop3",
                     "vlan":1077,
                     "ip_prefix":"10.77.77.1/24"
                  },
                  "topology":"Real-Time Optimized",
                  "sla_mgmt":"FINE",
                  "network_seg":false,
                  "gatewaySite":false,
                  "site_role":"SPOKE",
                  "site_address":{
                     "country":"US"
                  },
                  "site_group":null,
                  "site_name":"sdwansite3",
                  "device_redundancy":false,
                  "device_profile_name":"NFX250 as SD-WAN CPE",
                  "cloud_service":"EDGE",
                  "site_type":"on_premise",
                  "dvpn_params":{
                     "create_dvpn_threshold":5,
                     "delete_dvpn_threshold":2
                  },
                  "device_template":[
                     {
                        "template_name":"NFX_Advanced_SDWAN_CPE_option_1",
                        "device_name":"sdwansite3",
                        "wan_link_info":[
                           {
                              "wan_link":"WAN_0",
                              "wan_link_type":"MPLS",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"abc",
                              "cost":2222,
                              "_sys_reserved_row":"e8302d43-1d40-0d01-c02d-ea4174be25b8",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           },
                           {
                              "wan_link":"WAN_1",
                              "wan_link_type":"Internet",
                              "access_type":"Ethernet",
                              "enable_pppoe":false,
                              "cost_currency":"USD",
                              "local_breakout_enabled":false,
                              "exclusive_for_local_breakout":false,
                              "subscribed_bandwidth":1000,
                              "provider":"xyz",
                              "cost":111,
                              "_sys_reserved_row":"95354486-63b5-fade-392e-ca938e35cb56",
                              "default_link":true,
                              "backup_link":false,
                              "preferred_breakout_link":false
                           }
                        ],
                        "lan_segment":[
                           {
                              "dhcp":false,
                              "department":"Default",
                              "lan_ports":[
                                 "LAN_0"
                              ],
                              "lan_segment_name":"desktop3",
                              "vlan":1077,
                              "ip_prefix":"10.77.77.1/24"
                           }
                        ]
                     }
                  ]
               }
            }
         ]
      }
   }
   

JSON of sdwansite1

.. hidden-code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "job_name_prefix": "realtimetenant-sdwansite1",
           "site": [
               {
                   "on_premise_site_info": {
                       "gateway_sites": [
                           {
                               "gateway_role": "PRIMARY_GW",
                               "gateway_name": "sdwansitegw"
                           }
                       ],
                       "region": "regional",
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       },
                       "device": [
                           {
                               "device_template": "SRX_Advanced_SDWAN_CPE_option_1",
                               "is_gateway_site": false,
                               "wan_link": [
                                   {
                                       "mesh_tag": [
                                           "germanyMPLS"
                                       ],
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/0",
                                       "used_for_meshing": true,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.170.1",
                                           "ip_address": "192.168.170.2/24"
                                       },
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "mesh_tag": [
                                           "germanyINTERNET"
                                       ],
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/1",
                                       "used_for_meshing": true,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.173.1",
                                           "ip_address": "192.168.173.2/24"
                                       },
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "traffic_type": "DATA_ONLY",
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   }
                               ],
                               "device_name": "sdwansite1",
                               "device_family": "juniper-srx",
                               "device_details": {
                                   "serial_number": "CV2116AF0288"
                               },
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.3/32"
                               }
                           }
                       ]
                   },
                   "site_name": "sdwansite1",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }
   

JSON of sdwansite2

.. hidden-code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "job_name_prefix": "realtimetenant-sdwansite2",
           "site": [
               {
                   "on_premise_site_info": {
                       "gateway_sites": [
                           {
                               "gateway_role": "PRIMARY_GW",
                               "gateway_name": "sdwansitegw"
                           }
                       ],
                       "region": "regional",
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       },
                       "device": [
                           {
                               "is_gateway_site": false,
                               "wan_link": [
                                   {
                                       "mesh_tag": [
                                           "germanyMPLS"
                                       ],
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/10",
                                       "used_for_meshing": true,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "traffic_type": "OAM_AND_DATA",
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.130.1",
                                           "ip_address": "192.168.130.2/24"
                                       },
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "mesh_tag": [
                                           "germanyINTERNET"
                                       ],
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/11",
                                       "used_for_meshing": true,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "traffic_type": "DATA_ONLY",
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.133.1",
                                           "ip_address": "192.168.133.2/24"
                                       },
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   }
                               ],
                               "device_name": "sdwansite2",
                               "device_template": "NFX_Advanced_SDWAN_CPE_option_1",
                               "device_details": {
                                   "serial_number": "DD2116AF0059"
                               },
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.4/32"
                               }
                           }
                       ]
                   },
                   "site_name": "sdwansite2",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }
   

JSON of sdwansite3

.. hidden-code-block:: none

   
   {
       "input": {
           "tenant_name": "realtimetenant",
           "job_name_prefix": "realtimetenant-sdwansite3",
           "site": [
               {
                   "on_premise_site_info": {
                       "gateway_sites": [
                           {
                               "gateway_role": "PRIMARY_GW",
                               "gateway_name": "sdwansitegw"
                           }
                       ],
                       "region": "regional",
                       "hub_sites": [
                           {
                               "hub_role": "PRIMARY",
                               "hub_name": "hub1"
                           }
                       ],
                       "site_role": "spoke",
                       "ha_info": {
                           "ha_topology": "STANDALONE"
                       },
                       "device": [
                           {
                               "is_gateway_site": false,
                               "wan_link": [
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_0",
                                                   "internet_gw_ip": "192.168.190.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "MPLS",
                                       "local_interface": "ge-0/0/10",
                                       "used_for_meshing": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "traffic_type": "OAM_AND_DATA",
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.150.1",
                                           "ip_address": "192.168.150.2/24"
                                       },
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_0",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   },
                                   {
                                       "overlay_tunnel": [
                                           {
                                               "peer_info": {
                                                   "interface_name": "WAN_1",
                                                   "internet_gw_ip": "192.168.191.1",
                                                   "peer_device": "hub1"
                                               },
                                               "tunnel_endpoint_role": "SPOKE",
                                               "tunnel_type": "GRE_IPSEC",
                                               "tunnel_id": 0
                                           }
                                       ],
                                       "enable_pppoe": false,
                                       "wan_link_type": "Internet",
                                       "local_interface": "ge-0/0/11",
                                       "used_for_meshing": false,
                                       "nat_info": {
                                           "nat_enabled": false
                                       },
                                       "access_type": "Ethernet",
                                       "traffic_type": "DATA_ONLY",
                                       "connect_to_hubs": true,
                                       "local_breakout_enabled": false,
                                       "used_for_oam": true,
                                       "static_ip_assignment": {
                                           "gateway_ip": "192.168.153.1",
                                           "ip_address": "192.168.153.2/24"
                                       },
                                       "vpn": [
                                           {
                                               "vpn_name": "realtimetenant_DefaultVPN"
                                           }
                                       ],
                                       "wan_link_name": "WAN_1",
                                       "address_assignment": "STATIC",
                                       "mesh_overlay_link_type": "GRE_IPSEC"
                                   }
                               ],
                               "device_name": "sdwansite3",
                               "device_template": "NFX_Advanced_SDWAN_CPE_option_1",
                               "device_details": {
                                   "serial_number": "DD1816AF0024"
                               },
                               "oam_traffic": {
                                   "ip_prefix": "192.168.210.5/32"
                               }
                           }
                       ]
                   },
                   "site_name": "sdwansite3",
                   "properties": {
                       "property": [
                           {
                               "name": "site_advanced_config",
                               "value": {
                                   "timezone": "Europe/Amsterdam",
                                   "nameserver": [
                                       "8.8.8.8"
                                   ]
                               }
                           }
                       ]
                   }
               }
           ]
       }
   }
   

Enable Traffic latency on both paths via the Delay VM.

.. code-block:: none

   virsh console delayvm --force

   tc qdisc add dev eth0.132 root netem delay 10ms
   tc qdisc add dev eth0.135 root netem delay 10ms

.. note:: There has been a direct cable patched between the CSO lab and the CC13 lab in slab Amsterdam using QFX5100-121 port xe-0/0/50:0 and xe-0/0/2:0 on Contrail3-mx204 (device name).

Changes on the QFX5100-121 of CSO slab to unbind Desktop1vm and connect with the CC13 environment as BGP-Peer instead

On the mx204

.. code-block:: none

   1.) ssh lab@172.30.51.129 (m0anco)
   2.) ssh root@192.168.42.71 (juniper123)

   set policy-options policy-statement adv-contrail term a from protocol bgp
   set policy-options policy-statement adv-contrail term a then accept

   set interfaces xe-0/0/2:0 description "link to CSO lab qfx5100 xe-0/0/50:0"
   set interfaces xe-0/0/2:0 unit 0 family inet address 192.168.205.254/24

   set routing-instances sdwan instance-type vrf
   set routing-instances sdwan interface xe-0/0/2:0.0
   set routing-instances sdwan route-distinguisher 172.23.0.1:555
   set routing-instances sdwan vrf-target target:64512:555
   set routing-instances sdwan vrf-table-label
   set routing-instances sdwan routing-options static route 0.0.0.0/0 next-hop 192.168.205.1
   set routing-instances sdwan protocols ospf export adv-contrail
   set routing-instances sdwan protocols ospf area 0.0.0.0 interface xe-0/0/2:0.0

   root@contrail3-mx204# show | compare rollback 4
   [edit interfaces]
   +   xe-0/0/2:0 {
   +       description "link to CSO lab qfx5100 xe-0/0/50:0";
   +       unit 0 {
   +           family inet {
   +               address 192.168.205.254/24;
   +           }
   +       }
   +   }
   [edit policy-options]
   +   policy-statement adv-contrail {
   +       term a {
   +           from protocol bgp;
   +           then accept;
   +       }
   +   }
   [edit routing-instances]
   +   sdwan {
   +       instance-type vrf;
   +       interface xe-0/0/2:0.0;
   +       route-distinguisher 172.23.0.1:555;
   +       vrf-target target:64512:555;
   +       vrf-table-label;
   +       routing-options {
   +           static {
   +               route 0.0.0.0/0 next-hop 192.168.205.1;
   +           }
   +       }
   +       protocols {
   +           ospf {
   +               export adv-contrail;
   +               area 0.0.0.0 {
   +                   interface xe-0/0/2:0.0;
   +               }
   +           }
   +       }
   +   }


   root@contrail3-mx204> show route table sdwan

   sdwan.inet.0: 5 destinations, 6 routes (5 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 03:17:44
                       > to 192.168.205.1 via xe-0/0/2:0.0
   10.99.99.3/32      *[BGP/170] 00:00:21, MED 100, localpref 200, from 172.16.81.105
                         AS path: ?, validation-state: unverified
                       > via Tunnel Composite, Push 23
                       [BGP/170] 00:00:21, MED 100, localpref 200, from 172.16.81.108
                         AS path: ?, validation-state: unverified
                       > via Tunnel Composite, Push 23
   192.168.205.0/24   *[Direct/0] 03:17:44
                       > via xe-0/0/2:0.0
   192.168.205.254/32 *[Local/0] 03:17:44
                         Local via xe-0/0/2:0.0
   224.0.0.5/32       *[OSPF/10] 02:05:53, metric 1
                         MultiRecv


   root@contrail3-mx204> show ospf database instance sdwan

       OSPF database, Area 0.0.0.0
    Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len
   Router   192.168.204.1    192.168.204.1    0x80000008  1219  0x22 0x1837  36
   Router  *192.168.205.254  192.168.205.254  0x80000002  1218  0x22 0x1f37  36
   Network *192.168.205.254  192.168.205.254  0x80000001  1218  0x22 0xda85  32
       OSPF AS SCOPE link state database
    Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len
   Extern  *10.99.99.3       192.168.205.254  0x80000002   757  0xa2 0x37bd  36

On the QFX5100 as underlay Switch.

.. code-block:: none

   delete interfaces xe-0/0/48:0 unit 0 family ethernet-switching vlan members 1099

   delete interfaces xe-0/0/50:0 disable
   delete interfaces xe-0/0/50:0
   set interfaces xe-0/0/50:0 description "link to mx80 xe-0/0/2:0"
   set interfaces xe-0/0/50:0 unit 0 family inet address 192.168.205.1/24

   delete groups sdwan-sitegw
   set groups sdwan-sitegw interfaces xe-0/0/42 unit 0 family inet address 192.168.200.1/24
   set groups sdwan-sitegw interfaces xe-0/0/43 unit 0 family inet address 192.168.201.1/24
   set groups sdwan-sitegw interfaces xe-0/0/44 disable
   set groups sdwan-sitegw interfaces xe-0/0/45 disable
   set groups sdwan-sitegw interfaces xe-0/0/46 unit 0 family inet address 192.168.204.1/24
   set groups sdwan-sitegw policy-options policy-statement export-sitegw term sitegw-net from protocol ospf
   set groups sdwan-sitegw policy-options policy-statement export-sitegw term sitegw-net then accept
   set groups sdwan-sitegw routing-instances hub-wan0 interface xe-0/0/42.0
   set groups sdwan-sitegw routing-instances hub-wan1 interface xe-0/0/43.0
   set groups sdwan-sitegw routing-instances sitegw instance-type virtual-router
   set groups sdwan-sitegw routing-instances sitegw interface xe-0/0/46.0
   set groups sdwan-sitegw routing-instances sitegw interface xe-0/0/50:0.0
   set groups sdwan-sitegw routing-instances sitegw routing-options static route 0.0.0.0/0 next-hop 192.168.204.254
   set groups sdwan-sitegw routing-instances sitegw routing-options autonomous-system 65100
   set groups sdwan-sitegw routing-instances sitegw protocols bgp group ebgp type external
   set groups sdwan-sitegw routing-instances sitegw protocols bgp group ebgp export export-sitegw
   set groups sdwan-sitegw routing-instances sitegw protocols bgp group ebgp peer-as 64512
   set groups sdwan-sitegw routing-instances sitegw protocols bgp group ebgp neighbor 192.168.204.254
   set groups sdwan-sitegw routing-instances sitegw protocols ospf area 0.0.0.0 interface xe-0/0/50:0.0


   root@qfx5100-121> show ospf database instance sitegw

       OSPF database, Area 0.0.0.0
    Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len
   Router  *192.168.204.1    192.168.204.1    0x80000008  1278  0x22 0x1837  36
   Router   192.168.205.254  192.168.205.254  0x80000002  1279  0x22 0x1f37  36
   Network  192.168.205.254  192.168.205.254  0x80000001  1279  0x22 0xda85  32
       OSPF AS SCOPE link state database
    Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len
   Extern   10.99.99.3       192.168.205.254  0x80000002   818  0xa2 0x37bd  36

   root@qfx5100-121> show route table sitegw.inet.0

   sitegw.inet.0: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[Static/5] 2d 21:58:21
                       > to 192.168.204.254 via xe-0/0/46.0
   10.99.99.3/32      *[OSPF/150] 00:14:04, metric 100, tag 3489725440
                       > to 192.168.205.254 via xe-0/0/50:0.0
   192.168.204.0/24   *[Direct/0] 2d 21:58:21
                       > via xe-0/0/46.0
   192.168.204.1/32   *[Local/0] 2d 21:58:21
                         Local via xe-0/0/46.0
   192.168.205.0/24   *[Direct/0] 03:13:16
                       > via xe-0/0/50:0.0
   192.168.205.1/32   *[Local/0] 03:13:16
                         Local via xe-0/0/50:0.0
   224.0.0.5/32       *[OSPF/10] 02:20:44, metric 1
                         MultiRecv

.. warning:: Configure the desktop1-lan 10.99.99.0/24 and apply as address group to the rule as well.

|image985|

|image986|

|image987|

|image988|

|image989|

|image990|

|image991|

.. code-block:: none

   root@GWR.sdwansite2.realtimetenant> show route table LAN-realtimetenant_DefaultVPN

   LAN-realtimetenant_DefaultVPN.inet.0: 7 destinations, 11 routes (7 active, 0 holddo
   + = Active Route, - = Last Active, * = Both

   0.0.0.0/0          *[BGP/170] 2d 22:07:33, localpref 300, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 18
                         via gr-0/0/0.4000, Push 18
                       [BGP/170] 5d 23:20:49, localpref 200, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4002, Push 16
                         via gr-0/0/0.4003, Push 16
   10.66.66.0/24      *[Direct/0] 1w0d 01:32:31
                       > via ge-0/0/4.1066
   10.66.66.1/32      *[Local/0] 1w0d 01:32:31
                         Local via ge-0/0/4.1066
   10.77.77.0/24      *[BGP/170] 2d 22:10:36, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4000, Push 18
   10.88.88.0/24      *[BGP/170] 5d 22:54:48, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4004, Push 16
                       > via gr-0/0/0.4005, Push 16
                       [BGP/170] 2d 22:10:36, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                         via gr-0/0/0.4001, Push 18
                       > via gr-0/0/0.4000, Push 18
   10.99.99.3/32      *[BGP/170] 00:11:14, MED 100, localpref 100, from 192.168.10.49
                         AS path: 65100 I, validation-state: unverified
                         via gr-0/0/0.4001, Push 21
                       > via gr-0/0/0.4000, Push 21
   192.168.204.0/24   *[BGP/170] 2d 22:07:33, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 18
                         via gr-0/0/0.4000, Push 18
                       [BGP/170] 2d 21:55:31, localpref 100, from 192.168.10.49
                         AS path: I, validation-state: unverified
                       > via gr-0/0/0.4001, Push 21
                         via gr-0/0/0.4000, Push 21

|image992|

Open Automation items (for future enhancements)
-----------------------------------------------

.. warning:: /\* fixme this chapter is currently work-in-progress! Review chapter 8.15 above for the STABLE automation pieces that we provide as of now \*/

This Python code installs the CSO Tarball complete in KVM environments. You just need to run it and after 40minutes all tasks from chapter 3.2.7 to chapter 3.2.8 above have been automatically done with no keyboard input from your side required.

**DOWNLOAD**
`cso-401-installer.tgz <cso-401-installer.tgz>`__


|image993|

The above is an embedded object. It’s known to work for Word on Windows users that they can export this.

The code below is a Python-Script to reset a NFX250 to the initial lab configuration of this reference lab. The code is modified from the original “recall_device.sh” of the CSO tarball. If one wants you can exchange the original file and each time you delete an NFX250 in CSO it would automatically get the start configuration for this lab without you required to zeroize it and so on.

.. hidden-code-block:: none

   
   #!/usr/bin/env python
   import logging
   import argparse
   import getpass
   import grp
   import sys
   import re
   import subprocess
   import os
   import time
   import atexit
   import paramiko
   import signal
   from paramiko import AutoAddPolicy
   
   app_logger = None
   
   def get_app_logging():
   
       logger = logging.getLogger("init_device")
       hdlr = logging.FileHandler('/tmp/init_device.log')
       formatter = logging.Formatter('%(asctime)s %(levelname)s %(message)s')
       hdlr.setFormatter(formatter)
       logger.addHandler(hdlr)
       logger.setLevel(logging.INFO)
       return logger
   
   
   def parse_cmd_options():
       print "Parse command line arguments\n"
   
       parser = argparse.ArgumentParser(description='Run env init script')
   
       parser.add_argument('--jdm_user', help='Userid that CSP uses to SSH to the NFX')
       parser.add_argument('--encrypted_root_password', help='root password to be burnt on jvm')
   
       opt = parser.parse_args(sys.argv[1:])
       opt.debug = True
   
       # print out cmd option for debugging purpose
       print sys.argv[1:]
       app_logger.info("Command Line Arguments:")
       app_logger.info(sys.argv[1:])
       return opt
   
   
   class SwitchConn:
   
       CMD_LOAD_FACTORY_DEFAULT = "load factory-default"
   
       # commands for JDM
       CLI_GET_OOB_SSH = "show configuration system services outbound-ssh"
       CMD_DEL_JSXE_INTF = "delete interfaces jsxe0"
       CMD_DEL_USER_CSP = "delete system login user csp"
       CMD_DEL_USER_CSPAGENT = "delete system login user cspagent"
       CMD_DEL_DEPARTMENTS = "delete groups"
       CMD_SHOW_VNFS = "show virtual-network-functions"
       CMD_DEL_GWR = "delete virtual-network-functions %s"
       CMD_DEL_VNF = "delete virtual-network-functions %s"
       CMD_DEL_OOB_SSH = "delete system services outbound-ssh"
       CMD_DEL_JDM_3RD_PARTY = "rm -rf /var/third-party/CSP"
       CMD_DEL_TELEMETRY_AGENT = "rm -rf /etc/telemetry_agent"
   
       # commands on JVM
       LOAD_JVM_FACTORY_DEFAULT = "load factory-default"
       CFG_ROOT_AUTH = 'set system root-authentication encrypted-password "%s"'
       CFG_ROOT_KEY = 'set system root-authentication ssh-ecdsa "%s"'
       CFG_SYSUSER_KEY = 'set system login user jdm-sysuser authentication ssh-ecdsa "%s"'
       CFG_ROOT_AUTH_JVM = 'set system root-authentication plain-text-password-value "%s"; commit and-quit'
       SHOW_FILES_IN_VAR_TMP = "file list /var/tmp"
   
   
       # regx used to find parameters
       REGX_IP = r"\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b"
       REGX_OOB_CLIENT = r'client (.*?) {'
       REGX_VNF = r"<.*?>"
   
       def __init__(self, opts, pidfile, stdin='/dev/null', stdout='/dev/null', stderr='/dev/null'):
   
           self.gwr = None
           self.jdm_user = opts.jdm_user
           self.enc_paswd = opts.encrypted_root_password
           self.vnfs = []
           self.stdin = stdin
           self.stdout = stdout
           self.stderr = stderr
           self.pidfile = pidfile
   
       def find_key(self, reg_str, ctxt):
           pat = re.compile(reg_str)
           matchObj = re.findall(pat, ctxt)
           if matchObj:
               key = matchObj[0]
           else:
               key = None
           return key
   
   
   
       def clicmd_get(self, cmd):
   
           cli_cmd = 'cli -c "' + cmd + '| display xml" > /tmp/res_vnf_get'
           os.system(cli_cmd)
           res = subprocess.check_output(["cat", "/tmp/res_vnf_get"])
           return res
   
   
       def get_oobssh_client(self):
   
           ctxt = self.clicmd_get(SwitchConn.CLI_GET_OOB_SSH)
           client_id = self.find_key(SwitchConn.REGX_OOB_CLIENT, ctxt)
           cso_ip = self.find_key(SwitchConn.REGX_IP, ctxt)
   
           return client_id, cso_ip
   
   
       def daemonize(self):
   
           try:
                   pid = os.fork()
                   if pid > 0:
                           # exit first parent
                           sys.exit(0)
           except OSError, e:
                   sys.stderr.write("fork #1 failed: %d (%s)\n" % (e.errno, e.strerror))
                   sys.exit(1)
   
           # decouple from parent environment
           os.chdir("/")
           os.setsid()
           os.umask(0)
   
           # do second fork
           try:
                   pid = os.fork()
                   if pid > 0:
                           # exit from second parent
                           sys.exit(0)
           except OSError, e:
                   sys.stderr.write("fork #2 failed: %d (%s)\n" % (e.errno, e.strerror))
                   sys.exit(1)
   
           # redirect standard file descriptors
           sys.stdout.flush()
           sys.stderr.flush()
           si = file(self.stdin, 'r')
           so = file(self.stdout, 'a+')
           se = file(self.stderr, 'a+', 0)
           os.dup2(si.fileno(), sys.stdin.fileno())
           os.dup2(so.fileno(), sys.stdout.fileno())
           os.dup2(se.fileno(), sys.stderr.fileno())
   
           # write pidfile
           atexit.register(self.delpid)
           pid = str(os.getpid())
           file(self.pidfile,'w+').write("%s\n" % pid)
   
       def delpid(self):
                   os.remove(self.pidfile)
   
       def create_config_cmd(self, configCommand):
           # root user directly lands on console, others land on cli mode
           if self.jdm_user == 'root':
               cmd = 'cli -c \'edit; ' + configCommand + '; \''
           else:
               cmd = 'edit; ' + configCommand + '; '
           return cmd
   
       def create_cli_cmd(self, opCommand):
           if self.gwr_user == 'root':
               cmd = 'cli -c \'' + opCommand + '\''
           else:
               cmd = opCommand
           return cmd
   
       def exec_config_cmd_without_commit(self, configcommand):
           cmd  = 'cli -c \'edit; ' + configcommand + '; \''
           app_logger.info("Sending cmd: " + cmd)
           os.system(cmd)
   
       def exec_config_cmd(self, configcommand):
           cmd  = 'cli -c \'edit; ' + configcommand + '; commit and-quit; \''
           app_logger.info("Sending cmd: " + cmd)
           os.system(cmd)
   
       def start(self):
   
           RETRY_CNT = 4
           RETRY_INTERVAL = 30
           pid = None
   
           print "####  Start the daemon  ####"
   
           for i in range(0, RETRY_CNT):
               try:
                   pf = file(self.pidfile,'r')
                   pid = int(pf.read().strip())
                   pf.close()
                   if not self.is_process_running(pid, pname="recall_device"):
                       pid = None
               except IOError:
                   pid = None
   
               if not pid:
                   break
   
               app_logger.warning("[Try %d/%d] Previous daemon pid=%s is still running",
                                   i, RETRY_CNT, pid)
               time.sleep(RETRY_INTERVAL)
   
           if pid:
               app_logger.warning("Previous daemon pid=%s seems to have hung. killing it", pid)
               try:
                   os.kill(pid, signal.SIGTERM)
                   os.remove(self.pidfile)
               except OSError as err:
                   app_logger.warning("Error occured in killing the deamon: %s" % str(err))
   
           # Start the daemon
           self.daemonize()
           try:
               self.run()
           except Exception as e:
               import traceback
               traceback.print_exc()
               app_logger.error("Exception %s " % str(e))
   
   
       def is_process_running(self, pid, pname):
           """ returns True if the pid is actually running on the device """
   
           cmd = "ps -o cmd= %s" % pid
           proc = subprocess.Popen(cmd, shell=True, stdin=None,
                                   stdout=subprocess.PIPE, stderr=subprocess.PIPE)
   
           (output, err) = proc.communicate()
           if proc.returncode != 0:
               return False
   
           # check if the process name is same as the one passed.
           return pname in output
   
       def jdm_delete_3rdparty(self):
           os.system(SwitchConn.CMD_DEL_JDM_3RD_PARTY)
   
       def jdm_delete_telemetry_agent(self):
           os.system(SwitchConn.CMD_DEL_TELEMETRY_AGENT)
   
       def jdm_load_default(self):
           #cmd = self.create_config_cmd(SwitchConn.CMD_LOAD_FACTORY_DEFAULT)
           cmd = SwitchConn.CMD_LOAD_FACTORY_DEFAULT
           app_logger.info("Sending " + cmd)
           #os.system(cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           # Specify the encrypted root from the profile. Password=juniper123
           cmd = 'set system root-authentication encrypted-password "$6$jwzbJ$YPKRY59jtJ2T6YKX2B9hxyokfo7lXH94OBs9ATHZSTIzjD4Mo93NrPARFZT7SUn9bTsx8k5IVWGelRU4bh0t/."'
           with open("/tmp/1.conf", "w+") as text_file:
               text_file.write(cmd)
           app_logger.info("Generated /tmp/1.conf file")
           configCommand = 'load set /tmp/1.conf'
           app_logger.info("Executing " + configCommand)
           self.exec_config_cmd(configCommand)
   
           os.system('rm /tmp/1.conf')
           app_logger.info("Removed /tmp/1.conf file")
   
   
           #configCommand = "commit"
           #self.exec_config_cmd(configcommand)
   
   
       def jdm_load_lab_tweaks(self):
   
           cmd = "set system host-name nfx250"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "set system memory hugepages page-size 1024 page-count 13"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "delete interfaces jmgmt0 unit 0"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "delete system phone-home server https://redirect.juniper.net"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "set system phone-home server https://centralmsvm.example.net"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "set system phone-home traceoptions file phc.log"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "set system phone-home traceoptions flag all"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "set system name-server 192.168.10.10"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "commit"
           self.exec_config_cmd(cmd)
           time.sleep(30)
   
       def jdm_dhcp_reinit(self):
           cmd = "set interfaces jmgmt0 unit 0 family inet dhcp"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "commit"
           self.exec_config_cmd(cmd)
           time.sleep(10)
   
           cmd = "delete interfaces jmgmt0"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "delete interfaces jsxe0 unit 0 family inet dhcp"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "commit"
           self.exec_config_cmd(cmd)
           time.sleep(10)
   
           cmd = "set interfaces jsxe0 unit 0 family inet dhcp"
           app_logger.info("Sending " + cmd)
           self.exec_config_cmd_without_commit(cmd)
   
           cmd = "commit"
           self.exec_config_cmd(cmd)
           time.sleep(10)
   
       def jvm_load_default(self):
           client = paramiko.SSHClient()
           client.load_system_host_keys()
           client.set_missing_host_key_policy(AutoAddPolicy())
   
           count = 0
           while count < 3:
               try:
                   client.connect("vjunos0", username=self.jdm_user, password=None)
                   break
               except Exception as e:
                   app_logger.error("Failed to connect to JVM: " + str(e))
                   count = count + 1
               time.sleep(10)
   
           if count == 3:
               count = 0
               while count < 3:
                   try:
                       client.connect("vjunos0", username="root", password="Embe1mpls")
                       break
                   except Exception as e:
                       app_logger.error("Failed to connect to JVM: " + str(e))
                       count = count + 1
                   time.sleep(10)
               if count == 3:
                   app_logger.error("Failed to connect to JVM in 30 sec. Give up.")
                   # need to rollback committed config
                   return
   
           app_logger.info("### EXEC commands on JVM")
           self.jdm_user = 'root'
           app_logger.info("Trying to save config")
           configCommand = "save /var/tmp/current-config.txt"
           cmd = self.create_config_cmd(configCommand)
           app_logger.info("Sending cmd: " + cmd)
           stdin, stdout, stderr = client.exec_command(cmd)
           for line in stdout:
               app_logger.info('... ' + line.strip('\n'))
   
           # extract root password from config
           self.jdm_user = 'cli'
           app_logger.info("Trying to read root password and key")
           cmd = "cat /var/tmp/current-config.txt"
           app_logger.info("Sending cmd: " + cmd)
           stdin, stdout, stderr = client.exec_command(cmd)
           enc_jvmr_pwd = ""
           p = re.compile('.*encrypted-password(.*)\"(.*?)\"')
           enc_jvmr_key = ""
           r = re.compile('.*ssh-ecdsa(.*)\"(.*?)\"')
           for line in stdout:
               m = p.search(line.strip('\n'))
               if m != None and len(m.group(2)) >= 15 and len(enc_jvmr_pwd) <= 9:
                 enc_jvmr_pwd = m.group(2)
               n = r.search(line.strip('\n'))
               if n != None and len(n.group(2)) >= 15 and len(enc_jvmr_key) <= 9:
                 enc_jvmr_key = n.group(2)
               app_logger.info('... ' + line.strip('\n'))
   
           app_logger.info("Extacted Root password: " + enc_jvmr_pwd)
           app_logger.info("Extacted Root key: " + enc_jvmr_key)
   
           self.jdm_user = 'root'
           # use the big hammer and restore factory
           app_logger.info("Trying to load factory default")
           configCommand = SwitchConn.LOAD_JVM_FACTORY_DEFAULT
           cmd = self.create_config_cmd(configCommand)
           app_logger.info("Sending cmd: " + cmd)
           stdin, stdout, stderr = client.exec_command(cmd)
           for line in stdout:
               app_logger.info('... ' + line.strip('\n'))
   
           # Specify the Junos OS-encrypted root password to be set.
           app_logger.info("Trying to set root password ")
           if len (enc_jvmr_pwd) <= 9:
             enc_jvmr_pwd = '$1$sm0FT7Qk$dhusS5V574MHoyEKqyyxW0'
           configCommand = SwitchConn.CFG_ROOT_AUTH % enc_jvmr_pwd
           cmd = self.create_config_cmd(configCommand)
           app_logger.info("Sending cmd: " + cmd)
           stdin, stdout, stderr = client.exec_command(cmd)
           for line in stdout:
               app_logger.info('... ' + line.strip('\n'))
   
           # Specify the Junos OS-encrypted root key to be set.
           app_logger.info("Trying to set root key")
           configCommand = SwitchConn.CFG_ROOT_KEY % enc_jvmr_key
           cmd = self.create_config_cmd(configCommand)
           app_logger.info("Sending cmd: " + cmd)
           stdin, stdout, stderr = client.exec_command(cmd)
           for line in stdout:
               app_logger.info('... ' + line.strip('\n'))
   
           # 1 jdm-sysuser
           configCommand = "set system login user jdm-sysuser uid 2000"
           cmd = self.create_config_cmd(configCommand)
           app_logger.info("Sending cmd: " + cmd)
           stdin, stdout, stderr = client.exec_command(cmd)
           for line in stdout:
               app_logger.info('... ' + line.strip('\n'))
   
           # 2 jdm-sysuser
           configCommand = "set system login user jdm-sysuser class super-user"
           cmd = self.create_config_cmd(configCommand)
           app_logger.info("Sending cmd: " + cmd)
           stdin, stdout, stderr = client.exec_command(cmd)
           for line in stdout:
               app_logger.info('... ' + line.strip('\n'))
   
           # 3 jdm-sysuser
           app_logger.info("Trying to set SYSUSER key")
           configCommand = SwitchConn.CFG_SYSUSER_KEY % enc_jvmr_key
           cmd = self.create_config_cmd(configCommand)
           app_logger.info("Sending cmd: " + cmd)
           stdin, stdout, stderr = client.exec_command(cmd)
           for line in stdout:
               app_logger.info('... ' + line.strip('\n'))
   
   
           configCommand = "commit"
           app_logger.info("Trying to commit config on JVM...")
           cmd = self.create_config_cmd(configCommand)
           app_logger.info("Sending cmd: " + cmd)
           stdin, stdout, stderr = client.exec_command(cmd)
           for line in stdout:
               app_logger.info('... ' + line.strip('\n'))
           app_logger.info("### EXEC commands on JVM -- DONE")
   
           time.sleep(5)
           client.close()
   
   
       def run(self):
   
           # ENFORCE factory defaults on JDM FIRST
           # In JDM, jdm_load_default  and set root-pwd
           app_logger.info("### BEGIN jdm_load_default on JDM")
           self.jdm_load_default()
           time.sleep(5)
           app_logger.info("### END jdm_load_default on JDM")
   
           # In JDM, jdm_load_lab_tweaks
           app_logger.info("### BEGIN jdm_load_lab_tweaks on JDM")
           self.jdm_load_lab_tweaks()
           time.sleep(5)
           app_logger.info("### END jdm_load_lab_tweaks on JDM")
   
   #        app_logger.info("### BEGIN jdm_patch_certs on JDM")
   #        self.jdm_load_patch_certs()
   #        time.sleep(5)
   #        app_logger.info("### END jdm_patch_certs on JDM")
   
           # In JDM, always do a rm -rf /var/third-party/CSP directory
           app_logger.info("### BEGIN delete /var/third-party/CSP on JDM")
           self.jdm_delete_3rdparty()
           time.sleep(5)
           app_logger.info("### END delete /var/third-party/CSP on JDM")
   
           # In JDM, always do a rm -rf /etc/telemetry_agent directory
           app_logger.info("### BEGIN delete /etc/telemetry_agent on JDM")
           self.jdm_delete_telemetry_agent()
           time.sleep(5)
           app_logger.info("### END delete /etc/telemetry_agent on JDM")
   
           # 2. if recovery.conf not present, try remove config from jdm and jcp
           # inside jvm session check for /var/tmp/recovery.conf
           app_logger.info("### BEGIN load-factory-default on jvm")
           self.jvm_load_default()
           time.sleep(5)
           app_logger.info("### END load-factory-default on jvm")
   
           app_logger.info("### BEGIN dhcp-reinit on jdm")
           self.jdm_dhcp_reinit()
           time.sleep(5)
           app_logger.info("### END dhcp-reinit on jdm")
   
           time.sleep(1)
           app_logger.info("### END program ......")
   
   
   if __name__ == '__main__':
       app_logger = get_app_logging()
       app_logger.info("Start init_device\n")
       opt = parse_cmd_options()
   
       print "Create SwitchConn Object\n"
       daemon = SwitchConn(opt, '/tmp/daemon-init.pid')
   
       daemon.start()
   

Conclusion
==========

This is the end (for now) my Friend. Are you still feeling good?

Go and win the PoC and get the PO from the Customer in.

This is all what counts and why we spend soo much time on it getting this together….

**One last ask from our Team**

If you don’t like our work or have wishes and contributions: Tell us!

If you think this is good and it helps you: **Tell others!**

Enjoy… Hartmut

.. |image0| image:: 1.png
.. |image1| image:: 2.png
.. |image2| image:: 3.png
.. |image3| image:: 4.png
.. |image4| image:: 5.png
.. |image5| image:: 6.x-emf
.. |image6| image:: 7.png
.. |image7| image:: 8.png
.. |image8| image:: 9.png
.. |image9| image:: 10.png
.. |image10| image:: 11.png
.. |image11| image:: 12.png
.. |image12| image:: 13.png
.. |image13| image:: 14.png
.. |image14| image:: 15.png
.. |image15| image:: 16.png
.. |image16| image:: 17.png
.. |image17| image:: 18.png
.. |image18| image:: 19.png
.. |image19| image:: 20.png
.. |image20| image:: 21.png
.. |image21| image:: 22.png
.. |image22| image:: 23.png
.. |image23| image:: 24.png
.. |image24| image:: 25.png
.. |image25| image:: 26.png
.. |image26| image:: 27.png
.. |image27| image:: 28.png
.. |image28| image:: 29.png
.. |image29| image:: 30.png
.. |image30| image:: 31.png
.. |image31| image:: 32.png
.. |image32| image:: 33.png
.. |image33| image:: 34.png
.. |image34| image:: 35.png
.. |image35| image:: 36.png
.. |image36| image:: 37.png
.. |image37| image:: 38.png
.. |image38| image:: 39.png
.. |image39| image:: 40.png
.. |image40| image:: 41.png
.. |image41| image:: 42.png
.. |image42| image:: 43.png
.. |image43| image:: 44.png
.. |image44| image:: 45.png
.. |image45| image:: 46.png
.. |image46| image:: 47.png
.. |image47| image:: 48.png
.. |image48| image:: 49.png
.. |image49| image:: 50.png
.. |image50| image:: 51.png
.. |image51| image:: 52.png
.. |image52| image:: 53.png
.. |image53| image:: 54.png
.. |image54| image:: 55.png
.. |image55| image:: 56.png
.. |image56| image:: 57.png
.. |image57| image:: 58.png
.. |image58| image:: 59.png
.. |image59| image:: 60.png
.. |image60| image:: 61.png
.. |image61| image:: 62.png
.. |image62| image:: 63.png
.. |image63| image:: 64.png
.. |image64| image:: 65.png
.. |image65| image:: 66.png
.. |image66| image:: 67.png
.. |image67| image:: 68.png
.. |image68| image:: 69.png
.. |image69| image:: 70.png
.. |image70| image:: 71.png
.. |image71| image:: 72.png
.. |image72| image:: 73.png
.. |image73| image:: 74.png
.. |image74| image:: 75.png
.. |image75| image:: 76.png
.. |image76| image:: 77.png
.. |image77| image:: 78.png
.. |image78| image:: 79.png
.. |image79| image:: 80.png
.. |image80| image:: 81.png
.. |image81| image:: 82.png
.. |image82| image:: 83.png
.. |image83| image:: 84.png
.. |image84| image:: 85.png
.. |image85| image:: 86.png
.. |image86| image:: 87.png
.. |image87| image:: 88.png
.. |image88| image:: 89.png
.. |image89| image:: 90.png
.. |image90| image:: 91.png
.. |image91| image:: 92.png
.. |image92| image:: 93.png
.. |image93| image:: 94.png
.. |image94| image:: 95.png
.. |image95| image:: 96.png
.. |image96| image:: 97.png
.. |image97| image:: 98.png
.. |image98| image:: 99.png
.. |image99| image:: 100.png
.. |image100| image:: 101.png
.. |image101| image:: 102.png
.. |image102| image:: 103.png
.. |image103| image:: 104.png
.. |image104| image:: 105.png
.. |image105| image:: 106.png
.. |image106| image:: 107.png
.. |image107| image:: 108.png
.. |image108| image:: 109.png
.. |image109| image:: 110.png
.. |image110| image:: 111.png
.. |image111| image:: 112.png
.. |image112| image:: 113.png
.. |image113| image:: 114.png
.. |image114| image:: 115.png
.. |image115| image:: 116.png
.. |image116| image:: 117.png
.. |image117| image:: 118.png
.. |image118| image:: 119.png
.. |image119| image:: 120.png
.. |image120| image:: 121.png
.. |image121| image:: 122.png
.. |image122| image:: 123.png
.. |image123| image:: 124.png
.. |image124| image:: 125.png
.. |image125| image:: 126.png
.. |image126| image:: 127.png
.. |image127| image:: 128.png
.. |image128| image:: 129.png
.. |image129| image:: 130.png
.. |image130| image:: 131.png
.. |image131| image:: 132.png
.. |image132| image:: 133.png
.. |image133| image:: 134.png
.. |image134| image:: 135.png
.. |image135| image:: 136.png
.. |image136| image:: 137.png
.. |image137| image:: 138.png
.. |image138| image:: 139.png
.. |image139| image:: 140.png
.. |image140| image:: 141.png
.. |image141| image:: 142.png
.. |image142| image:: 143.png
.. |image143| image:: 144.png
.. |image144| image:: 145.png
.. |image145| image:: 146.png
.. |image146| image:: 147.png
.. |image147| image:: 148.png
.. |image148| image:: 149.png
.. |image149| image:: 150.png
.. |image150| image:: 151.png
.. |image151| image:: 152.png
.. |image152| image:: 153.png
.. |image153| image:: 154.png
.. |image154| image:: 155.png
.. |image155| image:: 156.png
.. |image156| image:: 157.png
.. |image157| image:: 158.png
.. |image158| image:: 159.png
.. |image159| image:: 160.png
.. |image160| image:: 161.png
.. |image161| image:: 162.png
.. |image162| image:: 163.png
.. |image163| image:: 164.png
.. |image164| image:: 165.png
.. |image165| image:: 166.png
.. |image166| image:: 167.png
.. |image167| image:: 168.png
.. |image168| image:: 169.png
.. |image169| image:: 170.png
.. |image170| image:: 171.png
.. |image171| image:: 172.png
.. |image172| image:: 173.png
.. |image173| image:: 174.png
.. |image174| image:: 175.png
.. |image175| image:: 176.png
.. |image176| image:: 177.png
.. |image177| image:: 178.png
.. |image178| image:: 179.png
.. |image179| image:: 180.png
.. |image180| image:: 181.png
.. |image181| image:: 182.png
.. |image182| image:: 183.png
.. |image183| image:: 184.png
.. |image184| image:: 185.png
.. |image185| image:: 186.png
.. |image186| image:: 187.png
.. |image187| image:: 188.png
.. |image188| image:: 189.png
.. |image189| image:: 190.png
.. |image190| image:: 191.png
.. |image191| image:: 192.png
.. |image192| image:: 193.png
.. |image193| image:: 194.png
.. |image194| image:: 195.png
.. |image195| image:: 196.png
.. |image196| image:: 197.png
.. |image197| image:: 198.png
.. |image198| image:: 199.png
.. |image199| image:: 200.png
.. |image200| image:: 201.png
.. |image201| image:: 202.png
.. |image202| image:: 203.png
.. |image203| image:: 204.png
.. |image204| image:: 205.png
.. |image205| image:: 206.png
.. |image206| image:: 207.png
.. |image207| image:: 208.png
.. |image208| image:: 209.png
.. |image209| image:: 210.png
.. |image210| image:: 211.png
.. |image211| image:: 212.png
.. |image212| image:: 213.png
.. |image213| image:: 214.png
.. |image214| image:: 215.png
.. |image215| image:: 216.png
.. |image216| image:: 217.png
.. |image217| image:: 218.png
.. |image218| image:: 219.png
.. |image219| image:: 220.png
.. |image220| image:: 221.png
.. |image221| image:: 222.png
.. |image222| image:: 223.png
.. |image223| image:: 224.png
.. |image224| image:: 225.png
.. |image225| image:: 226.png
.. |image226| image:: 227.png
.. |image227| image:: 228.png
.. |image228| image:: 229.png
.. |image229| image:: 230.png
.. |image230| image:: 231.png
.. |image231| image:: 232.png
.. |image232| image:: 233.png
.. |image233| image:: 234.png
.. |image234| image:: 235.png
.. |image235| image:: 236.png
.. |image236| image:: 237.png
.. |image237| image:: 238.png
.. |image238| image:: 239.png
.. |image239| image:: 240.png
.. |image240| image:: 241.png
.. |image241| image:: 242.png
.. |image242| image:: 243.png
.. |image243| image:: 244.png
.. |image244| image:: 245.png
.. |image245| image:: 246.png
.. |image246| image:: 247.png
.. |image247| image:: 248.png
.. |image248| image:: 249.png
.. |image249| image:: 250.png
.. |image250| image:: 251.png
.. |image251| image:: 252.png
.. |image252| image:: 253.png
.. |image253| image:: 254.png
.. |image254| image:: 255.png
.. |image255| image:: 256.png
.. |image256| image:: 257.png
.. |image257| image:: 258.png
.. |image258| image:: 259.png
.. |image259| image:: 260.png
.. |image260| image:: 261.png
.. |image261| image:: 262.png
.. |image262| image:: 263.png
.. |image263| image:: 264.png
.. |image264| image:: 265.png
.. |image265| image:: 266.png
.. |image266| image:: 267.png
.. |image267| image:: 268.png
.. |image268| image:: 269.png
.. |image269| image:: 270.png
.. |image270| image:: 271.png
.. |image271| image:: 272.png
.. |image272| image:: 273.png
.. |image273| image:: 274.png
.. |image274| image:: 275.png
.. |image275| image:: 276.png
.. |image276| image:: 277.png
.. |image277| image:: 278.png
.. |image278| image:: 279.png
.. |image279| image:: 280.png
.. |image280| image:: 281.png
.. |image281| image:: 282.png
.. |image282| image:: 283.png
.. |image283| image:: 284.png
.. |image284| image:: 285.png
.. |image285| image:: 286.png
.. |image286| image:: 287.png
.. |image287| image:: 288.png
.. |image288| image:: 289.png
.. |image289| image:: 290.png
.. |image290| image:: 291.png
.. |image291| image:: 292.png
.. |image292| image:: 293.png
.. |image293| image:: 294.png
.. |image294| image:: 295.png
.. |image295| image:: 296.png
.. |image296| image:: 297.x-emf
.. |image297| image:: 298.png
.. |image298| image:: 299.png
.. |image299| image:: 300.png
.. |image300| image:: 301.png
.. |image301| image:: 302.png
.. |image302| image:: 303.png
.. |image303| image:: 304.png
.. |image304| image:: 305.png
.. |image305| image:: 306.png
.. |image306| image:: 307.png
.. |image307| image:: 308.png
.. |image308| image:: 309.png
.. |image309| image:: 310.png
.. |image310| image:: 311.png
.. |image311| image:: 312.png
.. |image312| image:: 313.png
.. |image313| image:: 314.png
.. |image314| image:: 315.png
.. |image315| image:: 316.png
.. |image316| image:: 317.png
.. |image317| image:: 318.png
.. |image318| image:: 319.png
.. |image319| image:: 320.png
.. |image320| image:: 321.png
.. |image321| image:: 322.png
.. |image322| image:: 323.png
.. |image323| image:: 324.png
.. |image324| image:: 325.png
.. |image325| image:: 326.png
.. |image326| image:: 327.png
.. |image327| image:: 328.png
.. |image328| image:: 329.png
.. |image329| image:: 330.png
.. |image330| image:: 331.png
.. |image331| image:: 332.png
.. |image332| image:: 333.png
.. |image333| image:: 334.png
.. |image334| image:: 335.png
.. |image335| image:: 336.png
.. |image336| image:: 337.png
.. |image337| image:: 338.png
.. |image338| image:: 339.png
.. |image339| image:: 340.png
.. |image340| image:: 341.png
.. |image341| image:: 342.png
.. |image342| image:: 343.png
.. |image343| image:: 344.png
.. |image344| image:: 345.png
.. |image345| image:: 346.png
.. |image346| image:: 347.png
.. |image347| image:: 348.png
.. |image348| image:: 349.png
.. |image349| image:: 350.png
.. |image350| image:: 351.png
.. |image351| image:: 352.png
.. |image352| image:: 353.png
.. |image353| image:: 354.png
.. |image354| image:: 355.png
.. |image355| image:: 356.png
.. |image356| image:: 357.png
.. |image357| image:: 358.png
.. |image358| image:: 359.png
.. |image359| image:: 360.png
.. |image360| image:: 361.png
.. |image361| image:: 362.png
.. |image362| image:: 363.png
.. |image363| image:: 364.png
.. |image364| image:: 365.png
.. |image365| image:: 366.png
.. |image366| image:: 367.png
.. |image367| image:: 368.png
.. |image368| image:: 369.png
.. |image369| image:: 370.png
.. |image370| image:: 371.png
.. |image371| image:: 372.png
.. |image372| image:: 373.png
.. |image373| image:: 374.png
.. |image374| image:: 375.png
.. |image375| image:: 376.png
.. |image376| image:: 377.png
.. |image377| image:: 378.png
.. |image378| image:: 379.png
.. |image379| image:: 380.png
.. |image380| image:: 381.png
.. |image381| image:: 382.png
.. |image382| image:: 383.png
.. |image383| image:: 384.png
.. |image384| image:: 385.png
.. |image385| image:: 386.png
.. |image386| image:: 387.png
.. |image387| image:: 388.png
.. |image388| image:: 389.png
.. |image389| image:: 390.png
.. |image390| image:: 391.png
.. |image391| image:: 392.png
.. |image392| image:: 393.png
.. |image393| image:: 394.png
.. |image394| image:: 395.png
.. |image395| image:: 396.png
.. |image396| image:: 397.png
.. |image397| image:: 398.png
.. |image398| image:: 399.png
.. |image399| image:: 400.png
.. |image400| image:: 401.png
.. |image401| image:: 402.png
.. |image402| image:: 403.png
.. |image403| image:: 404.png
.. |image404| image:: 405.png
.. |image405| image:: 406.png
.. |image406| image:: 407.png
.. |image407| image:: 408.png
.. |image408| image:: 409.png
.. |image409| image:: 410.png
.. |image410| image:: 411.png
.. |image411| image:: 412.png
.. |image412| image:: 413.png
.. |image413| image:: 414.png
.. |image414| image:: 415.png
.. |image415| image:: 416.png
.. |image416| image:: 417.png
.. |image417| image:: 418.png
.. |image418| image:: 419.png
.. |image419| image:: 420.png
.. |image420| image:: 421.png
.. |image421| image:: 422.png
.. |image422| image:: 423.png
.. |image423| image:: 424.png
.. |image424| image:: 425.png
.. |image425| image:: 426.png
.. |image426| image:: 427.png
.. |image427| image:: 428.png
.. |image428| image:: 429.png
.. |image429| image:: 430.png
.. |image430| image:: 431.png
.. |image431| image:: 432.png
.. |image432| image:: 433.png
.. |image433| image:: 434.png
.. |image434| image:: 435.png
.. |image435| image:: 436.png
.. |image436| image:: 437.png
.. |image437| image:: 438.png
.. |image438| image:: 439.png
.. |image439| image:: 440.png
.. |image440| image:: 441.png
.. |image441| image:: 442.png
.. |image442| image:: 443.png
.. |image443| image:: 444.png
.. |image444| image:: 445.png
.. |image445| image:: 446.png
.. |image446| image:: 447.png
.. |image447| image:: 448.png
.. |image448| image:: 449.png
.. |image449| image:: 450.png
.. |image450| image:: 451.png
.. |image451| image:: 452.png
.. |image452| image:: 453.png
.. |image453| image:: 454.png
.. |image454| image:: 455.png
.. |image455| image:: 456.png
.. |image456| image:: 457.png
.. |image457| image:: 458.png
.. |image458| image:: 459.png
.. |image459| image:: 460.png
.. |image460| image:: 461.png
.. |image461| image:: 462.x-emf
.. |image462| image:: 463.png
.. |image463| image:: 464.png
.. |image464| image:: 465.png
.. |image465| image:: 466.png
.. |image466| image:: 467.png
.. |image467| image:: 468.png
.. |image468| image:: 469.png
.. |image469| image:: 470.png
.. |image470| image:: 471.png
.. |image471| image:: 472.png
.. |image472| image:: 473.png
.. |image473| image:: 474.png
.. |image474| image:: 475.png
.. |image475| image:: 476.png
.. |image476| image:: 477.png
.. |image477| image:: 478.png
.. |image478| image:: 479.png
.. |image479| image:: 480.png
.. |image480| image:: 481.png
.. |image481| image:: 482.png
.. |image482| image:: 483.png
.. |image483| image:: 484.png
.. |image484| image:: 485.png
.. |image485| image:: 486.png
.. |image486| image:: 487.png
.. |image487| image:: 488.png
.. |image488| image:: 489.png
.. |image489| image:: 490.png
.. |image490| image:: 491.png
.. |image491| image:: 492.png
.. |image492| image:: 493.png
.. |image493| image:: 494.png
.. |image494| image:: 495.png
.. |image495| image:: 496.png
.. |image496| image:: 497.png
.. |image497| image:: 498.png
.. |image498| image:: 499.png
.. |image499| image:: 500.png
.. |image500| image:: 501.png
.. |image501| image:: 502.png
.. |image502| image:: 503.png
.. |image503| image:: 504.png
.. |image504| image:: 505.png
.. |image505| image:: 506.png
.. |image506| image:: 507.png
.. |image507| image:: 508.png
.. |image508| image:: 509.png
.. |image509| image:: 510.png
.. |image510| image:: 511.png
.. |image511| image:: 512.png
.. |image512| image:: 513.png
.. |image513| image:: 514.png
.. |image514| image:: 515.png
.. |image515| image:: 516.png
.. |image516| image:: 517.png
.. |image517| image:: 518.png
.. |image518| image:: 519.png
.. |image519| image:: 520.png
.. |image520| image:: 521.png
.. |image521| image:: 522.png
.. |image522| image:: 523.png
.. |image523| image:: 524.png
.. |image524| image:: 525.png
.. |image525| image:: 526.png
.. |image526| image:: 527.png
.. |image527| image:: 528.png
.. |image528| image:: 529.png
.. |image529| image:: 530.png
.. |image530| image:: 531.png
.. |image531| image:: 532.png
.. |image532| image:: 533.png
.. |image533| image:: 534.png
.. |image534| image:: 535.png
.. |image535| image:: 536.png
.. |image536| image:: 537.png
.. |image537| image:: 538.png
.. |image538| image:: 539.png
.. |image539| image:: 540.png
.. |image540| image:: 541.png
.. |image541| image:: 542.png
.. |image542| image:: 543.png
.. |image543| image:: 544.png
.. |image544| image:: 545.png
.. |image545| image:: 546.png
.. |image546| image:: 547.png
.. |image547| image:: 548.png
.. |image548| image:: 549.png
.. |image549| image:: 550.png
.. |image550| image:: 551.png
.. |image551| image:: 552.png
.. |image552| image:: 553.png
.. |image553| image:: 554.png
.. |image554| image:: 555.png
.. |image555| image:: 556.png
.. |image556| image:: 557.png
.. |image557| image:: 558.png
.. |image558| image:: 559.png
.. |image559| image:: 560.png
.. |image560| image:: 561.png
.. |image561| image:: 562.png
.. |image562| image:: 563.jpeg
.. |image563| image:: 564.png
.. |image564| image:: 565.png
.. |image565| image:: 566.png
.. |image566| image:: 567.png
.. |image567| image:: 568.png
.. |image568| image:: 569.png
.. |image569| image:: 570.png
.. |image570| image:: 571.png
.. |image571| image:: 572.png
.. |image572| image:: 573.png
.. |image573| image:: 574.png
.. |image574| image:: 575.png
.. |image575| image:: 576.png
.. |image576| image:: 577.png
.. |image577| image:: 578.png
.. |image578| image:: 579.png
.. |image579| image:: 580.png
.. |image580| image:: 581.png
.. |image581| image:: 582.png
.. |image582| image:: 583.png
.. |image583| image:: 584.png
.. |image584| image:: 585.png
.. |image585| image:: 586.png
.. |image586| image:: 587.png
.. |image587| image:: 588.png
.. |image588| image:: 589.png
.. |image589| image:: 590.png
.. |image590| image:: 591.png
.. |image591| image:: 592.png
.. |image592| image:: 593.png
.. |image593| image:: 594.png
.. |image594| image:: 595.png
.. |image595| image:: 596.png
.. |image596| image:: 597.png
.. |image597| image:: 598.png
.. |image598| image:: 599.png
.. |image599| image:: 600.png
.. |image600| image:: 601.png
.. |image601| image:: 602.png
.. |image602| image:: 603.png
.. |image603| image:: 604.png
.. |image604| image:: 605.png
.. |image605| image:: 606.png
.. |image606| image:: 607.png
.. |image607| image:: 608.png
.. |image608| image:: 609.png
.. |image609| image:: 610.png
.. |image610| image:: 611.png
.. |image611| image:: 612.png
.. |image612| image:: 613.png
.. |image613| image:: 614.png
.. |image614| image:: 615.png
.. |image615| image:: 616.png
.. |image616| image:: 617.png
.. |image617| image:: 618.png
.. |image618| image:: 619.png
.. |image619| image:: 620.png
.. |image620| image:: 621.png
.. |image621| image:: 622.png
.. |image622| image:: 623.png
.. |image623| image:: 624.png
.. |image624| image:: 625.png
.. |image625| image:: 626.png
.. |image626| image:: 627.png
.. |image627| image:: 628.png
.. |image628| image:: 629.png
.. |image629| image:: 630.png
.. |image630| image:: 631.png
.. |image631| image:: 632.png
.. |image632| image:: 633.png
.. |image633| image:: 634.png
.. |image634| image:: 635.png
.. |image635| image:: 636.png
.. |image636| image:: 637.png
.. |image637| image:: 638.png
.. |image638| image:: 639.png
.. |image639| image:: 640.png
.. |image640| image:: 641.png
.. |image641| image:: 642.png
.. |image642| image:: 643.png
.. |image643| image:: 644.png
.. |image644| image:: 645.png
.. |image645| image:: 646.png
.. |image646| image:: 647.png
.. |image647| image:: 648.png
.. |image648| image:: 649.png
.. |image649| image:: 650.png
.. |image650| image:: 651.png
.. |image651| image:: 652.png
.. |image652| image:: 653.png
.. |image653| image:: 654.png
.. |image654| image:: 655.png
.. |image655| image:: 656.png
.. |image656| image:: 657.png
.. |image657| image:: 658.png
.. |image658| image:: 659.png
.. |image659| image:: 660.png
.. |image660| image:: 661.png
.. |image661| image:: 662.png
.. |image662| image:: 663.png
.. |image663| image:: 664.png
.. |image664| image:: 665.png
.. |image665| image:: 666.png
.. |image666| image:: 667.png
.. |image667| image:: 668.png
.. |image668| image:: 669.png
.. |image669| image:: 670.png
.. |image670| image:: 671.png
.. |image671| image:: 672.png
.. |image672| image:: 673.png
.. |image673| image:: 674.png
.. |image674| image:: 675.png
.. |image675| image:: 676.png
.. |image676| image:: 677.png
.. |image677| image:: 678.png
.. |image678| image:: 679.png
.. |image679| image:: 680.png
.. |image680| image:: 681.png
.. |image681| image:: 682.png
.. |image682| image:: 683.png
.. |image683| image:: 684.png
.. |image684| image:: 685.png
.. |image685| image:: 686.png
.. |image686| image:: 687.png
.. |image687| image:: 688.png
.. |image688| image:: 689.png
.. |image689| image:: 690.png
.. |image690| image:: 691.png
.. |image691| image:: 692.png
.. |image692| image:: 693.png
.. |image693| image:: 694.png
.. |image694| image:: 695.png
.. |image695| image:: 696.png
.. |image696| image:: 697.png
.. |image697| image:: 698.png
.. |image698| image:: 699.png
.. |image699| image:: 700.png
.. |image700| image:: 701.png
.. |image701| image:: 702.png
.. |image702| image:: 703.png
.. |image703| image:: 704.png
.. |image704| image:: 705.png
.. |image705| image:: 706.png
.. |image706| image:: 707.png
.. |image707| image:: 708.png
.. |image708| image:: 709.png
.. |image709| image:: 710.png
.. |image710| image:: 711.png
.. |image711| image:: 712.png
.. |image712| image:: 713.png
.. |image713| image:: 714.png
.. |image714| image:: 715.png
.. |image715| image:: 716.png
.. |image716| image:: 717.png
.. |image717| image:: 718.png
.. |image718| image:: 719.png
.. |image719| image:: 720.png
.. |image720| image:: 721.png
.. |image721| image:: 722.png
.. |image722| image:: 723.png
.. |image723| image:: 724.png
.. |image724| image:: 725.png
.. |image725| image:: 726.png
.. |image726| image:: 727.png
.. |image727| image:: 728.png
.. |image728| image:: 729.png
.. |image729| image:: 730.png
.. |image730| image:: 731.png
.. |image731| image:: 732.png
.. |image732| image:: 733.png
.. |image733| image:: 734.png
.. |image734| image:: 735.png
.. |image735| image:: 736.png
.. |image736| image:: 737.png
.. |image737| image:: 738.png
.. |image738| image:: 739.png
.. |image739| image:: 740.png
.. |image740| image:: 741.png
.. |image741| image:: 742.png
.. |image742| image:: 743.png
.. |image743| image:: 744.png
.. |image744| image:: 745.png
.. |image745| image:: 746.png
.. |image746| image:: 747.png
.. |image747| image:: 748.png
.. |image748| image:: 749.png
.. |image749| image:: 750.png
.. |image750| image:: 751.png
.. |image751| image:: 752.png
.. |image752| image:: 753.png
.. |image753| image:: 754.png
.. |image754| image:: 755.png
.. |image755| image:: 756.png
.. |image756| image:: 757.png
.. |image757| image:: 758.png
.. |image758| image:: 759.png
.. |image759| image:: 760.png
.. |image760| image:: 761.png
.. |image761| image:: 762.png
.. |image762| image:: 763.png
.. |image763| image:: 764.png
.. |image764| image:: 765.png
.. |image765| image:: 766.png
.. |image766| image:: 767.png
.. |image767| image:: 768.png
.. |image768| image:: 769.png
.. |image769| image:: 770.png
.. |image770| image:: 771.png
.. |image771| image:: 772.png
.. |image772| image:: 773.png
.. |image773| image:: 774.png
.. |image774| image:: 775.png
.. |image775| image:: 776.png
.. |image776| image:: 777.png
.. |image777| image:: 778.png
.. |image778| image:: 779.png
.. |image779| image:: 780.png
.. |image780| image:: 781.png
.. |image781| image:: 782.png
.. |image782| image:: 783.png
.. |image783| image:: 784.png
.. |image784| image:: 785.png
.. |image785| image:: 786.png
.. |image786| image:: 787.png
.. |image787| image:: 788.png
.. |image788| image:: 789.png
.. |image789| image:: 790.png
.. |image790| image:: 791.png
.. |image791| image:: 792.png
.. |image792| image:: 793.png
.. |image793| image:: 794.png
.. |image794| image:: 795.png
.. |image795| image:: 796.png
.. |image796| image:: 797.png
.. |image797| image:: 798.png
.. |image798| image:: 799.png
.. |image799| image:: 800.png
.. |image800| image:: 801.png
.. |image801| image:: 802.png
.. |image802| image:: 803.png
.. |image803| image:: 804.png
.. |image804| image:: 805.png
.. |image805| image:: 806.png
.. |image806| image:: 807.png
.. |image807| image:: 808.png
.. |image808| image:: 809.png
.. |image809| image:: 810.png
.. |image810| image:: 811.png
.. |image811| image:: 812.png
.. |image812| image:: 813.png
.. |image813| image:: 814.png
.. |image814| image:: 815.png
.. |image815| image:: 816.png
.. |image816| image:: 817.png
.. |image817| image:: 818.png
.. |image818| image:: 819.png
.. |image819| image:: 820.png
.. |image820| image:: 821.png
.. |image821| image:: 822.png
.. |image822| image:: 823.png
.. |image823| image:: 824.png
.. |image824| image:: 825.png
.. |image825| image:: 826.png
.. |image826| image:: 827.png
.. |image827| image:: 828.png
.. |image828| image:: 829.png
.. |image829| image:: 830.png
.. |image830| image:: 831.png
.. |image831| image:: 832.png
.. |image832| image:: 833.png
.. |image833| image:: 834.png
.. |image834| image:: 835.png
.. |image835| image:: 836.png
.. |image836| image:: 837.png
.. |image837| image:: 838.png
.. |image838| image:: 839.png
.. |image839| image:: 840.png
.. |image840| image:: 841.png
.. |image841| image:: 842.png
.. |image842| image:: 843.png
.. |image843| image:: 844.png
.. |image844| image:: 845.png
.. |image845| image:: 846.x-emf
.. |image846| image:: 847.png
.. |image847| image:: 848.png
.. |image848| image:: 849.png
.. |image849| image:: 850.png
.. |image850| image:: 851.png
.. |image851| image:: 852.png
.. |image852| image:: 853.png
.. |image853| image:: 854.png
.. |image854| image:: 855.png
.. |image855| image:: 856.png
.. |image856| image:: 857.png
.. |image857| image:: 858.png
.. |image858| image:: 859.png
.. |image859| image:: 860.png
.. |image860| image:: 861.png
.. |image861| image:: 862.png
.. |image862| image:: 863.png
.. |image863| image:: 864.png
.. |image864| image:: 865.png
.. |image865| image:: 866.png
.. |image866| image:: 867.png
.. |image867| image:: 868.png
.. |image868| image:: 869.png
.. |image869| image:: 870.png
.. |image870| image:: 871.png
.. |image871| image:: 872.png
.. |image872| image:: 873.png
.. |image873| image:: 874.png
.. |image874| image:: 875.png
.. |image875| image:: 876.png
.. |image876| image:: 877.png
.. |image877| image:: 878.png
.. |image878| image:: 879.png
.. |image879| image:: 880.png
.. |image880| image:: 881.png
.. |image881| image:: 882.png
.. |image882| image:: 883.png
.. |image883| image:: 884.png
.. |image884| image:: 885.png
.. |image885| image:: 886.png
.. |image886| image:: 887.png
.. |image887| image:: 888.png
.. |image888| image:: 889.png
.. |image889| image:: 890.png
.. |image890| image:: 891.png
.. |image891| image:: 892.png
.. |image892| image:: 893.png
.. |image893| image:: 894.png
.. |image894| image:: 895.png
.. |image895| image:: 896.png
.. |image896| image:: 897.png
.. |image897| image:: 898.png
.. |image898| image:: 899.png
.. |image899| image:: 900.png
.. |image900| image:: 901.x-emf
.. |image901| image:: 902.png
.. |image902| image:: 903.x-emf
.. |image903| image:: 904.png
.. |image904| image:: 905.x-emf
.. |image905| image:: 906.png
.. |image906| image:: 907.png
.. |image907| image:: 908.png
.. |image908| image:: 909.png
.. |image909| image:: 910.png
.. |image910| image:: 911.x-emf
.. |image911| image:: 912.png
.. |image912| image:: 913.png
.. |image913| image:: 914.png
.. |image914| image:: 915.png
.. |image915| image:: 916.png
.. |image916| image:: 917.png
.. |image917| image:: 918.png
.. |image918| image:: 919.png
.. |image919| image:: 920.png
.. |image920| image:: 921.png
.. |image921| image:: 922.png
.. |image922| image:: 923.png
.. |image923| image:: 924.png
.. |image924| image:: 925.png
.. |image925| image:: 926.png
.. |image926| image:: 927.png
.. |image927| image:: 928.png
.. |image928| image:: 929.png
.. |image929| image:: 930.png
.. |image930| image:: 931.png
.. |image931| image:: 932.png
.. |image932| image:: 933.png
.. |image933| image:: 934.png
.. |image934| image:: 935.png
.. |image935| image:: 936.png
.. |image936| image:: 937.png
.. |image937| image:: 938.png
.. |image938| image:: 939.png
.. |image939| image:: 940.png
.. |image940| image:: 941.png
.. |image941| image:: 942.png
.. |image942| image:: 943.png
.. |image943| image:: 944.png
.. |image944| image:: 945.png
.. |image945| image:: 946.png
.. |image946| image:: 947.png
.. |image947| image:: 948.png
.. |image948| image:: 949.png
.. |image949| image:: 950.png
.. |image950| image:: 951.png
.. |image951| image:: 952.png
.. |image952| image:: 953.png
.. |image953| image:: 954.png
.. |image954| image:: 955.png
.. |image955| image:: 956.png
.. |image956| image:: 957.png
.. |image957| image:: 958.png
.. |image958| image:: 959.png
.. |image959| image:: 960.png
.. |image960| image:: 961.png
.. |image961| image:: 962.png
.. |image962| image:: 963.png
.. |image963| image:: 964.png
.. |image964| image:: 965.png
.. |image965| image:: 966.png
.. |image966| image:: 967.png
.. |image967| image:: 968.png
.. |image968| image:: 969.png
.. |image969| image:: 970.png
.. |image970| image:: 971.png
.. |image971| image:: 972.png
.. |image972| image:: 973.png
.. |image973| image:: 974.png
.. |image974| image:: 975.png
.. |image975| image:: 976.png
.. |image976| image:: 977.png
.. |image977| image:: 978.png
.. |image978| image:: 979.png
.. |image979| image:: 980.png
.. |image980| image:: 981.png
.. |image981| image:: 982.png
.. |image982| image:: 983.png
.. |image983| image:: 984.png
.. |image984| image:: 985.png
.. |image985| image:: 986.png
.. |image986| image:: 987.png
.. |image987| image:: 988.png
.. |image988| image:: 989.png
.. |image989| image:: 990.png
.. |image990| image:: 991.png
.. |image991| image:: 992.png
.. |image992| image:: 993.png
.. |image993| image:: 994.x-emf

